<!DOCTYPE html>
<html lang="el" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MediRadar App</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Barcode Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <!-- Supabase Client (Placeholder, though we use Firebase for persistence) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Firebase Imports (Required for persistent 24h extension limit) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        // Set Debug logging for Firebase
        setLogLevel('Debug');

        // Global Firebase variables for use in <script> below
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, getDoc, setDoc, onSnapshot
        };
    </script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#0d9488', // Teal-600
                        secondary: '#0f172a', // Slate-900
                    },
                    animation: {
                        'float': 'float 15s linear infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideInUp: { /* Toast Entry */
                            '0%': { transform: 'translateY(100px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        slideOutDown: { /* Toast Exit */
                            '0%': { transform: 'translateY(0)', opacity: '1' },
                            '100%': { transform: 'translateY(100px)', opacity: '0' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Floating Emojis */
        .emoji-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: 0; pointer-events: none;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            transition: background 0.5s ease;
        }
        
        html.dark .emoji-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        .emoji {
            position: absolute; bottom: -100px;
            font-size: 2rem; opacity: 0.4;
            animation: floatUp 15s linear infinite;
            z-index: 0;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.5; }
            90% { opacity: 0.5; }
            100% { transform: translateY(-110vh) rotate(360deg); opacity: 0; }
        }
        
        /* Glassmorphism Card - Stronger borders for visibility */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
            position: relative; z-index: 10;
            transition: all 0.3s ease;
        }

        html.dark .glass-card {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.3);
        }

        /* Modal Styles */
        .modal-backdrop {
            display: none;
            position: fixed; inset: 0; z-index: 50;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            align-items: center; justify-content: center;
            padding: 1rem;
        }
        .modal-backdrop.active { display: flex; animation: fadeIn 0.2s ease-out; }

        .modal-content {
            width: 100%; max-width: 400px;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95); opacity: 0;
        }
        
        .modal-backdrop.active .modal-content {
            animation: slideUp 0.3s ease-out forwards;
        }
        
        /* Toast Animations */
        .toast-enter { animation: slideInUp 0.3s ease-out forwards; }
        .toast-exit { animation: slideOutDown 0.3s ease-in forwards; }
        
        body::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* Tab Animation */
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-100 antialiased min-h-screen relative flex flex-col">

    <!-- 1. Background Animation -->
    <div id="emoji-container" class="emoji-bg"></div>

    <!-- Top Bar: Settings & Auth -->
    <nav class="w-full max-w-lg mx-auto p-4 flex justify-between items-center z-20 relative">
        <!-- Login Buttons -->
        <div class="flex gap-2">
            <button onclick="openModal('user')" class="bg-white/90 dark:bg-slate-800/90 hover:bg-white dark:hover:bg-slate-700 px-3 py-2 rounded-xl text-xs font-bold text-primary border border-primary/20 transition-all flex items-center gap-1 shadow-sm backdrop-blur-md hover:shadow-md">
                <i class="ph ph-user text-lg"></i> Î•Î¯ÏƒÎ¿Î´Î¿Ï‚
            </button>
            <button onclick="openModal('pro')" class="bg-slate-800 hover:bg-slate-900 text-white px-3 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-1 shadow-lg shadow-slate-500/20 backdrop-blur-md hover:transform hover:-translate-y-0.5">
                <i class="ph ph-briefcase text-lg"></i> Pro
            </button>
        </div>

        <!-- Toggles -->
        <div class="flex gap-2">
            <!-- Language Toggle -->
            <button onclick="toggleLang()" class="bg-white/60 dark:bg-slate-700/60 w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-sm hover:scale-110 transition-transform border border-white/50" title="Î‘Î»Î»Î±Î³Î® Î“Î»ÏÏƒÏƒÎ±Ï‚">
                <span id="lang-flag">ğŸ‡¬ğŸ‡·</span>
            </button>
            
            <!-- Dark Mode Toggle -->
            <button onclick="toggleTheme()" class="bg-white/60 dark:bg-slate-700/60 w-10 h-10 rounded-full flex items-center justify-center text-slate-700 dark:text-yellow-300 shadow-sm hover:scale-110 transition-transform border border-white/50" title="Dark/Light Mode">
                <i id="theme-icon" class="ph ph-moon-stars text-xl"></i>
            </button>
        </div>
    </nav>

    <main class="w-full max-w-lg mx-auto p-4 pb-6 flex-grow z-10 relative">
        
        <!-- 2. Header -->
        <header class="text-center mb-6">
            <div class="inline-flex items-center justify-center bg-white/70 dark:bg-slate-700/70 p-4 rounded-2xl mb-3 shadow-sm backdrop-blur-sm border border-white/50">
                <i class="ph ph-magnifying-glass text-4xl text-primary"></i>
            </div>
            <h1 class="text-3xl font-bold text-primary bg-clip-text text-transparent bg-gradient-to-r from-teal-600 to-cyan-500 drop-shadow-sm">
                MediRadar
            </h1>
            <p class="text-slate-500 dark:text-slate-400 text-sm mt-1 font-medium">Î’ÏÎµÏ‚ Ï„Î¿ Ï†Î¬ÏÎ¼Î±ÎºÏŒ ÏƒÎ¿Ï… Î¬Î¼ÎµÏƒÎ± & Ï„Î¿Ï€Î¹ÎºÎ¬.</p>
        </header>

        <!-- 3. Navigation Tabs -->
        <div class="flex p-1.5 bg-slate-200/80 dark:bg-slate-800/80 rounded-2xl mb-6 glass-card">
            <button onclick="switchTab('search')" id="btn-search" class="flex-1 py-3 rounded-xl text-sm font-bold transition-all bg-white dark:bg-slate-700 shadow-sm text-primary dark:text-teal-300 ring-1 ring-black/5">
                Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·
            </button>
            <button onclick="switchTab('how')" id="btn-how" class="flex-1 py-3 rounded-xl text-sm font-bold text-slate-500 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-700/50 transition-all">
                Î ÏÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯
            </button>
        </div>

        <!-- 4. Search Tab Content -->
        <div id="tab-search" class="tab-content active">
            <div class="glass-card rounded-3xl p-6 relative overflow-hidden">
                
                <form id="request-form" class="space-y-6">
                    
                    <!-- Personal Info (Fields with Local Storage) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">ÎŸÎ½Î¿Î¼Î±</label>
                            <input id="full-name" type="text" placeholder="ÎœÎ±ÏÎ¯Î± Î ." oninput="saveUserData()"
                                   class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary focus:bg-white dark:focus:bg-slate-900 transition-all text-slate-900 dark:text-white placeholder-slate-400 font-medium shadow-sm" required>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î¤Î·Î»ÎµÏ†Ï‰Î½Î¿</label>
                            <input id="phone" type="tel" placeholder="69..." oninput="saveUserData()"
                                   class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary focus:bg-white dark:focus:bg-slate-900 transition-all text-slate-900 dark:text-white placeholder-slate-400 font-medium shadow-sm" required>
                        </div>
                    </div>

                    <!-- Location with "Near Me" (Field with Local Storage) -->
                    <div class="space-y-2 relative">
                        <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î ÎµÏÎ¹Î¿Ï‡Î·</label>
                        <div class="relative">
                            <input id="city" type="text" placeholder="Ï€.Ï‡. ÎšÎ¬Ï„Ï‰ Î¤Î¿ÏÎ¼Ï€Î±" oninput="saveUserData()"
                                   class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 pr-32 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary focus:bg-white dark:focus:bg-slate-900 transition-all text-slate-900 dark:text-white placeholder-slate-400 font-medium shadow-sm" required>
                            <button type="button" onclick="getLocation()" class="absolute right-2 top-2 bottom-2 px-3 bg-teal-100 dark:bg-teal-900/40 text-teal-800 dark:text-teal-200 border border-teal-200 dark:border-teal-700 rounded-xl text-xs font-bold hover:bg-teal-200 dark:hover:bg-teal-900/60 transition-colors flex items-center gap-1 shadow-sm">
                                <i class="ph ph-navigation-arrow text-sm"></i> ÎšÎ¿Î½Ï„Î¬ Î¼Î¿Ï…
                            </button>
                        </div>
                    </div>

                    <div class="border-t-2 border-dashed border-slate-200 dark:border-slate-700 my-2"></div>

                    <!-- Medicine Info Expanded (Includes Voice Input) -->
                    <div class="space-y-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">ÎŸÎ½Î¿Î¼Î± Î¦Î±ÏÎ¼Î±ÎºÎ¿Ï…</label>
                            <div class="relative">
                                <i class="ph ph-pill absolute left-4 top-4 text-slate-400 text-xl z-10"></i>
                                <input id="medicine" type="text" placeholder="Ï€.Ï‡. Depon Maximum"
                                       class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl pl-12 pr-12 py-3.5 text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary focus:bg-white dark:focus:bg-slate-900 transition-all text-slate-900 dark:text-white placeholder-slate-400 shadow-sm" required>

                                <!-- Microphone Button for Voice Input - IMPROVED -->
                                <button type="button" onclick="startVoiceInput()" id="voice-btn" title="Î¦Ï‰Î½Î·Ï„Î¹ÎºÎ® Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î¦Î±ÏÎ¼Î¬ÎºÎ¿Ï…" class="absolute right-3 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 shadow-sm flex items-center justify-center text-xl text-slate-500 hover:text-primary hover:border-primary focus:outline-none focus:ring-2 focus:ring-primary/40 transition-all">
                                    <i id="mic-icon" class="ph ph-microphone text-xl"></i>
                                </button>
                            </div>
                            <p class="text-right text-xs font-semibold text-slate-500 dark:text-slate-300 flex items-center justify-end gap-1 mt-2">
                                <i class="ph ph-microphone text-sm"></i> Î Î±Ï„Î®ÏƒÏ„Îµ Î½Î± Î¼Î¹Î»Î®ÏƒÎµÏ„Îµ
                            </p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î”ÏÎ±ÏƒÏ„Î¹ÎºÎ·</label>
                                <input id="substance" type="text" placeholder="Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬" 
                                       class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary focus:bg-white dark:focus:bg-slate-900 transition-all text-slate-900 dark:text-white placeholder-slate-400 font-medium shadow-sm text-sm">
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î Î¿ÏƒÎ¿Ï„Î·Ï„Î±</label>
                                <input id="quantity" type="number" min="1" value="1" 
                                       class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 text-center font-bold focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary focus:bg-white dark:focus:bg-slate-900 transition-all text-slate-900 dark:text-white shadow-sm">
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î•Î¯Î´Î¿Ï‚ / ÎœÎ¿ÏÏ†Î®</label>
                            <div class="relative">
                                <select id="med-type" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary focus:bg-white dark:focus:bg-slate-900 transition-all text-slate-900 dark:text-white font-medium shadow-sm">
                                    <option value="">Î•Ï€Î¯Î»ÎµÎ¾Îµ ÎµÎ¯Î´Î¿Ï‚ (Ï€.Ï‡. Î§Î¬Ï€Î¹Î±)</option>
                                    <option value="pills">ğŸ’Š Î§Î¬Ï€Î¹Î± / ÎšÎ¬ÏˆÎ¿Ï…Î»ÎµÏ‚</option>
                                    <option value="syrup">ğŸ§´ Î£Î¹ÏÏŒÏ€Î¹ / Î ÏŒÏƒÎ¹Î¼Î¿</option>
                                    <option value="cream">ğŸ§´ Î‘Î»Î¿Î¹Ï†Î® / ÎšÏÎ­Î¼Î±</option>
                                    <option value="inhaler">ğŸ’¨ Î•Î¹ÏƒÏ€Î½ÎµÏŒÎ¼ÎµÎ½Î¿ / Î£Ï€ÏÎ­Î¹</option>
                                    <option value="injection">ğŸ’‰ Î•Î½Î­ÏƒÎ¹Î¼Î¿</option>
                                    <option value="powder">ğŸš Î£ÎºÏŒÎ½Î· / Î¦Î±ÎºÎµÎ»Î¬ÎºÎ¹Î±</option>
                                    <option value="suppository">ğŸ’Š Î¥Ï€ÏŒÎ¸ÎµÏ„Î¿</option>
                                </select>
                                <i class="ph ph-caret-down absolute right-4 top-4 text-slate-500 pointer-events-none text-lg"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Unified Media Input (Professional Icons) -->
                    <div class="bg-slate-50 dark:bg-slate-800/80 rounded-2xl p-4 border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-primary/50 transition-colors">
                        <label class="text-xs font-bold text-slate-600 dark:text-slate-300 uppercase mb-3 block text-center">ğŸ“¸ Î ÏÎ¿ÏƒÎ¸Î·ÎºÎ· Î¦Ï‰Ï„Î¿ / Barcode / Î£Ï…Î½Ï„Î±Î³Î·Ï‚</label>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <!-- Photo Upload Button -->
                            <input id="request-image" type="file" accept="image/*" class="hidden" onchange="handleFileSelect(this)">
                            <button type="button" onclick="document.getElementById('request-image').click()" 
                                class="flex flex-col items-center justify-center bg-white dark:bg-slate-700 hover:bg-blue-50 dark:hover:bg-slate-600 border-2 border-slate-200 dark:border-slate-600 rounded-xl p-4 transition-all hover:shadow-md group relative overflow-hidden">
                                <div class="absolute inset-0 bg-blue-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <i class="ph ph-camera text-3xl text-slate-600 dark:text-slate-300 mb-1 group-hover:scale-110 transition-transform group-hover:text-blue-600"></i>
                                <span class="text-xs font-semibold text-slate-600 dark:text-slate-300">Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±</span>
                            </button>

                            <!-- Scan Button -->
                            <button type="button" onclick="toggleScanner()" 
                                class="flex flex-col items-center justify-center bg-white dark:bg-slate-700 hover:bg-teal-50 dark:hover:bg-slate-600 border-2 border-slate-200 dark:border-slate-600 rounded-xl p-4 transition-all hover:shadow-md group relative overflow-hidden">
                                <div class="absolute inset-0 bg-teal-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <i class="ph ph-barcode text-3xl text-slate-600 dark:text-slate-300 mb-1 group-hover:scale-110 transition-transform group-hover:text-teal-600"></i>
                                <span class="text-xs font-semibold text-slate-600 dark:text-slate-300">Scan Barcode</span>
                            </button>
                        </div>

                        <!-- Scanner Viewport -->
                        <div id="scanner-container" class="hidden mt-4 rounded-xl overflow-hidden relative bg-black border-2 border-primary shadow-lg">
                            <div id="reader" class="w-full h-64"></div>
                            <button type="button" onclick="stopScanner()" class="absolute top-2 right-2 bg-white/20 text-white p-1.5 rounded-full backdrop-blur-md hover:bg-white/40 transition-colors">
                                <i class="ph ph-x text-lg"></i>
                            </button>
                        </div>

                        <!-- Preview Area -->
                        <div id="media-preview" class="hidden mt-3 p-3 bg-teal-50 dark:bg-teal-900/30 border border-teal-100 dark:border-teal-800 rounded-xl flex items-center gap-3 animate-fade-in">
                            <div class="bg-teal-100 dark:bg-teal-800 p-2 rounded-lg text-xl">
                                <i class="ph ph-check-circle text-teal-600 dark:text-teal-300"></i>
                            </div>
                            <div class="flex-1 overflow-hidden">
                                <p class="text-xs text-teal-800 dark:text-teal-200 font-bold">Î•Ï€Î¹Ï„Ï…Ï‡Î¯Î±!</p>
                                <p id="preview-text" class="text-xs text-teal-600 dark:text-teal-400 truncate">Barcode: 123456</p>
                            </div>
                            <button type="button" onclick="clearMedia()" class="text-teal-400 hover:text-teal-700 dark:hover:text-teal-200 p-1">
                                <i class="ph ph-trash text-lg"></i>
                            </button>
                        </div>
                        
                        <input id="barcode-value" type="hidden">
                    </div>

                    <!-- Notes -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î£Î·Î¼ÎµÎ¹Ï‰ÏƒÎµÎ¹Ï‚ (Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¿)</label>
                        <textarea id="notes" rows="2" placeholder="Î .Ï‡. Î ÏÎ¿Ï„Î¹Î¼Ï ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î· ÎµÏ„Î±Î¹ÏÎµÎ¯Î±..." 
                                  class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 resize-none focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary focus:bg-white dark:focus:bg-slate-900 transition-all text-slate-900 dark:text-white placeholder-slate-400 font-medium shadow-sm"></textarea>
                    </div>

                    <!-- Checkboxes & GDPR -->
                    <div class="space-y-3 pt-2">
                        <label class="flex items-start gap-3 p-3 rounded-xl bg-white/60 dark:bg-slate-700/40 border border-slate-200 dark:border-slate-600 hover:bg-white/80 transition-colors cursor-pointer">
                            <input type="checkbox" class="mt-1 w-4 h-4 text-primary rounded focus:ring-primary border-gray-300" checked>
                            <span class="text-xs text-slate-600 dark:text-slate-300 leading-tight">Î”Î­Ï‡Î¿Î¼Î±Î¹ Î½Î± Î¼Î¿Ï… Ï€ÏÎ¿Ï„ÎµÎ¯Î½Î¿Ï…Î½ <strong>Î³ÎµÎ½ÏŒÏƒÎ·Î¼Î¿</strong> Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„Î¿ Ï€ÏÏ‰Ï„ÏŒÏ„Ï…Ï€Î¿.</span>
                        </label>

                        <label class="flex items-start gap-3 px-3 cursor-pointer group">
                            <input type="checkbox" id="gdpr-check" class="mt-0.5 w-4 h-4 text-primary rounded focus:ring-primary border-gray-300" required>
                            <span class="text-xs text-slate-500 dark:text-slate-400 leading-tight group-hover:text-primary transition-colors">
                                ÎˆÏ‡Ï‰ Î´Î¹Î±Î²Î¬ÏƒÎµÎ¹ ÎºÎ±Î¹ Î±Ï€Î¿Î´Î­Ï‡Î¿Î¼Î±Î¹ Ï„Î¿Ï…Ï‚ <a href="#" class="underline text-primary font-semibold">ÎŒÏÎ¿Ï…Ï‚ Î§ÏÎ®ÏƒÎ·Ï‚</a> ÎºÎ±Î¹ Ï„Î·Î½ <a href="#" class="underline text-primary font-semibold">Î Î¿Î»Î¹Ï„Î¹ÎºÎ® Î‘Ï€Î¿ÏÏÎ®Ï„Î¿Ï… (GDPR)</a>.
                            </span>
                        </label>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="w-full bg-gradient-to-r from-cyan-500 to-teal-500 hover:from-cyan-600 hover:to-teal-600 text-white text-lg font-bold py-4 rounded-2xl shadow-lg shadow-teal-500/30 transform active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                        <i class="ph ph-paper-plane-right text-xl"></i>
                        Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î‘Î¹Ï„Î®Î¼Î±Ï„Î¿Ï‚
                    </button>

                </form>
            </div>
        </div>

        <!-- 5. How It Works Tab -->
        <div id="tab-how" class="tab-content">
            <div class="glass-card rounded-3xl p-6">
                <h3 class="text-xl font-bold mb-6 text-slate-800 dark:text-white flex items-center gap-2">
                    <i class="ph ph-info text-primary"></i> Î ÏÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯;
                </h3>
                <ul class="space-y-6">
                    <li class="flex gap-4 items-start">
                        <div class="bg-teal-100 dark:bg-teal-900 text-teal-700 dark:text-teal-300 w-10 h-10 rounded-full flex items-center justify-center font-bold flex-shrink-0 text-lg shadow-sm">1</div>
                        <div>
                            <h4 class="font-bold text-slate-800 dark:text-slate-200">Î‘Î¯Ï„Î·Î¼Î±</h4>
                            <p class="text-slate-600 dark:text-slate-400 text-sm mt-1">Î£Ï…Î¼Ï€Î»Î·ÏÏÎ½ÎµÎ¹Ï‚ Ï„Î· Ï†ÏŒÏÎ¼Î±, Î±Î½ÎµÎ²Î¬Î¶ÎµÎ¹Ï‚ Ï†Ï‰Ï„ÏŒ Î® ÏƒÎ±ÏÏÎ½ÎµÎ¹Ï‚ Ï„Î¿ barcode/ÏƒÏ…Î½Ï„Î±Î³Î®.</p>
                        </div>
                    </li>
                    <li class="flex gap-4 items-start">
                        <div class="bg-teal-100 dark:bg-teal-900 text-teal-700 dark:text-teal-300 w-10 h-10 rounded-full flex items-center justify-center font-bold flex-shrink-0 text-lg shadow-sm">2</div>
                        <div>
                            <h4 class="font-bold text-slate-800 dark:text-slate-200">Î•Î¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·</h4>
                            <p class="text-slate-600 dark:text-slate-400 text-sm mt-1">Î¤Î¿ MediRadar ÏˆÎ¬Ï‡Î½ÎµÎ¹ ÏƒÏ„Î± Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î± ÎºÎ¿Î½Ï„Î¬ ÏƒÏ„Î·Î½ Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î± ÏƒÎ¿Ï….</p>
                        </div>
                    </li>
                    <li class="flex gap-4 items-start">
                        <div class="bg-teal-100 dark:bg-teal-900 text-teal-700 dark:text-teal-300 w-10 h-10 rounded-full flex items-center justify-center font-bold flex-shrink-0 text-lg shadow-sm">3</div>
                        <div>
                            <h4 class="font-bold text-slate-800 dark:text-slate-200">ÎšÏÎ¬Ï„Î·ÏƒÎ·</h4>
                            <p class="text-slate-600 dark:text-slate-400 text-sm mt-1">Î›Î±Î¼Î²Î¬Î½ÎµÎ¹Ï‚ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚, ÎµÏ€Î¹Î»Î­Î³ÎµÎ¹Ï‚ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿ ÎºÎ±Î¹ Ï€Î±ÏÎ±Î»Î±Î¼Î²Î¬Î½ÎµÎ¹Ï‚!</p>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 6. Status / Pickup Timer Screen (Updated) -->
        <div id="pickup-view" class="hidden animate-fadeIn">
            <div class="glass-card rounded-3xl p-8 text-center border-teal-200 dark:border-teal-800">
                
                <!-- Pickup Deadline Timer -->
                <div class="w-24 h-24 bg-teal-100 dark:bg-teal-900/50 rounded-full flex flex-col items-center justify-center mx-auto mb-6 shadow-xl ring-8 ring-teal-50 dark:ring-teal-900/20">
                    <i class="ph ph-hourglass-high text-4xl text-primary mb-1"></i>
                    <p class="text-xs font-bold text-primary">Pickup</p>
                </div>
                
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">Î§ÏÏŒÎ½Î¿Ï‚ Î Î±ÏÎ±Î»Î±Î²Î®Ï‚</h2>
                <p class="text-slate-500 dark:text-slate-400 mb-6">ÎšÏÎ±Ï„Î®Î¸Î·ÎºÎµ Î³Î¹Î± ÎµÏƒÎ¬Ï‚ ÏƒÏ„Î¿ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿! Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€Î±ÏÎ±Î»Î¬Î²ÎµÏ„Îµ ÎµÎ½Ï„ÏŒÏ‚:</p>
                
                <!-- TIMER DISPLAY -->
                <div class="bg-white dark:bg-slate-700 rounded-2xl p-4 mb-6 shadow-inner border border-slate-200 dark:border-slate-700">
                    <p id="timer-display" class="text-5xl font-extrabold text-primary dark:text-teal-400 tracking-tighter">
                        --:--
                    </p>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Î›ÎµÏ€Ï„Î¬</p>
                </div>

                <!-- Extend Button & Info -->
                <div class="space-y-2 mb-4">
                    <button id="extend-btn" onclick="extendPickupTime()" disabled 
                        class="w-full bg-slate-200 dark:bg-slate-700 text-slate-500 font-bold py-3 rounded-xl transition-all flex items-center justify-center gap-2 text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="ph ph-timer text-lg"></i> Î Î±ÏÎ¬Ï„Î±ÏƒÎ· 15' (Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î·)
                    </button>
                    <p id="extend-info" class="text-xs text-slate-500 dark:text-slate-400">
                        ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„Î·Î½ Ï€Î±ÏÎ¬Ï„Î±ÏƒÎ· Î¼ÏŒÎ½Î¿ Î¼Î¯Î± Ï†Î¿ÏÎ¬ ÎºÎ¬Î¸Îµ 24 ÏÏÎµÏ‚.
                    </p>
                </div>
                

                <button onclick="resetApp()" class="text-sm text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 font-medium flex items-center justify-center gap-1 mx-auto">
                    <i class="ph ph-x-circle"></i> ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·/Î‘ÎºÏÏÏ‰ÏƒÎ· Ï€Î±ÏÎ±Î»Î±Î²Î®Ï‚
                </button>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="mt-auto py-6 bg-white/50 dark:bg-slate-900/50 backdrop-blur-md border-t border-slate-200 dark:border-slate-800 z-10">
        <div class="max-w-lg mx-auto px-4 text-center">
            <div class="flex justify-center gap-4 mb-4">
                <a href="#" class="w-9 h-9 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center text-slate-600 dark:text-slate-300 hover:bg-primary hover:text-white transition-colors shadow-sm">
                    <i class="ph ph-facebook-logo text-lg"></i>
                </a>
                <a href="#" class="w-9 h-9 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center text-slate-600 dark:text-slate-300 hover:bg-primary hover:text-white transition-colors shadow-sm">
                    <i class="ph ph-instagram-logo text-lg"></i>
                </a>
                <a href="#" class="w-9 h-9 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center text-slate-600 dark:text-slate-300 hover:bg-primary hover:text-white transition-colors shadow-sm">
                    <i class="ph ph-envelope-simple text-lg"></i>
                </a>
            </div>
            <div class="flex flex-wrap justify-center gap-x-6 gap-y-2 text-xs text-slate-500 dark:text-slate-400 font-medium mb-4">
                <a href="#" class="hover:text-primary transition-colors">ÎŒÏÎ¿Î¹ Î§ÏÎ®ÏƒÎ·Ï‚</a>
                <a href="#" class="hover:text-primary transition-colors">Î Î¿Î»Î¹Ï„Î¹ÎºÎ® Î‘Ï€Î¿ÏÏÎ®Ï„Î¿Ï… (GDPR)</a>
                <a href="#" class="hover:text-primary transition-colors">FAQ</a>
                <a href="#" class="hover:text-primary transition-colors">Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±</a>
            </div>
            <p class="text-xs text-slate-400 dark:text-slate-600">Â© 2023 MediRadar. All rights reserved.</p>
        </div>
    </footer>

    <!-- TOAST NOTIFICATIONS CONTAINER -->
    <div id="toast-container" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-sm px-4 space-y-2 pointer-events-none">
        <!-- Toasts will be dynamically added here -->
    </div>

    <!-- MODALS -->
    <!-- User Login Modal -->
    <div id="modal-user" class="modal-backdrop">
        <div class="modal-content bg-white dark:bg-slate-800 text-center relative glass-card !opacity-100 !transform-none">
            <button onclick="closeModal('user')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors"><i class="ph ph-x text-xl"></i></button>
            
            <div class="w-16 h-16 bg-teal-100 dark:bg-teal-900/50 rounded-full flex items-center justify-center mx-auto mb-4 text-primary ring-4 ring-teal-50 dark:ring-teal-900/20">
                <i class="ph ph-user text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold mb-1 text-slate-800 dark:text-white">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚ Î§ÏÎ®ÏƒÏ„Î·</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Î£Ï…Î½Î´Î­ÏƒÎ¿Ï… Î³Î¹Î± Î½Î± Î²Î»Î­Ï€ÎµÎ¹Ï‚ Ï„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ ÏƒÎ¿Ï….</p>

            <form id="magic-link-form" class="space-y-4">
                <div class="space-y-1 text-left">
                    <label for="user-email" class="text-xs font-bold text-slate-600 dark:text-slate-300 uppercase ml-1">Email</label>
                    <input id="user-email" type="email" placeholder="example@email.com" required
                           class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-xl px-4 py-3.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary focus:bg-white dark:focus:bg-slate-900 transition-all text-slate-900 dark:text-white placeholder-slate-400 font-medium shadow-sm">
                </div>

                <button type="submit" onclick="handleMagicLink(event)" class="w-full bg-primary hover:bg-teal-700 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-all shadow-md shadow-teal-500/20">
                    <i class="ph ph-magic-wand text-lg"></i> Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Magic Link
                </button>
            </form>
            
            <button onclick="showToast('Î— ÏƒÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Google Î­ÏÏ‡ÎµÏ„Î±Î¹ ÏƒÏÎ½Ï„Î¿Î¼Î±.', 'info')" class="w-full bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 hover:bg-slate-50 text-slate-700 dark:text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-all mt-3">
                <i class="ph ph-google-logo text-lg text-red-500"></i> Î£Ï…Î½Î­Ï‡ÎµÎ¹Î± Î¼Îµ Google
            </button>
            
            <p class="text-xs text-slate-400 mt-3">
                Î‘Î½ ÎµÎ¯Î½Î±Î¹ Î· Ï€ÏÏÏ„Î· ÏƒÎ±Ï‚ Ï†Î¿ÏÎ¬, Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸ÎµÎ¯ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚.<br>
                **ÎŸÎ´Î·Î³Î¯ÎµÏ‚:** Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± ÎµÎ¹ÏƒÎµÏÏ‡ÏŒÎ¼ÎµÎ½Î¬ ÏƒÎ±Ï‚ Î³Î¹Î± Ï„Î¿Î½ ÏƒÏÎ½Î´ÎµÏƒÎ¼Î¿ ÎµÎ¹ÏƒÏŒÎ´Î¿Ï….
            </p>
        </div>
    </div>

    <!-- Pro Login Modal -->
    <div id="modal-pro" class="modal-backdrop">
        <div class="modal-content bg-white dark:bg-slate-800 text-center relative glass-card !opacity-100 !transform-none">
            <button onclick="closeModal('pro')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors"><i class="ph ph-x text-xl"></i></button>
            
            <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 text-white shadow-lg shadow-slate-500/30 ring-4 ring-slate-200 dark:ring-slate-700">
                <i class="ph ph-briefcase text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold mb-1 text-slate-800 dark:text-white">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚ Pro</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Î Î»Î±Ï„Ï†ÏŒÏÎ¼Î± Î¦Î±ÏÎ¼Î±ÎºÎ¿Ï€Î¿Î¹ÏÎ½ & Î£Ï…Î½ÎµÏÎ³Î±Ï„ÏÎ½.</p>

            <form class="space-y-4 text-left">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-600 dark:text-slate-300 uppercase ml-1">Professional Email</label>
                    <input id="pro-email" type="email" placeholder="pharmacy@example.com" required
                           class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-xl px-4 py-3.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary focus:bg-white dark:focus:bg-slate-900 transition-all text-slate-900 dark:text-white placeholder-slate-400 font-medium shadow-sm">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-600 dark:text-slate-300 uppercase ml-1">Password</label>
                    <input id="pro-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required
                           class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-xl px-4 py-3.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary focus:bg-white dark:focus:bg-slate-900 transition-all text-slate-900 dark:text-white placeholder-slate-400 font-medium shadow-sm">
                </div>
                <button type="submit" onclick="handleProLogin(event)" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl transition-all shadow-lg mt-2">
                    Î£ÏÎ½Î´ÎµÏƒÎ·
                </button>
            </form>
            <p class="mt-4 text-xs text-slate-400">
                Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ; <a href="#" class="underline text-slate-600 dark:text-slate-300 font-semibold">Î•Î³Î³ÏÎ±Ï†Î® Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…</a>.<br>
                **ÎŸÎ´Î·Î³Î¯ÎµÏ‚:** Î— ÎµÎ³Î³ÏÎ±Ï†Î® Î±Ï€Î±Î¹Ï„ÎµÎ¯ Î­Î»ÎµÎ³Ï‡Î¿ Ï„Î±Ï…Ï„Î¿Ï€ÏÎ¿ÏƒÏ‰Ï€Î¯Î±Ï‚ ÎºÎ±Î¹ Î­Î³ÎºÏÎ¹ÏƒÎ·.
            </p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/env.js"></script>
    
    <script>
        // --- 0. Global Variables & Firebase Init ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isListening = false;
        let timerInterval = null;
        let pickupDeadline = null; // Stored as Unix Timestamp
        
        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        
        const EXTENSION_COOLDOWN_MS = 24 * 60 * 60 * 1000; // 24 hours
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        async function initializeFirebase() {
            if (typeof firebase === 'undefined') {
                console.error("Firebase library not loaded.");
                return;
            }
            
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.getFirestore(app);
                auth = firebase.getAuth(app);

                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
                
                if (token) {
                    await firebase.signInWithCustomToken(auth, token);
                } else {
                    await firebase.signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase initialized. User ID:", userId);

                // Start listening to the pickup status for this user
                startPickupStatusListener();

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showToast("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î· Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.", 'error');
            }
        }
        
        // --- 1. UI Toggles & Modals ---
        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            if(html.classList.contains('dark')) {
                html.classList.remove('dark');
                icon.classList.replace('ph-sun', 'ph-moon-stars');
                icon.classList.remove('text-yellow-400');
            } else {
                html.classList.add('dark');
                icon.classList.add('dark');
                icon.classList.replace('ph-moon-stars', 'ph-sun');
                icon.classList.add('text-yellow-400');
            }
        }

        function toggleLang() {
            const flag = document.getElementById('lang-flag');
            if(flag.innerText === 'ğŸ‡¬ğŸ‡·') {
                flag.innerText = 'ğŸ‡¬ğŸ‡§';
                // Here would go the text change logic
            } else {
                flag.innerText = 'ğŸ‡¬ğŸ‡·';
            }
        }

        function openModal(type) {
            document.getElementById(`modal-${type}`).classList.add('active');
        }

        function closeModal(type) {
            document.getElementById(`modal-${type}`).classList.remove('active');
        }

        // Close modal on backdrop click
        document.querySelectorAll('.modal-backdrop').forEach(bg => {
            bg.addEventListener('click', (e) => {
                if(e.target === bg) bg.classList.remove('active');
            });
        });

        // --- 2. Toast Notifications ---
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const id = 'toast-' + Date.now();
            
            let iconClass = '';
            let colorClass = '';

            switch(type) {
                case 'success':
                    iconClass = 'ph-check-circle text-green-500';
                    colorClass = 'bg-green-50 dark:bg-green-900/40 border-green-200 dark:border-green-800';
                    break;
                case 'error':
                    iconClass = 'ph-x-circle text-red-500';
                    colorClass = 'bg-red-50 dark:bg-red-900/40 border-red-200 dark:border-red-800';
                    break;
                case 'warning':
                    iconClass = 'ph-warning-circle text-yellow-500';
                    colorClass = 'bg-yellow-50 dark:bg-yellow-900/40 border-yellow-200 dark:border-yellow-800';
                    break;
                case 'info':
                default:
                    iconClass = 'ph-info text-primary';
                    colorClass = 'bg-teal-50 dark:bg-teal-900/40 border-teal-200 dark:border-teal-800';
                    break;
            }

            // Create the toast element
            const toastElement = document.createElement('div');
            toastElement.id = id;
            toastElement.className = `toast-enter p-4 rounded-xl shadow-lg flex items-center gap-3 ${colorClass} border transition-all duration-300 opacity-0 pointer-events-auto`;
            toastElement.innerHTML = `
                <i class="ph ${iconClass} text-2xl flex-shrink-0"></i>
                <p class="text-sm font-medium text-slate-800 dark:text-slate-100">${message}</p>
            `;
            container.appendChild(toastElement);

            // Set timeout for removal
            setTimeout(() => {
                toastElement.classList.remove('toast-enter');
                toastElement.classList.add('toast-exit');
                toastElement.addEventListener('animationend', () => toastElement.remove());
            }, duration);
        }

        // --- 3. Login Logic ---
        async function handleMagicLink(e) {
            e.preventDefault(); // Prevent form submission
            // ... (Supabase/Auth logic implementation skipped for brevity, keeping the demo toast)
            const email = document.getElementById('user-email').value;
            
            if(!email) {
                showToast("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿ email ÏƒÎ±Ï‚.", 'warning');
                return;
            }
            showToast("Demo: ÎŸ ÏƒÏÎ½Î´ÎµÏƒÎ¼Î¿Ï‚ ÎµÎ¹ÏƒÏŒÎ´Î¿Ï… ÏƒÏ„Î¬Î»Î¸Î·ÎºÎµ ÏƒÏ„Î¿ " + email, 'success');
            closeModal('user');
        }
        
        function handleProLogin(e) {
            e.preventDefault(); // Prevent form submission
            // ... (Auth logic implementation skipped for brevity, keeping the demo toast)
            const email = document.getElementById('pro-email').value;
            const password = document.getElementById('pro-password').value;
            
            if(!email || !password) {
                showToast("Î Î±ÏÎ±ÎºÎ±Î»Ï ÏƒÏ…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ ÏŒÎ»Î± Ï„Î± Ï€ÎµÎ´Î¯Î±.", 'warning');
                return;
            }
            showToast(`Demo: Î ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Ï‰Ï‚ Ï†Î±ÏÎ¼Î±ÎºÎ¿Ï€Î¿Î¹ÏŒÏ‚ (${email}).`, 'info');
            closeModal('pro');
        }


        // --- 4. Geolocation (Updated to use Toast) ---
        function getLocation() {
            const cityInput = document.getElementById('city');
            if (navigator.geolocation) {
                cityInput.value = "Î•Î½Ï„Î¿Ï€Î¹ÏƒÎ¼ÏŒÏ‚...";
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                showToast("Î— ÎµÎ½Ï„Î¿Ï€Î¹ÏƒÎ¼ÏŒÏ‚ Î³ÎµÏ‰Î³ÏÎ±Ï†Î¹ÎºÎ®Ï‚ Î¸Î­ÏƒÎ·Ï‚ Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÏƒÎµ Î±Ï…Ï„Î® Ï„Î· ÏƒÏ…ÏƒÎºÎµÏ…Î®.", 'error');
            }
        }

        function showPosition(position) {
            const lat = position.coords.latitude.toFixed(4);
            const lon = position.coords.longitude.toFixed(4);
            const cityInput = document.getElementById('city');
            cityInput.value = `ğŸ“ ${lat}, ${lon}`;
            saveUserData();
            showToast("Î— Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î± ÏƒÎ±Ï‚ Î²ÏÎ­Î¸Î·ÎºÎµ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±!", 'success');
        }

        function showError(error) {
            document.getElementById('city').value = "";
            showToast("Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„ÏŒÏ‚ Î¿ ÎµÎ½Ï„Î¿Ï€Î¹ÏƒÎ¼ÏŒÏ‚ Ï„Î·Ï‚ Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±Ï‚ ÏƒÎ±Ï‚. Î Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³Î®ÏƒÏ„Îµ Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î±.", 'warning');
        }

        // --- 5. Floating Emojis (Background Logic) ---
        const emojis = ['ğŸ’Š', 'ğŸ©º', 'ğŸ¥', 'ğŸ©¹', 'ğŸ§ª', 'ğŸ§¬', 'ğŸ§´', 'ğŸ”¬', 'ğŸš‘', 'ğŸ¦·'];
        const container = document.getElementById('emoji-container');

        function createEmojis() {
            container.innerHTML = '';
            for(let i=0; i<15; i++) {
                const el = document.createElement('div');
                el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                el.classList.add('emoji');
                el.style.left = Math.random() * 100 + '%';
                el.style.animationDuration = (12 + Math.random() * 20) + 's'; 
                el.style.animationDelay = (Math.random() * 10) + 's';
                el.style.fontSize = (1.5 + Math.random() * 2.5) + 'rem';
                container.appendChild(el);
            }
        }
        createEmojis();

        // --- 6. Tab Switching ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            
            const btnSearch = document.getElementById('btn-search');
            const btnHow = document.getElementById('btn-how');
            
            const activeClass = "flex-1 py-3 rounded-xl text-sm font-bold transition-all bg-white dark:bg-slate-700 shadow-sm text-primary dark:text-teal-300 ring-1 ring-black/5";
            const inactiveClass = "flex-1 py-3 rounded-xl text-sm font-bold text-slate-500 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-700/50 transition-all";

            if(tabName === 'search') {
                btnSearch.className = activeClass;
                btnHow.className = inactiveClass;
                document.getElementById('pickup-view').classList.add('hidden');
            } else {
                btnHow.className = activeClass;
                btnSearch.className = inactiveClass;
                document.getElementById('pickup-view').classList.add('hidden');
            }
        }

        // --- 7. Scanner, File Upload & Preview ---
        let html5QrcodeScanner = null;
        function toggleScanner() {
            const container = document.getElementById('scanner-container');
            if (!container.classList.contains('hidden')) {
                stopScanner();
                return;
            }
            container.classList.remove('hidden');
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 150 } },
                onScanSuccess,
                (error) => { }
            ).catch(err => {
                showToast("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÎºÎ¬Î¼ÎµÏÎ± Î® Î´ÎµÎ½ Î´ÏŒÎ¸Î·ÎºÎµ Î¬Î´ÎµÎ¹Î±.", 'error');
                container.classList.add('hidden');
            });
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    document.getElementById('scanner-container').classList.add('hidden');
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                });
            } else {
                document.getElementById('scanner-container').classList.add('hidden');
            }
        }

        function onScanSuccess(decodedText) {
            stopScanner();
            if(navigator.vibrate) navigator.vibrate(200);
            document.getElementById('barcode-value').value = decodedText;
            showPreview(`Barcode: ${decodedText}`);
            showToast("Î¤Î¿ Barcode ÏƒÎ±ÏÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!", 'success');
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                showPreview(`Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±: ${input.files[0].name}`);
                showToast("Î— Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î± Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ.", 'success');
            }
        }

        function showPreview(text) {
            document.getElementById('media-preview').classList.remove('hidden');
            document.getElementById('preview-text').textContent = text;
        }

        function clearMedia() {
            document.getElementById('media-preview').classList.add('hidden');
            document.getElementById('request-image').value = '';
            document.getElementById('barcode-value').value = '';
            showToast("Î¤Î± Î¼Î­ÏƒÎ± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·Ï‚ Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎ±Î½.", 'info');
        }
        
        // --- 8. Local Storage for User Data ---
        const LS_KEYS = { NAME: 'mediRadar_user_name', PHONE: 'mediRadar_user_phone', CITY: 'mediRadar_user_city' };
        function loadUserData() {
            try {
                document.getElementById('full-name').value = localStorage.getItem(LS_KEYS.NAME) || '';
                document.getElementById('phone').value = localStorage.getItem(LS_KEYS.PHONE) || '';
                document.getElementById('city').value = localStorage.getItem(LS_KEYS.CITY) || '';
            } catch (e) { console.error("Could not load user data from Local Storage:", e); }
        }
        function saveUserData() {
            try {
                localStorage.setItem(LS_KEYS.NAME, document.getElementById('full-name').value);
                localStorage.setItem(LS_KEYS.PHONE, document.getElementById('phone').value);
                localStorage.setItem(LS_KEYS.CITY, document.getElementById('city').value);
            } catch (e) { console.error("Could not save user data to Local Storage:", e); }
        }

        // --- 9. Speech Recognition (Voice Input) ---
        function startVoiceInput() {
            if (!SpeechRecognition) {
                showToast("Î— Ï†Ï‰Î½Î·Ï„Î¹ÎºÎ® Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÏƒÎµ Î±Ï…Ï„Î® Ï„Î· ÏƒÏ…ÏƒÎºÎµÏ…Î®.", 'error');
                return;
            }
            
            const btn = document.getElementById('voice-btn');
            const icon = document.getElementById('mic-icon');
            const input = document.getElementById('medicine');

            if (isListening) {
                recognition.stop();
                return; 
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'el-GR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isListening = true;
                icon.classList.replace('ph-microphone', 'ph-speaker-high');
                btn.classList.add('animate-pulse-slow', 'text-red-500', 'scale-110');
                showToast("Î‘ÎºÎ¿ÏÏ‰... Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÎµÎ¯Ï„Îµ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î¿Ï… Ï†Î±ÏÎ¼Î¬ÎºÎ¿Ï… ÎºÎ±Î¸Î±ÏÎ¬.", 'info', 3000);
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                input.value = transcript.trim();
                showToast(`Î‘Î½Î±Î³Î½Ï‰ÏÎ¯ÏƒÏ„Î·ÎºÎµ: "${transcript}"`, 'success');
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                let errorMessage = "Î£Ï†Î¬Î»Î¼Î± Ï†Ï‰Î½Î·Ï„Î¹ÎºÎ®Ï‚ Î±Î½Î±Î³Î½ÏÏÎ¹ÏƒÎ·Ï‚.";
                if (event.error === 'not-allowed') {
                    errorMessage = "Î”ÎµÎ½ Î´ÏŒÎ¸Î·ÎºÎµ Î¬Î´ÎµÎ¹Î± Ï‡ÏÎ®ÏƒÎ·Ï‚ Î¼Î¹ÎºÏÎ¿Ï†ÏÎ½Î¿Ï….";
                } else if (event.error === 'no-speech') {
                    errorMessage = "Î”ÎµÎ½ Î±Î½Î¹Ï‡Î½ÎµÏÏ„Î·ÎºÎµ Î¿Î¼Î¹Î»Î¯Î±. Î ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÏ„Îµ Î¾Î±Î½Î¬.";
                }
                showToast(errorMessage, 'error');
            };

            recognition.onend = () => {
                isListening = false;
                icon.classList.replace('ph-speaker-high', 'ph-microphone');
                btn.classList.remove('animate-pulse-slow', 'text-red-500', 'scale-110');
            };

            try {
                recognition.start();
            } catch (e) {
                console.warn("Recognition start error (likely already running):", e);
            }
        }
        
        // --- 10. Timer and Extension Logic (Firestore Dependent) ---
        function getStatusDocRef() {
             if (!db || !userId) {
                console.error("Firestore or UserID not ready.");
                return null;
            }
            // Private data path: /artifacts/{appId}/users/{userId}/pickup_settings/status
            return firebase.doc(db, `artifacts/${appId}/users/${userId}/pickup_settings/status`);
        }

        function startPickupStatusListener() {
            const docRef = getStatusDocRef();
            if (!docRef) return;

            firebase.onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    pickupDeadline = data.deadlineTimestamp;
                    updateTimerDisplay(pickupDeadline, data.lastExtendedTimestamp);
                } else {
                    // No active request, stop timer and show search tab
                    stopTimer();
                    if(!document.getElementById('pickup-view').classList.contains('hidden')) {
                         document.getElementById('pickup-view').classList.add('hidden');
                         document.getElementById('tab-search').classList.add('active');
                    }
                }
            }, (error) => {
                console.error("Error listening to status:", error);
                // Optionally show a toast error
            });
        }
        
        function updateTimerDisplay(deadline, lastExtendedTimestamp) {
            stopTimer(); // Clear existing interval if any
            
            if (deadline && deadline > Date.now()) {
                document.getElementById('pickup-view').classList.remove('hidden');
                document.getElementById('tab-search').classList.remove('active');
                
                // Check extension button status
                const now = Date.now();
                const canExtend = now - lastExtendedTimestamp >= EXTENSION_COOLDOWN_MS;
                const extendBtn = document.getElementById('extend-btn');
                
                extendBtn.disabled = !canExtend;
                extendBtn.classList.toggle('bg-gradient-to-r', canExtend);
                extendBtn.classList.toggle('from-cyan-500', canExtend);
                extendBtn.classList.toggle('to-teal-500', canExtend);
                extendBtn.classList.toggle('hover:from-cyan-600', canExtend);
                extendBtn.classList.toggle('hover:to-teal-600', canExtend);
                extendBtn.classList.toggle('text-white', canExtend);
                extendBtn.classList.toggle('bg-slate-200', !canExtend);
                extendBtn.classList.toggle('dark:bg-slate-700', !canExtend);
                extendBtn.classList.toggle('text-slate-500', !canExtend);

                if (canExtend) {
                    extendBtn.innerHTML = '<i class="ph ph-timer text-lg"></i> Î Î±ÏÎ¬Ï„Î±ÏƒÎ· 15\'';
                } else {
                    extendBtn.innerHTML = '<i class="ph ph-timer-fill text-lg"></i> Î Î±ÏÎ¬Ï„Î±ÏƒÎ· 15\' (Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎµ)';
                }


                timerInterval = setInterval(() => {
                    const remainingMs = deadline - Date.now();
                    const timerEl = document.getElementById('timer-display');
                    
                    if (remainingMs <= 0) {
                        timerEl.textContent = "00:00";
                        stopTimer();
                        showToast("ÎŸ Ï‡ÏÏŒÎ½Î¿Ï‚ Ï€Î±ÏÎ±Î»Î±Î²Î®Ï‚ Î­Î»Î·Î¾Îµ. Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î®ÏƒÏ„Îµ Î¼Îµ Ï„Î¿ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿.", 'error', 10000);
                        // Optional: Reset status in Firestore here if expired
                    } else {
                        const totalSeconds = Math.floor(remainingMs / 1000);
                        const minutes = Math.floor(totalSeconds / 60);
                        const seconds = totalSeconds % 60;
                        
                        const minStr = String(minutes).padStart(2, '0');
                        const secStr = String(seconds).padStart(2, '0');
                        timerEl.textContent = `${minStr}:${secStr}`;
                    }
                }, 1000);
                
            } else {
                // Deadline passed or not set, ensure timer is stopped
                stopTimer();
            }
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        async function extendPickupTime() {
            const docRef = getStatusDocRef();
            if (!docRef) return;
            
            const extendBtn = document.getElementById('extend-btn');
            if (extendBtn.disabled) {
                showToast("ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„Î·Î½ Ï€Î±ÏÎ¬Ï„Î±ÏƒÎ· Î¼ÏŒÎ½Î¿ Î¼Î¯Î± Ï†Î¿ÏÎ¬ ÎºÎ¬Î¸Îµ 24 ÏÏÎµÏ‚.", 'warning');
                return;
            }
            
            extendBtn.disabled = true; // Disable immediately
            
            try {
                const now = Date.now();
                const currentDeadline = pickupDeadline || now;
                
                // Add 15 minutes (900,000 milliseconds)
                const newDeadline = currentDeadline + (15 * 60 * 1000); 

                // Update Firestore: new deadline and set lastExtendedTimestamp
                await firebase.setDoc(docRef, {
                    deadlineTimestamp: newDeadline,
                    lastExtendedTimestamp: now,
                }, { merge: true });

                pickupDeadline = newDeadline; // Update local state immediately
                updateTimerDisplay(pickupDeadline, now); // Refresh timer and button state

                showToast("Î•Ï€Î¹Ï„Ï…Ï‡Î¯Î±! Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎ±Î½ 15 Î»ÎµÏ€Ï„Î¬ ÏƒÏ„Î·Î½ Ï€ÏÎ¿Î¸ÎµÏƒÎ¼Î¯Î± ÏƒÎ±Ï‚.", 'success');

            } catch (e) {
                console.error("Error extending pickup time:", e);
                showToast("Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î·Î½ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï„Î·Ï‚ Ï€Î±ÏÎ¬Ï„Î±ÏƒÎ·Ï‚. Î ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÏ„Îµ Î¾Î±Î½Î¬.", 'error');
                extendBtn.disabled = false; // Re-enable on error
            }
        }

        // --- 11. Submit ---
        const form = document.getElementById('request-form');
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!document.getElementById('gdpr-check').checked) {
                showToast("Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î±Ï€Î¿Î´ÎµÏ‡Ï„ÎµÎ¯Ï„Îµ Ï„Î¿Ï…Ï‚ ÏŒÏÎ¿Ï…Ï‚ Ï‡ÏÎ®ÏƒÎ·Ï‚ Î³Î¹Î± Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÏ„Îµ.", 'error'); 
                return;
            }

            if (!db || !userId) {
                showToast("Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î­Ï„Î¿Î¹Î¼Î·. Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ 1 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î¿.", 'warning');
                return;
            }

            saveUserData(); 

            // Calculate new deadline: 60 minutes from now
            const initialDeadline = Date.now() + (60 * 60 * 1000);
            
            // Set initial pickup status in Firestore
            try {
                const docRef = getStatusDocRef();
                await firebase.setDoc(docRef, {
                    deadlineTimestamp: initialDeadline,
                    lastExtendedTimestamp: 0, // Reset extension for a new request
                    medicineName: document.getElementById('medicine').value,
                    requestTime: Date.now(),
                    city: document.getElementById('city').value,
                }, { merge: true });
                
                // Firestore listener will automatically update the UI (pickup-view)
                document.getElementById('tab-search').classList.remove('active');
                
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#0d9488', '#38bdf8', '#ffffff']
                });
                showToast("Î¤Î¿ Î±Î¯Ï„Î·Î¼Î¬ ÏƒÎ±Ï‚ ÏƒÏ„Î¬Î»Î¸Î·ÎºÎµ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±! ÎÎµÎºÎ¹Î½Î¬ÎµÎ¹ Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚ Ï€Î±ÏÎ±Î»Î±Î²Î®Ï‚.", 'success');
                
            } catch (e) {
                console.error("Error setting initial request:", e);
                showToast("Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ Ï„Î¿Ï… Î±Î¹Ï„Î®Î¼Î±Ï„Î¿Ï‚. Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬.", 'error');
            }
        });

        async function resetApp() {
            stopTimer();
            // Clear status in Firestore (simulating completion/cancellation)
            try {
                const docRef = getStatusDocRef();
                 await firebase.setDoc(docRef, {
                    deadlineTimestamp: 0,
                    lastExtendedTimestamp: 0,
                }, { merge: true });

                // UI will be reset by the onSnapshot listener

            } catch (e) {
                console.error("Error resetting request status:", e);
            }
            document.getElementById('pickup-view').classList.add('hidden');
            document.getElementById('tab-search').classList.add('active');
            clearMedia();
            showToast("Î— Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ/Î±ÎºÏ…ÏÏÎ¸Î·ÎºÎµ.", 'warning');
        }

        // --- 12. Initialization ---
        window.onload = function() {
            loadUserData();
            initializeFirebase(); // Start Firebase initialization and listener
        };
    </script>
</body>
</html>
