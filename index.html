<!DOCTYPE html>
<html lang="el" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MediRadar App</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { primary: '#0d9488', secondary: '#0f172a' },
                    animation: { 
                        'float': 'float 15s linear infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite', 
                        'fade-in': 'fadeIn 0.3s ease-out forwards', 
                        'slide-up': 'slideUp 0.3s ease-out forwards' 
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* Floating Emojis Background */
        .emoji-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 0; pointer-events: none; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); transition: background 0.5s ease; }
        html.dark .emoji-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .emoji { position: absolute; bottom: -100px; font-size: 2rem; opacity: 0.4; animation: floatUp 15s linear infinite; z-index: 0; }
        @keyframes floatUp { 0% { transform: translateY(0) rotate(0deg); opacity: 0; } 10% { opacity: 0.5; } 90% { opacity: 0.5; } 100% { transform: translateY(-110vh) rotate(360deg); opacity: 0; } }
        
        /* Glassmorphism */
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); position: relative; z-index: 10; transition: all 0.3s ease; }
        html.dark .glass-card { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.3); }

        /* Tab Animation */
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }

        /* Autocomplete */
        #drug-suggestions, #city-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; max-height: 200px; overflow-y: auto; z-index: 50; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: none; margin-top: 4px; }
        .suggestion-item { padding: 0.75rem 1rem; cursor: pointer; font-size: 0.875rem; border-bottom: 1px solid #f1f5f9; } .suggestion-item:hover { background-color: #f0f9ff; }

        /* Radar Pulse */
        .radar-pulse { width: 100px; height: 100px; background: rgba(13, 148, 136, 0.2); border-radius: 50%; position: relative; margin: 0 auto; }
        .radar-pulse::before, .radar-pulse::after { content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); border-radius: 50%; border: 2px solid #0d9488; width: 100%; height: 100%; animation: ripple 2s linear infinite; opacity: 0; }
        .radar-pulse::after { animation-delay: 1s; }
        @keyframes ripple { 0% { width: 0; height: 0; opacity: 1; } 100% { width: 200%; height: 200%; opacity: 0; } }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-100 antialiased min-h-screen relative flex flex-col">

    <div id="emoji-container" class="emoji-bg"></div>

    <nav class="w-full max-w-lg mx-auto p-4 flex justify-between items-center z-20 relative">
        <div class="flex gap-2" id="user-nav-container">
            <button onclick="window.location.reload()" class="bg-white/90 dark:bg-slate-800/90 px-3 py-2 rounded-xl text-xs font-bold text-primary border border-primary/20 shadow-sm hover:shadow-md transition-all">
                <i class="ph ph-arrows-clockwise text-lg"></i> Reset
            </button>
        </div>

        <div class="flex gap-2">
            <button onclick="window.location.href='pharmacy.html'" class="bg-slate-800 hover:bg-slate-900 text-white px-3 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-1 shadow-lg shadow-slate-500/20 backdrop-blur-md">
                <i class="ph ph-briefcase text-lg"></i> Pro
            </button>
            <button onclick="toggleTheme()" class="bg-white/60 dark:bg-slate-700/60 w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-sm transition-transform border border-white/50"><i id="theme-icon" class="ph ph-moon-stars"></i></button>
        </div>
    </nav>

    <main class="w-full max-w-lg mx-auto p-4 pb-6 flex-grow z-10 relative">
        
        <header class="text-center mb-6">
            <div class="inline-flex items-center justify-center bg-white/70 dark:bg-slate-700/70 p-4 rounded-2xl mb-3 shadow-sm backdrop-blur-sm border border-white/50">
                <i class="ph ph-magnifying-glass text-4xl text-primary"></i>
            </div>
            <h1 class="text-3xl font-bold text-primary bg-clip-text text-transparent bg-gradient-to-r from-teal-600 to-cyan-500 drop-shadow-sm">MediRadar</h1>
            <p class="text-slate-500 dark:text-slate-400 text-sm mt-1 font-medium">Î’ÏÎµÏ‚ Ï„Î¿ Ï†Î¬ÏÎ¼Î±ÎºÏŒ ÏƒÎ¿Ï… Î¬Î¼ÎµÏƒÎ± & Ï„Î¿Ï€Î¹ÎºÎ¬.</p>
        </header>

        <div class="flex p-1.5 bg-slate-200/80 dark:bg-slate-800/80 rounded-2xl mb-6 glass-card">
            <button onclick="switchTab('search')" id="btn-search" class="flex-1 py-3 rounded-xl text-sm font-bold transition-all bg-white dark:bg-slate-700 shadow-sm text-primary dark:text-teal-300 ring-1 ring-black/5">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·</button>
            <button onclick="switchTab('how')" id="btn-how" class="flex-1 py-3 rounded-xl text-sm font-bold text-slate-500 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-700/50 transition-all">Î ÏÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯</button>
        </div>

        <div id="tab-search" class="tab-content active">
            <div class="glass-card rounded-3xl p-6 relative overflow-hidden">
                <form id="request-form" class="space-y-6">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">ÎŸÎ½Î¿Î¼Î±</label>
                            <input id="full-name" type="text" placeholder="ÎœÎ±ÏÎ¯Î± Î ." oninput="saveUserData()" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all text-slate-900 dark:text-white font-medium shadow-sm" required>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î¤Î·Î»ÎµÏ†Ï‰Î½Î¿</label>
                            <input id="phone" type="tel" placeholder="69..." oninput="saveUserData()" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all text-slate-900 dark:text-white font-medium shadow-sm" required>
                        </div>
                    </div>

                    <div class="space-y-2 relative">
                        <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î ÎµÏÎ¹Î¿Ï‡Î·</label>
                        <div class="relative">
                            <input id="city" type="text" placeholder="Î ÎµÏÎ¹Î¿Ï‡Î®..." oninput="saveUserData()" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 pr-32 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all text-slate-900 dark:text-white font-medium shadow-sm" required autocomplete="off">
                            <div id="city-suggestions"></div>
                            <button type="button" onclick="getLocation()" class="absolute right-2 top-2 bottom-2 px-3 bg-teal-100 dark:bg-teal-900/40 text-teal-800 dark:text-teal-200 border border-teal-200 dark:border-teal-700 rounded-xl text-xs font-bold hover:bg-teal-200 transition-colors flex items-center gap-1 shadow-sm">
                                <i class="ph ph-navigation-arrow text-sm"></i> ÎšÎ¿Î½Ï„Î¬ Î¼Î¿Ï…
                            </button>
                        </div>
                    </div>

                    <div class="border-t-2 border-dashed border-slate-200 dark:border-slate-700 my-2"></div>
                    
                    <div class="space-y-4">
                        <div class="space-y-2 relative">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î¦Î±ÏÎ¼Î±ÎºÎ¿</label>
                            <div class="relative">
                                <i class="ph ph-pill absolute left-4 top-4 text-slate-400 text-xl z-10"></i>
                                <input id="medicine" type="text" placeholder="Ï€.Ï‡. Depon" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl pl-12 pr-12 py-3.5 text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all text-slate-900 dark:text-white shadow-sm" required autocomplete="off">
                                <button type="button" onclick="startVoiceInput()" id="voice-btn" class="absolute right-2 top-2 bottom-2 w-8 h-8 rounded-full flex items-center justify-center text-xl text-slate-500 hover:text-primary transition-colors"><i class="ph ph-microphone"></i></button>
                                <div id="drug-suggestions"></div>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î Î¿ÏƒÎ¿Ï„Î·Ï„Î±</label>
                            <input id="quantity" type="number" min="1" value="1" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 text-center font-bold focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all text-slate-900 dark:text-white shadow-sm">
                        </div>

                        <div class="bg-slate-50 dark:bg-slate-800/80 rounded-2xl p-4 border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-primary/50 transition-colors text-center">
                            <label class="text-xs font-bold text-slate-600 dark:text-slate-300 uppercase mb-3 block">ğŸ“¸ Î¦Ï‰Ï„Î¿ / Barcode</label>
                            <div class="grid grid-cols-2 gap-3">
                                <button type="button" onclick="document.getElementById('file-input').click()" class="flex flex-col items-center justify-center bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 rounded-xl p-4 hover:shadow-md transition-all group">
                                    <i class="ph ph-camera text-3xl text-slate-600 dark:text-slate-300 mb-1 group-hover:text-blue-500 transition-colors"></i>
                                    <span class="text-xs font-semibold text-slate-600 dark:text-slate-300">Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±</span>
                                </button>
                                <button type="button" onclick="toggleScanner()" class="flex flex-col items-center justify-center bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 rounded-xl p-4 hover:shadow-md transition-all group">
                                    <i class="ph ph-barcode text-3xl text-slate-600 dark:text-slate-300 mb-1 group-hover:text-teal-500 transition-colors"></i>
                                    <span class="text-xs font-semibold text-slate-600 dark:text-slate-300">Scan</span>
                                </button>
                            </div>
                            <input type="file" id="file-input" class="hidden" accept="image/*" onchange="showToast('Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î± Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ!', 'success')">
                            
                            <div id="scanner-container" class="hidden mt-4 rounded-xl overflow-hidden relative bg-black border-2 border-primary h-64 shadow-lg"><div id="reader" style="width:100%;height:100%;"></div></div>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-gradient-to-r from-cyan-500 to-teal-500 hover:from-cyan-600 hover:to-teal-600 text-white text-lg font-bold py-4 rounded-2xl shadow-lg shadow-teal-500/30 transform active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                        <i class="ph ph-paper-plane-right text-xl"></i> Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î‘Î¹Ï„Î®Î¼Î±Ï„Î¿Ï‚
                    </button>
                </form>
            </div>
        </div>

        <div id="tab-results" class="tab-content">
            <div class="glass-card rounded-3xl p-6 min-h-[50vh] text-center">
                <div id="loading-state">
                    <div class="radar-pulse mt-10 mb-6"></div>
                    <h2 class="text-xl font-bold text-slate-800 dark:text-white">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·...</h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400">Î•Î¹Î´Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î± Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î±.</p>
                    <button onclick="resetApp()" class="mt-8 text-red-400 text-sm font-bold hover:text-red-500">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
                </div>
                
                <div id="responses-list" class="space-y-4 text-left hidden mt-4">
                    </div>
            </div>
        </div>

        <div id="pickup-view" class="hidden animate-slide-up">
            <div class="glass-card rounded-3xl p-8 text-center border-2 border-teal-500">
                <div class="w-24 h-24 bg-teal-100 dark:bg-teal-900/50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl ring-8 ring-teal-50 dark:ring-teal-900/20">
                    <i class="ph ph-check-circle text-4xl text-primary"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-1">ÎšÏÎ±Ï„Î®Î¸Î·ÎºÎµ!</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">ÎŸ Ï†Î±ÏÎ¼Î±ÎºÎ¿Ï€Î¿Î¹ÏŒÏ‚ ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ.</p>

                <div class="bg-white dark:bg-slate-700 rounded-2xl p-4 mb-6 shadow-inner border border-slate-200 dark:border-slate-600">
                    <p class="text-xs text-slate-500 dark:text-slate-300 font-bold uppercase mb-1">Î§ÏÎ¿Î½Î¿Ï‚ Î Î±ÏÎ±Î»Î±Î²Î·Ï‚</p>
                    <div id="timer-display" class="text-5xl font-mono font-bold text-primary dark:text-teal-400 tracking-tighter">60:00</div>
                    <p class="text-xs text-slate-400 mt-2">Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€Î±ÏÎ±Î»Î¬Î²ÎµÏ„Îµ ÎµÎ½Ï„ÏŒÏ‚ Ï„Î¿Ï… Ï‡ÏÏŒÎ½Î¿Ï….</p>
                </div>

                <div class="border-t border-dashed border-slate-300 dark:border-slate-600 my-4 pt-4">
                    <p class="text-xs text-slate-500 dark:text-slate-300 font-bold uppercase mb-2">ÎšÏ‰Î´Î¹ÎºÎ¿Ï‚ Î Î±ÏÎ±Î»Î±Î²Î·Ï‚</p>
                    <div id="pickup-code" class="text-3xl font-mono font-bold text-slate-800 dark:text-white tracking-[0.2em] bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 py-3 rounded-xl">------</div>
                    <p class="text-[10px] text-slate-400 mt-2">Î”ÎµÎ¯Î¾Ï„Îµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ ÏƒÏ„Î¿ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿.</p>
                </div>
                
                <button onclick="openGoogleMaps()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl mb-3 flex items-center justify-center gap-2 shadow-lg"><i class="ph ph-map-trifold"></i> Î§Î¬ÏÏ„Î·Ï‚</button>
                <button onclick="resetApp()" class="text-slate-400 text-sm underline hover:text-slate-600 dark:hover:text-slate-200">ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·</button>
            </div>
        </div>

        <div id="tab-how" class="tab-content">
            <div class="glass-card rounded-3xl p-6">
                <h3 class="text-xl font-bold mb-6 text-slate-800 dark:text-white flex items-center gap-2"><i class="ph ph-info text-primary"></i> Î ÏÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯;</h3>
                <ul class="space-y-6">
                    <li class="flex gap-4 items-start"><div class="bg-teal-100 dark:bg-teal-900 text-teal-700 dark:text-teal-300 w-10 h-10 rounded-full flex items-center justify-center font-bold flex-shrink-0 text-lg shadow-sm">1</div><div><h4 class="font-bold text-slate-800 dark:text-slate-200">Î‘Î¯Ï„Î·Î¼Î±</h4><p class="text-slate-600 dark:text-slate-400 text-sm mt-1">Î£Ï…Î¼Ï€Î»Î·ÏÏÎ½ÎµÎ¹Ï‚ Ï„Î· Ï†ÏŒÏÎ¼Î±, Î±Î½ÎµÎ²Î¬Î¶ÎµÎ¹Ï‚ Ï†Ï‰Ï„ÏŒ Î® ÏƒÎ±ÏÏÎ½ÎµÎ¹Ï‚ Ï„Î¿ barcode.</p></div></li>
                    <li class="flex gap-4 items-start"><div class="bg-teal-100 dark:bg-teal-900 text-teal-700 dark:text-teal-300 w-10 h-10 rounded-full flex items-center justify-center font-bold flex-shrink-0 text-lg shadow-sm">2</div><div><h4 class="font-bold text-slate-800 dark:text-slate-200">Î•Î¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·</h4><p class="text-slate-600 dark:text-slate-400 text-sm mt-1">Î¤Î¿ MediRadar ÏˆÎ¬Ï‡Î½ÎµÎ¹ ÏƒÏ„Î± Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î± ÎºÎ¿Î½Ï„Î¬ ÏƒÏ„Î·Î½ Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î± ÏƒÎ¿Ï….</p></div></li>
                    <li class="flex gap-4 items-start"><div class="bg-teal-100 dark:bg-teal-900 text-teal-700 dark:text-teal-300 w-10 h-10 rounded-full flex items-center justify-center font-bold flex-shrink-0 text-lg shadow-sm">3</div><div><h4 class="font-bold text-slate-800 dark:text-slate-200">ÎšÏÎ¬Ï„Î·ÏƒÎ·</h4><p class="text-slate-600 dark:text-slate-400 text-sm mt-1">Î›Î±Î¼Î²Î¬Î½ÎµÎ¹Ï‚ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚, ÎµÏ€Î¹Î»Î­Î³ÎµÎ¹Ï‚ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿ ÎºÎ±Î¹ Ï€Î±ÏÎ±Î»Î±Î¼Î²Î¬Î½ÎµÎ¹Ï‚!</p></div></li>
                </ul>
            </div>
        </div>

    </main>

    <footer class="mt-auto py-6 bg-white/50 dark:bg-slate-900/50 backdrop-blur-md border-t border-slate-200 dark:border-slate-800 z-10">
        <div class="max-w-lg mx-auto px-4 text-center">
            <div class="flex justify-center gap-4 mb-4">
                <a href="#" class="w-9 h-9 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center text-slate-600 dark:text-slate-300 hover:bg-primary hover:text-white transition-colors shadow-sm"><i class="ph ph-facebook-logo text-lg"></i></a>
                <a href="#" class="w-9 h-9 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center text-slate-600 dark:text-slate-300 hover:bg-primary hover:text-white transition-colors shadow-sm"><i class="ph ph-instagram-logo text-lg"></i></a>
            </div>
            <p class="text-xs text-slate-400 dark:text-slate-600">Â© 2025 MediRadar.</p>
        </div>
    </footer>

    <div id="toast-container" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-sm pointer-events-none"></div>

    <script>
        // CONFIG
        const SB_URL = "https://qzerrisyowkfkmcyxmav.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZXJyaXN5b3drZmttY3l4bWF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTcxODQsImV4cCI6MjA3NTU5MzE4NH0.alkvHkOQPBTwY3daUcKAEsf4nt0kizuU3rYI2c2InPk";

        // DATA
        const cities = ["Î‘Î¸Î®Î½Î±", "Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·", "Î Î¬Ï„ÏÎ±", "Î—ÏÎ¬ÎºÎ»ÎµÎ¹Î¿", "Î›Î¬ÏÎ¹ÏƒÎ±", "Î’ÏŒÎ»Î¿Ï‚", "Î™Ï‰Î¬Î½Î½Î¹Î½Î±", "Î¤ÏÎ¯ÎºÎ±Î»Î±", "Î§Î±Î»ÎºÎ¯Î´Î±", "Î£Î­ÏÏÎµÏ‚", "Î ÎµÎ¹ÏÎ±Î¹Î¬Ï‚", "Î ÎµÏÎ¹ÏƒÏ„Î­ÏÎ¹", "ÎšÎ±Î»Î»Î¹Î¸Î­Î±", "Î“Î»Ï…Ï†Î¬Î´Î±", "ÎœÎ±ÏÎ¿ÏÏƒÎ¹", "ÎšÎ·Ï†Î¹ÏƒÎ¹Î¬"];
        const medicines = ["Depon", "Panadol", "Algofren", "Mesulid", "Voltaren", "Augmentin", "Amoxil", "Aerolin", "Ponstan", "Buscopan", "Ibuprofen", "Paracetamol", "Aspirin", "Zirtek", "Clarityne"];

        // STATE
        let currentUser = null;
        let currentRequestId = null;
        let userLocation = { lat: null, lon: null };
        let pickupTimer = null;
        let html5QrcodeScanner = null;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        window.onload = async function() {
            createEmojis();
            setupAutocomplete('city', 'city-suggestions', cities);
            setupAutocomplete('medicine', 'drug-suggestions', medicines);
            loadUserData();

            window.db = window.supabase.createClient(SB_URL, SB_KEY);
            const { data, error } = await window.db.auth.signInAnonymously();
            if(!error) currentUser = data.user;
            else showToast("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚", "error");

            document.getElementById('request-form').addEventListener('submit', handleFormSubmit);
        };

        async function handleFormSubmit(e) {
            e.preventDefault();
            if(!currentUser) return showToast("Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Ï„Î· ÏƒÏÎ½Î´ÎµÏƒÎ·...", "error");

            const btn = e.target.querySelector('button[type="submit"]');
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="ph ph-spinner animate-spin text-xl"></i> Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®...'; 
            btn.disabled = true;

            const formData = {
                user_id: currentUser.id,
                customer_name: document.getElementById('full-name').value,
                phone: document.getElementById('phone').value,
                location: document.getElementById('city').value,
                medicine_name: document.getElementById('medicine').value,
                quantity: document.getElementById('quantity').value,
                status: 'pending'
            };

            const { data, error } = await window.db.from('requests').insert([formData]).select().single();

            if(error) {
                showToast("Î£Ï†Î¬Î»Î¼Î±: " + error.message, "error");
                btn.innerHTML = oldText; btn.disabled = false;
            } else {
                currentRequestId = data.id;
                saveUserData();
                // Confetti Effect
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#0d9488', '#38bdf8'] });
                
                switchTab('results');
                listenForResponsesRobust(data.id);
            }
        }

        // --- ROBUST LISTENER ---
        function listenForResponsesRobust(reqId) {
            window.db.channel('public:responses')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'responses' }, (payload) => {
                if (payload.new.request_id === reqId) {
                    displayResponse(payload.new);
                }
            })
            .subscribe();
        }

        function displayResponse(resp) {
            const list = document.getElementById('responses-list');
            document.getElementById('loading-state').classList.add('hidden');
            list.classList.remove('hidden');
            
            try { new Audio('https://cdn.freesound.org/previews/536/536108_10463375-lq.mp3').play().catch(e=>{}); } catch(e){}
            showToast("Î’ÏÎ­Î¸Î·ÎºÎµ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿!", "success");

            const html = `
                <div class="glass-card bg-white dark:bg-slate-800 p-5 rounded-2xl border-l-4 border-teal-500 animate-slide-up shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-lg text-teal-700 dark:text-teal-300">Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿ Î’ÏÎ­Î¸Î·ÎºÎµ!</h4>
                            <p class="text-sm font-semibold mt-1 text-slate-700 dark:text-slate-300">${resp.message}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">Î‘Ï€ÏŒÏƒÏ„Î±ÏƒÎ·: <span class="font-mono">0.8 Ï‡Î»Î¼</span></p>
                        </div>
                        <div class="text-2xl font-bold text-slate-800 dark:text-white">${resp.price > 0 ? resp.price+'â‚¬' : ''}</div>
                    </div>
                    <button onclick="acceptOffer('${resp.pharmacist_id}')" class="w-full mt-4 bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-xl shadow-md active:scale-95 transition-all">
                        ÎšÏÎ¬Ï„Î·ÏƒÎ· Î¤ÏÏÎ±
                    </button>
                </div>
            `;
            list.innerHTML = html;
        }

        async function acceptOffer(pharmacyId) {
            if(!currentRequestId) return;
            const { error } = await window.db.from('requests').update({ status: 'reserved', winner_pharmacy_id: pharmacyId }).eq('id', currentRequestId);
            if(error) showToast(error.message, 'error');
            else {
                document.getElementById('pickup-view').classList.remove('hidden');
                document.getElementById('tab-results').classList.remove('active');
                document.getElementById('pickup-code').innerText = currentRequestId.substring(0, 6);
                startTimer();
            }
        }

        function startTimer() {
            let duration = 3600; 
            const el = document.getElementById('timer-display');
            pickupTimer = setInterval(() => {
                const m = Math.floor(duration / 60);
                const s = duration % 60;
                el.innerText = `${m}:${s<10?'0':''}${s}`;
                if(--duration < 0) { clearInterval(pickupTimer); el.innerText = "Î•Î›Î—ÎÎ•"; el.classList.add('text-red-500'); }
            }, 1000);
        }

        // --- EXTRAS ---
        function toggleScanner() {
            const c = document.getElementById('scanner-container');
            if(!c.classList.contains('hidden')) { 
                if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => { c.classList.add('hidden'); html5QrcodeScanner.clear(); });
                return;
            }
            c.classList.remove('hidden');
            setTimeout(() => {
                html5QrcodeScanner = new Html5Qrcode("reader");
                html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (t) => {
                    html5QrcodeScanner.stop().then(() => c.classList.add('hidden'));
                    document.getElementById('medicine').value = t; 
                    showToast("Barcode: " + t, 'success');
                }, (e) => {});
            }, 100);
        }

        function startVoiceInput() {
            if (!SpeechRecognition) return showToast("Î”ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÏ„Î±Î¹ Ï†Ï‰Î½Î·Ï„Î¹ÎºÎ® ÎµÎ½Ï„Î¿Î»Î®", 'error');
            const recognition = new SpeechRecognition();
            recognition.lang = 'el-GR';
            recognition.onstart = () => showToast("ÎœÎ¹Î»Î®ÏƒÏ„Îµ Ï„ÏÏÎ±...", 'info');
            recognition.onresult = (e) => { document.getElementById('medicine').value = e.results[0][0].transcript; showToast("OK!", 'success'); };
            recognition.start();
        }

        // --- UTILS & UI ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            document.getElementById('pickup-view').classList.add('hidden');
            
            const btnSearch = document.getElementById('btn-search');
            const btnHow = document.getElementById('btn-how');
            const activeClass = "flex-1 py-3 rounded-xl text-sm font-bold transition-all bg-white dark:bg-slate-700 shadow-sm text-primary dark:text-teal-300 ring-1 ring-black/5";
            const inactiveClass = "flex-1 py-3 rounded-xl text-sm font-bold text-slate-500 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-700/50 transition-all";
            
            if(id === 'search') { btnSearch.className = activeClass; btnHow.className = inactiveClass; }
            else { btnHow.className = activeClass; btnSearch.className = inactiveClass; }
        }

        function createEmojis() {
            const container = document.getElementById('emoji-container');
            const emojis = ['ğŸ’Š', 'ğŸ©º', 'ğŸ¥', 'ğŸ©¹', 'ğŸ§ª', 'ğŸ§¬', 'ğŸ§´', 'ğŸ”¬', 'ğŸš‘', 'ğŸ¦·'];
            for(let i=0; i<15; i++) {
                const el = document.createElement('div');
                el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                el.classList.add('emoji');
                el.style.left = Math.random() * 100 + '%';
                el.style.animationDuration = (12 + Math.random() * 20) + 's'; 
                el.style.animationDelay = (Math.random() * 10) + 's';
                el.style.fontSize = (1.5 + Math.random() * 2.5) + 'rem';
                container.appendChild(el);
            }
        }

        function getLocation() {
            if(!navigator.geolocation) return showToast("GPS Error", "error");
            document.querySelector('button[onclick="getLocation()"]').innerHTML = '<i class="ph ph-spinner animate-spin"></i>';
            navigator.geolocation.getCurrentPosition(async (p) => {
                userLocation = { lat: p.coords.latitude, lon: p.coords.longitude };
                try {
                    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLocation.lat}&lon=${userLocation.lon}`);
                    const d = await r.json();
                    document.getElementById('city').value = (d.address.road || "") + ", " + (d.address.suburb || d.address.city || "");
                    showToast("Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î± OK!", "success");
                } catch(e) { document.getElementById('city').value = "Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î± OK"; }
                document.querySelector('button[onclick="getLocation()"]').innerHTML = '<i class="ph ph-navigation-arrow text-sm"></i> ÎšÎ¿Î½Ï„Î¬ Î¼Î¿Ï…';
                saveUserData();
            }, () => { showToast("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±", "error"); });
        }

        function setupAutocomplete(id, boxId, data) {
            const inp = document.getElementById(id);
            const box = document.getElementById(boxId);
            inp.addEventListener('input', (e) => {
                const v = e.target.value.toLowerCase();
                if(v.length < 1) { box.style.display = 'none'; return; }
                const m = data.filter(i => i.toLowerCase().includes(v));
                box.innerHTML = m.map(i => `<div class="suggestion-item" onclick="document.getElementById('${id}').value='${i}'; document.getElementById('${boxId}').style.display='none'">${i}</div>`).join('');
                box.style.display = m.length ? 'block' : 'none';
            });
            document.addEventListener('click', (e) => { if(!inp.contains(e.target)) box.style.display = 'none'; });
        }

        function toggleTheme() { document.documentElement.classList.toggle('dark'); }
        function saveUserData() { localStorage.setItem('mr_user', JSON.stringify({ n: document.getElementById('full-name').value, p: document.getElementById('phone').value, c: document.getElementById('city').value })); }
        function loadUserData() { const d = JSON.parse(localStorage.getItem('mr_user') || '{}'); if(d.n) document.getElementById('full-name').value = d.n; if(d.p) document.getElementById('phone').value = d.p; if(d.c) document.getElementById('city').value = d.c; }
        function resetApp() { window.location.reload(); }
        function showToast(m, t='info') { const c = document.getElementById('toast-container'); const e = document.createElement('div'); const bg = t==='success' ? 'bg-green-500' : (t==='error'?'bg-red-500':'bg-slate-800'); e.className = `p-3 rounded-xl shadow-lg text-white text-sm mb-2 ${bg} animate-fade-in`; e.innerText = m; c.appendChild(e); setTimeout(()=>e.remove(), 3000); }
        function openGoogleMaps() { window.open(`https://maps.google.com/?q=${userLocation.lat},${userLocation.lon}`, '_blank'); }
    </script>
</body>
</html>
