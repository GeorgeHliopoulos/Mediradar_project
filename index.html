<!DOCTYPE html>
<html lang="el" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MediRadar</title>

  <!-- Favicon (inline για να μην έχεις 404) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect rx='14' width='64' height='64' fill='%2329a3a3'/%3E%3Cpath d='M30 8h4v7a15 15 0 0 1 15 15h7v4h-7a15 15 0 0 1-15 15v7h-4v-7a15 15 0 0 1-15-15h-7v-4h7a15 15 0 0 1 15-15z' fill='white'/%3E%3Ccircle cx='32' cy='30' r='8' fill='white'/%3E%3C/svg%3E">

  <!-- Android/Chrome PWA -->
  <meta name="mobile-web-app-capable" content="yes">
  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <!-- Tailwind (dev με CDN). Για production build θα το αλλάξουμε σε PostCSS/CLI. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: { brand: { 500:'#29a3a3', 600:'#208181', 700:'#196464' } },
          boxShadow: { soft:'0 16px 40px rgba(2,6,23,.12)' }
        }
      }
    }
  </script>

  <style>
    .app-bg{
      background:
        radial-gradient(1100px 600px at 0% -10%, rgba(132,197,244,.30), transparent 60%),
        radial-gradient(900px 540px at 110% 0%, rgba(199,166,244,.22), transparent 58%),
        radial-gradient(1000px 600px at 25% 120%, rgba(247,141,167,.18), transparent 62%),
        radial-gradient(800px 520px at 120% 120%, rgba(157,224,214,.20), transparent 60%),
        linear-gradient(180deg, #f6fbfb 0%, #f8fafc 40%, #fbfcfe 100%);
    }
    .dark .app-bg{
      background:
        radial-gradient(1100px 600px at 0% -10%, rgba(132,197,244,.16), transparent 60%),
        radial-gradient(900px 540px at 110% 0%, rgba(199,166,244,.14), transparent 58%),
        radial-gradient(1000px 600px at 25% 120%, rgba(247,141,167,.12), transparent 62%),
        radial-gradient(800px 520px at 120% 120%, rgba(157,224,214,.12), transparent 60%),
        linear-gradient(180deg, #0b1515, #0b1515 45%, #0b1515 100%);
    }
    .ac-list { position:absolute; inset-inline:0; top:100%; z-index:40 }
    .ac-item { cursor:pointer }
    .badge { display:inline-flex; align-items:center; gap:6px; padding:.25rem .5rem; border-radius:999px; font-size:.75rem; }
    .badge-exact { background:rgba(41,163,163,.12); color:#1f4f4f; }
    .dark .badge-exact { color:#7edbd9; background:rgba(41,163,163,.15); }
    .badge-generic { background:rgba(245,158,11,.15); color:#92400e; }
    .dark .badge-generic { background:rgba(245,158,11,.2); color:#facc15; }
    .badge-distance { background:rgba(59,130,246,.12); color:#1e3a8a; }
    .dark .badge-distance { background:rgba(59,130,246,.2); color:#93c5fd; }
    @keyframes spinHourglass { 0%{transform:rotate(0)} 50%{transform:rotate(180deg)} 100%{transform:rotate(360deg)} }
    /* μικρό, διακριτικό toast για ειδοποιήσεις */
    #push-toast { transition: transform .25s ease, opacity .25s ease; }
    #push-toast.hidden { opacity:0; pointer-events:none; transform: translateY(6px); }
    .lang-btn { transition: all .2s ease; }
    .lang-btn[data-active="true"] {
      background: linear-gradient(135deg, #29a3a3, #208181);
      color: #fff;
      box-shadow: 0 12px 24px rgba(32,129,129,.25);
    }
    .dark .lang-btn[data-active="true"] {
      background: linear-gradient(135deg, #7edbd9, #4cc2c1);
      color: #062322;
    }
    .flag-icon { display:inline-flex; align-items:center; justify-content:center; }
    .flag-icon svg { width:24px; height:16px; border-radius:2px; box-shadow:0 0 0 1px rgba(15,23,42,.15); }
    .dark .flag-icon svg { box-shadow:0 0 0 1px rgba(148,163,184,.4); }
    .barcode-highlight { box-shadow:0 0 0 3px rgba(16,185,129,.45); }
    .cta-search-priority { transition: transform .2s ease, box-shadow .2s ease; }
    @media (min-width: 640px) {
      .cta-search-priority { transform: scale(1.1); }
      .cta-search-priority:focus-visible { box-shadow: 0 0 0 3px rgba(41,163,163,.35); }
    }
  </style>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#29a3a3" />
</head>
<body class="min-h-full app-bg text-slate-900 dark:text-slate-200 font-sans">

  <!-- Confetti -->
  <canvas id="confetti" class="fixed inset-0 pointer-events-none z-[60]" style="display:none;"></canvas>

  <!-- Top bar -->
  <div class="absolute top-3 left-3 right-3 z-50">
    <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
      <button id="pro-trigger" data-open-pro type="button" class="flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-2xl bg-white/80 dark:bg-white/10 border border-slate-200 dark:border-slate-700 backdrop-blur shadow-sm hover:bg-white dark:hover:bg-white/20">
        <span aria-hidden="true">💼</span>
        <span id="t-pro">Για επαγγελματίες</span>
      </button>

      <div class="flex items-center gap-2 rounded-2xl bg-white/80 dark:bg-white/10 border border-slate-200 dark:border-slate-700 backdrop-blur px-2 py-1 shadow-sm">
        <div class="flex items-center gap-1">
          <button id="lang-el" type="button" class="lang-btn px-3 py-1.5 text-xs sm:text-sm font-semibold rounded-xl flex items-center gap-2 bg-white/60 dark:bg-white/10 text-slate-800 dark:text-slate-200 hover:bg-white dark:hover:bg-white/20">
            <span aria-hidden="true" class="flag-icon">
              <svg viewBox="0 0 28 20" role="presentation" focusable="false" xmlns="http://www.w3.org/2000/svg">
                <rect width="28" height="20" fill="#0d5eaf"></rect>
                <g fill="#ffffff">
                  <rect y="2" width="28" height="2"></rect>
                  <rect y="6" width="28" height="2"></rect>
                  <rect y="10" width="28" height="2"></rect>
                  <rect y="14" width="28" height="2"></rect>
                  <rect y="18" width="28" height="2"></rect>
                </g>
                <rect width="10" height="10" fill="#0d5eaf"></rect>
                <rect x="4" width="2" height="10" fill="#ffffff"></rect>
                <rect y="4" width="10" height="2" fill="#ffffff"></rect>
              </svg>
            </span>
            <span id="t-langElLabel" class="hidden sm:inline">Ελληνικά</span>
            <span class="sm:hidden">EL</span>
          </button>
          <button id="lang-en" type="button" class="lang-btn px-3 py-1.5 text-xs sm:text-sm font-semibold rounded-xl flex items-center gap-2 bg-white/60 dark:bg-white/10 text-slate-800 dark:text-slate-200 hover:bg-white dark:hover:bg-white/20">
            <span aria-hidden="true" class="flag-icon">
              <svg viewBox="0 0 30 20" role="presentation" focusable="false" xmlns="http://www.w3.org/2000/svg">
                <rect width="30" height="20" fill="#012169"></rect>
                <path d="M0 0L30 20M30 0L0 20" stroke="#ffffff" stroke-width="6" stroke-linecap="square"></path>
                <path d="M0 0L30 20M30 0L0 20" stroke="#c8102e" stroke-width="2.5" stroke-linecap="square"></path>
                <rect x="13" width="4" height="20" fill="#ffffff"></rect>
                <rect y="8" width="30" height="4" fill="#ffffff"></rect>
                <rect x="14" width="2" height="20" fill="#c8102e"></rect>
                <rect y="9" width="30" height="2" fill="#c8102e"></rect>
              </svg>
            </span>
            <span id="t-langEnLabel" class="hidden sm:inline">Αγγλικά</span>
            <span class="sm:hidden">EN</span>
          </button>
        </div>

        <button id="theme-toggle" type="button" class="px-2.5 py-1.5 rounded-xl hover:bg-white dark:hover:bg-white/20">
          <span id="icon-sun" class="hidden">🌞</span><span id="icon-moon">🌙</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Pending toast -->
  <div id="pending-toast" class="hidden fixed top-16 left-1/2 -translate-x-1/2 z-40 w-[min(760px,92vw)] pointer-events-none">
    <div class="pointer-events-auto rounded-2xl p-4 border border-amber-300/70 bg-amber-50 text-amber-900 dark:bg-amber-900/30 dark:text-amber-100 dark:border-amber-800 shadow-soft">
      <div class="flex items-center gap-4">
        <div class="text-4xl" style="animation:spinHourglass 1.2s linear infinite">⏳</div>
        <div class="text-sm sm:text-base">
          <div id="t-pending">Περιμένουμε απαντήσεις από τα κοντινά φαρμακεία…</div>
          <div class="mt-1 font-semibold opacity-80"><span id="wait-elapsed">0s</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- μικρό push toast -->
  <div id="push-toast" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 z-40 w-[min(680px,94vw)]">
    <div class="rounded-2xl p-4 border border-sky-300/70 bg-sky-50 text-sky-900 dark:bg-sky-900/30 dark:text-sky-100 dark:border-sky-800 shadow-soft flex items-center justify-between gap-3">
      <div class="text-sm">
        🔔 Θες να λαμβάνεις ειδοποίηση όταν απαντά ένα φαρμακείο;
      </div>
      <div class="flex gap-2">
        <button id="push-deny" class="px-3 py-1.5 rounded-xl border hover:bg-white/70 dark:hover:bg-white/10 text-sm">Όχι τώρα</button>
        <button id="push-allow" class="px-3 py-1.5 rounded-xl bg-brand-600 text-white font-semibold text-sm">Ενεργοποίηση</button>
      </div>
    </div>
  </div>

  <!-- SPLASH -->
  <section id="splash" class="min-h-[100svh] grid place-items-center relative px-4">
    <div class="w-full max-w-4xl text-center">
      <div class="mx-auto w-24 h-24 rounded-3xl bg-brand-600 text-white grid place-items-center shadow-soft">
        <svg viewBox="0 0 24 24" class="w-10 h-10" aria-hidden="true">
          <path fill="currentColor" d="M11 2h2v3.06A7 7 0 0 1 18.94 11H22v2h-3.06A7 7 0 0 1 13 18.94V22h-2v-3.06A7 7 0 0 1 5.06 13H2v-2h3.06A7 7 0 0 1 11 5.06V2Zm1 5a5 5 0 1 0 0 10a5 5 0 0 0 0-10Z"/>
        </svg>
      </div>

      <h1 class="mt-5 text-4xl sm:text-5xl font-extrabold tracking-tight">MediRadar</h1>
      <p id="t-hero" class="mt-2 text-lg text-slate-600 dark:text-slate-400">Άμεση εύρεση διαθεσιμότητας φαρμάκων σε κοντινά φαρμακεία.</p>

      <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-3xl mx-auto">
        <button id="cta-search" class="cta-search-priority px-6 py-4 rounded-2xl bg-gradient-to-r from-brand-500 to-brand-600 text-white font-semibold shadow-soft hover:opacity-95 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500">
          <span id="t-searchBTN">Αναζήτηση Φαρμάκου</span>
        </button>
        <button id="cta-how" class="px-6 py-4 rounded-2xl bg-white/85 backdrop-blur border border-slate-200 hover:bg-white font-semibold focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/70">
          <span id="t-howBTN">Πώς λειτουργεί</span>
        </button>
      </div>

      <button id="cta-install" class="mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-brand-600 text-brand-700 font-semibold bg-white/80 backdrop-blur hover:bg-white hidden">
        📲 <span id="t-installBTN">Εγκατάσταση</span>
      </button>

      <div class="sm:hidden mt-4">
        <button id="pro-trigger-mobile" data-open-pro type="button" class="text-sm underline decoration-2">
          <span id="t-pro-m">Για επαγγελματίες</span>
        </button>
      </div>
    </div>
  </section>

  <!-- APP -->
  <main id="app" class="hidden mx-auto max-w-3xl px-4 pb-16">
    <header class="sticky top-0 z-30 -mt-3 mb-4">
      <div class="flex items-center justify-between px-2 py-3 rounded-2xl bg-white/80 dark:bg-slate-900/70 backdrop-blur border border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-2">
          <button id="backHome" type="button" data-go-home class="px-3 py-1.5 rounded-lg border text-sm hover:bg-slate-50 dark:hover:bg-slate-800">← <span id="t-home">Αρχική</span></button>
          <span id="t-searchTitle" class="font-semibold">Αναζήτηση Φαρμάκου</span>
        </div>
      </div>
    </header>

    <section class="grid grid-cols-1 gap-4 sm:gap-5">
      <!-- City -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">📍</span>
          <span id="t-city">Πόλη</span>
        </label>
        <select id="city" required
                class="mt-2 w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30">
          <option value="">— Επιλογή —</option>
          <!-- Μεγάλα αστικά κέντρα + extra -->
          <option>Αθήνα</option><option>Πειραιάς</option><option>Θεσσαλονίκη</option>
          <option>Πάτρα</option><option>Ηράκλειο</option><option>Λάρισα</option>
          <option>Βόλος</option><option>Ιωάννινα</option><option>Χανιά</option>
          <option>Καλαμάτα</option><option>Καβάλα</option><option>Ξάνθη</option>
          <option>Κομοτηνή</option><option>Αλεξανδρούπολη</option><option>Σέρρες</option>
          <option>Τρίκαλα</option><option>Λαμία</option><option>Χαλκίδα</option>
          <option>Κόρινθος</option><option>Ρόδος</option><option>Μυτιλήνη</option>
          <option>Ρέθυμνο</option><option>Κέρκυρα</option><option>Χίος</option>
          <option>Αγρίνιο</option><option>Βέροια</option><option>Δράμα</option>
          <option>Κατερίνη</option><option>Κοζάνη</option><option>Ναύπλιο</option>
          <option>Πύργος</option><option>Γλυφάδα</option>
          <!-- Αττική – δήμοι -->
          <option>Μαρούσι</option><option>Χαλάνδρι</option><option>Κηφισιά</option>
          <option>Νέα Ιωνία</option><option>Μεταμόρφωση</option><option>Περιστέρι</option>
          <option>Αιγάλεω</option><option>Καλλιθέα</option><option>Νέα Σμύρνη</option>
          <option>Παλαιό Φάληρο</option><option>Άλιμος</option><option>Ιλίου</option>
          <option>Ζωγράφου</option><option>Γαλάτσι</option><option>Βύρωνας</option>
          <option>Δάφνη</option><option>Ηλιούπολη</option><option>Νίκαια</option>
          <option>Κορυδαλλός</option><option>Πετρούπολη</option><option>Αργυρούπολη</option>
          <option>Ηράκλειο Αττικής</option><option>Νέα Φιλαδέλφεια</option><option>Νέα Χαλκηδόνα</option>
          <!-- Κρήτη extra -->
          <option>Σητεία</option><option>Ιεράπετρα</option><option>Άγιος Νικόλαος</option>
          <!-- Νησιά extra -->
          <option>Κως</option><option>Σάμος</option><option>Σύρος</option><option>Πάρος</option><option>Νάξος</option>
        </select>
      </div>

      <!-- Medicine -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">🔎</span>
          <span id="t-medname">Όνομα Φαρμάκου</span>
        </label>
        <div class="mt-2 relative">
          <input id="medicine-name" type="text" autocomplete="off"
                 class="w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30 placeholder:text-slate-400"
                 placeholder="π.χ. Augmentin 875mg" />
          <div id="ac-medicine" class="ac-list hidden rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-lg"></div>
        </div>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400" id="t-formatTip">Συμβουλή: Εμπορική ονομασία + δοσολογία (π.χ. “500mg”).</p>
        <div class="mt-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/40 p-4">
          <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
            <div class="space-y-1">
              <div class="text-sm font-semibold flex items-center gap-2">
                <span class="w-6 h-6 grid place-items-center">📷</span>
                <span id="t-barcodeTitle">Σάρωση barcode συνταγής ή κουτιού</span>
                <span id="t-barcodeOptional" class="text-xs font-normal text-slate-400">(προαιρετικά)</span>
              </div>
              <p id="t-barcodeHelp" class="text-xs text-slate-500 dark:text-slate-400">Σάρωσε τον γραμμωτό κωδικό για να συμπληρωθεί αυτόματα.</p>
            </div>
            <button id="barcode-start" type="button" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-900 text-white text-xs sm:text-sm font-semibold shadow-soft hover:bg-slate-700 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-slate-200">
              <span aria-hidden="true">🎯</span>
              <span id="t-barcodeStart">Άνοιγμα κάμερας</span>
            </button>
          </div>
          <input id="barcode-value" type="text" inputmode="numeric" pattern="[0-9]*" class="mt-3 w-full px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white/95 dark:bg-slate-900 focus:outline-none focus:ring-4 focus:ring-brand-500/30 placeholder:text-slate-400" placeholder="Ο κωδικός θα εμφανιστεί εδώ" autocomplete="off" />
        </div>
      </div>

      <!-- Quantity + Type -->
      <div class="grid sm:grid-cols-2 gap-4">
        <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
          <label class="text-sm font-semibold flex items-center gap-2">
            <span class="w-6 h-6 grid place-items-center">📦</span>
            <span id="t-qty">Ποσότητα (τεμάχια/κουτιά)</span>
          </label>
          <input id="quantity" type="number" min="1" value="1" required
                 class="mt-2 w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30" />
        </div>

        <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
          <label class="text-sm font-semibold flex items-center gap-2">
            <span class="w-6 h-6 grid place-items-center">💊</span>
            <span id="t-type">Τύπος Φαρμάκου</span>
          </label>
          <select id="medicine-type"
                  class="mt-2 w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30">
            <option value="">— Επιλογή —</option>
            <option>Χάπι</option><option>Κάψουλα</option><option>Σκόνη</option>
            <option>Υγρό</option><option>Σιρόπι</option><option>Σταγόνες</option>
            <option>Εισπνεόμενο</option><option>Σπρέι</option><option>Ρινικό σπρέι</option>
            <option>Οφθαλμικές σταγόνες</option><option>Αλοιφή</option><option>Δερματική Κρέμα</option>
            <option>Ζελέ</option><option>Επίθεμα</option><option>Υπόθετο</option>
            <option>Πένα (προγεμισμένη)</option><option>Διάλυμα έγχυσης</option>
          </select>
        </div>
      </div>

      <!-- Substance -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">🧪</span>
          <span id="t-substance">Δραστική Ουσία</span> <span class="text-slate-400 ml-1" id="t-optional">(προαιρετικά)</span>
        </label>
        <div class="mt-2 relative">
          <input id="active-substance" type="text" autocomplete="off"
                 class="w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30 placeholder:text-slate-400"
                 placeholder="π.χ. Παρακεταμόλη" />
          <div id="ac-substance" class="ac-list hidden rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-lg"></div>
        </div>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400" id="t-doseEx">Παράδειγμα δοσολογίας: Paracetamol 500mg.</p>
      </div>

      <!-- Generic -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <p class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">✅</span>
          <span id="t-genericQ">Αν δεν είναι διαθέσιμο το συγκεκριμένο εμπορικό, επιτρέπεις να σου προτείνουμε ισοδύναμο (γενόσημο);</span>
        </p>
        <div class="mt-3 flex gap-4">
          <label class="inline-flex items-center gap-2"><input type="radio" name="allow-generic" value="YES" class="size-4 accent-brand-600" checked><span id="t-yes">ΝΑΙ</span></label>
          <label class="inline-flex items-center gap-2"><input type="radio" name="allow-generic" value="NO" class="size-4 accent-brand-600"><span id="t-no">ΟΧΙ</span></label>
        </div>
      </div>

      <!-- GDPR + Submit -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="inline-flex items-start gap-3">
          <input id="gdpr-checkbox" type="checkbox" required class="mt-0.5 size-5 accent-brand-600">
          <span class="text-sm"><span id="t-accept">Αποδέχομαι τους</span> <button type="button" id="gdpr-open" class="underline text-brand-700"><span id="t-gdprLink">Όρους Αναζήτησης & GDPR</span></button>.</span>
        </label>
        <div class="mt-4 flex justify-end">
          <button id="submitBtn" class="px-5 py-3 rounded-2xl bg-gradient-to-r from-brand-500 to-brand-600 text-white font-semibold shadow-soft hover:opacity-95">
            <span id="t-submit">Υποβολή Αναζήτησης</span>
          </button>
        </div>
      </div>
    </section>

    <!-- Results & status flow -->
    <div id="results" class="fixed inset-0 hidden z-[60]">
      <div id="results-backdrop" class="absolute inset-0 bg-slate-950/60 backdrop-blur-sm"></div>
      <div id="results-panel" class="relative z-10 flex h-full w-full flex-col bg-white/95 dark:bg-slate-900/85 border-t border-slate-200 dark:border-slate-800 shadow-soft sm:mx-auto sm:mt-10 sm:h-auto sm:max-h-[92svh] sm:max-w-4xl sm:rounded-3xl sm:border" role="dialog" aria-modal="true" aria-labelledby="t-statusHeading" tabindex="-1">
        <div class="flex items-center justify-between gap-3 px-4 py-4 sm:px-6 sm:py-5 border-b border-slate-200 dark:border-slate-800">
          <div class="flex items-center gap-2">
            <button type="button" data-go-home class="flex items-center gap-2 rounded-xl border border-slate-200 dark:border-slate-700 px-3 py-1.5 text-sm font-semibold hover:bg-slate-100 dark:hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60">
              ← <span id="t-statusHome">Αρχική</span>
            </button>
            <h3 id="t-statusHeading" class="text-base sm:text-lg font-semibold">Κατάσταση αιτήματος</h3>
          </div>
          <div class="flex items-center gap-2">
            <button id="status-notify" type="button" class="rounded-xl border border-transparent px-3 py-2 text-lg hover:bg-slate-100 dark:hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60" aria-label="Ενεργοποίηση ειδοποιήσεων">
              🔔
            </button>
            <button id="results-close" type="button" class="rounded-xl border border-slate-200 dark:border-slate-700 px-3 py-2 text-sm font-semibold hover:bg-slate-100 dark:hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60" aria-label="Κλείσιμο">
              ✕
            </button>
          </div>
        </div>
        <div id="location-banner" class="hidden border-b border-slate-200 dark:border-slate-800 bg-amber-50/90 dark:bg-amber-900/30 px-4 py-3 text-sm text-amber-800 dark:text-amber-100" role="status"></div>
        <div class="flex-1 overflow-y-auto px-4 py-6 sm:px-6 sm:py-8 space-y-8">
          <div id="results-pending" class="flex flex-col items-center gap-4 text-center py-10" role="status" aria-live="polite">
            <div class="relative">
              <div class="h-16 w-16 rounded-full border-4 border-brand-500/30 border-t-brand-600 animate-spin" aria-hidden="true"></div>
            </div>
            <div class="space-y-2">
              <h4 id="t-statusPendingTitle" class="text-xl font-bold tracking-tight">Αναζητούμε το φαρμακό σου…</h4>
              <p id="t-statusPendingDesc" class="text-sm text-slate-500 dark:text-slate-400">Θα ειδοποιηθείς μόλις απαντήσει ένα φαρμακείο.</p>
            </div>
          </div>

          <div id="results-list" class="hidden space-y-4" role="region" aria-live="polite">
            <div class="space-y-1">
              <h4 id="t-statusListTitle" class="text-lg font-semibold">Φαρμακεία με διαθεσιμότητα</h4>
              <p id="t-statusListDesc" class="text-sm text-slate-500 dark:text-slate-400">Επίλεξε το φαρμακείο που σε εξυπηρετεί για self pick-up.</p>
            </div>
            <div id="resultsList" class="space-y-3" role="list"></div>
          </div>

          <div id="results-error" class="hidden text-center space-y-3 py-10">
            <div class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-rose-100 text-rose-600 text-2xl" aria-hidden="true">⚠️</div>
            <h4 id="t-statusErrorTitle" class="text-xl font-bold tracking-tight">Παρουσιάστηκε σφάλμα</h4>
            <p id="t-statusErrorBody" class="text-sm text-slate-500 dark:text-slate-400 max-w-md mx-auto">Κάτι πήγε στραβά κατά την ανάκτηση απαντήσεων. Προσπάθησε ξανά.</p>
            <button id="status-error-btn" type="button" class="mx-auto inline-flex items-center gap-2 rounded-xl border border-slate-300 dark:border-slate-700 px-4 py-2 text-sm font-semibold hover:bg-slate-100 dark:hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60">
              <span id="t-statusErrorCta">Επανάληψη</span>
            </button>
          </div>

          <div id="results-empty" class="hidden flex flex-col items-center gap-4 text-center py-10 px-4">
            <div class="w-16 h-16 rounded-full bg-rose-100 text-rose-600 grid place-items-center text-2xl" aria-hidden="true">⚠️</div>
            <h4 id="t-statusEmptyTitle" class="text-xl font-bold tracking-tight">Δεν βρέθηκαν φαρμακεία</h4>
            <p id="t-statusEmptyBody" class="text-sm text-slate-500 dark:text-slate-400 max-w-md">Δεν εντοπίσαμε διαθέσιμα φαρμακεία αυτή τη στιγμή. Δοκίμασε ξανά σε λίγο ή άλλαξε τα στοιχεία της αναζήτησης.</p>
            <button id="status-empty-btn" type="button" class="px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-sm font-semibold focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60">
              <span id="t-statusEmptyCta">Δοκίμασε ξανά</span>
            </button>
          </div>

          <div id="pickup-box" class="hidden flex flex-col items-center gap-5 text-center py-8 px-4 rounded-2xl bg-emerald-50/80 dark:bg-emerald-900/20 border border-emerald-300 dark:border-emerald-800">
            <div id="t-statusReservedTitle" class="text-sm font-semibold uppercase tracking-widest text-emerald-700 dark:text-emerald-200">Το φαρμακείο σε περιμένει</div>
            <div class="space-y-2">
              <h4 id="status-reserved-name" class="text-2xl sm:text-3xl font-bold tracking-tight">City Pharmacy</h4>
              <p id="status-reserved-address" class="text-sm text-slate-600 dark:text-slate-300">Ιπποκράτους 12, Αθήνα</p>
            </div>
            <div class="flex items-baseline gap-3">
              <span id="pickup-timer" class="text-5xl font-extrabold tracking-tight">60:00</span>
              <span id="t-statusReservedHint" class="text-sm text-emerald-700 dark:text-emerald-200">Χρόνος κράτησης</span>
            </div>
            <div id="status-reserved-generic" class="hidden px-3 py-1 rounded-full bg-emerald-100/70 dark:bg-emerald-800/40 text-xs font-semibold text-emerald-700 dark:text-emerald-200">🧬 <span id="t-statusGenericBadge">Διαθέσιμο γενόσημο</span></div>
            <div class="flex flex-wrap justify-center gap-3">
              <button id="extend-btn" class="px-4 py-2 rounded-xl border border-emerald-500 text-emerald-700 dark:text-emerald-200 hover:bg-emerald-100/70 dark:hover:bg-emerald-800/40 text-sm font-semibold focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500/60">
                <span id="t-statusExtend">+15 λεπτά</span>
              </button>
              <a id="status-call" class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 opacity-60 pointer-events-none focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500/60" href="#">
                📞 <span id="t-statusCall">Κλήση</span>
              </a>
              <a id="status-directions" class="px-4 py-2 rounded-xl bg-sky-600 text-white text-sm font-semibold hover:bg-sky-700 opacity-60 pointer-events-none focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-500/60" href="#" target="_blank" rel="noopener">
                🧭 <span id="t-statusDirections">Οδηγίες</span>
              </a>
            </div>
            <button id="status-done" data-go-home type="button" class="px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-white dark:hover:bg-slate-800 text-sm font-semibold focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60">
              <span id="t-statusBackHome">Επιστροφή στην αρχική</span>
            </button>
          </div>
        </div>
        <div class="flex flex-col gap-3 border-t border-slate-200 dark:border-slate-800 px-4 py-4 sm:flex-row sm:items-center sm:justify-between sm:px-6">
          <button id="newSearch" class="rounded-xl border border-slate-300 dark:border-slate-700 px-4 py-2 text-sm font-semibold hover:bg-slate-100 dark:hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60">
            <span id="t-newSearch">Νέα αναζήτηση</span>
          </button>
          <p class="text-xs text-slate-500 dark:text-slate-400">MediRadar ©</p>
        </div>
      </div>
    </div>
  </main>

  <!-- PRO PORTAL MODAL -->
  <div id="pro-modal" class="fixed inset-0 hidden items-center justify-center bg-slate-950/60 backdrop-blur-sm px-4 py-6 z-[70]">
    <div class="relative w-full max-w-3xl max-h-[90svh] overflow-y-auto rounded-3xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-6 sm:p-8">
      <button id="pro-close" type="button" class="absolute top-4 right-4 p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800" aria-label="Κλείσιμο">✕</button>
      <div class="space-y-6">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
          <div class="space-y-1">
            <h2 id="t-proModalTitle" class="text-2xl font-bold">Πρόσβαση φαρμακείων</h2>
            <p id="t-proModalSubtitle" class="text-sm text-slate-600 dark:text-slate-400">Συνδέσου ή καταχώρησε το φαρμακείο σου για να απαντάς σε αιτήματα διαθεσιμότητας.</p>
          </div>
        </div>

        <div class="flex items-center gap-1 rounded-2xl bg-slate-100/80 dark:bg-white/5 p-1">
          <button id="pro-tab-signin" type="button" class="flex-1 rounded-2xl px-4 py-2 text-sm font-semibold bg-white dark:bg-slate-800 shadow-soft" aria-selected="true">
            <span id="t-proSigninTab">Σύνδεση</span>
          </button>
          <button id="pro-tab-register" type="button" class="flex-1 rounded-2xl px-4 py-2 text-sm font-semibold text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200" aria-selected="false">
            <span id="t-proRegisterTab">Εγγραφή</span>
          </button>
        </div>

        <div id="pro-view-signin" class="space-y-5">
          <div class="grid gap-4 sm:grid-cols-2">
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-proSigninEmailLabel">Email φαρμακείου</span>
              <input id="pro-signin-email" type="email" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="pharmacy@example.gr">
            </label>
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-proSigninPasswordLabel">Κωδικός πρόσβασης</span>
              <input id="pro-signin-password" type="password" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="••••••••">
            </label>
          </div>
          <button id="pro-signin-submit" class="w-full sm:w-auto px-5 py-3 rounded-2xl bg-brand-600 text-white font-semibold shadow-soft hover:bg-brand-700" type="button">
            <span id="t-proSigninSubmit">Σύνδεση</span>
          </button>
          <button id="pro-forgot" type="button" class="text-sm underline text-slate-600 dark:text-slate-300 hover:opacity-80 w-fit">
            <span id="t-proForgot">Ξέχασες τον κωδικό;</span>
          </button>

          <div class="space-y-3">
            <div class="flex items-center gap-2 text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
              <div class="h-px flex-1 bg-slate-200 dark:bg-slate-700"></div>
              <span id="t-proSSO">Ή συνέχισε με</span>
              <div class="h-px flex-1 bg-slate-200 dark:bg-slate-700"></div>
            </div>
            <div class="grid gap-2 sm:grid-cols-3">
              <button class="pro-sso-btn px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center gap-2" type="button" data-provider="Google">
                <span aria-hidden="true">🟢</span> Google
              </button>
              <button class="pro-sso-btn px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center gap-2" type="button" data-provider="Microsoft">
                <span aria-hidden="true">🪟</span> Microsoft
              </button>
              <button class="pro-sso-btn px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center gap-2" type="button" data-provider="Apple">
                <span aria-hidden="true">🍎</span> Apple
              </button>
            </div>
          </div>

        </div>

        <div id="pro-view-register" class="space-y-5 hidden">
          <div class="space-y-3">
            <div class="flex items-center gap-2 text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
              <div class="h-px flex-1 bg-slate-200 dark:bg-slate-700"></div>
              <span id="t-proSSO2">Ή συνέχισε με</span>
              <div class="h-px flex-1 bg-slate-200 dark:bg-slate-700"></div>
            </div>
            <div class="grid gap-2 sm:grid-cols-3">
              <button class="pro-sso-btn px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center gap-2" type="button" data-provider="Google">
                <span aria-hidden="true">🟢</span> Google
              </button>
              <button class="pro-sso-btn px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center gap-2" type="button" data-provider="Microsoft">
                <span aria-hidden="true">🪟</span> Microsoft
              </button>
              <button class="pro-sso-btn px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center gap-2" type="button" data-provider="Apple">
                <span aria-hidden="true">🍎</span> Apple
              </button>
            </div>
          </div>

          <div>
            <h3 id="t-proRegisterHeading" class="text-lg font-semibold">Στοιχεία φαρμακείου</h3>
            <p id="t-proRegisterDesc" class="mt-1 text-sm text-slate-600 dark:text-slate-400">Συμπλήρωσε τα στοιχεία του φαρμακείου για να ξεκινήσεις.</p>
          </div>

          <form id="pro-register-form" class="grid gap-4 sm:grid-cols-2">
            <label class="text-sm font-semibold flex flex-col gap-2 sm:col-span-2">
              <span id="t-proFieldBusinessName">Επωνυμία φαρμακείου</span>
              <input id="pro-field-business" type="text" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="Φαρμακείο Κεντρικής Πλατείας">
            </label>
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-proFieldVat">ΑΦΜ</span>
              <input id="pro-field-vat" type="text" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="123456789">
            </label>
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-proFieldRegistrationNumber">Αριθμός άδειας</span>
              <input id="pro-field-license" type="text" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="12345">
            </label>
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-proFieldContact">Υπεύθυνος επικοινωνίας</span>
              <input id="pro-field-contact" type="text" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="Μαρία Παπαδοπούλου">
            </label>
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-proFieldEmail">Email επικοινωνίας</span>
              <input id="pro-field-email" type="email" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="pharmacy@example.gr">
            </label>
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-proFieldPhone">Τηλέφωνο</span>
              <input id="pro-field-phone" type="tel" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="2101234567">
            </label>
            <label class="text-sm font-semibold flex flex-col gap-2 sm:col-span-2">
              <span id="t-proFieldAddress">Διεύθυνση</span>
              <input id="pro-field-address" type="text" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="Ιπποκράτους 12">
            </label>
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-proFieldCity">Πόλη</span>
              <input id="pro-field-city" type="text" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="Αθήνα">
            </label>
            <div class="sm:col-span-2">
              <button id="pro-register-submit" type="submit" class="w-full sm:w-auto px-5 py-3 rounded-2xl bg-brand-600 text-white font-semibold shadow-soft hover:bg-brand-700">
                <span id="t-proRegisterSubmit">Αίτηση εγγραφής</span>
              </button>
            </div>
          </form>

          <div class="text-sm text-slate-600 dark:text-slate-300">
            <span id="t-proHaveAccount">Έχεις ήδη λογαριασμό;</span>
            <button id="t-proGoSignin" data-pro-switch="signin" type="button" class="ml-1 font-semibold underline decoration-2">Σύνδεση</button>
          </div>
        </div>

        <div class="flex flex-wrap items-center justify-between gap-3 pt-2">
          <button id="pro-back-home" type="button" data-go-home data-close-pro="true" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-sm font-semibold">
            <span aria-hidden="true">←</span>
            <span id="t-proBackHome">Επιστροφή στην αρχική</span>
          </button>
          <p class="text-xs text-slate-500 dark:text-slate-400">MediRadar ©</p>
        </div>
      </div>
    </div>
  </div>

  <!-- HOW -->
  <div id="modal-how" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-2xl rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200 dark:border-slate-800">
        <h3 class="text-lg font-bold" id="t-howTitle">Πώς λειτουργεί το MediRadar</h3>
        <button id="how-close" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">✕</button>
      </div>
      <div id="how-body" class="p-5 leading-relaxed text-slate-700 dark:text-slate-300"></div>
      <div class="px-5 pb-5 flex justify-end">
        <button id="how-ok" class="px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold hover:opacity-95"><span id="t-continue">Συνέχεια</span></button>
      </div>
    </div>
  </div>

  <!-- GDPR -->
  <div id="gdpr-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-3xl rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <h3 class="text-lg font-bold" id="t-gdprTitle">Πολιτική Προστασίας Δεδομένων & Όροι Αναζήτησης</h3>
        <button id="gdpr-close" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">✕</button>
      </div>
      <div id="gdpr-body" class="p-5 text-sm text-slate-700 dark:text-slate-300 space-y-3" style="max-height:62vh; overflow:auto"></div>
      <div class="px-5 pb-5 flex justify-end">
        <button id="gdpr-ok" class="px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold hover:opacity-95"><span id="t-gdprAccept">OK</span></button>
      </div>
    </div>
  </div>

  <!-- Pharmacy details modal -->
  <div id="pharm-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div id="pharm-modal-panel" class="w-full max-w-lg rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft" role="dialog" aria-modal="true" aria-labelledby="pm-title" tabindex="-1">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <h3 class="text-lg font-bold" id="pm-title">Φαρμακείο</h3>
        <button id="pm-close" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">✕</button>
      </div>
      <div class="p-5 space-y-2 text-sm">
        <div id="pm-address">Διεύθυνση:</div>
        <div id="pm-phone">Τηλέφωνο:</div>
      </div>
      <div class="px-5 pb-5 flex gap-2 justify-between">
        <div class="flex gap-2">
          <a id="pm-call" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">Κλήση</a>
          <a id="pm-maps" target="_blank" rel="noopener" class="px-4 py-2 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-700">Άνοιγμα σε Χάρτες</a>
        </div>
        <button id="pm-confirm" class="px-4 py-2 rounded-2xl bg-brand-600 text-white font-semibold hover:bg-brand-700">Επιβεβαίωση & Έναρξη 60’</button>
      </div>
    </div>
  </div>

<!-- AUTH GATE -->
<div id="auth-gate" class="fixed inset-0 hidden items-center justify-center bg-black/45 backdrop-blur-sm px-4 py-6 z-[75]">
  <div id="auth-gate-panel" class="w-full max-w-xl rounded-3xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="t-authTitle" aria-describedby="t-authSubtitle" tabindex="-1">
    <div class="flex items-start justify-between gap-3 px-5 py-4 border-b border-slate-200 dark:border-slate-800">
      <div class="space-y-1">
        <h3 id="t-authTitle" class="text-lg font-bold">Επιβεβαίωση πριν τη δέσμευση</h3>
        <p id="t-authSubtitle" class="text-sm text-slate-600 dark:text-slate-400">Επίλεξε τρόπο σύνδεσης ή επιβεβαίωσης.</p>
      </div>
      <button id="auth-close" class="rounded-xl border border-slate-200 dark:border-slate-700 px-2.5 py-1.5 text-sm font-semibold hover:bg-slate-100 dark:hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60" aria-label="Κλείσιμο">✕</button>
    </div>
    <div class="px-5 py-5 space-y-6">
      <div class="flex items-center gap-2 rounded-2xl bg-slate-100/80 dark:bg-white/5 p-1">
        <button type="button" class="auth-flow-btn flex-1 rounded-2xl px-3 py-2 text-sm font-semibold bg-white dark:bg-slate-800 shadow-soft" data-auth-flow="login" aria-pressed="true" id="auth-flow-login">
          <span id="t-authFlowLogin">Σύνδεση</span>
        </button>
        <button type="button" class="auth-flow-btn flex-1 rounded-2xl px-3 py-2 text-sm font-semibold text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-slate-100" data-auth-flow="register" aria-pressed="false" id="auth-flow-register">
          <span id="t-authFlowRegister">Εγγραφή</span>
        </button>
        <button type="button" class="auth-flow-btn flex-1 rounded-2xl px-3 py-2 text-sm font-semibold text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-slate-100" data-auth-flow="guest" aria-pressed="false" id="auth-flow-guest">
          <span id="t-authFlowGuest">Επισκέπτης</span>
        </button>
      </div>
      <div>
        <div class="flex items-center gap-2" role="tablist" aria-label="Επιλογή μεθόδου επιβεβαίωσης">
          <button type="button" class="auth-tab-btn rounded-xl border border-slate-300 dark:border-slate-700 px-3 py-1.5 text-sm font-semibold bg-white dark:bg-slate-800 shadow-soft focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60" data-auth-tab="sms" aria-selected="true" id="auth-tab-btn-sms">
            <span id="t-authTabSms">SMS</span>
          </button>
          <button type="button" class="auth-tab-btn rounded-xl border border-transparent px-3 py-1.5 text-sm font-semibold text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-slate-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60" data-auth-tab="email" aria-selected="false" id="auth-tab-btn-email">
            <span id="t-authTabEmail">Email</span>
          </button>
          <button type="button" class="auth-tab-btn rounded-xl border border-transparent px-3 py-1.5 text-sm font-semibold text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-slate-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60" data-auth-tab="sso" aria-selected="false" id="auth-tab-btn-sso">
            <span id="t-authTabSso">SSO</span>
          </button>
        </div>
        <div class="mt-4 space-y-5">
          <div id="auth-tab-sms" role="tabpanel" aria-labelledby="auth-tab-btn-sms" class="space-y-3">
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-authSmsLabel">Αριθμός τηλεφώνου</span>
              <input id="auth-sms-phone" type="tel" inputmode="tel" class="rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500/40" placeholder="69XXXXXXXX">
            </label>
            <div class="flex flex-wrap items-center gap-2">
              <button id="auth-sms-send" type="button" class="rounded-xl bg-brand-600 px-4 py-2 text-sm font-semibold text-white shadow-soft hover:bg-brand-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-300">
                <span id="t-authSmsSend">Αποστολή κωδικού</span>
              </button>
              <button id="auth-sms-resend" type="button" class="hidden rounded-xl border border-slate-300 dark:border-slate-700 px-3 py-2 text-sm font-semibold hover:bg-slate-100 dark:hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60">
                <span id="t-authSmsResend">Επανάληψη</span>
              </button>
            </div>
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-authSmsCodeLabel">Εισήγαγε τον κωδικό</span>
              <input id="auth-sms-code" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="6" class="rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500/40" placeholder="123456">
            </label>
            <button id="auth-sms-verify" type="button" class="rounded-xl border border-slate-300 dark:border-slate-700 px-4 py-2 text-sm font-semibold hover:bg-slate-100 dark:hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60">
              <span id="t-authSmsVerify">Επιβεβαίωση κωδικού</span>
            </button>
          </div>
          <div id="auth-tab-email" role="tabpanel" aria-labelledby="auth-tab-btn-email" class="hidden space-y-3">
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-authEmailLabel">Email επικοινωνίας</span>
              <input id="auth-email-value" type="email" class="rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500/40" placeholder="name@example.com">
            </label>
            <div class="flex flex-wrap items-center gap-2">
              <button id="auth-email-send" type="button" class="rounded-xl bg-brand-600 px-4 py-2 text-sm font-semibold text-white shadow-soft hover:bg-brand-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-300">
                <span id="t-authEmailSend">Αποστολή magic link</span>
              </button>
              <button id="auth-email-confirm" type="button" class="rounded-xl border border-slate-300 dark:border-slate-700 px-3 py-2 text-sm font-semibold hover:bg-slate-100 dark:hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60">
                <span id="t-authEmailConfirm">Έκανα κλικ στο link</span>
              </button>
            </div>
          </div>
          <div id="auth-tab-sso" role="tabpanel" aria-labelledby="auth-tab-btn-sso" class="hidden space-y-2">
            <p id="t-authSsoHint" class="text-sm text-slate-600 dark:text-slate-300">Συνδέσου με υπάρχον λογαριασμό.</p>
            <div class="grid gap-2 sm:grid-cols-3">
              <button type="button" class="auth-sso-btn rounded-xl border border-slate-300 dark:border-slate-700 px-3 py-2 text-sm font-semibold hover:bg-slate-100 dark:hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60" data-provider="Google">
                <span aria-hidden="true">🟢</span> Google
              </button>
              <button type="button" class="auth-sso-btn rounded-xl border border-slate-300 dark:border-slate-700 px-3 py-2 text-sm font-semibold hover:bg-slate-100 dark:hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60" data-provider="Apple">
                <span aria-hidden="true">🍎</span> Apple
              </button>
              <button type="button" class="auth-sso-btn rounded-xl border border-slate-300 dark:border-slate-700 px-3 py-2 text-sm font-semibold hover:bg-slate-100 dark:hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60" data-provider="Azure">
                <span aria-hidden="true">🪟</span> SSO
              </button>
            </div>
          </div>
        </div>
      </div>
      <div id="auth-status" class="min-h-[1.75rem] text-sm font-medium"></div>
    </div>
    <div class="flex justify-end gap-3 border-t border-slate-200 dark:border-slate-800 px-5 py-4">
      <button id="auth-continue" type="button" class="rounded-xl bg-brand-600 px-5 py-2 text-sm font-semibold text-white shadow-soft opacity-60 pointer-events-none focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-300">
        <span id="t-authContinue">Συνέχεια στη δέσμευση</span>
      </button>
    </div>
  </div>
</div>


  <!-- BARCODE MODAL -->
  <div id="barcode-modal" class="fixed inset-0 hidden items-center justify-center bg-black/50 backdrop-blur-sm px-4 py-6 z-[70]">
    <div class="w-full max-w-md rounded-3xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft overflow-hidden">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200 dark:border-slate-800">
        <h3 id="t-barcodeModalTitle" class="text-lg font-bold">Σάρωση barcode</h3>
        <button id="barcode-close" type="button" class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800" aria-label="Κλείσιμο">✕</button>
      </div>
      <div class="p-5 space-y-4">
        <div id="barcode-status" class="text-sm text-slate-600 dark:text-slate-300">Στόχευσε τον γραμμωτό κωδικό μέσα στο πλαίσιο.</div>
        <div class="rounded-2xl overflow-hidden border border-slate-200 dark:border-slate-800 bg-black">
          <video id="barcode-video" class="w-full aspect-video" autoplay muted playsinline></video>
        </div>
        <div class="flex justify-end">
          <button id="barcode-stop" type="button" class="hidden px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700 text-sm font-semibold hover:bg-slate-100 dark:hover:bg-slate-800">
            <span id="t-barcodeStop">Διακοπή</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== ENV (INLINE — χωρίς /env.js) ===== -->
  <script>
    window.ENV = window.ENV || {
      SUPABASE_URL: 'https://qzerrisyowkfkmcyxmav.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZXJyaXN5b3drZmttY3l4bWF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTcxODQsImV4cCI6MjA3NTU5MzE4NH0.alkvHkOQPBTwY3daUcKAEsf4nt0kizuU3rYI2c2InPk',
      VAPID_PUBLIC_KEY: 'BGS8pCF76A6Es7XAu3hcTAEE8vcRDl1JlWQ7Hym7m5WK63gIHqbuuSJl_xfC4l7729H5ClVqysTjnShnJwviHgo'
    };
  </script>

  <!-- Supabase client -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.ENV || {};
    if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
      console.error('Missing Supabase ENV');
    }
    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('Supabase ready:', !!window.supabase);
  </script>

  <!-- App JS -->
  <script>
    /* ========== Theme ========== */
    const html = document.documentElement;
    const bodyEl = document.body;
    const themeBtn = document.getElementById('theme-toggle');
    const iconSun = document.getElementById('icon-sun');
    const iconMoon = document.getElementById('icon-moon');
    function setTheme(mode){
      const dark = mode==='dark';
      html.classList.toggle('dark', dark);
      iconSun.classList.toggle('hidden', !dark);
      iconMoon.classList.toggle('hidden', dark);
      localStorage.setItem('mediradar-theme', dark?'dark':'light');
    }
    setTheme(localStorage.getItem('mediradar-theme') || (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
    themeBtn.addEventListener('click',()=> setTheme(html.classList.contains('dark')?'light':'dark'));

    /* ========== i18n ========== */
    const strings = {
      el:{
        hero:'Άμεση εύρεση διαθεσιμότητας φαρμάκων σε κοντινά φαρμακεία.',
        searchBTN:'Αναζήτηση Φαρμάκου', howBTN:'Πώς λειτουργεί', signinBTN:'Σύνδεση', installBTN:'Εγκατάσταση',
        searchTitle:'Αναζήτηση Φαρμάκου', home:'Αρχική', medname:'Όνομα Φαρμάκου', formatTip:'Συμβουλή: Εμπορική ονομασία + δοσολογία (π.χ. “500mg”).',
        substance:'Δραστική Ουσία', optional:'(προαιρετικά)', doseEx:'Παράδειγμα δοσολογίας: Paracetamol 500mg.', type:'Τύπος Φαρμάκου',
        qty:'Ποσότητα (τεμάχια/κουτιά)', select:'Επιλογή', genericQ:'Αν δεν είναι διαθέσιμο το συγκεκριμένο εμπορικό, επιτρέπεις να σου προτείνουμε ισοδύναμο (γενόσημο);',
        yes:'ΝΑΙ', no:'ΟΧΙ', city:'Πόλη', accept:'Αποδέχομαι τους', submit:'Υποβολή Αναζήτησης', results:'Αποτελέσματα', newSearch:'Νέα αναζήτηση',
        pro:'Για επαγγελματίες', howTitle:'Πώς λειτουργεί το MediRadar', continue:'Συνέχεια', pending:'Περιμένουμε απαντήσεις από τα κοντινά φαρμακεία…', pharmLogin:'Είσοδος φαρμακείων',
        langGreek:'Ελληνικά', langEnglish:'Αγγλικά',
        gdprLink:'Όρους Αναζήτησης & GDPR',
        gdprTitle:'Πολιτική Προστασίας Δεδομένων & Όροι Αναζήτησης',
        gdprBody:`<p>Η MediRadar επεξεργάζεται τα στοιχεία που καταχωρείς αποκλειστικά για την εξυπηρέτηση του αιτήματος διαθεσιμότητας.</p>
          <ul class="list-disc pl-5 space-y-2">
            <li>Συλλέγουμε το φάρμακο, την πόλη, την επιθυμητή ποσότητα και τυχόν πρόσθετες πληροφορίες που δίνεις (δραστική ουσία, barcode).</li>
            <li>Χρησιμοποιούμε τα δεδομένα για να ενημερώσουμε τα συνεργαζόμενα φαρμακεία και να σε ειδοποιήσουμε για τις απαντήσεις τους.</li>
            <li>Διατηρούμε τα στοιχεία μόνο όσο χρειάζεται για να ολοκληρωθεί το αίτημα ή έως 30 ημέρες, εκτός αν ζητήσεις νωρίτερα τη διαγραφή τους.</li>
          </ul>
          <p>Δεν διαβιβάζουμε δεδομένα σε τρίτους και εφαρμόζουμε τεχνικά μέτρα ασφάλειας σύμφωνα με τον GDPR.</p>
          <p>Έχεις δικαίωμα πρόσβασης, διόρθωσης ή διαγραφής επικοινωνώντας στο <a class="text-brand-700 underline" href="mailto:privacy@mediradar.gr">privacy@mediradar.gr</a>.</p>`,
        barcodeTitle:'Σάρωση barcode συνταγής ή κουτιού', barcodeHelp:'Χρησιμοποίησε την κάμερα για να σαρώσεις τον γραμμωτό κωδικό της συνταγής ή του κουτιού.',
        barcodeStart:'Άνοιγμα κάμερας', barcodePlaceholder:'Ο κωδικός θα εμφανιστεί εδώ', barcodeModalTitle:'Σάρωση barcode',
        barcodeStatusInit:'Στόχευσε τον γραμμωτό κωδικό μέσα στο πλαίσιο.', barcodeStatusScanning:'Σάρωση σε εξέλιξη…',
        barcodeStatusSuccess:'Εντοπίστηκε κωδικός: %s', barcodeStatusNoApi:'Ο περιηγητής δεν υποστηρίζει αυτόματη ανάγνωση barcode. Συμπλήρωσε τον κωδικό χειροκίνητα.',
        barcodeStatusNoCamera:'Δεν εντοπίστηκε κάμερα στη συσκευή.', barcodeStatusDenied:'Η πρόσβαση στην κάμερα απορρίφθηκε. Έλεγξε τις άδειες.',
        barcodeStatusStopped:'Η σάρωση διακόπηκε. Μπορείς να κλείσεις το παράθυρο.', barcodeStop:'Διακοπή',
        proModalTitle:'Πρόσβαση φαρμακείων', proModalSubtitle:'Συνδέσου ή καταχώρησε το φαρμακείο σου για να απαντάς σε αιτήματα διαθεσιμότητας.',
        proSigninTab:'Σύνδεση', proRegisterTab:'Εγγραφή',
        proSigninEmailLabel:'Email φαρμακείου', proSigninPasswordLabel:'Κωδικός πρόσβασης', proSigninSubmit:'Σύνδεση',
        proForgot:'Ξέχασες τον κωδικό;', proSSO:'Ή συνέχισε με',
        proHaveAccount:'Έχεις ήδη λογαριασμό;', proGoSignin:'Σύνδεση',
        proRegisterHeading:'Στοιχεία φαρμακείου', proRegisterDesc:'Συμπλήρωσε τα στοιχεία του φαρμακείου για να ξεκινήσεις.',
        proFieldBusinessName:'Επωνυμία φαρμακείου', proFieldVat:'ΑΦΜ', proFieldContact:'Υπεύθυνος επικοινωνίας',
        proFieldEmail:'Email επικοινωνίας', proFieldPhone:'Τηλέφωνο', proFieldAddress:'Διεύθυνση', proFieldCity:'Πόλη',
        proFieldRegistrationNumber:'Αριθμός άδειας', proRegisterSubmit:'Αίτηση εγγραφής', proBackHome:'Επιστροφή στην αρχική',
        statusErrorTitle:'Παρουσιάστηκε σφάλμα', statusErrorBody:'Κάτι πήγε στραβά κατά την ανάκτηση απαντήσεων. Προσπάθησε ξανά.', statusErrorCta:'Επανάληψη',
        locationLoading:'Ζητάμε την τοποθεσία σου για να υπολογίσουμε αποστάσεις…',
        locationDenied:'Δεν δόθηκε άδεια τοποθεσίας — εμφανίζουμε αποτελέσματα χωρίς απόσταση.',
        locationUnsupported:'Η συσκευή δεν υποστηρίζει αυτόματη τοποθεσία. Οι αποστάσεις δεν θα υπολογιστούν.',
        locationError:'Αδυναμία λήψης τοποθεσίας. Μπορείς να ενεργοποιήσεις την άδεια αργότερα.',
        availabilityExact:'Ακριβώς το ζητούμενο', availabilityGeneric:'Γενόσημο διαθέσιμο',
        badgeExact:'Exact', badgeGeneric:'Generic',
        distanceAway:'%s km μακριά', distanceUnknown:'Χωρίς τοποθεσία',
        actionViewMap:'Προβολή στο χάρτη', actionCall:'Κλήση', actionReserve:'Δέσμευση', actionCallDisabled:'Δεν υπάρχει διαθέσιμο τηλέφωνο',
        authTitle:'Επιβεβαίωση πριν τη δέσμευση', authSubtitle:'Επίλεξε τρόπο σύνδεσης ή επιβεβαίωσης.',
        authFlowLogin:'Σύνδεση', authFlowRegister:'Εγγραφή', authFlowGuest:'Επισκέπτης',
        authTabSms:'SMS', authTabEmail:'Email', authTabSso:'SSO',
        authSmsLabel:'Αριθμός τηλεφώνου', authSmsSend:'Αποστολή κωδικού', authSmsResend:'Επανάληψη', authSmsCodeLabel:'Εισήγαγε τον κωδικό', authSmsVerify:'Επιβεβαίωση κωδικού',
        authSmsInvalid:'Δώσε έγκυρο ελληνικό τηλέφωνο.', authSmsSent:'Στάλθηκε SMS με κωδικό %s (demo).', authSmsNeedSend:'Στείλε πρώτα τον κωδικό SMS.',
        authEmailLabel:'Email επικοινωνίας', authEmailSend:'Αποστολή magic link', authEmailConfirm:'Έκανα κλικ στο link',
        authEmailInvalid:'Δώσε έγκυρη διεύθυνση email.', authEmailSent:'Στείλαμε magic link στο %s (demo).', authEmailNeedSend:'Στείλε το magic link πριν συνεχίσεις.',
        authSsoHint:'Συνδέσου με υπάρχον λογαριασμό.', authSsoSuccess:'Επιβεβαιώθηκε μέσω %s.',
        authStatusSuccess:'Επαληθεύτηκες με επιτυχία! Μπορείς να συνεχίσεις.', authStatusExpired:'Ο κωδικός έληξε. Ζήτησε νέο.', authStatusInvalid:'Λάθος κωδικός, δοκίμασε ξανά.',
        authNeedVerification:'Ολοκλήρωσε πρώτα την επιβεβαίωση.', authContinue:'Συνέχεια στη δέσμευση', authGuestHint:'Ως επισκέπτης χρειάζεται επιβεβαίωση με SMS ή email.', authAlreadyVerified:'Έχεις ήδη ταυτοποιηθεί — μπορείς να συνεχίσεις.'
      },
      en:{
        hero:'Instant availability check at nearby pharmacies.',
        searchBTN:'Medicine Search', howBTN:'How it works', signinBTN:'Sign in', installBTN:'Install',
        searchTitle:'Medicine Search', home:'Home', medname:'Medicine Name', formatTip:'Tip: Brand name + dosage (e.g. “500mg”).',
        substance:'Active Substance', optional:'(optional)', doseEx:'Dosage example: Paracetamol 500mg.', type:'Medicine Type',
        qty:'Quantity (units/boxes)', select:'Select', genericQ:'If the specific brand is unavailable, may we suggest an equivalent (generic)?',
        yes:'YES', no:'NO', city:'City', accept:'I accept the', submit:'Submit Search', results:'Results', newSearch:'New search',
        pro:'For professionals', howTitle:'How MediRadar works', continue:'Continue', pending:'Waiting for responses from nearby pharmacies…', pharmLogin:'Pharmacy login',
        langGreek:'Greek', langEnglish:'English',
        gdprLink:'Search Terms & GDPR',
        gdprTitle:'Data Protection & Search Terms',
        gdprBody:`<p>MediRadar processes the details you provide solely to fulfil your medicine availability request.</p>
          <ul class="list-disc pl-5 space-y-2">
            <li>We collect the medicine, city, desired quantity and any optional details you share (active substance, barcode).</li>
            <li>Your data is used to notify participating pharmacies and relay their responses back to you.</li>
            <li>Information is retained only for the time needed to complete the request or up to 30 days, unless you ask for earlier deletion.</li>
          </ul>
          <p>We do not pass data to third parties and apply security safeguards in line with GDPR requirements.</p>
          <p>You may request access, correction or deletion by emailing <a class="text-brand-700 underline" href="mailto:privacy@mediradar.gr">privacy@mediradar.gr</a>.</p>`,
        barcodeTitle:'Scan prescription or box barcode', barcodeHelp:'Use your camera to capture the prescription or medicine box barcode.',
        barcodeStart:'Open camera', barcodePlaceholder:'The code will appear here', barcodeModalTitle:'Barcode scan',
        barcodeStatusInit:'Align the barcode inside the frame.', barcodeStatusScanning:'Scanning…',
        barcodeStatusSuccess:'Detected code: %s', barcodeStatusNoApi:'Your browser does not support automatic barcode reading. Enter the code manually.',
        barcodeStatusNoCamera:'No camera was found on this device.', barcodeStatusDenied:'Camera access was denied. Check your permission settings.',
        barcodeStatusStopped:'Scanning stopped. You can close this window.', barcodeStop:'Stop',
        proModalTitle:'Pharmacy access', proModalSubtitle:'Sign in or register your pharmacy to respond to availability requests.',
        proSigninTab:'Sign in', proRegisterTab:'Register',
        proSigninEmailLabel:'Pharmacy email', proSigninPasswordLabel:'Password', proSigninSubmit:'Sign in',
        proForgot:'Forgot password?', proSSO:'Or continue with',
        proHaveAccount:'Already have an account?', proGoSignin:'Sign in',
        proRegisterHeading:'Pharmacy details', proRegisterDesc:'Share your business information to get started.',
        proFieldBusinessName:'Pharmacy name', proFieldVat:'VAT number', proFieldContact:'Primary contact',
        proFieldEmail:'Contact email', proFieldPhone:'Phone', proFieldAddress:'Address', proFieldCity:'City',
        proFieldRegistrationNumber:'License number', proRegisterSubmit:'Submit registration', proBackHome:'Back to home',
        statusErrorTitle:'Something went wrong', statusErrorBody:'We could not load the latest replies. Please try again.', statusErrorCta:'Try again',
        locationLoading:'Requesting your location to calculate distances…',
        locationDenied:'Location permission was denied — showing results without distance.',
        locationUnsupported:'This device does not support automatic location. Distances will be omitted.',
        locationError:'We could not determine your location. You can enable it later.',
        availabilityExact:'Exact match', availabilityGeneric:'Generic available',
        badgeExact:'Exact', badgeGeneric:'Generic',
        distanceAway:'%s km away', distanceUnknown:'No location',
        actionViewMap:'View on map', actionCall:'Call', actionReserve:'Reserve', actionCallDisabled:'Phone number unavailable',
        authTitle:'Verify before reserving', authSubtitle:'Choose how you want to identify yourself.',
        authFlowLogin:'Sign in', authFlowRegister:'Register', authFlowGuest:'Guest checkout',
        authTabSms:'SMS', authTabEmail:'Email', authTabSso:'SSO',
        authSmsLabel:'Phone number', authSmsSend:'Send code', authSmsResend:'Resend', authSmsCodeLabel:'Enter the code', authSmsVerify:'Verify code',
        authSmsInvalid:'Enter a valid phone number.', authSmsSent:'We sent an SMS with code %s (demo).', authSmsNeedSend:'Send the SMS code first.',
        authEmailLabel:'Contact email', authEmailSend:'Send magic link', authEmailConfirm:'I clicked the link',
        authEmailInvalid:'Enter a valid email address.', authEmailSent:'We emailed a magic link to %s (demo).', authEmailNeedSend:'Send the magic link before continuing.',
        authSsoHint:'Continue with an existing account.', authSsoSuccess:'Verified via %s.',
        authStatusSuccess:'Verification complete! You can continue.', authStatusExpired:'The code expired. Request a new one.', authStatusInvalid:'Incorrect code, please retry.',
        authNeedVerification:'Complete verification before reserving.', authContinue:'Continue to reserve', authGuestHint:'Guests must verify via SMS or email.', authAlreadyVerified:'You are already verified — you may continue.'
      }
    };
    const state = { lang: localStorage.getItem('mediradar-lang') || 'el' };
    let selectedPharmacy = null;
    function t(k){ return strings[state.lang][k]; }
    function setText(id, txt){ const el=document.getElementById(id); if(el) el.textContent=txt; }
    function setHTML(id, html){ const el=document.getElementById(id); if(el) el.innerHTML=html; }
    function applyLang(){
      document.documentElement.lang = state.lang;
      setText('t-hero', t('hero'));
      setText('t-searchBTN', t('searchBTN')); setText('t-howBTN', t('howBTN')); setText('t-installBTN', t('installBTN'));
      setText('t-searchTitle', t('searchTitle')); setText('t-home', t('home'));
      setText('t-medname', t('medname')); setText('t-formatTip', t('formatTip'));
      setText('t-city', t('city'));
      setText('t-qty', t('qty'));
      setText('t-type', t('type'));
      setText('t-substance', t('substance'));
      setText('t-doseEx', t('doseEx'));
      setText('t-genericQ', t('genericQ'));
      setText('t-yes', t('yes'));
      setText('t-no', t('no'));
      setText('t-accept', t('accept'));
      setText('t-gdprLink', t('gdprLink'));
      setText('t-submit', t('submit'));
      setText('t-results', t('results')); setText('t-newSearch', t('newSearch')); setText('t-pending', t('pending'));
      setText('t-pro', t('pro')); setText('t-pro-m', t('pro'));
      setText('t-howTitle', t('howTitle')); setText('t-continue', t('continue'));
      setText('t-langElLabel', t('langGreek')); setText('t-langEnLabel', t('langEnglish'));
      setText('t-barcodeTitle', t('barcodeTitle'));
      setText('t-barcodeOptional', t('optional'));
      setText('t-barcodeHelp', t('barcodeHelp'));
      setText('t-barcodeStart', t('barcodeStart'));
      setText('t-barcodeModalTitle', t('barcodeModalTitle'));
      setText('t-barcodeStop', t('barcodeStop'));
      setText('t-gdprTitle', t('gdprTitle'));
      setHTML('gdpr-body', t('gdprBody'));
      setText('t-proModalTitle', t('proModalTitle')); setText('t-proModalSubtitle', t('proModalSubtitle'));
      setText('t-proSigninTab', t('proSigninTab')); setText('t-proRegisterTab', t('proRegisterTab'));
      setText('t-proSigninEmailLabel', t('proSigninEmailLabel')); setText('t-proSigninPasswordLabel', t('proSigninPasswordLabel'));
      setText('t-proSigninSubmit', t('proSigninSubmit')); setText('t-proForgot', t('proForgot'));
      setText('t-proSSO', t('proSSO')); setText('t-proSSO2', t('proSSO'));
      setText('t-proRegisterHeading', t('proRegisterHeading')); setText('t-proRegisterDesc', t('proRegisterDesc'));
      setText('t-proFieldBusinessName', t('proFieldBusinessName')); setText('t-proFieldVat', t('proFieldVat'));
      setText('t-proFieldRegistrationNumber', t('proFieldRegistrationNumber'));
      setText('t-proFieldContact', t('proFieldContact')); setText('t-proFieldEmail', t('proFieldEmail'));
      setText('t-proFieldPhone', t('proFieldPhone')); setText('t-proFieldAddress', t('proFieldAddress'));
      setText('t-proFieldCity', t('proFieldCity'));
      setText('t-proRegisterSubmit', t('proRegisterSubmit'));
      setText('t-proHaveAccount', t('proHaveAccount')); setText('t-proGoSignin', t('proGoSignin'));
      setText('t-proBackHome', t('proBackHome'));
      setText('t-optional', t('optional'));
      setText('t-authTitle', t('authTitle'));
      setText('t-authSubtitle', t('authSubtitle'));
      setText('t-authFlowLogin', t('authFlowLogin'));
      setText('t-authFlowRegister', t('authFlowRegister'));
      setText('t-authFlowGuest', t('authFlowGuest'));
      setText('t-authTabSms', t('authTabSms'));
      setText('t-authTabEmail', t('authTabEmail'));
      setText('t-authTabSso', t('authTabSso'));
      setText('t-authSmsLabel', t('authSmsLabel'));
      setText('t-authSmsSend', t('authSmsSend'));
      setText('t-authSmsResend', t('authSmsResend'));
      setText('t-authSmsCodeLabel', t('authSmsCodeLabel'));
      setText('t-authSmsVerify', t('authSmsVerify'));
      setText('t-authEmailLabel', t('authEmailLabel'));
      setText('t-authEmailSend', t('authEmailSend'));
      setText('t-authEmailConfirm', t('authEmailConfirm'));
      setText('t-authSsoHint', t('authSsoHint'));
      setText('t-authContinue', t('authContinue'));
      document.getElementById('medicine-name').placeholder = state.lang==='el'?'π.χ. Augmentin 875mg':'e.g. Augmentin 875mg';
      document.getElementById('active-substance').placeholder = state.lang==='el'?'π.χ. Paracetamol':'e.g. Paracetamol';
      document.getElementById('barcode-value').placeholder = t('barcodePlaceholder');
      document.getElementById('pro-signin-email').placeholder = state.lang==='el'?'π.χ. pharmacy@domain.gr':'e.g. pharmacy@domain.com';
      document.getElementById('pro-signin-password').placeholder = state.lang==='el'?'Ο κωδικός σου':'Your password';
      document.getElementById('pro-field-business').placeholder = state.lang==='el'?'π.χ. Φαρμακείο Κεντρικής Πλατείας':'e.g. Central Square Pharmacy';
      document.getElementById('pro-field-vat').placeholder = state.lang==='el'?'π.χ. 123456789':'e.g. 123456789';
      document.getElementById('pro-field-license').placeholder = state.lang==='el'?'π.χ. 12345':'e.g. 12345';
      document.getElementById('pro-field-contact').placeholder = state.lang==='el'?'π.χ. Μαρία Παπαδοπούλου':'e.g. Maria Papadopoulou';
      document.getElementById('pro-field-email').placeholder = state.lang==='el'?'π.χ. pharmacy@domain.gr':'e.g. pharmacy@domain.com';
      document.getElementById('pro-field-phone').placeholder = state.lang==='el'?'π.χ. 2101234567':'e.g. +30 2101234567';
      document.getElementById('pro-field-address').placeholder = state.lang==='el'?'π.χ. Ιπποκράτους 12':'e.g. 12 Ippokratous St';
      document.getElementById('pro-field-city').placeholder = state.lang==='el'?'π.χ. Αθήνα':'e.g. Athens';
      themeBtn.setAttribute('aria-label', state.lang==='el'?'Αλλαγή θέματος':'Toggle theme');
      document.getElementById('pro-trigger').setAttribute('aria-label', state.lang==='el'?'Πρόσβαση για επαγγελματίες':'Professionals area');
      document.getElementById('pro-trigger-mobile').setAttribute('aria-label', state.lang==='el'?'Πρόσβαση για επαγγελματίες':'Professionals area');
      document.getElementById('pro-close').setAttribute('aria-label', state.lang==='el'?'Κλείσιμο παραθύρου':'Close window');
      document.getElementById('barcode-start').setAttribute('aria-label', state.lang==='el'?'Σάρωση barcode':'Scan barcode');
      document.getElementById('barcode-close').setAttribute('aria-label', state.lang==='el'?'Κλείσιμο παραθύρου':'Close window');
      resultsCloseBtn?.setAttribute('aria-label', state.lang==='el'?'Κλείσιμο':'Close');
      statusNotifyBtn?.setAttribute('aria-label', state.lang==='el'?'Ενεργοποίηση ειδοποιήσεων':'Enable notifications');
      if(document.getElementById('barcode-modal').classList.contains('hidden')){
        document.getElementById('barcode-status').textContent = t('barcodeStatusInit');
      }
      const langElBtn = document.getElementById('lang-el');
      const langEnBtn = document.getElementById('lang-en');
      langElBtn.dataset.active = state.lang==='el';
      langEnBtn.dataset.active = state.lang==='en';
      langElBtn.setAttribute('aria-pressed', state.lang==='el');
      langEnBtn.setAttribute('aria-pressed', state.lang==='en');
      localStorage.setItem('mediradar-lang', state.lang);
      updateLocationBanner();
    }
    document.getElementById('lang-el').addEventListener('click', ()=>{ state.lang='el'; applyLang(); });
    document.getElementById('lang-en').addEventListener('click', ()=>{ state.lang='en'; applyLang(); });

    /* ========== Navigation ========== */
    const splash = document.getElementById('splash');
    const app = document.getElementById('app');
    function goHome(){
      stopPickupTimer();
      app.classList.add('hidden');
      splash.classList.remove('hidden');
      hidePending();
      hideResultsWrapper();
      pickupBox?.classList.add('hidden');
      window.scrollTo({ top: 0, behavior:'smooth' });
    }
    document.getElementById('cta-search').addEventListener('click', ()=>{ splash.classList.add('hidden'); app.classList.remove('hidden'); window.scrollTo({ top: 0, behavior:'smooth' }); });
    document.querySelectorAll('[data-go-home]').forEach(btn => {
      btn.addEventListener('click', (event) => {
        event.preventDefault();
        if (btn.dataset.closePro === 'true') {
          closeProModal();
        }
        goHome();
      });
    });

    /* ========== Modals (How/GDPR/Login) ========== */
    const modalHow = document.getElementById('modal-how');
    document.getElementById('cta-how').onclick = ()=> {
      modalHow.classList.remove('hidden'); modalHow.classList.add('flex');
      const body = state.lang==='el' ? `<ol class="list-decimal pl-5 space-y-2">
          <li>Πληκτρολόγησε τι ψάχνεις (εμπορική ονομασία ή/και δραστική ουσία).</li>
          <li>Η αίτηση στέλνεται στα κοντινά φαρμακεία.</li>
          <li>Όποιο έχει <strong>διαθεσιμότητα</strong> απαντά θετικά· αν έχει μόνο γενόσημο, θα το δεις με ειδικό σήμα.</li>
          <li>Επιλέγεις φαρμακείο και πας για <strong>self pick-up</strong>.</li>
          <li>Δεν συλλέγουμε τιμές· μόνο διαθεσιμότητα.</li></ol>`
        : `<ol class="list-decimal pl-5 space-y-2">
          <li>Type what you need (brand / active).</li>
          <li>Your request goes to nearby pharmacies.</li>
          <li>Those with <strong>availability</strong> reply “Available”; if generic only, you’ll see a badge.</li>
          <li>Pick a pharmacy and go for <strong>self pick-up</strong>.</li>
          <li>No prices collected—availability only.</li></ol>`;
      document.getElementById('how-body').innerHTML = body;
    };
    document.getElementById('how-close').onclick = ()=> modalHow.classList.add('hidden');
    document.getElementById('how-ok').onclick    = ()=> modalHow.classList.add('hidden');

    const modalGdpr = document.getElementById('gdpr-modal');
    document.getElementById('gdpr-open').onclick = ()=> { modalGdpr.classList.remove('hidden'); modalGdpr.classList.add('flex'); };
    document.getElementById('gdpr-close').onclick= ()=> modalGdpr.classList.add('hidden');
    document.getElementById('gdpr-ok').onclick   = ()=> modalGdpr.classList.add('hidden');

    /* ========== Barcode scanning ========== */
    const barcodeModal = document.getElementById('barcode-modal');
    const barcodeStartBtn = document.getElementById('barcode-start');
    const barcodeCloseBtn = document.getElementById('barcode-close');
    const barcodeStopBtn = document.getElementById('barcode-stop');
    const barcodeStatus = document.getElementById('barcode-status');
    const barcodeVideo = document.getElementById('barcode-video');
    const barcodeInput = document.getElementById('barcode-value');
    let barcodeStream = null;
    let barcodeDetector = null;
    let barcodeActive = false;
    const barcodeFormats = ['ean_13','ean_8','code_128','code_39','qr_code','upc_a','upc_e','itf','data_matrix','pdf417'];

    function setBarcodeStatus(key, value){
      if(!barcodeStatus) return;
      const txt = t(key);
      barcodeStatus.textContent = (value !== undefined && txt.includes('%s')) ? txt.replace('%s', value) : txt;
    }

    async function ensureBarcodeDetector(){
      if(barcodeDetector) return barcodeDetector;
      if(!('BarcodeDetector' in window)) return null;
      try{
        barcodeDetector = new BarcodeDetector({ formats: barcodeFormats });
      }catch(err){
        console.warn('BarcodeDetector init error', err);
        try{ barcodeDetector = new BarcodeDetector(); }
        catch(err2){ console.warn('BarcodeDetector fallback failed', err2); barcodeDetector = null; }
      }
      return barcodeDetector;
    }

    function openBarcodeModal(){
      setBarcodeStatus('barcodeStatusInit');
      barcodeModal.classList.remove('hidden');
      barcodeModal.classList.add('flex');
      bodyEl.classList.add('overflow-hidden');
    }

    function stopBarcodeScan(keepStatus=false){
      barcodeActive = false;
      if(barcodeStream){
        barcodeStream.getTracks().forEach(track=>track.stop());
        barcodeStream = null;
      }
      if(barcodeVideo){
        barcodeVideo.pause?.();
        barcodeVideo.srcObject = null;
      }
      barcodeStopBtn.classList.add('hidden');
      if(!keepStatus){
        setBarcodeStatus('barcodeStatusInit');
      }
    }

    function closeBarcodeModal(){
      stopBarcodeScan();
      barcodeModal.classList.add('hidden');
      barcodeModal.classList.remove('flex');
      bodyEl.classList.remove('overflow-hidden');
    }

    async function startBarcodeScan(){
      if(!navigator.mediaDevices?.getUserMedia){
        setBarcodeStatus('barcodeStatusNoCamera');
        barcodeStopBtn.classList.add('hidden');
        return;
      }
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }});
        barcodeStream = stream;
        barcodeVideo.srcObject = stream;
        await barcodeVideo.play();
        barcodeStopBtn.classList.remove('hidden');
        const detector = await ensureBarcodeDetector();
        if(!detector){
          setBarcodeStatus('barcodeStatusNoApi');
          return;
        }
        barcodeActive = true;
        setBarcodeStatus('barcodeStatusScanning');
        requestAnimationFrame(scanLoop);
      }catch(err){
        console.warn('Barcode camera error', err);
        if(err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')){
          setBarcodeStatus('barcodeStatusDenied');
        }else{
          setBarcodeStatus('barcodeStatusNoCamera');
        }
        stopBarcodeScan(true);
      }
    }

    async function scanLoop(){
      if(!barcodeActive || !barcodeDetector) return;
      try{
        const barcodes = await barcodeDetector.detect(barcodeVideo);
        if(barcodes && barcodes.length){
          const code = String(barcodes[0].rawValue || '').trim();
          if(code){
            barcodeInput.value = code;
            barcodeInput.focus();
            barcodeInput.classList.add('barcode-highlight');
            setTimeout(()=> barcodeInput.classList.remove('barcode-highlight'), 1400);
            setBarcodeStatus('barcodeStatusSuccess', code);
            stopBarcodeScan(true);
            setTimeout(()=> closeBarcodeModal(), 900);
            return;
          }
        }
      }catch(err){
        console.warn('Barcode detect error', err);
      }
      if(barcodeActive) requestAnimationFrame(scanLoop);
    }

    barcodeStartBtn?.addEventListener('click', ()=>{ openBarcodeModal(); startBarcodeScan(); });
    barcodeCloseBtn?.addEventListener('click', closeBarcodeModal);
    barcodeModal?.addEventListener('click', (event)=>{ if(event.target === barcodeModal){ closeBarcodeModal(); }});
    barcodeStopBtn?.addEventListener('click', ()=>{ stopBarcodeScan(true); setBarcodeStatus('barcodeStatusStopped'); });
    document.addEventListener('keydown', (event)=>{ if(event.key === 'Escape' && !barcodeModal.classList.contains('hidden')) closeBarcodeModal(); });

    /* ========== Pro modal (pharmacies) ========== */
    const proModal = document.getElementById('pro-modal');
    const proClose = document.getElementById('pro-close');
    const proTabSignin = document.getElementById('pro-tab-signin');
    const proTabRegister = document.getElementById('pro-tab-register');
    const proSigninView = document.getElementById('pro-view-signin');
    const proRegisterView = document.getElementById('pro-view-register');
    const proOpeners = document.querySelectorAll('[data-open-pro]');
    const proSwitchers = document.querySelectorAll('[data-pro-switch]');
    const proSigninBtn = document.getElementById('pro-signin-submit');
    const proForgotBtn = document.getElementById('pro-forgot');
    const proRegisterForm = document.getElementById('pro-register-form');

    function setProMode(mode='signin'){
      const isSignin = mode==='signin';
      proSigninView.classList.toggle('hidden', !isSignin);
      proRegisterView.classList.toggle('hidden', isSignin);
      proTabSignin.classList.toggle('bg-white', isSignin);
      proTabSignin.classList.toggle('dark:bg-slate-800', isSignin);
      proTabSignin.classList.toggle('text-slate-900', isSignin);
      proTabSignin.classList.toggle('dark:text-slate-100', isSignin);
      proTabSignin.classList.toggle('text-slate-600', !isSignin);
      proTabSignin.classList.toggle('dark:text-slate-400', !isSignin);
      proTabSignin.classList.toggle('shadow-soft', isSignin);
      proTabSignin.setAttribute('aria-selected', isSignin);
      proTabRegister.classList.toggle('bg-white', !isSignin);
      proTabRegister.classList.toggle('dark:bg-slate-800', !isSignin);
      proTabRegister.classList.toggle('text-slate-900', !isSignin);
      proTabRegister.classList.toggle('dark:text-slate-100', !isSignin);
      proTabRegister.classList.toggle('text-slate-600', isSignin);
      proTabRegister.classList.toggle('dark:text-slate-400', isSignin);
      proTabRegister.classList.toggle('shadow-soft', !isSignin);
      proTabRegister.setAttribute('aria-selected', !isSignin);
    }

    function openProModal(mode='signin'){
      setProMode(mode);
      proModal.classList.remove('hidden');
      proModal.classList.add('flex');
      bodyEl.classList.add('overflow-hidden');
    }

    function closeProModal(){
      proModal.classList.add('hidden');
      proModal.classList.remove('flex');
      bodyEl.classList.remove('overflow-hidden');
      setProMode('signin');
    }

    proOpeners.forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        openProModal(btn.dataset.mode || 'signin');
      });
    });
    proTabSignin.addEventListener('click', ()=> setProMode('signin'));
    proTabRegister.addEventListener('click', ()=> setProMode('register'));
    proSwitchers.forEach(btn=> btn.addEventListener('click', ()=> setProMode(btn.dataset.proSwitch || 'signin')));
    proClose.addEventListener('click', closeProModal);
    proModal.addEventListener('click', (event)=>{ if(event.target === proModal){ closeProModal(); }});
    document.addEventListener('keydown', (event)=>{ if(event.key === 'Escape' && !proModal.classList.contains('hidden')) closeProModal(); });

    document.querySelectorAll('.pro-sso-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const provider = btn.dataset.provider;
        alert(state.lang==='el'
          ? `Η σύνδεση με ${provider} θα είναι σύντομα διαθέσιμη.`
          : `${provider} sign-in is coming soon.`);
      });
    });

    proSigninBtn.addEventListener('click', ()=>{
      alert(state.lang==='el'
        ? 'Η σύνδεση φαρμακείου θα είναι σύντομα διαθέσιμη.'
        : 'Pharmacy sign-in will be available soon.');
    });

    proForgotBtn.addEventListener('click', ()=>{
      alert(state.lang==='el'
        ? 'Θα προσθέσουμε ροή ανάκτησης κωδικού σύντομα.'
        : 'Password recovery will be added soon.');
    });

    proRegisterForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      alert(state.lang==='el'
        ? 'Ευχαριστούμε! Η ομάδα MediRadar θα επικοινωνήσει μαζί σου για την ολοκλήρωση της εγγραφής.'
        : 'Thanks! The MediRadar team will reach out to finish your registration.');
      closeProModal();
    });

    /* ========== Autocomplete (demo) ========== */
    const AC_MEDICINES = [
      'Algofren 400mg',
      'Apotel 500mg',
      'Augmentin 875mg/125mg',
      'Bepanthene 5% Cream',
      'Betadine 10%',
      'Canesten 1% Cream',
      'Clavulin 875/125mg',
      'Daktarin Gel',
      'Depon 500mg',
      'Efferalgan 500mg',
      'Fucidin 2%',
      'Gaviscon Double Action',
      'Humira 40mg Pen',
      'Imodium 2mg',
      'Losec 20mg',
      'Nurofen Express 400mg',
      'Otrivin 0.1% Spray',
      'Panadol 500mg',
      'Plavix 75mg',
      'Prospan Syrup',
      'Salospir 100mg',
      'Synagis 100mg',
      'Voltaren 50mg',
      'Xanax 0.5mg',
      'Zylapour 300mg',
      'Zyrtec 10mg'
    ];
    const AC_SUBSTANCES = [
      'Acetylcysteine 600mg',
      'Acetylsalicylic Acid 100mg',
      'Acyclovir 400mg',
      'Allopurinol 300mg',
      'Amlodipine 5mg',
      'Amoxicillin 500mg',
      'Amoxicillin + Clavulanic Acid 875/125mg',
      'Atorvastatin 20mg',
      'Azithromycin 500mg',
      'Cetirizine 10mg',
      'Doxycycline 100mg',
      'Ibuprofen 400mg',
      'Levocetirizine 5mg',
      'Metformin 1000mg',
      'Metoprolol 50mg',
      'Omeprazole 20mg',
      'Paracetamol 500mg',
      'Rivaroxaban 20mg',
      'Rosuvastatin 10mg',
      'Salbutamol 2mg/5ml',
      'Valsartan 160mg'
    ];
    function attachAutocomplete(inputId, listId, data){
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      let idx = -1;
      function render(items){
        list.innerHTML = items.map((x,i)=>`<div class="ac-item px-3 py-2 text-sm hover:bg-brand-50 dark:hover:bg-slate-800 ${i===idx?'bg-brand-50 dark:bg-slate-800':''}" data-val="${x}">${x}</div>`).join('');
        list.classList.toggle('hidden', items.length===0);
      }
      function filter(q){ if(!q){ render([]); return; } render(data.filter(s=>s.toLowerCase().includes(q.toLowerCase())).slice(0,10)); }
      input.addEventListener('input', ()=>{ idx=-1; filter(input.value.trim()); });
      input.addEventListener('keydown', (e)=>{
        const items = [...list.querySelectorAll('.ac-item')]; if(!items.length) return;
        if(e.key==='ArrowDown'){ idx=(idx+1)%items.length; render(items.map(n=>n.dataset.val)); e.preventDefault(); }
        else if(e.key==='ArrowUp'){ idx=(idx-1+items.length)%items.length; render(items.map(n=>n.dataset.val)); e.preventDefault(); }
        else if(e.key==='Enter'){ if(idx>=0){ input.value = items[idx].dataset.val; render([]); } }
        else if(e.key==='Escape'){ render([]); }
      });
      list.addEventListener('click', (e)=>{ const item = e.target.closest('.ac-item'); if(!item) return; input.value = item.dataset.val; list.classList.add('hidden'); });
      document.addEventListener('click', (e)=>{ if(!list.contains(e.target) && e.target!==input){ list.classList.add('hidden'); }});
    }
    attachAutocomplete('medicine-name','ac-medicine',AC_MEDICINES);
    attachAutocomplete('active-substance','ac-substance',AC_SUBSTANCES);

    /* ========== Pending + Confetti ========== */
    const pendingToast=document.getElementById('pending-toast'), waitSpan=document.getElementById('wait-elapsed');
    let waitT=null, waitStart=0;
    function showPending(){
      waitStart=Date.now();
      pendingToast.classList.remove('hidden');
      if(waitT) clearInterval(waitT);
      waitT=setInterval(()=>{waitSpan.textContent=Math.floor((Date.now()-waitStart)/1000)+'s'},500);
      setResultsState('pending');
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function hidePending(){ pendingToast.classList.add('hidden'); if(waitT){clearInterval(waitT); waitT=null;} }
    function fireConfetti(ms=3500){
      const c=document.getElementById('confetti'),ctx=c.getContext('2d');
      const W=c.width=innerWidth,H=c.height=innerHeight; c.style.display='block';
      const N=180,P=Array.from({length:N},()=>({x:Math.random()*W,y:-20-Math.random()*H*.3,r:2+Math.random()*4,vx:-1+Math.random()*2,vy:2+Math.random()*3,a:Math.random()*Math.PI,va:-.2+Math.random()*.4}));
      let run=true; const end=performance.now()+ms;
      (function loop(t){ if(t>end) run=false;
        ctx.clearRect(0,0,W,H);
        P.forEach(p=>{ if(run) p.vy+=.02; p.x+=p.vx; p.y+=p.vy; p.a+=p.va;
          if(p.y>H+20){p.y=-20;p.x=Math.random()*W;p.vy=2+Math.random()*3}
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a);
          ctx.fillStyle=`hsl(${(p.x/W)*360},90%,55%)`; ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2); ctx.restore();
        });
        if(run) requestAnimationFrame(loop); else { c.style.display='none'; ctx.clearRect(0,0,W,H); }
      })(performance.now());
    }

    /* ========== Supabase helpers ========== */
    function sb(){ return window.supabase; }
    function hasSupabase(){ return !!(window.supabase && window.ENV && window.ENV.SUPABASE_URL); }
    const LS_REQ = 'mr:lastRequest';

    async function apiFetch(path, { method = 'GET', body, headers } = {}) {
      const url = `${API_BASE}/${path.replace(/^\//,'')}`;
      const opts = { method, headers: { 'Content-Type': 'application/json', ...(headers || {}) } };
      if (body !== undefined) {
        opts.body = typeof body === 'string' ? body : JSON.stringify(body);
      }
      const res = await fetch(url, opts);
      const txt = await res.text().catch(()=> '');
      if (!res.ok) {
        throw new Error(`API ${path} ${res.status}: ${txt}`);
      }
      return txt ? JSON.parse(txt) : {};
    }

    /* ========== Results + Pharmacy modal + Pickup timer ========== */
    const results = document.getElementById('results');
    const resultsPanel = document.getElementById('results-panel');
    const resultsBackdrop = document.getElementById('results-backdrop');
    const resultsCloseBtn = document.getElementById('results-close');
    const resultsList = document.getElementById('resultsList');
    const resultsPending = document.getElementById('results-pending');
    const resultsListWrap = document.getElementById('results-list');
    const resultsEmpty = document.getElementById('results-empty');
    const resultsError = document.getElementById('results-error');
    const statusErrorBtn = document.getElementById('status-error-btn');
    const pickupBox = document.getElementById('pickup-box');
    const pickupTimerEl = document.getElementById('pickup-timer');
    const extendBtn = document.getElementById('extend-btn');
    const statusReservedName = document.getElementById('status-reserved-name');
    const statusReservedAddress = document.getElementById('status-reserved-address');
    const statusReservedGeneric = document.getElementById('status-reserved-generic');
    const statusCallLink = document.getElementById('status-call');
    const statusDirectionsLink = document.getElementById('status-directions');
    const statusEmptyBtn = document.getElementById('status-empty-btn');
    const statusNotifyBtn = document.getElementById('status-notify');
    const locationBanner = document.getElementById('location-banner');
    const LS_PICKUP = 'mr:lastPickup';
    const API_BASE = '/.netlify/functions';
    let pInt=null, remaining=0, pollInt=null;
    const geoState = { status:'idle', coords:null, error:null };
    let latestResultsItems = [];
    const AUTH_STORAGE_KEY = 'mr:auth';
    const authState = {
      verified: false,
      method: null,
      flow: 'login',
      tab: 'sms',
      sms: { code: null, expiresAt: 0 },
      email: { target: '', sentAt: 0 }
    };
    let authCallback = null;

    function showResultsWrapper(){
      results.classList.remove('hidden');
      bodyEl.classList.add('overflow-hidden');
      resultsPanel?.focus();
    }

    function hideResultsWrapper(){
      results.classList.add('hidden');
      bodyEl.classList.remove('overflow-hidden');
    }
    function setResultsState(state){
      showResultsWrapper();
      resultsPending?.classList.toggle('hidden', state!=='pending');
      resultsListWrap?.classList.toggle('hidden', state!=='list');
      resultsEmpty?.classList.toggle('hidden', state!=='empty');
      resultsError?.classList.toggle('hidden', state!=='error');
      pickupBox?.classList.toggle('hidden', state!=='reserved');
      if(state!=='list'){ locationBanner?.classList.add('hidden'); }
      if(state==='pending'){
        resultsList.innerHTML='';
        if(statusCallLink){ statusCallLink.href = '#'; setLinkAvailability(statusCallLink, false); }
        if(statusDirectionsLink){ statusDirectionsLink.href = '#'; setLinkAvailability(statusDirectionsLink, false); }
        statusReservedGeneric?.classList.add('hidden');
      }
      if(state==='empty' || state==='error'){
        if(statusCallLink){ statusCallLink.href = '#'; setLinkAvailability(statusCallLink, false); }
        if(statusDirectionsLink){ statusDirectionsLink.href = '#'; setLinkAvailability(statusDirectionsLink, false); }
        statusReservedGeneric?.classList.add('hidden');
      }
      if(state==='pending' || state==='empty' || state==='error'){ selectedPharmacy = null; }
      if(state!=='pending'){
        results.scrollIntoView({ behavior:'smooth', block:'start' });
      }
    }
    function setLinkAvailability(el, enabled){
      if(!el) return;
      el.classList.toggle('opacity-60', !enabled);
      el.classList.toggle('pointer-events-none', !enabled);
    }

    function updateLocationBanner(){
      if(!locationBanner) return;
      let text='';
      if(geoState.status==='loading') text = t('locationLoading');
      else if(geoState.status==='denied') text = t('locationDenied');
      else if(geoState.status==='unsupported') text = t('locationUnsupported');
      else if(geoState.status==='error') text = t('locationError');
      if(text){
        locationBanner.textContent = text;
        locationBanner.classList.remove('hidden');
      }else{
        locationBanner.classList.add('hidden');
      }
    }

    function ensureLocation(){
      if(!navigator?.geolocation){
        if(geoState.status!=='unsupported'){
          geoState.status='unsupported';
          updateLocationBanner();
        }
        return;
      }
      if(geoState.status==='idle'){
        geoState.status='loading';
        updateLocationBanner();
        navigator.geolocation.getCurrentPosition((pos)=>{
          geoState.status='granted';
          geoState.coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          geoState.error=null;
          updateLocationBanner();
          drawResults();
        }, (err)=>{
          geoState.error = err;
          if(err && err.code === err.PERMISSION_DENIED){
            geoState.status='denied';
          }else{
            geoState.status='error';
          }
          updateLocationBanner();
          drawResults();
        }, { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
      }else{
        updateLocationBanner();
      }
    }

    function toNumber(val){ const num = Number(val); return Number.isFinite(num) ? num : null; }
    function haversineKm(lat1, lon1, lat2, lon2){
      if(lat1==null || lon1==null || lat2==null || lon2==null) return null;
      const toRad = d=>d*Math.PI/180;
      const R=6371;
      const dLat=toRad(lat2-lat1);
      const dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
      return R*c;
    }

    function toPickupPharmacy(raw){
      if(!raw) return null;
      if(typeof raw === 'string'){
        return {
          name: raw,
          addr: '',
          tel: '',
          lat: '',
          lng: '',
          is_generic: false
        };
      }
      if(raw.pharmacy){
        return toPickupPharmacy({
          ...raw.pharmacy,
          is_generic: raw.is_generic ?? raw.pharmacy.is_generic
        });
      }
      return {
        name: raw.name || raw.pharmacy_name || raw.title || (state.lang==='el'?'Φαρμακείο':'Pharmacy'),
        addr: raw.addr || raw.address || raw.pharmacy_address || '',
        tel: raw.tel || raw.phone || raw.pharmacy_phone || '',
        lat: raw.lat ?? raw.pharmacy_lat ?? '',
        lng: raw.lng ?? raw.pharmacy_lng ?? '',
        is_generic: !!(raw.is_generic ?? raw.generic ?? false)
      };
    }

    function populateReservedDetails(pharmacy){
      const fallbackName = state.lang==='el'?'Φαρμακείο':'Pharmacy';
      const fallbackAddress = state.lang==='el'?'Χωρίς διαθέσιμη διεύθυνση':'No address provided';
      statusReservedName.textContent = pharmacy?.name || fallbackName;
      statusReservedAddress.textContent = pharmacy?.addr || fallbackAddress;
      statusReservedGeneric.classList.toggle('hidden', !pharmacy?.is_generic);
      if(pharmacy?.tel){
        const tel = pharmacy.tel.replace(/\s+/g,'');
        statusCallLink.href = `tel:${tel}`;
        setLinkAvailability(statusCallLink, true);
      } else {
        statusCallLink.href = '#';
        setLinkAvailability(statusCallLink, false);
      }
      const querySource = pharmacy?.addr || pharmacy?.name || '';
      if(querySource){
        const encoded = encodeURIComponent(querySource);
        let href = `https://www.google.com/maps?q=${encoded}`;
        if(pharmacy?.lat && pharmacy?.lng){
          href = `https://www.google.com/maps?q=${encoded}@${pharmacy.lat},${pharmacy.lng},17z`;
        }
        statusDirectionsLink.href = href;
        setLinkAvailability(statusDirectionsLink, true);
      } else {
        statusDirectionsLink.href = '#';
        setLinkAvailability(statusDirectionsLink, false);
      }
    }

    function fmt(s){const m=String(Math.floor(s/60)).padStart(2,'0'), ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`;}
    function stopPickupTimer(){ if(pInt){clearInterval(pInt); pInt=null;} pickupBox?.classList.add('hidden'); }
    function startPickupTimer(sec){
      setResultsState('reserved');
      remaining=sec; pickupTimerEl.textContent=fmt(remaining);
      const last=localStorage.getItem('pickup-extend-date'); const today=new Date().toISOString().slice(0,10);
      extendBtn.disabled=(last===today); extendBtn.classList.toggle('opacity-50',extendBtn.disabled);
      if(pInt) clearInterval(pInt);
      pInt=setInterval(()=>{remaining--; if(remaining<=0){stopPickupTimer(); return;} pickupTimerEl.textContent=fmt(remaining)},1000);
    }
    extendBtn.onclick=async ()=>{
      if(extendBtn.disabled) return;
      extendBtn.disabled = true;
      extendBtn.classList.add('opacity-50');
      try{
        if(window.currentRequest?.mode === 'functions' && window.currentRequest?.token){
          const hold = await extendViaFunctions(window.currentRequest.token);
          if(hold){
            const diff = Math.max(0, Math.round((new Date(hold).getTime() - Date.now())/1000));
            if(diff > 0){
              remaining = diff;
              pickupTimerEl.textContent = fmt(remaining);
            }
          } else {
            remaining += 15*60;
            pickupTimerEl.textContent = fmt(remaining);
          }
        } else {
          remaining += 15*60;
          pickupTimerEl.textContent = fmt(remaining);
          if(hasSupabase() && window.currentRequest?.id){
            const newUntil = new Date(Date.now()+remaining*1000).toISOString();
            await sb().from('requests').update({ pickup_until: newUntil }).eq('id', window.currentRequest.id);
          }
        }
      }catch(err){
        console.warn('extend error', err);
        remaining += 15*60;
        pickupTimerEl.textContent = fmt(remaining);
      }
      localStorage.setItem('pickup-extend-date', new Date().toISOString().slice(0,10));
    };

    statusEmptyBtn?.addEventListener('click', ()=>{
      hidePending();
      hideResultsWrapper();
      resultsPending?.classList.remove('hidden');
      resultsListWrap?.classList.add('hidden');
      resultsEmpty?.classList.add('hidden');
      pickupBox?.classList.add('hidden');
      selectedPharmacy = null;
      window.scrollTo({ top: 0, behavior:'smooth' });
    });

    statusErrorBtn?.addEventListener('click', ()=>{
      if(!window.currentRequest) return;
      showPending();
      startPolling({ mode: window.currentRequest.mode || 'functions' });
    });

    resultsCloseBtn?.addEventListener('click', hideResultsWrapper);
    resultsBackdrop?.addEventListener('click', (event)=>{ if(event.target === resultsBackdrop) hideResultsWrapper(); });

    const pm = document.getElementById('pharm-modal');
    const pmPanel = document.getElementById('pharm-modal-panel');
    const pmTitle = document.getElementById('pm-title');
    const pmAddr  = document.getElementById('pm-address');
    const pmPhone = document.getElementById('pm-phone');
    const pmCall  = document.getElementById('pm-call');
    const pmMaps  = document.getElementById('pm-maps');
    const pmConfirm = document.getElementById('pm-confirm');

    const authGate = document.getElementById('auth-gate');
    const authGatePanel = document.getElementById('auth-gate-panel');
    const authCloseBtn = document.getElementById('auth-close');
    const authFlowButtons = Array.from(document.querySelectorAll('.auth-flow-btn'));
    const authTabButtons = Array.from(document.querySelectorAll('.auth-tab-btn'));
    const authTabs = {
      sms: document.getElementById('auth-tab-sms'),
      email: document.getElementById('auth-tab-email'),
      sso: document.getElementById('auth-tab-sso')
    };
    const authStatusEl = document.getElementById('auth-status');
    const authContinueBtn = document.getElementById('auth-continue');
    const authSmsPhone = document.getElementById('auth-sms-phone');
    const authSmsSend = document.getElementById('auth-sms-send');
    const authSmsResend = document.getElementById('auth-sms-resend');
    const authSmsCode = document.getElementById('auth-sms-code');
    const authSmsVerify = document.getElementById('auth-sms-verify');
    const authEmailInput = document.getElementById('auth-email-value');
    const authEmailSend = document.getElementById('auth-email-send');
    const authEmailConfirm = document.getElementById('auth-email-confirm');
    const authSsoButtons = Array.from(document.querySelectorAll('.auth-sso-btn'));

    document.addEventListener('keydown', (event)=>{
      if(event.key !== 'Escape') return;
      let consumed = false;
      if(!authGate.classList.contains('hidden')){
        closeAuthGate();
        authCallback = null;
        consumed = true;
      } else if(!pm.classList.contains('hidden')){
        pm.classList.add('hidden');
        pm.classList.remove('flex');
        consumed = true;
      } else if(!results.classList.contains('hidden')){
        hideResultsWrapper();
        consumed = true;
      }
      if(consumed) event.preventDefault();
    });

    function setAuthStatus(message='', tone='info'){
      if(!authStatusEl) return;
      authStatusEl.textContent = message || '';
      authStatusEl.classList.remove('text-emerald-600','dark:text-emerald-300','text-rose-600','dark:text-rose-400','text-slate-600','dark:text-slate-300');
      if(!message) return;
      if(tone==='success'){ authStatusEl.classList.add('text-emerald-600','dark:text-emerald-300'); }
      else if(tone==='error'){ authStatusEl.classList.add('text-rose-600','dark:text-rose-400'); }
      else { authStatusEl.classList.add('text-slate-600','dark:text-slate-300'); }
    }

    function updateAuthContinue(){
      const enabled = !!authState.verified;
      authContinueBtn?.classList.toggle('opacity-60', !enabled);
      authContinueBtn?.classList.toggle('pointer-events-none', !enabled);
    }

    function setAuthFlow(flow){
      authState.flow = flow;
      authFlowButtons.forEach(btn=>{
        const active = btn.dataset.authFlow === flow;
        btn.classList.toggle('bg-white', active);
        btn.classList.toggle('dark:bg-slate-800', active);
        btn.classList.toggle('shadow-soft', active);
        btn.classList.toggle('text-slate-600', !active);
        btn.classList.toggle('dark:text-slate-300', !active);
        btn.setAttribute('aria-pressed', active);
      });
      updateAuthFlowHint();
    }

    function updateAuthFlowHint(){
      if(authState.flow === 'guest'){
        setAuthStatus(t('authGuestHint'), 'info');
      } else {
        setAuthStatus('');
      }
    }

    function setAuthTab(tab){
      authState.tab = tab;
      authTabButtons.forEach(btn=>{
        const active = btn.dataset.authTab === tab;
        btn.setAttribute('aria-selected', active);
        btn.classList.toggle('bg-white', active);
        btn.classList.toggle('dark:bg-slate-800', active);
        btn.classList.toggle('shadow-soft', active);
        btn.classList.toggle('border-slate-300', active);
        btn.classList.toggle('dark:border-slate-700', active);
        btn.classList.toggle('border-transparent', !active);
        btn.classList.toggle('text-slate-600', !active);
        btn.classList.toggle('dark:text-slate-300', !active);
      });
      Object.entries(authTabs).forEach(([key, panel])=>{
        if(!panel) return;
        panel.classList.toggle('hidden', key !== tab);
      });
    }

    function resetAuthGate(){
      authState.tab = 'sms';
      authState.sms.code = null;
      authState.sms.expiresAt = 0;
      authState.email.target = '';
      authState.email.sentAt = 0;
      authSmsPhone.value = '';
      authSmsCode.value = '';
      authEmailInput.value = '';
      authSmsResend?.classList.add('hidden');
      setAuthFlow('login');
      setAuthTab('sms');
      setAuthStatus('');
      updateAuthContinue();
    }

    function openAuthGate(callback){
      authCallback = callback;
      resetAuthGate();
      authGate?.classList.remove('hidden');
      authGate?.classList.add('flex');
      bodyEl.classList.add('overflow-hidden');
      if(authState.verified){
        setAuthStatus(t('authAlreadyVerified'), 'success');
        updateAuthContinue();
      }
      authGatePanel?.focus();
    }

    function closeAuthGate(){
      authGate?.classList.add('hidden');
      authGate?.classList.remove('flex');
      if(results.classList.contains('hidden')){
        bodyEl.classList.remove('overflow-hidden');
      }else{
        bodyEl.classList.add('overflow-hidden');
      }
    }

    function markVerified(method){
      authState.verified = true;
      authState.method = method;
      setAuthStatus(t('authStatusSuccess'), 'success');
      updateAuthContinue();
      try{
        sessionStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify({ verified:true, method, flow:authState.flow, ts:Date.now() }));
      }catch{}
    }

    authFlowButtons.forEach(btn=>{
      btn.addEventListener('click', ()=> setAuthFlow(btn.dataset.authFlow || 'login'));
    });

    authTabButtons.forEach(btn=>{
      btn.addEventListener('click', ()=> setAuthTab(btn.dataset.authTab || 'sms'));
    });

    authCloseBtn?.addEventListener('click', ()=>{ closeAuthGate(); authCallback = null; });
    authGate?.addEventListener('click', (event)=>{ if(event.target === authGate){ closeAuthGate(); authCallback = null; }});

    function sendSmsCode(){
      const phone = (authSmsPhone?.value || '').trim();
      if(!phone || phone.replace(/\D/g,'').length < 8){
        setAuthStatus(t('authSmsInvalid'), 'error');
        return;
      }
      const code = String(Math.floor(100000 + Math.random()*900000));
      authState.sms.code = code;
      authState.sms.expiresAt = Date.now() + 3*60*1000;
      authSmsResend?.classList.remove('hidden');
      setAuthStatus(t('authSmsSent').replace('%s', code), 'info');
      authSmsCode?.focus();
    }

    authSmsSend?.addEventListener('click', sendSmsCode);
    authSmsResend?.addEventListener('click', sendSmsCode);

    authSmsVerify?.addEventListener('click', ()=>{
      if(!authState.sms.code){
        setAuthStatus(t('authSmsNeedSend'), 'error');
        return;
      }
      if(Date.now() > authState.sms.expiresAt){
        setAuthStatus(t('authStatusExpired'), 'error');
        return;
      }
      const code = (authSmsCode?.value || '').trim();
      if(code !== authState.sms.code){
        setAuthStatus(t('authStatusInvalid'), 'error');
        return;
      }
      markVerified(`sms:${authState.flow}`);
    });

    authEmailSend?.addEventListener('click', ()=>{
      const email = (authEmailInput?.value || '').trim();
      if(!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){
        setAuthStatus(t('authEmailInvalid'), 'error');
        return;
      }
      authState.email.target = email;
      authState.email.sentAt = Date.now();
      setAuthStatus(t('authEmailSent').replace('%s', email), 'info');
    });

    authEmailConfirm?.addEventListener('click', ()=>{
      if(!authState.email.target){
        setAuthStatus(t('authEmailNeedSend'), 'error');
        return;
      }
      if(Date.now() - authState.email.sentAt > 5*60*1000){
        setAuthStatus(t('authStatusExpired'), 'error');
        return;
      }
      markVerified(`email:${authState.flow}`);
    });

    authSsoButtons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const provider = btn.dataset.provider || 'SSO';
        setAuthStatus(t('authSsoSuccess').replace('%s', provider), 'success');
        markVerified(`sso:${provider.toLowerCase()}`);
      });
    });

    authContinueBtn?.addEventListener('click', ()=>{
      if(!authState.verified){
        setAuthStatus(t('authNeedVerification'), 'error');
        return;
      }
      closeAuthGate();
      const cb = authCallback;
      authCallback = null;
      if(typeof cb === 'function') cb();
    });

    /* ========== CREATE REQUEST ========== */
    async function insertRequestRow(row){
      const { data, error } = await sb().from('requests').insert(row).select('id,created_at').single();
      if(error) throw error;
      return data;
    }

    async function createRequest(payload){
      if(!hasSupabase()) throw new Error('NO_DB');
      const baseRow = {
        status: 'pending',
        med_name: payload.med_name,
        active_substance: payload.active_substance || null,
        med_type: payload.med_type || null,
        quantity: payload.quantity,
        allow_generic: payload.allow_generic,
        city: payload.city
      };
      if(payload.barcode){
        try {
          return await insertRequestRow({ ...baseRow, barcode_value: payload.barcode });
        } catch(err){
          console.warn('Falling back without barcode_value column', err);
        }
      }
      return insertRequestRow(baseRow);
    }

    async function submitViaFunctions(payload){
      try{
        const res = await apiFetch('send-request', {
          method:'POST',
          body: {
            lang: state.lang,
            city: payload.city,
            medicine_name: payload.med_name,
            substance: payload.active_substance || '',
            type: payload.med_type || '',
            quantity: payload.quantity,
            allow_generic: payload.allow_generic,
            rx_number: payload.barcode || ''
          }
        });
        if(res?.ok){
          return { id: res.request_id, token: res.token };
        }
      }catch(err){
        console.warn('send-request error', err);
      }
      return null;
    }

    function mapReplyToItem(reply){
      if(!reply) return null;
      const available = reply.available;
      if(available === false) return null;
      const pharmacy = reply.pharmacy || {};
      return {
        id: reply.id || reply.reply_id || pharmacy.id || Math.random().toString(36).slice(2),
        is_generic: !!(reply.is_generic ?? reply.generic ?? false),
        pharmacy: {
          id: pharmacy.id || reply.pharmacy_id || null,
          name: reply.pharmacy_name || pharmacy.name || (state.lang==='el'?'Φαρμακείο':'Pharmacy'),
          address: reply.address || pharmacy.address || reply.pharmacy_address || '',
          phone: reply.phone || pharmacy.phone || reply.pharmacy_phone || '',
          lat: (reply.lat ?? pharmacy.lat ?? reply.pharmacy_lat ?? ''),
          lng: (reply.lng ?? pharmacy.lng ?? reply.pharmacy_lng ?? '')
        }
      };
    }

    async function pollStatusFunctions(token){
      if(!token) return null;
      try{
        const data = await apiFetch(`request-status?token=${encodeURIComponent(token)}`);
        const replies = Array.isArray(data.replies) ? data.replies : [];
        const items = replies
          .map(mapReplyToItem)
          .filter(Boolean);
        const reservedPharmacy = data.reserved_pharmacy || data.pickup_pharmacy || null;
        return {
          status: data.status || 'pending',
          items,
          holdUntil: data.hold_until || null,
          extendUsedAt: data.extend_used_at || null,
          reservedPharmacy
        };
      }catch(err){
        console.warn('request-status error', err);
        throw err;
      }
    }

    async function reserveViaFunctions(token){
      if(!token) return null;
      try{
        const data = await apiFetch('reserve', { method:'POST', body:{ token } });
        return data?.hold_until || null;
      }catch(err){
        console.warn('reserve error', err);
        return null;
      }
    }

    async function extendViaFunctions(token){
      if(!token) return null;
      try{
        const data = await apiFetch('extend-hold', { method:'POST', body:{ token } });
        return data?.hold_until || null;
      }catch(err){
        console.warn('extend-hold error', err);
        return null;
      }
    }

    /* ========== POLLING RESPONSES ========== */
    async function fetchResponses(requestId){
      const { data: rows, error } = await sb()
        .from('responses')
        .select('id, request_id, is_generic, pharmacy_id, available')
        .eq('request_id', requestId)
        .eq('available', true);

      if(error) throw error;
      if(!rows || !rows.length) return [];

      const pharmacyIds = [...new Set(rows.map(r=>r.pharmacy_id).filter(Boolean))];
      let pharmacies = [];
      if(pharmacyIds.length){
        const { data: phs } = await sb()
          .from('pharmacies')
          .select('id,name,address,phone,hours_json,lat,lng')
          .in('id', pharmacyIds);
        pharmacies = phs || [];
      }
      const byId = Object.fromEntries(pharmacies.map(p=>[p.id, p]));
      return rows.map(r=>({
        id: r.id,
        is_generic: !!r.is_generic,
        pharmacy: byId[r.pharmacy_id] || { id:r.pharmacy_id, name:'Φαρμακείο', address:'—', phone:'—' }
      }));
    }

    function startPolling({ mode, startTime=Date.now() }){
      if(pollInt) clearInterval(pollInt);

      async function handleFunctions(){
        if(!window.currentRequest?.token) return;
        const data = await pollStatusFunctions(window.currentRequest.token);
        if(!data) return;
        if(data.status === 'reserved'){
          hidePending();
          let reserved = selectedPharmacy || null;
          if(!reserved){
            try{
              const stored = localStorage.getItem(LS_PICKUP);
              if(stored) reserved = toPickupPharmacy(JSON.parse(stored));
            }catch{}
          }
          if(!reserved && data.reservedPharmacy){
            reserved = toPickupPharmacy(data.reservedPharmacy);
          }
          if(reserved){
            populateReservedDetails(reserved);
            localStorage.setItem(LS_PICKUP, JSON.stringify(reserved));
            selectedPharmacy = reserved;
          }
          const holdSec = data.holdUntil ? Math.max(0, Math.round((new Date(data.holdUntil).getTime() - Date.now())/1000)) : 60*60;
          if(holdSec > 0) startPickupTimer(Math.max(holdSec, 60));
          else startPickupTimer(60*60);
          clearInterval(pollInt); pollInt=null;
          return;
        }
        if(data.items.length){
          hidePending();
          renderResults(data.items);
        } else if(Date.now() - startTime > 120000){
          hidePending();
          setResultsState('empty');
          clearInterval(pollInt); pollInt=null;
        }
      }

      async function handleSupabase(){
        if(!window.currentRequest?.id) return;
        const items = await fetchResponses(window.currentRequest.id);
        if(items.length){
          hidePending();
          renderResults(items);
          clearInterval(pollInt); pollInt=null;
        }else if(Date.now()-startTime > 120000){
          hidePending();
          setResultsState('empty');
          clearInterval(pollInt); pollInt=null;
        }
      }

      const pollOnce = async ()=>{
        try{
          if(mode === 'functions'){
            await handleFunctions();
          }else if(mode === 'supabase'){
            await handleSupabase();
          }
        }catch(err){
          console.warn('poll error', err);
          hidePending();
          setResultsState('error');
          if(pollInt) clearInterval(pollInt);
          pollInt=null;
        }
      };

      pollOnce();
      pollInt = setInterval(pollOnce, 4000);
    }

    function renderResults(items){
      latestResultsItems = Array.isArray(items) ? items.slice() : [];
      if(!latestResultsItems.length){
        resultsList.innerHTML='';
        setResultsState('empty');
        return;
      }
      ensureLocation();
      drawResults();
      setResultsState('list');
    }

    function drawResults(){
      if(!latestResultsItems.length){
        resultsList.innerHTML='';
        return;
      }
      const processed = latestResultsItems.map(item=>{
        const pharmacy = item.pharmacy || {};
        const lat = toNumber(pharmacy.lat ?? pharmacy.latitude ?? pharmacy.latLng?.lat);
        const lng = toNumber(pharmacy.lng ?? pharmacy.longitude ?? pharmacy.latLng?.lng);
        let distanceKm = null;
        if(geoState.status==='granted' && geoState.coords){
          distanceKm = haversineKm(geoState.coords.lat, geoState.coords.lng, lat, lng);
        }
        return {
          raw: item,
          pharmacy,
          lat,
          lng,
          distanceKm,
          isGeneric: !!item.is_generic
        };
      }).sort((a,b)=>{
        if(a.isGeneric !== b.isGeneric) return a.isGeneric - b.isGeneric;
        const distA = a.distanceKm ?? Number.POSITIVE_INFINITY;
        const distB = b.distanceKm ?? Number.POSITIVE_INFINITY;
        if(distA !== distB) return distA - distB;
        const nameA = (a.pharmacy.name || '').toLowerCase();
        const nameB = (b.pharmacy.name || '').toLowerCase();
        return nameA.localeCompare(nameB, state.lang==='el'?'el':'en');
      });

      resultsList.innerHTML='';
      processed.forEach(({ pharmacy: ph, distanceKm, lat, lng, isGeneric })=>{
        const name = ph.name || (state.lang==='el'?'Φαρμακείο':'Pharmacy');
        const address = ph.address || '';
        const phone = ph.phone || '';
        const availabilityText = isGeneric ? t('availabilityGeneric') : t('availabilityExact');
        const badgeLabel = isGeneric ? t('badgeGeneric') : t('badgeExact');
        const badgeClass = isGeneric ? 'badge badge-generic' : 'badge badge-exact';
        const mapsQuery = encodeURIComponent(address || name);
        const mapsHref = (lat!=null && lng!=null)
          ? `https://www.google.com/maps?q=${mapsQuery}@${lat},${lng},17z`
          : `https://www.google.com/maps?q=${mapsQuery}`;
        const telHref = phone ? `tel:${phone.replace(/\s+/g,'')}` : '#';
        const distanceValue = distanceKm!=null ? distanceKm.toFixed(1) : null;
        const distanceLabel = distanceValue!=null ? `${distanceValue} km` : t('distanceUnknown');
        const distanceAria = distanceValue!=null ? t('distanceAway').replace('%s', distanceValue) : t('distanceUnknown');
        const distanceBadgeClass = distanceValue!=null ? 'badge badge-distance' : 'badge badge-distance opacity-70';
        const card = document.createElement('article');
        card.className = 'result-card rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/90 dark:bg-slate-900/50 px-4 py-4 shadow-soft focus-within:outline-none focus-within:ring-2 focus-within:ring-brand-500/40 flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between';
        card.setAttribute('role','listitem');
        card.dataset.name = name;
        card.dataset.addr = address;
        card.dataset.tel  = phone;
        card.dataset.lat  = lat ?? '';
        card.dataset.lng  = lng ?? '';
        card.dataset.generic = isGeneric ? 'true' : 'false';
        const callDisabled = !phone;
        const callClass = `inline-flex items-center gap-2 rounded-xl border border-slate-200 dark:border-slate-700 px-3 py-2 text-sm font-semibold ${callDisabled?'pointer-events-none opacity-60':'hover:bg-slate-100 dark:hover:bg-slate-800'} focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60`;
        const callAttrs = callDisabled ? `aria-disabled="true" tabindex="-1" title="${t('actionCallDisabled')}"` : '';
        card.innerHTML = `
          <div class="flex flex-1 gap-3">
            <div class="h-12 w-12 shrink-0 rounded-2xl bg-brand-500/10 text-brand-600 grid place-items-center" aria-hidden="true">💊</div>
            <div class="flex-1 min-w-0 space-y-2">
              <div class="flex flex-wrap items-center gap-2">
                <p class="font-semibold text-slate-900 dark:text-slate-100 truncate">${name}</p>
                <span class="${badgeClass}" aria-label="${availabilityText}">${badgeLabel}</span>
              </div>
              <p class="text-sm text-slate-500 dark:text-slate-400 truncate">${address || '—'}</p>
              <div class="flex flex-wrap items-center gap-2 text-xs sm:text-sm text-slate-500 dark:text-slate-400">
                <span>${availabilityText}</span>
                <span class="${distanceBadgeClass}" aria-label="${distanceAria}">📍 ${distanceLabel}</span>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-2 sm:items-end sm:justify-between">
            <div class="flex gap-2">
              <a class="inline-flex items-center gap-2 rounded-xl border border-slate-200 dark:border-slate-700 px-3 py-2 text-sm font-semibold hover:bg-slate-100 dark:hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60" target="_blank" rel="noopener" href="${mapsHref}" aria-label="${t('actionViewMap')}">
                <span aria-hidden="true">🗺️</span> ${t('actionViewMap')}
              </a>
              <a class="${callClass}" href="${telHref}" ${callAttrs}>
                <span aria-hidden="true">📞</span> ${t('actionCall')}
              </a>
            </div>
            <button data-action="reserve" class="select-pharm inline-flex items-center justify-center rounded-xl bg-brand-600 px-4 py-2 text-sm font-semibold text-white shadow-soft hover:bg-brand-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-300">
              <span class="status-accept-label">${t('actionReserve')}</span>
            </button>
          </div>`;
        resultsList.appendChild(card);
      });
      if(geoState.status!=='idle' && geoState.status!=='granted'){
        updateLocationBanner();
      }else if(geoState.status==='granted'){
        locationBanner?.classList.add('hidden');
      }
    }

    resultsList.addEventListener('click', (e)=>{
      const btn = e.target.closest('.select-pharm'); if(!btn) return;
      const card = btn.closest('.result-card'); if(!card) return;
      selectedPharmacy = {
        name: card.dataset.name,
        addr: card.dataset.addr,
        tel: card.dataset.tel,
        lat: card.dataset.lat,
        lng: card.dataset.lng,
        is_generic: card.dataset.generic === 'true'
      };
      pmTitle.textContent = selectedPharmacy.name;
      pmAddr.textContent  = (state.lang==='el'?'Διεύθυνση: ':'Address: ') + (selectedPharmacy.addr || '—');
      pmPhone.textContent = (state.lang==='el'?'Τηλέφωνο: ':'Phone: ') + (selectedPharmacy.tel || '—');
      pmCall.href = selectedPharmacy.tel ? `tel:${selectedPharmacy.tel.replace(/\s+/g,'')}` : '#';
      pmMaps.href = `https://www.google.com/maps?q=${encodeURIComponent(selectedPharmacy.addr||selectedPharmacy.name)}${selectedPharmacy.lat?`@${selectedPharmacy.lat},${selectedPharmacy.lng},17z`:''}`;
      pm.classList.remove('hidden');
      pm.classList.add('flex');
      pmPanel?.focus();
    });

    document.getElementById('pm-close').onclick = ()=>{ pm.classList.add('hidden'); pm.classList.remove('flex'); };
    pm.addEventListener('click', (event)=>{
      if(event.target === pm){
        pm.classList.add('hidden');
        pm.classList.remove('flex');
      }
    });

    async function finalizeReservation(){
      if(!selectedPharmacy) return;
      pm.classList.add('hidden');
      pm.classList.remove('flex');
      populateReservedDetails(selectedPharmacy);
      let sec = 60*60;
      try{
        if(window.currentRequest?.mode === 'functions' && window.currentRequest?.token){
          const hold = await reserveViaFunctions(window.currentRequest.token);
          if(hold){
            const diff = Math.max(0, Math.round((new Date(hold).getTime() - Date.now())/1000));
            if(diff > 0) sec = diff;
          }
        } else if(hasSupabase() && window.currentRequest?.id){
          const untilISO = new Date(Date.now()+sec*1000).toISOString();
          await sb().from('requests').update({ status:'reserved', pickup_until: untilISO }).eq('id', window.currentRequest.id);
        }
      }catch(err){ console.warn('reserve confirm error', err); }
      localStorage.setItem(LS_PICKUP, JSON.stringify(selectedPharmacy));
      startPickupTimer(sec);
    }

    pmConfirm.addEventListener('click', ()=>{
      if(!selectedPharmacy) return;
      const proceed = ()=> finalizeReservation();
      if(authState.verified){
        proceed();
      }else{
        openAuthGate(proceed);
      }
    });

    document.getElementById('newSearch').addEventListener('click', ()=>{
      hidePending();
      stopPickupTimer();
      hideResultsWrapper();
      resultsPending?.classList.remove('hidden');
      resultsListWrap?.classList.add('hidden');
      resultsEmpty?.classList.add('hidden');
      pickupBox?.classList.add('hidden');
      selectedPharmacy = null;
      window.scrollTo({ top: 0, behavior:'smooth' });
    });

    /* ========== SUBMIT FLOW ========== */
    document.getElementById('submitBtn').addEventListener('click', async (e)=>{
      e.preventDefault();
      const med_name = document.getElementById('medicine-name').value.trim();
      const active_substance = document.getElementById('active-substance').value.trim();
      const barcode = document.getElementById('barcode-value').value.trim();
      const med_type = document.getElementById('medicine-type').value || null;
      const quantity = parseInt(document.getElementById('quantity').value || '1',10);
      const allow_generic = (document.querySelector('input[name="allow-generic"]:checked')?.value==='YES');
      const city = document.getElementById('city').value;

      if(!med_name) return alert(state.lang==='el'?'Συμπλήρωσε το όνομα φαρμάκου':'Enter medicine name');
      if(!city) return alert(state.lang==='el'?'Επίλεξε πόλη':'Select city');
      if(!document.getElementById('gdpr-checkbox').checked) return alert(state.lang==='el'?'Αποδέξου τους όρους':'Accept terms');

      fireConfetti(3500);
      showPending();

      try {
        if(pollInt) { clearInterval(pollInt); pollInt=null; }
        window.currentRequest = null;
        selectedPharmacy = null;
        localStorage.removeItem(LS_PICKUP);
        localStorage.removeItem('pickup-extend-date');

        const fnResult = await submitViaFunctions({ med_name, active_substance, med_type, quantity, allow_generic, city, barcode });
        if(fnResult){
          window.currentRequest = { ...fnResult, mode:'functions', city, created_at: Date.now() };
          localStorage.setItem(LS_REQ, JSON.stringify(window.currentRequest));
          startPolling({ mode:'functions' });
          return;
        }

        if(hasSupabase()){
          const inserted = await createRequest({ med_name, active_substance, med_type, quantity, allow_generic, city, barcode });
          window.currentRequest = { id: inserted.id, created_at: inserted.created_at, mode:'supabase' };
          localStorage.setItem(LS_REQ, JSON.stringify(window.currentRequest));
          startPolling({ mode:'supabase' });
          return;
        }

        setTimeout(()=>{
          hidePending();
          const items = [
            { pharmacy:{ name:'Φαρμακείο Ιάκωβος', address:'Ιπποκράτους 12, Αθήνα', phone:'+30 210 1234567', lat:37.984, lng:23.735 }, is_generic: allow_generic },
            { pharmacy:{ name:'Φαρμακείο Νίκη', address:'Σόλωνος 90, Αθήνα', phone:'+30 210 7654321', lat:37.983, lng:23.732 }, is_generic: false }
          ];
          if(barcode){
            console.info('Submitted barcode:', barcode);
          }
          renderResults(items);
        }, 4500);
      } catch(err){
        console.error(err);
        hidePending();
        alert('Κάτι πήγε στραβά. Έλεγξε τα Supabase keys και τα tables.');
      }
    });

    /* ===================== Web Push (3c) ===================== */
    const pushToast = document.getElementById('push-toast');
    const btnPushAllow = document.getElementById('push-allow');
    const btnPushDeny  = document.getElementById('push-deny');

    statusNotifyBtn?.addEventListener('click', ()=>{
      pushToast?.classList.remove('hidden');
      pushToast?.scrollIntoView({ behavior:'smooth', block:'end' });
    });

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
      return outputArray;
    }

    async function saveSubscriptionToSupabase(sub) {
      if (!hasSupabase()) return;
      // Συμβατότητα: πάρε τα keys από toJSON()
      const raw = (typeof sub.toJSON === 'function') ? sub.toJSON() : {};
      const keys = raw.keys || {};
      const row = {
        endpoint: sub.endpoint,
        p256dh: keys.p256dh || '',
        auth: keys.auth || '',
        user_agent: navigator.userAgent
      };
      // upsert με onConflict:endpoint
      const { error } = await sb().from('push_subscriptions').upsert(row, { onConflict: 'endpoint' });
      if (error) console.warn('save sub error', error);
    }

    async function ensurePushSubscribed(reg) {
      try{
        if (!('Notification' in window) || !('PushManager' in window)) return;
        const publicKey = (window.ENV && window.ENV.VAPID_PUBLIC_KEY) || '';
        if (!publicKey) return;

        if (Notification.permission === 'granted') {
          const existing = await reg.pushManager.getSubscription();
          if (existing) { await saveSubscriptionToSupabase(existing); return; }
          const sub = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(publicKey)
          });
          await saveSubscriptionToSupabase(sub);
          return;
        }
        if (Notification.permission === 'default') {
          pushToast.classList.remove('hidden');
        }
      }catch(err){ console.warn('push subscribe error', err); }
    }

    btnPushAllow?.addEventListener('click', async ()=>{
      pushToast.classList.add('hidden');
      try{
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') return;
        const reg = await navigator.serviceWorker.getRegistration();
        if (!reg) return;
        await ensurePushSubscribed(reg);
      }catch(e){ console.warn(e); }
    });
    btnPushDeny?.addEventListener('click', ()=> pushToast.classList.add('hidden'));

    /* ========== PWA install & SW update flow ========== */
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js').then(async reg => {
        if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        reg.addEventListener('updatefound', () => {
          const nw = reg.installing;
          nw?.addEventListener('statechange', () => {
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              reg.waiting?.postMessage({ type: 'SKIP_WAITING' });
            }
          });
        });
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          window.location.reload();
        });

        // 3c: push subscription
        await ensurePushSubscribed(reg);
      }).catch(console.warn);
    }
    let deferredPrompt=null;
    const installBtn = document.getElementById('cta-install');
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden');
    });
    installBtn.addEventListener('click', async ()=>{
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt=null; installBtn.classList.add('hidden');
    });

    /* ========== Init ========== */
    applyLang();
    try{
      const saved = JSON.parse(localStorage.getItem(LS_REQ) || 'null');
      if(saved?.id){ window.currentRequest = saved; }
    }catch{}
    try{
      const savedAuth = JSON.parse(sessionStorage.getItem(AUTH_STORAGE_KEY) || 'null');
      if(savedAuth?.verified){
        authState.verified = true;
        authState.method = savedAuth.method || null;
        authState.flow = savedAuth.flow || 'login';
      }
    }catch{}
  </script>
</body>
</html>
