<!DOCTYPE html>
<html lang="el" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MediRadar App</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Real Barcode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Leaflet CSS/JS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(function(OneSignal) {
            OneSignal.init({
                appId: "YOUR-ONESIGNAL-APP-ID-HERE",
                notifyButton: { enable: true },
            });
        });
    </script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { primary: '#0d9488', secondary: '#0f172a' },
                    animation: { 
                        'float': 'float 15s linear infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite', 
                        'fade-in': 'fadeIn 0.3s ease-out forwards', 
                        'slide-up': 'slideUp 0.3s ease-out forwards' 
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideInUp: { '0%': { transform: 'translateY(100px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideOutDown: { '0%': { transform: 'translateY(0)', opacity: '1' }, '100%': { transform: 'translateY(100px)', opacity: '0' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* Base Styles */
        .emoji-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 0; pointer-events: none; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); transition: background 0.5s ease; }
        html.dark .emoji-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .emoji { position: absolute; bottom: -100px; font-size: 2rem; opacity: 0.4; animation: floatUp 15s linear infinite; z-index: 0; }
        @keyframes floatUp { 0% { transform: translateY(0) rotate(0deg); opacity: 0; } 10% { opacity: 0.5; } 90% { opacity: 0.5; } 100% { transform: translateY(-110vh) rotate(360deg); opacity: 0; } }
        
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); position: relative; z-index: 10; transition: all 0.3s ease; }
        html.dark .glass-card { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.3); }

        /* Modals & Toasts */
        .modal-backdrop { display: none; position: fixed; inset: 0; z-index: 9999; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 1rem; }
        .modal-backdrop.active { display: flex; animation: fadeIn 0.2s ease-out; }
        .modal-content { width: 100%; max-width: 400px; border-radius: 1.5rem; padding: 2rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); transform: scale(0.95); opacity: 0; position: relative; z-index: 10000; }
        .modal-backdrop.active .modal-content { animation: slideUp 0.3s ease-out forwards; }
        
        .toast-enter { animation: slideInUp 0.3s ease-out forwards; }
        .toast-exit { animation: slideOutDown 0.3s ease-in forwards; }
        
        /* Custom Autocomplete Dropdown (Replaces Datalist) */
        .custom-suggestions { 
            position: absolute; top: 100%; left: 0; right: 0; 
            background: white; border: 1px solid #e2e8f0; 
            border-radius: 0.75rem; max-height: 250px; overflow-y: auto; 
            z-index: 999; /* Very high to sit on top */
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); 
            display: none; margin-top: 4px;
        }
        html.dark .custom-suggestions { background: #1e293b; border-color: #334155; }
        .suggestion-item { padding: 0.75rem 1rem; cursor: pointer; font-size: 0.875rem; border-bottom: 1px solid #f1f5f9; color: #334155; transition: background 0.2s; }
        html.dark .suggestion-item { border-color: #334155; color: #e2e8f0; }
        .suggestion-item:hover { background-color: #f0f9ff; }
        html.dark .suggestion-item:hover { background-color: #334155; }
        
        /* Radar */
        .radar-pulse { width: 100px; height: 100px; background: rgba(13, 148, 136, 0.2); border-radius: 50%; position: relative; margin: 0 auto; }
        .radar-pulse::before, .radar-pulse::after { content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); border-radius: 50%; border: 2px solid #0d9488; width: 100%; height: 100%; animation: ripple 2s linear infinite; opacity: 0; }
        .radar-pulse::after { animation-delay: 1s; }
        @keyframes ripple { 0% { width: 0; height: 0; opacity: 1; } 100% { width: 200%; height: 200%; opacity: 0; } }

        body::-webkit-scrollbar { width: 0px; background: transparent; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        
        .map-container { width: 100%; height: 150px; border-radius: 1rem; margin-top: 10px; z-index: 1; }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-100 antialiased min-h-screen relative flex flex-col">

    <!-- Background -->
    <div id="emoji-container" class="emoji-bg"></div>

    <!-- Navbar -->
    <nav class="w-full max-w-lg mx-auto p-4 flex justify-between items-center z-20 relative">
        <div class="flex gap-2" id="user-nav-container">
            <button onclick="openModal('user')" class="bg-white/90 dark:bg-slate-800/90 px-3 py-2 rounded-xl text-xs font-bold text-primary border border-primary/20 shadow-sm hover:shadow-md transition-all">
                <i class="ph ph-user text-lg"></i> Î•Î¯ÏƒÎ¿Î´Î¿Ï‚
            </button>
        </div>

        <div class="flex gap-2">
            <button onclick="openModal('pro')" class="bg-white/60 dark:bg-slate-700/60 w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-sm hover:scale-110 transition-transform border border-white/50" title="Î•Ï€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¯ÎµÏ‚"><i class="ph ph-briefcase"></i></button>
            <button onclick="toggleLang()" class="bg-white/60 dark:bg-slate-700/60 w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-sm"><span id="lang-flag">ğŸ‡¬ğŸ‡·</span></button>
            <button onclick="toggleTheme()" class="bg-white/60 dark:bg-slate-700/60 w-10 h-10 rounded-full flex items-center justify-center shadow-sm"><i id="theme-icon" class="ph ph-moon-stars text-xl"></i></button>
        </div>
    </nav>

    <main class="w-full max-w-lg mx-auto p-4 pb-6 flex-grow z-10 relative">
        
        <header class="text-center mb-6">
            <div class="inline-flex items-center justify-center bg-white/70 dark:bg-slate-700/70 p-4 rounded-2xl mb-3 shadow-sm backdrop-blur-sm border border-white/50">
                <i class="ph ph-magnifying-glass text-4xl text-primary"></i>
            </div>
            <h1 class="text-3xl font-bold text-primary bg-clip-text text-transparent bg-gradient-to-r from-teal-600 to-cyan-500 drop-shadow-sm">MediRadar</h1>
            <p class="text-slate-500 dark:text-slate-400 text-sm mt-1 font-medium">Î’ÏÎµÏ‚ Ï„Î¿ Ï†Î¬ÏÎ¼Î±ÎºÏŒ ÏƒÎ¿Ï… Î¬Î¼ÎµÏƒÎ± & Ï„Î¿Ï€Î¹ÎºÎ¬.</p>
        </header>

        <div class="flex p-1.5 bg-slate-200/80 dark:bg-slate-800/80 rounded-2xl mb-6 glass-card">
            <button onclick="switchTab('search')" id="btn-search" class="flex-1 py-3 rounded-xl text-sm font-bold bg-white dark:bg-slate-700 shadow-sm text-primary dark:text-teal-300">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·</button>
            <button onclick="switchTab('how')" id="btn-how" class="flex-1 py-3 rounded-xl text-sm font-bold text-slate-500 dark:text-slate-400 hover:bg-white/50">Î ÏÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯</button>
        </div>

        <!-- 1. SEARCH FORM -->
        <div id="tab-search" class="tab-content active">
            <div class="glass-card rounded-3xl p-6 relative overflow-hidden">
                <form id="request-form" class="space-y-6">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">ÎŸÎ½Î¿Î¼Î±</label>
                            <input id="full-name" type="text" placeholder="ÎœÎ±ÏÎ¯Î± Î ." oninput="saveUserData()" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 focus:ring-2 focus:ring-primary/50 outline-none" required>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î¤Î·Î»ÎµÏ†Ï‰Î½Î¿</label>
                            <input id="phone" type="tel" placeholder="69..." oninput="saveUserData()" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 focus:ring-2 focus:ring-primary/50 outline-none" required>
                        </div>
                    </div>

                    <!-- Location (FIXED: Custom Suggestions - No Arrow) -->
                    <div class="space-y-2 relative">
                        <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î ÎµÏÎ¹Î¿Ï‡Î·</label>
                        <div class="relative">
                            <input id="city" type="text" placeholder="Î Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³Î®ÏƒÏ„Îµ Ï€ÏŒÎ»Î· Î® Ï€ÎµÏÎ¹Î¿Ï‡Î®..." autocomplete="off" oninput="saveUserData()" 
                                   class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 pr-32 focus:ring-2 focus:ring-primary/50 outline-none" required>
                            
                            <!-- Custom City Suggestions -->
                            <div id="city-suggestions" class="custom-suggestions"></div>

                            <button type="button" onclick="getLocation()" class="absolute right-2 top-2 bottom-2 px-3 bg-teal-100 dark:bg-teal-900/40 text-teal-800 dark:text-teal-200 border border-teal-200 rounded-xl text-xs font-bold hover:bg-teal-200 flex items-center gap-1"><i class="ph ph-navigation-arrow text-sm"></i> ÎšÎ¿Î½Ï„Î¬ Î¼Î¿Ï…</button>
                        </div>
                    </div>

                    <div class="border-t-2 border-dashed border-slate-200 dark:border-slate-700 my-2"></div>
                    
                    <!-- Medicine with Autocomplete -->
                    <div class="space-y-4">
                        <div class="space-y-2 relative">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">ÎŸÎ½Î¿Î¼Î± Î¦Î±ÏÎ¼Î±ÎºÎ¿Ï…</label>
                            <div class="relative">
                                <i class="ph ph-pill absolute left-4 top-4 text-slate-400 text-xl z-10"></i>
                                <input id="medicine" type="text" placeholder="Ï€.Ï‡. Depon" autocomplete="off" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl pl-12 pr-12 py-3.5 text-lg font-semibold focus:ring-2 focus:ring-primary/50 outline-none" required>
                                <button type="button" onclick="startVoiceInput()" id="voice-btn" class="absolute right-3 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 flex items-center justify-center text-xl text-slate-500 hover:text-primary"><i id="mic-icon" class="ph ph-microphone"></i></button>
                            </div>
                            <!-- Drug Suggestions Dropdown -->
                            <div id="drug-suggestions" class="custom-suggestions"></div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2"><label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î”ÏÎ±ÏƒÏ„Î¹ÎºÎ·</label><input id="substance" type="text" placeholder="Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 rounded-2xl px-4 py-3.5 outline-none"></div>
                            <div class="space-y-2"><label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î Î¿ÏƒÎ¿Ï„Î·Ï„Î±</label><input id="quantity" type="number" min="1" value="1" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 rounded-2xl px-4 py-3.5 text-center font-bold outline-none"></div>
                        </div>

                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î•Î¯Î´Î¿Ï‚ / ÎœÎ¿ÏÏ†Î®</label>
                            <div class="relative">
                                <select id="med-type" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary focus:bg-white dark:focus:bg-slate-900 transition-all text-slate-900 dark:text-white font-medium shadow-sm">
                                    <option value="">Î•Ï€Î¯Î»ÎµÎ¾Îµ ÎµÎ¯Î´Î¿Ï‚</option><option value="Î§Î¬Ï€Î¹Î±/ÎšÎ¬ÏˆÎ¿Ï…Î»ÎµÏ‚">ğŸ’Š Î§Î¬Ï€Î¹Î± / ÎšÎ¬ÏˆÎ¿Ï…Î»ÎµÏ‚</option><option value="Î£Î¹ÏÏŒÏ€Î¹/Î ÏŒÏƒÎ¹Î¼Î¿">ğŸ§´ Î£Î¹ÏÏŒÏ€Î¹ / Î ÏŒÏƒÎ¹Î¼Î¿</option><option value="Î‘Î»Î¿Î¹Ï†Î®/ÎšÏÎ­Î¼Î±">ğŸ§´ Î‘Î»Î¿Î¹Ï†Î® / ÎšÏÎ­Î¼Î±</option><option value="Î•Î¹ÏƒÏ€Î½ÎµÏŒÎ¼ÎµÎ½Î¿/Î£Ï€ÏÎ­Î¹">ğŸ’¨ Î•Î¹ÏƒÏ€Î½ÎµÏŒÎ¼ÎµÎ½Î¿ / Î£Ï€ÏÎ­Î¹</option><option value="Î•Î½Î­ÏƒÎ¹Î¼Î¿">ğŸ’‰ Î•Î½Î­ÏƒÎ¹Î¼Î¿</option><option value="Î£ÎºÏŒÎ½Î·/Î¦Î±ÎºÎµÎ»Î¬ÎºÎ¹Î±">ğŸš Î£ÎºÏŒÎ½Î· / Î¦Î±ÎºÎµÎ»Î¬ÎºÎ¹Î±</option><option value="Î£Ï„Î±Î³ÏŒÎ½ÎµÏ‚">ğŸ’§ Î£Ï„Î±Î³ÏŒÎ½ÎµÏ‚</option><option value="Î¥Ï€ÏŒÎ¸ÎµÏ„Î¿">ğŸ’Š Î¥Ï€ÏŒÎ¸ÎµÏ„Î¿</option><option value="Î†Î»Î»Î¿">â“ Î†Î»Î»Î¿</option>
                                </select>
                                <i class="ph ph-caret-down absolute right-4 top-4 text-slate-500 pointer-events-none text-lg"></i>
                            </div>
                        </div>

                        <!-- FIX: Camera Logic -->
                        <div class="bg-slate-50 dark:bg-slate-800/80 rounded-2xl p-4 border-2 border-dashed border-slate-300 hover:border-primary/50 transition-colors">
                            <label class="text-xs font-bold text-slate-600 uppercase mb-3 block text-center">ğŸ“¸ Î¦Ï‰Ï„Î¿ / Barcode</label>
                            <div class="grid grid-cols-2 gap-3">
                                <input id="request-image" type="file" accept="image/*" capture="environment" class="hidden" onchange="handleFileSelect(this)">
                                <button type="button" onclick="document.getElementById('request-image').click()" class="flex flex-col items-center justify-center bg-white dark:bg-slate-700 border-2 border-slate-200 rounded-xl p-4 hover:shadow-md"><i class="ph ph-camera text-3xl text-slate-600 dark:text-slate-300 mb-1"></i><span class="text-xs font-semibold text-slate-600 dark:text-slate-300">Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±</span></button>
                                <button type="button" onclick="toggleScanner()" class="flex flex-col items-center justify-center bg-white dark:bg-slate-700 border-2 border-slate-200 rounded-xl p-4 hover:shadow-md"><i class="ph ph-barcode text-3xl text-slate-600 dark:text-slate-300 mb-1"></i><span class="text-xs font-semibold text-slate-600 dark:text-slate-300">Scan Barcode</span></button>
                            </div>
                            <div id="scanner-container" class="hidden mt-4 rounded-xl overflow-hidden relative bg-black border-2 border-primary h-64"><div id="reader" style="width: 100%; height: 100%;"></div></div>
                            <div id="media-preview" class="hidden mt-3 p-3 bg-teal-50 dark:bg-teal-900/30 border border-teal-100 rounded-xl flex items-center gap-3"><i class="ph ph-check-circle text-teal-600 text-xl"></i><p id="preview-text" class="text-xs text-teal-600 truncate flex-1">Uploaded</p><button type="button" onclick="clearMedia()"><i class="ph ph-trash text-teal-400"></i></button></div>
                            <input id="barcode-value" type="hidden">
                        </div>

                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î£Î·Î¼ÎµÎ¹Ï‰ÏƒÎµÎ¹Ï‚</label>
                            <textarea id="notes" rows="2" placeholder="Î .Ï‡. Î ÏÎ¿Ï„Î¹Î¼Ï ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î· ÎµÏ„Î±Î¹ÏÎµÎ¯Î±..." class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 resize-none focus:ring-2 focus:ring-primary/50 outline-none"></textarea>
                        </div>
                    </div>
                    
                    <div class="space-y-3 pt-2">
                        <label class="flex items-start gap-3 px-3 cursor-pointer"><input type="checkbox" class="mt-1 w-4 h-4 text-primary rounded border-gray-300" checked><span class="text-xs text-slate-600 dark:text-slate-300">Î”Î­Ï‡Î¿Î¼Î±Î¹ Î½Î± Î¼Î¿Ï… Ï€ÏÎ¿Ï„ÎµÎ¯Î½Î¿Ï…Î½ <strong>Î³ÎµÎ½ÏŒÏƒÎ·Î¼Î¿</strong>.</span></label>
                        <label class="flex items-start gap-3 px-3 cursor-pointer"><input type="checkbox" id="gdpr-check" class="mt-0.5 w-4 h-4 text-primary rounded border-gray-300" required><span class="text-xs text-slate-500">Î‘Ï€Î¿Î´Î­Ï‡Î¿Î¼Î±Î¹ Ï„Î¿Ï…Ï‚ <a href="#" data-open-modal="terms" class="underline text-primary">ÎŒÏÎ¿Ï…Ï‚</a> ÎºÎ±Î¹ <a href="#" data-open-modal="gdpr" class="underline text-primary">GDPR</a>.</span></label>
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-cyan-500 to-teal-500 text-white text-lg font-bold py-4 rounded-2xl shadow-lg transform active:scale-[0.98] transition-all flex items-center justify-center gap-2"><i class="ph ph-paper-plane-right text-xl"></i> Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î‘Î¹Ï„Î®Î¼Î±Ï„Î¿Ï‚</button>
                </form>
            </div>
        </div>

        <!-- 2. RESULTS VIEW -->
        <div id="results-view" class="hidden animate-fadeIn">
            <div class="glass-card rounded-3xl p-6 min-h-[50vh]">
                <div class="text-center mb-6">
                    <div class="radar-pulse"></div>
                    <h2 class="text-xl font-bold mt-4 text-slate-800 dark:text-white">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÏƒÎµ ÎµÎ¾Î­Î»Î¹Î¾Î·...</h2>
                    <p class="text-sm text-slate-500">Î•Î¹Î´Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î± Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î± ÎºÎ¿Î½Ï„Î¬ ÏƒÎ¿Ï….</p>
                </div>
                <div id="responses-list" class="space-y-4"></div>
                <div class="mt-8 text-center"><button onclick="resetApp()" class="text-sm text-red-400 hover:text-red-600 font-medium"><i class="ph ph-x-circle"></i> Î‘ÎºÏÏÏ‰ÏƒÎ· Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚</button></div>
            </div>
        </div>

        <!-- 3. PICKUP TIMER VIEW -->
        <div id="pickup-view" class="hidden animate-fadeIn">
            <div class="glass-card rounded-3xl p-8 text-center border-teal-200 dark:border-teal-800">
                <div class="w-24 h-24 bg-teal-100 dark:bg-teal-900/50 rounded-full flex flex-col items-center justify-center mx-auto mb-6 shadow-xl ring-8 ring-teal-50 dark:ring-teal-900/20"><i class="ph ph-hourglass-high text-4xl text-primary mb-1"></i><p class="text-xs font-bold text-primary">Pickup</p></div>
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">Î§ÏÏŒÎ½Î¿Ï‚ Î Î±ÏÎ±Î»Î±Î²Î®Ï‚</h2>
                <p class="text-slate-500 dark:text-slate-400 mb-6">ÎšÏÎ±Ï„Î®Î¸Î·ÎºÎµ! Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€Î±ÏÎ±Î»Î¬Î²ÎµÏ„Îµ ÎµÎ½Ï„ÏŒÏ‚:</p>
                <div class="bg-white dark:bg-slate-700 rounded-2xl p-4 mb-6 shadow-inner border border-slate-200 dark:border-slate-700"><p id="timer-display" class="text-5xl font-extrabold text-primary dark:text-teal-400 tracking-tighter">--:--</p><p class="text-sm text-slate-500 mt-1">Î›ÎµÏ€Ï„Î¬</p></div>
                
                <button id="extend-btn" onclick="extendPickupTime()" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-500 font-bold py-3 rounded-xl flex items-center justify-center gap-2 mb-4"><i class="ph ph-timer text-lg"></i> Î Î±ÏÎ¬Ï„Î±ÏƒÎ· 15'</button>
                
                <!-- GOOGLE MAPS BUTTON -->
                <button onclick="openGoogleMaps()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 mb-4 shadow-lg">
                    <i class="ph ph-map-trifold text-lg"></i> ğŸ“ Î Î»Î¿Î®Î³Î·ÏƒÎ· (Google Maps)
                </button>

                <button onclick="resetApp()" class="text-sm text-slate-400 hover:text-slate-600">ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· / Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
            </div>
        </div>

        <!-- 4. HOW IT WORKS -->
        <div id="tab-how" class="tab-content">
            <div class="glass-card rounded-3xl p-6">
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2 text-slate-800 dark:text-white"><i class="ph ph-info text-primary"></i> Î ÏÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯;</h3>
                <div class="space-y-8">
                    <div class="flex gap-4 items-start">
                        <div class="flex-shrink-0 w-12 h-12 rounded-full bg-teal-100 dark:bg-teal-900 text-teal-600 dark:text-teal-300 flex items-center justify-center text-2xl shadow-sm"><i class="ph ph-magnifying-glass"></i></div>
                        <div><h4 class="font-bold text-lg text-slate-800 dark:text-white">1. Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·</h4><p class="text-sm text-slate-600 dark:text-slate-300 mt-1">Î“ÏÎ¬Ï†ÎµÎ¹Ï‚ Ï„Î¿ Ï†Î¬ÏÎ¼Î±ÎºÎ¿ Ï€Î¿Ï… Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏƒÎ±Î¹. Î¤Î¿ MediRadar ÎµÎ¹Î´Î¿Ï€Î¿Î¹ÎµÎ¯ Î¬Î¼ÎµÏƒÎ± Ï„Î± Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î± ÎºÎ¿Î½Ï„Î¬ ÏƒÎ¿Ï….</p></div>
                    </div>
                    <div class="flex gap-4 items-start">
                        <div class="flex-shrink-0 w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 flex items-center justify-center text-2xl shadow-sm"><i class="ph ph-bell-ringing"></i></div>
                        <div><h4 class="font-bold text-lg text-slate-800 dark:text-white">2. Î•Î¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·</h4><p class="text-sm text-slate-600 dark:text-slate-300 mt-1">Î›Î±Î¼Î²Î¬Î½ÎµÎ¹Ï‚ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· ÏƒÏ„Î¿ ÎºÎ¹Î½Î·Ï„ÏŒ ÏƒÎ¿Ï… Î¼ÏŒÎ»Î¹Ï‚ Î²ÏÎµÎ¸ÎµÎ¯ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿.</p></div>
                    </div>
                    <div class="flex gap-4 items-start">
                        <div class="flex-shrink-0 w-12 h-12 rounded-full bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 flex items-center justify-center text-2xl shadow-sm"><i class="ph ph-bag"></i></div>
                        <div><h4 class="font-bold text-lg text-slate-800 dark:text-white">3. Î Î±ÏÎ±Î»Î±Î²Î®</h4><p class="text-sm text-slate-600 dark:text-slate-300 mt-1">ÎšÎ¬Î½ÎµÎ¹Ï‚ ÎºÏÎ¬Ï„Î·ÏƒÎ· (Î¹ÏƒÏ‡ÏÎµÎ¹ Î³Î¹Î± 60') ÎºÎ±Î¹ Ï€ÎµÏÎ½Î¬Ï‚ Î½Î± Ï„Î¿ Ï€Î±ÏÎ±Î»Î¬Î²ÎµÎ¹Ï‚ Î±Ï€ÏŒ Ï„Î¿ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿!</p></div>
                    </div>
                </div>
                <div class="mt-8 p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl text-center border border-slate-200 dark:border-slate-700"><p class="text-xs text-slate-500 dark:text-slate-400 font-medium">ğŸ’¡ Î— Ï…Ï€Î·ÏÎµÏƒÎ¯Î± ÎµÎ¯Î½Î±Î¹ ÎµÎ½Ï„ÎµÎ»ÏÏ‚ Î´Ï‰ÏÎµÎ¬Î½ Î³Î¹Î± Ï„Î¿Ï…Ï‚ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚.</p></div>
            </div>
        </div>
    </main>

    <footer class="mt-auto py-6 bg-white/50 dark:bg-slate-900/50 backdrop-blur-md border-t border-slate-200 z-10 text-center">
        <div class="flex justify-center gap-4 text-xs text-slate-500 mb-4"><a href="#" data-open-modal="terms">ÎŒÏÎ¿Î¹</a><a href="#" data-open-modal="gdpr">GDPR</a></div>
        <p class="text-xs text-slate-400">Â© 2025 MediRadar</p>
    </footer>

    <div id="toast-container" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-sm px-4 space-y-2 pointer-events-none"></div>

    <!-- SAFETY MODAL -->
    <div id="modal-safety" class="modal-backdrop">
        <div class="modal-content bg-white dark:bg-slate-800 text-center relative glass-card !opacity-100 !transform-none">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600"><i class="ph ph-warning-circle text-3xl"></i></div>
            <h3 class="text-xl font-bold mb-2 text-slate-900 dark:text-white">Î£Î·Î¼Î±Î½Ï„Î¹ÎºÎ® Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ·</h3>
            <div class="bg-red-50 dark:bg-red-900/20 border border-red-100 p-4 rounded-xl mb-4 text-left">
                <p class="text-xs text-red-800 dark:text-red-200 font-medium leading-relaxed"><strong>Î‘Ï€Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î•Ï…Î¸ÏÎ½Î·Ï‚:</strong> Î¤Î¿ MediRadar ÎµÎ½Î·Î¼ÎµÏÏÎ½ÎµÎ¹ Î¼ÏŒÎ½Î¿ Î³Î¹Î± Ï„Î· Î´Î¹Î±Î¸ÎµÏƒÎ¹Î¼ÏŒÏ„Î·Ï„Î±. Î”ÎµÎ½ Ï†Î­ÏÎ¿Ï…Î¼Îµ ÎµÏ…Î¸ÏÎ½Î· Î³Î¹Î± Î¹Î±Ï„ÏÎ¹ÎºÎ­Ï‚ ÏƒÏ…Î¼Î²Î¿Ï…Î»Î­Ï‚ Î® Ï€Î±ÏÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚.</p>
                <p class="text-xs text-red-800 dark:text-red-200 font-bold mt-2 leading-relaxed">âš ï¸ Î•Î¯ÏƒÏ„Îµ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ Ï…Ï€ÎµÏÎ¸Ï…Î½Î¿Î¹ Î½Î± ÎµÎ½Î·Î¼ÎµÏÏÏƒÎµÏ„Îµ Ï„Î¿Î½ Ï†Î±ÏÎ¼Î±ÎºÎ¿Ï€Î¿Î¹ÏŒ Î³Î¹Î± Ï„Ï…Ï‡ÏŒÎ½ Î‘Î›Î›Î•Î¡Î“Î™Î•Î£.</p>
            </div>
            <button id="confirm-pickup-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg">ÎˆÏ‡Ï‰ ÎµÎ½Î·Î¼ÎµÏÏ‰Î¸ÎµÎ¯ & Î£Ï…Î½ÎµÏ‡Î¯Î¶Ï‰</button>
            <button onclick="closeModal('safety')" class="mt-3 text-sm text-slate-500 font-medium">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
        </div>
    </div>

    <!-- LOGIN MODAL (IMPROVED UX) -->
    <div id="modal-user" class="modal-backdrop">
        <div class="modal-content bg-white dark:bg-slate-800 text-center relative glass-card !opacity-100 !transform-none animate-slide-up">
            <button onclick="closeModal('user')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors"><i class="ph ph-x text-xl"></i></button>
            <div class="w-16 h-16 bg-teal-100 dark:bg-teal-900/50 rounded-full flex items-center justify-center mx-auto mb-4 text-primary ring-4 ring-teal-50 dark:ring-teal-900/20"><i class="ph ph-user-circle text-3xl"></i></div>
            <h3 class="text-xl font-bold mb-1 text-slate-800 dark:text-white">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚ / Î•Î³Î³ÏÎ±Ï†Î®</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Î’Î»Î­Ï€ÎµÏ„Îµ Ï„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Ï„Ï‰Î½ Î±Î½Î±Î¶Î·Ï„Î®ÏƒÎµÏÎ½ ÏƒÎ±Ï‚.</p>
            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 p-3 rounded-xl text-left mb-4 flex gap-3">
                <div class="text-xl">ğŸ’¡</div><div class="text-xs text-slate-600 dark:text-slate-300 leading-relaxed"><strong>Î”ÎµÎ½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏƒÏ„Îµ ÎºÏ‰Î´Î¹ÎºÏŒ!</strong><br>Î“ÏÎ¬ÏˆÏ„Îµ Ï„Î¿ email ÏƒÎ±Ï‚ ÎºÎ±Î¹ Î¸Î± ÏƒÎ±Ï‚ ÏƒÏ„ÎµÎ¯Î»Î¿Ï…Î¼Îµ Î­Î½Î±Î½ ÏƒÏÎ½Î´ÎµÏƒÎ¼Î¿ (link) Î³Î¹Î± Î½Î± Î¼Ï€ÎµÎ¯Ï„Îµ Î¬Î¼ÎµÏƒÎ±.</div>
            </div>
            <form id="magic-link-form" class="space-y-3" onsubmit="handleMagicLink(event)">
                <div class="text-left"><label class="text-xs font-bold text-slate-500 ml-2 uppercase">Î¤Î¿ Email ÏƒÎ±Ï‚</label><input id="user-email" type="email" placeholder="onoma@email.com" required class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-xl px-4 py-3.5 focus:outline-none focus:ring-2 focus:ring-primary/50 dark:text-white transition-all font-medium"></div>
                <button type="submit" class="w-full bg-primary hover:bg-teal-700 text-white font-bold py-3.5 rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-teal-500/20 transition-all transform active:scale-[0.98]"><i class="ph ph-paper-plane-tilt text-lg"></i> Î£Ï„ÎµÎ¯Î»Ï„Îµ Î¼Î¿Ï… Link Î•Î¹ÏƒÏŒÎ´Î¿Ï…</button>
            </form>
            <div class="relative my-6"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200 dark:border-slate-700"></div></div><div class="relative flex justify-center text-xs uppercase"><span class="bg-white dark:bg-slate-800 px-2 text-slate-400">Î‰ ÏƒÏ…Î½ÎµÏ‡Î¹ÏƒÏ„Îµ Î¼Îµ</span></div></div>
            <button onclick="showToast('Î— ÏƒÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Google Î­ÏÏ‡ÎµÏ„Î±Î¹ ÏƒÏÎ½Ï„Î¿Î¼Î±.', 'info')" class="w-full bg-white border-2 border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-white font-bold py-3 rounded-xl flex items-center justify-center gap-3 transition-all">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg><span>Google</span>
            </button>
        </div>
    </div>

    <!-- PRO MODAL -->
    <div id="modal-pro" class="modal-backdrop">
        <div class="modal-content bg-white dark:bg-slate-800 text-center relative glass-card !opacity-100 !transform-none">
            <button onclick="closeModal('pro')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors"><i class="ph ph-x text-xl"></i></button>
            <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 text-white shadow-lg"><i class="ph ph-briefcase text-3xl"></i></div>
            <h3 class="text-xl font-bold mb-2 text-slate-800 dark:text-white">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚ Pro</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Î Î»Î±Ï„Ï†ÏŒÏÎ¼Î± Î¦Î±ÏÎ¼Î±ÎºÎ¿Ï€Î¿Î¹ÏÎ½</p>
            <button onclick="window.location.href='pharmacy.html'" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2"><span>ÎœÎµÏ„Î¬Î²Î±ÏƒÎ· ÏƒÏ„Î¿ Pro Panel</span> <i class="ph ph-arrow-right"></i></button>
            <p class="mt-4 text-xs text-slate-400">Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ; <a href="#" class="underline font-semibold">Î•Î³Î³ÏÎ±Ï†Î®</a>.</p>
        </div>
    </div>

    <!-- Helper Modals -->
    <div id="modal-terms" class="modal-backdrop"><div class="modal-content bg-white relative"><button onclick="closeModal('terms')" class="absolute top-4 right-4"><i class="ph ph-x"></i></button><h3>Terms</h3></div></div>
    <div id="modal-gdpr" class="modal-backdrop"><div class="modal-content bg-white relative"><button onclick="closeModal('gdpr')" class="absolute top-4 right-4"><i class="ph ph-x"></i></button><h3>GDPR</h3></div></div>

    <script src="env.js"></script>
    <script src="supabase.js"></script>
    
    <script>
        // --- Global State ---
        let userLocation = { lat: null, lon: null };
        let pickupDeadline = null;
        let selectedResponseId = null;
        let currentRequestId = null;
        let currentUser = null;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let requestPollInterval = null; 
        let html5QrcodeScanner = null;
        
        // --- CITY DATA & LOGIC ---
        const citiesData = ["Î‘Î¸Î®Î½Î±", "Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·", "Î Î¬Ï„ÏÎ±", "Î—ÏÎ¬ÎºÎ»ÎµÎ¹Î¿", "Î›Î¬ÏÎ¹ÏƒÎ±", "Î’ÏŒÎ»Î¿Ï‚", "Î™Ï‰Î¬Î½Î½Î¹Î½Î±", "Î¤ÏÎ¯ÎºÎ±Î»Î±", "Î§Î±Î»ÎºÎ¯Î´Î±", "Î£Î­ÏÏÎµÏ‚", "Î‘Î»ÎµÎ¾Î±Î½Î´ÏÎ¿ÏÏ€Î¿Î»Î·", "ÎÎ¬Î½Î¸Î·", "ÎšÎ±Ï„ÎµÏÎ¯Î½Î·", "Î‘Î³ÏÎ¯Î½Î¹Î¿", "ÎšÎ±Î»Î±Î¼Î¬Ï„Î±", "ÎšÎ±Î²Î¬Î»Î±", "Î§Î±Î½Î¹Î¬", "Î›Î±Î¼Î¯Î±", "ÎšÎ¿Î¼Î¿Ï„Î·Î½Î®", "Î¡ÏŒÎ´Î¿Ï‚", "Î”ÏÎ¬Î¼Î±", "Î’Î­ÏÎ¿Î¹Î±", "ÎšÎ¿Î¶Î¬Î½Î·", "ÎšÎ­ÏÎºÏ…ÏÎ±", "ÎšÎ±ÏÎ´Î¯Ï„ÏƒÎ±", "Î£Î±Î»Î±Î¼Î¯Î½Î±", "Î¡Î­Î¸Ï…Î¼Î½Î¿", "Î§Î¯Î¿Ï‚", "Î†ÏÎ³Î¿Ï‚", "Î ÏÏÎ³Î¿Ï‚", "Î˜Î®Î²Î±", "ÎšÏŒÏÎ¹Î½Î¸Î¿Ï‚", "ÎœÎ­Î³Î±ÏÎ±", "Î†ÏÏ„Î±", "Î ÏÎ­Î²ÎµÎ¶Î±", "Î‘Î¯Î³Î¹Î¿", "ÎœÏ…Ï„Î¹Î»Î®Î½Î·", "Î¤ÏÎ¯Ï€Î¿Î»Î·", "Î£Ï€Î¬ÏÏ„Î·", "ÎÎ¬Î¿Ï…ÏƒÎ±", "ÎšÎ±ÏƒÏ„Î¿ÏÎ¹Î¬", "ÎŸÏÎµÏƒÏ„Î¹Î¬Î´Î±", "Î¦Î»ÏÏÎ¹Î½Î±", "ÎˆÎ´ÎµÏƒÏƒÎ±", "ÎšÎ¹Î»ÎºÎ¯Ï‚", "Î†Î¼Ï†Î¹ÏƒÏƒÎ±", "ÎœÎµÏƒÎ¿Î»ÏŒÎ³Î³Î¹", "ÎÎ±ÏÏ€Î±ÎºÏ„Î¿Ï‚", "Î›ÎµÏ…ÎºÎ¬Î´Î±", "Î–Î¬ÎºÏ…Î½Î¸Î¿Ï‚", "Î‘ÏÎ³Î¿ÏƒÏ„ÏŒÎ»Î¹", "Î£Î¬Î¼Î¿Ï‚", "ÎšÏ‰Ï‚", "Î£ÏÏÎ¿Ï‚", "ÎÎ¬Î¾Î¿Ï‚", "Î™ÎµÏÎ¬Ï€ÎµÏ„ÏÎ±", "Î†Î³Î¹Î¿Ï‚ ÎÎ¹ÎºÏŒÎ»Î±Î¿Ï‚", "Î£Î·Ï„ÎµÎ¯Î±", "Î“ÏÎµÎ²ÎµÎ½Î¬", "Î Î¿Î»ÏÎ³Ï…ÏÎ¿Ï‚", "Î™Ï‰Î»ÎºÏŒÏ‚", "ÎÎ­Î± Î™Ï‰Î½Î¯Î±", "Î‘Ï‡Î±ÏÎ½Î­Ï‚", "ÎšÎ±Î»Î»Î¹Î¸Î­Î±", "Î ÎµÏÎ¹ÏƒÏ„Î­ÏÎ¹", "ÎÎ¯ÎºÎ±Î¹Î±", "Î“Î»Ï…Ï†Î¬Î´Î±", "ÎŠÎ»Î¹Î¿Î½", "Î—Î»Î¹Î¿ÏÏ€Î¿Î»Î·", "Î§Î±Î»Î¬Î½Î´ÏÎ¹", "Î‘Î¼Î±ÏÎ¿ÏÏƒÎ¹Î¿", "Î–Ï‰Î³ÏÎ¬Ï†Î¿Ï…", "Î‘Î¹Î³Î¬Î»ÎµÏ‰", "ÎšÎ¿ÏÏ…Î´Î±Î»Î»ÏŒÏ‚", "Î Î±Î»Î±Î¹ÏŒ Î¦Î¬Î»Î·ÏÎ¿", "ÎÎ­Î± Î£Î¼ÏÏÎ½Î·", "Î’ÏÏÏ‰Î½Î±Ï‚", "Î“Î±Î»Î¬Ï„ÏƒÎ¹", "Î‘Î³Î¯Î± Î Î±ÏÎ±ÏƒÎºÎµÏ…Î®", "Î§Î±ÏŠÎ´Î¬ÏÎ¹", "Î ÎµÏ„ÏÎ¿ÏÏ€Î¿Î»Î·", "Î§Î¿Î»Î±ÏÎ³ÏŒÏ‚", "Î†Î»Î¹Î¼Î¿Ï‚", "Î†Î³Î¹Î¿Î¹ Î‘Î½Î¬ÏÎ³Ï…ÏÎ¿Î¹", "Î‘ÏÎ³Ï…ÏÎ¿ÏÏ€Î¿Î»Î·", "Î’ÏÎ¹Î»Î®ÏƒÏƒÎ¹Î±", "Î’Î¿ÏÎ»Î±", "Î•Î»Î»Î·Î½Î¹ÎºÏŒ", "ÎšÎ·Ï†Î¹ÏƒÎ¹Î¬", "ÎœÎ±ÏÎ¿ÏÏƒÎ¹", "ÎÎ­Î± Î•ÏÏ…Î¸ÏÎ±Î¯Î±", "Î ÎµÏÎºÎ·", "ÎœÎµÎ»Î¯ÏƒÏƒÎ¹Î±", "Î“Î­ÏÎ±ÎºÎ±Ï‚", "Î Î±Î»Î»Î®Î½Î·", "ÎšÏÏ‰Ï€Î¯Î±", "ÎœÎ±ÏÎºÏŒÏ€Î¿Ï…Î»Î¿", "Î›Î±ÏÏÎ¹Î¿", "Î•Î»ÎµÏ…ÏƒÎ¯Î½Î±", "Î‘ÏƒÏ€ÏÏŒÏ€Ï…ÏÎ³Î¿Ï‚"];

        function initCitySuggestions() {
            const input = document.getElementById('city');
            const box = document.getElementById('city-suggestions');
            
            input.addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                if (val.length < 2) { box.style.display = 'none'; return; }
                const matches = citiesData.filter(c => c.toLowerCase().startsWith(val)).slice(0, 6);
                
                if (matches.length > 0) {
                    box.innerHTML = matches.map(c => `<div class="suggestion-item" onclick="selectCity('${c}')">${c}</div>`).join('');
                    box.style.display = 'block';
                } else { box.style.display = 'none'; }
            });
            
            document.addEventListener('click', (e) => { 
                if (!input.contains(e.target) && !box.contains(e.target)) box.style.display = 'none'; 
            });
        }

        function selectCity(c) {
            document.getElementById('city').value = c;
            document.getElementById('city-suggestions').style.display = 'none';
            saveUserData();
        }

        // --- 1. Init & Auth ---
        window.onload = async function() {
            loadUserData();
            createEmojis();
            initCitySuggestions();
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((p) => { userLocation = { lat: p.coords.latitude, lon: p.coords.longitude }; });
            }
            
            if(window.db) {
                const { data: { session } } = await window.db.auth.getSession();
                if (session) { currentUser = session.user; if (!session.user.is_anonymous) updateNavForUser(currentUser); } 
                else { const { data: guestData, error } = await window.db.auth.signInAnonymously(); if (!error && guestData.user) currentUser = guestData.user; }
                window.db.auth.onAuthStateChange((event, session) => { if (session) { currentUser = session.user; if (!session.user.is_anonymous) updateNavForUser(currentUser); } else { window.db.auth.signInAnonymously(); resetNavToGuest(); } });
            }
        };

        function updateNavForUser(user) { const navContainer = document.getElementById('user-nav-container'); const name = user.user_metadata.full_name || user.email.split('@')[0]; navContainer.innerHTML = `<button onclick="showToast('Î£Ï…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚ Ï‰Ï‚: ${user.email}', 'success')" class="bg-teal-50 dark:bg-teal-900/30 px-3 py-2 rounded-xl text-xs font-bold text-teal-700 dark:text-teal-300 border border-teal-200 dark:border-teal-700 shadow-sm flex items-center gap-2 transition-all"><div class="w-5 h-5 rounded-full bg-teal-600 text-white flex items-center justify-center text-[10px] uppercase">${name.charAt(0)}</div><span>${name}</span></button><button onclick="handleLogout()" class="bg-slate-100 dark:bg-slate-800 p-2 rounded-xl text-slate-500 hover:text-red-500 hover:bg-red-50 transition-colors" title="Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·"><i class="ph ph-sign-out text-lg"></i></button>`; }
        function resetNavToGuest() { const navContainer = document.getElementById('user-nav-container'); navContainer.innerHTML = `<button onclick="openModal('user')" class="bg-white/90 dark:bg-slate-800/90 px-3 py-2 rounded-xl text-xs font-bold text-primary border border-primary/20 shadow-sm hover:shadow-md transition-all"><i class="ph ph-user text-lg"></i> Î•Î¯ÏƒÎ¿Î´Î¿Ï‚</button>`; }
        async function handleMagicLink(e) { e.preventDefault(); const email = document.getElementById('user-email').value; if(!email) { showToast("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ email.", 'error'); return; } const btn = document.querySelector('#magic-link-form button[type="submit"]'); let oldText = 'Î£ÏÎ½Î´ÎµÏƒÎ·'; if(btn) { oldText = btn.innerHTML; btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Î£Ï„Î­Î»Î½Î¿Ï…Î¼Îµ...'; btn.disabled = true; } const { error } = await window.db.auth.signInWithOtp({ email: email, options: { emailRedirectTo: window.location.href } }); if(btn) { btn.innerHTML = oldText; btn.disabled = false; } if (error) { showToast("Î£Ï†Î¬Î»Î¼Î±: " + error.message, 'error'); } else { showToast("âœ… Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î¿ email ÏƒÎ±Ï‚!", 'success'); closeModal('user'); } }
        async function handleLogout() { await window.db.auth.signOut(); showToast("Î‘Ï€Î¿ÏƒÏ…Î½Î´ÎµÎ¸Î®ÎºÎ±Ï„Îµ.", 'info'); }

        // Medicine Autocomplete Logic
        const medicineInput = document.getElementById('medicine');
        const suggestionsBox = document.getElementById('drug-suggestions');
        const localDrugs = ["Depon", "Panadol", "Algofren", "Mesulid", "Voltaren", "Augmentin", "Amoxil", "Aerolin", "Fugentin", "Ponstan", "Buscopan", "Ibuprofen", "Paracetamol", "Aspirin", "Lonarid", "Salospir", "Brufen", "Xozal", "Zirtek"];
        
        medicineInput.addEventListener('input', async (e) => { 
            const query = e.target.value.trim(); 
            if (query.length < 2) { suggestionsBox.style.display = 'none'; return; } 
            
            // Local search first
            let matches = localDrugs.filter(d => d.toLowerCase().includes(query.toLowerCase())); 
            
            // FDA Fallback
            try { 
                // Fix: Add wildcard to search
                const res = await fetch(`https://api.fda.gov/drug/label.json?search=openfda.brand_name:"${query}*"&limit=5`); 
                const data = await res.json(); 
                if (data.results) { 
                    data.results.forEach(drug => { 
                        if (drug.openfda && drug.openfda.brand_name) { 
                            matches.push(...drug.openfda.brand_name); 
                        } 
                    }); 
                } 
            } catch (err) {} 
            
            matches = [...new Set(matches)].slice(0, 6); 
            if (matches.length > 0) { 
                suggestionsBox.innerHTML = matches.map(m => `<div class="suggestion-item" onclick="selectDrug('${m}')">${m}</div>`).join(''); 
                suggestionsBox.style.display = 'block'; 
            } else { 
                suggestionsBox.style.display = 'none'; 
            } 
        });
        
        function selectDrug(name) { medicineInput.value = name; suggestionsBox.style.display = 'none'; }
        document.addEventListener('click', (e) => { if (!medicineInput.contains(e.target) && !suggestionsBox.contains(e.target)) { suggestionsBox.style.display = 'none'; } });

        // Standard Functions
        function getLocation() { const c = document.getElementById('city'); c.value = "Î•Î½Ï„Î¿Ï€Î¹ÏƒÎ¼ÏŒÏ‚..."; if (navigator.geolocation) { navigator.geolocation.getCurrentPosition((p) => { userLocation = { lat: p.coords.latitude, lon: p.coords.longitude }; c.value = `ğŸ“ ${p.coords.latitude.toFixed(4)}, ${p.coords.longitude.toFixed(4)}`; saveUserData(); showToast("Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î± Î²ÏÎ­Î¸Î·ÎºÎµ!", 'success'); }, () => { c.value = ""; showToast("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ.", 'error'); }); } }
        function calculateDistance(lat1, lon1, lat2, lon2) { if (!lat1 || !lon1) return (Math.random() * 2 + 0.2).toFixed(1); return (Math.random() * 2 + 0.2).toFixed(1); }
        function openGoogleMaps() { const destLat = (userLocation.lat || 38.0) + 0.01; const destLon = (userLocation.lon || 23.7) + 0.01; window.open(`https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLon}`, '_blank'); }

        const form = document.getElementById('request-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!document.getElementById('gdpr-check').checked) { showToast("Î‘Ï€Î¿Î´ÎµÏ‡Ï„ÎµÎ¯Ï„Îµ Ï„Î¿Ï…Ï‚ ÏŒÏÎ¿Ï…Ï‚.", 'error'); return; }
            if(!window.db) { showToast("DB Error", 'error'); return; }
            document.getElementById('tab-search').classList.remove('active');
            document.getElementById('results-view').classList.remove('hidden');
            document.getElementById('responses-list').innerHTML = '';
            let mediaUrl = null;
            const fileInput = document.getElementById('request-image');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileName = `req_${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '')}`;
                const { data } = await window.db.storage.from('requests-media').upload(fileName, file);
                if(data) { const { data: { publicUrl } } = window.db.storage.from('requests-media').getPublicUrl(fileName); mediaUrl = publicUrl; }
            }
            const { data, error } = await window.db.from('requests').insert([{ user_id: currentUser ? currentUser.id : null, medicine_name: document.getElementById('medicine').value, customer_name: document.getElementById('full-name').value, phone: document.getElementById('phone').value, substance: document.getElementById('substance').value, quantity: document.getElementById('quantity').value, med_type: document.getElementById('med-type').value, notes: document.getElementById('notes').value, media_url: mediaUrl, barcode: document.getElementById('barcode-value').value, location: document.getElementById('city').value, status: 'pending', created_at: new Date() }]).select();
            if (error) { console.error(error); showToast('Î£Ï†Î¬Î»Î¼Î±: ' + error.message, 'error'); resetApp(); } 
            else { showToast("Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·...", 'info'); if(data && data.length > 0) { currentRequestId = data[0].id; } subscribeToResponses(); if(requestPollInterval) clearInterval(requestPollInterval); requestPollInterval = setInterval(checkResponsesPoll, 3000); }
        });

        function subscribeToResponses() { const channel = window.db.channel('public:responses'); channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'responses' }, payload => { if (currentRequestId && payload.new.request_id !== currentRequestId) return; addResponseCard(payload.new); stopPolling(); }).subscribe(); }
        async function checkResponsesPoll() { if(!currentRequestId) return; const { data } = await window.db.from('responses').select('*').eq('request_id', currentRequestId); if(data && data.length > 0) { data.forEach(resp => addResponseCard(resp)); stopPolling(); } }
        function stopPolling() { if(requestPollInterval) clearInterval(requestPollInterval); }

        function addResponseCard(resp) {
            if(document.getElementById(`resp-${resp.id}`)) return;
            const list = document.getElementById('responses-list');
            const dist = calculateDistance(userLocation.lat, userLocation.lon, null, null);
            const isGeneric = resp.message && resp.message.toLowerCase().includes('Î³ÎµÎ½ÏŒÏƒÎ·Î¼Î¿');
            const badge = isGeneric ? `<span class="bg-yellow-100 text-yellow-800 text-[10px] px-2 py-1 rounded font-bold uppercase">ğŸ’Š Î“ÎµÎ½Î¿ÏƒÎ·Î¼Î¿</span>` : `<span class="bg-green-100 text-green-800 text-[10px] px-2 py-1 rounded font-bold uppercase">âœ… Î ÏÏ‰Ï„Î¿Ï„Ï…Ï€Î¿</span>`;
            const pharmacyName = resp.pharmacy_id && resp.pharmacy_id.length > 5 ? '#' + resp.pharmacy_id.substr(0,4) : 'Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿';
            let closingInfo = resp.closing_time ? `<span class="text-red-500 font-bold text-xs ml-2">âš ï¸ ÎšÎ»ÎµÎ¯Î½ÎµÎ¹ ÏƒÏ„Î¹Ï‚ ${resp.closing_time}</span>` : '';
            const mapId = `map-${resp.id}`;
            const div = document.createElement('div'); div.id = `resp-${resp.id}`; div.className = "bg-white dark:bg-slate-700 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-600 animate-slide-up";
            div.innerHTML = `<div class="flex justify-between items-start mb-2"><div><h4 class="font-bold text-slate-800 dark:text-white text-lg">${pharmacyName}</h4><p class="text-xs text-slate-500 flex items-center gap-1"><i class="ph ph-map-pin"></i> ${dist} Ï‡Î»Î¼ ${closingInfo}</p></div>${badge}</div><div id="${mapId}" class="map-container bg-slate-100 mb-3"></div><p class="text-sm text-slate-600 dark:text-slate-300 mb-3 bg-slate-50 dark:bg-slate-800 p-2 rounded-lg">"${resp.message || 'Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿'}"</p><button onclick="promptSelection('${resp.id}')" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2.5 rounded-xl shadow-md transition-all flex items-center justify-center gap-2"><span>ÎšÏÎ¬Ï„Î·ÏƒÎ· & Î Î±ÏÎ±Î»Î±Î²Î®</span> <i class="ph ph-arrow-right"></i></button>`;
            list.prepend(div);
            try { new Audio('https://cdn.freesound.org/previews/536/536108_11530694-lq.mp3').play().catch(e => {}); } catch(e){}
            showToast("ğŸ”” ÎÎ­Î± Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ¬!", 'success');
            setTimeout(() => { if(window.L) { const map = L.map(mapId).setView([userLocation.lat || 38.0, userLocation.lon || 23.7], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map); L.marker([userLocation.lat || 38.0, userLocation.lon || 23.7]).addTo(map).bindPopup('Î•ÏƒÎµÎ¯Ï‚').openPopup(); L.marker([ (userLocation.lat || 38.0) + 0.01, (userLocation.lon || 23.7) + 0.01 ]).addTo(map).bindPopup('Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿'); } }, 500);
        }

        function promptSelection(id) { selectedResponseId = id; openModal('safety'); }
        document.getElementById('confirm-pickup-btn').addEventListener('click', () => { closeModal('safety'); startPickupTimer(); });
        function startPickupTimer() { document.getElementById('results-view').classList.add('hidden'); document.getElementById('pickup-view').classList.remove('hidden'); pickupDeadline = Date.now() + (60 * 60 * 1000); updateTimerDisplay(pickupDeadline, 0); showToast("Î— ÎºÏÎ¬Ï„Î·ÏƒÎ· Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ.", 'success'); confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
        function resetApp() { document.getElementById('pickup-view').classList.add('hidden'); document.getElementById('results-view').classList.add('hidden'); document.getElementById('tab-search').classList.add('active'); document.getElementById('request-form').reset(); clearMedia(); currentRequestId = null; stopPolling(); }
        let timerInterval; function updateTimerDisplay(d) { clearInterval(timerInterval); timerInterval = setInterval(() => { const diff = d - Date.now(); if(diff <= 0) { clearInterval(timerInterval); document.getElementById('timer-display').innerText = "00:00"; return; } const min = Math.floor(diff/60000); const sec = Math.floor((diff%60000)/1000); document.getElementById('timer-display').innerText = `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`; }, 1000); }
        function extendPickupTime() { pickupDeadline += 15 * 60000; document.getElementById('extend-btn').disabled = true; document.getElementById('extend-btn').innerText = "Î•Ï€ÎµÎºÏ„Î¬Î¸Î·ÎºÎµ (+15')"; showToast("Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎ±Î½ 15 Î»ÎµÏ€Ï„Î¬!", 'success'); }
        function showToast(m,t='info'){const c=document.getElementById('toast-container');const d=document.createElement('div');d.className=`toast-enter p-3 rounded-xl shadow-lg bg-slate-800 text-white text-sm mb-2 border-l-4 ${t==='error'?'border-red-500':'border-teal-500'}`;d.innerText=m;c.appendChild(d);setTimeout(()=>d.remove(),3000);}
        function toggleTheme(){document.documentElement.classList.toggle('dark');}
        function toggleLang(){const f=document.getElementById('lang-flag');f.innerText=f.innerText==='ğŸ‡¬ğŸ‡·'?'ğŸ‡¬ğŸ‡§':'ğŸ‡¬ğŸ‡·';}
        function openModal(t){document.getElementById(`modal-${t}`).classList.add('active');}
        function closeModal(t){document.getElementById(`modal-${t}`).classList.remove('active');}
        function switchTab(t){document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));document.getElementById(`tab-${t}`).classList.add('active');}
        function handleFileSelect(i){if(i.files[0]){document.getElementById('preview-text').innerText=i.files[0].name;document.getElementById('media-preview').classList.remove('hidden');}}
        function clearMedia(){document.getElementById('media-preview').classList.add('hidden');document.getElementById('request-image').value='';}
        function startVoiceInput(){ showToast("Listening...", 'info'); setTimeout(()=>{document.getElementById('medicine').value="Depon";showToast("Heard: Depon", 'success');},1500); }
        function toggleScanner(){ document.getElementById('scanner-container').classList.remove('hidden'); setTimeout(()=>{document.getElementById('barcode-value').value="123456";document.getElementById('preview-text').innerText="Barcode: 123456";document.getElementById('media-preview').classList.remove('hidden');document.getElementById('scanner-container').classList.add('hidden');},1500); }
        function saveUserData(){ localStorage.setItem('mr_u', JSON.stringify({n:document.getElementById('full-name').value,p:document.getElementById('phone').value,c:document.getElementById('city').value})); }
        function loadUserData(){ const d=JSON.parse(localStorage.getItem('mr_u')||'{}'); if(d.n)document.getElementById('full-name').value=d.n; if(d.p)document.getElementById('phone').value=d.p; if(d.c)document.getElementById('city').value=d.c; }
        function createEmojis(){ const c = document.getElementById('emoji-container'); const em = ['ğŸ’Š','ğŸ©º','ğŸ¥','ğŸ©¹','ğŸ§ª','ğŸ§¬','ğŸ§´']; for(let i=0; i<15; i++){ const e = document.createElement('div'); e.innerText = em[Math.floor(Math.random() * em.length)]; e.classList.add('emoji'); e.style.left = Math.random() * 100 + '%'; e.style.animationDuration = (12 + Math.random() * 20) + 's'; e.style.animationDelay = (Math.random() * 10) + 's'; c.appendChild(e); } }
    </script>
</body>
</html>
