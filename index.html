<!DOCTYPE html>
<html lang="el" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MediRadar</title>

  <!-- Favicon (inline για να μην έχεις 404) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect rx='14' width='64' height='64' fill='%2329a3a3'/%3E%3Cpath d='M30 8h4v7a15 15 0 0 1 15 15h7v4h-7a15 15 0 0 1-15 15v7h-4v-7a15 15 0 0 1-15-15h-7v-4h7a15 15 0 0 1 15-15z' fill='white'/%3E%3Ccircle cx='32' cy='30' r='8' fill='white'/%3E%3C/svg%3E">

  <!-- Android/Chrome PWA -->
  <meta name="mobile-web-app-capable" content="yes">
  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <!-- Tailwind (dev με CDN). Για production build θα το αλλάξουμε σε PostCSS/CLI. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: { brand: { 500:'#29a3a3', 600:'#208181', 700:'#196464' } },
          boxShadow: { soft:'0 16px 40px rgba(2,6,23,.12)' }
        }
      }
    }
  </script>

  <style>
    .app-bg{
      background:
        radial-gradient(1100px 600px at 0% -10%, rgba(132,197,244,.30), transparent 60%),
        radial-gradient(900px 540px at 110% 0%, rgba(199,166,244,.22), transparent 58%),
        radial-gradient(1000px 600px at 25% 120%, rgba(247,141,167,.18), transparent 62%),
        radial-gradient(800px 520px at 120% 120%, rgba(157,224,214,.20), transparent 60%),
        linear-gradient(180deg, #f6fbfb 0%, #f8fafc 40%, #fbfcfe 100%);
    }
    .dark .app-bg{
      background:
        radial-gradient(1100px 600px at 0% -10%, rgba(132,197,244,.16), transparent 60%),
        radial-gradient(900px 540px at 110% 0%, rgba(199,166,244,.14), transparent 58%),
        radial-gradient(1000px 600px at 25% 120%, rgba(247,141,167,.12), transparent 62%),
        radial-gradient(800px 520px at 120% 120%, rgba(157,224,214,.12), transparent 60%),
        linear-gradient(180deg, #0b1515, #0b1515 45%, #0b1515 100%);
    }
    .ac-list { position:absolute; inset-inline:0; top:100%; z-index:40 }
    .ac-item { cursor:pointer }
    .badge { display:inline-flex; align-items:center; gap:6px; padding:.25rem .5rem; border-radius:999px; font-size:.75rem; }
    /* Επιταχύνουμε και κάνουμε πιο έντονη την κίνηση των emoji */
    @keyframes spinHourglass {
      0%   { transform: translateY(0) scale(0.95) rotate(0deg); }
      50%  { transform: translateY(-10px) scale(1.18) rotate(270deg); }
      100% { transform: translateY(0) scale(0.95) rotate(540deg); }
    }
    /* Εφαρμόζουμε γρηγορότερη κίνηση & πιο ζωντανά χρώματα στο animated emoji */
    .emoji-spinner {
      animation: spinHourglass 0.6s ease-out infinite;
      filter: saturate(1.4) brightness(1.1);
      opacity: 1;
      display: inline-flex;
    }
    /* μικρό, διακριτικό toast για ειδοποιήσεις */
    #push-toast { transition: transform .25s ease, opacity .25s ease; }
    #push-toast.hidden { opacity:0; pointer-events:none; transform: translateY(6px); }
    .lang-btn { transition: all .2s ease; }
    .lang-btn[data-active="true"] {
      background: linear-gradient(135deg, #29a3a3, #208181);
      color: #fff;
      box-shadow: 0 12px 24px rgba(32,129,129,.25);
    }
    .dark .lang-btn[data-active="true"] {
      background: linear-gradient(135deg, #7edbd9, #4cc2c1);
      color: #062322;
    }
    .flag-icon { display:inline-flex; align-items:center; justify-content:center; }
    .flag-icon svg { width:24px; height:16px; border-radius:2px; box-shadow:0 0 0 1px rgba(15,23,42,.15); }
    .dark .flag-icon svg { box-shadow:0 0 0 1px rgba(148,163,184,.4); }
    .barcode-highlight { box-shadow:0 0 0 3px rgba(16,185,129,.45); }
  </style>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#29a3a3" />
</head>
<body class="min-h-full app-bg text-slate-900 dark:text-slate-200 font-sans">

  <!-- Confetti -->
  <canvas id="confetti" class="fixed inset-0 pointer-events-none z-[60]" style="display:none;"></canvas>

  <!-- Top bar -->
  <div class="absolute top-3 left-3 right-3 z-50">
    <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
      <button id="pro-trigger" data-open-pro type="button" class="flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-2xl bg-white/80 dark:bg-white/10 border border-slate-200 dark:border-slate-700 backdrop-blur shadow-sm hover:bg-white dark:hover:bg-white/20">
        <span aria-hidden="true">💼</span>
        <span id="t-pro">Για επαγγελματίες</span>
      </button>

      <div class="flex items-center gap-2 rounded-2xl bg-white/80 dark:bg-white/10 border border-slate-200 dark:border-slate-700 backdrop-blur px-2 py-1 shadow-sm">
        <div class="flex items-center gap-1">
          <button id="lang-el" type="button" class="lang-btn px-3 py-1.5 text-xs sm:text-sm font-semibold rounded-xl flex items-center gap-2 bg-white/60 dark:bg-white/10 text-slate-800 dark:text-slate-200 hover:bg-white dark:hover:bg-white/20">
            <span aria-hidden="true" class="flag-icon">
              <svg viewBox="0 0 28 20" role="presentation" focusable="false" xmlns="http://www.w3.org/2000/svg">
                <rect width="28" height="20" fill="#0d5eaf"></rect>
                <g fill="#ffffff">
                  <rect y="2" width="28" height="2"></rect>
                  <rect y="6" width="28" height="2"></rect>
                  <rect y="10" width="28" height="2"></rect>
                  <rect y="14" width="28" height="2"></rect>
                  <rect y="18" width="28" height="2"></rect>
                </g>
                <rect width="10" height="10" fill="#0d5eaf"></rect>
                <rect x="4" width="2" height="10" fill="#ffffff"></rect>
                <rect y="4" width="10" height="2" fill="#ffffff"></rect>
              </svg>
            </span>
            <span id="t-langElLabel" class="hidden sm:inline">Ελληνικά</span>
            <span class="sm:hidden">EL</span>
          </button>
          <button id="lang-en" type="button" class="lang-btn px-3 py-1.5 text-xs sm:text-sm font-semibold rounded-xl flex items-center gap-2 bg-white/60 dark:bg-white/10 text-slate-800 dark:text-slate-200 hover:bg-white dark:hover:bg-white/20">
            <span aria-hidden="true" class="flag-icon">
              <svg viewBox="0 0 30 20" role="presentation" focusable="false" xmlns="http://www.w3.org/2000/svg">
                <rect width="30" height="20" fill="#012169"></rect>
                <path d="M0 0L30 20M30 0L0 20" stroke="#ffffff" stroke-width="6" stroke-linecap="square"></path>
                <path d="M0 0L30 20M30 0L0 20" stroke="#c8102e" stroke-width="2.5" stroke-linecap="square"></path>
                <rect x="13" width="4" height="20" fill="#ffffff"></rect>
                <rect y="8" width="30" height="4" fill="#ffffff"></rect>
                <rect x="14" width="2" height="20" fill="#c8102e"></rect>
                <rect y="9" width="30" height="2" fill="#c8102e"></rect>
              </svg>
            </span>
            <span id="t-langEnLabel" class="hidden sm:inline">Αγγλικά</span>
            <span class="sm:hidden">EN</span>
          </button>
        </div>

        <button id="theme-toggle" type="button" class="px-2.5 py-1.5 rounded-xl hover:bg-white dark:hover:bg-white/20">
          <span id="icon-sun" class="hidden">🌞</span><span id="icon-moon">🌙</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Pending toast -->
  <div id="pending-toast" class="hidden fixed top-16 left-1/2 -translate-x-1/2 z-40 w-[min(760px,92vw)] pointer-events-none">
    <div class="pointer-events-auto rounded-2xl p-4 border border-amber-300/70 bg-amber-50 text-amber-900 dark:bg-amber-900/30 dark:text-amber-100 dark:border-amber-800 shadow-soft">
      <div class="flex items-center gap-4">
        <!-- Προσθέτουμε την κλάση emoji-spinner για πιο ζωηρή, γρήγορη κίνηση -->
        <div class="text-4xl emoji-spinner">⏳</div>
        <div class="text-sm sm:text-base">
          <div id="t-pending">Περιμένουμε απαντήσεις από τα κοντινά φαρμακεία…</div>
          <div class="mt-1 font-semibold opacity-80"><span id="wait-elapsed">0s</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- μικρό push toast -->
  <div id="push-toast" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 z-40 w-[min(680px,94vw)]">
    <div class="rounded-2xl p-4 border border-sky-300/70 bg-sky-50 text-sky-900 dark:bg-sky-900/30 dark:text-sky-100 dark:border-sky-800 shadow-soft flex items-center justify-between gap-3">
      <div class="text-sm">
        🔔 Θες να λαμβάνεις ειδοποίηση όταν απαντά ένα φαρμακείο;
      </div>
      <div class="flex gap-2">
        <button id="push-deny" class="px-3 py-1.5 rounded-xl border hover:bg-white/70 dark:hover:bg-white/10 text-sm">Όχι τώρα</button>
        <button id="push-allow" class="px-3 py-1.5 rounded-xl bg-brand-600 text-white font-semibold text-sm">Ενεργοποίηση</button>
      </div>
    </div>
  </div>

  <!-- SPLASH -->
  <section id="splash" class="min-h-[100svh] grid place-items-center relative px-4">
    <div class="w-full max-w-4xl text-center">
      <div class="mx-auto w-24 h-24 rounded-3xl bg-brand-600 text-white grid place-items-center shadow-soft">
        <svg viewBox="0 0 24 24" class="w-10 h-10" aria-hidden="true">
          <path fill="currentColor" d="M11 2h2v3.06A7 7 0 0 1 18.94 11H22v2h-3.06A7 7 0 0 1 13 18.94V22h-2v-3.06A7 7 0 0 1 5.06 13H2v-2h3.06A7 7 0 0 1 11 5.06V2Zm1 5a5 5 0 1 0 0 10a5 5 0 0 0 0-10Z"/>
        </svg>
      </div>

      <h1 class="mt-5 text-4xl sm:text-5xl font-extrabold tracking-tight">MediRadar</h1>
      <p id="t-hero" class="mt-2 text-lg text-slate-600 dark:text-slate-400">Άμεση εύρεση διαθεσιμότητας φαρμάκων σε κοντινά φαρμακεία.</p>

      <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-4 max-w-3xl mx-auto">
        <button id="cta-search" class="px-6 py-4 rounded-2xl bg-gradient-to-r from-brand-500 to-brand-600 text-white font-semibold shadow-soft hover:opacity-95">
          <span id="t-searchBTN">Αναζήτηση Φαρμάκου</span>
        </button>
        <button id="cta-how" class="px-6 py-4 rounded-2xl bg-white/85 backdrop-blur border border-slate-200 hover:bg-white font-semibold">
          <span id="t-howBTN">Πώς λειτουργεί</span>
        </button>
        <button id="cta-signin" class="px-6 py-4 rounded-2xl bg-white/85 backdrop-blur border border-slate-200 hover:bg-white font-semibold">
          <span id="t-signinBTN">Σύνδεση</span>
        </button>
      </div>

      <button id="cta-install" class="mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-brand-600 text-brand-700 font-semibold bg-white/80 backdrop-blur hover:bg-white hidden">
        📲 <span id="t-installBTN">Εγκατάσταση</span>
      </button>

      <div class="sm:hidden mt-4">
        <button id="pro-trigger-mobile" data-open-pro type="button" class="text-sm underline decoration-2">
          <span id="t-pro-m">Για επαγγελματίες</span>
        </button>
      </div>

      <div class="mt-16 max-w-3xl mx-auto w-full relative sm:min-h-[240px]">
        <div class="rounded-3xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/40 backdrop-blur-sm p-6 text-left text-slate-700 dark:text-slate-300 w-full sm:w-[min(320px,45%)] sm:max-w-sm sm:absolute sm:bottom-0 sm:left-0">
          <h2 id="t-faqTitle" class="text-xl font-semibold">Συχνές ερωτήσεις (σύντομα διαθέσιμες)</h2>
          <p id="t-faqSoon" class="mt-2 text-sm">Ετοιμάζουμε ενότητα FAQ με τις πιο συχνές απορίες σας. Αν έχεις ερώτηση, ενημέρωσέ μας.</p>
        </div>

        <div class="mt-6 flex flex-col gap-4 items-center text-slate-500 dark:text-slate-400 w-full sm:w-[min(320px,45%)] sm:max-w-sm sm:absolute sm:bottom-0 sm:right-0 sm:items-end sm:text-right">
          <a id="faq-contact" href="mailto:info@mediradar.gr" class="inline-flex items-center gap-2 text-sm font-semibold text-brand-700 hover:underline sm:self-end">
            ✉️ <span id="t-faqContact">Επικοινωνία: info@mediradar.gr</span>
          </a>
          <div class="flex flex-col items-center sm:items-end gap-3 text-center sm:text-right">
            <p id="t-shareTitle" class="text-xs uppercase tracking-[0.32em] text-slate-400 dark:text-slate-500">Μοιράσου το MediRadar</p>
            <div class="flex items-center gap-3">
              <a id="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fmediradar.gr" target="_blank" rel="noopener" class="p-2 rounded-full border border-slate-200 dark:border-slate-700 hover:bg-white/80 dark:hover:bg-white/10 transition" aria-label="Κοινοποίηση στο Facebook">
                <span class="sr-only" id="t-shareFacebook">Κοινοποίηση στο Facebook</span>
                <svg aria-hidden="true" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 22v-8.2h2.7l.4-3.2h-3.1v-2c0-.9.3-1.5 1.6-1.5h1.6V4.2c-.3 0-1.2-.1-2.2-.1c-2.2 0-3.7 1.3-3.7 3.8v2.1H8.8v3.2h2.9V22h1.8Z"/></svg>
              </a>
              <a id="share-twitter" href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fmediradar.gr" target="_blank" rel="noopener" class="p-2 rounded-full border border-slate-200 dark:border-slate-700 hover:bg-white/80 dark:hover:bg-white/10 transition" aria-label="Κοινοποίηση στο X">
                <span class="sr-only" id="t-shareTwitter">Κοινοποίηση στο X</span>
                <svg aria-hidden="true" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M4 3h4.4l3.2 4.7L15.7 3H20l-6.2 7.2L20 21h-4.4l-3.6-5.1L8.2 21H4l6.5-7.5L4 3Z"/></svg>
              </a>
              <a id="share-instagram" href="https://www.instagram.com/" target="_blank" rel="noopener" class="p-2 rounded-full border border-slate-200 dark:border-slate-700 hover:bg-white/80 dark:hover:bg-white/10 transition" aria-label="Κοινοποίηση στο Instagram">
                <span class="sr-only" id="t-shareInstagram">Κοινοποίηση στο Instagram</span>
                <svg aria-hidden="true" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5Zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7Zm5 3.5A4.5 4.5 0 1 1 7.5 12 4.5 4.5 0 0 1 12 7.5ZM12 9a3 3 0 1 0 3 3 3 3 0 0 0-3-3Zm6.25-2.75a1 1 0 1 1-1 1a1 1 0 0 1 1-1Z"/></svg>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <main id="app" class="hidden mx-auto max-w-3xl px-4 pb-16">
    <header class="sticky top-0 z-30 -mt-3 mb-4">
      <div class="flex items-center justify-between px-2 py-3 rounded-2xl bg-white/80 dark:bg-slate-900/70 backdrop-blur border border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-2">
          <button id="backHome" type="button" data-go-home class="px-3 py-1.5 rounded-lg border text-sm hover:bg-slate-50 dark:hover:bg-slate-800">← <span id="t-home">Αρχική</span></button>
          <span id="t-searchTitle" class="font-semibold">Αναζήτηση Φαρμάκου</span>
        </div>
      </div>
    </header>

    <section class="grid grid-cols-1 gap-4 sm:gap-5">
      <!-- City -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">📍</span>
          <span id="t-city">Πόλη</span>
        </label>
        <select id="city" required
                class="mt-2 w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30">
          <option value="">— Επιλογή —</option>
          <!-- Μεγάλα αστικά κέντρα + extra -->
          <option>Αθήνα</option><option>Πειραιάς</option><option>Θεσσαλονίκη</option>
          <option>Πάτρα</option><option>Ηράκλειο</option><option>Λάρισα</option>
          <option>Βόλος</option><option>Ιωάννινα</option><option>Χανιά</option>
          <option>Καλαμάτα</option><option>Καβάλα</option><option>Ξάνθη</option>
          <option>Κομοτηνή</option><option>Αλεξανδρούπολη</option><option>Σέρρες</option>
          <option>Τρίκαλα</option><option>Λαμία</option><option>Χαλκίδα</option>
          <option>Κόρινθος</option><option>Ρόδος</option><option>Μυτιλήνη</option>
          <option>Ρέθυμνο</option><option>Κέρκυρα</option><option>Χίος</option>
          <option>Αγρίνιο</option><option>Βέροια</option><option>Δράμα</option>
          <option>Κατερίνη</option><option>Κοζάνη</option><option>Ναύπλιο</option>
          <option>Πύργος</option><option>Γλυφάδα</option>
          <!-- Αττική – δήμοι -->
          <option>Μαρούσι</option><option>Χαλάνδρι</option><option>Κηφισιά</option>
          <option>Νέα Ιωνία</option><option>Μεταμόρφωση</option><option>Περιστέρι</option>
          <option>Αιγάλεω</option><option>Καλλιθέα</option><option>Νέα Σμύρνη</option>
          <option>Παλαιό Φάληρο</option><option>Άλιμος</option><option>Ιλίου</option>
          <option>Ζωγράφου</option><option>Γαλάτσι</option><option>Βύρωνας</option>
          <option>Δάφνη</option><option>Ηλιούπολη</option><option>Νίκαια</option>
          <option>Κορυδαλλός</option><option>Πετρούπολη</option><option>Αργυρούπολη</option>
          <option>Ηράκλειο Αττικής</option><option>Νέα Φιλαδέλφεια</option><option>Νέα Χαλκηδόνα</option>
          <!-- Κρήτη extra -->
          <option>Σητεία</option><option>Ιεράπετρα</option><option>Άγιος Νικόλαος</option>
          <!-- Νησιά extra -->
          <option>Κως</option><option>Σάμος</option><option>Σύρος</option><option>Πάρος</option><option>Νάξος</option>
        </select>
      </div>

      <!-- Medicine -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">🔎</span>
          <span id="t-medname">Όνομα Φαρμάκου</span>
        </label>
        <div class="mt-2 relative">
          <input id="medicine-name" type="text" autocomplete="off"
                 class="w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30 placeholder:text-slate-400"
                 placeholder="π.χ. Augmentin 875mg" />
          <div id="ac-medicine" class="ac-list hidden rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-lg"></div>
        </div>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400" id="t-formatTip">Συμβουλή: Εμπορική ονομασία + δοσολογία (π.χ. “500mg”).</p>
        <div class="mt-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/40 p-4">
          <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
            <div class="space-y-1">
              <div class="text-sm font-semibold flex items-center gap-2">
                <span class="w-6 h-6 grid place-items-center">📷</span>
                <span id="t-barcodeTitle">Σάρωση barcode συνταγής ή κουτιού</span>
                <span id="t-barcodeOptional" class="text-xs font-normal text-slate-400">(προαιρετικά)</span>
              </div>
              <p id="t-barcodeHelp" class="text-xs text-slate-500 dark:text-slate-400">Σάρωσε τον γραμμωτό κωδικό για να συμπληρωθεί αυτόματα.</p>
            </div>
            <button id="barcode-start" type="button" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-900 text-white text-xs sm:text-sm font-semibold shadow-soft hover:bg-slate-700 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-slate-200">
              <span aria-hidden="true">🎯</span>
              <span id="t-barcodeStart">Άνοιγμα κάμερας</span>
            </button>
          </div>
          <input id="barcode-value" type="text" inputmode="numeric" pattern="[0-9]*" class="mt-3 w-full px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white/95 dark:bg-slate-900 focus:outline-none focus:ring-4 focus:ring-brand-500/30 placeholder:text-slate-400" placeholder="Ο κωδικός θα εμφανιστεί εδώ" autocomplete="off" />
        </div>
      </div>

      <!-- Quantity + Type -->
      <div class="grid sm:grid-cols-2 gap-4">
        <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
          <label class="text-sm font-semibold flex items-center gap-2">
            <span class="w-6 h-6 grid place-items-center">📦</span>
            <span id="t-qty">Ποσότητα (τεμάχια/κουτιά)</span>
          </label>
          <input id="quantity" type="number" min="1" value="1" required
                 class="mt-2 w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30" />
        </div>

        <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
          <label class="text-sm font-semibold flex items-center gap-2">
            <span class="w-6 h-6 grid place-items-center">💊</span>
            <span id="t-type">Τύπος Φαρμάκου</span>
          </label>
          <select id="medicine-type"
                  class="mt-2 w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30">
            <option value="">— Επιλογή —</option>
            <option>Χάπι</option><option>Κάψουλα</option><option>Σκόνη</option>
            <option>Υγρό</option><option>Σιρόπι</option><option>Σταγόνες</option>
            <option>Εισπνεόμενο</option><option>Σπρέι</option><option>Ρινικό σπρέι</option>
            <option>Οφθαλμικές σταγόνες</option><option>Αλοιφή</option><option>Δερματική Κρέμα</option>
            <option>Ζελέ</option><option>Επίθεμα</option><option>Υπόθετο</option>
            <option>Πένα (προγεμισμένη)</option><option>Διάλυμα έγχυσης</option>
          </select>
        </div>
      </div>

      <!-- Substance -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">🧪</span>
          <span id="t-substance">Δραστική Ουσία</span> <span class="text-slate-400 ml-1" id="t-optional">(προαιρετικά)</span>
        </label>
        <div class="mt-2 relative">
          <input id="active-substance" type="text" autocomplete="off"
                 class="w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30 placeholder:text-slate-400"
                 placeholder="π.χ. Παρακεταμόλη" />
          <div id="ac-substance" class="ac-list hidden rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-lg"></div>
        </div>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400" id="t-doseEx">Παράδειγμα δοσολογίας: Paracetamol 500mg.</p>
      </div>

      <!-- Generic -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <p class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">✅</span>
          <span id="t-genericQ">Αν δεν είναι διαθέσιμο το συγκεκριμένο εμπορικό, επιτρέπεις να σου προτείνουμε ισοδύναμο (γενόσημο);</span>
        </p>
        <div class="mt-3 flex gap-4">
          <label class="inline-flex items-center gap-2"><input type="radio" name="allow-generic" value="YES" class="size-4 accent-brand-600" checked><span id="t-yes">ΝΑΙ</span></label>
          <label class="inline-flex items-center gap-2"><input type="radio" name="allow-generic" value="NO" class="size-4 accent-brand-600"><span id="t-no">ΟΧΙ</span></label>
        </div>
      </div>

      <!-- GDPR + Submit -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="inline-flex items-start gap-3">
          <input id="gdpr-checkbox" type="checkbox" required class="mt-0.5 size-5 accent-brand-600">
          <span class="text-sm"><span id="t-accept">Αποδέχομαι τους</span> <button type="button" id="gdpr-open" class="underline text-brand-700"><span id="t-gdprLink">Όρους Αναζήτησης & GDPR</span></button>.</span>
        </label>
        <div class="mt-4 flex justify-end">
          <button id="submitBtn" class="px-5 py-3 rounded-2xl bg-gradient-to-r from-brand-500 to-brand-600 text-white font-semibold shadow-soft hover:opacity-95">
            <span id="t-submit">Υποβολή Αναζήτησης</span>
          </button>
        </div>
      </div>
    </section>

    <!-- Results & status flow -->
    <section id="results" class="hidden mt-6">
      <div class="rounded-3xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 shadow-soft overflow-hidden">
        <div class="flex items-center gap-3 px-5 py-4 border-b border-slate-200 dark:border-slate-800">
          <button type="button" data-go-home class="flex items-center gap-2 text-sm font-semibold px-3 py-1.5 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800">
            ← <span id="t-statusHome">Αρχική</span>
          </button>
          <h3 id="t-statusHeading" class="flex-1 text-center text-base sm:text-lg font-semibold">Κατάσταση αιτήματος</h3>
          <div class="w-10 h-10" aria-hidden="true"></div>
        </div>
        <div class="p-6 space-y-8">
          <div id="results-pending" class="flex flex-col items-center gap-4 text-center py-10">
            <div class="relative">
              <div class="h-16 w-16 rounded-full border-4 border-brand-500/30 border-t-brand-600 animate-spin"></div>
            </div>
            <div class="space-y-2">
              <h4 id="t-statusPendingTitle" class="text-xl font-bold tracking-tight">Αναζητούμε το φαρμακό σου…</h4>
              <p id="t-statusPendingDesc" class="text-sm text-slate-500 dark:text-slate-400">Θα ειδοποιηθείς μόλις απαντήσει ένα φαρμακείο.</p>
            </div>
          </div>

          <div id="results-list" class="hidden space-y-4">
            <div class="space-y-1">
              <h4 id="t-statusListTitle" class="text-lg font-semibold">Φαρμακεία με διαθεσιμότητα</h4>
              <p id="t-statusListDesc" class="text-sm text-slate-500 dark:text-slate-400">Επίλεξε το φαρμακείο που σε εξυπηρετεί για self pick-up.</p>
            </div>
            <p id="distance-hint" class="hidden text-xs text-slate-500 dark:text-slate-400"></p>
            <div id="resultsList" class="space-y-3"></div>
          </div>

          <div id="pickup-box" class="hidden flex flex-col items-center gap-5 text-center py-8 px-4 rounded-2xl bg-emerald-50/80 dark:bg-emerald-900/20 border border-emerald-300 dark:border-emerald-800">
            <div id="t-statusReservedTitle" class="text-sm font-semibold uppercase tracking-widest text-emerald-700 dark:text-emerald-200">Το φαρμακείο σε περιμένει</div>
            <div class="space-y-2">
              <h4 id="status-reserved-name" class="text-2xl sm:text-3xl font-bold tracking-tight">City Pharmacy</h4>
              <p id="status-reserved-address" class="text-sm text-slate-600 dark:text-slate-300">Ιπποκράτους 12, Αθήνα</p>
            </div>
            <div class="flex items-baseline gap-3">
              <span id="pickup-timer" class="text-5xl font-extrabold tracking-tight">60:00</span>
              <span id="t-statusReservedHint" class="text-sm text-emerald-700 dark:text-emerald-200">Χρόνος κράτησης</span>
            </div>
            <div id="status-reserved-generic" class="hidden px-3 py-1 rounded-full bg-emerald-100/70 dark:bg-emerald-800/40 text-xs font-semibold text-emerald-700 dark:text-emerald-200">🧬 <span id="t-statusGenericBadge">Διαθέσιμο γενόσημο</span></div>
            <div class="flex flex-wrap justify-center gap-3">
              <button id="extend-btn" class="px-4 py-2 rounded-xl border border-emerald-500 text-emerald-700 dark:text-emerald-200 hover:bg-emerald-100/70 dark:hover:bg-emerald-800/40 text-sm font-semibold">
                <span id="t-statusExtend">+15 λεπτά</span>
              </button>
              <a id="status-call" class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 opacity-60 pointer-events-none" href="#">
                📞 <span id="t-statusCall">Κλήση</span>
              </a>
              <a id="status-directions" class="px-4 py-2 rounded-xl bg-sky-600 text-white text-sm font-semibold hover:bg-sky-700 opacity-60 pointer-events-none" href="#" target="_blank" rel="noopener">
                🧭 <span id="t-statusDirections">Οδηγίες</span>
              </a>
            </div>
            <p id="extend-note" class="text-xs text-emerald-700 dark:text-emerald-200 text-center max-w-xs sm:max-w-sm mx-auto">
              Μπορείς να χρησιμοποιήσεις αυτή την επέκταση μόνο μία φορά ανά 12 ώρες.
            </p>
            <button id="status-done" data-go-home type="button" class="px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-white dark:hover:bg-slate-800 text-sm font-semibold">
              <span id="t-statusBackHome">Επιστροφή στην αρχική</span>
            </button>
          </div>

          <div id="results-empty" class="hidden flex flex-col items-center gap-4 text-center py-10 px-4">
            <div class="w-16 h-16 rounded-full bg-rose-100 text-rose-600 grid place-items-center text-2xl">⚠️</div>
            <h4 id="t-statusEmptyTitle" class="text-xl font-bold tracking-tight">Δεν βρέθηκαν φαρμακεία</h4>
            <p id="t-statusEmptyBody" class="text-sm text-slate-500 dark:text-slate-400 max-w-md">Δεν εντοπίσαμε διαθέσιμα φαρμακεία αυτή τη στιγμή. Δοκίμασε ξανά σε λίγο ή άλλαξε τα στοιχεία της αναζήτησης.</p>
            <button id="status-empty-btn" type="button" class="px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-sm font-semibold">
              <span id="t-statusEmptyCta">Δοκίμασε ξανά</span>
            </button>
          </div>
        </div>
        <div class="px-6 pb-6 pt-4 border-t border-slate-200 dark:border-slate-800 flex justify-end">
          <button id="newSearch" class="px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">
            <span id="t-newSearch">Νέα αναζήτηση</span>
          </button>
        </div>
      </div>
    </section>
  </main>

  <!-- PRO PORTAL MODAL -->
  <div id="pro-modal" class="fixed inset-0 hidden items-center justify-center bg-slate-950/60 backdrop-blur-sm px-4 py-6 z-[70]">
    <div class="relative w-full max-w-3xl max-h-[90svh] overflow-y-auto rounded-3xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-6 sm:p-8">
      <button id="pro-close" type="button" class="absolute top-4 right-4 p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800" aria-label="Κλείσιμο">✕</button>
      <div class="space-y-6">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
          <div class="space-y-1">
            <h2 id="t-proModalTitle" class="text-2xl font-bold">Πρόσβαση φαρμακείων</h2>
            <p id="t-proModalSubtitle" class="text-sm text-slate-600 dark:text-slate-400">Συνδέσου ή καταχώρησε το φαρμακείο σου για να απαντάς σε αιτήματα διαθεσιμότητας.</p>
          </div>
        </div>

        <div class="flex items-center gap-1 rounded-2xl bg-slate-100/80 dark:bg-white/5 p-1">
          <button id="pro-tab-signin" type="button" class="flex-1 rounded-2xl px-4 py-2 text-sm font-semibold bg-white dark:bg-slate-800 shadow-soft" aria-selected="true">
            <span id="t-proSigninTab">Σύνδεση</span>
          </button>
          <button id="pro-tab-register" type="button" class="flex-1 rounded-2xl px-4 py-2 text-sm font-semibold text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200" aria-selected="false">
            <span id="t-proRegisterTab">Εγγραφή</span>
          </button>
        </div>

        <div id="pro-view-signin" class="space-y-5">
          <div class="grid gap-4 sm:grid-cols-2">
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-proSigninEmailLabel">Email φαρμακείου</span>
              <input id="pro-signin-email" type="email" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="pharmacy@example.gr">
            </label>
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-proSigninPasswordLabel">Κωδικός πρόσβασης</span>
              <input id="pro-signin-password" type="password" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="••••••••">
            </label>
          </div>
          <button id="pro-signin-submit" class="w-full sm:w-auto px-5 py-3 rounded-2xl bg-brand-600 text-white font-semibold shadow-soft hover:bg-brand-700" type="button">
            <span id="t-proSigninSubmit">Σύνδεση</span>
          </button>
          <button id="pro-forgot" type="button" class="text-sm underline text-slate-600 dark:text-slate-300 hover:opacity-80 w-fit">
            <span id="t-proForgot">Ξέχασες τον κωδικό;</span>
          </button>

          <div class="space-y-3">
            <div class="flex items-center gap-2 text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
              <div class="h-px flex-1 bg-slate-200 dark:bg-slate-700"></div>
              <span id="t-proSSO">Ή συνέχισε με</span>
              <div class="h-px flex-1 bg-slate-200 dark:bg-slate-700"></div>
            </div>
            <div class="grid gap-2 sm:grid-cols-3">
              <button class="pro-sso-btn px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center gap-2" type="button" data-provider="Google">
                <span aria-hidden="true">🟢</span> Google
              </button>
              <button class="pro-sso-btn px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center gap-2" type="button" data-provider="Microsoft">
                <span aria-hidden="true">🪟</span> Microsoft
              </button>
              <button class="pro-sso-btn px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center gap-2" type="button" data-provider="Apple">
                <span aria-hidden="true">🍎</span> Apple
              </button>
            </div>
          </div>

        </div>

        <div id="pro-view-register" class="space-y-5 hidden">
          <div class="space-y-3">
            <div class="flex items-center gap-2 text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
              <div class="h-px flex-1 bg-slate-200 dark:bg-slate-700"></div>
              <span id="t-proSSO2">Ή συνέχισε με</span>
              <div class="h-px flex-1 bg-slate-200 dark:bg-slate-700"></div>
            </div>
            <div class="grid gap-2 sm:grid-cols-3">
              <button class="pro-sso-btn px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center gap-2" type="button" data-provider="Google">
                <span aria-hidden="true">🟢</span> Google
              </button>
              <button class="pro-sso-btn px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center gap-2" type="button" data-provider="Microsoft">
                <span aria-hidden="true">🪟</span> Microsoft
              </button>
              <button class="pro-sso-btn px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center gap-2" type="button" data-provider="Apple">
                <span aria-hidden="true">🍎</span> Apple
              </button>
            </div>
          </div>

          <div>
            <h3 id="t-proRegisterHeading" class="text-lg font-semibold">Στοιχεία φαρμακείου</h3>
            <p id="t-proRegisterDesc" class="mt-1 text-sm text-slate-600 dark:text-slate-400">Συμπλήρωσε τα στοιχεία του φαρμακείου για να ξεκινήσεις.</p>
          </div>

          <form id="pro-register-form" class="grid gap-4 sm:grid-cols-2">
            <label class="text-sm font-semibold flex flex-col gap-2 sm:col-span-2">
              <span id="t-proFieldBusinessName">Επωνυμία φαρμακείου</span>
              <input id="pro-field-business" type="text" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="Φαρμακείο Κεντρικής Πλατείας">
            </label>
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-proFieldVat">ΑΦΜ</span>
              <input id="pro-field-vat" type="text" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="123456789">
            </label>
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-proFieldRegistrationNumber">Αριθμός άδειας</span>
              <input id="pro-field-license" type="text" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="12345">
            </label>
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-proFieldContact">Υπεύθυνος επικοινωνίας</span>
              <input id="pro-field-contact" type="text" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="Μαρία Παπαδοπούλου">
            </label>
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-proFieldEmail">Email επικοινωνίας</span>
              <input id="pro-field-email" type="email" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="pharmacy@example.gr">
            </label>
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-proFieldPhone">Τηλέφωνο</span>
              <input id="pro-field-phone" type="tel" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="2101234567">
            </label>
            <label class="text-sm font-semibold flex flex-col gap-2 sm:col-span-2">
              <span id="t-proFieldAddress">Διεύθυνση</span>
              <input id="pro-field-address" type="text" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="Ιπποκράτους 12">
            </label>
            <label class="text-sm font-semibold flex flex-col gap-2">
              <span id="t-proFieldCity">Πόλη</span>
              <input id="pro-field-city" type="text" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="Αθήνα">
            </label>
            <div class="sm:col-span-2">
              <button id="pro-register-submit" type="submit" class="w-full sm:w-auto px-5 py-3 rounded-2xl bg-brand-600 text-white font-semibold shadow-soft hover:bg-brand-700">
                <span id="t-proRegisterSubmit">Αίτηση εγγραφής</span>
              </button>
            </div>
          </form>

          <div class="text-sm text-slate-600 dark:text-slate-300">
            <span id="t-proHaveAccount">Έχεις ήδη λογαριασμό;</span>
            <button id="t-proGoSignin" data-pro-switch="signin" type="button" class="ml-1 font-semibold underline decoration-2">Σύνδεση</button>
          </div>
        </div>

        <div class="flex flex-wrap items-center justify-between gap-3 pt-2">
          <button id="pro-back-home" type="button" data-go-home data-close-pro="true" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-sm font-semibold">
            <span aria-hidden="true">←</span>
            <span id="t-proBackHome">Επιστροφή στην αρχική</span>
          </button>
          <p class="text-xs text-slate-500 dark:text-slate-400">MediRadar ©</p>
        </div>
      </div>
    </div>
  </div>

  <!-- HOW -->
  <div id="modal-how" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-2xl rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200 dark:border-slate-800">
        <h3 class="text-lg font-bold" id="t-howTitle">Πώς λειτουργεί το MediRadar</h3>
        <button id="how-close" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">✕</button>
      </div>
      <div id="how-body" class="p-5 leading-relaxed text-slate-700 dark:text-slate-300"></div>
      <div class="px-5 pb-5 flex justify-end">
        <button id="how-ok" class="px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold hover:opacity-95"><span id="t-continue">Συνέχεια</span></button>
      </div>
    </div>
  </div>

  <!-- GDPR -->
  <div id="gdpr-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-3xl rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <h3 class="text-lg font-bold" id="t-gdprTitle">Πολιτική Προστασίας Δεδομένων & Όροι Αναζήτησης</h3>
        <button id="gdpr-close" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">✕</button>
      </div>
      <div id="gdpr-body" class="p-5 text-sm text-slate-700 dark:text-slate-300 space-y-3" style="max-height:62vh; overflow:auto"></div>
      <div class="px-5 pb-5 flex justify-end">
        <button id="gdpr-ok" class="px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold hover:opacity-95">OK</button>
      </div>
    </div>
  </div>

  <!-- Pharmacy details modal -->
  <div id="pharm-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-lg rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <h3 class="text-lg font-bold" id="pm-title">Φαρμακείο</h3>
        <button id="pm-close" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">✕</button>
      </div>
      <div class="p-5 space-y-2 text-sm">
        <div id="pm-address">Διεύθυνση:</div>
        <div id="pm-phone">Τηλέφωνο:</div>
      </div>
      <div class="px-5 pb-5 flex gap-2 justify-between">
        <div class="flex gap-2">
          <a id="pm-call" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">Κλήση</a>
          <a id="pm-maps" target="_blank" rel="noopener" class="px-4 py-2 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-700">Άνοιγμα σε Χάρτες</a>
        </div>
        <button id="pm-confirm" class="px-4 py-2 rounded-2xl bg-brand-600 text-white font-semibold hover:bg-brand-700">Επιβεβαίωση & Έναρξη 60’</button>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL (πελάτης) -->
  <div id="login-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4 z-[70]">
    <div class="w-full max-w-md rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200 dark:border-slate-800">
        <h3 class="text-lg font-bold">Σύνδεση</h3>
        <button id="login-close" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">✕</button>
      </div>
      <div class="p-5 space-y-3">
        <label class="block text-sm">
          Email
          <input id="login-email" type="email" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="name@email.com">
        </label>
        <label class="block text-sm">
          Κωδικός
          <input id="login-pass" type="password" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="••••••••">
        </label>

        <div class="flex items-center justify-between pt-1">
          <button id="login-email-btn" class="px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold hover:bg-brand-700">Σύνδεση</button>
          <button id="login-guest" class="text-sm underline hover:opacity-80">Συνέχεια ως επισκέπτης</button>
        </div>

        <div class="flex items-center gap-2 pt-3">
          <div class="h-px bg-slate-200 dark:bg-slate-700 flex-1"></div>
          <span class="text-xs text-slate-500">ή</span>
          <div class="h-px bg-slate-200 dark:bg-slate-700 flex-1"></div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button id="login-google" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 flex items-center justify-center gap-2">
            <span>🟢</span> Google
          </button>
          <button id="login-apple" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 flex items-center justify-center gap-2">
            <span>🍎</span> Apple
          </button>
        </div>

        <button id="login-forgot" class="block text-sm underline hover:opacity-80">Ξέχασα τον κωδικό</button>
      </div>
    </div>
  </div>

  <!-- BARCODE MODAL -->
  <div id="barcode-modal" class="fixed inset-0 hidden items-center justify-center bg-black/50 backdrop-blur-sm px-4 py-6 z-[70]">
    <div class="w-full max-w-md rounded-3xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft overflow-hidden">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200 dark:border-slate-800">
        <h3 id="t-barcodeModalTitle" class="text-lg font-bold">Σάρωση barcode</h3>
        <button id="barcode-close" type="button" class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800" aria-label="Κλείσιμο">✕</button>
      </div>
      <div class="p-5 space-y-4">
        <div id="barcode-status" class="text-sm text-slate-600 dark:text-slate-300">Στόχευσε τον γραμμωτό κωδικό μέσα στο πλαίσιο.</div>
        <div class="rounded-2xl overflow-hidden border border-slate-200 dark:border-slate-800 bg-black">
          <video id="barcode-video" class="w-full aspect-video" autoplay muted playsinline></video>
        </div>
        <div class="flex justify-end">
          <button id="barcode-stop" type="button" class="hidden px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700 text-sm font-semibold hover:bg-slate-100 dark:hover:bg-slate-800">
            <span id="t-barcodeStop">Διακοπή</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== ENV (INLINE — χωρίς /env.js) ===== -->
  <script>
    window.ENV = window.ENV || {
      SUPABASE_URL: 'https://qzerrisyowkfkmcyxmav.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZXJyaXN5b3drZmttY3l4bWF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTcxODQsImV4cCI6MjA3NTU5MzE4NH0.alkvHkOQPBTwY3daUcKAEsf4nt0kizuU3rYI2c2InPk',
      VAPID_PUBLIC_KEY: 'BGS8pCF76A6Es7XAu3hcTAEE8vcRDl1JlWQ7Hym7m5WK63gIHqbuuSJl_xfC4l7729H5ClVqysTjnShnJwviHgo'
    };
  </script>

  <!-- Supabase client -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.ENV || {};
    if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
      console.error('Missing Supabase ENV');
    }
    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('Supabase ready:', !!window.supabase);
  </script>

  <!-- App JS -->
  <script>
    /* ========== Theme ========== */
    const html = document.documentElement;
    const bodyEl = document.body;
    const themeBtn = document.getElementById('theme-toggle');
    const iconSun = document.getElementById('icon-sun');
    const iconMoon = document.getElementById('icon-moon');
    const pushToast = document.getElementById('push-toast');
    function setTheme(mode){
      const dark = mode==='dark';
      html.classList.toggle('dark', dark);
      iconSun.classList.toggle('hidden', !dark);
      iconMoon.classList.toggle('hidden', dark);
      localStorage.setItem('mediradar-theme', dark?'dark':'light');
    }
    setTheme(localStorage.getItem('mediradar-theme') || (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
    themeBtn.addEventListener('click',()=> setTheme(html.classList.contains('dark')?'light':'dark'));

    /* ========== i18n ========== */
    const strings = {
      el:{
        hero:'Άμεση εύρεση διαθεσιμότητας φαρμάκων σε κοντινά φαρμακεία.',
        searchBTN:'Αναζήτηση Φαρμάκου', howBTN:'Πώς λειτουργεί', signinBTN:'Σύνδεση', installBTN:'Εγκατάσταση',
        searchTitle:'Αναζήτηση Φαρμάκου', home:'Αρχική', medname:'Όνομα Φαρμάκου', formatTip:'Συμβουλή: Εμπορική ονομασία + δοσολογία (π.χ. “500mg”).',
        substance:'Δραστική Ουσία', optional:'(προαιρετικά)', doseEx:'Παράδειγμα δοσολογίας: Paracetamol 500mg.', type:'Τύπος Φαρμάκου',
        qty:'Ποσότητα (τεμάχια/κουτιά)', select:'Επιλογή', genericQ:'Αν δεν είναι διαθέσιμο το συγκεκριμένο εμπορικό, επιτρέπεις να σου προτείνουμε ισοδύναμο (γενόσημο);',
        yes:'ΝΑΙ', no:'ΟΧΙ', city:'Πόλη', accept:'Αποδέχομαι τους', submit:'Υποβολή Αναζήτησης', results:'Αποτελέσματα', newSearch:'Νέα αναζήτηση',
        pro:'Για επαγγελματίες', howTitle:'Πώς λειτουργεί το MediRadar', continue:'Συνέχεια', pending:'Περιμένουμε απαντήσεις από τα κοντινά φαρμακεία…', pharmLogin:'Είσοδος φαρμακείων',
        langGreek:'Ελληνικά', langEnglish:'Αγγλικά',
        gdprLink:'Όρους Αναζήτησης & GDPR',
        gdprTitle:'Πολιτική Προστασίας Δεδομένων & Όροι Αναζήτησης',
        gdprBody:`<p>Η MediRadar επεξεργάζεται τα στοιχεία που καταχωρείς αποκλειστικά για την εξυπηρέτηση του αιτήματος διαθεσιμότητας.</p>
          <ul class="list-disc pl-5 space-y-2">
            <li>Συλλέγουμε το φάρμακο, την πόλη, την επιθυμητή ποσότητα και τυχόν πρόσθετες πληροφορίες που δίνεις (δραστική ουσία, barcode).</li>
            <li>Χρησιμοποιούμε τα δεδομένα για να ενημερώσουμε τα συνεργαζόμενα φαρμακεία και να σε ειδοποιήσουμε για τις απαντήσεις τους.</li>
            <li>Διατηρούμε τα στοιχεία μόνο όσο χρειάζεται για να ολοκληρωθεί το αίτημα ή έως 30 ημέρες, εκτός αν ζητήσεις νωρίτερα τη διαγραφή τους.</li>
          </ul>
          <p>Δεν διαβιβάζουμε δεδομένα σε τρίτους και εφαρμόζουμε τεχνικά μέτρα ασφάλειας σύμφωνα με τον GDPR.</p>
          <p>Έχεις δικαίωμα πρόσβασης, διόρθωσης ή διαγραφής επικοινωνώντας στο <a class="text-brand-700 underline" href="mailto:privacy@mediradar.gr">privacy@mediradar.gr</a>.</p>`,
        barcodeTitle:'Σάρωση barcode συνταγής ή κουτιού', barcodeHelp:'Χρησιμοποίησε την κάμερα για να σαρώσεις τον γραμμωτό κωδικό της συνταγής ή του κουτιού.',
        barcodeStart:'Άνοιγμα κάμερας', barcodePlaceholder:'Ο κωδικός θα εμφανιστεί εδώ', barcodeModalTitle:'Σάρωση barcode',
        barcodeStatusInit:'Στόχευσε τον γραμμωτό κωδικό μέσα στο πλαίσιο.', barcodeStatusScanning:'Σάρωση σε εξέλιξη…',
        barcodeStatusSuccess:'Εντοπίστηκε κωδικός: %s', barcodeStatusNoApi:'Ο περιηγητής δεν υποστηρίζει αυτόματη ανάγνωση barcode. Συμπλήρωσε τον κωδικό χειροκίνητα.',
        barcodeStatusNoCamera:'Δεν εντοπίστηκε κάμερα στη συσκευή.', barcodeStatusDenied:'Η πρόσβαση στην κάμερα απορρίφθηκε. Έλεγξε τις άδειες.',
        barcodeStatusStopped:'Η σάρωση διακόπηκε. Μπορείς να κλείσεις το παράθυρο.', barcodeStop:'Διακοπή',
        proModalTitle:'Πρόσβαση φαρμακείων', proModalSubtitle:'Συνδέσου ή καταχώρησε το φαρμακείο σου για να απαντάς σε αιτήματα διαθεσιμότητας.',
        proSigninTab:'Σύνδεση', proRegisterTab:'Εγγραφή',
        proSigninEmailLabel:'Email φαρμακείου', proSigninPasswordLabel:'Κωδικός πρόσβασης', proSigninSubmit:'Σύνδεση',
        proForgot:'Ξέχασες τον κωδικό;', proSSO:'Ή συνέχισε με',
        proHaveAccount:'Έχεις ήδη λογαριασμό;', proGoSignin:'Σύνδεση',
        proRegisterHeading:'Στοιχεία φαρμακείου', proRegisterDesc:'Συμπλήρωσε τα στοιχεία του φαρμακείου για να ξεκινήσεις.',
        proFieldBusinessName:'Επωνυμία φαρμακείου', proFieldVat:'ΑΦΜ', proFieldContact:'Υπεύθυνος επικοινωνίας',
        proFieldEmail:'Email επικοινωνίας', proFieldPhone:'Τηλέφωνο', proFieldAddress:'Διεύθυνση', proFieldCity:'Πόλη',
        proFieldRegistrationNumber:'Αριθμός άδειας', proRegisterSubmit:'Αίτηση εγγραφής', proBackHome:'Επιστροφή στην αρχική',
        statusHeading:'Κατάσταση αιτήματος', statusPendingTitle:'Αναζητούμε το φαρμακό σου…',
        statusPendingDesc:'Θα ειδοποιηθείς μόλις απαντήσει κάποιο φαρμακείο.',
        statusListTitle:'Φαρμακεία με διαθεσιμότητα', statusListDesc:'Επίλεξε το φαρμακείο που σε εξυπηρετεί για self pick-up.',
        statusAccept:'Επιβεβαίωση', statusReservedTitle:'Το φαρμακείο σε περιμένει', statusReservedHint:'Χρόνος κράτησης',
        statusExtend:'+15 λεπτά', statusCall:'Κλήση', statusDirections:'Οδηγίες',
        statusGenericBadge:'Διαθέσιμο γενόσημο', statusGenericShort:'Γενόσημο',
        extendNote:'Μπορείς να χρησιμοποιήσεις αυτή την επέκταση μόνο μία φορά ανά 12 ώρες.',
        extendNoteUsed:'Έχεις ήδη χρησιμοποιήσει την επέκταση μέσα στις τελευταίες 12 ώρες.',
        statusBackHome:'Επιστροφή στην αρχική', statusEmptyTitle:'Δεν βρέθηκαν φαρμακεία',
        statusEmptyBody:'Δεν εντοπίσαμε διαθέσιμα φαρμακεία αυτή τη στιγμή. Δοκίμασε ξανά σε λίγο ή άλλαξε τα στοιχεία της αναζήτησης.',
        statusEmptyCta:'Δοκίμασε ξανά',
        distanceAway:'%s χλμ. από εσένα',
        distanceHintLoading:'Υπολογίζουμε αποστάσεις βάσει της τοποθεσίας σου…',
        distanceHintDenied:'Ενεργοποίησε την τοποθεσία του προγράμματος περιήγησης για να δεις αποστάσεις.',
        distanceHintUnsupported:'Η συσκευή δεν υποστηρίζει υπηρεσίες τοποθεσίας.',
        distanceHintUnavailable:'Δεν ήταν δυνατός ο υπολογισμός αποστάσεων αυτή τη στιγμή.',
        shareTitle:'Μοιράσου το MediRadar',
        shareFacebook:'Κοινοποίηση στο Facebook',
        shareTwitter:'Κοινοποίηση στο X',
        shareInstagram:'Κοινοποίηση στο Instagram',
        faqTitle:'Συχνές ερωτήσεις (σύντομα διαθέσιμες)',
        faqSoon:'Ετοιμάζουμε ενότητα FAQ με τις πιο συχνές απορίες σας. Αν έχεις ερώτηση, ενημέρωσέ μας.',
        faqContact:'Επικοινωνία: info@mediradar.gr'
      },
      en:{
        hero:'Instant availability check at nearby pharmacies.',
        searchBTN:'Medicine Search', howBTN:'How it works', signinBTN:'Sign in', installBTN:'Install',
        searchTitle:'Medicine Search', home:'Home', medname:'Medicine Name', formatTip:'Tip: Brand name + dosage (e.g. “500mg”).',
        substance:'Active Substance', optional:'(optional)', doseEx:'Dosage example: Paracetamol 500mg.', type:'Medicine Type',
        qty:'Quantity (units/boxes)', select:'Select', genericQ:'If the specific brand is unavailable, may we suggest an equivalent (generic)?',
        yes:'YES', no:'NO', city:'City', accept:'I accept the', submit:'Submit Search', results:'Results', newSearch:'New search',
        pro:'For professionals', howTitle:'How MediRadar works', continue:'Continue', pending:'Waiting for responses from nearby pharmacies…', pharmLogin:'Pharmacy login',
        langGreek:'Greek', langEnglish:'English',
        gdprLink:'Search Terms & GDPR',
        gdprTitle:'Data Protection & Search Terms',
        gdprBody:`<p>MediRadar processes the details you provide solely to fulfil your medicine availability request.</p>
          <ul class="list-disc pl-5 space-y-2">
            <li>We collect the medicine, city, desired quantity and any optional details you share (active substance, barcode).</li>
            <li>Your data is used to notify participating pharmacies and relay their responses back to you.</li>
            <li>Information is retained only for the time needed to complete the request or up to 30 days, unless you ask for earlier deletion.</li>
          </ul>
          <p>We do not pass data to third parties and apply security safeguards in line with GDPR requirements.</p>
          <p>You may request access, correction or deletion by emailing <a class="text-brand-700 underline" href="mailto:privacy@mediradar.gr">privacy@mediradar.gr</a>.</p>`,
        barcodeTitle:'Scan prescription or box barcode', barcodeHelp:'Use your camera to capture the prescription or medicine box barcode.',
        barcodeStart:'Open camera', barcodePlaceholder:'The code will appear here', barcodeModalTitle:'Barcode scan',
        barcodeStatusInit:'Align the barcode inside the frame.', barcodeStatusScanning:'Scanning…',
        barcodeStatusSuccess:'Detected code: %s', barcodeStatusNoApi:'Your browser does not support automatic barcode reading. Enter the code manually.',
        barcodeStatusNoCamera:'No camera was found on this device.', barcodeStatusDenied:'Camera access was denied. Check your permission settings.',
        barcodeStatusStopped:'Scanning stopped. You can close this window.', barcodeStop:'Stop',
        proModalTitle:'Pharmacy access', proModalSubtitle:'Sign in or register your pharmacy to respond to availability requests.',
        proSigninTab:'Sign in', proRegisterTab:'Register',
        proSigninEmailLabel:'Pharmacy email', proSigninPasswordLabel:'Password', proSigninSubmit:'Sign in',
        proForgot:'Forgot password?', proSSO:'Or continue with',
        proHaveAccount:'Already have an account?', proGoSignin:'Sign in',
        proRegisterHeading:'Pharmacy details', proRegisterDesc:'Share your business information to get started.',
        proFieldBusinessName:'Pharmacy name', proFieldVat:'VAT number', proFieldContact:'Primary contact',
        proFieldEmail:'Contact email', proFieldPhone:'Phone', proFieldAddress:'Address', proFieldCity:'City',
        proFieldRegistrationNumber:'License number', proRegisterSubmit:'Submit registration', proBackHome:'Back to home',
        statusHeading:'Request status', statusPendingTitle:'Searching for your medicine…',
        statusPendingDesc:'We will notify you as soon as a pharmacy responds.',
        statusListTitle:'Pharmacies with availability', statusListDesc:'Choose the pharmacy that suits you for self pick-up.',
        statusAccept:'Accept', statusReservedTitle:'Your pick-up is ready', statusReservedHint:'Reservation timer',
        statusExtend:'+15 minutes', statusCall:'Call', statusDirections:'Directions',
        statusGenericBadge:'Generic option available', statusGenericShort:'Generic',
        extendNote:'You can use this extension only once every 12 hours.',
        extendNoteUsed:'You have already used the extension within the last 12 hours.',
        statusBackHome:'Back to home', statusEmptyTitle:'No pharmacies found',
        statusEmptyBody:'We couldn’t find any pharmacies with availability right now. Please try again shortly or adjust your request.',
        statusEmptyCta:'Try again',
        distanceAway:'%s km from you',
        distanceHintLoading:'Calculating distances based on your location…',
        distanceHintDenied:'Enable location access in your browser to see distances.',
        distanceHintUnsupported:'Your device does not support location services.',
        distanceHintUnavailable:'We could not calculate distances right now.',
        shareTitle:'Share MediRadar',
        shareFacebook:'Share on Facebook',
        shareTwitter:'Share on X',
        shareInstagram:'Share on Instagram',
        faqTitle:'FAQ (coming soon)',
        faqSoon:'We are preparing an FAQ section with the most common questions. Let us know what you need.',
        faqContact:'Contact: info@mediradar.gr'
      }
    };
    const state = {
      lang: localStorage.getItem('mediradar-lang') || 'el',
      locationStatus: 'idle',
      locationAttempted: false,
      userCoords: null
    };
    let selectedPharmacy = null;
    function t(k){ return strings[state.lang][k]; }
    function setText(id, txt){ const el=document.getElementById(id); if(el) el.textContent=txt; }
    function setHTML(id, html){ const el=document.getElementById(id); if(el) el.innerHTML=html; }
    function applyLang(){
      document.documentElement.lang = state.lang;
      setText('t-hero', t('hero'));
      setText('t-searchBTN', t('searchBTN')); setText('t-howBTN', t('howBTN')); setText('t-signinBTN', t('signinBTN')); setText('t-installBTN', t('installBTN'));
      setText('t-searchTitle', t('searchTitle')); setText('t-home', t('home'));
      setText('t-medname', t('medname')); setText('t-formatTip', t('formatTip'));
      setText('t-city', t('city'));
      setText('t-qty', t('qty'));
      setText('t-type', t('type'));
      setText('t-substance', t('substance'));
      setText('t-doseEx', t('doseEx'));
      setText('t-genericQ', t('genericQ'));
      setText('t-yes', t('yes'));
      setText('t-no', t('no'));
      setText('t-accept', t('accept'));
      setText('t-gdprLink', t('gdprLink'));
      setText('t-submit', t('submit'));
      setText('t-results', t('results')); setText('t-newSearch', t('newSearch')); setText('t-pending', t('pending'));
      setText('t-pro', t('pro')); setText('t-pro-m', t('pro'));
      setText('t-howTitle', t('howTitle')); setText('t-continue', t('continue'));
      setText('t-langElLabel', t('langGreek')); setText('t-langEnLabel', t('langEnglish'));
      setText('t-barcodeTitle', t('barcodeTitle'));
      setText('t-barcodeOptional', t('optional'));
      setText('t-barcodeHelp', t('barcodeHelp'));
      setText('t-barcodeStart', t('barcodeStart'));
      setText('t-barcodeModalTitle', t('barcodeModalTitle'));
      setText('t-barcodeStop', t('barcodeStop'));
      setText('t-gdprTitle', t('gdprTitle'));
      setHTML('gdpr-body', t('gdprBody'));
      setText('t-proModalTitle', t('proModalTitle')); setText('t-proModalSubtitle', t('proModalSubtitle'));
      setText('t-proSigninTab', t('proSigninTab')); setText('t-proRegisterTab', t('proRegisterTab'));
      setText('t-proSigninEmailLabel', t('proSigninEmailLabel')); setText('t-proSigninPasswordLabel', t('proSigninPasswordLabel'));
      setText('t-proSigninSubmit', t('proSigninSubmit')); setText('t-proForgot', t('proForgot'));
      setText('t-proSSO', t('proSSO')); setText('t-proSSO2', t('proSSO'));
      setText('t-proRegisterHeading', t('proRegisterHeading')); setText('t-proRegisterDesc', t('proRegisterDesc'));
      setText('t-proFieldBusinessName', t('proFieldBusinessName')); setText('t-proFieldVat', t('proFieldVat'));
      setText('t-proFieldRegistrationNumber', t('proFieldRegistrationNumber'));
      setText('t-proFieldContact', t('proFieldContact')); setText('t-proFieldEmail', t('proFieldEmail'));
      setText('t-proFieldPhone', t('proFieldPhone')); setText('t-proFieldAddress', t('proFieldAddress'));
      setText('t-proFieldCity', t('proFieldCity'));
      setText('t-proRegisterSubmit', t('proRegisterSubmit'));
      setText('t-proHaveAccount', t('proHaveAccount')); setText('t-proGoSignin', t('proGoSignin'));
      setText('t-proBackHome', t('proBackHome'));
      setText('t-optional', t('optional'));
      setText('t-shareTitle', t('shareTitle'));
      setText('t-shareFacebook', t('shareFacebook'));
      setText('t-shareTwitter', t('shareTwitter'));
      setText('t-shareInstagram', t('shareInstagram'));
      setText('t-faqTitle', t('faqTitle'));
      setText('t-faqSoon', t('faqSoon'));
      setText('t-faqContact', t('faqContact'));
      if(typeof refreshExtendNote === 'function') refreshExtendNote();
      setText('t-statusHeading', t('statusHeading'));
      setText('t-statusPendingTitle', t('statusPendingTitle'));
      setText('t-statusPendingDesc', t('statusPendingDesc'));
      setText('t-statusListTitle', t('statusListTitle'));
      setText('t-statusListDesc', t('statusListDesc'));
      setText('t-statusReservedTitle', t('statusReservedTitle'));
      setText('t-statusReservedHint', t('statusReservedHint'));
      setText('t-statusGenericBadge', t('statusGenericBadge'));
      setText('t-statusExtend', t('statusExtend'));
      setText('t-statusCall', t('statusCall'));
      setText('t-statusDirections', t('statusDirections'));
      setText('t-statusBackHome', t('statusBackHome'));
      setText('t-statusEmptyTitle', t('statusEmptyTitle'));
      setText('t-statusEmptyBody', t('statusEmptyBody'));
      setText('t-statusEmptyCta', t('statusEmptyCta'));
      setText('t-statusHome', t('home'));
      document.getElementById('medicine-name').placeholder = state.lang==='el'?'π.χ. Augmentin 875mg':'e.g. Augmentin 875mg';
      document.getElementById('active-substance').placeholder = state.lang==='el'?'π.χ. Paracetamol':'e.g. Paracetamol';
      document.getElementById('barcode-value').placeholder = t('barcodePlaceholder');
      document.getElementById('pro-signin-email').placeholder = state.lang==='el'?'π.χ. pharmacy@domain.gr':'e.g. pharmacy@domain.com';
      document.getElementById('pro-signin-password').placeholder = state.lang==='el'?'Ο κωδικός σου':'Your password';
      document.getElementById('pro-field-business').placeholder = state.lang==='el'?'π.χ. Φαρμακείο Κεντρικής Πλατείας':'e.g. Central Square Pharmacy';
      document.getElementById('pro-field-vat').placeholder = state.lang==='el'?'π.χ. 123456789':'e.g. 123456789';
      document.getElementById('pro-field-license').placeholder = state.lang==='el'?'π.χ. 12345':'e.g. 12345';
      document.getElementById('pro-field-contact').placeholder = state.lang==='el'?'π.χ. Μαρία Παπαδοπούλου':'e.g. Maria Papadopoulou';
      document.getElementById('pro-field-email').placeholder = state.lang==='el'?'π.χ. pharmacy@domain.gr':'e.g. pharmacy@domain.com';
      document.getElementById('pro-field-phone').placeholder = state.lang==='el'?'π.χ. 2101234567':'e.g. +30 2101234567';
      document.getElementById('pro-field-address').placeholder = state.lang==='el'?'π.χ. Ιπποκράτους 12':'e.g. 12 Ippokratous St';
      document.getElementById('pro-field-city').placeholder = state.lang==='el'?'π.χ. Αθήνα':'e.g. Athens';
      themeBtn.setAttribute('aria-label', state.lang==='el'?'Αλλαγή θέματος':'Toggle theme');
      document.getElementById('pro-trigger').setAttribute('aria-label', state.lang==='el'?'Πρόσβαση για επαγγελματίες':'Professionals area');
      document.getElementById('pro-trigger-mobile').setAttribute('aria-label', state.lang==='el'?'Πρόσβαση για επαγγελματίες':'Professionals area');
      document.getElementById('pro-close').setAttribute('aria-label', state.lang==='el'?'Κλείσιμο παραθύρου':'Close window');
      document.getElementById('barcode-start').setAttribute('aria-label', state.lang==='el'?'Σάρωση barcode':'Scan barcode');
      document.getElementById('barcode-close').setAttribute('aria-label', state.lang==='el'?'Κλείσιμο παραθύρου':'Close window');
      document.getElementById('share-facebook')?.setAttribute('aria-label', t('shareFacebook'));
      document.getElementById('share-twitter')?.setAttribute('aria-label', t('shareTwitter'));
      document.getElementById('share-instagram')?.setAttribute('aria-label', t('shareInstagram'));
      statusCallLink?.setAttribute('aria-label', t('statusCall'));
      statusDirectionsLink?.setAttribute('aria-label', t('statusDirections'));
      document.querySelectorAll('.status-accept-label').forEach(el=> el.textContent = t('statusAccept'));
      document.querySelectorAll('.status-generic-label').forEach(el=> el.textContent = t('statusGenericShort'));
      if(document.getElementById('barcode-modal').classList.contains('hidden')){
        document.getElementById('barcode-status').textContent = t('barcodeStatusInit');
      }
      const langElBtn = document.getElementById('lang-el');
      const langEnBtn = document.getElementById('lang-en');
      langElBtn.dataset.active = state.lang==='el';
      langEnBtn.dataset.active = state.lang==='en';
      langElBtn.setAttribute('aria-pressed', state.lang==='el');
      langEnBtn.setAttribute('aria-pressed', state.lang==='en');
      updateDistanceHint();
      localStorage.setItem('mediradar-lang', state.lang);
    }
    document.getElementById('lang-el').addEventListener('click', ()=>{ state.lang='el'; applyLang(); });
    document.getElementById('lang-en').addEventListener('click', ()=>{ state.lang='en'; applyLang(); });

    /* ========== Navigation ========== */
    const splash = document.getElementById('splash');
    const app = document.getElementById('app');
    function goHome(){
      stopPickupTimer();
      if(demoTimeout){ clearTimeout(demoTimeout); demoTimeout=null; }
      app.classList.add('hidden');
      splash.classList.remove('hidden');
      hidePending();
      const resultsSection = document.getElementById('results');
      resultsSection?.classList.add('hidden');
      document.getElementById('pickup-box')?.classList.add('hidden');
      document.getElementById('results-pending')?.classList.remove('hidden');
      document.getElementById('results-list')?.classList.add('hidden');
      document.getElementById('results-empty')?.classList.add('hidden');
      distanceHintEl?.classList.add('hidden');
      selectedPharmacy = null;
      window.scrollTo({ top: 0, behavior:'smooth' });
    }
    document.getElementById('cta-search').addEventListener('click', ()=>{ splash.classList.add('hidden'); app.classList.remove('hidden'); window.scrollTo({ top: 0, behavior:'smooth' }); });
    document.body.addEventListener('click', (event) => {
      const btn = event.target.closest('[data-go-home]');
      if(!btn) return;
      event.preventDefault();
      if (btn.dataset.closePro === 'true') {
        closeProModal();
      }
      goHome();
    });

    /* ========== Modals (How/GDPR/Login) ========== */
    const modalHow = document.getElementById('modal-how');
    document.getElementById('cta-how').onclick = ()=> {
      modalHow.classList.remove('hidden'); modalHow.classList.add('flex');
      const body = state.lang==='el'
        ? `<div class="space-y-4">
            <div class="space-y-2">
              <p class="text-base font-semibold">🚀 MediRadar – Το φάρμακό σου, χωρίς καθυστερήσεις!</p>
              <p>Ψάχνεις φάρμακο και δεν θες να χάνεις χρόνο;</p>
              <p>Με το MediRadar, βρίσκεις άμεσα ποιο φαρμακείο έχει διαθέσιμο το φαρμακό σου – χωρίς άσκοπες κλήσεις, χωρίς περιττές μετακινήσεις!</p>
            </div>
            <div class="space-y-2">
              <p class="font-semibold">🧠 Πώς λειτουργεί;</p>
              <p>Μπαίνεις στην πλατφόρμα, συμπληρώνεις τα στοιχεία του φαρμάκου και… τέλος! Τα συνεργαζόμενα φαρμακεία λαμβάνουν την αίτησή σου και σου απαντούν θετικά. Το φάρμακο σε περιμένει για παραλαβή σε μόλις 60 λεπτά!</p>
            </div>
            <div class="space-y-2">
              <p class="font-semibold">💡 Γιατί να το χρησιμοποιήσεις;</p>
              <ul class="list-disc pl-5 space-y-2">
                <li>✅ Γρήγορη και εύκολη αναζήτηση φαρμάκου</li>
                <li>✅ Χωρίς τηλεφωνήματα ή αναμονές</li>
                <li>✅ Χωρίς άγχος για πληρωμές ή αποστολές</li>
                <li>✅ Αν έχεις συνταγή, όλα γίνονται στο φαρμακείο</li>
                <li>✅ Δεν συλλέγουμε τιμές ή ιατρικά δεδομένα</li>
              </ul>
            </div>
            <p>🎯 Εσύ ασχολείσαι μόνο με την υγεία σου – εμείς με όλα τα υπόλοιπα!</p>
          </div>`
        : `<div class="space-y-4">
            <div class="space-y-2">
              <p class="text-base font-semibold">🚀 MediRadar – Your medicine, without delays!</p>
              <p>Looking for medication and don’t want to waste time?</p>
              <p>With MediRadar you instantly see which pharmacy has your medicine available—no unnecessary calls or trips.</p>
            </div>
            <div class="space-y-2">
              <p class="font-semibold">🧠 How it works?</p>
              <p>Visit the platform, fill in the medicine details and… done! Partner pharmacies receive your request and reply with availability. Your medicine is ready for pick-up within just 60 minutes.</p>
            </div>
            <div class="space-y-2">
              <p class="font-semibold">💡 Why use it?</p>
              <ul class="list-disc pl-5 space-y-2">
                <li>✅ Fast and easy medicine search</li>
                <li>✅ No phone calls or waiting lines</li>
                <li>✅ No stress about payments or shipping</li>
                <li>✅ If you have a prescription, everything happens at the pharmacy</li>
                <li>✅ We do not collect pricing or medical data</li>
              </ul>
            </div>
            <p>🎯 You focus on your health — we handle the rest!</p>
          </div>`;
      document.getElementById('how-body').innerHTML = body;
    };
    document.getElementById('how-close').onclick = ()=> modalHow.classList.add('hidden');
    document.getElementById('how-ok').onclick    = ()=> modalHow.classList.add('hidden');

    const modalGdpr = document.getElementById('gdpr-modal');
    document.getElementById('gdpr-open').onclick = ()=> { modalGdpr.classList.remove('hidden'); modalGdpr.classList.add('flex'); };
    document.getElementById('gdpr-close').onclick= ()=> modalGdpr.classList.add('hidden');
    document.getElementById('gdpr-ok').onclick   = ()=> modalGdpr.classList.add('hidden');

    const loginModal = document.getElementById('login-modal');
    document.getElementById('cta-signin').onclick = ()=>{ loginModal.classList.remove('hidden'); loginModal.classList.add('flex'); };
    document.getElementById('login-close').onclick = ()=> loginModal.classList.add('hidden');
    document.getElementById('login-email-btn').onclick = ()=> loginModal.classList.add('hidden');
    document.getElementById('login-google').onclick = ()=> loginModal.classList.add('hidden');
    document.getElementById('login-apple').onclick  = ()=> loginModal.classList.add('hidden');
    document.getElementById('login-guest').onclick  = ()=> loginModal.classList.add('hidden');
    document.getElementById('login-forgot').onclick = ()=> alert('Θα προστεθεί ροή υπενθύμισης κωδικού.');

    /* ========== Barcode scanning ========== */
    const barcodeModal = document.getElementById('barcode-modal');
    const barcodeStartBtn = document.getElementById('barcode-start');
    const barcodeCloseBtn = document.getElementById('barcode-close');
    const barcodeStopBtn = document.getElementById('barcode-stop');
    const barcodeStatus = document.getElementById('barcode-status');
    const barcodeVideo = document.getElementById('barcode-video');
    const barcodeInput = document.getElementById('barcode-value');
    let barcodeStream = null;
    let barcodeDetector = null;
    let barcodeActive = false;
    const barcodeFormats = ['ean_13','ean_8','code_128','code_39','qr_code','upc_a','upc_e','itf','data_matrix','pdf417'];

    function setBarcodeStatus(key, value){
      if(!barcodeStatus) return;
      const txt = t(key);
      barcodeStatus.textContent = (value !== undefined && txt.includes('%s')) ? txt.replace('%s', value) : txt;
    }

    async function ensureBarcodeDetector(){
      if(barcodeDetector) return barcodeDetector;
      if(!('BarcodeDetector' in window)) return null;
      try{
        barcodeDetector = new BarcodeDetector({ formats: barcodeFormats });
      }catch(err){
        console.warn('BarcodeDetector init error', err);
        try{ barcodeDetector = new BarcodeDetector(); }
        catch(err2){ console.warn('BarcodeDetector fallback failed', err2); barcodeDetector = null; }
      }
      return barcodeDetector;
    }

    function openBarcodeModal(){
      setBarcodeStatus('barcodeStatusInit');
      barcodeModal.classList.remove('hidden');
      barcodeModal.classList.add('flex');
      bodyEl.classList.add('overflow-hidden');
    }

    function stopBarcodeScan(keepStatus=false){
      barcodeActive = false;
      if(barcodeStream){
        barcodeStream.getTracks().forEach(track=>track.stop());
        barcodeStream = null;
      }
      if(barcodeVideo){
        barcodeVideo.pause?.();
        barcodeVideo.srcObject = null;
      }
      barcodeStopBtn.classList.add('hidden');
      if(!keepStatus){
        setBarcodeStatus('barcodeStatusInit');
      }
    }

    function closeBarcodeModal(){
      stopBarcodeScan();
      barcodeModal.classList.add('hidden');
      barcodeModal.classList.remove('flex');
      bodyEl.classList.remove('overflow-hidden');
    }

    async function startBarcodeScan(){
      if(!navigator.mediaDevices?.getUserMedia){
        setBarcodeStatus('barcodeStatusNoCamera');
        barcodeStopBtn.classList.add('hidden');
        return;
      }
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }});
        barcodeStream = stream;
        barcodeVideo.srcObject = stream;
        await barcodeVideo.play();
        barcodeStopBtn.classList.remove('hidden');
        const detector = await ensureBarcodeDetector();
        if(!detector){
          setBarcodeStatus('barcodeStatusNoApi');
          return;
        }
        barcodeActive = true;
        setBarcodeStatus('barcodeStatusScanning');
        requestAnimationFrame(scanLoop);
      }catch(err){
        console.warn('Barcode camera error', err);
        if(err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')){
          setBarcodeStatus('barcodeStatusDenied');
        }else{
          setBarcodeStatus('barcodeStatusNoCamera');
        }
        stopBarcodeScan(true);
      }
    }

    async function scanLoop(){
      if(!barcodeActive || !barcodeDetector) return;
      try{
        const barcodes = await barcodeDetector.detect(barcodeVideo);
        if(barcodes && barcodes.length){
          const code = String(barcodes[0].rawValue || '').trim();
          if(code){
            barcodeInput.value = code;
            barcodeInput.focus();
            barcodeInput.classList.add('barcode-highlight');
            setTimeout(()=> barcodeInput.classList.remove('barcode-highlight'), 1400);
            setBarcodeStatus('barcodeStatusSuccess', code);
            stopBarcodeScan(true);
            setTimeout(()=> closeBarcodeModal(), 900);
            return;
          }
        }
      }catch(err){
        console.warn('Barcode detect error', err);
      }
      if(barcodeActive) requestAnimationFrame(scanLoop);
    }

    barcodeStartBtn?.addEventListener('click', ()=>{ openBarcodeModal(); startBarcodeScan(); });
    barcodeCloseBtn?.addEventListener('click', closeBarcodeModal);
    barcodeModal?.addEventListener('click', (event)=>{ if(event.target === barcodeModal){ closeBarcodeModal(); }});
    barcodeStopBtn?.addEventListener('click', ()=>{ stopBarcodeScan(true); setBarcodeStatus('barcodeStatusStopped'); });
    document.addEventListener('keydown', (event)=>{ if(event.key === 'Escape' && !barcodeModal.classList.contains('hidden')) closeBarcodeModal(); });

    /* ========== Pro modal (pharmacies) ========== */
    const proModal = document.getElementById('pro-modal');
    const proClose = document.getElementById('pro-close');
    const proTabSignin = document.getElementById('pro-tab-signin');
    const proTabRegister = document.getElementById('pro-tab-register');
    const proSigninView = document.getElementById('pro-view-signin');
    const proRegisterView = document.getElementById('pro-view-register');
    const proOpeners = document.querySelectorAll('[data-open-pro]');
    const proSwitchers = document.querySelectorAll('[data-pro-switch]');
    const proSigninBtn = document.getElementById('pro-signin-submit');
    const proForgotBtn = document.getElementById('pro-forgot');
    const proRegisterForm = document.getElementById('pro-register-form');

    function setProMode(mode='signin'){
      const isSignin = mode==='signin';
      proSigninView.classList.toggle('hidden', !isSignin);
      proRegisterView.classList.toggle('hidden', isSignin);
      proTabSignin.classList.toggle('bg-white', isSignin);
      proTabSignin.classList.toggle('dark:bg-slate-800', isSignin);
      proTabSignin.classList.toggle('text-slate-900', isSignin);
      proTabSignin.classList.toggle('dark:text-slate-100', isSignin);
      proTabSignin.classList.toggle('text-slate-600', !isSignin);
      proTabSignin.classList.toggle('dark:text-slate-400', !isSignin);
      proTabSignin.classList.toggle('shadow-soft', isSignin);
      proTabSignin.setAttribute('aria-selected', isSignin);
      proTabRegister.classList.toggle('bg-white', !isSignin);
      proTabRegister.classList.toggle('dark:bg-slate-800', !isSignin);
      proTabRegister.classList.toggle('text-slate-900', !isSignin);
      proTabRegister.classList.toggle('dark:text-slate-100', !isSignin);
      proTabRegister.classList.toggle('text-slate-600', isSignin);
      proTabRegister.classList.toggle('dark:text-slate-400', isSignin);
      proTabRegister.classList.toggle('shadow-soft', !isSignin);
      proTabRegister.setAttribute('aria-selected', !isSignin);
    }

    function openProModal(mode='signin'){
      setProMode(mode);
      proModal.classList.remove('hidden');
      proModal.classList.add('flex');
      bodyEl.classList.add('overflow-hidden');
    }

    function closeProModal(){
      proModal.classList.add('hidden');
      proModal.classList.remove('flex');
      bodyEl.classList.remove('overflow-hidden');
      setProMode('signin');
    }

    proOpeners.forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        openProModal(btn.dataset.mode || 'signin');
      });
    });
    proTabSignin.addEventListener('click', ()=> setProMode('signin'));
    proTabRegister.addEventListener('click', ()=> setProMode('register'));
    proSwitchers.forEach(btn=> btn.addEventListener('click', ()=> setProMode(btn.dataset.proSwitch || 'signin')));
    proClose.addEventListener('click', closeProModal);
    proModal.addEventListener('click', (event)=>{ if(event.target === proModal){ closeProModal(); }});
    document.addEventListener('keydown', (event)=>{ if(event.key === 'Escape' && !proModal.classList.contains('hidden')) closeProModal(); });

    document.querySelectorAll('.pro-sso-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const provider = btn.dataset.provider;
        alert(state.lang==='el'
          ? `Η σύνδεση με ${provider} θα είναι σύντομα διαθέσιμη.`
          : `${provider} sign-in is coming soon.`);
      });
    });

    proSigninBtn.addEventListener('click', ()=>{
      alert(state.lang==='el'
        ? 'Η σύνδεση φαρμακείου θα είναι σύντομα διαθέσιμη.'
        : 'Pharmacy sign-in will be available soon.');
    });

    proForgotBtn.addEventListener('click', ()=>{
      alert(state.lang==='el'
        ? 'Θα προσθέσουμε ροή ανάκτησης κωδικού σύντομα.'
        : 'Password recovery will be added soon.');
    });

    proRegisterForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      alert(state.lang==='el'
        ? 'Ευχαριστούμε! Η ομάδα MediRadar θα επικοινωνήσει μαζί σου για την ολοκλήρωση της εγγραφής.'
        : 'Thanks! The MediRadar team will reach out to finish your registration.');
      closeProModal();
    });

    /* ========== Autocomplete (demo) ========== */
    const AC_MEDICINES = [
      'Algofren 400mg',
      'Apotel 500mg',
      'Augmentin 875mg/125mg',
      'Bepanthene 5% Cream',
      'Betadine 10%',
      'Canesten 1% Cream',
      'Clavulin 875/125mg',
      'Daktarin Gel',
      'Depon 500mg',
      'Efferalgan 500mg',
      'Fucidin 2%',
      'Gaviscon Double Action',
      'Humira 40mg Pen',
      'Imodium 2mg',
      'Losec 20mg',
      'Nurofen Express 400mg',
      'Otrivin 0.1% Spray',
      'Panadol 500mg',
      'Plavix 75mg',
      'Prospan Syrup',
      'Salospir 100mg',
      'Synagis 100mg',
      'Voltaren 50mg',
      'Xanax 0.5mg',
      'Zylapour 300mg',
      'Zyrtec 10mg'
    ];
    const AC_SUBSTANCES = [
      'Acetylcysteine 600mg',
      'Acetylsalicylic Acid 100mg',
      'Acyclovir 400mg',
      'Allopurinol 300mg',
      'Amlodipine 5mg',
      'Amoxicillin 500mg',
      'Amoxicillin + Clavulanic Acid 875/125mg',
      'Atorvastatin 20mg',
      'Azithromycin 500mg',
      'Cetirizine 10mg',
      'Doxycycline 100mg',
      'Ibuprofen 400mg',
      'Levocetirizine 5mg',
      'Metformin 1000mg',
      'Metoprolol 50mg',
      'Omeprazole 20mg',
      'Paracetamol 500mg',
      'Rivaroxaban 20mg',
      'Rosuvastatin 10mg',
      'Salbutamol 2mg/5ml',
      'Valsartan 160mg'
    ];
    function attachAutocomplete(inputId, listId, data){
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      let idx = -1;
      function render(items){
        list.innerHTML = items.map((x,i)=>`<div class="ac-item px-3 py-2 text-sm hover:bg-brand-50 dark:hover:bg-slate-800 ${i===idx?'bg-brand-50 dark:bg-slate-800':''}" data-val="${x}">${x}</div>`).join('');
        list.classList.toggle('hidden', items.length===0);
      }
      function filter(q){ if(!q){ render([]); return; } render(data.filter(s=>s.toLowerCase().includes(q.toLowerCase())).slice(0,10)); }
      input.addEventListener('input', ()=>{ idx=-1; filter(input.value.trim()); });
      input.addEventListener('keydown', (e)=>{
        const items = [...list.querySelectorAll('.ac-item')]; if(!items.length) return;
        if(e.key==='ArrowDown'){ idx=(idx+1)%items.length; render(items.map(n=>n.dataset.val)); e.preventDefault(); }
        else if(e.key==='ArrowUp'){ idx=(idx-1+items.length)%items.length; render(items.map(n=>n.dataset.val)); e.preventDefault(); }
        else if(e.key==='Enter'){ if(idx>=0){ input.value = items[idx].dataset.val; render([]); } }
        else if(e.key==='Escape'){ render([]); }
      });
      list.addEventListener('click', (e)=>{ const item = e.target.closest('.ac-item'); if(!item) return; input.value = item.dataset.val; list.classList.add('hidden'); });
      document.addEventListener('click', (e)=>{ if(!list.contains(e.target) && e.target!==input){ list.classList.add('hidden'); }});
    }
    attachAutocomplete('medicine-name','ac-medicine',AC_MEDICINES);
    attachAutocomplete('active-substance','ac-substance',AC_SUBSTANCES);

    /* ========== Pending + Confetti ========== */
    const pendingToast=document.getElementById('pending-toast'), waitSpan=document.getElementById('wait-elapsed');
    let waitT=null, waitStart=0;
    function showPending(){
      waitStart=Date.now();
      pendingToast.classList.remove('hidden');
      if(waitT) clearInterval(waitT);
      waitT=setInterval(()=>{waitSpan.textContent=Math.floor((Date.now()-waitStart)/1000)+'s'},500);
      setResultsState('pending');
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function hidePending(){ pendingToast.classList.add('hidden'); if(waitT){clearInterval(waitT); waitT=null;} }
    function fireConfetti(ms=3500){
      const c=document.getElementById('confetti'),ctx=c.getContext('2d');
      const W=c.width=innerWidth,H=c.height=innerHeight; c.style.display='block';
      const N=180,P=Array.from({length:N},()=>({x:Math.random()*W,y:-20-Math.random()*H*.3,r:2+Math.random()*4,vx:-1+Math.random()*2,vy:2+Math.random()*3,a:Math.random()*Math.PI,va:-.2+Math.random()*.4}));
      let run=true; const end=performance.now()+ms;
      (function loop(t){ if(t>end) run=false;
        ctx.clearRect(0,0,W,H);
        P.forEach(p=>{ if(run) p.vy+=.02; p.x+=p.vx; p.y+=p.vy; p.a+=p.va;
          if(p.y>H+20){p.y=-20;p.x=Math.random()*W;p.vy=2+Math.random()*3}
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a);
          ctx.fillStyle=`hsl(${(p.x/W)*360},90%,55%)`; ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2); ctx.restore();
        });
        if(run) requestAnimationFrame(loop); else { c.style.display='none'; ctx.clearRect(0,0,W,H); }
      })(performance.now());
    }

    /* ========== Supabase helpers ========== */
    function sb(){ return window.supabase; }
    function hasSupabase(){ return !!(window.supabase && window.ENV && window.ENV.SUPABASE_URL); }
    const LS_REQ = 'mr:lastRequest';

    /* ========== Results + Pharmacy modal + Pickup timer ========== */
    const results = document.getElementById('results');
    const resultsList = document.getElementById('resultsList');
    const resultsPending = document.getElementById('results-pending');
    const resultsListWrap = document.getElementById('results-list');
    const resultsEmpty = document.getElementById('results-empty');
    const distanceHintEl = document.getElementById('distance-hint');
    const pickupBox = document.getElementById('pickup-box');
    const pickupTimerEl = document.getElementById('pickup-timer');
    const extendBtn = document.getElementById('extend-btn');
    const extendNoteEl = document.getElementById('extend-note');
    const EXTEND_STORAGE_KEY = 'pickup-extend-at';
    const LEGACY_EXTEND_KEY = 'pickup-extend-date';
    const EXTEND_COOLDOWN_MS = 12 * 60 * 60 * 1000;
    const statusReservedName = document.getElementById('status-reserved-name');
    const statusReservedAddress = document.getElementById('status-reserved-address');
    const statusReservedGeneric = document.getElementById('status-reserved-generic');
    const statusCallLink = document.getElementById('status-call');
    const statusDirectionsLink = document.getElementById('status-directions');
    const statusEmptyBtn = document.getElementById('status-empty-btn');

    function readExtendTimestamp(){
      const raw = localStorage.getItem(EXTEND_STORAGE_KEY);
      if(raw){
        const numeric = Number(raw);
        if(!Number.isNaN(numeric)) return numeric;
        const parsed = Date.parse(raw);
        if(!Number.isNaN(parsed)) return parsed;
        localStorage.removeItem(EXTEND_STORAGE_KEY);
      }
      const legacy = localStorage.getItem(LEGACY_EXTEND_KEY);
      if(legacy){
        localStorage.removeItem(LEGACY_EXTEND_KEY);
        const parsedLegacy = Date.parse(legacy);
        if(!Number.isNaN(parsedLegacy)){
          localStorage.setItem(EXTEND_STORAGE_KEY, String(parsedLegacy));
          return parsedLegacy;
        }
      }
      return null;
    }
    function writeExtendTimestamp(ts){
      localStorage.setItem(EXTEND_STORAGE_KEY, String(ts));
      localStorage.removeItem(LEGACY_EXTEND_KEY);
    }
    function canUseExtend(){
      const last = readExtendTimestamp();
      return !last || (Date.now() - last) >= EXTEND_COOLDOWN_MS;
    }
    function refreshExtendNote(){
      const key = extendBtn && extendBtn.disabled ? 'extendNoteUsed' : 'extendNote';
      if(extendBtn){
        extendBtn.setAttribute('title', t(key));
        extendBtn.setAttribute('aria-disabled', extendBtn.disabled ? 'true' : 'false');
      }
      if(extendNoteEl){
        extendNoteEl.textContent = t(key);
      }
    }
    function updateExtendAvailability(){
      if(!extendBtn) return true;
      const allowed = canUseExtend();
      extendBtn.disabled = !allowed;
      extendBtn.classList.toggle('opacity-50', !allowed);
      extendBtn.classList.toggle('cursor-not-allowed', !allowed);
      refreshExtendNote();
      return allowed;
    }

    let pInt=null, remaining=0, pollInt=null, demoTimeout=null;

    function showResultsWrapper(){ results.classList.remove('hidden'); }
    function setResultsState(state){
      showResultsWrapper();
      resultsPending?.classList.toggle('hidden', state!=='pending');
      resultsListWrap?.classList.toggle('hidden', state!=='list');
      resultsEmpty?.classList.toggle('hidden', state!=='empty');
      pickupBox?.classList.toggle('hidden', state!=='reserved');
      if(state==='pending'){
        resultsList.innerHTML='';
        if(statusCallLink){ statusCallLink.href = '#'; setLinkAvailability(statusCallLink, false); }
        if(statusDirectionsLink){ statusDirectionsLink.href = '#'; setLinkAvailability(statusDirectionsLink, false); }
        statusReservedGeneric?.classList.add('hidden');
      }
      if(state==='empty'){
        if(statusCallLink){ statusCallLink.href = '#'; setLinkAvailability(statusCallLink, false); }
        if(statusDirectionsLink){ statusDirectionsLink.href = '#'; setLinkAvailability(statusDirectionsLink, false); }
        statusReservedGeneric?.classList.add('hidden');
      }
      if(state==='pending' || state==='empty'){ selectedPharmacy = null; }
      if(state!=='pending'){
        results.scrollIntoView({ behavior:'smooth', block:'start' });
      }
    }
    function setLinkAvailability(el, enabled){
      if(!el) return;
      el.classList.toggle('opacity-60', !enabled);
      el.classList.toggle('pointer-events-none', !enabled);
    }

    function updateDistanceHint(){
      if(!distanceHintEl) return;
      switch(state.locationStatus){
        case 'loading':
          distanceHintEl.textContent = t('distanceHintLoading');
          distanceHintEl.classList.remove('hidden');
          break;
        case 'denied':
          distanceHintEl.textContent = t('distanceHintDenied');
          distanceHintEl.classList.remove('hidden');
          break;
        case 'unsupported':
          distanceHintEl.textContent = t('distanceHintUnsupported');
          distanceHintEl.classList.remove('hidden');
          break;
        case 'unavailable':
          distanceHintEl.textContent = t('distanceHintUnavailable');
          distanceHintEl.classList.remove('hidden');
          break;
        default:
          distanceHintEl.classList.add('hidden');
          break;
      }
    }

    let locatingPromise = null;
    async function requestUserLocation(){
      if(state.userCoords) return state.userCoords;
      if(state.locationStatus === 'denied' || state.locationStatus === 'unsupported'){
        updateDistanceHint();
        return null;
      }
      if(!('geolocation' in navigator)){
        state.locationStatus = 'unsupported';
        updateDistanceHint();
        return null;
      }
      if(locatingPromise){
        return locatingPromise;
      }
      state.locationAttempted = true;
      state.locationStatus = 'loading';
      updateDistanceHint();
      locatingPromise = new Promise((resolve)=>{
        navigator.geolocation.getCurrentPosition((pos)=>{
          state.userCoords = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          };
          state.locationStatus = 'ready';
          locatingPromise = null;
          updateDistanceHint();
          resolve(state.userCoords);
        }, (err)=>{
          locatingPromise = null;
          if(err && err.code === err.PERMISSION_DENIED){
            state.locationStatus = 'denied';
          }else{
            state.locationStatus = 'unavailable';
          }
          updateDistanceHint();
          resolve(null);
        }, {
          enableHighAccuracy: true,
          timeout: 8000,
          maximumAge: 120000
        });
      });
      return locatingPromise;
    }

    function haversineDistanceKm(lat1, lon1, lat2, lon2){
      const R = 6371;
      const toRad = (deg)=> deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function formatDistance(km){
      if(Number.isNaN(km)) return null;
      const rounded = km >= 10 ? Math.round(km) : Math.round(km * 10) / 10;
      return rounded.toFixed(rounded % 1 === 0 ? 0 : 1);
    }
    function populateReservedDetails(pharmacy){
      const fallbackName = state.lang==='el'?'Φαρμακείο':'Pharmacy';
      const fallbackAddress = state.lang==='el'?'Χωρίς διαθέσιμη διεύθυνση':'No address provided';
      statusReservedName.textContent = pharmacy?.name || fallbackName;
      statusReservedAddress.textContent = pharmacy?.addr || fallbackAddress;
      statusReservedGeneric.classList.toggle('hidden', !pharmacy?.is_generic);
      if(pharmacy?.tel){
        const tel = pharmacy.tel.replace(/\s+/g,'');
        statusCallLink.href = `tel:${tel}`;
        setLinkAvailability(statusCallLink, true);
      } else {
        statusCallLink.href = '#';
        setLinkAvailability(statusCallLink, false);
      }
      const querySource = pharmacy?.addr || pharmacy?.name || '';
      if(querySource){
        const encoded = encodeURIComponent(querySource);
        let href = `https://www.google.com/maps?q=${encoded}`;
        if(pharmacy?.lat && pharmacy?.lng){
          href = `https://www.google.com/maps?q=${encoded}@${pharmacy.lat},${pharmacy.lng},17z`;
        }
        statusDirectionsLink.href = href;
        setLinkAvailability(statusDirectionsLink, true);
      } else {
        statusDirectionsLink.href = '#';
        setLinkAvailability(statusDirectionsLink, false);
      }
    }

    function fmt(s){const m=String(Math.floor(s/60)).padStart(2,'0'), ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`;}
    function stopPickupTimer(){ if(pInt){clearInterval(pInt); pInt=null;} pickupBox?.classList.add('hidden'); }
    function startPickupTimer(sec){
      setResultsState('reserved');
      remaining=sec; pickupTimerEl.textContent=fmt(remaining);
      updateExtendAvailability();
      if(pInt) clearInterval(pInt);
      pInt=setInterval(()=>{remaining--; if(remaining<=0){stopPickupTimer(); return;} pickupTimerEl.textContent=fmt(remaining)},1000);
    }
    if(extendBtn){
      extendBtn.onclick=async ()=>{
        if(!canUseExtend()){
          updateExtendAvailability();
          return;
        }
        remaining+=15*60; pickupTimerEl.textContent=fmt(remaining);
        writeExtendTimestamp(Date.now());
        updateExtendAvailability();
        if(hasSupabase() && window.currentRequest?.id){
          const newUntil = new Date(Date.now()+remaining*1000).toISOString();
          await sb().from('requests').update({ pickup_until: newUntil }).eq('id', window.currentRequest.id);
        }
      };
    }

    statusEmptyBtn?.addEventListener('click', ()=>{
      hidePending();
      results.classList.add('hidden');
      resultsPending?.classList.remove('hidden');
      resultsListWrap?.classList.add('hidden');
      resultsEmpty?.classList.add('hidden');
      pickupBox?.classList.add('hidden');
      selectedPharmacy = null;
      window.scrollTo({ top: 0, behavior:'smooth' });
    });

    const pm = document.getElementById('pharm-modal');
    const pmTitle = document.getElementById('pm-title');
    const pmAddr  = document.getElementById('pm-address');
    const pmPhone = document.getElementById('pm-phone');
    const pmCall  = document.getElementById('pm-call');
    const pmMaps  = document.getElementById('pm-maps');
    const pmConfirm = document.getElementById('pm-confirm');
    document.getElementById('pm-close').onclick = ()=> pm.classList.add('hidden');

    /* ========== CREATE REQUEST ========== */
    async function insertRequestRow(row){
      const { data, error } = await sb().from('requests').insert(row).select('id,created_at').single();
      if(error) throw error;
      return data;
    }

    async function createRequest(payload){
      if(!hasSupabase()) throw new Error('NO_DB');
      const baseRow = {
        status: 'pending',
        med_name: payload.med_name,
        active_substance: payload.active_substance || null,
        med_type: payload.med_type || null,
        quantity: payload.quantity,
        allow_generic: payload.allow_generic,
        city: payload.city
      };
      if(payload.barcode){
        try {
          return await insertRequestRow({ ...baseRow, barcode_value: payload.barcode });
        } catch(err){
          console.warn('Falling back without barcode_value column', err);
        }
      }
      return insertRequestRow(baseRow);
    }

    /* ========== POLLING RESPONSES ========== */
    async function fetchResponses(requestId){
      const { data: rows, error } = await sb()
        .from('responses')
        .select('id, request_id, is_generic, pharmacy_id, available')
        .eq('request_id', requestId)
        .eq('available', true);

      if(error) throw error;
      if(!rows || !rows.length) return [];

      const pharmacyIds = [...new Set(rows.map(r=>r.pharmacy_id).filter(Boolean))];
      let pharmacies = [];
      if(pharmacyIds.length){
        const { data: phs } = await sb()
          .from('pharmacies')
          .select('id,name,address,phone,hours_json,lat,lng')
          .in('id', pharmacyIds);
        pharmacies = phs || [];
      }
      const byId = Object.fromEntries(pharmacies.map(p=>[p.id, p]));
      return rows.map(r=>({
        id: r.id,
        is_generic: !!r.is_generic,
        pharmacy: byId[r.pharmacy_id] || { id:r.pharmacy_id, name:'Φαρμακείο', address:'—', phone:'—' }
      }));
    }

    async function renderResults(items){
      resultsList.innerHTML='';
      const safeItems = Array.isArray(items) ? items : [];
      const hasGeoData = safeItems.some(item => {
        const ph = item?.pharmacy || {};
        const lat = ph.lat !== undefined && ph.lat !== null ? parseFloat(ph.lat) : NaN;
        const lng = ph.lng !== undefined && ph.lng !== null ? parseFloat(ph.lng) : NaN;
        return Number.isFinite(lat) && Number.isFinite(lng);
      });
      let coords = state.userCoords;
      if(hasGeoData && !coords){
        coords = await requestUserLocation();
      }
      if(!hasGeoData){
        distanceHintEl?.classList.add('hidden');
      } else if(!coords && state.locationStatus === 'idle'){
        updateDistanceHint();
      }
      safeItems.forEach(item=>{
        const ph=item.pharmacy || {};
        const lat = ph.lat !== undefined && ph.lat !== null ? parseFloat(ph.lat) : null;
        const lng = ph.lng !== undefined && ph.lng !== null ? parseFloat(ph.lng) : null;
        let distanceLabel='';
        if(coords && Number.isFinite(lat) && Number.isFinite(lng)){
          const km = haversineDistanceKm(coords.lat, coords.lng, lat, lng);
          const formatted = formatDistance(km);
          if(formatted){
            distanceLabel = t('distanceAway').replace('%s', formatted);
          }
        }
        const card = document.createElement('article');
        card.className = 'result-card flex items-center gap-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/85 dark:bg-slate-900/50 px-4 py-4 shadow-soft';
        card.innerHTML = `
          <div class="w-12 h-12 rounded-2xl bg-brand-500/10 text-brand-600 grid place-items-center shrink-0">
            <span aria-hidden="true">💊</span>
          </div>
          <div class="flex flex-col flex-1 min-w-0 text-left">
            <p class="font-semibold text-slate-900 dark:text-slate-100 truncate">${ph.name || (state.lang==='el'?'Φαρμακείο':'Pharmacy')}</p>
            <p class="text-sm text-slate-500 dark:text-slate-400 truncate">${ph.address || '—'}</p>
            ${distanceLabel ? `<p class="mt-1 text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1"><span aria-hidden="true">📍</span><span>${distanceLabel}</span></p>` : ''}
          </div>
          <div class="flex flex-col items-end gap-2 shrink-0">
            ${item.is_generic ? `<span class="px-2 py-1 rounded-full bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-200 text-xs font-semibold status-generic-label-wrapper"><span class="status-generic-label">${t('statusGenericShort')}</span></span>` : ''}
            <button class="select-pharm status-accept px-4 py-2 rounded-xl bg-brand-600 text-white text-sm font-semibold hover:bg-brand-700 transition">
              <span class="status-accept-label">${t('statusAccept')}</span>
            </button>
          </div>`;
        card.dataset.name = ph.name || (state.lang==='el'?'Φαρμακείο':'Pharmacy');
        card.dataset.addr = ph.address || '';
        card.dataset.tel  = ph.phone || '';
        card.dataset.lat  = ph.lat || '';
        card.dataset.lng  = ph.lng || '';
        card.dataset.generic = item.is_generic ? 'true' : 'false';
        resultsList.appendChild(card);
      });
      if(safeItems.length){
        setResultsState('list');
        if(pushToast && !pushToast.dataset.shown){
          pushToast.classList.remove('hidden');
          pushToast.dataset.shown = 'true';
        }
      }else{
        setResultsState('empty');
      }
    }

    function scheduleDemoResults(allow_generic, barcode){
      if(pollInt){ clearInterval(pollInt); pollInt=null; }
      if(demoTimeout){ clearTimeout(demoTimeout); }
      demoTimeout = setTimeout(async ()=>{
        hidePending();
        const demoItems = [
          { pharmacy:{ name:'Φαρμακείο Ιάκωβος', address:'Ιπποκράτους 12, Αθήνα', phone:'+30 210 1234567', lat:37.984, lng:23.735 }, is_generic: allow_generic },
          { pharmacy:{ name:'Φαρμακείο Νίκη', address:'Σόλωνος 90, Αθήνα', phone:'+30 210 7654321', lat:37.983, lng:23.732 }, is_generic: false },
          { pharmacy:{ name:'PharmaPlus Care', address:'Αχαρνών 45, Αθήνα', phone:'+30 210 5556677', lat:37.997, lng:23.727 }, is_generic: false }
        ];
        if(barcode){ console.info('Submitted barcode:', barcode); }
        await renderResults(demoItems);
        demoTimeout = null;
      }, 4500);
    }

    resultsList.addEventListener('click', (e)=>{
      const btn = e.target.closest('.select-pharm'); if(!btn) return;
      const card = btn.closest('.result-card'); if(!card) return;
      selectedPharmacy = {
        name: card.dataset.name,
        addr: card.dataset.addr,
        tel: card.dataset.tel,
        lat: card.dataset.lat,
        lng: card.dataset.lng,
        is_generic: card.dataset.generic === 'true'
      };
      pmTitle.textContent = selectedPharmacy.name;
      pmAddr.textContent  = (state.lang==='el'?'Διεύθυνση: ':'Address: ') + (selectedPharmacy.addr || '—');
      pmPhone.textContent = (state.lang==='el'?'Τηλέφωνο: ':'Phone: ') + (selectedPharmacy.tel || '—');
      pmCall.href = selectedPharmacy.tel ? `tel:${selectedPharmacy.tel.replace(/\s+/g,'')}` : '#';
      pmMaps.href = `https://www.google.com/maps?q=${encodeURIComponent(selectedPharmacy.addr||selectedPharmacy.name)}${selectedPharmacy.lat?`@${selectedPharmacy.lat},${selectedPharmacy.lng},17z`:''}`;
      pm.classList.remove('hidden'); pm.classList.add('flex');
    });

    document.getElementById('pm-close').onclick = ()=> pm.classList.add('hidden');
    document.getElementById('pm-confirm').onclick = async ()=>{
      if(!selectedPharmacy) return;
      pm.classList.add('hidden');
      const sec = 60*60;
      populateReservedDetails(selectedPharmacy);
      startPickupTimer(sec);
      if(hasSupabase() && window.currentRequest?.id){
        const untilISO = new Date(Date.now()+sec*1000).toISOString();
        await sb().from('requests').update({ status:'reserved', pickup_until: untilISO }).eq('id', window.currentRequest.id);
      }
    };

    document.getElementById('newSearch').addEventListener('click', ()=>{
      hidePending();
      stopPickupTimer();
      if(demoTimeout){ clearTimeout(demoTimeout); demoTimeout=null; }
      results.classList.add('hidden');
      resultsPending?.classList.remove('hidden');
      resultsListWrap?.classList.add('hidden');
      resultsEmpty?.classList.add('hidden');
      pickupBox?.classList.add('hidden');
      selectedPharmacy = null;
      window.scrollTo({ top: 0, behavior:'smooth' });
    });

    /* ========== SUBMIT FLOW ========== */
    document.getElementById('submitBtn').addEventListener('click', async (e)=>{
      e.preventDefault();
      const med_name = document.getElementById('medicine-name').value.trim();
      const active_substance = document.getElementById('active-substance').value.trim();
      const barcode = document.getElementById('barcode-value').value.trim();
      const med_type = document.getElementById('medicine-type').value || null;
      const quantity = parseInt(document.getElementById('quantity').value || '1',10);
      const allow_generic = (document.querySelector('input[name="allow-generic"]:checked')?.value==='YES');
      const city = document.getElementById('city').value;

      if(!med_name) return alert(state.lang==='el'?'Συμπλήρωσε το όνομα φαρμάκου':'Enter medicine name');
      if(!city) return alert(state.lang==='el'?'Επίλεξε πόλη':'Select city');
      if(!document.getElementById('gdpr-checkbox').checked) return alert(state.lang==='el'?'Αποδέξου τους όρους':'Accept terms');

      fireConfetti(3500);
      showPending();

      try {
        let inserted = null;
        if(hasSupabase()){
          inserted = await createRequest({ med_name, active_substance, med_type, quantity, allow_generic, city, barcode });
          window.currentRequest = inserted;
          localStorage.setItem(LS_REQ, JSON.stringify({ id: inserted.id, created_at: inserted.created_at }));
        }

        if(hasSupabase() && inserted?.id){
          if(pollInt) clearInterval(pollInt);
          const startPoll = Date.now();
          pollInt = setInterval(async ()=>{
            try{
              const items = await fetchResponses(inserted.id);
              if(items.length){
                hidePending();
                await renderResults(items);
                clearInterval(pollInt); pollInt=null;
              }else if(Date.now()-startPoll > 120000){
                hidePending();
                setResultsState('empty');
                clearInterval(pollInt); pollInt=null;
              }
            }catch(err){ console.warn('poll error', err); }
          }, 3000);
        } else {
          scheduleDemoResults(allow_generic, barcode);
        }
      } catch(err){
        console.error(err);
        window.currentRequest = null;
        localStorage.removeItem(LS_REQ);
        scheduleDemoResults(allow_generic, barcode);
        alert(state.lang==='el'
          ? 'Δεν ήταν δυνατή η σύνδεση με τη βάση. Εμφανίζονται ενδεικτικά αποτελέσματα.'
          : 'We could not connect to the database. Showing demo results instead.');
      }
    });

    /* ===================== Web Push (3c) ===================== */
    const btnPushAllow = document.getElementById('push-allow');
    const btnPushDeny  = document.getElementById('push-deny');

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
      return outputArray;
    }

    async function saveSubscriptionToSupabase(sub) {
      if (!hasSupabase()) return;
      // Συμβατότητα: πάρε τα keys από toJSON()
      const raw = (typeof sub.toJSON === 'function') ? sub.toJSON() : {};
      const keys = raw.keys || {};
      const row = {
        endpoint: sub.endpoint,
        p256dh: keys.p256dh || '',
        auth: keys.auth || '',
        user_agent: navigator.userAgent
      };
      // upsert με onConflict:endpoint
      const { error } = await sb().from('push_subscriptions').upsert(row, { onConflict: 'endpoint' });
      if (error) console.warn('save sub error', error);
    }

    async function ensurePushSubscribed(reg) {
      try{
        if (!('Notification' in window) || !('PushManager' in window)) return;
        const publicKey = (window.ENV && window.ENV.VAPID_PUBLIC_KEY) || '';
        if (!publicKey) return;

        if (Notification.permission === 'granted') {
          const existing = await reg.pushManager.getSubscription();
          if (existing) { await saveSubscriptionToSupabase(existing); return; }
          const sub = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(publicKey)
          });
          await saveSubscriptionToSupabase(sub);
          return;
        }
        if (Notification.permission === 'default') {
          pushToast.classList.remove('hidden');
        }
      }catch(err){ console.warn('push subscribe error', err); }
    }

    btnPushAllow?.addEventListener('click', async ()=>{
      pushToast.classList.add('hidden');
      try{
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') return;
        const reg = await navigator.serviceWorker.getRegistration();
        if (!reg) return;
        await ensurePushSubscribed(reg);
      }catch(e){ console.warn(e); }
    });
    btnPushDeny?.addEventListener('click', ()=> pushToast.classList.add('hidden'));

    /* ========== PWA install & SW update flow ========== */
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js').then(async reg => {
        if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        reg.addEventListener('updatefound', () => {
          const nw = reg.installing;
          nw?.addEventListener('statechange', () => {
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              reg.waiting?.postMessage({ type: 'SKIP_WAITING' });
            }
          });
        });
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          window.location.reload();
        });

        // 3c: push subscription
        await ensurePushSubscribed(reg);
      }).catch(console.warn);
    }
    let deferredPrompt=null;
    const installBtn = document.getElementById('cta-install');
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden');
    });
    installBtn.addEventListener('click', async ()=>{
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt=null; installBtn.classList.add('hidden');
    });

    /* ========== Init ========== */
    applyLang();
    try{
      const saved = JSON.parse(localStorage.getItem(LS_REQ) || 'null');
      if(saved?.id){ window.currentRequest = saved; }
    }catch{}
  </script>
</body>
</html>
