<!DOCTYPE html>
<html lang="el" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MediRadar App</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#0d9488', // Teal-600
                        secondary: '#0f172a', // Slate-900
                    },
                    animation: {
                        'float': 'float 15s linear infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideInUp: { '0%': { transform: 'translateY(100px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideOutDown: { '0%': { transform: 'translateY(0)', opacity: '1' }, '100%': { transform: 'translateY(100px)', opacity: '0' } }
                    }
                }
            }
        }
    </script>

    <style>
        .emoji-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: 0; pointer-events: none;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            transition: background 0.5s ease;
        }
        html.dark .emoji-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .emoji { position: absolute; bottom: -100px; font-size: 2rem; opacity: 0.4; animation: floatUp 15s linear infinite; z-index: 0; }
        @keyframes floatUp { 0% { transform: translateY(0) rotate(0deg); opacity: 0; } 10% { opacity: 0.5; } 90% { opacity: 0.5; } 100% { transform: translateY(-110vh) rotate(360deg); opacity: 0; } }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
            position: relative; z-index: 10; transition: all 0.3s ease;
        }
        html.dark .glass-card { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.3); }

        .modal-backdrop { display: none; position: fixed; inset: 0; z-index: 50; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 1rem; }
        .modal-backdrop.active { display: flex; animation: fadeIn 0.2s ease-out; }
        .modal-content { width: 100%; max-width: 400px; border-radius: 1.5rem; padding: 2rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transform: scale(0.95); opacity: 0; }
        .modal-backdrop.active .modal-content { animation: slideUp 0.3s ease-out forwards; }
        
        .toast-enter { animation: slideInUp 0.3s ease-out forwards; }
        .toast-exit { animation: slideOutDown 0.3s ease-in forwards; }
        body::-webkit-scrollbar { width: 0px; background: transparent; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        
        /* Radar Animation for Searching */
        .radar-pulse {
            width: 100px; height: 100px; background: rgba(13, 148, 136, 0.2);
            border-radius: 50%; position: relative; margin: 0 auto;
        }
        .radar-pulse::before, .radar-pulse::after {
            content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            border-radius: 50%; border: 2px solid #0d9488; width: 100%; height: 100%;
            animation: ripple 2s linear infinite; opacity: 0;
        }
        .radar-pulse::after { animation-delay: 1s; }
        @keyframes ripple { 0% { width: 0; height: 0; opacity: 1; } 100% { width: 200%; height: 200%; opacity: 0; } }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-100 antialiased min-h-screen relative flex flex-col">

    <div id="emoji-container" class="emoji-bg"></div>

    <nav class="w-full max-w-lg mx-auto p-4 flex justify-between items-center z-20 relative">
        <div class="flex gap-2">
            <button onclick="openModal('user')" class="bg-white/90 dark:bg-slate-800/90 px-3 py-2 rounded-xl text-xs font-bold text-primary border border-primary/20 shadow-sm hover:shadow-md">
                <i class="ph ph-user text-lg"></i> Î•Î¯ÏƒÎ¿Î´Î¿Ï‚
            </button>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleLang()" class="bg-white/60 dark:bg-slate-700/60 w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-sm"><span id="lang-flag">ğŸ‡¬ğŸ‡·</span></button>
            <button onclick="toggleTheme()" class="bg-white/60 dark:bg-slate-700/60 w-10 h-10 rounded-full flex items-center justify-center shadow-sm"><i id="theme-icon" class="ph ph-moon-stars text-xl"></i></button>
        </div>
    </nav>

    <main class="w-full max-w-lg mx-auto p-4 pb-6 flex-grow z-10 relative">
        
        <header class="text-center mb-6">
            <div class="inline-flex items-center justify-center bg-white/70 dark:bg-slate-700/70 p-4 rounded-2xl mb-3 shadow-sm backdrop-blur-sm border border-white/50">
                <i class="ph ph-magnifying-glass text-4xl text-primary"></i>
            </div>
            <h1 class="text-3xl font-bold text-primary bg-clip-text text-transparent bg-gradient-to-r from-teal-600 to-cyan-500 drop-shadow-sm">MediRadar</h1>
            <p class="text-slate-500 dark:text-slate-400 text-sm mt-1 font-medium">Î’ÏÎµÏ‚ Ï„Î¿ Ï†Î¬ÏÎ¼Î±ÎºÏŒ ÏƒÎ¿Ï… Î¬Î¼ÎµÏƒÎ± & Ï„Î¿Ï€Î¹ÎºÎ¬.</p>
        </header>

        <div class="flex p-1.5 bg-slate-200/80 dark:bg-slate-800/80 rounded-2xl mb-6 glass-card">
            <button onclick="switchTab('search')" id="btn-search" class="flex-1 py-3 rounded-xl text-sm font-bold bg-white dark:bg-slate-700 shadow-sm text-primary dark:text-teal-300">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·</button>
            <button onclick="switchTab('how')" id="btn-how" class="flex-1 py-3 rounded-xl text-sm font-bold text-slate-500 dark:text-slate-400 hover:bg-white/50">Î ÏÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯</button>
        </div>

        <div id="tab-search" class="tab-content active">
            <div class="glass-card rounded-3xl p-6 relative overflow-hidden">
                <form id="request-form" class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">ÎŸÎ½Î¿Î¼Î±</label>
                            <input id="full-name" type="text" placeholder="ÎœÎ±ÏÎ¯Î± Î ." oninput="saveUserData()" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 focus:ring-2 focus:ring-primary/50 outline-none" required>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î¤Î·Î»ÎµÏ†Ï‰Î½Î¿</label>
                            <input id="phone" type="tel" placeholder="69..." oninput="saveUserData()" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 focus:ring-2 focus:ring-primary/50 outline-none" required>
                        </div>
                    </div>
                    <div class="space-y-2 relative">
                        <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î ÎµÏÎ¹Î¿Ï‡Î·</label>
                        <div class="relative">
                            <input id="city" type="text" placeholder="Ï€.Ï‡. ÎšÎ¬Ï„Ï‰ Î¤Î¿ÏÎ¼Ï€Î±" oninput="saveUserData()" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl px-4 py-3.5 pr-32 focus:ring-2 focus:ring-primary/50 outline-none" required>
                            <button type="button" onclick="getLocation()" class="absolute right-2 top-2 bottom-2 px-3 bg-teal-100 dark:bg-teal-900/40 text-teal-800 dark:text-teal-200 border border-teal-200 rounded-xl text-xs font-bold hover:bg-teal-200 flex items-center gap-1">
                                <i class="ph ph-navigation-arrow text-sm"></i> ÎšÎ¿Î½Ï„Î¬ Î¼Î¿Ï…
                            </button>
                        </div>
                    </div>
                    <div class="border-t-2 border-dashed border-slate-200 dark:border-slate-700 my-2"></div>
                    <div class="space-y-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">ÎŸÎ½Î¿Î¼Î± Î¦Î±ÏÎ¼Î±ÎºÎ¿Ï…</label>
                            <div class="relative">
                                <i class="ph ph-pill absolute left-4 top-4 text-slate-400 text-xl z-10"></i>
                                <input id="medicine" type="text" placeholder="Ï€.Ï‡. Depon Maximum" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-2xl pl-12 pr-12 py-3.5 text-lg font-semibold focus:ring-2 focus:ring-primary/50 outline-none" required>
                                <button type="button" onclick="startVoiceInput()" id="voice-btn" class="absolute right-3 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 flex items-center justify-center text-xl text-slate-500 hover:text-primary"><i id="mic-icon" class="ph ph-microphone"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î”ÏÎ±ÏƒÏ„Î¹ÎºÎ·</label>
                                <input id="substance" type="text" placeholder="Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 rounded-2xl px-4 py-3.5 outline-none">
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase ml-1">Î Î¿ÏƒÎ¿Ï„Î·Ï„Î±</label>
                                <input id="quantity" type="number" min="1" value="1" class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 rounded-2xl px-4 py-3.5 text-center font-bold outline-none">
                            </div>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-800/80 rounded-2xl p-4 border-2 border-dashed border-slate-300 hover:border-primary/50 transition-colors">
                            <label class="text-xs font-bold text-slate-600 uppercase mb-3 block text-center">ğŸ“¸ Î¦Ï‰Ï„Î¿ / Barcode</label>
                            <div class="grid grid-cols-2 gap-3">
                                <input id="request-image" type="file" accept="image/*" class="hidden" onchange="handleFileSelect(this)">
                                <button type="button" onclick="document.getElementById('request-image').click()" class="flex flex-col items-center justify-center bg-white dark:bg-slate-700 border-2 border-slate-200 rounded-xl p-4 hover:shadow-md">
                                    <i class="ph ph-camera text-3xl text-slate-600 dark:text-slate-300 mb-1"></i>
                                    <span class="text-xs font-semibold text-slate-600 dark:text-slate-300">Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±</span>
                                </button>
                                <button type="button" onclick="toggleScanner()" class="flex flex-col items-center justify-center bg-white dark:bg-slate-700 border-2 border-slate-200 rounded-xl p-4 hover:shadow-md">
                                    <i class="ph ph-barcode text-3xl text-slate-600 dark:text-slate-300 mb-1"></i>
                                    <span class="text-xs font-semibold text-slate-600 dark:text-slate-300">Scan Barcode</span>
                                </button>
                            </div>
                            <div id="scanner-container" class="hidden mt-4 rounded-xl overflow-hidden relative bg-black border-2 border-primary h-64"><div id="reader"></div></div>
                            <div id="media-preview" class="hidden mt-3 p-3 bg-teal-50 dark:bg-teal-900/30 border border-teal-100 rounded-xl flex items-center gap-3">
                                <i class="ph ph-check-circle text-teal-600 text-xl"></i>
                                <p id="preview-text" class="text-xs text-teal-600 truncate flex-1">Uploaded</p>
                                <button type="button" onclick="clearMedia()"><i class="ph ph-trash text-teal-400"></i></button>
                            </div>
                            <input id="barcode-value" type="hidden">
                        </div>
                    </div>
                    <div class="space-y-3 pt-2">
                        <label class="flex items-start gap-3 px-3 cursor-pointer">
                            <input type="checkbox" class="mt-1 w-4 h-4 text-primary rounded border-gray-300" checked>
                            <span class="text-xs text-slate-600 dark:text-slate-300">Î”Î­Ï‡Î¿Î¼Î±Î¹ Î½Î± Î¼Î¿Ï… Ï€ÏÎ¿Ï„ÎµÎ¯Î½Î¿Ï…Î½ <strong>Î³ÎµÎ½ÏŒÏƒÎ·Î¼Î¿</strong>.</span>
                        </label>
                        <label class="flex items-start gap-3 px-3 cursor-pointer">
                            <input type="checkbox" id="gdpr-check" class="mt-0.5 w-4 h-4 text-primary rounded border-gray-300" required>
                            <span class="text-xs text-slate-500">Î‘Ï€Î¿Î´Î­Ï‡Î¿Î¼Î±Î¹ Ï„Î¿Ï…Ï‚ <a href="#" data-open-modal="terms" class="underline text-primary">ÎŒÏÎ¿Ï…Ï‚</a> ÎºÎ±Î¹ <a href="#" data-open-modal="gdpr" class="underline text-primary">GDPR</a>.</span>
                        </label>
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-cyan-500 to-teal-500 text-white text-lg font-bold py-4 rounded-2xl shadow-lg transform active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                        <i class="ph ph-paper-plane-right text-xl"></i> Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î‘Î¹Ï„Î®Î¼Î±Ï„Î¿Ï‚
                    </button>
                </form>
            </div>
        </div>

        <div id="results-view" class="hidden animate-fadeIn">
            <div class="glass-card rounded-3xl p-6 min-h-[50vh]">
                <div class="text-center mb-6">
                    <div class="radar-pulse"></div>
                    <h2 class="text-xl font-bold mt-4 text-slate-800 dark:text-white">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÏƒÎµ ÎµÎ¾Î­Î»Î¹Î¾Î·...</h2>
                    <p class="text-sm text-slate-500">Î•Î¹Î´Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î± Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î± ÎºÎ¿Î½Ï„Î¬ ÏƒÎ¿Ï….</p>
                </div>
                
                <div id="responses-list" class="space-y-4">
                    </div>
                
                <div class="mt-8 text-center">
                    <button onclick="resetApp()" class="text-sm text-red-400 hover:text-red-600 font-medium">
                        <i class="ph ph-x-circle"></i> Î‘ÎºÏÏÏ‰ÏƒÎ· Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚
                    </button>
                </div>
            </div>
        </div>

        <div id="pickup-view" class="hidden animate-fadeIn">
            <div class="glass-card rounded-3xl p-8 text-center border-teal-200 dark:border-teal-800">
                <div class="w-24 h-24 bg-teal-100 dark:bg-teal-900/50 rounded-full flex flex-col items-center justify-center mx-auto mb-6 shadow-xl ring-8 ring-teal-50 dark:ring-teal-900/20">
                    <i class="ph ph-hourglass-high text-4xl text-primary mb-1"></i>
                    <p class="text-xs font-bold text-primary">Pickup</p>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">Î§ÏÏŒÎ½Î¿Ï‚ Î Î±ÏÎ±Î»Î±Î²Î®Ï‚</h2>
                <p class="text-slate-500 dark:text-slate-400 mb-6">ÎšÏÎ±Ï„Î®Î¸Î·ÎºÎµ! Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€Î±ÏÎ±Î»Î¬Î²ÎµÏ„Îµ ÎµÎ½Ï„ÏŒÏ‚:</p>
                <div class="bg-white dark:bg-slate-700 rounded-2xl p-4 mb-6 shadow-inner border border-slate-200 dark:border-slate-700">
                    <p id="timer-display" class="text-5xl font-extrabold text-primary dark:text-teal-400 tracking-tighter">--:--</p>
                    <p class="text-sm text-slate-500 mt-1">Î›ÎµÏ€Ï„Î¬</p>
                </div>
                <button id="extend-btn" onclick="extendPickupTime()" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-500 font-bold py-3 rounded-xl flex items-center justify-center gap-2 mb-4">
                    <i class="ph ph-timer text-lg"></i> Î Î±ÏÎ¬Ï„Î±ÏƒÎ· 15'
                </button>
                <button onclick="resetApp()" class="text-sm text-slate-400 hover:text-slate-600">ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· / Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
            </div>
        </div>

        <div id="tab-how" class="tab-content">
            <div class="glass-card rounded-3xl p-6">
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2"><i class="ph ph-info text-primary"></i> Î ÏÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯;</h3>
                <ul class="space-y-6">
                    <li class="flex gap-4"><div class="bg-teal-100 text-teal-700 w-10 h-10 rounded-full flex items-center justify-center font-bold">1</div><div><h4 class="font-bold">Î‘Î¯Ï„Î·Î¼Î±</h4><p class="text-sm text-slate-600">Î£Ï…Î¼Ï€Î»Î·ÏÏÎ½ÎµÎ¹Ï‚ Ï„Î· Ï†ÏŒÏÎ¼Î± Î® ÏƒÎ±ÏÏÎ½ÎµÎ¹Ï‚ barcode.</p></div></li>
                    <li class="flex gap-4"><div class="bg-teal-100 text-teal-700 w-10 h-10 rounded-full flex items-center justify-center font-bold">2</div><div><h4 class="font-bold">Î›Î¯ÏƒÏ„Î±</h4><p class="text-sm text-slate-600">Î’Î»Î­Ï€ÎµÎ¹Ï‚ Ï€Î¿Î¹Î± Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î± Î­Ï‡Î¿Ï…Î½ Ï„Î¿ Ï†Î¬ÏÎ¼Î±ÎºÎ¿ ÎºÎ±Î¹ ÏƒÎµ Ï„Î¹ Î±Ï€ÏŒÏƒÏ„Î±ÏƒÎ·.</p></div></li>
                    <li class="flex gap-4"><div class="bg-teal-100 text-teal-700 w-10 h-10 rounded-full flex items-center justify-center font-bold">3</div><div><h4 class="font-bold">Î Î±ÏÎ±Î»Î±Î²Î®</h4><p class="text-sm text-slate-600">Î•Ï€Î¹Î»Î­Î³ÎµÎ¹Ï‚, ÎµÎ½Î·Î¼ÎµÏÏÎ½ÎµÎ¹Ï‚ Î³Î¹Î± Î±Î»Î»ÎµÏÎ³Î¯ÎµÏ‚ ÎºÎ±Î¹ Ï€Î±ÏÎ±Î»Î±Î¼Î²Î¬Î½ÎµÎ¹Ï‚.</p></div></li>
                </ul>
            </div>
        </div>

    </main>

    <footer class="mt-auto py-6 bg-white/50 dark:bg-slate-900/50 backdrop-blur-md border-t border-slate-200 z-10 text-center">
        <button onclick="openModal('pro')" class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-slate-800 text-white text-xs font-bold mb-4"><i class="ph ph-briefcase"></i> PRO</button>
        <div class="flex justify-center gap-4 text-xs text-slate-500 mb-4">
            <a href="#" data-open-modal="terms">ÎŒÏÎ¿Î¹</a><a href="#" data-open-modal="gdpr">GDPR</a><a href="#">Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±</a>
        </div>
        <p class="text-xs text-slate-400">Â© 2025 MediRadar</p>
    </footer>

    <div id="toast-container" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-sm px-4 space-y-2 pointer-events-none"></div>

    <div id="modal-safety" class="modal-backdrop">
        <div class="modal-content bg-white dark:bg-slate-800 text-center relative glass-card !opacity-100 !transform-none">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600">
                <i class="ph ph-warning-circle text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold mb-2 text-slate-900 dark:text-white">Î£Î·Î¼Î±Î½Ï„Î¹ÎºÎ® Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ·</h3>
            <div class="bg-red-50 dark:bg-red-900/20 border border-red-100 p-4 rounded-xl mb-4 text-left">
                <p class="text-xs text-red-800 dark:text-red-200 font-medium leading-relaxed">
                    <strong>Î‘Ï€Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î•Ï…Î¸ÏÎ½Î·Ï‚:</strong> Î¤Î¿ MediRadar ÎµÎ½Î·Î¼ÎµÏÏÎ½ÎµÎ¹ Î¼ÏŒÎ½Î¿ Î³Î¹Î± Ï„Î· Î´Î¹Î±Î¸ÎµÏƒÎ¹Î¼ÏŒÏ„Î·Ï„Î±.
                    Î”ÎµÎ½ Ï†Î­ÏÎ¿Ï…Î¼Îµ ÎµÏ…Î¸ÏÎ½Î· Î³Î¹Î± Î¹Î±Ï„ÏÎ¹ÎºÎ­Ï‚ ÏƒÏ…Î¼Î²Î¿Ï…Î»Î­Ï‚, Ï€Î±ÏÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚ Î® Ï€Î¿Î¹ÏŒÏ„Î·Ï„Î± ÏƒÎºÎµÏ…Î±ÏƒÎ¼Î¬Ï„Ï‰Î½.
                </p>
                <p class="text-xs text-red-800 dark:text-red-200 font-bold mt-2 leading-relaxed">
                    âš ï¸ Î•Î¯ÏƒÏ„Îµ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ Ï…Ï€ÎµÏÎ¸Ï…Î½Î¿Î¹ Î½Î± ÎµÎ½Î·Î¼ÎµÏÏÏƒÎµÏ„Îµ Ï„Î¿Î½ Ï†Î±ÏÎ¼Î±ÎºÎ¿Ï€Î¿Î¹ÏŒ Î³Î¹Î± Ï„Ï…Ï‡ÏŒÎ½ Î‘Î›Î›Î•Î¡Î“Î™Î•Î£ Î® Î¬Î»Î»Î± Ï†Î¬ÏÎ¼Î±ÎºÎ± Ï€Î¿Ï… Î»Î±Î¼Î²Î¬Î½ÎµÏ„Îµ ÎºÎ±Ï„Î¬ Ï„Î·Î½ Ï€Î±ÏÎ±Î»Î±Î²Î® (Self Pickup).
                </p>
            </div>
            <button id="confirm-pickup-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg">
                ÎˆÏ‡Ï‰ ÎµÎ½Î·Î¼ÎµÏÏ‰Î¸ÎµÎ¯ & Î£Ï…Î½ÎµÏ‡Î¯Î¶Ï‰
            </button>
            <button onclick="closeModal('safety')" class="mt-3 text-sm text-slate-500 font-medium">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
        </div>
    </div>

    <div id="modal-user" class="modal-backdrop"><div class="modal-content bg-white dark:bg-slate-800 relative"><button onclick="closeModal('user')" class="absolute top-4 right-4"><i class="ph ph-x"></i></button><h3>User Login</h3><p class="text-sm">Demo only.</p></div></div>
    <div id="modal-pro" class="modal-backdrop"><div class="modal-content bg-white dark:bg-slate-800 relative"><button onclick="closeModal('pro')" class="absolute top-4 right-4"><i class="ph ph-x"></i></button><h3>Pro Login</h3><a href="pharmacy.html" class="block bg-slate-800 text-white p-2 rounded mt-2">Go to App</a></div></div>
    <div id="modal-terms" class="modal-backdrop"><div class="modal-content bg-white relative"><button onclick="closeModal('terms')" class="absolute top-4 right-4"><i class="ph ph-x"></i></button><h3>Terms</h3></div></div>
    <div id="modal-gdpr" class="modal-backdrop"><div class="modal-content bg-white relative"><button onclick="closeModal('gdpr')" class="absolute top-4 right-4"><i class="ph ph-x"></i></button><h3>GDPR</h3></div></div>

    <script src="env.js"></script>
    <script src="supabase.js"></script>
    
    <script>
        // --- Global State ---
        let userLocation = { lat: null, lon: null };
        let pickupDeadline = null;
        let selectedResponseId = null;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        // --- 1. Init & Location ---
        window.onload = function() {
            loadUserData();
            createEmojis();
            // Try auto-locate on load
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((p) => {
                    userLocation = { lat: p.coords.latitude, lon: p.coords.longitude };
                });
            }
        };

        function getLocation() {
            const cityInput = document.getElementById('city');
            cityInput.value = "Î•Î½Ï„Î¿Ï€Î¹ÏƒÎ¼ÏŒÏ‚...";
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((p) => {
                    userLocation = { lat: p.coords.latitude, lon: p.coords.longitude };
                    cityInput.value = `ğŸ“ ${p.coords.latitude.toFixed(4)}, ${p.coords.longitude.toFixed(4)}`;
                    saveUserData();
                    showToast("Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î± Î²ÏÎ­Î¸Î·ÎºÎµ!", 'success');
                }, () => {
                    cityInput.value = ""; showToast("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±.", 'error');
                });
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            if (!lat1 || !lon1 || !lat2 || !lon2) return (Math.random() * 2 + 0.2).toFixed(1); // Mock distance if missing
            const R = 6371; // Radius of earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c).toFixed(1);
        }
        function deg2rad(deg) { return deg * (Math.PI/180); }

        // --- 2. Submit & Realtime ---
        const form = document.getElementById('request-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!document.getElementById('gdpr-check').checked) { showToast("Î‘Ï€Î¿Î´ÎµÏ‡Ï„ÎµÎ¯Ï„Îµ Ï„Î¿Ï…Ï‚ ÏŒÏÎ¿Ï…Ï‚.", 'error'); return; }
            if(!window.db) { showToast("DB Error", 'error'); return; }

            // Switch to Waiting View
            document.getElementById('tab-search').classList.remove('active');
            document.getElementById('results-view').classList.remove('hidden');
            document.getElementById('responses-list').innerHTML = ''; // Clear old results

            // 1. Upload Media
            let mediaUrl = null;
            const fileInput = document.getElementById('request-image');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileName = `req_${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '')}`;
                const { data } = await window.db.storage.from('requests-media').upload(fileName, file);
                if(data) {
                    const { data: { publicUrl } } = window.db.storage.from('requests-media').getPublicUrl(fileName);
                    mediaUrl = publicUrl;
                }
            }

            // 2. Insert Request
            const { error } = await window.db.from('requests').insert([{
                medicine_name: document.getElementById('medicine').value,
                substance: document.getElementById('substance').value,
                quantity: document.getElementById('quantity').value,
                notes: document.getElementById('notes').value,
                media_url: mediaUrl,
                barcode: document.getElementById('barcode-value').value,
                location: document.getElementById('city').value,
                status: 'pending',
                created_at: new Date()
            }]);

            if (error) {
                showToast('Î£Ï†Î¬Î»Î¼Î±: ' + error.message, 'error');
                resetApp();
            } else {
                showToast("Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÏƒÎµ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î±...", 'info');
                subscribeToResponses();
            }
        });

        // --- 3. Response Listener & List Render ---
        function subscribeToResponses() {
            window.db.channel('public:responses')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'responses' }, payload => {
                addResponseCard(payload.new);
                try { new Audio('https://cdn.freesound.org/previews/536/536108_11530694-lq.mp3').play(); } catch(e){}
                showToast("ğŸ”” ÎÎ­Î± Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ¬!", 'success');
            })
            .subscribe();
        }

        function addResponseCard(resp) {
            const list = document.getElementById('responses-list');
            const dist = calculateDistance(userLocation.lat, userLocation.lon, null, null); // Mock pharmacy lat/lon for now
            
            const isGeneric = resp.message && resp.message.toLowerCase().includes('Î³ÎµÎ½ÏŒÏƒÎ·Î¼Î¿');
            const badge = isGeneric 
                ? `<span class="bg-yellow-100 text-yellow-800 text-[10px] px-2 py-1 rounded font-bold uppercase">ğŸ’Š Î“ÎµÎ½Î¿ÏƒÎ·Î¼Î¿</span>`
                : `<span class="bg-green-100 text-green-800 text-[10px] px-2 py-1 rounded font-bold uppercase">âœ… Î ÏÏ‰Ï„Î¿Ï„Ï…Ï€Î¿</span>`;

            const div = document.createElement('div');
            div.className = "bg-white dark:bg-slate-700 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-600 animate-slide-up";
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h4 class="font-bold text-slate-800 dark:text-white text-lg">Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿ #${resp.pharmacy_id.substr(0,4)}</h4>
                        <p class="text-xs text-slate-500 flex items-center gap-1"><i class="ph ph-map-pin"></i> ${dist} Ï‡Î»Î¼ Î±Ï€ÏŒ ÎµÏƒÎ¬Ï‚</p>
                    </div>
                    ${badge}
                </div>
                <p class="text-sm text-slate-600 dark:text-slate-300 mb-3 bg-slate-50 dark:bg-slate-800 p-2 rounded-lg">
                    "${resp.message || 'Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿'}"
                </p>
                <button onclick="promptSelection('${resp.id}')" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2.5 rounded-xl shadow-md transition-all flex items-center justify-center gap-2">
                    <span>ÎšÏÎ¬Ï„Î·ÏƒÎ· & Î Î±ÏÎ±Î»Î±Î²Î®</span> <i class="ph ph-arrow-right"></i>
                </button>
            `;
            list.prepend(div);
        }

        // --- 4. Selection & Disclaimer Logic ---
        function promptSelection(respId) {
            selectedResponseId = respId;
            openModal('safety'); // Show disclaimer BEFORE timer
        }

        document.getElementById('confirm-pickup-btn').addEventListener('click', () => {
            closeModal('safety');
            startPickupTimer();
        });

        function startPickupTimer() {
            document.getElementById('results-view').classList.add('hidden');
            document.getElementById('pickup-view').classList.remove('hidden');
            
            pickupDeadline = Date.now() + (60 * 60 * 1000);
            updateTimerDisplay(pickupDeadline, 0);
            
            showToast("Î— ÎºÏÎ¬Ï„Î·ÏƒÎ· Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ. ÎŸ Ï‡ÏÏŒÎ½Î¿Ï‚ Î¾ÎµÎºÎ¯Î½Î·ÏƒÎµ!", 'success');
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }

        // --- Helpers (UI, Timer, etc) ---
        function resetApp() {
            document.getElementById('pickup-view').classList.add('hidden');
            document.getElementById('results-view').classList.add('hidden');
            document.getElementById('tab-search').classList.add('active');
            document.getElementById('request-form').reset();
            clearMedia();
        }

        let timerInterval;
        function updateTimerDisplay(deadline, lastExt) {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const diff = deadline - Date.now();
                if(diff <= 0) { clearInterval(timerInterval); document.getElementById('timer-display').innerText = "00:00"; return; }
                const min = Math.floor(diff/60000); const sec = Math.floor((diff%60000)/1000);
                document.getElementById('timer-display').innerText = `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
            }, 1000);
        }

        function extendPickupTime() {
            pickupDeadline += 15 * 60000;
            document.getElementById('extend-btn').disabled = true;
            document.getElementById('extend-btn').innerText = "Î•Ï€ÎµÎºÏ„Î¬Î¸Î·ÎºÎµ (+15')";
            showToast("Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎ±Î½ 15 Î»ÎµÏ€Ï„Î¬!", 'success');
        }

        // Standard UI funcs
        function showToast(m,t='info'){const c=document.getElementById('toast-container');const d=document.createElement('div');d.className=`toast-enter p-3 rounded-xl shadow-lg bg-slate-800 text-white text-sm mb-2 border-l-4 ${t==='error'?'border-red-500':'border-teal-500'}`;d.innerText=m;c.appendChild(d);setTimeout(()=>d.remove(),3000);}
        function toggleTheme(){document.documentElement.classList.toggle('dark');}
        function toggleLang(){const f=document.getElementById('lang-flag');f.innerText=f.innerText==='ğŸ‡¬ğŸ‡·'?'ğŸ‡¬ğŸ‡§':'ğŸ‡¬ğŸ‡·';}
        function openModal(t){document.getElementById(`modal-${t}`).classList.add('active');}
        function closeModal(t){document.getElementById(`modal-${t}`).classList.remove('active');}
        function switchTab(t){document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));document.getElementById(`tab-${t}`).classList.add('active');}
        function handleFileSelect(i){if(i.files[0]){document.getElementById('preview-text').innerText=i.files[0].name;document.getElementById('media-preview').classList.remove('hidden');}}
        function clearMedia(){document.getElementById('media-preview').classList.add('hidden');document.getElementById('request-image').value='';}
        
        // Voice & Scanner Stubs
        function startVoiceInput(){ showToast("Listening...", 'info'); setTimeout(()=>{document.getElementById('medicine').value="Depon";showToast("Heard: Depon", 'success');},1500); }
        function toggleScanner(){ document.getElementById('scanner-container').classList.remove('hidden'); setTimeout(()=>{document.getElementById('barcode-value').value="123456";document.getElementById('preview-text').innerText="Barcode: 123456";document.getElementById('media-preview').classList.remove('hidden');document.getElementById('scanner-container').classList.add('hidden');},1500); }
        function saveUserData(){ localStorage.setItem('mr_u', JSON.stringify({n:document.getElementById('full-name').value,p:document.getElementById('phone').value,c:document.getElementById('city').value})); }
        function loadUserData(){ const d=JSON.parse(localStorage.getItem('mr_u')||'{}'); if(d.n)document.getElementById('full-name').value=d.n; if(d.p)document.getElementById('phone').value=d.p; if(d.c)document.getElementById('city').value=d.c; }
        function createEmojis(){ /* Background emojis logic */ }
    </script>
</body>
</html>
