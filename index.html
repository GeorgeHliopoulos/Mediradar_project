<!DOCTYPE html>
<html lang="el" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MediRadar</title>

  <!-- Favicon (inline για να μην έχεις 404) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect rx='14' width='64' height='64' fill='%2329a3a3'/%3E%3Cpath d='M30 8h4v7a15 15 0 0 1 15 15h7v4h-7a15 15 0 0 1-15 15v7h-4v-7a15 15 0 0 1-15-15h-7v-4h7a15 15 0 0 1 15-15z' fill='white'/%3E%3Ccircle cx='32' cy='30' r='8' fill='white'/%3E%3C/svg%3E">

  <!-- Android/Chrome PWA -->
  <meta name="mobile-web-app-capable" content="yes">
  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <!-- env.js MUST be the first script so window.ENV is ready for all subsequent modules -->
  <script src="/env.js"></script>
  <script>
    (function ensurePublicEnv(){
      const env = window.ENV || {};
      const missing = !env.SUPABASE_URL || !env.SUPABASE_ANON_KEY;
      if (!missing) return;

      const message = 'Λείπουν τα public Supabase keys (SUPABASE_URL, SUPABASE_ANON_KEY). Ρύθμισέ τα στα Netlify Environment variables (Deploy previews) ώστε να δημιουργείται το env.js πριν φορτώσει η εφαρμογή.';
      window.__ENV_LOAD_ERROR = true;
      window.__ENV_LOAD_ERROR_MESSAGE = message;

      const showError = () => {
        const banner = document.querySelector('[data-env-error]');
        if (banner) {
          banner.classList.remove('hidden');
          banner.style.display = 'block';
          banner.setAttribute('role', 'alert');
          const text = banner.querySelector('[data-env-error-text]');
          if (text) {
            text.innerHTML = `<strong class="block text-base">Ρύθμιση περιβάλλοντος απαιτείται</strong><span class="block mt-1 text-sm">${message}</span>`;
          }
        } else if (document.body) {
          const fallback = document.createElement('div');
          fallback.style.cssText = 'background:#fee2e2;color:#7f1d1d;padding:16px;text-align:center;font-weight:600;';
          fallback.textContent = message;
          document.body.prepend(fallback);
        }
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', showError);
      } else {
        showError();
      }

      console.error(message);
      throw new Error('Missing public Supabase configuration');
    })();
  </script>

  <!-- Tailwind (dev με CDN). Για production build θα το αλλάξουμε σε PostCSS/CLI. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: { brand: { 500:'#29a3a3', 600:'#208181', 700:'#196464' } },
          boxShadow: { soft:'0 16px 40px rgba(2,6,23,.12)' }
        }
      }
    }
  </script>

  <style>
    .app-bg{
      background:
        radial-gradient(1100px 600px at 0% -10%, rgba(132,197,244,.30), transparent 60%),
        radial-gradient(900px 540px at 110% 0%, rgba(199,166,244,.22), transparent 58%),
        radial-gradient(1000px 600px at 25% 120%, rgba(247,141,167,.18), transparent 62%),
        radial-gradient(800px 520px at 120% 120%, rgba(157,224,214,.20), transparent 60%),
        linear-gradient(180deg, #f6fbfb 0%, #f8fafc 40%, #fbfcfe 100%);
    }
    .dark .app-bg{
      background:
        radial-gradient(1100px 600px at 0% -10%, rgba(132,197,244,.16), transparent 60%),
        radial-gradient(900px 540px at 110% 0%, rgba(199,166,244,.14), transparent 58%),
        radial-gradient(1000px 600px at 25% 120%, rgba(247,141,167,.12), transparent 62%),
        radial-gradient(800px 520px at 120% 120%, rgba(157,224,214,.12), transparent 60%),
        linear-gradient(180deg, #0b1515, #0b1515 45%, #0b1515 100%);
    }
    .ac-list { position:absolute; inset-inline:0; top:100%; z-index:40 }
    .ac-item { cursor:pointer }
    .badge { display:inline-flex; align-items:center; gap:6px; padding:.25rem .5rem; border-radius:999px; font-size:.75rem; }
    @keyframes spinHourglass { 0%{transform:rotate(0)} 50%{transform:rotate(180deg)} 100%{transform:rotate(360deg)} }
    /* μικρό, διακριτικό toast για ειδοποιήσεις */
    #push-toast { transition: transform .25s ease, opacity .25s ease; }
    #push-toast.hidden { opacity:0; pointer-events:none; transform: translateY(6px); }
  </style>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#29a3a3" />
</head>
<body class="min-h-full app-bg text-slate-900 dark:text-slate-200 font-sans">

  <div data-env-error class="hidden" style="display:none;">
    <div class="mx-auto max-w-3xl px-4 py-3 rounded-b-2xl border border-red-200 bg-red-100/90 text-red-900 shadow-lg">
      <div data-env-error-text class="text-sm leading-relaxed font-medium"></div>
    </div>
  </div>

  <div id="diagnostics-modal" class="hidden fixed inset-0 z-[80] bg-black/60 backdrop-blur-sm p-4 items-center justify-center">
    <div class="w-full max-w-3xl max-h-[90vh] overflow-y-auto rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-950 shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200 dark:border-slate-800">
        <h2 class="text-lg font-bold">Diagnostics</h2>
        <div class="flex items-center gap-2">
          <button id="diagnostics-refresh" class="px-3 py-1.5 rounded-xl border border-slate-200 dark:border-slate-700 text-xs font-semibold bg-white/70 dark:bg-slate-900/40 hover:bg-white">Run check</button>
          <button id="diagnostics-close" class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800">✕</button>
        </div>
      </div>
      <div class="px-5 py-4 space-y-4 text-sm">
        <p class="text-slate-600 dark:text-slate-400">Χρησιμοποίησε τον έλεγχο για να επιβεβαιώσεις ότι τα public Supabase keys φορτώθηκαν και ότι η REST API απαντά σωστά.</p>
        <div>
          <div class="font-semibold">window.ENV</div>
          <pre id="diagnostics-env" class="mt-2 rounded-xl bg-slate-900/90 text-slate-100 text-xs p-3 whitespace-pre-wrap break-all">(pending)</pre>
        </div>
        <div>
          <div class="font-semibold">REST probe</div>
          <p class="text-xs text-slate-500">GET <span id="diagnostics-rest-url" class="break-all"></span></p>
          <div class="mt-2 text-xs">Status: <span id="diagnostics-rest-status">—</span></div>
          <pre id="diagnostics-rest-body" class="mt-2 rounded-xl bg-slate-100 dark:bg-slate-900/60 p-3 text-xs whitespace-pre-wrap break-all">(pending)</pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Confetti -->
  <canvas id="confetti" class="fixed inset-0 pointer-events-none z-[60]" style="display:none;"></canvas>

  <!-- Top bar -->
  <div class="absolute top-3 left-3 right-3 z-50">
    <div class="ml-auto w-fit flex items-center gap-2 rounded-2xl bg-white/80 dark:bg-white/10 border border-slate-200 dark:border-slate-700 backdrop-blur px-2 py-1">
      <a href="/pharmacy.html" class="hidden sm:inline text-sm px-2 py-1 rounded-lg hover:bg-white/70 dark:hover:bg-white/20" id="t-pro">Για επαγγελματίες</a>

      <!-- Language with flags -->
      <div class="flex items-center rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700">
        <button id="lang-el" class="px-2 py-1.5 text-xs font-semibold bg-white/70 dark:bg-white/10 flex items-center gap-1">
          <span aria-hidden="true">🇬🇷</span> EL
        </button>
        <button id="lang-en" class="px-2 py-1.5 text-xs font-semibold opacity-90 hover:opacity-100 flex items-center gap-1">
          <span aria-hidden="true">🇬🇧</span> EN
        </button>
      </div>

      <button id="diagnostics-open" data-diagnostics-open class="hidden sm:inline px-2 py-1.5 rounded-xl text-xs font-semibold hover:bg-white/70 dark:hover:bg-white/20">Diagnostics</button>

      <!-- Theme -->
      <button id="theme-toggle" class="px-2 py-1.5 rounded-xl hover:bg-white/70 dark:hover:bg-white/20">
        <span id="icon-sun" class="hidden">🌞</span><span id="icon-moon">🌙</span>
      </button>
    </div>
  </div>

  <!-- Pending toast -->
  <div id="pending-toast" class="hidden fixed top-16 left-1/2 -translate-x-1/2 z-40 w-[min(760px,92vw)] pointer-events-none">
    <div class="pointer-events-auto rounded-2xl p-4 border border-amber-300/70 bg-amber-50 text-amber-900 dark:bg-amber-900/30 dark:text-amber-100 dark:border-amber-800 shadow-soft">
      <div class="flex items-center gap-4">
        <div class="text-4xl" style="animation:spinHourglass 1.2s linear infinite">⏳</div>
        <div class="text-sm sm:text-base">
          <div id="t-pending">Περιμένουμε απαντήσεις από τα κοντινά φαρμακεία…</div>
          <div class="mt-1 font-semibold opacity-80"><span id="wait-elapsed">0s</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- μικρό push toast -->
  <div id="push-toast" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 z-40 w-[min(680px,94vw)]">
    <div class="rounded-2xl p-4 border border-sky-300/70 bg-sky-50 text-sky-900 dark:bg-sky-900/30 dark:text-sky-100 dark:border-sky-800 shadow-soft flex items-center justify-between gap-3">
      <div class="text-sm">
        🔔 Θες να λαμβάνεις ειδοποίηση όταν απαντά ένα φαρμακείο;
      </div>
      <div class="flex gap-2">
        <button id="push-deny" class="px-3 py-1.5 rounded-xl border hover:bg-white/70 dark:hover:bg-white/10 text-sm">Όχι τώρα</button>
        <button id="push-allow" class="px-3 py-1.5 rounded-xl bg-brand-600 text-white font-semibold text-sm">Ενεργοποίηση</button>
      </div>
    </div>
  </div>

  <!-- SPLASH -->
  <section id="splash" class="min-h-[100svh] grid place-items-center relative px-4">
    <div class="w-full max-w-4xl text-center">
      <div class="mx-auto w-24 h-24 rounded-3xl bg-brand-600 text-white grid place-items-center shadow-soft">
        <svg viewBox="0 0 24 24" class="w-10 h-10" aria-hidden="true">
          <path fill="currentColor" d="M11 2h2v3.06A7 7 0 0 1 18.94 11H22v2h-3.06A7 7 0 0 1 13 18.94V22h-2v-3.06A7 7 0 0 1 5.06 13H2v-2h3.06A7 7 0 0 1 11 5.06V2Zm1 5a5 5 0 1 0 0 10a5 5 0 0 0 0-10Z"/>
        </svg>
      </div>

      <h1 class="mt-5 text-4xl sm:text-5xl font-extrabold tracking-tight">MediRadar</h1>
      <p id="t-hero" class="mt-2 text-lg text-slate-600 dark:text-slate-400">Άμεση εύρεση διαθεσιμότητας φαρμάκων σε κοντινά φαρμακεία.</p>

      <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-4 max-w-3xl mx-auto">
        <button id="cta-search" class="px-6 py-4 rounded-2xl bg-gradient-to-r from-brand-500 to-brand-600 text-white font-semibold shadow-soft hover:opacity-95">
          <span id="t-searchBTN">Αναζήτηση Φαρμάκου</span>
        </button>
        <button id="cta-how" class="px-6 py-4 rounded-2xl bg-white/85 backdrop-blur border border-slate-200 hover:bg-white font-semibold">
          <span id="t-howBTN">Πώς λειτουργεί</span>
        </button>
        <button id="cta-signin" class="px-6 py-4 rounded-2xl bg-white/85 backdrop-blur border border-slate-200 hover:bg-white font-semibold">
          <span id="t-signinBTN">Σύνδεση</span>
        </button>
      </div>

      <button id="cta-install" class="mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-brand-600 text-brand-700 font-semibold bg-white/80 backdrop-blur hover:bg-white hidden">
        📲 <span id="t-installBTN">Εγκατάσταση</span>
      </button>

      <div class="sm:hidden mt-4 flex flex-col items-center gap-2">
        <a href="/pharmacy.html" class="text-sm underline" id="t-pro-m">Για επαγγελματίες</a>
        <button data-diagnostics-open class="text-xs px-3 py-1.5 rounded-lg border border-slate-300 bg-white/80">Diagnostics</button>
      </div>
    </div>
  </section>

  <!-- APP -->
  <main id="app" class="hidden mx-auto max-w-3xl px-4 pb-16">
    <header class="sticky top-0 z-30 -mt-3 mb-4">
      <div class="flex items-center justify-between px-2 py-3 rounded-2xl bg-white/80 dark:bg-slate-900/70 backdrop-blur border border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-2">
          <button id="backHome" class="px-3 py-1.5 rounded-lg border text-sm hover:bg-slate-50 dark:hover:bg-slate-800">← <span id="t-home">Αρχική</span></button>
          <span id="t-searchTitle" class="font-semibold">Αναζήτηση Φαρμάκου</span>
        </div>
        <a href="/pharmacy.html" class="text-sm underline underline-offset-4" id="t-pharmLogin2">Είσοδος φαρμακείου</a>
      </div>
    </header>

    <section class="grid grid-cols-1 gap-4 sm:gap-5">
      <!-- Medicine -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">🔎</span>
          <span id="t-medname">Όνομα Φαρμάκου</span>
        </label>
        <div class="mt-2 relative">
          <input id="medicine-name" type="text" autocomplete="off"
                 class="w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30 placeholder:text-slate-400"
                 placeholder="π.χ. Augmentin 875mg" />
          <div id="ac-medicine" class="ac-list hidden rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-lg"></div>
        </div>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400" id="t-formatTip">Συμβουλή: Εμπορική ονομασία + δοσολογία (π.χ. “500mg”).</p>
      </div>

      <!-- Substance -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">🧪</span>
          <span id="t-substance">Δραστική Ουσία</span> <span class="text-slate-400 ml-1" id="t-optional">(προαιρετικά)</span>
        </label>
        <div class="mt-2 relative">
          <input id="active-substance" type="text" autocomplete="off"
                 class="w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30 placeholder:text-slate-400"
                 placeholder="π.χ. Παρακεταμόλη" />
          <div id="ac-substance" class="ac-list hidden rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-lg"></div>
        </div>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400" id="t-doseEx">Παράδειγμα δοσολογίας: Paracetamol 500mg.</p>
      </div>

      <!-- Type + Quantity -->
      <div class="grid sm:grid-cols-2 gap-4">
        <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
          <label class="text-sm font-semibold flex items-center gap-2">
            <span class="w-6 h-6 grid place-items-center">💊</span>
            <span id="t-type">Τύπος Φαρμάκου</span>
          </label>
          <select id="medicine-type"
                  class="mt-2 w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30">
            <option value="">— Επιλογή —</option>
            <option>Χάπι</option><option>Κάψουλα</option><option>Σκόνη</option>
            <option>Υγρό</option><option>Σιρόπι</option><option>Σταγόνες</option>
            <option>Εισπνεόμενο</option><option>Σπρέι</option><option>Ρινικό σπρέι</option>
            <option>Οφθαλμικές σταγόνες</option><option>Αλοιφή</option><option>Δερματική Κρέμα</option>
            <option>Ζελέ</option><option>Επίθεμα</option><option>Υπόθετο</option>
            <option>Πένα (προγεμισμένη)</option><option>Διάλυμα έγχυσης</option>
          </select>
        </div>

        <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
          <label class="text-sm font-semibold flex items-center gap-2">
            <span class="w-6 h-6 grid place-items-center">📦</span>
            <span id="t-qty">Ποσότητα (τεμάχια/κουτιά)</span>
          </label>
          <input id="quantity" type="number" min="1" value="1" required
                 class="mt-2 w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30" />
        </div>
      </div>

      <!-- Generic -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <p class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">✅</span>
          <span id="t-genericQ">Αν δεν είναι διαθέσιμο το συγκεκριμένο εμπορικό, επιτρέπεις να σου προτείνουμε ισοδύναμο (γενόσημο);</span>
        </p>
        <div class="mt-3 flex gap-4">
          <label class="inline-flex items-center gap-2"><input type="radio" name="allow-generic" value="YES" class="size-4 accent-brand-600" checked><span id="t-yes">ΝΑΙ</span></label>
          <label class="inline-flex items-center gap-2"><input type="radio" name="allow-generic" value="NO" class="size-4 accent-brand-600"><span id="t-no">ΟΧΙ</span></label>
        </div>
      </div>

      <!-- City -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">📍</span>
          <span id="t-city">Πόλη</span>
        </label>
        <select id="city" required
                class="mt-2 w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30">
          <option value="">— Επιλογή —</option>
          <!-- Μεγάλα αστικά κέντρα + extra -->
          <option>Αθήνα</option><option>Πειραιάς</option><option>Θεσσαλονίκη</option>
          <option>Πάτρα</option><option>Ηράκλειο</option><option>Λάρισα</option>
          <option>Βόλος</option><option>Ιωάννινα</option><option>Χανιά</option>
          <option>Καλαμάτα</option><option>Καβάλα</option><option>Ξάνθη</option>
          <option>Κομοτηνή</option><option>Αλεξανδρούπολη</option><option>Σέρρες</option>
          <option>Τρίκαλα</option><option>Λαμία</option><option>Χαλκίδα</option>
          <option>Κόρινθος</option><option>Ρόδος</option><option>Μυτιλήνη</option>
          <option>Ρέθυμνο</option><option>Κέρκυρα</option><option>Χίος</option>
          <option>Αγρίνιο</option><option>Βέροια</option><option>Δράμα</option>
          <option>Κατερίνη</option><option>Κοζάνη</option><option>Ναύπλιο</option>
          <option>Πύργος</option><option>Γλυφάδα</option>
          <!-- Αττική – δήμοι -->
          <option>Μαρούσι</option><option>Χαλάνδρι</option><option>Κηφισιά</option>
          <option>Νέα Ιωνία</option><option>Μεταμόρφωση</option><option>Περιστέρι</option>
          <option>Αιγάλεω</option><option>Καλλιθέα</option><option>Νέα Σμύρνη</option>
          <option>Παλαιό Φάληρο</option><option>Άλιμος</option><option>Ιλίου</option>
          <option>Ζωγράφου</option><option>Γαλάτσι</option><option>Βύρωνας</option>
          <option>Δάφνη</option><option>Ηλιούπολη</option><option>Νίκαια</option>
          <option>Κορυδαλλός</option><option>Πετρούπολη</option><option>Αργυρούπολη</option>
          <option>Ηράκλειο Αττικής</option><option>Νέα Φιλαδέλφεια</option><option>Νέα Χαλκηδόνα</option>
          <!-- Κρήτη extra -->
          <option>Σητεία</option><option>Ιεράπετρα</option><option>Άγιος Νικόλαος</option>
          <!-- Νησιά extra -->
          <option>Κως</option><option>Σάμος</option><option>Σύρος</option><option>Πάρος</option><option>Νάξος</option>
        </select>
      </div>

      <!-- GDPR + Submit -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="inline-flex items-start gap-3">
          <input id="gdpr-checkbox" type="checkbox" required class="mt-0.5 size-5 accent-brand-600">
          <span class="text-sm"><span id="t-accept">Αποδέχομαι τους</span> <button type="button" id="gdpr-open" class="underline text-brand-700">Όρους Αναζήτησης & GDPR</button>.</span>
        </label>
        <div class="mt-4 flex justify-end">
          <button id="submitBtn" class="px-5 py-3 rounded-2xl bg-gradient-to-r from-brand-500 to-brand-600 text-white font-semibold shadow-soft hover:opacity-95">
            <span id="t-submit">Υποβολή Αναζήτησης</span>
          </button>
        </div>
      </div>
    </section>

    <!-- Self pick-up timer -->
    <section id="pickup-box" class="hidden mt-6">
      <div class="rounded-2xl p-4 border border-emerald-300 bg-emerald-50 text-emerald-900 dark:bg-emerald-900/20 dark:text-emerald-100 dark:border-emerald-800">
        <div class="flex items-center justify-between flex-wrap gap-2">
          <div class="text-sm">
            ✅ <strong>Self pick-up</strong> • <span id="pickup-timer">60:00</span>
            <span class="ml-2 text-slate-500 dark:text-slate-400">– Ελέγξτε το ωράριο του φαρμακείου</span>
          </div>
          <button id="extend-btn" class="px-3 py-1.5 rounded-lg border border-emerald-600 text-emerald-700 dark:text-emerald-200 hover:bg-emerald-100/60 dark:hover:bg-emerald-800/40 text-sm">Extend +15’</button>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section id="results" class="hidden mt-6">
      <h2 class="text-xl font-bold mb-3" id="t-results">Αποτελέσματα</h2>
      <div class="grid gap-3" id="resultsList"></div>
      <button id="newSearch" class="mt-4 px-4 py-2 rounded-xl border hover:bg-slate-100 dark:hover:bg-slate-800"><span id="t-newSearch">Νέα αναζήτηση</span></button>
    </section>
  </main>

  <!-- HOW -->
  <div id="modal-how" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-2xl rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200 dark:border-slate-800">
        <h3 class="text-lg font-bold" id="t-howTitle">Πώς λειτουργεί το MediRadar</h3>
        <button id="how-close" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">✕</button>
      </div>
      <div id="how-body" class="p-5 leading-relaxed text-slate-700 dark:text-slate-300"></div>
      <div class="px-5 pb-5 flex justify-end">
        <button id="how-ok" class="px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold hover:opacity-95"><span id="t-continue">Συνέχεια</span></button>
      </div>
    </div>
  </div>

  <!-- GDPR -->
  <div id="gdpr-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-3xl rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <h3 class="text-lg font-bold" id="t-gdprTitle">Πολιτική Προστασίας Δεδομένων & Όροι Αναζήτησης</h3>
        <button id="gdpr-close" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">✕</button>
      </div>
      <div id="gdpr-body" class="p-5 text-sm text-slate-700 dark:text-slate-300 space-y-3" style="max-height:62vh; overflow:auto"></div>
      <div class="px-5 pb-5 flex justify-end">
        <button id="gdpr-ok" class="px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold hover:opacity-95">OK</button>
      </div>
    </div>
  </div>

  <!-- Pharmacy details modal -->
  <div id="pharm-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-lg rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <h3 class="text-lg font-bold" id="pm-title">Φαρμακείο</h3>
        <button id="pm-close" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">✕</button>
      </div>
      <div class="p-5 space-y-2 text-sm">
        <div id="pm-address">Διεύθυνση:</div>
        <div id="pm-phone">Τηλέφωνο:</div>
      </div>
      <div class="px-5 pb-5 flex gap-2 justify-between">
        <div class="flex gap-2">
          <a id="pm-call" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">Κλήση</a>
          <a id="pm-maps" target="_blank" rel="noopener" class="px-4 py-2 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-700">Άνοιγμα σε Χάρτες</a>
        </div>
        <button id="pm-confirm" class="px-4 py-2 rounded-2xl bg-brand-600 text-white font-semibold hover:bg-brand-700">Επιβεβαίωση & Έναρξη 60’</button>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL (πελάτης) -->
  <div id="login-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4 z-[70]">
    <div class="w-full max-w-md rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200 dark:border-slate-800">
        <h3 class="text-lg font-bold">Σύνδεση</h3>
        <button id="login-close" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">✕</button>
      </div>
      <div class="p-5 space-y-3">
        <label class="block text-sm">
          Email
          <input id="login-email" type="email" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="name@email.com">
        </label>
        <label class="block text-sm">
          Κωδικός
          <input id="login-pass" type="password" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="••••••••">
        </label>

        <div class="flex items-center justify-between pt-1">
          <button id="login-email-btn" class="px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold hover:bg-brand-700">Σύνδεση</button>
          <button id="login-guest" class="text-sm underline hover:opacity-80">Συνέχεια ως επισκέπτης</button>
        </div>

        <div class="flex items-center gap-2 pt-3">
          <div class="h-px bg-slate-200 dark:bg-slate-700 flex-1"></div>
          <span class="text-xs text-slate-500">ή</span>
          <div class="h-px bg-slate-200 dark:bg-slate-700 flex-1"></div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button id="login-google" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 flex items-center justify-center gap-2">
            <span>🟢</span> Google
          </button>
          <button id="login-apple" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 flex items-center justify-center gap-2">
            <span>🍎</span> Apple
          </button>
        </div>

        <button id="login-forgot" class="block text-sm underline hover:opacity-80">Ξέχασα τον κωδικό</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const triggers = document.querySelectorAll('[data-diagnostics-open]');
      const modal = document.getElementById('diagnostics-modal');
      const closeBtn = document.getElementById('diagnostics-close');
      const refreshBtn = document.getElementById('diagnostics-refresh');
      const envPre = document.getElementById('diagnostics-env');
      const restUrlEl = document.getElementById('diagnostics-rest-url');
      const restStatusEl = document.getElementById('diagnostics-rest-status');
      const restBodyEl = document.getElementById('diagnostics-rest-body');

      if (!modal || !triggers.length) return;

      function closeModal(){
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }

      async function runDiagnostics(){
        const env = window.ENV || {};
        try {
          envPre.textContent = JSON.stringify(env, null, 2);
        } catch (err) {
          envPre.textContent = 'Unable to serialise window.ENV';
        }

        const hasKeys = !!(env.SUPABASE_URL && env.SUPABASE_ANON_KEY);
        const baseUrl = (env.SUPABASE_URL || '').replace(/\/$/, '');
        const restUrl = hasKeys ? `${baseUrl}/rest/v1/requests?select=id,created_at&limit=1` : '—';
        restUrlEl.textContent = restUrl;

        if (!hasKeys) {
          restStatusEl.textContent = 'Missing SUPABASE_URL / SUPABASE_ANON_KEY';
          restBodyEl.textContent = 'Ορίζει τα public Supabase κλειδιά στα Netlify environment variables.';
          return;
        }

        restStatusEl.textContent = 'Running…';
        restBodyEl.textContent = '…';

        try {
          const response = await fetch(restUrl, {
            headers: {
              apikey: env.SUPABASE_ANON_KEY,
              Authorization: `Bearer ${env.SUPABASE_ANON_KEY}`,
              Accept: 'application/json'
            },
            cache: 'no-store'
          });
          restStatusEl.textContent = `${response.status} ${response.statusText}`;
          const raw = await response.text();
          let display = raw;
          try {
            display = JSON.stringify(JSON.parse(raw), null, 2);
          } catch (_) {}
          restBodyEl.textContent = (display || '(empty)').slice(0, 1000);
        } catch (error) {
          restStatusEl.textContent = 'Fetch error';
          restBodyEl.textContent = String(error);
        }
      }

      function openModal(){
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        runDiagnostics();
      }

      triggers.forEach((btn)=> btn.addEventListener('click', openModal));
      modal.addEventListener('click', (event)=>{ if (event.target === modal) closeModal(); });
      closeBtn?.addEventListener('click', closeModal);
      refreshBtn?.addEventListener('click', runDiagnostics);
      document.addEventListener('keydown', (event)=>{
        if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
          closeModal();
        }
      });
    })();
  </script>

  <!-- Supabase client -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    if (window.__ENV_LOAD_ERROR) {
      throw new Error(window.__ENV_LOAD_ERROR_MESSAGE || 'Missing Supabase environment configuration');
    }
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.ENV || {};
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      throw new Error('Missing Supabase environment configuration');
    }
    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- App JS -->
  <script>
    (function(){
      if (window.__ENV_LOAD_ERROR) {
        return;
      }

    /* ========== Theme ========== */
    const html = document.documentElement;
    const themeBtn = document.getElementById('theme-toggle');
    const iconSun = document.getElementById('icon-sun');
    const iconMoon = document.getElementById('icon-moon');
    function setTheme(mode){
      const dark = mode==='dark';
      html.classList.toggle('dark', dark);
      iconSun.classList.toggle('hidden', !dark);
      iconMoon.classList.toggle('hidden', dark);
      localStorage.setItem('mediradar-theme', dark?'dark':'light');
    }
    setTheme(localStorage.getItem('mediradar-theme') || (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
    themeBtn.addEventListener('click',()=> setTheme(html.classList.contains('dark')?'light':'dark'));

    /* ========== i18n ========== */
    const strings = {
      el:{hero:'Άμεση εύρεση διαθεσιμότητας φαρμάκων σε κοντινά φαρμακεία.',searchBTN:'Αναζήτηση Φαρμάκου', howBTN:'Πώς λειτουργεί', signinBTN:'Σύνδεση', installBTN:'Εγκατάσταση',searchTitle:'Αναζήτηση Φαρμάκου', home:'Αρχική', medname:'Όνομα Φαρμάκου', formatTip:'Συμβουλή: Εμπορική ονομασία + δοσολογία (π.χ. “500mg”).',substance:'Δραστική Ουσία', optional:'(προαιρετικά)', doseEx:'Παράδειγμα δοσολογίας: Paracetamol 500mg.', type:'Τύπος Φαρμάκου', qty:'Ποσότητα (τεμάχια/κουτιά)', select:'Επιλογή', genericQ:'Αν δεν είναι διαθέσιμο το συγκεκριμένο εμπορικό, επιτρέπεις να σου προτείνουμε ισοδύναμο (γενόσημο);', yes:'ΝΑΙ', no:'ΟΧΙ', city:'Πόλη', accept:'Αποδέχομαι τους', submit:'Υποβολή Αναζήτησης', results:'Αποτελέσματα', newSearch:'Νέα αναζήτηση', pro:'Για επαγγελματίες', howTitle:'Πώς λειτουργεί το MediRadar', continue:'Συνέχεια', pending:'Περιμένουμε απαντήσεις από τα κοντινά φαρμακεία…', pharmLogin:'Είσοδος φαρμακείων'},
      en:{hero:'Instant availability check at nearby pharmacies.',searchBTN:'Medicine Search', howBTN:'How it works', signinBTN:'Sign in', installBTN:'Install',searchTitle:'Medicine Search', home:'Home', medname:'Medicine Name', formatTip:'Tip: Brand name + dosage (e.g. “500mg”).',substance:'Active Substance', optional:'(optional)', doseEx:'Dosage example: Paracetamol 500mg.', type:'Medicine Type', qty:'Quantity (units/boxes)', select:'Select', genericQ:'If the specific brand is unavailable, may we suggest an equivalent (generic)?', yes:'YES', no:'NO', city:'City', accept:'I accept the', submit:'Submit Search', results:'Results', newSearch:'New search', pro:'For professionals', howTitle:'How MediRadar works', continue:'Continue', pending:'Waiting for responses from nearby pharmacies…', pharmLogin:'Pharmacy login'}
    };
    const state = { lang: localStorage.getItem('mediradar-lang') || 'el' };
    function t(k){ return strings[state.lang][k]; }
    function setText(id, txt){ const el=document.getElementById(id); if(el) el.textContent=txt; }
    function setHTML(id, html){ const el=document.getElementById(id); if(el) el.innerHTML=html; }
    function applyLang(){
      document.documentElement.lang = state.lang;
      setText('t-hero', t('hero'));
      setText('t-searchBTN', t('searchBTN')); setText('t-howBTN', t('howBTN')); setText('t-signinBTN', t('signinBTN')); setText('t-installBTN', t('installBTN'));
      setText('t-searchTitle', t('searchTitle')); setText('t-home', t('home'));
      setText('t-medname', t('medname')); setText('t-formatTip', t('formatTip'));
      setText('t-results', t('results')); setText('t-newSearch', t('newSearch')); setText('t-pending', t('pending'));
      setText('t-pro', t('pro')); setText('t-pro-m', t('pro')); setText('t-pharmLogin2', t('pharmLogin'));
      setText('t-howTitle', t('howTitle')); setText('t-continue', t('continue'));
      document.getElementById('medicine-name').placeholder = state.lang==='el'?'π.χ. Augmentin 875mg':'e.g. Augmentin 875mg';
      document.getElementById('active-substance').placeholder = state.lang==='el'?'π.χ. Paracetamol':'e.g. Paracetamol';
      localStorage.setItem('mediradar-lang', state.lang);
    }
    document.getElementById('lang-el').addEventListener('click', ()=>{ state.lang='el'; applyLang(); });
    document.getElementById('lang-en').addEventListener('click', ()=>{ state.lang='en'; applyLang(); });

    /* ========== Navigation ========== */
    const splash = document.getElementById('splash');
    const app = document.getElementById('app');
    document.getElementById('cta-search').addEventListener('click', ()=>{ splash.classList.add('hidden'); app.classList.remove('hidden'); window.scrollTo({ top: 0, behavior:'smooth' }); });
    document.getElementById('backHome').addEventListener('click', (e)=>{ e.preventDefault(); stopPickupTimer(); app.classList.add('hidden'); splash.classList.remove('hidden'); hidePending(); document.getElementById('results').classList.add('hidden'); document.getElementById('pickup-box').classList.add('hidden'); });

    /* ========== Modals (How/GDPR/Login) ========== */
    const modalHow = document.getElementById('modal-how');
    document.getElementById('cta-how').onclick = ()=> {
      modalHow.classList.remove('hidden'); modalHow.classList.add('flex');
      const body = state.lang==='el' ? `<ol class="list-decimal pl-5 space-y-2">
          <li>Πληκτρολόγησε τι ψάχνεις (εμπορική ονομασία ή/και δραστική ουσία).</li>
          <li>Η αίτηση στέλνεται στα κοντινά φαρμακεία.</li>
          <li>Όποιο έχει <strong>διαθεσιμότητα</strong> απαντά θετικά· αν έχει μόνο γενόσημο, θα το δεις με ειδικό σήμα.</li>
          <li>Επιλέγεις φαρμακείο και πας για <strong>self pick-up</strong>.</li>
          <li>Δεν συλλέγουμε τιμές· μόνο διαθεσιμότητα.</li></ol>`
        : `<ol class="list-decimal pl-5 space-y-2">
          <li>Type what you need (brand / active).</li>
          <li>Your request goes to nearby pharmacies.</li>
          <li>Those with <strong>availability</strong> reply “Available”; if generic only, you’ll see a badge.</li>
          <li>Pick a pharmacy and go for <strong>self pick-up</strong>.</li>
          <li>No prices collected—availability only.</li></ol>`;
      document.getElementById('how-body').innerHTML = body;
    };
    document.getElementById('how-close').onclick = ()=> modalHow.classList.add('hidden');
    document.getElementById('how-ok').onclick    = ()=> modalHow.classList.add('hidden');

    const modalGdpr = document.getElementById('gdpr-modal');
    document.getElementById('gdpr-open').onclick = ()=> { modalGdpr.classList.remove('hidden'); modalGdpr.classList.add('flex'); };
    document.getElementById('gdpr-close').onclick= ()=> modalGdpr.classList.add('hidden');
    document.getElementById('gdpr-ok').onclick   = ()=> modalGdpr.classList.add('hidden');

    const loginModal = document.getElementById('login-modal');
    document.getElementById('cta-signin').onclick = ()=>{ loginModal.classList.remove('hidden'); loginModal.classList.add('flex'); };
    document.getElementById('login-close').onclick = ()=> loginModal.classList.add('hidden');
    document.getElementById('login-email-btn').onclick = ()=> loginModal.classList.add('hidden');
    document.getElementById('login-google').onclick = ()=> loginModal.classList.add('hidden');
    document.getElementById('login-apple').onclick  = ()=> loginModal.classList.add('hidden');
    document.getElementById('login-guest').onclick  = ()=> loginModal.classList.add('hidden');
    document.getElementById('login-forgot').onclick = ()=> alert('Θα προστεθεί ροή υπενθύμισης κωδικού.');

    /* ========== Autocomplete (demo) ========== */
    const AC_MEDICINES = [
      'Augmentin 875mg/125mg','Depon 500mg','Panadol 500mg','Nurofen 400mg','Algofren 400mg',
      'Zylapour 300mg','Salospir 100mg','Plavix 75mg','Zyrtec 10mg','Vibramycin 100mg',
      'Losec 20mg','Xanax 0.5mg','Amoxil 1000mg','Clavulin 875/125mg','Aspirin Protect 100mg',
      'Voltaren 50mg','Neurofen Express 400mg','Prospan Sirup','Synagis 100mg','Otrivin 0.1% Spray',
      'Betadine 10%','Fucidin 2%','Daktarin Gel','Gaviscon Double Action','Imodium 2mg'
    ];
    const AC_SUBSTANCES = [
      'Paracetamol 500mg','Ibuprofen 400mg','Amoxicillin 500mg','Amoxicillin/Clavulanate 875/125mg',
      'Cetirizine 10mg','Acetylsalicylic acid 100mg','Doxycycline 100mg','Omeprazole 20mg',
      'Loratadine 10mg','Metformin 1000mg','Atorvastatin 20mg','Levocetirizine 5mg'
    ];
    function attachAutocomplete(inputId, listId, data){
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      let idx = -1;
      function render(items){
        list.innerHTML = items.map((x,i)=>`<div class="ac-item px-3 py-2 text-sm hover:bg-brand-50 dark:hover:bg-slate-800 ${i===idx?'bg-brand-50 dark:bg-slate-800':''}" data-val="${x}">${x}</div>`).join('');
        list.classList.toggle('hidden', items.length===0);
      }
      function filter(q){ if(!q){ render([]); return; } render(data.filter(s=>s.toLowerCase().includes(q.toLowerCase())).slice(0,10)); }
      input.addEventListener('input', ()=>{ idx=-1; filter(input.value.trim()); });
      input.addEventListener('keydown', (e)=>{
        const items = [...list.querySelectorAll('.ac-item')]; if(!items.length) return;
        if(e.key==='ArrowDown'){ idx=(idx+1)%items.length; render(items.map(n=>n.dataset.val)); e.preventDefault(); }
        else if(e.key==='ArrowUp'){ idx=(idx-1+items.length)%items.length; render(items.map(n=>n.dataset.val)); e.preventDefault(); }
        else if(e.key==='Enter'){ if(idx>=0){ input.value = items[idx].dataset.val; render([]); } }
        else if(e.key==='Escape'){ render([]); }
      });
      list.addEventListener('click', (e)=>{ const item = e.target.closest('.ac-item'); if(!item) return; input.value = item.dataset.val; list.classList.add('hidden'); });
      document.addEventListener('click', (e)=>{ if(!list.contains(e.target) && e.target!==input){ list.classList.add('hidden'); }});
    }
    attachAutocomplete('medicine-name','ac-medicine',AC_MEDICINES);
    attachAutocomplete('active-substance','ac-substance',AC_SUBSTANCES);

    /* ========== Pending + Confetti ========== */
    const pendingToast=document.getElementById('pending-toast'), waitSpan=document.getElementById('wait-elapsed');
    let waitT=null, waitStart=0;
    function showPending(){ waitStart=Date.now(); pendingToast.classList.remove('hidden'); if(waitT) clearInterval(waitT); waitT=setInterval(()=>{waitSpan.textContent=Math.floor((Date.now()-waitStart)/1000)+'s'},500); window.scrollTo({top:0,behavior:'smooth'}) }
    function hidePending(){ pendingToast.classList.add('hidden'); if(waitT){clearInterval(waitT); waitT=null;} }
    function fireConfetti(ms=3500){
      const c=document.getElementById('confetti'),ctx=c.getContext('2d');
      const W=c.width=innerWidth,H=c.height=innerHeight; c.style.display='block';
      const N=180,P=Array.from({length:N},()=>({x:Math.random()*W,y:-20-Math.random()*H*.3,r:2+Math.random()*4,vx:-1+Math.random()*2,vy:2+Math.random()*3,a:Math.random()*Math.PI,va:-.2+Math.random()*.4}));
      let run=true; const end=performance.now()+ms;
      (function loop(t){ if(t>end) run=false;
        ctx.clearRect(0,0,W,H);
        P.forEach(p=>{ if(run) p.vy+=.02; p.x+=p.vx; p.y+=p.vy; p.a+=p.va;
          if(p.y>H+20){p.y=-20;p.x=Math.random()*W;p.vy=2+Math.random()*3}
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a);
          ctx.fillStyle=`hsl(${(p.x/W)*360},90%,55%)`; ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2); ctx.restore();
        });
        if(run) requestAnimationFrame(loop); else { c.style.display='none'; ctx.clearRect(0,0,W,H); }
      })(performance.now());
    }

    /* ========== Supabase helpers ========== */
    function sb(){ return window.supabase; }
    function hasSupabase(){ return !!(window.supabase && window.ENV && window.ENV.SUPABASE_URL); }
    const LS_REQ = 'mr:lastRequest';

    /* ========== Results + Pharmacy modal + Pickup timer ========== */
    const results = document.getElementById('results');
    const resultsList = document.getElementById('resultsList');
    const pickupBox=document.getElementById('pickup-box');
    const pickupTimerEl=document.getElementById('pickup-timer');
    const extendBtn=document.getElementById('extend-btn');
    let pInt=null, remaining=0, pollInt=null;

    function fmt(s){const m=String(Math.floor(s/60)).padStart(2,'0'), ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`;}
    function stopPickupTimer(){ if(pInt){clearInterval(pInt); pInt=null;} pickupBox.classList.add('hidden'); }
    function startPickupTimer(sec){
      remaining=sec; pickupBox.classList.remove('hidden'); pickupTimerEl.textContent=fmt(remaining);
      const last=localStorage.getItem('pickup-extend-date'); const today=new Date().toISOString().slice(0,10);
      extendBtn.disabled=(last===today); extendBtn.classList.toggle('opacity-50',extendBtn.disabled);
      if(pInt) clearInterval(pInt);
      pInt=setInterval(()=>{remaining--; if(remaining<=0){stopPickupTimer(); return;} pickupTimerEl.textContent=fmt(remaining)},1000);
    }
    extendBtn.onclick=async ()=>{
      if(extendBtn.disabled) return;
      remaining+=15*60; pickupTimerEl.textContent=fmt(remaining);
      localStorage.setItem('pickup-extend-date', new Date().toISOString().slice(0,10));
      extendBtn.disabled=true; extendBtn.classList.add('opacity-50');
      if(hasSupabase() && window.currentRequest?.id){
        const newUntil = new Date(Date.now()+remaining*1000).toISOString();
        await sb().from('requests').update({ pickup_until: newUntil }).eq('id', window.currentRequest.id);
      }
    };

    const pm = document.getElementById('pharm-modal');
    const pmTitle = document.getElementById('pm-title');
    const pmAddr  = document.getElementById('pm-address');
    const pmPhone = document.getElementById('pm-phone');
    const pmCall  = document.getElementById('pm-call');
    const pmMaps  = document.getElementById('pm-maps');
    const pmConfirm = document.getElementById('pm-confirm');
    document.getElementById('pm-close').onclick = ()=> pm.classList.add('hidden');

    /* ========== CREATE REQUEST ========== */
    async function createRequest(payload){
      if(!hasSupabase()) throw new Error('NO_DB');
      const { data, error } = await sb().from('requests').insert({
        status: 'pending',
        med_name: payload.med_name,
        active_substance: payload.active_substance || null,
        med_type: payload.med_type || null,
        quantity: payload.quantity,
        allow_generic: payload.allow_generic,
        city: payload.city
      }).select('id,created_at').single();   // status_token αφαιρέθηκε
      if(error) throw error;
      return data;
    }

    /* ========== POLLING RESPONSES ========== */
    async function fetchResponses(requestId){
      const { data: rows, error } = await sb()
        .from('responses')
        .select('id, request_id, is_generic, pharmacy_id, available')
        .eq('request_id', requestId)
        .eq('available', true);

      if(error) throw error;
      if(!rows || !rows.length) return [];

      const pharmacyIds = [...new Set(rows.map(r=>r.pharmacy_id).filter(Boolean))];
      let pharmacies = [];
      if(pharmacyIds.length){
        const { data: phs } = await sb()
          .from('pharmacies')
          .select('id,name,address,phone,hours_json,lat,lng')
          .in('id', pharmacyIds);
        pharmacies = phs || [];
      }
      const byId = Object.fromEntries(pharmacies.map(p=>[p.id, p]));
      return rows.map(r=>({
        id: r.id,
        is_generic: !!r.is_generic,
        pharmacy: byId[r.pharmacy_id] || { id:r.pharmacy_id, name:'Φαρμακείο', address:'—', phone:'—' }
      }));
    }

    function renderResults(items){
      resultsList.innerHTML='';
      items.forEach(item=>{
        const ph=item.pharmacy;
        const card = document.createElement('div');
        card.className = 'rounded-xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 flex items-center justify-between';
        card.innerHTML = `
          <div>
            <div class="font-semibold">${ph.name || 'Φαρμακείο'}</div>
            <div class="text-xs text-slate-600 dark:text-slate-400">${ph.address || '—'}</div>
            ${item.is_generic ? `<div class="mt-1"><span class="badge bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-200">🧬 Γενόσημο</span></div>` : ''}
          </div>
          <div class="flex items-center gap-2">
            <button class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm select-pharm">Επιλογή</button>
          </div>`;
        card.dataset.name = ph.name || 'Φαρμακείο';
        card.dataset.addr = ph.address || '';
        card.dataset.tel  = ph.phone || '';
        card.dataset.lat  = ph.lat || '';
        card.dataset.lng  = ph.lng || '';
        resultsList.appendChild(card);
      });
      results.classList.remove('hidden');
      window.scrollTo({ top: results.offsetTop - 20, behavior:'smooth' });
    }

    resultsList.addEventListener('click', (e)=>{
      const btn = e.target.closest('.select-pharm'); if(!btn) return;
      const card = btn.closest('div.rounded-xl');
      const selectedPharmacy = {name:card.dataset.name, addr:card.dataset.addr, tel:card.dataset.tel, lat:card.dataset.lat, lng:card.dataset.lng};
      pmTitle.textContent = selectedPharmacy.name;
      pmAddr.textContent  = (state.lang==='el'?'Διεύθυνση: ':'Address: ') + (selectedPharmacy.addr || '—');
      pmPhone.textContent = (state.lang==='el'?'Τηλέφωνο: ':'Phone: ') + (selectedPharmacy.tel || '—');
      pmCall.href = selectedPharmacy.tel ? `tel:${selectedPharmacy.tel.replace(/\s+/g,'')}` : '#';
      pmMaps.href = `https://www.google.com/maps?q=${encodeURIComponent(selectedPharmacy.addr||selectedPharmacy.name)}${selectedPharmacy.lat?`@${selectedPharmacy.lat},${selectedPharmacy.lng},17z`:''}`;
      pm.classList.remove('hidden'); pm.classList.add('flex');
    });

    document.getElementById('pm-close').onclick = ()=> pm.classList.add('hidden');
    document.getElementById('pm-confirm').onclick = async ()=>{
      pm.classList.add('hidden');
      const sec = 60*60;
      startPickupTimer(sec);
      if(hasSupabase() && window.currentRequest?.id){
        const untilISO = new Date(Date.now()+sec*1000).toISOString();
        await sb().from('requests').update({ status:'reserved', pickup_until: untilISO }).eq('id', window.currentRequest.id);
      }
      document.getElementById('pickup-box').scrollIntoView({behavior:'smooth',block:'start'});
    };

    document.getElementById('newSearch').addEventListener('click', ()=>{
      results.classList.add('hidden'); window.scrollTo({ top: 0, behavior:'smooth' });
    });

    /* ========== SUBMIT FLOW ========== */
    document.getElementById('submitBtn').addEventListener('click', async (e)=>{
      e.preventDefault();
      const med_name = document.getElementById('medicine-name').value.trim();
      const active_substance = document.getElementById('active-substance').value.trim();
      const med_type = document.getElementById('medicine-type').value || null;
      const quantity = parseInt(document.getElementById('quantity').value || '1',10);
      const allow_generic = (document.querySelector('input[name="allow-generic"]:checked')?.value==='YES');
      const city = document.getElementById('city').value;

      if(!med_name) return alert(state.lang==='el'?'Συμπλήρωσε το όνομα φαρμάκου':'Enter medicine name');
      if(!city) return alert(state.lang==='el'?'Επίλεξε πόλη':'Select city');
      if(!document.getElementById('gdpr-checkbox').checked) return alert(state.lang==='el'?'Αποδέξου τους όρους':'Accept terms');

      fireConfetti(3500);
      showPending();

      try {
        let inserted = null;
        if(hasSupabase()){
          inserted = await createRequest({ med_name, active_substance, med_type, quantity, allow_generic, city });
          window.currentRequest = inserted;
          localStorage.setItem(LS_REQ, JSON.stringify({ id: inserted.id, created_at: inserted.created_at }));
        }

        if(hasSupabase() && inserted?.id){
          if(pollInt) clearInterval(pollInt);
          const startPoll = Date.now();
          pollInt = setInterval(async ()=>{
            try{
              const items = await fetchResponses(inserted.id);
              if(items.length){
                hidePending();
                renderResults(items);
                clearInterval(pollInt); pollInt=null;
              }else if(Date.now()-startPoll > 120000){
                hidePending();
                results.classList.remove('hidden');
                resultsList.innerHTML = `<div class="text-sm text-slate-600 dark:text-slate-300 p-3 rounded-xl border">Ακόμη δεν υπάρχουν απαντήσεις. Μπορείς να αφήσεις ανοιχτή τη σελίδα• θα ενημερωθεί αυτόματα.</div>`;
                clearInterval(pollInt); pollInt=null;
              }
            }catch(err){ console.warn('poll error', err); }
          }, 3000);
        } else {
          setTimeout(()=>{
            hidePending();
            const items = [
              { pharmacy:{ name:'Φαρμακείο Ιάκωβος', address:'Ιπποκράτους 12, Αθήνα', phone:'+30 210 1234567', lat:37.984, lng:23.735 }, is_generic: allow_generic },
              { pharmacy:{ name:'Φαρμακείο Νίκη', address:'Σόλωνος 90, Αθήνα', phone:'+30 210 7654321', lat:37.983, lng:23.732 }, is_generic: false }
            ];
            renderResults(items);
          }, 4500);
        }
      } catch(err){
        console.error(err);
        hidePending();
        alert('Κάτι πήγε στραβά. Έλεγξε τα Supabase keys και τα tables.');
      }
    });

    /* ===================== Web Push (3c) ===================== */
    const pushToast = document.getElementById('push-toast');
    const btnPushAllow = document.getElementById('push-allow');
    const btnPushDeny  = document.getElementById('push-deny');

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
      return outputArray;
    }

    async function saveSubscriptionToSupabase(sub) {
      if (!hasSupabase()) return;
      // Συμβατότητα: πάρε τα keys από toJSON()
      const raw = (typeof sub.toJSON === 'function') ? sub.toJSON() : {};
      const keys = raw.keys || {};
      const row = {
        endpoint: sub.endpoint,
        p256dh: keys.p256dh || '',
        auth: keys.auth || '',
        user_agent: navigator.userAgent
      };
      // upsert με onConflict:endpoint
      const { error } = await sb().from('push_subscriptions').upsert(row, { onConflict: 'endpoint' });
      if (error) console.warn('save sub error', error);
    }

    async function ensurePushSubscribed(reg) {
      try{
        if (!('Notification' in window) || !('PushManager' in window)) return;
        const publicKey = (window.ENV && window.ENV.VAPID_PUBLIC_KEY) || '';
        if (!publicKey) return;

        if (Notification.permission === 'granted') {
          const existing = await reg.pushManager.getSubscription();
          if (existing) { await saveSubscriptionToSupabase(existing); return; }
          const sub = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(publicKey)
          });
          await saveSubscriptionToSupabase(sub);
          return;
        }
        if (Notification.permission === 'default') {
          pushToast.classList.remove('hidden');
        }
      }catch(err){ console.warn('push subscribe error', err); }
    }

    btnPushAllow?.addEventListener('click', async ()=>{
      pushToast.classList.add('hidden');
      try{
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') return;
        const reg = await navigator.serviceWorker.getRegistration();
        if (!reg) return;
        await ensurePushSubscribed(reg);
      }catch(e){ console.warn(e); }
    });
    btnPushDeny?.addEventListener('click', ()=> pushToast.classList.add('hidden'));

    /* ========== PWA install & SW update flow ========== */
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js').then(async reg => {
        if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        reg.addEventListener('updatefound', () => {
          const nw = reg.installing;
          nw?.addEventListener('statechange', () => {
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              reg.waiting?.postMessage({ type: 'SKIP_WAITING' });
            }
          });
        });
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          window.location.reload();
        });

        // 3c: push subscription
        await ensurePushSubscribed(reg);
      }).catch(console.warn);
    }
    let deferredPrompt=null;
    const installBtn = document.getElementById('cta-install');
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden');
    });
    installBtn.addEventListener('click', async ()=>{
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt=null; installBtn.classList.add('hidden');
    });

    /* ========== Init ========== */
    applyLang();
    try{
      const saved = JSON.parse(localStorage.getItem(LS_REQ) || 'null');
      if(saved?.id){ window.currentRequest = saved; }
    }catch{}
    })();
  </script>
</body>
</html>
