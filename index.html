<!DOCTYPE html>
<html lang="el" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MediRadar</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: {
            brand:{ 500:'#29a3a3',600:'#208181',700:'#196464' },
            mapblue:'#2563eb',
            google:'#4285F4', apple:'#111827'
          },
          boxShadow:{ soft:'0 16px 40px rgba(2,6,23,.12)'}
        }
      }
    }
  </script>

  <style>
    .app-bg{
      background:
        radial-gradient(1100px 600px at 0% -10%, rgba(132,197,244,.30), transparent 60%),
        radial-gradient(900px 540px at 110% 0%, rgba(199,166,244,.22), transparent 58%),
        radial-gradient(1000px 600px at 25% 120%, rgba(247,141,167,.18), transparent 62%),
        radial-gradient(800px 520px at 120% 120%, rgba(157,224,214,.20), transparent 60%),
        linear-gradient(180deg, #f6fbfb 0%, #f8fafc 40%, #fbfcfe 100%);
    }
    .dark .app-bg{
      background:
        radial-gradient(1100px 600px at 0% -10%, rgba(132,197,244,.16), transparent 60%),
        radial-gradient(900px 540px at 110% 0%, rgba(199,166,244,.14), transparent 58%),
        radial-gradient(1000px 600px at 25% 120%, rgba(247,141,167,.12), transparent 62%),
        radial-gradient(800px 520px at 120% 120%, rgba(157,224,214,.12), transparent 60%),
        linear-gradient(180deg, #0b1515, #0b1515 45%, #0b1515 100%);
    }
    .ac-list{ position:absolute; inset-inline:0; top:100%; z-index:40 }
    .ac-item{ cursor:pointer }
    .scan-frame::after{
      content:''; position:absolute; inset:8%; border:3px solid rgba(255,255,255,.85);
      border-radius:16px; box-shadow:0 0 0 100vmax rgba(0,0,0,.25); pointer-events:none;
    }
    @keyframes hourglass { 0%{transform:rotate(0)} 50%{transform:rotate(180deg)} 100%{transform:rotate(360deg)} }
    .hg{ animation:hourglass 2.2s linear infinite }
  </style>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#29a3a3" />

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ✅ SUPABASE ENV ΓΙΑ BROWSER -->
  <script>
    window.SUPABASE_URL = "https://qzerrisyowkfkmcyxmav.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZXJyaXN5b3drZmttY3l4bWF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTcxODQsImV4cCI6MjA3NTU5MzE4NH0.alkvHkOQPBTwY3daUcKAEsf4nt0kizuU3rYI2c2InPk"; // <-- βάλε το anon public key σου εδώ
  </script>
</head>
<body class="min-h-full app-bg text-slate-900 dark:text-slate-200 font-sans">
  <!-- Confetti -->
  <canvas id="confetti" class="fixed inset-0 pointer-events-none" style="display:none"></canvas>

  <!-- PRO (top-left) -->
  <a id="pro-floating" href="/pharmacy.html"
     class="fixed top-3 left-3 z-50 px-3 py-2 rounded-2xl bg-white/80 dark:bg-white/10 backdrop-blur border border-slate-200 dark:border-slate-700 hover:bg-white text-sm">
    Για επαγγελματίες
  </a>

  <!-- Lang + Theme (top-right) -->
  <div class="fixed top-3 right-3 z-50 flex items-center gap-2 rounded-2xl bg-white/80 dark:bg-white/10 border border-slate-200 dark:border-slate-700 backdrop-blur px-2 py-1">
    <div class="flex items-center rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700">
      <button id="lang-el" class="px-2 py-1.5 text-xs font-semibold flex items-center gap-1 bg-white/70 dark:bg-white/10">
        <svg width="14" height="10" viewBox="0 0 27 18" aria-hidden="true">
          <rect width="27" height="18" fill="#0D5EAF"/>
          <g fill="#fff"><rect y="2" width="27" height="2"/><rect y="6" width="27" height="2"/><rect y="10" width="27" height="2"/><rect y="14" width="27" height="2"/></g>
          <rect width="10" height="10" fill="#0D5EAF"/><rect x="4" width="2" height="10" fill="#fff"/><rect y="4" width="10" height="2" fill="#fff"/>
        </svg> EL
      </button>
      <button id="lang-en" class="px-2 py-1.5 text-xs font-semibold flex items-center gap-1 opacity-90 hover:opacity-100">
        <svg width="14" height="10" viewBox="0 0 28 20" aria-hidden="true">
          <rect width="28" height="20" fill="#012169"/>
          <path d="M0,0 L28,20 M28,0 L0,20" stroke="#fff" stroke-width="5"/>
          <path d="M0,0 L28,20 M28,0 L0,20" stroke="#C8102E" stroke-width="3"/>
          <rect x="11" width="6" height="20" fill="#fff"/><rect y="7" width="28" height="6" fill="#fff"/>
          <rect x="12" width="4" height="20" fill="#C8102E"/><rect y="8" width="28" height="4" fill="#C8102E"/>
        </svg> EN
      </button>
    </div>
    <button id="theme-toggle" class="px-2 py-1.5 rounded-xl hover:bg-white/70 dark:hover:bg-white/20">
      <span id="icon-sun" class="hidden">🌞</span><span id="icon-moon">🌙</span>
    </button>
  </div>

  <!-- SPLASH -->
  <section id="splash" class="min-h-[100svh] grid place-items-center relative px-4">
    <div class="w-full max-w-4xl text-center">
      <div class="mx-auto w-24 h-24 rounded-3xl bg-brand-600 text-white grid place-items-center shadow-soft">
        <svg viewBox="0 0 24 24" class="w-10 h-10" aria-hidden="true">
          <path fill="currentColor" d="M11 2h2v3.06A7 7 0 0 1 18.94 11H22v2h-3.06A7 7 0 0 1 13 18.94V22h-2v-3.06A7 7 0 0 1 5.06 13H2v-2h3.06A7 7 0 0 1 11 5.06V2Zm1 5a5 5 0 1 0 0 10a5 5 0 0 0 0-10Z"/>
        </svg>
      </div>

      <h1 class="mt-5 text-4xl sm:text-5xl font-extrabold tracking-tight">MediRadar</h1>
      <p id="t-hero" class="mt-2 text-lg text-slate-700 dark:text-slate-300">Άμεση εύρεση διαθεσιμότητας φαρμάκων σε κοντινά φαρμακεία.</p>

      <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-4 max-w-3xl mx-auto">
        <button id="cta-search" class="px-6 py-4 rounded-2xl bg-gradient-to-r from-brand-500 to-brand-600 text-white font-semibold shadow-soft hover:opacity-95">
          <span id="t-searchBTN">Αναζήτηση Φαρμάκου</span>
        </button>
        <button id="cta-how" class="px-6 py-4 rounded-2xl bg-white/85 dark:bg-white/10 backdrop-blur border border-slate-200 dark:border-slate-700 hover:bg-white text-slate-900 dark:text-slate-100 font-semibold">
          <span id="t-howBTN">Πώς λειτουργεί</span>
        </button>
        <button id="cta-signin" class="px-6 py-4 rounded-2xl bg-white/85 dark:bg-white/10 backdrop-blur border border-slate-200 dark:border-slate-700 hover:bg-white text-slate-900 dark:text-slate-100 font-semibold">
          <span id="t-signinBTN">Σύνδεση</span>
        </button>
      </div>

      <button id="cta-install" class="mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-brand-600 text-brand-700 dark:text-brand-200 font-semibold bg-white/80 dark:bg-white/10 backdrop-blur hover:bg-white hidden">
        📲 <span id="t-installBTN">Εγκατάσταση</span>
      </button>
    </div>
  </section>

  <!-- APP (search UI) -->
  <main id="app" class="hidden mx-auto max-w-3xl px-4 pb-16">
    <header class="sticky top-0 z-30 -mt-3 mb-4">
      <div class="flex items-center justify-between px-2 py-3 rounded-2xl bg-white/80 dark:bg-slate-900/70 backdrop-blur border border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-2">
          <a href="#" id="backHome" class="px-3 py-1.5 rounded-lg border text-sm hover:bg-slate-50 dark:hover:bg-slate-800">← <span id="t-home">Αρχική</span></a>
          <span id="t-searchTitle" class="font-semibold">Αναζήτηση Φαρμάκου</span>
        </div>
        <span class="text-sm opacity-70" id="userBadge"></span>
      </div>
    </header>

    <!-- Sticky Pending banner -->
    <div id="pendingBanner" class="hidden sticky top-[60px] z-20 mb-4">
      <div class="rounded-2xl border border-amber-300/80 bg-amber-50/95 dark:bg-amber-900/50 dark:border-amber-800 backdrop-blur px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="text-2xl hg">⌛</div>
          <div>
            <div class="font-semibold" id="t-pendingTitle">Αναμονή απαντήσεων από φαρμακεία</div>
            <div class="text-xs text-amber-800/90 dark:text-amber-100/90" id="t-pendingHint">Μείνε στη σελίδα — αν τη κλείσεις, θα συνεχίσουμε να κρατάμε την αναμονή και θα επανέλθει όταν γυρίσεις.</div>
          </div>
        </div>
        <span class="text-xs opacity-70" id="reqIdBadge"></span>
      </div>
    </div>

    <!-- Φόρμα -->
    <section class="grid grid-cols-1 gap-4 sm:gap-5">
      <!-- Medicine -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">🔎</span>
          <span id="t-medname">Όνομα Φαρμάκου</span>
        </label>
        <div class="mt-2 relative">
          <input id="medicine-name" type="text" autocomplete="off"
                 class="w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30 placeholder:text-slate-400"
                 placeholder="π.χ. Augmentin 875mg" />
          <div id="err-med" class="mt-1 text-xs text-rose-600 hidden"></div>
          <div id="ac-medicine" class="ac-list hidden rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-lg"></div>
        </div>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400" id="t-formatTip">Συμβουλή: Εμπορική ονομασία + δοσολογία (π.χ. “500mg”).</p>
      </div>

      <!-- Substance -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">🧪</span>
          <span id="t-substance">Δραστική Ουσία</span> <span class="text-slate-400 ml-1" id="t-optional">(προαιρετικά)</span>
        </label>
        <div class="mt-2 relative">
          <input id="active-substance" type="text" autocomplete="off"
                 class="w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30 placeholder:text-slate-400"
                 placeholder="π.χ. Παρακεταμόλη" />
          <div id="ac-substance" class="ac-list hidden rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-lg"></div>
        </div>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400" id="t-doseEx">Παράδειγμα δοσολογίας: Paracetamol 500mg.</p>
      </div>

      <!-- Type + Quantity -->
      <div class="grid sm:grid-cols-2 gap-4">
        <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
          <label class="text-sm font-semibold flex items-center gap-2">
            <span class="w-6 h-6 grid place-items-center">💊</span>
            <span id="t-type">Τύπος Φαρμάκου</span>
          </label>
          <select id="medicine-type"
                  class="mt-2 w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30">
            <option value="">— Επιλογή —</option>
            <option>Σκόνη</option><option>Υγρό</option><option>Χάπι</option>
            <option>Δερματική Κρέμα</option><option>Αλοιφή</option>
            <option>Πένα (προγεμισμένη)</option><option>Επίθεμα</option>
          </select>
          <div id="err-type" class="mt-1 text-xs text-rose-600 hidden"></div>
        </div>

        <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
          <label class="text-sm font-semibold flex items-center gap-2">
            <span class="w-6 h-6 grid place-items-center">📦</span>
            <span id="t-qty">Ποσότητα (τεμάχια/κουτιά)</span>
          </label>
          <input id="quantity" type="number" min="1" value="1" required
                 class="mt-2 w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30" />
          <div id="err-qty" class="mt-1 text-xs text-rose-600 hidden"></div>
        </div>
      </div>

      <!-- Generic -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <p class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">✅</span>
          <span id="t-genericQ">Αν δεν είναι διαθέσιμο το συγκεκριμένο εμπορικό, επιτρέπεις να σου προτείνουμε ισοδύναμο (γενόσημο);</span>
        </p>
        <div class="mt-3 flex gap-4">
          <label class="inline-flex items-center gap-2"><input type="radio" name="allow-generic" value="YES" class="size-4 accent-brand-600" checked><span id="t-yes">ΝΑΙ</span></label>
          <label class="inline-flex items-center gap-2"><input type="radio" name="allow-generic" value="NO" class="size-4 accent-brand-600"><span id="t-no">ΟΧΙ</span></label>
        </div>
      </div>

      <!-- City -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">📍</span>
          <span id="t-city">Πόλη</span>
        </label>
        <select id="city" required
                class="mt-2 w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-500/30">
          <option value="">— Επιλογή —</option>
          <option>Αγρίνιο</option><option>Αλεξανδρούπολη</option><option>Αθήνα</option>
          <option>Βέροια</option><option>Βόλος</option><option>Γιάννενα</option>
          <option>Γλυφάδα</option><option>Δράμα</option><option>Ελευσίνα</option>
          <option>Ηράκλειο</option><option>Θεσσαλονίκη</option><option>Καβάλα</option>
          <option>Καλαμάτα</option><option>Κατερίνη</option><option>Κέρκυρα</option>
          <option>Κοζάνη</option><option>Κομοτηνή</option><option>Κόρινθος</option>
          <option>Λαμία</option><option>Λάρισα</option><option>Μυτιλήνη</option>
          <option>Ναύπλιο</option><option>Ξάνθη</option><option>Πάτρα</option>
          <option>Πύργος</option><option>Ρέθυμνο</option><option>Ρόδος</option>
          <option>Σέρρες</option><option>Τρίκαλα</option><option>Χαλκίδα</option>
          <option>Χανιά</option>
        </select>
        <div id="err-city" class="mt-1 text-xs text-rose-600 hidden"></div>
      </div>

      <!-- RX + scan (optional) -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="text-sm font-semibold flex items-center gap-2">
          <span class="w-6 h-6 grid place-items-center">🧾</span>
          <span id="t-rx">Προαιρετικά: Αριθμός συνταγής</span>
        </label>
        <p id="t-rxHelp" class="mt-1 text-xs text-slate-500 dark:text-slate-400">Διευκολύνει το φαρμακείο να εντοπίσει σωστό σκεύασμα/δοσολογία.</p>
        <div class="mt-2 grid gap-2 sm:grid-cols-[1fr_auto_auto]">
          <input id="rx-number" type="text"
            class="w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-4 focus:ring-brand-300 focus:border-brand-500 placeholder:text-slate-400"
            placeholder="π.χ. 0123-456789-00" inputmode="numeric" />
          <button type="button" id="scan-barcode" class="px-4 py-3 rounded-xl bg-brand-600 text-white font-semibold hover:bg-brand-700">Σάρωση</button>
          <button type="button" id="toggle-torch" class="px-4 py-3 rounded-xl bg-slate-800/80 text-white font-semibold hover:bg-slate-800 hidden">🔦</button>
        </div>
        <div id="scan-area" class="mt-3 hidden relative">
          <video id="preview" playsinline class="w-full rounded-xl border border-slate-200 dark:border-slate-700"></video>
          <div class="absolute inset-0 scan-frame pointer-events-none"></div>
          <div class="mt-2 flex gap-2">
            <button type="button" id="stop-scan" class="px-3 py-2 rounded-xl bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100 text-sm font-semibold hover:bg-slate-300 dark:hover:bg-slate-600">Τερματισμός</button>
          </div>
        </div>
      </div>

      <!-- GDPR + Submit -->
      <div class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
        <label class="inline-flex items-start gap-3">
          <input id="gdpr-checkbox" type="checkbox" required class="mt-0.5 size-5 accent-brand-600">
          <span class="text-sm"><span id="t-accept">Αποδέχομαι τους</span> <button type="button" id="gdpr-open" class="underline text-brand-700">Όρους Αναζήτησης & GDPR</button>.</span>
        </label>
        <div id="err-gdpr" class="mt-1 text-xs text-rose-600 hidden"></div>
        <div class="mt-4 flex justify-end">
          <button id="submitBtn" class="px-5 py-3 rounded-2xl bg-gradient-to-r from-brand-500 to-brand-600 text-white font-semibold shadow-soft hover:opacity-95">
            <span id="t-submit">Υποβολή Αναζήτησης</span>
          </button>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section id="results" class="hidden mt-6">
      <h2 class="text-xl font-bold mb-3" id="t-results">Αποτελέσματα (demo UI)</h2>
      <div class="grid gap-3" id="resultsList"></div>
      <button id="newSearch" class="mt-4 px-4 py-2 rounded-xl border hover:bg-slate-100 dark:hover:bg-slate-800"><span id="t-newSearch">Νέα αναζήτηση</span></button>
    </section>

    <!-- Hold 60' -->
    <section id="hold" class="hidden mt-6">
      <div class="rounded-2xl bg-emerald-50 dark:bg-emerald-900/30 border border-emerald-200 dark:border-emerald-800 p-4">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="font-semibold" id="holdTitle">Κράτηση 60’ για παραλαβή</div>
            <div class="text-sm text-slate-600 dark:text-slate-300" id="holdPharm"></div>
          </div>
          <div class="text-2xl font-extrabold tabular-nums" id="holdTTL">60:00</div>
        </div>
        <div class="mt-3 flex gap-2 flex-wrap">
          <a id="holdCall" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">Κλήση</a>
          <a id="holdMaps" target="_blank" rel="noopener" class="px-4 py-2 rounded-xl bg-mapblue text-white font-semibold hover:bg-blue-700">Άνοιγμα σε Χάρτες</a>
          <button id="holdExtend" class="px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">+15’ Extend</button>
        </div>
        <div id="extendMsg" class="mt-2 text-xs text-slate-600 dark:text-slate-400"></div>
      </div>
    </section>
  </main>

  <!-- HOW modal -->
  <div id="modal-how" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-2xl rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200 dark:border-slate-800">
        <h3 class="text-lg font-bold" id="t-howTitle">Πώς λειτουργεί το MediRadar</h3>
        <button id="how-close" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">✕</button>
      </div>
      <div id="how-body" class="p-5 leading-relaxed text-slate-700 dark:text-slate-300"></div>
      <div class="px-5 pb-5 flex justify-end">
        <button id="how-ok" class="px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold hover:opacity-95"><span id="t-continue">Συνέχεια</span></button>
      </div>
    </div>
  </div>

  <!-- GDPR modal -->
  <div id="gdpr-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-3xl rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <h3 class="text-lg font-bold" id="t-gdprTitle">Πολιτική Προστασίας Δεδομένων & Όροι Αναζήτησης</h3>
        <button id="gdpr-close" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">✕</button>
      </div>
      <div id="gdpr-body" class="p-5 text-sm text-slate-700 dark:text-slate-300 space-y-3" style="max-height:62vh; overflow:auto"></div>
      <div class="px-5 pb-5 flex justify-end">
        <button id="gdpr-ok" class="px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold hover:opacity-95">OK</button>
      </div>
    </div>
  </div>

  <!-- Pharmacy info modal -->
  <div id="pharm-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-lg rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <h3 class="text-lg font-bold" id="pm-title">Φαρμακείο</h3>
        <button id="pm-close" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">✕</button>
      </div>
      <div class="p-5 space-y-2 text-sm">
        <div id="pm-address">Διεύθυνση:</div>
        <div id="pm-phone">Τηλέφωνο:</div>
      </div>
      <div class="px-5 pb-5 flex gap-2 justify-end">
        <a id="pm-call" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">Κλήση</a>
        <a id="pm-maps" target="_blank" rel="noopener" class="px-4 py-2 rounded-xl bg-mapblue text-white font-semibold hover:bg-blue-700">Άνοιγμα σε Χάρτες</a>
      </div>
    </div>
  </div>

  <!-- SIGN-IN modal -->
  <div id="auth-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <h3 class="text-lg font-bold" id="auth-title">Σύνδεση</h3>
        <button id="auth-close" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">✕</button>
      </div>
      <div class="p-5 space-y-4">
        <div class="space-y-2">
          <label class="text-sm font-semibold flex items-center gap-2"><span>✉️</span><span id="auth-emailLbl">Email</span></label>
          <input id="auth-email" type="email" class="w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="you@example.com" />
          <label class="text-sm font-semibold flex items-center gap-2 mt-2"><span>🔒</span><span id="auth-passLbl">Κωδικός</span></label>
          <input id="auth-pass" type="password" class="w-full px-3 py-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="••••••••" />
          <div class="flex gap-2 mt-2">
            <button id="auth-login" class="px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold hover:opacity-95">Σύνδεση</button>
            <button id="auth-signup" class="px-4 py-2 rounded-xl border hover:bg-slate-100 dark:hover:bg-slate-800">Εγγραφή</button>
          </div>
        </div>

        <div class="flex items-center gap-3"><div class="h-px bg-slate-200 dark:bg-slate-700 flex-1"></div><span class="text-xs opacity-70">ή</span><div class="h-px bg-slate-200 dark:bg-slate-700 flex-1"></div></div>

        <div class="grid gap-2">
          <button id="auth-google" class="px-4 py-2 rounded-xl bg-google text-white font-semibold hover:opacity-95 flex items-center justify-center gap-2">
            <svg width="18" height="18" viewBox="0 0 48 48" aria-hidden="true"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.5 34 29.1 37 24 37c-7 0-13-6-13-13s6-13 13-13c3.1 0 6 .9 8.3 2.9l5.7-5.7C34.8 5.4 29.7 3 24 3 12 3 2 13 2 25s10 22 22 22c11 0 21-8 21-22 0-1.6-.2-3.1-.4-4.5z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.2 16.3 18.7 13 24 13c3.1 0 6 .9 8.3 2.9l5.7-5.7C34.8 5.4 29.7 3 24 3 15.4 3 7.9 7.8 6.3 14.7z"/><path fill="#4CAF50" d="M24 47c5.1 0 10-1.9 13.6-5.2l-6.3-5.2C29.1 37 24.6 39 20 39c-5.1 0-9.4-3.3-11-7.9l-6.6 5.1C7.9 42.2 15.4 47 24 47z"/><path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.3 3.8-5.7 6.5-11.3 6.5-6.3 0-11.5-5.2-11.5-11.5S17.7 11.5 24 11.5c3.1 0 6 .9 8.3 2.9l5.7-5.7C34.8 5.4 29.7 3 24 3 12 3 2 13 2 25s10 22 22 22c11 0 21-8 21-22 0-1.6-.2-3.1-.4-4.5z"/></svg>
            Google
          </button>
          <button id="auth-apple" class="px-4 py-2 rounded-xl bg-apple text-white font-semibold hover:opacity-95 flex items-center justify-center gap-2">
            <svg width="16" height="16" viewBox="0 0 448 512"><path fill="currentColor" d="M350.5 129.6c-17.6 20.7-46.3 36.8-75.6 34.6-3-27.1 8.4-55.8 25.4-73.8 18-19.5 49.8-33.2 75.1-34.2 3.3 27.5-10 55.3-24.9 73.4zM399.8 357.8c-7.2 16.4-15.3 31.8-25 46.4-17.1 25.1-31.1 42.7-55.6 42.9-23.7.2-31.3-13.9-58.4-13.9-27.1 0-35.5 13.5-58 14.1-23.4.6-41.2-23.2-58.3-48.2-31.7-45.9-56-129.8-23.4-186.4 16.1-27.9 44.8-45.6 76.1-45.9 23.8-.3 46.3 15.7 58.4 15.7 12 0 40.3-19.4 68.1-16.6 11.6.5 44.2 4.7 65.1 35.4-1.7 1.1-38.9 22.9-38.6 68.8.4 54.9 47.6 73.1 48.3 73.4-.4 1.4-7.5 25.2-18.7 49.9z"/></svg>
            Apple
          </button>
        </div>

        <div class="text-center">
          <button id="auth-guest" class="text-sm underline hover:opacity-80">Συνέχεια ως επισκέπτης</button>
        </div>
        <div id="auth-msg" class="text-sm"></div>
      </div>
    </div>
  </div>

  <!-- ZXing lazy marker -->
  <script id="zxing-lib" type="text/plain" data-src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

  <script>
    /* ---------- Theme ---------- */
    const html = document.documentElement;
    const themeBtn = document.getElementById('theme-toggle');
    const iconSun = document.getElementById('icon-sun');
    const iconMoon = document.getElementById('icon-moon');
    function setTheme(mode){
      const dark = mode==='dark';
      html.classList.toggle('dark', dark);
      iconSun.classList.toggle('hidden', !dark);
      iconMoon.classList.toggle('hidden', dark);
      localStorage.setItem('mediradar-theme', dark?'dark':'light');
    }
    setTheme(localStorage.getItem('mediradar-theme') || (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
    themeBtn.addEventListener('click',()=> setTheme(html.classList.contains('dark')?'light':'dark'));

    /* ---------- i18n ---------- */
    const strings = {
      el:{ hero:'Άμεση εύρεση διαθεσιμότητας φαρμάκων σε κοντινά φαρμακεία.',
        searchBTN:'Αναζήτηση Φαρμάκου', howBTN:'Πώς λειτουργεί', signinBTN:'Σύνδεση', installBTN:'Εγκατάσταση',
        searchTitle:'Αναζήτηση Φαρμάκου', home:'Αρχική', medname:'Όνομα Φαρμάκου',
        formatTip:'Συμβουλή: Εμπορική ονομασία + δοσολογία (π.χ. “500mg”).',
        substance:'Δραστική Ουσία', optional:'(προαιρετικά)', doseEx:'Παράδειγμα δοσολογίας: Paracetamol 500mg.',
        type:'Τύπος Φαρμάκου', qty:'Ποσότητα (τεμάχια/κουτιά)', select:'Επιλογή',
        genericQ:'Αν δεν είναι διαθέσιμο το συγκεκριμένο εμπορικό, επιτρέπεις να σου προτείνουμε ισοδύναμο (γενόσημο);',
        yes:'ΝΑΙ', no:'ΟΧΙ', city:'Πόλη', accept:'Αποδέχομαι τους', submit:'Υποβολή Αναζήτησης',
        results:'Αποτελέσματα (demo UI)', newSearch:'Νέα αναζήτηση',
        pendingTitle:'Αναμονή απαντήσεων από φαρμακεία',
        pendingHint:'Μείνε στη σελίδα — αν τη κλείσεις, θα συνεχίσουμε να κρατάμε την αναμονή και θα επανέλθει όταν γυρίσεις.',
        howTitle:'Πώς λειτουργεί το MediRadar', continue:'Συνέχεια',
        rx:'Προαιρετικά: Αριθμός συνταγής', rxHelp:'Διευκολύνει το φαρμακείο να εντοπίσει σωστό σκεύασμα/δοσολογία.',
        holdTitle:'Κράτηση 60’ για παραλαβή',
        extendWarn:'Μπορείς να κάνεις παράταση μόνο μία φορά ανά 24 ώρες.',
        extendDone:'Έγινε παράταση +15’. Νέος χρόνος:',
        errors:{ med:'Συμπλήρωσε το όνομα φαρμάκου.', type:'Επίλεξε τύπο φαρμάκου.', qty:'Η ποσότητα πρέπει να είναι τουλάχιστον 1.', city:'Επίλεξε πόλη.', gdpr:'Πρέπει να αποδεχτείς τους όρους.' }
      },
      en:{ hero:'Instant availability check at nearby pharmacies.',
        searchBTN:'Medicine Search', howBTN:'How it works', signinBTN:'Sign in', installBTN:'Install',
        searchTitle:'Medicine Search', home:'Home', medname:'Medicine Name',
        formatTip:'Tip: Brand name + dosage (e.g. “500mg”).',
        substance:'Active Substance', optional:'(optional)', doseEx:'Dosage example: Paracetamol 500mg.',
        type:'Medicine Type', qty:'Quantity (units/boxes)', select:'Select',
        genericQ:'If the specific brand is unavailable, may we suggest an equivalent (generic)?',
        yes:'YES', no:'NO', city:'City', accept:'I accept the', submit:'Submit Search',
        results:'Results (demo UI)', newSearch:'New search',
        pendingTitle:'Waiting for pharmacy responses',
        pendingHint:'Please stay on the page — if you close it, we’ll keep the request pending and restore it when you return.',
        howTitle:'How MediRadar works', continue:'Continue',
        rx:'Optional: Prescription number', rxHelp:'Helps the pharmacy identify the correct product/dosage quickly.',
        holdTitle:'60’ reservation for self pick-up',
        extendWarn:'You can extend only once per 24 hours.',
        extendDone:'Extended +15’. New time:',
        errors:{ med:'Please enter medicine name.', type:'Please select medicine type.', qty:'Quantity must be at least 1.', city:'Please select a city.', gdpr:'You must accept the terms.' }
      }
    };
    const state = { lang: localStorage.getItem('mediradar-lang') || 'el' };
    function t(k){ return strings[state.lang][k]; }
    function setText(id, txt){ const el=document.getElementById(id); if(el) el.textContent=txt; }
    function applyLang(){
      document.documentElement.lang = state.lang;
      setText('t-hero', t('hero'));
      setText('t-searchBTN', t('searchBTN')); setText('t-howBTN', t('howBTN')); setText('t-signinBTN', t('signinBTN')); setText('t-installBTN', t('installBTN'));
      setText('t-searchTitle', t('searchTitle')); setText('t-home', t('home'));
      setText('t-medname', t('medname')); setText('t-formatTip', t('formatTip'));
      setText('t-substance', t('substance')); setText('t-optional', t('optional')); setText('t-doseEx', t('doseEx'));
      setText('t-type', t('type')); setText('t-qty', t('qty'));
      setText('t-genericQ', t('genericQ')); setText('t-yes', t('yes')); setText('t-no', t('no'));
      setText('t-city', t('city')); setText('t-accept', t('accept')); setText('t-submit', t('submit'));
      setText('t-results', t('results')); setText('t-newSearch', t('newSearch'));
      document.getElementById('pendingBanner').querySelector('#t-pendingTitle')?.textContent = t('pendingTitle');
      document.getElementById('pendingBanner').querySelector('#t-pendingHint')?.textContent = t('pendingHint');
      setText('holdTitle', t('holdTitle'));
      document.getElementById('medicine-name').placeholder = state.lang==='el'?'π.χ. Augmentin 875mg':'e.g. Augmentin 875mg';
      document.getElementById('active-substance').placeholder = state.lang==='el'?'π.χ. Paracetamol':'e.g. Paracetamol';
      localStorage.setItem('mediradar-lang', state.lang);
      // Auth labels
      document.getElementById('auth-title').textContent = state.lang==='el'?'Σύνδεση':'Sign in';
      document.getElementById('auth-emailLbl').textContent = state.lang==='el'?'Email':'Email';
      document.getElementById('auth-passLbl').textContent = state.lang==='el'?'Κωδικός':'Password';
      document.getElementById('auth-login').textContent = state.lang==='el'?'Σύνδεση':'Sign in';
      document.getElementById('auth-signup').textContent = state.lang==='el'?'Εγγραφή':'Sign up';
      document.getElementById('auth-guest').textContent = state.lang==='el'?'Συνέχεια ως επισκέπτης':'Continue as guest';
    }
    document.getElementById('lang-el').addEventListener('click', ()=>{ state.lang='el'; applyLang(); });
    document.getElementById('lang-en').addEventListener('click', ()=>{ state.lang='en'; applyLang(); });

    /* ---------- Nav ---------- */
    const splash = document.getElementById('splash');
    const app = document.getElementById('app');
    const results = document.getElementById('results');
    const proFloating = document.getElementById('pro-floating');
    const pendingBanner = document.getElementById('pendingBanner');
    const userBadge = document.getElementById('userBadge');

    function enterApp(){
      splash.classList.add('hidden'); app.classList.remove('hidden');
      proFloating.classList.add('hidden');
      window.scrollTo({ top: 0, behavior:'smooth' });
    }
    function backHome(e){
      if(e) e.preventDefault();
      app.classList.add('hidden'); splash.classList.remove('hidden');
      results.classList.add('hidden'); hideHold(); hidePending();
      proFloating.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior:'smooth' });
    }
    document.getElementById('cta-search').addEventListener('click', enterApp);
    document.getElementById('backHome').addEventListener('click', backHome);

    /* ---------- HOW modal ---------- */
    const modalHow = document.getElementById('modal-how');
    document.getElementById('cta-how').onclick = ()=> {
      modalHow.classList.remove('hidden'); modalHow.classList.add('flex');
      const body = state.lang==='el' ? `<ol class="list-decimal pl-5 space-y-2">
          <li>Πληκτρολόγησε τι ψάχνεις (εμπορική ονομασία ή/και δραστική ουσία).</li>
          <li>Η αίτηση στέλνεται στα κοντινά φαρμακεία.</li>
          <li>Όποιο έχει <strong>διαθεσιμότητα</strong> απαντά θετικά· αν έχει μόνο γενόσημο, θα το δεις με ειδικό σήμα.</li>
          <li>Επιλέγεις φαρμακείο και πας για <strong>self pick-up</strong>.</li>
          <li>Δεν συλλέγουμε τιμές — μόνο διαθεσιμότητα.</li></ol>`
        : `<ol class="list-decimal pl-5 space-y-2">
          <li>Type what you need (brand / active).</li>
          <li>Your request goes to nearby pharmacies.</li>
          <li>Those with <strong>availability</strong> reply “Available”; if generic only, you’ll see a badge.</li>
          <li>Pick a pharmacy and go for <strong>self pick-up</strong>.</li>
          <li>No prices collected — availability only.</li></ol>`;
      document.getElementById('how-body').innerHTML = body;
    };
    document.getElementById('how-close').onclick = ()=> modalHow.classList.add('hidden');
    document.getElementById('how-ok').onclick    = ()=> modalHow.classList.add('hidden');

    /* ---------- GDPR modal ---------- */
    const modalGdpr = document.getElementById('gdpr-modal');
    document.getElementById('gdpr-open').onclick = ()=> { modalGdpr.classList.remove('hidden'); modalGdpr.classList.add('flex'); };
    document.getElementById('gdpr-close').onclick= ()=> modalGdpr.classList.add('hidden');
    document.getElementById('gdpr-ok').onclick   = ()=> modalGdpr.classList.add('hidden');

    /* ---------- Autocomplete (demo) ---------- */
    const AC_MEDICINES = ['Augmentin 875mg/125mg','Depon 500mg','Panadol 500mg','Nurofen 400mg','Algofren 400mg','Zylapour 300mg','Salospir 100mg','Plavix 75mg','Zyrtec 10mg','Vibramycin 100mg'];
    const AC_SUBSTANCES = ['Paracetamol 500mg','Ibuprofen 400mg','Amoxicillin 500mg','Amoxicillin/Clavulanate 875/125mg','Cetirizine 10mg','Aspirin 100mg'];
    function attachAutocomplete(inputId, listId, data){
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      let idx = -1;
      function render(items){
        list.innerHTML = items.map((x,i)=>`<div class="ac-item px-3 py-2 text-sm hover:bg-brand-50 dark:hover:bg-slate-800 ${i===idx?'bg-brand-50 dark:bg-slate-800':''}" data-val="${x}">${x}</div>`).join('');
        list.classList.toggle('hidden', items.length===0);
      }
      function filter(q){ if(!q){ render([]); return; } render(data.filter(s=>s.toLowerCase().includes(q.toLowerCase())).slice(0,6)); }
      input.addEventListener('input', ()=>{ idx=-1; filter(input.value.trim()); });
      input.addEventListener('keydown', (e)=>{
        const items = [...list.querySelectorAll('.ac-item')]; if(!items.length) return;
        if(e.key==='ArrowDown'){ idx=(idx+1)%items.length; render(items.map(n=>n.dataset.val)); e.preventDefault(); }
        else if(e.key==='ArrowUp'){ idx=(idx-1+items.length)%items.length; render(items.map(n=>n.dataset.val)); e.preventDefault(); }
        else if(e.key==='Enter'){ if(idx>=0){ input.value = items[idx].dataset.val; render([]); } }
        else if(e.key==='Escape'){ render([]); }
      });
      list.addEventListener('click', (e)=>{ const item = e.target.closest('.ac-item'); if(!item) return; input.value = item.dataset.val; list.classList.add('hidden'); });
      document.addEventListener('click', (e)=>{ if(!list.contains(e.target) && e.target!==input){ list.classList.add('hidden'); }});
    }
    attachAutocomplete('medicine-name','ac-medicine',AC_MEDICINES);
    attachAutocomplete('active-substance','ac-substance',AC_SUBSTANCES);

    /* ---------- Confetti ---------- */
    const confettiCanvas = document.getElementById('confetti');
    const ctx = confettiCanvas.getContext('2d');
    function fireConfetti(duration=2500){
      confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight;
      confettiCanvas.style.display = 'block';
      const colors = ['#F78DA7','#84C5F4','#C3A6F4','#FFE08A','#9DE0D6'];
      const particles = Array.from({length: 150}, ()=> ({
        x: Math.random()*innerWidth, y: -20, vx:(Math.random()-.5)*2, vy: Math.random()*3+2,
        size: Math.random()*6+3, color: colors[Math.floor(Math.random()*colors.length)],
        rot: Math.random()*360, vr:(Math.random()-.5)*10
      }));
      const start = performance.now();
      function tick(ts){
        const elapsed = ts - start;
        ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
        particles.forEach(p=>{
          p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.rot+=p.vr;
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
          ctx.fillStyle=p.color; ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size); ctx.restore();
        });
        if(elapsed<duration) requestAnimationFrame(tick); else confettiCanvas.style.display='none';
      }
      requestAnimationFrame(tick);
    }

    /* ---------- Persist ---------- */
    const PERSIST_KEY = 'mr-state';
    function saveState(obj){ localStorage.setItem(PERSIST_KEY, JSON.stringify(obj)); }
    function loadState(){ try{ return JSON.parse(localStorage.getItem(PERSIST_KEY)||'{}'); }catch{ return {}; } }
    function clearState(){ localStorage.removeItem(PERSIST_KEY); }

    /* ---------- Pending ---------- */
    const reqBadge = document.getElementById('reqIdBadge');
    function showPending(reqId){
      reqBadge.textContent = reqId ? `ID: ${reqId}` : '';
      pendingBanner.classList.remove('hidden');
      pendingBanner.scrollIntoView({ behavior:'smooth', block:'start' });
    }
    function hidePending(){ pendingBanner.classList.add('hidden'); }

    /* ---------- Hold ---------- */
    const holdSec = document.getElementById('hold');
    const holdTTL = document.getElementById('holdTTL');
    const holdPharm = document.getElementById('holdPharm');
    const holdCall = document.getElementById('holdCall');
    const holdMaps = document.getElementById('holdMaps');
    const holdExtend = document.getElementById('holdExtend');
    const extendMsg = document.getElementById('extendMsg');
    let holdTimer=null, holdUntil=0;
    function two(n){ return n.toString().padStart(2,'0'); }
    function renderTTL(){
      const rem = Math.max(0, Math.floor((holdUntil - Date.now())/1000));
      const m = Math.floor(rem/60), s = rem%60;
      holdTTL.textContent = `${two(m)}:${two(s)}`;
      if(rem<=0){ clearInterval(holdTimer); holdTimer=null; clearState(); hideHold(); }
    }
    function startHold(pharm){
      holdSec.classList.remove('hidden'); results.classList.add('hidden'); hidePending();
      holdPharm.textContent = pharm.name + ' — ' + pharm.addr;
      holdCall.href = `tel:${pharm.tel.replace(/\s+/g,'')}`;
      holdMaps.href = `https://www.google.com/maps?q=${encodeURIComponent(pharm.addr)}${pharm.lat?`@${pharm.lat},${pharm.lng},17z`:''}`;
      holdUntil = Date.now() + 60*60*1000;
      const state0 = loadState();
      saveState({ ...state0, status:'hold', hold:{ until:holdUntil, pharm, extendedAt:state0?.hold?.extendedAt||null } });
      renderTTL(); clearInterval(holdTimer); holdTimer = setInterval(renderTTL, 1000);
      holdSec.scrollIntoView({ behavior:'smooth', block:'start' });
    }
    function restoreHold(data){
      const { pharm, until, extendedAt } = data.hold;
      holdSec.classList.remove('hidden'); results.classList.add('hidden');
      holdPharm.textContent = pharm.name + ' — ' + pharm.addr;
      holdCall.href = `tel:${pharm.tel.replace(/\s+/g,'')}`;
      holdMaps.href = `https://www.google.com/maps?q=${encodeURIComponent(pharm.addr)}${pharm.lat?`@${pharm.lat},${pharm.lng},17z`:''}`;
      holdUntil = until; renderTTL(); clearInterval(holdTimer); holdTimer = setInterval(renderTTL, 1000);
      if(extendedAt){ extendMsg.dataset.state='done'; extendMsg.textContent = strings[state.lang].extendDone + ' ' }
      holdSec.scrollIntoView({ behavior:'smooth', block:'start' });
    }
    function hideHold(){ holdSec.classList.add('hidden'); clearInterval(holdTimer); holdTimer=null; }

    holdExtend.addEventListener('click', ()=>{
      const st = loadState();
      const last = st?.hold?.extendedAt;
      const now = Date.now();
      const oneDay = 24*60*60*1000;
      if(last && (now - last) < oneDay){
        extendMsg.dataset.state='warn';
        extendMsg.textContent = strings[state.lang].extendWarn;
        return;
      }
      holdUntil += 15*60*1000;
      renderTTL();
      saveState({ ...st, hold:{ ...st.hold, until:holdUntil, extendedAt: now } });
      extendMsg.dataset.state='done';
      extendMsg.textContent = strings[state.lang].extendDone + ' ' + holdTTL.textContent;
    });

    /* ---------- Validation ---------- */
    function showErr(id, msg){ const el=document.getElementById(id); el.textContent=msg; el.classList.remove('hidden'); }
    function hideErr(id){ document.getElementById(id).classList.add('hidden'); }
    function validate(){
      let ok=true;
      const med=document.getElementById('medicine-name').value.trim();
      const type=document.getElementById('medicine-type').value.trim();
      const qty=parseInt(document.getElementById('quantity').value||'0',10);
      const city=document.getElementById('city').value.trim();
      const gdpr=document.getElementById('gdpr-checkbox').checked;
      if(!med){ showErr('err-med', strings[state.lang].errors.med); ok=false; } else hideErr('err-med');
      if(!type){ showErr('err-type', strings[state.lang].errors.type); ok=false; } else hideErr('err-type');
      if(!(qty>=1)){ showErr('err-qty', strings[state.lang].errors.qty); ok=false; } else hideErr('err-qty');
      if(!city){ showErr('err-city', strings[state.lang].errors.city); ok=false; } else hideErr('err-city');
      if(!gdpr){ showErr('err-gdpr', strings[state.lang].errors.gdpr); ok=false; } else hideErr('err-gdpr');
      return ok;
    }

    /* ---------- Submit (demo) ---------- */
    const list = document.getElementById('resultsList');
    document.getElementById('submitBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      if(!validate()) return;
      fireConfetti(2500);
      const reqId = 'MR-' + Math.random().toString(36).slice(2,8).toUpperCase();
      saveState({ status:'pending', reqId, createdAt: Date.now() });
      showPending(reqId);
      setTimeout(()=>{
        const st = loadState(); if(st.status!=='pending') return;
        hidePending(); list.innerHTML='';
        const allowGeneric = (document.querySelector('input[name="allow-generic"]:checked')?.value==='YES');
        const items = [
          { name:'Φαρμακείο Ιάκωβος', dist:'2.1km', generic: allowGeneric, addr:'Ιπποκράτους 12, Αθήνα', tel:'+30 2101234567', lat:37.984, lng:23.735 },
          { name:'Φαρμακείο Νίκη', dist:'3.0km', generic: false, addr:'Σόλωνος 90, Αθήνα', tel:'+30 2107654321', lat:37.983, lng:23.732 }
        ];
        items.forEach(it=>{
          const card = document.createElement('div');
          card.className = 'rounded-xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 flex items-center justify-between';
          card.innerHTML = `
            <div><div class="font-semibold">${it.name}</div>
                 <div class="text-xs text-slate-600 dark:text-slate-400">${it.dist}</div></div>
            <div class="flex items-center gap-2">
              ${it.generic ? `<span class="inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-200">🧬 Γενόσημο</span>` : ''}
              <button class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm select-pharm">Επιλογή</button>
            </div>`;
          card.dataset.addr = it.addr; card.dataset.tel = it.tel; card.dataset.name = it.name;
          card.dataset.lat = it.lat; card.dataset.lng = it.lng;
          list.appendChild(card);
        });
        results.classList.remove('hidden');
        results.scrollIntoView({ behavior:'smooth', block:'start' });
      }, 3000);
    });

    document.getElementById('resultsList').addEventListener('click', (e)=>{
      const btn = e.target.closest('.select-pharm'); if(!btn) return;
      const card = btn.closest('div.rounded-xl');
      const pharm = {
        name: card.dataset.name, addr: card.dataset.addr, tel: card.dataset.tel,
        lat: parseFloat(card.dataset.lat||'0'), lng: parseFloat(card.dataset.lng||'0')
      };
      startHold(pharm);
    });

    /* ---------- Scanner ---------- */
    const scanBtn = document.getElementById('scan-barcode');
    const stopBtn = document.getElementById('stop-scan');
    const scanArea = document.getElementById('scan-area');
    const videoEl = document.getElementById('preview');
    const rxInput = document.getElementById('rx-number');
    const torchBtn = document.getElementById('toggle-torch');
    let mediaStream=null, scanning=false, zxingReader=null, zxingInterval=null, videoTrack=null;

    async function loadZXing(){ if(window.ZXing) return;
      const src=document.getElementById('zxing-lib').getAttribute('data-src');
      await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.body.appendChild(s); });
    }
    async function startScan(){
      scanArea.classList.remove('hidden');
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment' }, audio:false });
        videoEl.srcObject = mediaStream; await videoEl.play(); scanning=true;
        videoTrack = mediaStream.getVideoTracks()[0];
        const capabilities = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
        if(capabilities.torch){ torchBtn.classList.remove('hidden'); } else { torchBtn.classList.add('hidden'); }
        if('BarcodeDetector' in window){
          const detector = new BarcodeDetector({ formats:['code_128','ean_13','qr_code','upc_a','upc_e','code_39','itf','codabar','data_matrix','pdf417','aztec'] });
          const loop = async ()=>{ if(!scanning) return;
            try{ const res = await detector.detect(videoEl);
              if(res && res.length){ rxInput.value = res[0].rawValue || ''; stopScan(); return; }
            }catch{} requestAnimationFrame(loop);
          }; loop();
        }else{
          await loadZXing();
          const { BrowserMultiFormatReader } = window.ZXing;
          zxingReader = new BrowserMultiFormatReader();
          zxingInterval = setInterval(async ()=>{
            if(!scanning) return;
            try{
              const r = await zxingReader.decodeOnceFromVideoDevice(undefined, videoEl);
              if(r && r.text){ rxInput.value = r.text; stopScan(); }
            }catch{}
          }, 800);
        }
      }catch(e){ alert(state.lang==='el'?'Δεν ήταν δυνατή η πρόσβαση στην κάμερα.':'Camera access failed.'); stopScan(); }
    }
    function stopScan(){
      scanning=false;
      if(zxingInterval){ clearInterval(zxingInterval); zxingInterval=null; }
      if(zxingReader){ try{zxingReader.reset();}catch{} zxingReader=null; }
      if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
      videoEl.pause(); videoEl.srcObject=null; scanArea.classList.add('hidden'); torchBtn.classList.add('hidden');
    }
    let torchOn=false;
    torchBtn.addEventListener('click', async ()=>{
      if(!videoTrack || !videoTrack.applyConstraints) return;
      try{ torchOn = !torchOn; await videoTrack.applyConstraints({ advanced:[{ torch: torchOn }] }); torchBtn.textContent = torchOn ? '🔦 On' : '🔦'; }catch{}
    });
    scanBtn.addEventListener('click', startScan);
    stopBtn.addEventListener('click', stopScan);

    /* ---------- PWA ---------- */
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/service-worker.js').catch(console.warn);
    }
    let deferredPrompt=null;
    const installBtn = document.getElementById('cta-install');
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden'); });
    installBtn.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.classList.add('hidden'); });
    window.addEventListener('appinstalled', ()=> installBtn.classList.add('hidden'));

    /* ---------- AUTH (Supabase) ---------- */
    const AUTH_URL = window.SUPABASE_URL || (typeof process!=='undefined' && process.env && process.env.SUPABASE_URL);
    const AUTH_KEY = window.SUPABASE_ANON_KEY || (typeof process!=='undefined' && process.env && process.env.SUPABASE_ANON_KEY);
    const sb = (AUTH_URL && AUTH_KEY) ? supabase.createClient(AUTH_URL, AUTH_KEY) : null;

    const authModal = document.getElementById('auth-modal');
    const openAuth = ()=> { authModal.classList.remove('hidden'); authModal.classList.add('flex'); };
    const closeAuth = ()=> authModal.classList.add('hidden');

    document.getElementById('cta-signin').addEventListener('click', ()=>{
      if(!sb){ alert('Supabase env variables missing (SUPABASE_URL / SUPABASE_ANON_KEY).'); return; }
      openAuth();
    });
    document.getElementById('auth-close').onclick = closeAuth;
    document.getElementById('auth-guest').onclick = closeAuth;

    async function showUser(){
      if(!sb) return;
      const { data: { user } } = await sb.auth.getUser();
      userBadge.textContent = user ? (user.email || user.user_metadata?.name || 'User') : '';
    }
    document.getElementById('auth-login').addEventListener('click', async ()=>{
      if(!sb) return;
      const email = document.getElementById('auth-email').value.trim();
      const pass  = document.getElementById('auth-pass').value;
      const msg = document.getElementById('auth-msg'); msg.textContent='';
      const { error } = await sb.auth.signInWithPassword({ email, password: pass });
      if(error){ msg.className='text-sm text-rose-600'; msg.textContent = error.message; return; }
      msg.className='text-sm text-emerald-600'; msg.textContent = state.lang==='el'?'Συνδέθηκες επιτυχώς.':'Signed in.';
      closeAuth(); showUser();
    });
    document.getElementById('auth-signup').addEventListener('click', async ()=>{
      if(!sb) return;
      const email = document.getElementById('auth-email').value.trim();
      const pass  = document.getElementById('auth-pass').value;
      const msg = document.getElementById('auth-msg'); msg.textContent='';
      const { error } = await sb.auth.signUp({ email, password: pass });
      if(error){ msg.className='text-sm text-rose-600'; msg.textContent = error.message; return; }
      msg.className='text-sm text-emerald-600'; msg.textContent = state.lang==='el'?'Έγινε εγγραφή. Έλεγξε το email σου.':'Signed up. Check your email.';
    });
    async function oauth(provider){
      if(!sb) return;
      const { error } = await sb.auth.signInWithOAuth({ provider, options:{ redirectTo: location.origin } });
      if(error) alert(error.message);
    }
    document.getElementById('auth-google').onclick = ()=> oauth('google');
    document.getElementById('auth-apple').onclick  = ()=> oauth('apple');

    /* ---------- Restore ---------- */
    function restore(){
      applyLang(); showUser();
      const st = loadState();
      if(!st.status) return;
      enterApp();
      if(st.status==='pending'){ showPending(st.reqId); }
      else if(st.status==='hold' && st.hold?.until && st.hold?.pharm){ restoreHold(st); }
    }
    restore();
  </script>
</body>
</html>
