<!DOCTYPE html>
<html lang="el" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MediRadar • Pharmacy</title>
  <meta name="application-name" content="MediRadar" />
  <meta name="apple-mobile-web-app-title" content="MediRadar" />
  <meta name="description" content="Σύνδεση μέσω Google για την πλατφόρμα MediRadar" />
  <meta property="og:site_name" content="MediRadar" />
  <meta property="og:description" content="Σύνδεση μέσω Google για την πλατφόρμα MediRadar" />
  <meta property="twitter:description" content="Σύνδεση μέσω Google για την πλατφόρμα MediRadar" />
  <link rel="icon" href="/icons/icon-192.png" />

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#29a3a3" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: { brand: { 500:'#29a3a3', 600:'#208181', 700:'#196464' } },
          boxShadow: { soft:'0 16px 40px rgba(2,6,23,.12)' }
        }
      }
    }
  </script>

  <style>
    body { position: relative; overflow-x: hidden; }
    .glass-surface {
      background: rgba(255, 255, 255, 0.22);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.35);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
      border-radius: 1rem;
    }
    .dark .glass-surface {
      background: rgba(15, 23, 42, 0.6);
      border-color: rgba(148, 163, 184, 0.3);
      box-shadow: 0 22px 48px rgba(2, 6, 23, 0.55);
    }
    .global-emoji-layer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      overflow: hidden;
    }
    .global-emoji-layer span {
      position: absolute;
      font-size: clamp(3rem, 6.5vw, 4.6rem);
      opacity: 0.3;
      filter: drop-shadow(0 18px 28px rgba(13, 148, 136, 0.25));
      animation-iteration-count: infinite;
      animation-timing-function: linear;
    }
    .global-emoji-layer span:nth-child(1) { top: 7%; left: 12%; animation: pharmEmojiFloatA 18s linear infinite; }
    .global-emoji-layer span:nth-child(2) { top: 18%; right: 12%; animation: pharmEmojiFloatB 21s linear infinite; }
    .global-emoji-layer span:nth-child(3) { bottom: 18%; left: 18%; animation: pharmEmojiFloatC 24s linear infinite; }
    .global-emoji-layer span:nth-child(4) { bottom: 10%; right: 14%; animation: pharmEmojiFloatD 19s linear infinite; }
    .global-emoji-layer span:nth-child(5) { top: 44%; left: 46%; animation: pharmEmojiFloatE 25s linear infinite; opacity: 0.26; }
    .global-emoji-layer span:nth-child(6) { top: 28%; left: 30%; animation: pharmEmojiFloatF 17s linear infinite; }
    .global-emoji-layer span:nth-child(7) { bottom: 28%; right: 26%; animation: pharmEmojiFloatG 20s linear infinite; }
    .global-emoji-layer span:nth-child(8) { top: 58%; right: 20%; animation: pharmEmojiFloatH 22s linear infinite; }
    .global-emoji-layer span:nth-child(9) { bottom: 12%; left: 36%; animation: pharmEmojiFloatI 16s linear infinite; }
    .global-emoji-layer span:nth-child(10) { top: 12%; left: 52%; animation: pharmEmojiFloatJ 28s linear infinite; }
    .dark .global-emoji-layer span { opacity: 0.38; filter: drop-shadow(0 18px 32px rgba(45, 212, 191, 0.35)); }
    @keyframes pharmEmojiFloatA {
      0% { transform: translate3d(0, 0, 0) scale(0.96); opacity: 0.08; }
      45% { transform: translate3d(34px, -26px, 0) scale(1.08); opacity: 0.32; }
      100% { transform: translate3d(0, 0, 0) scale(0.96); opacity: 0.08; }
    }
    @keyframes pharmEmojiFloatB {
      0% { transform: translate3d(0, 0, 0) scale(1); opacity: 0.07; }
      50% { transform: translate3d(-36px, 28px, 0) scale(1.12); opacity: 0.33; }
      100% { transform: translate3d(0, 0, 0) scale(1); opacity: 0.07; }
    }
    @keyframes pharmEmojiFloatC {
      0% { transform: translate3d(0, 0, 0) scale(0.94); opacity: 0.1; }
      55% { transform: translate3d(28px, -22px, 0) scale(1.08); opacity: 0.36; }
      100% { transform: translate3d(0, 0, 0) scale(0.94); opacity: 0.1; }
    }
    @keyframes pharmEmojiFloatD {
      0% { transform: translate3d(0, 0, 0) scale(1.02); opacity: 0.08; }
      50% { transform: translate3d(-32px, -30px, 0) scale(0.96); opacity: 0.3; }
      100% { transform: translate3d(0, 0, 0) scale(1.02); opacity: 0.08; }
    }
    @keyframes pharmEmojiFloatE {
      0% { transform: translate3d(0, 0, 0) scale(0.92); opacity: 0.07; }
      50% { transform: translate3d(28px, 30px, 0) scale(1.08); opacity: 0.3; }
      100% { transform: translate3d(0, 0, 0) scale(0.92); opacity: 0.07; }
    }
    @keyframes pharmEmojiFloatF {
      0% { transform: translate3d(0, 0, 0) scale(0.98); opacity: 0.08; }
      45% { transform: translate3d(26px, -28px, 0) scale(1.05); opacity: 0.28; }
      100% { transform: translate3d(0, 0, 0) scale(0.98); opacity: 0.08; }
    }
    @keyframes pharmEmojiFloatG {
      0% { transform: translate3d(0, 0, 0) scale(0.96); opacity: 0.09; }
      50% { transform: translate3d(-30px, 32px, 0) scale(1.06); opacity: 0.33; }
      100% { transform: translate3d(0, 0, 0) scale(0.96); opacity: 0.09; }
    }
    @keyframes pharmEmojiFloatH {
      0% { transform: translate3d(0, 0, 0) scale(1); opacity: 0.08; }
      55% { transform: translate3d(26px, -32px, 0) scale(1.09); opacity: 0.32; }
      100% { transform: translate3d(0, 0, 0) scale(1); opacity: 0.08; }
    }
    @keyframes pharmEmojiFloatI {
      0% { transform: translate3d(0, 0, 0) scale(0.94); opacity: 0.1; }
      50% { transform: translate3d(-24px, 26px, 0) scale(1.04); opacity: 0.32; }
      100% { transform: translate3d(0, 0, 0) scale(0.94); opacity: 0.1; }
    }
    @keyframes pharmEmojiFloatJ {
      0% { transform: translate3d(0, 0, 0) scale(0.96); opacity: 0.08; }
      50% { transform: translate3d(32px, 22px, 0) scale(1.08); opacity: 0.28; }
      100% { transform: translate3d(0, 0, 0) scale(0.96); opacity: 0.08; }
    }
    .pro-info-panel {
      padding: 1.5rem;
      border-radius: 1.25rem;
      transition: opacity .35s ease, transform .35s ease;
      opacity: 0;
      transform: translateY(-8px);
    }
    .pro-info-panel.is-visible {
      opacity: 1;
      transform: translateY(0);
    }
    .pro-info-panel h3 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 0.65rem;
    }
    .pro-info-panel p {
      margin-bottom: 0.65rem;
      line-height: 1.55;
    }
    .pro-info-panel ul {
      list-style: none;
      padding-left: 0;
      margin: 0 0 0.75rem;
      display: grid;
      gap: 0.4rem;
    }
    .pro-info-panel li {
      display: flex;
      gap: 0.6rem;
      font-weight: 600;
      align-items: flex-start;
    }
    .pro-info-panel li span:first-child {
      font-size: 1.15rem;
      line-height: 1.1;
    }
    .pro-info-panel em { font-style: italic; }
    .dark .pro-info-panel h3 { color: #7edbd9; }
    .dark .pro-info-panel li { color: #e0f2f1; }
    .dark .pro-info-panel em { color: #cbd5f5; }
    .card {
      border-radius: 1rem;
      background: rgba(255, 255, 255, 0.22);
      border: 1px solid rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(12px);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
      padding: 1.25rem;
    }
    .dark .card {
      background: rgba(15, 23, 42, 0.6);
      border-color: rgba(148, 163, 184, 0.3);
      box-shadow: 0 22px 48px rgba(2, 6, 23, 0.55);
    }
    .btn  {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 0.9rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(51, 65, 85, 0.25);
      font-weight: 600;
      background: rgba(255, 255, 255, 0.32);
      backdrop-filter: blur(10px);
      transition: all .2s ease;
    }
    .btn:hover { background: rgba(255, 255, 255, 0.45); }
    .dark .btn {
      background: rgba(15, 23, 42, 0.45);
      border-color: rgba(148, 163, 184, 0.4);
      color: #e2e8f0;
    }
    .dark .btn:hover { background: rgba(30, 41, 59, 0.6); }
    .dash-tab {
      position: relative;
      padding: 0.45rem 1.05rem;
      border-radius: 9999px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #0f172a;
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all .2s ease;
    }
    .dash-tab:is(:hover,:focus-visible) { color: #0f766e; }
    .dash-tab.is-active {
      background: linear-gradient(135deg, rgba(20, 184, 166, 0.15), rgba(14, 165, 233, 0.18));
      color: #0f766e;
      box-shadow: inset 0 0 0 1px rgba(15, 118, 110, 0.35);
    }
    .dark .dash-tab { color: #e2e8f0; }
    .dark .dash-tab:is(:hover,:focus-visible) { color: #5eead4; }
    .dark .dash-tab.is-active {
      background: linear-gradient(135deg, rgba(20, 184, 166, 0.18), rgba(56, 189, 248, 0.18));
      color: #5eead4;
      box-shadow: inset 0 0 0 1px rgba(45, 212, 191, 0.4);
    }
    .auth-portal-card { animation: authPortalIn .45s ease forwards; opacity:0; transform: translateY(16px) scale(.96); }
    .auth-portal-card::before {
      content:'';
      position:absolute;
      inset:0;
      border-radius:inherit;
      padding:1px;
      background:linear-gradient(135deg,#00c6ff,#0072ff);
      pointer-events:none;
      opacity:.9;
      transition:opacity .3s ease;
      -webkit-mask:
        linear-gradient(#fff 0 0) content-box,
        linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask:
        linear-gradient(#fff 0 0) content-box,
        linear-gradient(#fff 0 0);
      mask-composite: exclude;
    }
    .auth-portal-card:hover::before {
      opacity:1;
    }
    @keyframes authPortalIn { to { opacity:1; transform: translateY(0) scale(1); } }
    .auth-emoji-layer { position:absolute; inset:0; pointer-events:none; overflow:hidden; }
    .auth-emoji-layer span { position:absolute; font-size:2.75rem; opacity:.15; animation-iteration-count:infinite; animation-timing-function:linear; }
    .auth-emoji-layer span:nth-child(1) { top:14%; left:16%; animation-name:emojiDriftA; animation-duration:18s; }
    .auth-emoji-layer span:nth-child(2) { top:10%; right:10%; animation-name:emojiDriftB; animation-duration:22s; }
    .auth-emoji-layer span:nth-child(3) { bottom:12%; left:22%; animation-name:emojiDriftC; animation-duration:20s; }
    .auth-emoji-layer span:nth-child(4) { bottom:8%; right:16%; animation-name:emojiDriftD; animation-duration:24s; }
    .auth-emoji-layer span:nth-child(5) { top:42%; left:48%; animation-name:emojiDriftE; animation-duration:26s; opacity:.12; }
    @keyframes emojiDriftA { 0% { transform:translate3d(0,0,0) scale(.95); opacity:.05; } 40% { transform:translate3d(14px,-8px,0) scale(1.05); opacity:.16; } 100% { transform:translate3d(0,0,0) scale(.95); opacity:.05; } }
    @keyframes emojiDriftB { 0% { transform:translate3d(0,0,0) scale(1); opacity:.04; } 50% { transform:translate3d(-16px,12px,0) scale(1.08); opacity:.18; } 100% { transform:translate3d(0,0,0) scale(1); opacity:.04; } }
    @keyframes emojiDriftC { 0% { transform:translate3d(0,0,0) scale(.96); opacity:.06; } 60% { transform:translate3d(18px,-6px,0) scale(1.06); opacity:.16; } 100% { transform:translate3d(0,0,0) scale(.96); opacity:.06; } }
    @keyframes emojiDriftD { 0% { transform:translate3d(0,0,0) scale(1.02); opacity:.05; } 50% { transform:translate3d(-12px,-14px,0) scale(.94); opacity:.14; } 100% { transform:translate3d(0,0,0) scale(1.02); opacity:.05; } }
    @keyframes emojiDriftE { 0% { transform:translate3d(0,0,0) scale(.9); opacity:.03; } 55% { transform:translate3d(10px,8px,0) scale(1.08); opacity:.13; } 100% { transform:translate3d(0,0,0) scale(.9); opacity:.03; } }
    .auth-card--pulse-success { animation: authSuccessGlow 1.2s ease-out; }
    .auth-card--login-success { animation: authLoginSuccess 2s ease-out; }
    .auth-card--shake-error { animation: authErrorShake .55s ease; }
    @keyframes authSuccessGlow { 0% { box-shadow:0 0 0 0 rgba(16,185,129,0); border-color:rgba(16,185,129,0); } 50% { box-shadow:0 0 0 12px rgba(16,185,129,.12), 0 30px 60px rgba(15,23,42,.22); border-color:rgba(16,185,129,.35); } 100% { box-shadow:0 30px 60px rgba(15,23,42,.18); border-color:rgba(255,255,255,.4); } }
    @keyframes authLoginSuccess { 0% { box-shadow:0 0 0 0 rgba(34,197,94,0); border-color:rgba(34,197,94,0); transform:translateY(0) scale(1); } 25% { box-shadow:0 0 0 14px rgba(34,197,94,.14), 0 32px 70px rgba(15,23,42,.22); border-color:rgba(34,197,94,.4); transform:translateY(-4px) scale(1.01); } 70% { box-shadow:0 0 0 10px rgba(34,197,94,.08), 0 26px 60px rgba(15,23,42,.2); border-color:rgba(34,197,94,.22); } 100% { box-shadow:0 30px 60px rgba(15,23,42,.18); border-color:rgba(255,255,255,.4); transform:translateY(0) scale(1); } }
    @keyframes authErrorShake { 0%, 100% { transform:translateX(0); box-shadow:0 30px 60px rgba(15,23,42,.18); border-color:rgba(255,255,255,.4); } 20% { transform:translateX(-8px); box-shadow:0 0 0 10px rgba(248,113,113,.15), 0 30px 60px rgba(15,23,42,.2); border-color:rgba(248,113,113,.45); } 40% { transform:translateX(8px); } 60% { transform:translateX(-5px); } 80% { transform:translateX(5px); } }
    .auth-success-active { animation: authSuccessSequence 2s ease forwards; }
    @keyframes authSuccessSequence { 0% { opacity:0; transform:translateY(12px) scale(.95); } 20% { opacity:1; transform:translateY(0) scale(1); } 70% { opacity:1; transform:translateY(0) scale(1.02); } 100% { opacity:0; transform:translateY(-6px) scale(1.02); } }
  </style>
</head>
<body class="min-h-full bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-200 font-sans">
  <div class="global-emoji-layer" aria-hidden="true">
    <span>💊</span>
    <span>🩺</span>
    <span>💉</span>
    <span>🩹</span>
    <span>🧴</span>
    <span>⚕️</span>
    <span>🧬</span>
    <span>🏥</span>
    <span>🫀</span>
    <span>🩸</span>
  </div>
  <div class="max-w-5xl mx-auto p-4">
    <header class="flex flex-wrap items-center justify-between gap-3 mb-4 glass-surface bg-white/80 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-800 px-4 py-3 shadow-soft">
      <div class="flex items-center gap-3">
        <a href="/" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">← Αρχική</a>
        <h1 class="text-2xl font-extrabold">MediRadar • Φαρμακείο</h1>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2" data-auth-header>
          <button id="signin-btn" type="button" data-auth-open data-auth-target="pharmacies" data-auth-direct="true" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">Σύνδεση</button>
          <div data-auth-header-session class="hidden items-center gap-2">
            <div data-auth-header-avatar class="w-8 h-8 rounded-full bg-brand-600 text-white text-xs font-semibold grid place-items-center">Μ</div>
            <span data-auth-header-email class="text-sm font-semibold"></span>
          </div>
        </div>
        <div id="auth-session" class="text-xs text-slate-500 dark:text-slate-400"></div>
        <button id="signout-btn" data-auth-header-logout class="btn hidden hover:bg-slate-100 dark:hover:bg-slate-800">Έξοδος</button>
        <button id="theme-toggle" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">🌙/🌞</button>
      </div>
    </header>

    <!-- 🆕 Διαδραστικός πίνακας φαρμακείου για τους demo ιδιοκτήτες -->
    <section id="pharmacy-dashboard" class="card mt-4 hidden" aria-live="polite">
      <div class="flex flex-col gap-4">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="space-y-1">
            <h2 class="text-lg font-bold">Πίνακας φαρμακοποιού</h2>
            <p class="text-sm text-slate-600 dark:text-slate-300">Συνδέσου με τον demo λογαριασμό <strong>pharmacy_demo / mediradar123</strong> για να δεις αιτήματα και να ενημερώσεις ωράριο.</p>
          </div>
          <div class="inline-flex rounded-full border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 p-1" role="tablist">
            <button type="button" class="dash-tab is-active" data-dash-tab="requests" role="tab" aria-selected="true">Εκκρεμή αιτήματα</button>
            <button type="button" class="dash-tab" data-dash-tab="hours" role="tab" aria-selected="false">Ωράριο φαρμακείου</button>
          </div>
        </div>
        <div id="dashboard-status" class="hidden text-sm text-amber-600 dark:text-amber-300 bg-amber-100/70 dark:bg-amber-900/40 rounded-xl px-4 py-2"></div>
      </div>
    </section>

    <!-- Demo owner dashboard -->
    <section id="owner-dashboard" class="card mt-4 hidden" aria-live="polite">
      <div class="flex flex-wrap items-start justify-between gap-3">
        <div class="space-y-1">
          <h2 class="text-lg font-bold">Demo πίνακας φαρμακείου</h2>
          <p id="owner-welcome" class="text-sm text-slate-600 dark:text-slate-300">
            Συνδέσου για να δεις τον demo πίνακα ελέγχου.
          </p>
        </div>
        <span id="owner-demo-badge" class="px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wide bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-200">Demo</span>
      </div>
      <div class="mt-4 grid gap-3 md:grid-cols-3" id="owner-metrics-grid">
        <article class="rounded-2xl border border-emerald-200/60 bg-emerald-50/90 dark:border-emerald-500/40 dark:bg-emerald-500/10 p-4 shadow-inner">
          <div class="text-sm font-semibold text-emerald-700 dark:text-emerald-200">Αιτήματα σήμερα</div>
          <div class="mt-2 text-3xl font-extrabold text-emerald-900 dark:text-emerald-100">12</div>
          <div class="text-xs text-emerald-600/80 dark:text-emerald-200/80">+4 σε σχέση με χθες</div>
        </article>
        <article class="rounded-2xl border border-sky-200/70 bg-sky-50/90 dark:border-sky-500/40 dark:bg-sky-500/10 p-4 shadow-inner">
          <div class="text-sm font-semibold text-sky-700 dark:text-sky-200">Μέσος χρόνος απάντησης</div>
          <div class="mt-2 text-3xl font-extrabold text-sky-900 dark:text-sky-100">3’ 20’’</div>
          <div class="text-xs text-sky-600/80 dark:text-sky-200/80">Στόχος: &lt; 5 λεπτά</div>
        </article>
        <article class="rounded-2xl border border-amber-200/60 bg-amber-50/90 dark:border-amber-500/40 dark:bg-amber-500/10 p-4 shadow-inner">
          <div class="text-sm font-semibold text-amber-700 dark:text-amber-200">Επαναλαμβανόμενοι πελάτες</div>
          <div class="mt-2 text-3xl font-extrabold text-amber-900 dark:text-amber-100">68%</div>
          <div class="text-xs text-amber-600/80 dark:text-amber-200/80">Αύξηση 9% σε 30 ημέρες</div>
        </article>
      </div>
      <p class="mt-4 text-xs text-slate-500 dark:text-slate-400">
        Τα παραπάνω στοιχεία είναι demo για να γνωρίσεις το dashboard του MediRadar Pro.
      </p>
    </section>

    <!-- Opening hours summary widget -->
    <section id="hours-widget" class="card mt-4 hidden" aria-live="polite">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div class="space-y-1">
          <h2 id="hours-widget-title" class="text-lg font-bold">Ωράριο demo φαρμακείου</h2>
          <p class="text-xs text-slate-500 dark:text-slate-400">Γρήγορη προεπισκόπηση των ωρών που βλέπουν οι πελάτες.</p>
        </div>
        <span id="hours-widget-badge" class="px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wide bg-slate-900/10 dark:bg-slate-100/10">Demo</span>
      </div>
      <div id="hours-widget-empty" class="mt-4 rounded-xl border border-dashed border-slate-300 dark:border-slate-700 px-4 py-3 text-sm text-slate-500 dark:text-slate-400">
        Επίλεξε φαρμακείο ή συμπλήρωσε ωράριο για να εμφανιστεί η προεπισκόπηση.
      </div>
      <div id="hours-widget-list" class="mt-4 grid gap-2 sm:grid-cols-2 lg:grid-cols-3"></div>
    </section>

    <!-- PHARMACY PICK/CREATE -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <h2 class="text-lg font-bold mb-2">Επιλογή Φαρμακείου</h2>
        <div class="flex gap-2">
          <select id="pharmacy-select" class="w-full px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800"></select>
          <button id="reload-pharmacies" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">↻</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">Αν δεν υπάρχει, δημιούργησέ το δίπλα.</p>
        <div id="pharmacy-picked" class="mt-3 hidden">
          <div class="text-sm"><span class="font-semibold">Επιλεγμένο:</span> <span id="pharm-name"></span> • <span id="pharm-city"></span></div>
          <div class="text-xs text-slate-500"><span id="pharm-addr"></span> • <span id="pharm-phone"></span></div>
        </div>
      </div>

      <div class="card">
        <h2 class="text-lg font-bold mb-2">Νέο Φαρμακείο</h2>
        <div class="grid grid-cols-1 gap-2">
          <input id="new-name"  class="px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="Όνομα">
          <input id="new-addr"  class="px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="Διεύθυνση">
          <input id="new-phone" class="px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="Τηλέφωνο">
          <select id="new-city" class="px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800">
            <option value="">— Πόλη —</option>
            <option>Αθήνα</option><option>Θεσσαλονίκη</option><option>Πάτρα</option>
            <option>Ηράκλειο</option><option>Λάρισα</option><option>Βόλος</option>
            <option>Χανιά</option><option>Γλυφάδα</option><option>Ρόδος</option>
          </select>
          <button id="create-pharmacy" class="px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold hover:opacity-95">Δημιουργία</button>
        </div>
      </div>
    </section>

    <!-- HOURS JSON -->
    <section id="hours-box" class="card mt-4 hidden">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h2 class="text-lg font-bold">Πρόγραμμα λειτουργίας</h2>
          <p class="text-xs text-slate-500 dark:text-slate-400">Επίλεξε ημέρες και ώρες με την παρακάτω πρόταση.</p>
        </div>
        <div id="hours-meta" class="text-[11px] text-slate-400"></div>
      </div>
      <div id="hours-auth-alert" class="mt-3 text-xs text-amber-600 bg-amber-100/80 dark:bg-amber-900/30 dark:text-amber-200 rounded-xl px-3 py-2 hidden">Χρειάζεται είσοδος για επεξεργασία ωραρίου.</div>
      <div class="mt-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-3" id="hours-grid"></div>
      <div class="mt-4 flex flex-wrap items-center justify-between gap-3">
        <div id="hours-status" class="text-sm text-slate-500"></div>
        <div class="flex gap-2">
          <button id="cancel-hours" class="px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-sm font-semibold" disabled>Ακύρωση</button>
          <button id="save-hours" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700 disabled:opacity-60 disabled:pointer-events-none">Αποθήκευση</button>
        </div>
      </div>
    </section>

    <!-- REQUESTS LIST -->
    <section id="req-box" class="card mt-4 hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold">Αιτήματα στην πόλη σου</h2>
        <div class="flex items-center gap-2 text-sm">
          <span>Πόλη:</span><span id="city-pill" class="px-2 py-1 rounded-lg bg-slate-100 dark:bg-slate-800"></span>
          <button id="reload-requests" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">↻</button>
        </div>
      </div>
      <div id="req-list" class="mt-3 grid gap-3"></div>
      <div id="empty-state" class="hidden p-3 rounded-xl border text-sm">Δεν υπάρχουν εκκρεμή αιτήματα αυτή τη στιγμή.</div>
    </section>
  </div>

  <!-- USER AUTH MODAL -->
  <div data-auth-modal="users" id="auth-modal-users" class="fixed inset-0 hidden z-[100] items-center justify-center px-4 py-6" role="dialog" aria-modal="true" aria-labelledby="auth-user-title">
    <div class="absolute inset-0 bg-slate-950/70 backdrop-blur-sm" data-auth-close></div>
    <div class="relative w-full max-w-xl mx-auto">
      <div class="relative overflow-hidden rounded-3xl glass-surface border border-white/40 dark:border-slate-700/60 bg-white/70 dark:bg-slate-900/80 backdrop-blur-xl shadow-[0_30px_60px_rgba(15,23,42,0.18)] auth-portal-card" data-auth-card>
        <div class="absolute inset-0 pointer-events-none">
          <div class="absolute -top-24 right-[-60px] h-56 w-56 rounded-full bg-sky-400/20 blur-3xl"></div>
          <div class="absolute -bottom-28 left-[-40px] h-60 w-60 rounded-full bg-brand-500/25 blur-3xl"></div>
        </div>
        <div class="auth-emoji-layer" aria-hidden="true">
          <span>💊</span>
          <span>💉</span>
          <span>🩹</span>
          <span>🧴</span>
          <span>💚</span>
        </div>
        <button type="button" class="absolute top-4 right-4 z-10 p-2 rounded-xl bg-white/70 dark:bg-slate-800/60 border border-white/60 dark:border-slate-700 text-slate-600 dark:text-slate-200 hover:bg-white dark:hover:bg-slate-700" data-auth-close aria-label="Κλείσιμο">✕</button>
        <div class="relative p-6 sm:p-8 space-y-6" data-auth-root data-auth-role="users">
          <div class="flex flex-col items-center text-center gap-4">
            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-brand-500 to-brand-600 text-white grid place-items-center shadow-lg">
              <svg viewBox="0 0 24 24" class="w-9 h-9" aria-hidden="true">
                <path fill="currentColor" d="M11 2h2v3.06A7 7 0 0 1 18.94 11H22v2h-3.06A7 7 0 0 1 13 18.94V22h-2v-3.06A7 7 0 0 1 5.06 13H2v-2h3.06A7 7 0 0 1 11 5.06V2Zm1 5a5 5 0 1 0 0 10a5 5 0 0 0 0-10Z" />
              </svg>
            </div>
            <div class="space-y-2">
              <h2 id="auth-user-title" class="text-2xl font-bold tracking-tight text-slate-900 dark:text-white">Σύνδεση στην πλατφόρμα MediRadar</h2>
              <p id="auth-user-subtitle" class="text-sm text-slate-600 dark:text-slate-300">Συνέχισε με magic link ή Google για να προχωρήσεις στη δέσμευση.</p>
            </div>
          </div>

          <p data-auth-status-global class="hidden text-sm text-center text-rose-600"></p>

          <div data-auth-forms class="space-y-5">
            <form data-auth-form="users" class="space-y-4" novalidate>
              <label class="flex flex-col gap-2 text-left text-sm font-semibold text-slate-700 dark:text-slate-200">
                <span id="auth-users-email-label">Email</span>
                <input id="auth-users-email-input" type="email" required autocomplete="email" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white/90 dark:bg-slate-900/80 px-3 py-3 text-base focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="name@email.com">
              </label>
              <button type="submit" id="auth-users-email-cta" data-auth-email-button class="w-full rounded-xl bg-gradient-to-r from-brand-500 via-brand-600 to-brand-500 px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-brand-500/30 hover:opacity-95 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-500">Σύνδεση / Εγγραφή με Email</button>
              <button type="button" data-auth-google class="w-full flex items-center justify-center gap-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white/90 dark:bg-slate-900/80 px-4 py-3 text-sm font-semibold text-slate-700 dark:text-slate-200 shadow-sm hover:bg-white">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" class="w-5 h-5" />
                <span id="auth-users-google-cta">Σύνδεση με Google</span>
              </button>
              <p data-auth-status class="min-h-[1.25rem] text-center text-sm text-slate-600 dark:text-slate-300"></p>
            </form>
          </div>

          <div data-auth-success class="hidden flex-col items-center gap-3 text-center">
            <div class="w-14 h-14 rounded-full bg-emerald-500/15 text-emerald-500 grid place-items-center text-2xl shadow-inner">✅</div>
            <p id="auth-user-success-text" class="text-sm font-semibold text-emerald-600 dark:text-emerald-300">Επιτυχής Σύνδεση</p>
          </div>

          <div data-auth-session class="hidden">
            <div class="flex items-center justify-between gap-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/85 dark:bg-slate-900/70 px-4 py-4 shadow-inner">
              <div class="flex items-center gap-3">
                <div data-auth-avatar class="w-12 h-12 rounded-full bg-gradient-to-br from-brand-500 to-brand-600 text-white text-lg font-semibold grid place-items-center shadow-lg"></div>
                <div class="text-left">
                  <p id="auth-session-welcome" class="text-sm text-slate-500 dark:text-slate-300">Καλωσήρθες</p>
                  <p data-auth-user-email class="text-sm font-semibold text-slate-900 dark:text-white"></p>
                </div>
              </div>
              <button type="button" data-auth-logout class="rounded-xl border border-brand-500 px-4 py-2 text-sm font-semibold text-brand-700 dark:text-brand-200 hover:bg-brand-50 dark:hover:bg-brand-900/30">Αποσύνδεση</button>
            </div>
          </div>

          <p id="auth-user-footer" class="text-xs text-slate-500 dark:text-slate-400 text-center">Η πρόσβαση είναι δωρεάν για χρήστες. Οι φαρμακοποιοί χρειάζονται ενεργή συνδρομή MediRadar Pro.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- PHARMACY AUTH MODAL -->
  <div data-auth-modal="pharmacies" id="auth-modal-pharmacies" class="fixed inset-0 hidden z-[100] items-center justify-center px-4 py-6" role="dialog" aria-modal="true" aria-labelledby="auth-pharm-title">
    <div class="absolute inset-0 bg-slate-950/70 backdrop-blur-sm" data-auth-close></div>
    <div class="relative w-full max-w-xl mx-auto">
      <div class="relative overflow-hidden rounded-3xl glass-surface border border-white/40 dark:border-slate-700/60 bg-white/70 dark:bg-slate-900/80 backdrop-blur-xl shadow-[0_30px_60px_rgba(15,23,42,0.18)] auth-portal-card" data-auth-card>
        <div class="absolute inset-0 pointer-events-none">
          <div class="absolute -top-24 right-[-60px] h-56 w-56 rounded-full bg-sky-400/20 blur-3xl"></div>
          <div class="absolute -bottom-28 left-[-40px] h-60 w-60 rounded-full bg-brand-500/25 blur-3xl"></div>
        </div>
        <div class="auth-emoji-layer" aria-hidden="true">
          <span>💊</span>
          <span>💉</span>
          <span>🩹</span>
          <span>🧴</span>
          <span>💚</span>
        </div>
        <button type="button" class="absolute top-4 right-4 z-10 p-2 rounded-xl bg-white/70 dark:bg-slate-800/60 border border-white/60 dark:border-slate-700 text-slate-600 dark:text-slate-200 hover:bg-white dark:hover:bg-slate-700" data-auth-close aria-label="Κλείσιμο">✕</button>
        <div class="relative p-6 sm:p-8 space-y-6" data-auth-root data-auth-role="pharmacies">
          <div class="flex flex-col items-center text-center gap-4">
            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-brand-500 to-brand-600 text-white grid place-items-center shadow-lg">
              <svg viewBox="0 0 24 24" class="w-9 h-9" aria-hidden="true">
                <path fill="currentColor" d="M11 2h2v3.06A7 7 0 0 1 18.94 11H22v2h-3.06A7 7 0 0 1 13 18.94V22h-2v-3.06A7 7 0 0 1 5.06 13H2v-2h3.06A7 7 0 0 1 11 5.06V2Zm1 5a5 5 0 1 0 0 10a5 5 0 0 0 0-10Z" />
              </svg>
            </div>
            <div class="space-y-2">
              <h2 id="auth-pharm-title" class="text-2xl font-bold tracking-tight text-slate-900 dark:text-white">Πρόσβαση Φαρμακείων</h2>
              <p id="auth-pharm-subtitle" class="text-sm text-slate-600 dark:text-slate-300">Συνδέσου ή εγγράψου στο MediRadar Pro για να απαντάς σε αιτήματα διαθεσιμότητας.</p>
            </div>
          </div>

          <p data-auth-status-global class="hidden text-sm text-center text-rose-600"></p>

          <div data-auth-forms class="space-y-5">
            <form data-auth-form="pharmacies" class="space-y-4" novalidate>
              <label class="flex flex-col gap-2 text-left text-sm font-semibold text-slate-700 dark:text-slate-200">
                <span id="auth-pharm-email-label">Email φαρμακείου</span>
                <input id="auth-pharm-email-input" type="email" required autocomplete="email" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white/90 dark:bg-slate-900/80 px-3 py-3 text-base focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="pharmacy@example.gr">
              </label>
              <button type="submit" id="auth-pharm-email-cta" data-auth-email-button class="w-full rounded-xl bg-gradient-to-r from-brand-500 via-brand-600 to-brand-500 px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-brand-500/30 hover:opacity-95 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-500">Σύνδεση / Εγγραφή με Email</button>
              <button type="button" data-auth-google class="w-full flex items-center justify-center gap-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white/90 dark:bg-slate-900/80 px-4 py-3 text-sm font-semibold text-slate-700 dark:text-slate-200 shadow-sm hover:bg-white">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" class="w-5 h-5" />
                <span id="auth-pharm-google-cta">Σύνδεση με Google</span>
              </button>
              <p data-auth-status class="min-h-[1.25rem] text-center text-sm text-slate-600 dark:text-slate-300"></p>
            </form>
          </div>

          <div data-auth-success class="hidden flex-col items-center gap-3 text-center">
            <div class="w-14 h-14 rounded-full bg-emerald-500/15 text-emerald-500 grid place-items-center text-2xl shadow-inner">✅</div>
            <p id="auth-pharm-success-text" class="text-sm font-semibold text-emerald-600 dark:text-emerald-300">Επιτυχής Σύνδεση</p>
          </div>

          <div data-auth-session class="hidden">
            <div class="flex items-center justify-between gap-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/85 dark:bg-slate-900/70 px-4 py-4 shadow-inner">
              <div class="flex items-center gap-3">
                <div data-auth-avatar class="w-12 h-12 rounded-full bg-gradient-to-br from-brand-500 to-brand-600 text-white text-lg font-semibold grid place-items-center shadow-lg"></div>
                <div class="text-left">
                  <p class="text-sm text-slate-500 dark:text-slate-300">Καλωσήρθες</p>
                  <p data-auth-user-email class="text-sm font-semibold text-slate-900 dark:text-white"></p>
                </div>
              </div>
              <button type="button" data-auth-logout class="rounded-xl border border-brand-500 px-4 py-2 text-sm font-semibold text-brand-700 dark:text-brand-200 hover:bg-brand-50 dark:hover:bg-brand-900/30">Αποσύνδεση</button>
            </div>
          </div>

          <p id="auth-pharm-footer" class="text-xs text-slate-500 dark:text-slate-400 text-center">Η πρόσβαση είναι δωρεάν για χρήστες. Οι φαρμακοποιοί χρειάζονται ενεργή συνδρομή MediRadar Pro.</p>

          <button type="button" id="auth-pro-info-link" data-pro-info-toggle aria-expanded="false" class="mx-auto block text-xs font-semibold text-brand-700 underline decoration-dotted underline-offset-4 hover:text-brand-600 dark:text-brand-200 dark:hover:text-brand-100">Μάθετε περισσότερα για το MediRadar Pro</button>
          <div data-pro-info-panel class="pro-info-panel glass-surface hidden text-left text-sm text-slate-700 dark:text-slate-200" role="region" aria-label="Πληροφορίες MediRadar Pro">
            <h3>Γιατί να επιλέξετε το MediRadar Pro</h3>
            <p>Το MediRadar Pro προσφέρει στους φαρμακοποιούς ένα εύχρηστο και γρήγορο σύστημα για να απαντούν άμεσα στα αιτήματα διαθεσιμότητας φαρμάκων των πελατών τους, χωρίς τηλεφωνήματα και καθυστερήσεις.</p>
            <p>Με τη συνδρομή Pro:</p>
            <ul>
              <li><span aria-hidden="true">📱</span><span>Εξυπηρετείτε τους πελάτες σας σε πραγματικό χρόνο.</span></li>
              <li><span aria-hidden="true">💬</span><span>Μειώνετε τα τηλεφωνήματα και την απασχόληση του προσωπικού.</span></li>
              <li><span aria-hidden="true">⚡</span><span>Κερδίζετε νέους πελάτες που βλέπουν τη διαθεσιμότητά σας άμεσα.</span></li>
              <li><span aria-hidden="true">💶</span><span>Εξοικονομείτε χρόνο και αυξάνετε τα κέρδη από γρήγορες πωλήσεις.</span></li>
              <li><span aria-hidden="true">☁️</span><span>Δεν χρειάζεται εγκατάσταση — λειτουργεί 100% μέσω cloud.</span></li>
            </ul>
            <p>Η ετήσια συνδρομή ανέρχεται σε μόλις <b>€365/έτος</b> — λιγότερο από €1 την ημέρα, για να ενισχύσετε την εξυπηρέτηση και την εικόνα του φαρμακείου σας.</p>
            <p><em>Επιλέξτε MediRadar Pro και κάντε το φαρμακείο σας μέρος της νέας ψηφιακής εποχής.</em></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ENV -->
  <script src="/env.js"></script>
  <script>
    window.ENV = window.ENV || {
      SUPABASE_URL: 'https://qzerrisyowkfkmcyxmav.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZXJyaXN5b3drZmttY3l4bWF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTcxODQsImV4cCI6MjA3NTU5MzE4NH0.alkvHkOQPBTwY3daUcKAEsf4nt0kizuU3rYI2c2InPk'
    };
  </script>

  <!-- Supabase + App -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    import { supabaseClient } from "./firebase.js";
    import {
      WEEK_DAYS,
      createEmptySchedule,
      cloneSchedule,
      validateSchedule,
      loadSchedule,
      saveSchedule,
      formatScheduleForDisplay
    } from "./pharmacy/schedule.js";

    /* ---------- setup ---------- */
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.ENV || {};
    const supabase = supabaseClient || (SUPABASE_URL && SUPABASE_ANON_KEY
      ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null);
    if(!supabase){
      console.warn('Supabase configuration is missing.');
    }
    const qs = (s, r=document)=>r.querySelector(s);
    const qsa = (s, r=document)=>[...r.querySelectorAll(s)];
    const store = {
      pharmacy: null
    };

    const scheduleState = {
      draft: createEmptySchedule(),
      saved: createEmptySchedule(),
      meta: null,
      loading: false,
      dirty: false,
      errors: []
    };

    // 🆕 Demo ωράριο για προεπισκόπηση όταν δεν έχει επιλεγεί φαρμακείο
    const demoSchedule = [
      { dayIndex: 0, open: false, start: '', end: '' },
      { dayIndex: 1, open: true, start: '08:30', end: '17:30' },
      { dayIndex: 2, open: true, start: '08:30', end: '17:30' },
      { dayIndex: 3, open: true, start: '08:30', end: '17:30' },
      { dayIndex: 4, open: true, start: '08:30', end: '18:00' },
      { dayIndex: 5, open: true, start: '08:30', end: '18:00' },
      { dayIndex: 6, open: true, start: '09:00', end: '14:30' }
    ];

    const EMAIL_REDIRECT_URL = (window.ENV && typeof window.ENV.SUPABASE_EMAIL_REDIRECT_URL === 'string' && window.ENV.SUPABASE_EMAIL_REDIRECT_URL.length)
      ? window.ENV.SUPABASE_EMAIL_REDIRECT_URL
      : `${window.location.origin}/pharmacy.html`;

    let authToastTimer = null;

    function ensureAuthToast(){
      let toast = document.querySelector('[data-med-toast]');
      if(toast) return toast;
      toast = document.createElement('div');
      toast.dataset.medToast = 'true';
      toast.setAttribute('role','status');
      toast.setAttribute('aria-live','polite');
      toast.style.cssText = `
        position: fixed;
        left: 50%;
        bottom: 2.5rem;
        transform: translateX(-50%);
        background: rgba(15,23,42,0.92);
        color: #fff;
        padding: 0.9rem 1.4rem;
        border-radius: 1rem;
        font-size: 0.95rem;
        font-weight: 600;
        box-shadow: 0 18px 40px rgba(15,23,42,0.35);
        opacity: 0;
        pointer-events: none;
        transition: opacity .3s ease;
        z-index: 9999;
        max-width: min(92vw, 420px);
        text-align: center;
      `;
      document.body.appendChild(toast);
      return toast;
    }

    function showAuthToast(message, tone='info'){
      const toast = ensureAuthToast();
      toast.textContent = message;
      let bg = 'rgba(15,23,42,0.92)';
      if(tone === 'error') bg = 'rgba(185, 28, 28, 0.92)';
      else if(tone === 'success') bg = 'rgba(4, 120, 87, 0.92)';
      else if(tone === 'warning') bg = 'rgba(202, 138, 4, 0.92)';
      toast.style.background = bg;
      toast.style.opacity = '1';
      clearTimeout(authToastTimer);
      authToastTimer = window.setTimeout(()=>{
        toast.style.opacity = '0';
      }, 4200);
    }

    function setAuthButtonLoading(button, isLoading){
      if(!button) return;
      if(isLoading){
        if(!button.dataset.originalLabel){
          button.dataset.originalLabel = button.textContent;
        }
        button.textContent = 'Σύνδεση…';
        button.disabled = true;
        button.classList.add('opacity-70');
        button.setAttribute('aria-busy','true');
      } else {
        const label = button.dataset.originalLabel;
        if(label){
          button.textContent = label;
          delete button.dataset.originalLabel;
        }
        button.disabled = false;
        button.classList.remove('opacity-70');
        button.setAttribute('aria-busy','false');
      }
    }

    /* ---------- theme ---------- */
    const html = document.documentElement;
    const themeBtn = qs('#theme-toggle');
    function setTheme(mode){ const dark = mode==='dark'; html.classList.toggle('dark', dark); localStorage.setItem('mr-pharm-theme', dark?'dark':'light');}
    setTheme(localStorage.getItem('mr-pharm-theme') || (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
    themeBtn.addEventListener('click',()=> setTheme(html.classList.contains('dark')?'light':'dark'));

    /* ---------- ui refs ---------- */
    const selPh = qs('#pharmacy-select');
    const reloadPh = qs('#reload-pharmacies');
    const pickedBox = qs('#pharmacy-picked');
    const pName = qs('#pharm-name');
    const pCity = qs('#pharm-city');
    const pAddr = qs('#pharm-addr');
    const pPhone = qs('#pharm-phone');

    const authSessionEl = qs('#auth-session');
    const signOutBtn = qs('#signout-btn');
    const authModals = {
      users: qs('[data-auth-modal="users"]'),
      pharmacies: qs('[data-auth-modal="pharmacies"]')
    };
    let activeAuthModal = null;
    const authCloseEls = qsa('[data-auth-close]');
    const authOpenButtons = qsa('[data-auth-open]');
    const modalAuthButtons = authOpenButtons.filter(btn => btn.dataset.authDirect !== 'true');
    const directPharmacyButton = authOpenButtons.find(btn => btn.dataset.authDirect === 'true') || null;
    const authHeaderSession = qs('[data-auth-header-session]');
    const authHeaderAvatar = qs('[data-auth-header-avatar]');
    const authHeaderEmail = qs('[data-auth-header-email]');
    const proInfoToggles = qsa('[data-pro-info-toggle]');

    const dashboardSection = qs('#pharmacy-dashboard');
    const dashboardStatus = qs('#dashboard-status');
    const dashTabs = qsa('[data-dash-tab]');

    const ownerDashboard = qs('#owner-dashboard');
    const ownerWelcome = qs('#owner-welcome');
    const ownerBadge = qs('#owner-demo-badge');
    const hoursWidget = qs('#hours-widget');
    const hoursWidgetTitle = qs('#hours-widget-title');
    const hoursWidgetBadge = qs('#hours-widget-badge');
    const hoursWidgetList = qs('#hours-widget-list');
    const hoursWidgetEmpty = qs('#hours-widget-empty');
    const hoursBox = qs('#hours-box');
    const hoursGrid = qs('#hours-grid');
    const saveHoursBtn = qs('#save-hours');
    const cancelHoursBtn = qs('#cancel-hours');
    const hoursStatusEl = qs('#hours-status');
    const hoursMetaEl = qs('#hours-meta');
    const hoursAuthAlert = qs('#hours-auth-alert');

    const reqBox = qs('#req-box');
    const cityPill = qs('#city-pill');
    const reqList = qs('#req-list');
    const emptyState = qs('#empty-state');
    const reloadReq = qs('#reload-requests');

    const dayControls = new Map();

    let authSession = null;
    let activeDashTab = 'requests';

    function getSessionUser(){
      return authSession?.user || null;
    }

    function isDashboardUser(user = getSessionUser()){
      if(!user) return false;
      const email = String(user.email || '').toLowerCase();
      if(email.startsWith('pharmacy_demo')) return true;
      const username = String(user.user_metadata?.username || '').toLowerCase();
      if(username.startsWith('pharmacy_demo')) return true;
      const roles = user.user_metadata?.roles;
      if(Array.isArray(roles) && roles.some(role => String(role).toLowerCase().includes('pharm'))){
        return true;
      }
      // ✅ Επιτρέπουμε και άλλους δοκιμαστικούς λογαριασμούς φαρμακείων
      return true;
    }

    function setDashboardStatus(message = '', tone = 'info'){
      if(!dashboardStatus) return;
      if(!message){
        dashboardStatus.classList.add('hidden');
        dashboardStatus.textContent = '';
        return;
      }
      let toneClasses = 'text-slate-600 dark:text-slate-200 bg-slate-100/80 dark:bg-slate-800/60';
      if(tone === 'warning'){
        toneClasses = 'text-amber-600 dark:text-amber-300 bg-amber-100/70 dark:bg-amber-900/40';
      } else if(tone === 'success'){
        toneClasses = 'text-emerald-600 dark:text-emerald-300 bg-emerald-100/70 dark:bg-emerald-900/30';
      } else if(tone === 'error'){
        toneClasses = 'text-rose-600 dark:text-rose-300 bg-rose-100/70 dark:bg-rose-900/30';
      }
      dashboardStatus.className = `text-sm rounded-xl px-4 py-2 ${toneClasses}`;
      dashboardStatus.textContent = message;
      dashboardStatus.classList.remove('hidden');
    }

    // 🆕 Ενεργοποιούμε το σωστό tab (αιτήματα ή ωράριο) στον πίνακα φαρμακείου
    function setActiveDashboardTab(tab){
      if(!tab || tab === activeDashTab) return;
      activeDashTab = tab;
      dashTabs.forEach(btn => {
        const isActive = btn.dataset.dashTab === tab;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      syncDashboardVisibility({ refresh: true });
    }

    // 🆕 Εμφανίζουμε το dashboard μόνο σε συνδεδεμένους φαρμακοποιούς και ενημερώνουμε το τρέχον tab
    function syncDashboardVisibility({ refresh = false } = {}){
      const user = getSessionUser();
      const loggedIn = !!user;
      const allowed = isDashboardUser(user);
      const hasPharmacy = !!store.pharmacy?.id;
      if(dashboardSection){
        dashboardSection.classList.toggle('hidden', !(loggedIn && allowed));
      }
      const showRequests = loggedIn && allowed && hasPharmacy && activeDashTab === 'requests';
      const showHours = loggedIn && allowed && hasPharmacy && activeDashTab === 'hours';
      if(reqBox){ reqBox.classList.toggle('hidden', !showRequests); }
      if(hoursBox){ hoursBox.classList.toggle('hidden', !showHours); }
      if(!loggedIn){
        setDashboardStatus('Συνδέσου με τα demo στοιχεία για να ανοίξει το dashboard.', 'warning');
      } else if(!allowed){
        setDashboardStatus('Ο συγκεκριμένος λογαριασμός δεν έχει πρόσβαση στο demo dashboard.', 'warning');
      } else if(!hasPharmacy){
        setDashboardStatus('Επίλεξε φαρμακείο για να προβληθούν αιτήματα και ωράριο.', 'info');
      } else {
        setDashboardStatus('', 'info');
        if(refresh && activeDashTab === 'requests'){
          loadRequests();
        }
      }
    }

    function getOwnerFriendlyName(user = getSessionUser()){
      if(!user) return '';
      const metaName = user.user_metadata?.full_name || user.user_metadata?.name || '';
      if(metaName) return metaName;
      if(user.email){
        const [localPart] = user.email.split('@');
        return localPart || user.email;
      }
      return user.phone || '';
    }

    function updateOwnerWelcome(){
      if(!ownerDashboard) return;
      const user = getSessionUser();
      const loggedIn = !!user;
      ownerDashboard.classList.toggle('hidden', !loggedIn);
      if(ownerBadge){ ownerBadge.textContent = loggedIn ? 'Demo' : 'Demo'; }
      if(loggedIn){
        const friendly = getOwnerFriendlyName(user) || 'φαρμακοποιέ';
        if(ownerWelcome){
          ownerWelcome.textContent = `Καλωσήρθες, ${friendly}! Έτοιμος για την επόμενη βάρδια;`;
        }
      }else if(ownerWelcome){
        ownerWelcome.textContent = 'Συνδέσου για να δεις τον demo πίνακα ελέγχου.';
      }
    }

    function renderHoursWidget(){
      if(!hoursWidget) return;
      const loggedIn = !!authSession?.user;
      hoursWidget.classList.toggle('hidden', !loggedIn);
      if(!loggedIn){
        if(hoursWidgetList){ hoursWidgetList.innerHTML = ''; }
        hoursWidgetEmpty?.classList.add('hidden');
        return;
      }

      const hasPharmacy = !!store.pharmacy?.id;
      if(hoursWidgetTitle){
        hoursWidgetTitle.textContent = hasPharmacy && store.pharmacy?.name
          ? `Ωράριο ${store.pharmacy.name}`
          : 'Ωράριο demo φαρμακείου';
      }
      if(hoursWidgetBadge){
        hoursWidgetBadge.textContent = hasPharmacy ? 'Live' : 'Demo';
        hoursWidgetBadge.className = hasPharmacy
          ? 'px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wide bg-emerald-500/15 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-200'
          : 'px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wide bg-slate-900/10 dark:bg-slate-100/10';
      }

      const sourceSchedule = hasPharmacy ? scheduleState.draft : demoSchedule;
      const summary = formatScheduleForDisplay(sourceSchedule, 'el');

      if(!summary.length){
        hoursWidgetEmpty?.classList.remove('hidden');
        if(hoursWidgetList){ hoursWidgetList.innerHTML = ''; }
        return;
      }

      hoursWidgetEmpty?.classList.add('hidden');
      if(hoursWidgetList){
        hoursWidgetList.innerHTML = '';
        summary.forEach(item => {
          const row = document.createElement('div');
          row.className = 'rounded-xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/60 px-4 py-3 flex flex-col gap-1 shadow-sm';
          row.innerHTML = `
            <div class="text-sm font-semibold text-slate-700 dark:text-slate-100">${item.daysLabel}</div>
            <div class="text-sm text-slate-500 dark:text-slate-300">${item.hoursLabel}</div>
          `;
          hoursWidgetList.appendChild(row);
        });
      }
    }

    function getOpenAuthModal(){
      return Object.values(authModals).find(modal => modal && !modal.classList.contains('hidden')) || null;
    }

    function openAuthModal(target='pharmacies'){
      const modal = authModals[target] || authModals.pharmacies || authModals.users;
      if(!modal) return;
      activeAuthModal = modal;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.classList.add('overflow-hidden');
      const statusEl = modal.querySelector('[data-auth-status-global]');
      if(statusEl){
        statusEl.classList.add('hidden');
        statusEl.textContent = '';
      }
    }

    function hideProInfoPanel(panel, toggle){
      if(!panel) return;
      const finalize = () => {
        panel.classList.add('hidden');
        panel.removeEventListener('transitionend', finalize);
      };
      panel.classList.remove('is-visible');
      if(!panel.classList.contains('hidden')){
        panel.addEventListener('transitionend', finalize, { once: true });
      } else {
        panel.classList.add('hidden');
      }
      if(toggle){
        toggle.setAttribute('aria-expanded', 'false');
      }
    }

    proInfoToggles.forEach(toggle => {
      const root = toggle.closest('[data-auth-root]');
      const panel = root?.querySelector('[data-pro-info-panel]');
      if(!panel) return;
      toggle.addEventListener('click', () => {
        const isOpen = panel.classList.contains('is-visible') && !panel.classList.contains('hidden');
        if(isOpen){
          hideProInfoPanel(panel, toggle);
        } else {
          panel.classList.remove('hidden');
          requestAnimationFrame(() => panel.classList.add('is-visible'));
          toggle.setAttribute('aria-expanded', 'true');
        }
      });
    });

    function closeAuthModal(modal = activeAuthModal){
      if(!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      if(modal === activeAuthModal){
        activeAuthModal = null;
      }
      const panel = modal.querySelector('[data-pro-info-panel]');
      const toggle = modal.querySelector('[data-pro-info-toggle]');
      hideProInfoPanel(panel, toggle);
      if(!getOpenAuthModal()){
        document.body.classList.remove('overflow-hidden');
      }
    }

    async function handleDirectPharmacySignIn(button){
      // 🛠️ Άμεση ροή magic link από το CTA με feedback στον φαρμακοποιό
      if(!supabase){
        console.warn('⚠️ Το Supabase δεν ρυθμίστηκε – έλεγξε τα κλειδιά στο env.js.');
        showAuthToast('Αποτυχία σύνδεσης: λείπουν ρυθμίσεις Supabase.', 'error');
        return;
      }

      const email = window.prompt('Πληκτρολόγησε το email σου για magic link:');
      const trimmed = email?.trim();
      if(!trimmed){
        showAuthToast('Παρακαλούμε συμπλήρωσε email για να συνεχίσεις.', 'error');
        return;
      }

      try{
        setAuthButtonLoading(button, true);
        const { error } = await supabase.auth.signInWithOtp({
          email: trimmed,
          options: { emailRedirectTo: EMAIL_REDIRECT_URL }
        });
        // Εναλλακτική: Google OAuth ροή
        // const { error } = await supabase.auth.signInWithOAuth({ provider: 'google' });
        if(error) throw error;
        showAuthToast('Σου στείλαμε email σύνδεσης.');
      }catch(err){
        const message = err?.message || 'Κάτι πήγε στραβά.';
        showAuthToast(`Αποτυχία σύνδεσης: ${message}`, 'error');
      }finally{
        setAuthButtonLoading(button, false);
      }
    }

    function updateAuthHeaderUI(userOverride){
      const user = userOverride || getSessionUser();
      const email = user?.email || user?.user_metadata?.name || user?.phone || '';
      authOpenButtons.forEach(btn => btn.classList.toggle('hidden', !!user));
      if(authHeaderSession){ authHeaderSession.classList.toggle('hidden', !user); }
      if(authHeaderAvatar){
        const initial = (email || 'Μ').trim().charAt(0).toUpperCase();
        authHeaderAvatar.textContent = initial || 'Μ';
      }
      if(authHeaderEmail){ authHeaderEmail.textContent = email; }
      signOutBtn?.classList.toggle('hidden', !user);
    }

    updateAuthHeaderUI();
    updateOwnerWelcome();
    renderHoursWidget();
    syncDashboardVisibility();

    if(supabase){
      supabase.auth.getSession().then(({ data })=>{
        authSession = data?.session || null;
        updateAuthSessionUI();
      }).catch(()=>undefined);
      supabase.auth.onAuthStateChange((_event, session)=>{
        authSession = session;
        updateAuthSessionUI();
      });
    }

    modalAuthButtons.forEach(btn => {
      btn.addEventListener('click', event => {
        event.preventDefault();
        openAuthModal(btn.dataset.authTarget || 'pharmacies');
      });
    });

    if(directPharmacyButton){
      directPharmacyButton.addEventListener('click', async event => {
        event.preventDefault();
        await handleDirectPharmacySignIn(directPharmacyButton);
      });
    }

    dashTabs.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.dashTab;
        if(tab){
          setActiveDashboardTab(tab);
        }
      });
    });

    authCloseEls.forEach(btn => btn.addEventListener('click', () => {
      const modal = btn.closest('[data-auth-modal]');
      closeAuthModal(modal || undefined);
    }));

    document.addEventListener('keydown', event => {
      if(event.key === 'Escape' && getOpenAuthModal()){
        closeAuthModal();
      }
    });

    document.addEventListener('mediradar-auth-change', event => {
      const user = event?.detail?.user || null;
      if(user){
        updateAuthHeaderUI(user);
        if(supabase){
          supabase.auth.getSession()
            .then(({ data }) => {
              if(data?.session){
                authSession = data.session;
                updateAuthSessionUI();
              }
            })
            .catch(()=>undefined);
        }
        setTimeout(()=> closeAuthModal(), 2200);
      } else {
        authSession = null;
        updateAuthHeaderUI(null);
        updateAuthSessionUI();
      }
    });

    signOutBtn?.addEventListener('click', async ()=>{
      if(!supabase) return;
      try{
        await supabase.auth.signOut();
      }catch(err){
        console.warn('signout error', err);
      }
    });

    function updateAuthSessionUI(){
      if(!authSessionEl) return;
      const loggedIn = !!authSession?.user;
      const identifier = authSession?.user?.email || authSession?.user?.phone || authSession?.user?.user_metadata?.name || authSession?.user?.id || '';
      authSessionEl.textContent = loggedIn
        ? `Συνδεδεμένος ως ${identifier || 'λογαριασμός'}`
        : 'Δεν έχεις συνδεθεί';
      updateAuthHeaderUI();
      updateOwnerWelcome();
      renderHoursWidget();
      hoursAuthAlert?.classList.toggle('hidden', loggedIn);
      updateScheduleButtons();
      syncDashboardVisibility({ refresh: true });
    }
    updateAuthSessionUI();

    /* ---------- pharmacy CRUD ---------- */
    async function loadPharmacies(){
      const { data, error } = await supabase.from('pharmacies').select('id,name,city,address,phone').order('name');
      if(error){ console.warn(error); return; }
      selPh.innerHTML = `<option value="">— Επιλογή —</option>` + (data||[]).map(p=>`<option value="${p.id}" data-city="${p.city||''}" data-addr="${p.address||''}" data-phone="${p.phone||''}">${p.name} — ${p.city||'—'}</option>`).join('');
    }

    async function createPharmacy(){
      const name = qs('#new-name').value.trim();
      const address = qs('#new-addr').value.trim();
      const phone = qs('#new-phone').value.trim();
      const city = qs('#new-city').value;
      if(!name || !city){ alert('Όνομα και Πόλη είναι υποχρεωτικά'); return; }
      const { data, error } = await supabase.from('pharmacies').insert({ name, address, phone, city }).select('id,name,city,address,phone').single();
      if(error){ alert('Σφάλμα δημιουργίας φαρμακείου'); console.warn(error); return; }
      await loadPharmacies();
      selPh.value = data.id;
      applyPickedFromSelect();
      qs('#new-name').value=''; qs('#new-addr').value=''; qs('#new-phone').value=''; qs('#new-city').value='';
    }

    async function applyPickedFromSelect(){
      const id = selPh.value;
      if(!id){
        pickedBox.classList.add('hidden');
        store.pharmacy=null;
        scheduleState.draft = createEmptySchedule();
        scheduleState.saved = createEmptySchedule();
        scheduleState.meta = null;
        refreshScheduleUI({ silent:true });
        setHoursMeta(null);
        setHoursStatus('', 'muted');
        renderHoursWidget();
        syncDashboardVisibility();
        return;
      }
      const opt = selPh.selectedOptions[0];
      store.pharmacy = { id, name: opt.textContent.split(' — ')[0], city: opt.dataset.city, address: opt.dataset.addr, phone: opt.dataset.phone };
      pName.textContent = store.pharmacy.name;
      pCity.textContent = store.pharmacy.city || '—';
      pAddr.textContent = store.pharmacy.address || '—';
      pPhone.textContent = store.pharmacy.phone || '—';
      pickedBox.classList.remove('hidden');
      cityPill.textContent = store.pharmacy.city || '—';
      renderHoursWidget();
      if(store.pharmacy?.id && supabase){
        scheduleState.loading = true;
        updateScheduleButtons();
        setHoursStatus('Φόρτωση ωραρίου…', 'muted');
        await loadScheduleForCurrentPharmacy();
      }
      syncDashboardVisibility({ refresh: true });
    }

    /* ---------- hours ---------- */
    function normalizeSchedule(list = []){
      return list.map(item => ({
        dayIndex: item.dayIndex,
        open: !!item.open,
        start: item.start || '',
        end: item.end || ''
      }));
    }

    // 🆕 Μετατροπή του ωραρίου ώστε να αποθηκεύεται και στο opening_hours JSON του Supabase
    function buildOpeningHoursPayload(schedule){
      const payload = {};
      (schedule || []).forEach(entry => {
        if(entry.open && entry.start && entry.end){
          payload[entry.dayIndex] = { open: true, start: entry.start, end: entry.end };
        } else {
          payload[entry.dayIndex] = { open: false };
        }
      });
      payload._meta = {
        updatedAt: new Date().toISOString(),
        updatedBy: getOwnerFriendlyName() || authSession?.user?.email || authSession?.user?.id || 'pharmacy_demo'
      };
      return payload;
    }

    function setupScheduleEditor(){
      if(!hoursGrid) return;
      hoursGrid.innerHTML = '';
      dayControls.clear();
      WEEK_DAYS.forEach(day => {
        const card = document.createElement('div');
        card.className = 'rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/40 p-4 flex flex-col gap-3 transition-colors';
        card.dataset.dayIndex = String(day.index);

        const header = document.createElement('div');
        header.className = 'flex items-start justify-between gap-2';

        const labelWrap = document.createElement('div');
        const title = document.createElement('div');
        title.className = 'text-sm font-semibold text-slate-900 dark:text-slate-100';
        title.textContent = day.labels?.el || day.labels?.en || day.name || '';
        const status = document.createElement('div');
        status.className = 'text-[11px] text-slate-500 dark:text-slate-400';
        status.textContent = 'Κλειστό';
        labelWrap.append(title, status);

        const toggleWrap = document.createElement('label');
        toggleWrap.className = 'inline-flex items-center gap-2 text-xs font-medium text-slate-600 dark:text-slate-300';
        const toggle = document.createElement('input');
        toggle.type = 'checkbox';
        toggle.className = 'size-4 accent-emerald-600 rounded';
        toggleWrap.append(toggle, document.createTextNode('Ανοιχτό'));

        header.append(labelWrap, toggleWrap);

        const timesWrap = document.createElement('div');
        timesWrap.className = 'grid grid-cols-2 gap-2 transition-opacity';
        const startInput = document.createElement('input');
        startInput.type = 'time';
        startInput.className = 'px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/40';
        const endInput = document.createElement('input');
        endInput.type = 'time';
        endInput.className = 'px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/40';

        timesWrap.append(startInput, endInput);
        card.append(header, timesWrap);
        hoursGrid.appendChild(card);

        dayControls.set(day.index, {
          card,
          toggle,
          statusEl: status,
          timesWrap,
          startInput,
          endInput
        });

        toggle.addEventListener('change', ()=> handleToggleChange(day.index, toggle.checked));
        startInput.addEventListener('input', ()=> handleTimeChange(day.index, 'start', startInput.value));
        endInput.addEventListener('input', ()=> handleTimeChange(day.index, 'end', endInput.value));
      });

      refreshScheduleUI({ silent:true });
    }

    function getScheduleEntry(dayIndex){
      return scheduleState.draft.find(item => item.dayIndex === dayIndex);
    }

    function handleToggleChange(dayIndex, checked){
      const entry = getScheduleEntry(dayIndex);
      if(!entry) return;
      entry.open = !!checked;
      if(!entry.open){
        entry.start = '';
        entry.end = '';
      }
      refreshScheduleUI({ silent:true });
      setDirtyStatusMessage();
    }

    function handleTimeChange(dayIndex, role, value){
      const entry = getScheduleEntry(dayIndex);
      if(!entry) return;
      if(role === 'start'){ entry.start = value; }
      else { entry.end = value; }
      refreshScheduleUI({ silent:true });
      setDirtyStatusMessage();
    }

    function refreshScheduleUI({ silent=false } = {}){
      scheduleState.draft.forEach(entry => {
        const controls = dayControls.get(entry.dayIndex);
        if(!controls) return;
        controls.toggle.checked = !!entry.open;
        controls.startInput.value = entry.start || '';
        controls.endInput.value = entry.end || '';
        const isOpen = !!entry.open;
        controls.timesWrap.classList.toggle('opacity-40', !isOpen);
        controls.timesWrap.classList.toggle('pointer-events-none', !isOpen);
        controls.statusEl.textContent = isOpen && entry.start && entry.end
          ? `${entry.start} – ${entry.end}`
          : 'Κλειστό';
        controls.card.classList.remove('ring-2','ring-rose-400','border-rose-300','dark:border-rose-500/50');
        controls.statusEl.classList.remove('text-rose-500');
      });
      applyValidationToUI();
      renderHoursWidget();
      updateScheduleButtons();
      if(!silent){
        setDirtyStatusMessage();
      }
    }

    function applyValidationToUI(){
      const errors = validateSchedule(scheduleState.draft);
      scheduleState.errors = errors;
      const invalidDays = new Set(errors.map(err => err.dayIndex));
      dayControls.forEach((controls, dayIndex)=>{
        const invalid = invalidDays.has(dayIndex);
        controls.card.classList.toggle('ring-2', invalid);
        controls.card.classList.toggle('ring-rose-400', invalid);
        controls.card.classList.toggle('border-rose-300', invalid);
        controls.card.classList.toggle('dark:border-rose-500/50', invalid);
        controls.statusEl.classList.toggle('text-rose-500', invalid);
      });
    }

    function isScheduleDirty(){
      return JSON.stringify(normalizeSchedule(scheduleState.draft)) !== JSON.stringify(normalizeSchedule(scheduleState.saved));
    }

    function updateScheduleButtons(){
      scheduleState.dirty = isScheduleDirty();
      const saveDisabled = !authSession?.user || scheduleState.loading || !scheduleState.dirty || (scheduleState.errors?.length ?? 0) > 0;
      if(saveHoursBtn) saveHoursBtn.disabled = !!saveDisabled;
      if(cancelHoursBtn) cancelHoursBtn.disabled = scheduleState.loading || !scheduleState.dirty;
    }

    function setHoursStatus(message='', tone='muted'){
      if(!hoursStatusEl) return;
      let cls = 'text-sm ';
      if(tone === 'error'){ cls += 'text-rose-500 dark:text-rose-300'; }
      else if(tone === 'success'){ cls += 'text-emerald-600 dark:text-emerald-300'; }
      else if(tone === 'warning'){ cls += 'text-amber-600 dark:text-amber-300'; }
      else { cls += 'text-slate-500 dark:text-slate-400'; }
      hoursStatusEl.className = cls;
      hoursStatusEl.textContent = message;
    }

    function setHoursMeta(meta){
      if(!hoursMetaEl) return;
      if(meta?.updatedAt){
        try{
          const dt = new Date(meta.updatedAt);
          const formatted = dt.toLocaleString('el-GR', { hour12:false });
          hoursMetaEl.textContent = `Τελευταία ενημέρωση: ${formatted}${meta.updatedBy ? ` • ${meta.updatedBy}` : ''}`;
        }catch(err){
          hoursMetaEl.textContent = `Τελευταία ενημέρωση: ${meta.updatedAt}${meta.updatedBy ? ` • ${meta.updatedBy}` : ''}`;
        }
      }else{
        hoursMetaEl.textContent = '';
      }
    }

    function setDirtyStatusMessage(){
      if(scheduleState.errors.length){
        setHoursStatus('Διόρθωσε τις επισημάνσεις πριν την αποθήκευση.', 'error');
      }else if(scheduleState.dirty){
        setHoursStatus('Υπάρχουν μη αποθηκευμένες αλλαγές.', 'muted');
      }else if(scheduleState.meta?.updatedAt){
        try{
          const dt = new Date(scheduleState.meta.updatedAt);
          setHoursStatus(`Τελευταία ενημέρωση ${dt.toLocaleString('el-GR', { hour12:false })}.`, 'muted');
        }catch{
          setHoursStatus('', 'muted');
        }
      }else{
        setHoursStatus('', 'muted');
      }
    }

    async function loadScheduleForCurrentPharmacy(){
      if(!store.pharmacy?.id || !supabase){ return; }
      try{
        const { schedule, meta } = await loadSchedule(store.pharmacy.id, { client: supabase });
        scheduleState.saved = cloneSchedule(schedule);
        scheduleState.draft = cloneSchedule(schedule);
        scheduleState.meta = meta || null;
        refreshScheduleUI({ silent:true });
        setHoursMeta(meta || null);
        setHoursStatus('Το ωράριο φορτώθηκε.', 'success');
      }catch(err){
        console.warn('load schedule error', err);
        scheduleState.saved = createEmptySchedule();
        scheduleState.draft = createEmptySchedule();
        scheduleState.meta = null;
        refreshScheduleUI({ silent:true });
        setHoursMeta(null);
        setHoursStatus('Αποτυχία φόρτωσης ωραρίου.', 'error');
      }finally{
        scheduleState.loading = false;
        updateScheduleButtons();
      }
    }

    async function handleSaveSchedule(){
      if(!store.pharmacy?.id || !supabase) return;
      scheduleState.errors = validateSchedule(scheduleState.draft);
      if(scheduleState.errors.length){
        applyValidationToUI();
        updateScheduleButtons();
        setHoursStatus('Διόρθωσε τις επισημάνσεις πριν την αποθήκευση.', 'error');
        return;
      }
      if(!authSession?.user){
        hoursAuthAlert?.classList.remove('hidden');
        setHoursStatus('Πρέπει να συνδεθείς για να αποθηκεύσεις.', 'error');
        updateScheduleButtons();
        return;
      }
      scheduleState.loading = true;
      updateScheduleButtons();
      setHoursStatus('Αποθήκευση…', 'muted');
      try{
        const { schedule, meta } = await saveSchedule(store.pharmacy.id, scheduleState.draft, { client: supabase, session: authSession });
        scheduleState.saved = cloneSchedule(schedule);
        scheduleState.draft = cloneSchedule(schedule);
        scheduleState.meta = meta || null;
        refreshScheduleUI({ silent:true });
        setHoursMeta(meta || null);
        setHoursStatus('Το ωράριο αποθηκεύτηκε.', 'success');
        try{
          const openingPayload = buildOpeningHoursPayload(scheduleState.saved);
          await supabase.from('pharmacies').update({ opening_hours: openingPayload }).eq('id', store.pharmacy.id);
        }catch(syncErr){
          console.warn('opening_hours sync error', syncErr);
        }
      }catch(err){
        console.warn('save schedule error', err);
        setHoursStatus(err?.message || 'Αποτυχία αποθήκευσης ωραρίου.', 'error');
      }finally{
        scheduleState.loading = false;
        updateScheduleButtons();
      }
    }

    function handleCancelSchedule(){
      scheduleState.draft = cloneSchedule(scheduleState.saved);
      refreshScheduleUI({ silent:true });
      setDirtyStatusMessage();
    }

    setupScheduleEditor();
    setHoursMeta(scheduleState.meta);
    setHoursStatus('', 'muted');

    /* ---------- requests feed ---------- */
    const demoRequestSeeds = [
      { id: 'demo-req-1', med_name: 'Augmentin 1g', active_substance: 'Αμοξικιλλίνη', med_type: 'Δισκία', quantity: 1, allow_generic: false },
      { id: 'demo-req-2', med_name: 'Salospir 100mg', active_substance: 'Ακετυλοσαλικυλικό', med_type: 'Δισκία', quantity: 2, allow_generic: true },
      { id: 'demo-req-3', med_name: 'Apotel 1g', active_substance: 'Παρακεταμόλη', med_type: 'Κόνις', quantity: 1, allow_generic: true },
      { id: 'demo-req-4', med_name: 'Prospan Σιρόπι', active_substance: 'Κισσός', med_type: 'Σιρόπι', quantity: 1, allow_generic: false }
    ];

    function buildDemoRequests(){
      const baseCity = store.pharmacy?.city || 'Αθήνα';
      const now = Date.now();
      return demoRequestSeeds.map((item, index) => ({
        ...item,
        id: `${item.id}-${baseCity}`,
        city: baseCity,
        status: 'pending',
        created_at: new Date(now - index * 60 * 60 * 1000).toISOString()
      }));
    }

    // 🆕 Κάρτα αιτήματος για εμφανή προεπισκόπηση στους φαρμακοποιούς
    function renderRequestCard(row){
      const createdAt = row.created_at ? new Date(row.created_at) : new Date();
      const card = document.createElement('div');
      card.className = 'rounded-xl border border-emerald-200/50 dark:border-emerald-500/40 bg-white/80 dark:bg-emerald-500/10 p-4 flex flex-col gap-2 shadow-sm transition-opacity';
      card.dataset.id = row.id;
      card.dataset.allowGeneric = row.allow_generic ? 'true' : 'false';
      card.innerHTML = `
        <div class="flex flex-wrap items-start justify-between gap-2">
          <div>
            <div class="font-semibold text-slate-900 dark:text-white">${row.med_name}</div>
            <div class="text-xs text-slate-500 dark:text-slate-300">${createdAt.toLocaleString('el-GR', { hour12:false })}</div>
          </div>
          <span class="inline-flex items-center gap-1 rounded-full bg-amber-100/80 dark:bg-amber-500/10 px-2 py-1 text-[11px] font-semibold text-amber-700 dark:text-amber-200">Εκκρεμεί</span>
        </div>
        <div class="text-sm text-slate-600 dark:text-slate-300">
          ${row.active_substance ? `Ουσία: <strong>${row.active_substance}</strong> • ` : ''}Τύπος: ${row.med_type || '—'} • Ποσότητα: ${row.quantity ?? '—'}
        </div>
        <div class="flex flex-wrap items-center gap-2 text-xs text-emerald-600 dark:text-emerald-200">
          <span>${row.city || '—'}</span>
          ${row.allow_generic ? '<span class="rounded-full bg-emerald-100/80 dark:bg-emerald-500/20 px-2 py-0.5 font-semibold">Δέχεται γενόσημο</span>' : ''}
        </div>
        <div class="mt-2 flex flex-wrap items-center gap-2">
          <button class="avail btn bg-emerald-600 text-white border-emerald-700 hover:opacity-95 px-4 py-2 text-sm font-semibold">Διαθέσιμο</button>
        </div>
      `;
      return card;
    }

    // 🆕 Φόρτωση μόνο των εκκρεμών αιτημάτων 24ώρου (ή demo) ανά πόλη φαρμακείου
    async function loadRequests(){
      if(!reqList) return;
      reqList.innerHTML = '';
      emptyState?.classList.add('hidden');
      if(!store.pharmacy?.city){
        return;
      }

      const cutoffIso = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
      let rows = [];
      let usedDemo = false;

      if(supabase){
        try{
          const { data, error } = await supabase
            .from('requests')
            .select('id, created_at, med_name, active_substance, med_type, quantity, allow_generic, city, status')
            .eq('city', store.pharmacy.city)
            .eq('status', 'pending')
            .gte('created_at', cutoffIso)
            .order('created_at', { ascending:false })
            .limit(50);
          if(error) throw error;
          rows = (data || []).filter(item => {
            if(!item?.created_at) return true;
            try{
              return new Date(item.created_at).getTime() >= Date.now() - 24 * 60 * 60 * 1000;
            }catch{
              return true;
            }
          });
        }catch(err){
          console.warn('loadRequests error', err);
          usedDemo = true;
          setDashboardStatus('Αποτυχία φόρτωσης Supabase – προβάλλονται demo αιτήματα.', 'warning');
        }
      } else {
        usedDemo = true;
        console.warn('Supabase configuration missing για τα αιτήματα. Ενεργοποιείται demo λίστα.');
        setDashboardStatus('Δεν βρέθηκαν κλειδιά Supabase. Προβάλλονται demo αιτήματα.', 'warning');
      }

      if(!rows.length){
        rows = buildDemoRequests();
        usedDemo = true;
      }

      if(!rows.length){
        emptyState?.classList.remove('hidden');
        return;
      }

      if(!usedDemo){
        setDashboardStatus('', 'info');
      }

      rows.forEach(row => {
        const card = renderRequestCard(row);
        reqList.appendChild(card);
      });
    }

    // 🆕 Καταχώρηση απάντησης «Διαθέσιμο» στο Supabase και άμεση ενημέρωση UI
    async function handleAvailabilityResponse(card){
      if(!card) return;
      if(!store.pharmacy?.id){
        showAuthToast('Επίλεξε φαρμακείο πριν απαντήσεις.', 'warning');
        return;
      }
      if(!supabase){
        console.warn('Δεν είναι διαθέσιμος ο Supabase client – η απάντηση «Διαθέσιμο» δεν θα αποθηκευτεί.');
        showAuthToast('Demo λειτουργία: η απάντηση δεν αποθηκεύτηκε στο cloud.', 'warning');
        card.classList.add('opacity-60');
        return;
      }

      const btn = card.querySelector('.avail');
      if(!btn) return;
      const originalLabel = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Αποστολή…';
      btn.classList.add('opacity-70');

      try{
        const requestId = card.dataset.id;
        const respondedAt = new Date().toISOString();
        const responsePayload = {
          request_id: requestId,
          pharmacy_id: store.pharmacy.id,
          available: true,
          responded_at: respondedAt
        };
        const { error: insertError } = await supabase
          .from('responses')
          .upsert(responsePayload, { onConflict: 'request_id,pharmacy_id' });
        if(insertError) throw insertError;

        const { error: updateError } = await supabase
          .from('requests')
          .update({ status: 'has_responses' })
          .eq('id', requestId)
          .eq('status', 'pending');
        if(updateError) throw updateError;

        showAuthToast('Η διαθεσιμότητα καταχωρήθηκε με επιτυχία!', 'success');
        setDashboardStatus('Το αίτημα ενημερώθηκε ως διαθέσιμο από το φαρμακείο σου.', 'success');
        btn.textContent = 'Καταχωρήθηκε';
        btn.classList.remove('opacity-70');
        btn.classList.add('opacity-60');
        card.classList.add('opacity-60');
        card.classList.add('pointer-events-none');
        window.setTimeout(() => {
          loadRequests();
        }, 400);
      }catch(err){
        console.warn('availability response error', err);
        showAuthToast(`Αποτυχία καταχώρησης: ${err?.message || 'δοκίμασε ξανά.'}`, 'error');
        btn.disabled = false;
        btn.textContent = originalLabel;
        btn.classList.remove('opacity-70');
        return;
      }

      btn.setAttribute('aria-disabled', 'true');
    }

    /* ---------- events ---------- */
    qs('#create-pharmacy').addEventListener('click', createPharmacy);
    selPh.addEventListener('change', applyPickedFromSelect);
    reloadPh.addEventListener('click', loadPharmacies);
    saveHoursBtn.addEventListener('click', handleSaveSchedule);
    cancelHoursBtn.addEventListener('click', handleCancelSchedule);
    reloadReq.addEventListener('click', ()=>{
      if(activeDashTab !== 'requests'){
        setActiveDashboardTab('requests');
      } else {
        loadRequests();
      }
    });

    reqList.addEventListener('click', async (e)=>{
      const card = e.target.closest('[data-id]');
      if(!card) return;
      if(e.target.closest('.avail')){
        await handleAvailabilityResponse(card);
      }
    });

    /* ---------- realtime (optional) ---------- */
    try{
      supabase
        .channel('requests-feed')
        .on('postgres_changes', { event: 'INSERT', schema:'public', table:'requests', filter:`city=eq.${encodeURIComponent(store.pharmacy?.city||'')}` }, (payload)=>{
          loadRequests();
        })
        .subscribe();
    }catch{}

    /* ---------- init ---------- */
    await loadPharmacies();
  </script>
  <script type="module" src="/auth/magic-link-widget.js"></script>
</body>
</html>
