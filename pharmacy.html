<!DOCTYPE html>
<html lang="el" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediRadar Pro - Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { primary: '#0f172a', secondary: '#0d9488' },
                    animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>
    <style>
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        html.dark .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        /* Toast Animation */
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 min-h-screen flex flex-col">

    <nav class="bg-white dark:bg-slate-800 shadow-sm border-b border-slate-200 dark:border-slate-700 p-4 sticky top-0 z-30">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-secondary rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="ph ph-first-aid-kit text-2xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">MediRadar <span class="text-secondary">Pro</span></h1>
                    <p class="text-xs text-slate-500 dark:text-slate-400" id="pharmacy-name-display">ÎšÎ­Î½Ï„ÏÎ¿ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚</p>
                </div>
            </div>
            
            <div class="flex gap-3 items-center">
                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                    <i class="ph ph-moon-stars text-xl"></i>
                </button>
                <div id="auth-section">
                    </div>
            </div>
        </div>
    </nav>

    <div id="login-overlay" class="fixed inset-0 z-50 bg-slate-900/90 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border border-slate-700">
            <div class="w-20 h-20 bg-secondary/20 rounded-full flex items-center justify-center mx-auto mb-6 text-secondary">
                <i class="ph ph-lock-key text-4xl"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2 text-slate-900 dark:text-white">Î£ÏÎ½Î´ÎµÏƒÎ· Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…</h2>
            <p class="text-slate-500 mb-8 text-sm">Î£Ï…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ Î³Î¹Î± Î½Î± Î´ÎµÎ¯Ï„Îµ Î±Î¹Ï„Î®Î¼Î±Ï„Î± Ï†Î±ÏÎ¼Î¬ÎºÏ‰Î½ ÏƒÏ„Î·Î½ Ï€ÎµÏÎ¹Î¿Ï‡Î® ÏƒÎ±Ï‚.</p>
            
            <form id="login-form" class="space-y-4 text-left">
                <div>
                    <label class="text-xs font-bold uppercase ml-1 text-slate-500">Email</label>
                    <input type="email" id="email" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-secondary outline-none" placeholder="pharmacy@example.com" required>
                </div>
                <div>
                    <label class="text-xs font-bold uppercase ml-1 text-slate-500">ÎšÏ‰Î´Î¹ÎºÏŒÏ‚</label>
                    <input type="password" id="password" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-secondary outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <button type="submit" class="w-full bg-secondary hover:bg-teal-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg">
                    Î•Î¯ÏƒÎ¿Î´Î¿Ï‚
                </button>
            </form>
            
            <div class="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                <button onclick="demoLogin()" class="w-full bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-200 font-semibold py-3 rounded-xl transition-all flex items-center justify-center gap-2">
                    <i class="ph ph-flask text-lg"></i> Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Demo (Test)
                </button>
                <p class="text-xs text-slate-400 mt-2">Î”ÎµÎ½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ ÎµÎ³Î³ÏÎ±Ï†Î® Î³Î¹Î± Ï„Î¿ Demo.</p>
            </div>
        </div>
    </div>

    <main class="max-w-6xl mx-auto p-4 w-full grid grid-cols-1 lg:grid-cols-4 gap-6 flex-grow">
        
        <div class="lg:col-span-1 space-y-6">
            <div class="glass-panel p-5 rounded-2xl shadow-sm">
                <h3 class="font-bold text-xs uppercase text-slate-500 mb-4">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</h3>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" checked class="sr-only peer">
                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-300 dark:peer-focus:ring-teal-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-secondary"></div>
                    <span class="ml-3 text-sm font-medium text-slate-900 dark:text-slate-300">Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ Î¤ÏÏÎ±</span>
                </label>
                <p class="text-xs text-slate-400 mt-2">Î•Î½ÎµÏÎ³ÏŒ Î³Î¹Î± Î»Î®ÏˆÎ· ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ‰Î½.</p>
            </div>

            <div class="glass-panel p-5 rounded-2xl shadow-sm grid grid-cols-2 gap-4 text-center">
                <div>
                    <p class="text-2xl font-bold text-secondary">12</p>
                    <p class="text-xs text-slate-500">Î‘Î¹Ï„Î®Î¼Î±Ï„Î± Î£Î®Î¼ÎµÏÎ±</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-slate-700 dark:text-slate-300">4</p>
                    <p class="text-xs text-slate-500">Î‘Ï€Î±Î½Ï„Î®Î¸Î·ÎºÎ±Î½</p>
                </div>
            </div>
        </div>

        <div class="lg:col-span-3">
            <div class="flex justify-between items-end mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="ph ph-bell-ringing text-secondary animate-pulse-slow"></i> Î•Î¹ÏƒÎµÏÏ‡ÏŒÎ¼ÎµÎ½Î± Î‘Î¹Ï„Î®Î¼Î±Ï„Î±
                </h2>
                <button onclick="fetchRequests()" class="text-sm text-secondary font-semibold hover:underline">
                    <i class="ph ph-arrows-clockwise"></i> Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·
                </button>
            </div>

            <div id="loading-spinner" class="hidden text-center py-10">
                <i class="ph ph-spinner animate-spin text-3xl text-secondary"></i>
                <p class="text-sm text-slate-500 mt-2">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î½Î­Ï‰Î½ Î±Î¹Ï„Î·Î¼Î¬Ï„Ï‰Î½...</p>
            </div>

            <div id="requests-container" class="space-y-4">
                </div>
        </div>
    </main>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-2"></div>

    <script src="env.js"></script>
    <script src="supabase.js"></script>

    <script>
        // --- Pharmacist Dashboard Logic ---
        let currentUser = null;

        // 1. Check Auth on Load
        window.onload = async function() {
            if(!window.db) {
                console.error("Supabase not initialized");
                return;
            }

            const { data: { session } } = await window.db.auth.getSession();
            if (session) {
                handleLoginSuccess(session.user);
            } else {
                // Show Login Overlay
                document.getElementById('login-overlay').classList.remove('hidden');
            }
        };

        function handleLoginSuccess(user) {
            currentUser = user;
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('auth-section').innerHTML = `
                <span class="text-xs font-medium mr-2">${user.email}</span>
                <button onclick="handleLogout()" class="text-xs bg-slate-200 dark:bg-slate-700 px-3 py-1 rounded-lg hover:bg-red-500 hover:text-white transition-colors">ÎˆÎ¾Î¿Î´Î¿Ï‚</button>
            `;
            fetchRequests();
            subscribeToRequests();
        }

        // 2. Login Functions
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const { data, error } = await window.db.auth.signInWithPassword({ email, password });
            if (error) {
                showToast('Î£Ï†Î¬Î»Î¼Î±: ' + error.message, 'error');
            } else {
                handleLoginSuccess(data.user);
            }
        });

        async function demoLogin() {
            // Anonymous Sign In for Demo
            const { data, error } = await window.db.auth.signInAnonymously();
            if (error) {
                // Î‘Î½ Ï„Î¿ anonymous ÎµÎ¯Î½Î±Î¹ ÎºÎ»ÎµÎ¹ÏƒÏ„ÏŒ, ÎºÎ¬Î½Î¿Ï…Î¼Îµ fallback ÏƒÎµ fake user state Î³Î¹Î± UI demo
                currentUser = { id: 'demo_pharmacist', email: 'demo@pharmacy.gr' };
                handleLoginSuccess(currentUser);
                showToast('Î•Î¯ÏƒÎ¿Î´Î¿Ï‚ ÏƒÎµ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Demo', 'success');
            } else {
                handleLoginSuccess(data.user);
            }
        }

        async function handleLogout() {
            await window.db.auth.signOut();
            window.location.reload();
        }

        // 3. Fetch Requests
        async function fetchRequests() {
            const spinner = document.getElementById('loading-spinner');
            const container = document.getElementById('requests-container');
            
            spinner.classList.remove('hidden');
            
            // Î¦Î­ÏÎ½Î¿Ï…Î¼Îµ Î±Î¹Ï„Î®Î¼Î±Ï„Î± Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ 'pending'
            const { data, error } = await window.db
                .from('requests')
                .select('*')
                .eq('status', 'pending')
                .order('created_at', { ascending: false });

            spinner.classList.add('hidden');

            if (error) {
                showToast('Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚: ' + error.message, 'error');
                return;
            }

            container.innerHTML = '';

            if(data && data.length > 0) {
                data.forEach(req => {
                    container.innerHTML += createRequestCard(req);
                });
            } else {
                container.innerHTML = `
                    <div class="text-center py-16 bg-white/50 dark:bg-slate-800/50 rounded-3xl border-2 border-dashed border-slate-300 dark:border-slate-700">
                        <i class="ph ph-check-circle text-4xl text-slate-300 mb-2"></i>
                        <p class="text-slate-500">ÎšÎ±Î½Î­Î½Î± ÎµÎºÎºÏÎµÎ¼Î­Ï‚ Î±Î¯Ï„Î·Î¼Î±.</p>
                        <p class="text-xs text-slate-400">Î˜Î± ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯Ï„Îµ Î¼ÏŒÎ»Î¹Ï‚ Ï…Ï€Î¬ÏÎ¾ÎµÎ¹ Î½Î­Î¿.</p>
                    </div>`;
            }
        }

        // 4. HTML Generator for Request Card
        function createRequestCard(req) {
            const timeAgo = new Date(req.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Logic for badges
            const typeBadge = req.med_type ? `<span class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-[10px] font-bold px-2 py-1 rounded uppercase">${req.med_type}</span>` : '';
            const mediaButton = req.media_url 
                ? `<a href="${req.media_url}" target="_blank" class="text-blue-500 hover:text-blue-600 text-xs font-bold flex items-center gap-1 bg-blue-50 dark:bg-blue-900/20 px-2 py-1 rounded"><i class="ph ph-image"></i> Î ÏÎ¿Î²Î¿Î»Î® Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚</a>` 
                : '';
            const barcodeBadge = req.barcode 
                ? `<span class="text-slate-500 text-xs font-mono bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded flex items-center gap-1"><i class="ph ph-barcode"></i> ${req.barcode}</span>` 
                : '';

            return `
            <div id="card-${req.id}" class="glass-panel p-5 rounded-2xl shadow-sm hover:shadow-md transition-all border-l-4 border-l-secondary relative group">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <span class="bg-teal-100 text-teal-700 dark:bg-teal-900 dark:text-teal-300 text-xs font-bold px-2 py-1 rounded-md flex items-center gap-1">
                            <i class="ph ph-clock"></i> ${timeAgo}
                        </span>
                        ${typeBadge}
                        <span class="text-xs font-bold text-slate-500 flex items-center gap-1"><i class="ph ph-map-pin"></i> ${req.location || 'Î†Î³Î½Ï‰ÏƒÏ„Î· Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±'}</span>
                    </div>
                </div>
                
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-1 flex items-center gap-2">
                            ${req.medicine_name}
                            <span class="text-sm font-normal text-slate-500">x${req.quantity || 1}</span>
                        </h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-2">${req.substance || 'Î§Ï‰ÏÎ¯Ï‚ Î´Î¹ÎµÏ…ÎºÏÎ¯Î½Î¹ÏƒÎ· Î´ÏÎ±ÏƒÏ„Î¹ÎºÎ®Ï‚'}</p>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        ${mediaButton}
                        ${barcodeBadge}
                    </div>
                </div>
                
                ${req.notes ? `<div class="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg text-xs text-slate-600 dark:text-slate-300 italic border border-slate-100 dark:border-slate-700 mb-4">" ${req.notes} "</div>` : ''}

                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mt-4">
                    <button onclick="sendResponse('${req.id}', 'original')" class="col-span-1 bg-secondary hover:bg-teal-700 text-white py-2.5 rounded-xl font-bold text-xs transition-all shadow-lg shadow-teal-500/20 flex items-center justify-center gap-2">
                        <i class="ph ph-check-circle text-lg"></i> ÎˆÏ‡Ï‰ Ï„Î¿ Î ÏÏ‰Ï„ÏŒÏ„Ï…Ï€Î¿
                    </button>
                    <button onclick="sendResponse('${req.id}', 'generic')" class="col-span-1 bg-white dark:bg-slate-700 border border-secondary text-secondary dark:text-teal-400 hover:bg-teal-50 dark:hover:bg-slate-600 py-2.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2">
                        <i class="ph ph-pill text-lg"></i> ÎˆÏ‡Ï‰ Î“ÎµÎ½ÏŒÏƒÎ·Î¼Î¿
                    </button>
                    <button onclick="dismissRequest('${req.id}')" class="col-span-2 sm:col-span-1 bg-slate-100 dark:bg-slate-800 text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 py-2.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2">
                        <i class="ph ph-x text-lg"></i> Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ·
                    </button>
                </div>
            </div>
            `;
        }

        // 5. Actions
        async function sendResponse(requestId, type) {
            const btn = document.querySelector(`#card-${requestId} button`); 
            if(btn) btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Î£Ï„Î­Î»Î½ÎµÎ¹...';

            const { error } = await window.db.from('responses').insert({
                request_id: requestId,
                pharmacist_id: currentUser.id,
                response_type: type,
                message: type === 'original' ? 'Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ Î¬Î¼ÎµÏƒÎ± (Î ÏÏ‰Ï„ÏŒÏ„Ï…Ï€Î¿)' : 'Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ Î³ÎµÎ½ÏŒÏƒÎ·Î¼Î¿',
                price: '0.00' // Placeholder, Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î²Î¬Î»ÎµÎ¹Ï‚ prompt Î³Î¹Î± Ï„Î¹Î¼Î®
            });

            if (!error) {
                showToast('Î— Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· ÏƒÏ„Î¬Î»Î¸Î·ÎºÎµ!', 'success');
                // Î‘Î»Î»Î±Î³Î® status Ï„Î¿Ï… request ÏƒÎµ 'answered' Î® Î±Ï€Î»Î¬ Î±Ï†Î±Î¯ÏÎµÏƒÎ· Î±Ï€ÏŒ Ï„Î· Î»Î¯ÏƒÏ„Î±
                removeCard(requestId);
            } else {
                showToast('Î£Ï†Î¬Î»Î¼Î±: ' + error.message, 'error');
            }
        }

        function dismissRequest(requestId) {
            // Î‘Ï€Î»Î¬ Ï„Î¿ ÎºÏÏÎ²Î¿Ï…Î¼Îµ Ï„Î¿Ï€Î¹ÎºÎ¬ Î® Î¼Ï€Î¿ÏÎ¿ÏÎ¼Îµ Î½Î± Ï„Î¿ Î¼Î±ÏÎºÎ¬ÏÎ¿Ï…Î¼Îµ Ï‰Ï‚ 'ignored' ÏƒÏ„Î· Î²Î¬ÏƒÎ·
            removeCard(requestId);
        }

        function removeCard(id) {
            const card = document.getElementById(`card-${id}`);
            if (card) {
                card.style.opacity = '0';
                card.style.transform = 'translateY(-20px)';
                setTimeout(() => card.remove(), 300);
            }
        }

        // 6. Realtime Subscription
        function subscribeToRequests() {
            window.db.channel('pharmacy-feed')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'requests' }, payload => {
                showToast('ğŸ”” ÎÎ­Î¿ Î±Î¯Ï„Î·Î¼Î± Ï†Î±ÏÎ¼Î¬ÎºÎ¿Ï…!', 'info');
                // Add new card to top
                const container = document.getElementById('requests-container');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = createRequestCard(payload.new);
                container.prepend(tempDiv.firstElementChild);
            })
            .subscribe();
        }

        // UI Utilities
        function showToast(msg, type='info') {
            const c = document.getElementById('toast-container');
            const el = document.createElement('div');
            const bg = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-slate-800');
            el.className = `toast ${bg} text-white px-4 py-3 rounded-xl shadow-lg text-sm font-semibold flex items-center gap-2`;
            el.innerHTML = msg;
            c.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        function toggleTheme() {
            const html = document.documentElement;
            html.classList.toggle('dark');
        }
    </script>
</body>
</html>
