<!DOCTYPE html>
<html lang="el" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MediRadar • Portal Φαρμακείων</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase env + SDK -->
  <script src="/env.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .app-bg{
      background:
        radial-gradient(1100px 600px at 0% -10%, rgba(132,197,244,.30), transparent 60%),
        radial-gradient(900px 540px at 110% 0%, rgba(199,166,244,.22), transparent 58%),
        radial-gradient(1000px 600px at 25% 120%, rgba(247,141,167,.18), transparent 62%),
        radial-gradient(800px 520px at 120% 120%, rgba(157,224,214,.20), transparent 60%),
        linear-gradient(180deg, #f6fbfb 0%, #f8fafc 40%, #fbfcfe 100%);
    }
  </style>
</head>
<body class="min-h-full app-bg text-slate-900 font-sans">
  <header class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
    <a href="/" class="text-sm underline">← Αρχική</a>
    <div class="font-semibold">Portal Φαρμακείων</div>
    <button id="logout" class="text-sm underline">Έξοδος</button>
  </header>

  <main class="max-w-4xl mx-auto px-4 pb-16">
    <!-- Auth card -->
    <section id="auth-card" class="rounded-2xl bg-white/90 border border-slate-200 shadow p-4 max-w-md mx-auto mt-6">
      <h2 class="text-lg font-bold mb-3">Σύνδεση Φαρμακείου</h2>
      <label class="block text-sm mb-2">Email
        <input id="email" type="email" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" placeholder="pharmacy@email.com">
      </label>
      <label class="block text-sm mb-3">Κωδικός
        <input id="pass" type="password" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" placeholder="••••••••">
      </label>
      <button id="login" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700 w-full">Σύνδεση</button>
      <p class="text-xs text-slate-500 mt-2">* Ο λογαριασμός δημιουργείται από το MediRadar (ή ενεργοποιείται μέσω email).</p>
    </section>

    <!-- Dashboard -->
    <section id="dash" class="hidden mt-8">
      <div class="rounded-2xl bg-white/90 border border-slate-200 shadow p-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-bold">Αιτήματα σε εκκρεμότητα</h2>
          <button id="refresh" class="px-3 py-2 rounded-lg border hover:bg-slate-50">Ανανέωση</button>
        </div>
        <div id="list" class="mt-4 grid gap-3"></div>
      </div>
    </section>
  </main>

  <script>
    const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    const authCard = document.getElementById('auth-card');
    const dash = document.getElementById('dash');
    const email = document.getElementById('email');
    const pass = document.getElementById('pass');
    const loginBtn = document.getElementById('login');
    const logoutBtn = document.getElementById('logout');
    const refreshBtn = document.getElementById('refresh');
    const list = document.getElementById('list');

    let pharmacyProfile = null; // { id, name, ... }

    async function getPharmacyProfile(userId){
      // Απλή αντιστοίχιση: pharmacies.user_id = auth.user.id
      const { data, error } = await supabase.from('pharmacies').select('id,name,city').eq('user_id', userId).single();
      if(error) return null;
      return data;
    }

    async function loadPending(){
      list.innerHTML = '<div class="text-sm text-slate-500">Φόρτωση…</div>';
      // Εμφάνιση όλων των pending (ή μόνο για ίδια πόλη αν θέλεις)
      const { data, error } = await supabase
        .from('requests')
        .select('id,med_name,active_substance,med_type,qty,city,allow_generic,created_at,status')
        .eq('status','pending')
        .order('created_at',{ascending:false})
        .limit(50);
      if(error){ list.innerHTML = `<div class="text-sm text-red-600">Σφάλμα: ${error.message}</div>`; return; }
      if(!data || data.length===0){ list.innerHTML = `<div class="text-sm text-slate-500">Καμία εκκρεμότητα.</div>`; return; }

      list.innerHTML = '';
      data.forEach(r=>{
        const card = document.createElement('div');
        card.className = 'rounded-xl border border-slate-200 p-4 bg-white flex items-center justify-between';
        card.innerHTML = `
          <div class="text-sm">
            <div class="font-semibold">${r.med_name}</div>
            <div class="text-xs text-slate-600">${r.active_substance||''} • ${r.med_type||''} • ${r.qty||1} τμχ</div>
            <div class="text-xs text-slate-500 mt-1">Πόλη: ${r.city} • ${r.allow_generic ? '🧬 επιτρέπεται γενόσημο' : 'εμπορικό μόνο'}</div>
          </div>
          <div class="flex gap-2">
            <button class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm btn-available">Διαθέσιμο</button>
          </div>`;
        card.dataset.reqId = r.id;
        list.appendChild(card);
      });
    }

    async function setAvailable(requestId){
      if(!pharmacyProfile){ alert('Δεν βρέθηκε προφίλ φαρμακείου.'); return; }
      // insert response
      const { error } = await supabase.from('responses').insert({
        request_id: requestId,
        pharmacy_id: pharmacyProfile.id,
        generic_only: false
      });
      if(error){ alert('Σφάλμα: ' + error.message); return; }
      // δεν αλλάζουμε status εδώ — το frontend πελάτη μέσω RPC βλέπει το response
      loadPending();
    }

    loginBtn.onclick = async ()=>{
      const { data, error } = await supabase.auth.signInWithPassword({ email: email.value.trim(), password: pass.value });
      if(error){ alert('Login error: ' + error.message); return; }
      pharmacyProfile = await getPharmacyProfile(data.user.id);
      if(!pharmacyProfile){ alert('Δεν βρέθηκε καταχώριση φαρμακείου για αυτόν τον χρήστη.'); }
      authCard.classList.add('hidden'); dash.classList.remove('hidden'); loadPending();
    };

    logoutBtn.onclick = async ()=>{
      await supabase.auth.signOut();
      pharmacyProfile=null;
      dash.classList.add('hidden'); authCard.classList.remove('hidden');
    };

    refreshBtn.onclick = loadPending;

    list.addEventListener('click', (e)=>{
      const btn = e.target.closest('.btn-available'); if(!btn) return;
      const card = btn.closest('div.rounded-xl');
      const reqId = parseInt(card.dataset.reqId,10);
      setAvailable(reqId);
    });

    // auto-session
    (async ()=>{
      const { data: { user } } = await supabase.auth.getUser();
      if(user){
        pharmacyProfile = await getPharmacyProfile(user.id);
        authCard.classList.add('hidden'); dash.classList.remove('hidden');
        loadPending();
      }
    })();
  </script>
</body>
</html>
