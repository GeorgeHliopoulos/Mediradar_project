<!DOCTYPE html>
<html lang="el" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MediRadar • Pharmacy</title>

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#29a3a3" />

  <link rel="stylesheet" href="/styles/tailwind-lite.css">

  <!-- env.js MUST stay first so window.ENV is populated before any other scripts -->
  <script src="/env.js"></script>
  <script>
    if (!window.ENV || !window.ENV.SUPABASE_URL || !window.ENV.SUPABASE_ANON_KEY) {
      const msg = 'Missing Supabase ENV (URL/ANON). Check Netlify env vars & /env.js include.';
      window.__ENV_LOAD_ERROR = true;
      window.__ENV_LOAD_ERROR_MESSAGE = msg;
      const renderEnvError = () => {
        if (!document.body) return;
        document.body.innerHTML = '<div style="padding:16px;color:#b91c1c;background:#fee2e2">Missing Supabase ENV (URL/ANON). Check Netlify env vars & /env.js include.</div>';
      };
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', renderEnvError, { once: true });
      } else {
        renderEnvError();
      }
      throw new Error('ENV not loaded');
    }
  </script>

</head>
<body class="min-h-full bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-200 font-sans">
  <div data-env-error class="hidden" style="display:none;">
    <div class="mx-auto max-w-3xl px-4 py-3 rounded-b-2xl border border-red-200 bg-red-100/90 text-red-900 shadow-lg">
      <div data-env-error-text class="text-sm leading-relaxed font-medium"></div>
    </div>
  </div>

  <div id="diagnostics-modal" class="hidden fixed inset-0 z-[80] bg-black/60 backdrop-blur-sm p-4 items-center justify-center">
    <div class="w-full max-w-3xl max-h-[90vh] overflow-y-auto rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-950 shadow-soft">
      <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200 dark:border-slate-800">
        <h2 class="text-lg font-bold">Diagnostics</h2>
        <div class="flex items-center gap-2">
          <button id="diagnostics-refresh" class="px-3 py-1.5 rounded-xl border border-slate-200 dark:border-slate-700 text-xs font-semibold bg-white/70 dark:bg-slate-900/40 hover:bg-white">Run check</button>
          <button id="diagnostics-close" class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800">✕</button>
        </div>
      </div>
      <div class="px-5 py-4 space-y-4 text-sm">
        <p class="text-slate-600 dark:text-slate-400">Επαλήθευσε ότι τα public Supabase κλειδιά φορτώθηκαν και ότι ένα απλό REST αίτημα δουλεύει πριν συνεχίσεις με το dashboard.</p>
        <div>
          <div class="font-semibold">/env.js</div>
          <div class="mt-2 grid gap-1 text-xs">
            <div>Placement: <span id="diagnostics-envjs-placement">—</span></div>
            <div>Network: <span id="diagnostics-envjs-status">—</span></div>
          </div>
        </div>
        <div>
          <div class="font-semibold">window.ENV</div>
          <pre id="diagnostics-env" class="mt-2 rounded-xl bg-slate-900/90 text-slate-100 text-xs p-3 whitespace-pre-wrap break-all">(pending)</pre>
        </div>
        <div>
          <div class="font-semibold">Status RPC</div>
          <p class="text-xs text-slate-500">POST <span id="diagnostics-rest-url" class="break-all"></span></p>
          <div class="mt-2 grid gap-2 text-xs">
            <label class="block">
              <span class="font-medium">Token (p_token)</span>
              <input id="diagnostics-token" type="text" placeholder="π.χ. abcd1234"
                     class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2" />
            </label>
            <div>Status: <span id="diagnostics-rest-status">—</span></div>
            <div id="diagnostics-token-error" class="hidden text-red-600 dark:text-red-400"></div>
          </div>
          <pre id="diagnostics-rest-body" class="mt-2 rounded-xl bg-slate-100 dark:bg-slate-900/60 p-3 text-xs whitespace-pre-wrap break-all">(pending)</pre>
        </div>
      </div>
    </div>
  </div>
  <div class="max-w-5xl mx-auto p-4">
    <header class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <a href="/" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">← Αρχική</a>
        <h1 class="text-2xl font-extrabold">MediRadar • Φαρμακείο</h1>
      </div>
      <div class="flex items-center gap-2">
        <button data-diagnostics-open class="btn hover:bg-slate-100 dark:hover:bg-slate-800 text-xs">Diagnostics</button>
        <button id="theme-toggle" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">🌙/🌞</button>
      </div>
    </header>

    <!-- PHARMACY PICK/CREATE -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <h2 class="text-lg font-bold mb-2">Επιλογή Φαρμακείου</h2>
        <div class="flex gap-2">
          <select id="pharmacy-select" class="w-full px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800"></select>
          <button id="reload-pharmacies" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">↻</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">Αν δεν υπάρχει, δημιούργησέ το δίπλα.</p>
        <div id="pharmacy-picked" class="mt-3 hidden">
          <div class="text-sm"><span class="font-semibold">Επιλεγμένο:</span> <span id="pharm-name"></span> • <span id="pharm-city"></span></div>
          <div class="text-xs text-slate-500"><span id="pharm-addr"></span> • <span id="pharm-phone"></span></div>
        </div>
      </div>

      <div class="card">
        <h2 class="text-lg font-bold mb-2">Νέο Φαρμακείο</h2>
        <div class="grid grid-cols-1 gap-2">
          <input id="new-name"  class="px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="Όνομα">
          <input id="new-addr"  class="px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="Διεύθυνση">
          <input id="new-phone" class="px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="Τηλέφωνο">
          <select id="new-city" class="px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800">
            <option value="">— Πόλη —</option>
            <option>Αθήνα</option><option>Θεσσαλονίκη</option><option>Πάτρα</option>
            <option>Ηράκλειο</option><option>Λάρισα</option><option>Βόλος</option>
            <option>Χανιά</option><option>Γλυφάδα</option><option>Ρόδος</option>
          </select>
          <button id="create-pharmacy" class="px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold hover:opacity-95">Δημιουργία</button>
        </div>
      </div>
    </section>

    <!-- HOURS JSON -->
    <section id="hours-box" class="card mt-4 hidden">
      <h2 class="text-lg font-bold mb-2">Ωράριο</h2>
      <p class="text-xs text-slate-500 mb-2">Μορφή ανά ημέρα: π.χ. 08:00-17:00 (αφήσε κενό για κλειστό)</p>
      <div class="grid sm:grid-cols-4 md:grid-cols-7 gap-2" id="hours-grid"></div>
      <div class="mt-3 flex justify-end">
        <button id="save-hours" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:opacity-95">Αποθήκευση Ωραρίου</button>
      </div>
    </section>

    <!-- REQUESTS LIST -->
    <section id="req-box" class="card mt-4 hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold">Αιτήματα στην πόλη σου</h2>
        <div class="flex items-center gap-2 text-sm">
          <span>Πόλη:</span><span id="city-pill" class="px-2 py-1 rounded-lg bg-slate-100 dark:bg-slate-800"></span>
          <button id="reload-requests" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">↻</button>
        </div>
      </div>
      <div id="req-list" class="mt-3 grid gap-3"></div>
      <div id="empty-state" class="hidden p-3 rounded-xl border text-sm">Δεν υπάρχουν εκκρεμή αιτήματα αυτή τη στιγμή.</div>
    </section>
  </div>

  <script>
    (function(){
      const triggers = document.querySelectorAll('[data-diagnostics-open]');
      const modal = document.getElementById('diagnostics-modal');
      const closeBtn = document.getElementById('diagnostics-close');
      const refreshBtn = document.getElementById('diagnostics-refresh');
      const envPre = document.getElementById('diagnostics-env');
      const restUrlEl = document.getElementById('diagnostics-rest-url');
      const restStatusEl = document.getElementById('diagnostics-rest-status');
      const restBodyEl = document.getElementById('diagnostics-rest-body');
      const tokenInput = document.getElementById('diagnostics-token');
      const tokenErrorEl = document.getElementById('diagnostics-token-error');
      const envJsPlacementEl = document.getElementById('diagnostics-envjs-placement');
      const envJsStatusEl = document.getElementById('diagnostics-envjs-status');

      if (!modal || !triggers.length) return;

      function closeModal(){
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }

      async function runDiagnostics(){
        const env = window.ENV || {};
        try {
          envPre.textContent = JSON.stringify(env, null, 2);
        } catch (err) {
          envPre.textContent = 'Unable to serialise window.ENV';
        }

        if (envJsPlacementEl) {
          const scriptEl = document.querySelector('head script[src="/env.js"]');
          if (scriptEl) {
            const scripts = Array.from(document.head.querySelectorAll('script'));
            const idx = scripts.indexOf(scriptEl);
            envJsPlacementEl.textContent = idx === 0 ? 'first <script> in <head>' : idx >= 0 ? `index ${idx} in <head>` : 'unknown';
          } else {
            envJsPlacementEl.textContent = 'not found';
          }
        }

        if (envJsStatusEl) {
          envJsStatusEl.textContent = 'Running…';
          try {
            const envResponse = await fetch('/env.js', { cache: 'no-store' });
            const statusText = envResponse.statusText ? ` ${envResponse.statusText}` : '';
            envJsStatusEl.textContent = `${envResponse.status}${statusText}`.trim();
          } catch (error) {
            envJsStatusEl.textContent = `Fetch error: ${error}`;
          }
        }

        const hasKeys = !!(env.SUPABASE_URL && env.SUPABASE_ANON_KEY);
        const baseUrl = (env.SUPABASE_URL || '').replace(/\/$/, '');
        const rpcUrl = hasKeys ? `${baseUrl}/rest/v1/rpc/get_request_status` : '—';
        restUrlEl.textContent = rpcUrl;

        if (!hasKeys) {
          restStatusEl.textContent = 'Missing SUPABASE_URL / SUPABASE_ANON_KEY';
          restBodyEl.textContent = 'Ορίζει τα public Supabase κλειδιά στα Netlify environment variables.';
          tokenErrorEl?.classList.remove('hidden');
          if (tokenErrorEl) tokenErrorEl.textContent = 'Χωρίς public keys δεν μπορεί να γίνει RPC κλήση.';
          return;
        }

        const token = (tokenInput?.value || '').trim();
        if (!token) {
          restStatusEl.textContent = 'Token required';
          restBodyEl.textContent = 'Δώσε status token (p_token) για να εκτελεστεί το RPC.';
          tokenErrorEl?.classList.remove('hidden');
          if (tokenErrorEl) tokenErrorEl.textContent = 'Συμπλήρωσε ένα token πριν τρέξεις τον έλεγχο.';
          return;
        }

        if (tokenErrorEl) tokenErrorEl.classList.add('hidden');
        restStatusEl.textContent = 'Running…';
        restBodyEl.textContent = '…';

        try {
          const response = await fetch(rpcUrl, {
            method: 'POST',
            headers: {
              apikey: env.SUPABASE_ANON_KEY,
              Authorization: `Bearer ${env.SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ p_token: token }),
            cache: 'no-store'
          });
          restStatusEl.textContent = `${response.status} ${response.statusText}`.trim();
          let payload = null;
          try {
            payload = await response.json();
          } catch (parseErr) {
            payload = null;
          }

          if (!response.ok) {
            restBodyEl.textContent = payload ? JSON.stringify(payload, null, 2) : '(no body)';
            tokenErrorEl?.classList.remove('hidden');
            if (tokenErrorEl) tokenErrorEl.textContent = 'Η RPC κλήση απέτυχε – έλεγξε τα headers & τα Netlify env vars.';
            return;
          }

          if (Array.isArray(payload) && payload.length) {
            restBodyEl.textContent = JSON.stringify(payload[0], null, 2);
            if (tokenErrorEl) tokenErrorEl.classList.add('hidden');
          } else {
            restBodyEl.textContent = JSON.stringify(payload, null, 2) || '(empty array)';
            tokenErrorEl?.classList.remove('hidden');
            if (tokenErrorEl) tokenErrorEl.textContent = 'Δεν βρέθηκε αίτηση για το συγκεκριμένο token.';
          }
        } catch (error) {
          restStatusEl.textContent = 'Fetch error';
          restBodyEl.textContent = String(error);
          tokenErrorEl?.classList.remove('hidden');
          if (tokenErrorEl) tokenErrorEl.textContent = 'Αποτυχία επικοινωνίας με το Supabase RPC endpoint.';
        }
      }

      function openModal(){
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        runDiagnostics();
      }

      triggers.forEach((btn)=> btn.addEventListener('click', openModal));
      modal.addEventListener('click', (event)=>{ if (event.target === modal) closeModal(); });
      closeBtn?.addEventListener('click', closeModal);
      refreshBtn?.addEventListener('click', runDiagnostics);
      document.addEventListener('keydown', (event)=>{
        if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
          closeModal();
        }
      });
    })();
  </script>

  <!-- Supabase + App -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    /* ---------- setup ---------- */
    if (window.__ENV_LOAD_ERROR) {
      throw new Error(window.__ENV_LOAD_ERROR_MESSAGE || 'Missing Supabase environment configuration');
    }
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.ENV || {};
    if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
      throw new Error('Missing Supabase environment configuration');
    }
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const qs = (s, r=document)=>r.querySelector(s);
    const qsa = (s, r=document)=>[...r.querySelectorAll(s)];
    const store = {
      pharmacy: null,
      hoursInputs: ['Κυρ','Δευ','Τρι','Τετ','Πεμ','Παρ','Σαβ'].map(d=>({day:d, val:''}))
    };

    /* ---------- theme ---------- */
    const html = document.documentElement;
    const themeBtn = qs('#theme-toggle');
    function setTheme(mode){ const dark = mode==='dark'; html.classList.toggle('dark', dark); localStorage.setItem('mr-pharm-theme', dark?'dark':'light');}
    setTheme(localStorage.getItem('mr-pharm-theme') || (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
    themeBtn.addEventListener('click',()=> setTheme(html.classList.contains('dark')?'light':'dark'));

    /* ---------- ui refs ---------- */
    const selPh = qs('#pharmacy-select');
    const reloadPh = qs('#reload-pharmacies');
    const pickedBox = qs('#pharmacy-picked');
    const pName = qs('#pharm-name');
    const pCity = qs('#pharm-city');
    const pAddr = qs('#pharm-addr');
    const pPhone = qs('#pharm-phone');

    const hoursBox = qs('#hours-box');
    const hoursGrid = qs('#hours-grid');
    const saveHoursBtn = qs('#save-hours');

    const reqBox = qs('#req-box');
    const cityPill = qs('#city-pill');
    const reqList = qs('#req-list');
    const emptyState = qs('#empty-state');
    const reloadReq = qs('#reload-requests');

    /* ---------- pharmacy CRUD ---------- */
    async function loadPharmacies(){
      const { data, error } = await supabase.from('pharmacies').select('id,name,city,address,phone').order('name');
      if(error){ console.warn(error); return; }
      selPh.innerHTML = `<option value="">— Επιλογή —</option>` + (data||[]).map(p=>`<option value="${p.id}" data-city="${p.city||''}" data-addr="${p.address||''}" data-phone="${p.phone||''}">${p.name} — ${p.city||'—'}</option>`).join('');
    }

    async function createPharmacy(){
      const name = qs('#new-name').value.trim();
      const address = qs('#new-addr').value.trim();
      const phone = qs('#new-phone').value.trim();
      const city = qs('#new-city').value;
      if(!name || !city){ alert('Όνομα και Πόλη είναι υποχρεωτικά'); return; }
      const { data, error } = await supabase.from('pharmacies').insert({ name, address, phone, city }).select('id,name,city,address,phone').single();
      if(error){ alert('Σφάλμα δημιουργίας φαρμακείου'); console.warn(error); return; }
      await loadPharmacies();
      selPh.value = data.id;
      applyPickedFromSelect();
      qs('#new-name').value=''; qs('#new-addr').value=''; qs('#new-phone').value=''; qs('#new-city').value='';
    }

    function applyPickedFromSelect(){
      const id = selPh.value;
      if(!id){ pickedBox.classList.add('hidden'); hoursBox.classList.add('hidden'); reqBox.classList.add('hidden'); store.pharmacy=null; return; }
      const opt = selPh.selectedOptions[0];
      store.pharmacy = { id, name: opt.textContent.split(' — ')[0], city: opt.dataset.city, address: opt.dataset.addr, phone: opt.dataset.phone };
      pName.textContent = store.pharmacy.name;
      pCity.textContent = store.pharmacy.city || '—';
      pAddr.textContent = store.pharmacy.address || '—';
      pPhone.textContent = store.pharmacy.phone || '—';
      pickedBox.classList.remove('hidden');
      hoursBox.classList.remove('hidden');
      reqBox.classList.remove('hidden');
      cityPill.textContent = store.pharmacy.city || '—';
      renderHoursInputs();
      loadRequests();
    }

    /* ---------- hours ---------- */
    function renderHoursInputs(){
      const days = ['Κυρ','Δευ','Τρι','Τετ','Πεμ','Παρ','Σαβ'];
      hoursGrid.innerHTML = days.map((d,i)=>`
        <label class="text-sm">
          <div class="font-semibold mb-1">${d}</div>
          <input data-day="${i}" class="w-full px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="π.χ. 08:00-17:00">
        </label>
      `).join('');
      // load existing hours_json
      if(store.pharmacy?.id){
        supabase.from('pharmacies').select('hours_json').eq('id', store.pharmacy.id).single().then(({data})=>{
          const h = data?.hours_json || {};
          qsa('input[data-day]').forEach(inp=>{
            const di = Number(inp.dataset.day); inp.value = h[di]?.range || '';
          });
        });
      }
    }
    async function saveHours(){
      const obj = {};
      qsa('input[data-day]').forEach(inp=>{
        const di = Number(inp.dataset.day); const range = inp.value.trim();
        if(range) obj[di] = { range };
      });
      await supabase.from('pharmacies').update({ hours_json: obj }).eq('id', store.pharmacy.id);
      alert('Αποθηκεύτηκε το ωράριο.');
    }

    /* ---------- requests feed ---------- */
    async function loadRequests(){
      reqList.innerHTML = '';
      emptyState.classList.add('hidden');
      if(!store.pharmacy?.city) return;

      const { data, error } = await supabase
        .from('requests')
        .select('id, created_at, med_name, active_substance, med_type, quantity, allow_generic, city, status')
        .eq('city', store.pharmacy.city)
        .in('status', ['pending','has_responses'])
        .order('created_at', { ascending:false })
        .limit(50);

      if(error){ console.warn(error); return; }
      if(!data || !data.length){ emptyState.classList.remove('hidden'); return; }

      data.forEach(row=>{
        const card = document.createElement('div');
        card.className = 'rounded-xl border p-3 bg-white/80 dark:bg-slate-900/60';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-semibold">${row.med_name}</div>
            <div class="text-xs text-slate-500">${new Date(row.created_at).toLocaleString()}</div>
          </div>
          <div class="text-xs text-slate-600 dark:text-slate-400">
            ${row.active_substance ? `Ουσία: ${row.active_substance} • ` : ''}Τύπος: ${row.med_type||'—'} • Ποσ: ${row.quantity}
          </div>
          <div class="mt-2 flex items-center gap-3">
            <label class="inline-flex items-center gap-2 text-sm">
              <input type="checkbox" class="gen-chk size-4 accent-brand-600"> Γενόσημο
            </label>
            <button class="avail btn bg-emerald-600 text-white border-emerald-700 hover:opacity-95">Διαθέσιμο</button>
            <button class="unavail btn hover:bg-slate-100 dark:hover:bg-slate-800">Μη διαθέσιμο</button>
          </div>
        `;
        card.dataset.id = row.id;
        reqList.appendChild(card);
      });
    }

    async function sendResponse(reqId, available, isGeneric){
      if(!store.pharmacy?.id){ alert('Διάλεξε φαρμακείο πρώτα.'); return; }
      const payload = { request_id: reqId, pharmacy_id: store.pharmacy.id, available: !!available, is_generic: !!isGeneric };
      const { error } = await supabase.from('responses').insert(payload);
      if(error){ alert('Σφάλμα καταχώρησης απάντησης'); console.warn(error); return; }
      // Προαιρετικά, ενημέρωσε το request σε has_responses
      await supabase.from('requests').update({ status:'has_responses' }).eq('id', reqId).neq('status','reserved');
    }

    /* ---------- events ---------- */
    qs('#create-pharmacy').addEventListener('click', createPharmacy);
    selPh.addEventListener('change', applyPickedFromSelect);
    reloadPh.addEventListener('click', loadPharmacies);
    saveHoursBtn.addEventListener('click', saveHours);
    reloadReq.addEventListener('click', loadRequests);

    reqList.addEventListener('click', async (e)=>{
      const card = e.target.closest('[data-id]'); if(!card) return;
      const reqId = card.dataset.id;
      if(e.target.closest('.avail')){
        const isGen = card.querySelector('.gen-chk')?.checked || false;
        await sendResponse(reqId, true, isGen);
        card.classList.add('opacity-60');
      }
      if(e.target.closest('.unavail')){
        await sendResponse(reqId, false, false);
        card.classList.add('opacity-60');
      }
    });

    /* ---------- realtime (optional) ---------- */
    try{
      supabase
        .channel('requests-feed')
        .on('postgres_changes', { event: 'INSERT', schema:'public', table:'requests', filter:`city=eq.${encodeURIComponent(store.pharmacy?.city||'')}` }, (payload)=>{
          loadRequests();
        })
        .subscribe();
    }catch{}

    /* ---------- init ---------- */
    await loadPharmacies();
  </script>
</body>
</html>
