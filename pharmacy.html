<!DOCTYPE html>
<html lang="el" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediRadar Pro - Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    
    <script>
        const SB_URL = "https://qzerrisyowkfkmcyxmav.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZXJyaXN5b3drZmttY3l4bWF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTcxODQsImV4cCI6MjA3NTU5MzE4NH0.alkvHkOQPBTwY3daUcKAEsf4nt0kizuU3rYI2c2InPk";
        
        tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, colors: { primary: '#0f172a', secondary: '#0d9488' }, animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' } } } }
    </script>
    <style>
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); } 
        .toast { animation: slideIn 0.3s ease-out forwards; } 
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        /* Tab Transitions */
        .tab-content { display: none; animation: fadeIn 0.2s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-slate-200 p-4 sticky top-0 z-30">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3"><div class="w-10 h-10 bg-secondary rounded-xl flex items-center justify-center text-white shadow-lg"><i class="ph ph-first-aid-kit text-2xl"></i></div><div><h1 class="font-bold text-lg leading-tight">MediRadar <span class="text-secondary">Pro</span></h1><p class="text-xs text-slate-500">ÎšÎ­Î½Ï„ÏÎ¿ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚</p></div></div>
            <div class="flex gap-2 items-center">
                <div id="auth-section"></div>
            </div>
        </div>
    </nav>

    <!-- Authentication Overlay (Login / Register) -->
    <div id="login-overlay" class="fixed inset-0 z-50 bg-slate-900/95 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            
            <!-- Header with Tabs -->
            <div class="bg-slate-50 p-2 flex border-b border-slate-200">
                <button onclick="switchAuthTab('login')" id="tab-btn-login" class="flex-1 py-3 rounded-xl text-sm font-bold text-secondary bg-white shadow-sm transition-all">Î£ÏÎ½Î´ÎµÏƒÎ·</button>
                <button onclick="switchAuthTab('register')" id="tab-btn-register" class="flex-1 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-100 transition-all">Î•Î³Î³ÏÎ±Ï†Î® Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…</button>
            </div>

            <div class="p-8 overflow-y-auto">
                
                <!-- LOGIN TAB -->
                <div id="auth-login" class="tab-content active">
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 bg-secondary/10 rounded-full flex items-center justify-center mx-auto mb-4 text-secondary"><i class="ph ph-lock-key text-4xl"></i></div>
                        <h2 class="text-2xl font-bold text-slate-800">ÎšÎ±Î»ÏÏ‚ Î®ÏÎ¸Î±Ï„Îµ</h2>
                        <p class="text-sm text-slate-500">Î£Ï…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ ÏƒÎ±Ï‚.</p>
                    </div>
                    
                    <form onsubmit="handleProLogin(event)" class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase ml-1">Email</label>
                            <input type="email" id="login-email" placeholder="pharmacy@example.com" required class="w-full bg-slate-50 border border-slate-300 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-secondary">
                        </div>
                        <button type="submit" class="w-full bg-secondary hover:bg-teal-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2">
                            <i class="ph ph-magic-wand"></i> Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Magic Link
                        </button>
                    </form>
                    
                    <div class="mt-6 text-center">
                        <button onclick="demoLogin()" class="text-xs text-slate-400 hover:text-secondary underline">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚ Î¼Îµ Demo Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ</button>
                    </div>
                </div>

                <!-- REGISTER TAB -->
                <div id="auth-register" class="tab-content">
                    <div class="text-center mb-6">
                        <h2 class="text-xl font-bold text-slate-800">Î‘Î¯Ï„Î·ÏƒÎ· Î•Î³Î³ÏÎ±Ï†Î®Ï‚</h2>
                        <p class="text-xs text-slate-500">Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Î³Î¹Î± Î­Î»ÎµÎ³Ï‡Î¿.</p>
                    </div>

                    <form onsubmit="handleRegistration(event)" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-[10px] font-bold text-slate-500 uppercase">Î•Ï€Ï‰Î½Ï…Î¼Î¹Î±</label><input id="reg-name" type="text" required class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2.5 text-sm outline-none focus:border-secondary"></div>
                            <div><label class="text-[10px] font-bold text-slate-500 uppercase">Î‘Î¦Îœ</label><input id="reg-afm" type="text" required class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2.5 text-sm outline-none focus:border-secondary"></div>
                        </div>
                        
                        <div><label class="text-[10px] font-bold text-slate-500 uppercase">Î‘ÏÎ¹Î¸Î¼Î¿Ï‚ Î‘Î´ÎµÎ¹Î±Ï‚</label><input id="reg-license" type="text" required class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2.5 text-sm outline-none focus:border-secondary"></div>
                        
                        <div><label class="text-[10px] font-bold text-slate-500 uppercase">Î”Î¹ÎµÏ…Î¸Ï…Î½ÏƒÎ· Î¦Î±ÏÎ¼Î±ÎºÎµÎ¹Î¿Ï…</label><input id="reg-address" type="text" required class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2.5 text-sm outline-none focus:border-secondary"></div>

                        <div class="border-t border-dashed border-slate-200 my-2"></div>

                        <div><label class="text-[10px] font-bold text-slate-500 uppercase">ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€Ï‰Î½Ï…Î¼Î¿ Î¥Ï€ÎµÏ…Î¸Ï…Î½Î¿Ï…</label><input id="reg-contact" type="text" required class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2.5 text-sm outline-none focus:border-secondary"></div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-[10px] font-bold text-slate-500 uppercase">Email</label><input id="reg-email" type="email" required class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2.5 text-sm outline-none focus:border-secondary"></div>
                            <div><label class="text-[10px] font-bold text-slate-500 uppercase">Î¤Î·Î»ÎµÏ†Ï‰Î½Î¿</label><input id="reg-phone" type="tel" required class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2.5 text-sm outline-none focus:border-secondary"></div>
                        </div>

                        <button type="submit" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg mt-2">
                            Î¥Ï€Î¿Î²Î¿Î»Î® Î‘Î¯Ï„Î·ÏƒÎ·Ï‚
                        </button>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto p-4 w-full grid grid-cols-1 lg:grid-cols-4 gap-6 flex-grow">
        <!-- Sidebar -->
        <div class="lg:col-span-1 space-y-6">
            <div class="glass-panel p-5 rounded-2xl shadow-sm"><h3 class="font-bold text-xs uppercase text-slate-500 mb-4">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</h3><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" checked class="sr-only peer"><div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-300 rounded-full peer peer-checked:bg-secondary"></div><span class="ml-3 text-sm font-medium">Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ Î¤ÏÏÎ±</span></label></div>
        </div>
        
        <!-- Requests Feed -->
        <div class="lg:col-span-3">
            <div class="flex justify-between items-end mb-4"><h2 class="text-xl font-bold flex items-center gap-2"><i class="ph ph-bell-ringing text-secondary animate-pulse-slow"></i> Î•Î¹ÏƒÎµÏÏ‡ÏŒÎ¼ÎµÎ½Î± Î‘Î¹Ï„Î®Î¼Î±Ï„Î±</h2><button onclick="fetchRequests()" class="text-sm text-secondary font-semibold hover:underline"><i class="ph ph-arrows-clockwise"></i> Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</button></div>
            <div id="loading-spinner" class="hidden text-center py-10"><i class="ph ph-spinner animate-spin text-3xl text-secondary"></i><p class="text-sm text-slate-500 mt-2">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</p></div>
            <div id="requests-container" class="space-y-4"></div>
        </div>
    </main>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-2"></div>

    <script>
        let currentUser = null;
        let timers = {}; 

        window.db = window.supabase.createClient(SB_URL, SB_KEY);

        window.onload = async function() {
            const { data: { session } } = await window.db.auth.getSession();
            if (session) { handleLoginSuccess(session.user); } else { document.getElementById('login-overlay').classList.remove('hidden'); }
        };

        // --- UI LOGIC ---
        function switchAuthTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`auth-${tab}`).classList.add('active');
            
            const btnLogin = document.getElementById('tab-btn-login');
            const btnRegister = document.getElementById('tab-btn-register');
            
            if(tab === 'login') {
                btnLogin.className = "flex-1 py-3 rounded-xl text-sm font-bold text-secondary bg-white shadow-sm transition-all";
                btnRegister.className = "flex-1 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-100 transition-all";
            } else {
                btnRegister.className = "flex-1 py-3 rounded-xl text-sm font-bold text-secondary bg-white shadow-sm transition-all";
                btnLogin.className = "flex-1 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-100 transition-all";
            }
        }

        // --- AUTH LOGIC ---
        async function handleProLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const btn = e.target.querySelector('button');
            const oldText = btn.innerHTML;
            
            btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i>'; btn.disabled = true;

            const { error } = await window.db.auth.signInWithOtp({ email: email, options: { emailRedirectTo: window.location.href } });

            if (error) {
                showToast("Î£Ï†Î¬Î»Î¼Î±: " + error.message, 'error');
                btn.innerHTML = oldText; btn.disabled = false;
            } else {
                showToast("âœ… Î¤Î¿ Magic Link ÏƒÏ„Î¬Î»Î¸Î·ÎºÎµ ÏƒÏ„Î¿ email ÏƒÎ±Ï‚!", 'success');
                btn.innerHTML = '<i class="ph ph-check"></i> Î•ÏƒÏ„Î¬Î»Î·';
            }
        }

        async function handleRegistration(e) {
            e.preventDefault();
            
            const formData = {
                pharmacy_name: document.getElementById('reg-name').value,
                afm: document.getElementById('reg-afm').value,
                license_number: document.getElementById('reg-license').value,
                address: document.getElementById('reg-address').value,
                contact_person: document.getElementById('reg-contact').value,
                email: document.getElementById('reg-email').value,
                phone: document.getElementById('reg-phone').value,
                status: 'pending' // Î‘ÏÏ‡Î¹ÎºÎ® ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·
            };

            const btn = e.target.querySelector('button');
            const oldText = btn.innerHTML;
            btn.innerHTML = 'Î¥Ï€Î¿Î²Î¿Î»Î®...'; btn.disabled = true;

            // Insert into pharmacy_registrations table
            const { error } = await window.db.from('pharmacy_registrations').insert([formData]);

            if (error) {
                showToast("Î£Ï†Î¬Î»Î¼Î±: " + error.message, 'error');
                btn.innerHTML = oldText; btn.disabled = false;
            } else {
                showToast("âœ… Î— Î±Î¯Ï„Î·ÏƒÎ· ÎµÏƒÏ„Î¬Î»Î·! Î˜Î± ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î®ÏƒÎ¿Ï…Î¼Îµ Î¼Î±Î¶Î¯ ÏƒÎ±Ï‚.", 'success');
                // Reset form & show message
                document.getElementById('auth-register').innerHTML = `
                    <div class="text-center py-10 animate-[fadeIn_0.5s]">
                        <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl"><i class="ph ph-check"></i></div>
                        <h3 class="text-xl font-bold text-slate-800">Î•Ï…Ï‡Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ¼Îµ!</h3>
                        <p class="text-sm text-slate-500 mt-2">Î— Î±Î¯Ï„Î·ÏƒÎ® ÏƒÎ±Ï‚ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎµ.<br>Î˜Î± ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ email: <strong>${formData.email}</strong></p>
                        <button onclick="window.location.reload()" class="mt-6 text-sm text-secondary font-bold underline">Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î®</button>
                    </div>
                `;
            }
        }

        function handleLoginSuccess(user) {
            currentUser = user;
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('auth-section').innerHTML = `<span class="text-xs font-medium mr-2 hidden sm:inline">${user.email}</span><button onclick="handleLogout()" class="text-xs bg-slate-200 px-3 py-1 rounded-lg hover:bg-red-500 hover:text-white transition-colors">ÎˆÎ¾Î¿Î´Î¿Ï‚</button>`;
            fetchRequests();
            subscribeToEverything();
            
            // Fallback auto-refresh interval (every 30s)
            setInterval(fetchRequests, 30000);
        }

        async function demoLogin() {
            const { data, error } = await window.db.auth.signInAnonymously();
            if (error) { showToast('Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚', 'error'); } 
            else { handleLoginSuccess(data.user); }
        }
        async function handleLogout() { await window.db.auth.signOut(); window.location.reload(); }

        // --- FETCH REQUESTS (FIXED: Filtering rejected) ---
        async function fetchRequests() {
            const container = document.getElementById('requests-container');
            
            // Î¦Î­ÏÎµ Ï„Î± Î±Î¹Ï„Î®Î¼Î±Ï„Î± Ï€Î¿Ï… Î”Î•Î ÎµÎ¯Î½Î±Î¹ rejected Î® completed
            const { data, error } = await window.db.from('requests').select('*')
                .neq('status', 'rejected') 
                .neq('status', 'completed') 
                .or(`status.eq.pending,and(status.eq.reserved,winner_pharmacy_id.eq.${currentUser.id})`)
                .order('created_at', { ascending: false });

            const { data: myResponses } = await window.db.from('responses').select('request_id').eq('pharmacist_id', currentUser.id);
            const myRespondedIds = new Set((myResponses || []).map(r => r.request_id));

            if(error) return; 
            
            container.innerHTML = '';
            if(data && data.length > 0) { 
                data.forEach(req => container.innerHTML += createRequestCard(req, myRespondedIds.has(req.id))); 
                data.forEach(req => {
                    if(req.status === 'reserved' && req.winner_pharmacy_id === currentUser.id) {
                        const timeBase = req.updated_at || req.created_at;
                        startCountdown(req.id, timeBase);
                    }
                });
            } else { 
                container.innerHTML = `<div class="text-center py-16 bg-white/50 rounded-3xl border-2 border-dashed border-slate-300"><p class="text-slate-500">ÎšÎ±Î½Î­Î½Î± ÎµÎ½ÎµÏÎ³ÏŒ Î±Î¯Ï„Î·Î¼Î±.</p></div>`; 
            }
        }

        function createRequestCard(req, hasResponded) {
            const timeAgo = new Date(req.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            let stateUI = '';
            let borderClass = 'border-l-secondary';
            
            // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î´Î­Ï‡ÎµÏ„Î±Î¹ Î³ÎµÎ½ÏŒÏƒÎ·Î¼Î¿ (Î±Î½ ÎµÎ¯Î½Î±Î¹ null Î¸ÎµÏ‰ÏÎ¿ÏÎ¼Îµ Î½Î±Î¹)
            const allowGeneric = req.accepts_generic !== false; 

            if (req.status === 'reserved' && req.winner_pharmacy_id === currentUser.id) {
                borderClass = 'border-l-green-500 ring-1 ring-green-500/20';
                const verifyCode = req.id.substring(0, 6); 
                stateUI = `
                    <div class="mt-4 bg-green-50 border border-green-200 p-4 rounded-xl animate-[fadeIn_0.5s]">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-bold text-green-800 flex items-center gap-2"><i class="ph ph-check-circle text-xl"></i> ÎŸ Î ÎµÎ»Î¬Ï„Î·Ï‚ ÎˆÏÏ‡ÎµÏ„Î±Î¹!</h4>
                                <p class="text-xs text-green-700 mt-1">Î‘Ï€Î¿Î¼Î­Î½Î¿Ï…Î½: <span id="timer-${req.id}" class="font-mono font-bold text-lg">Loading...</span></p>
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] uppercase text-slate-400 font-bold">ÎšÏ‰Î´Î¹ÎºÎ¿Ï‚</span>
                                <div class="text-2xl font-mono font-bold text-slate-800 tracking-widest">${verifyCode}</div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-3 rounded-xl border border-green-100 flex gap-2">
                            <input type="text" id="verify-input-${req.id}" placeholder="Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® ÎšÏ‰Î´Î¹ÎºÎ¿Ï" class="flex-1 bg-transparent outline-none text-center font-bold tracking-widest uppercase">
                            <button onclick="verifyOrder('${req.id}', '${verifyCode}')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-md">Î•Ï€Î±Î»Î®Î¸ÎµÏ…ÏƒÎ·</button>
                        </div>
                    </div>
                `;
            } 
            else if (hasResponded) {
                borderClass = 'border-l-yellow-400';
                stateUI = `
                    <div class="mt-4 bg-yellow-50 border border-yellow-200 p-3 rounded-xl flex items-center justify-between">
                        <div class="flex items-center gap-2 text-yellow-700 font-bold text-sm">
                            <i class="ph ph-hourglass-medium animate-spin"></i> Î‘Î½Î±Î¼Î¿Î½Î® Ï€ÎµÎ»Î¬Ï„Î·...
                        </div>
                        <span class="text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded">Î‘Ï€Î±Î½Ï„Î®ÏƒÎ±Ï„Îµ</span>
                    </div>
                `;
            } 
            else {
                // ÎšÎ¿Ï…Î¼Ï€Î¯ Î“ÎµÎ½ÏŒÏƒÎ·Î¼Î¿Ï…: Î•Î½ÎµÏÎ³ÏŒ Î® Î‘Î½ÎµÎ½ÎµÏÎ³ÏŒ Î±Î½Î¬Î»Î¿Î³Î± Î¼Îµ Ï„Î·Î½ ÎµÏ€Î¹Î»Î¿Î³Î® Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·
                const genericBtn = allowGeneric 
                    ? `<button onclick="sendResponse('${req.id}', 'generic')" class="col-span-1 bg-white border border-secondary text-secondary hover:bg-teal-50 py-3 rounded-xl font-bold text-sm transition-transform active:scale-95">ğŸ’Š Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ (Î“ÎµÎ½ÏŒÏƒÎ·Î¼Î¿)</button>`
                    : `<button disabled class="col-span-1 bg-slate-100 border border-slate-200 text-slate-400 py-3 rounded-xl font-bold text-xs cursor-not-allowed" title="ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î´ÎµÎ½ Î´Î­Ï‡ÎµÏ„Î±Î¹ Î³ÎµÎ½ÏŒÏƒÎ·Î¼Î¿">ğŸš« Î“ÎµÎ½ÏŒÏƒÎ·Î¼Î¿ (ÎŒÏ‡Î¹)</button>`;

                stateUI = `
                    <div class="grid grid-cols-2 gap-3 mt-4">
                        <button onclick="sendResponse('${req.id}', 'original')" class="col-span-1 bg-secondary hover:bg-teal-700 text-white py-3 rounded-xl font-bold text-sm shadow-md transition-transform active:scale-95">âœ… Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ (Î ÏÏ‰Ï„ÏŒÏ„Ï…Ï€Î¿)</button>
                        ${genericBtn}
                        <button onclick="dismissRequest('${req.id}')" class="col-span-2 text-xs text-slate-400 hover:text-slate-600 py-2">Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ·</button>
                    </div>
                `;
            }

            return `
                <div id="card-${req.id}" class="glass-panel p-5 rounded-2xl shadow-sm hover:shadow-md transition-all border-l-4 ${borderClass} relative mb-4">
                    <div class="flex justify-between items-start mb-2">
                        <span class="bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1"><i class="ph ph-clock"></i> ${timeAgo}</span>
                        <span class="text-xs font-bold text-slate-500 flex items-center gap-1"><i class="ph ph-map-pin"></i> ${req.location || 'Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±'}</span>
                    </div>
                    <h3 class="text-xl font-bold text-slate-900 mb-1">${req.medicine_name} <span class="text-lg font-normal text-slate-500">x${req.quantity}</span></h3>
                    <p class="text-sm text-slate-500 mb-2">${req.customer_name || 'Î ÎµÎ»Î¬Ï„Î·Ï‚'}</p>
                    ${req.notes ? `<div class="bg-slate-50 p-2 rounded text-xs italic border border-slate-100">"${req.notes}"</div>` : ''}
                    ${!allowGeneric ? '<span class="text-[10px] font-bold text-red-500 bg-red-50 px-2 py-1 rounded inline-block mb-2">âš ï¸ ÎœÏŒÎ½Î¿ Î ÏÏ‰Ï„ÏŒÏ„Ï…Ï€Î¿</span>' : ''}
                    ${stateUI}
                </div>
            `;
        }

        // --- ACTIONS ---
        async function sendResponse(requestId, type) {
            const { error } = await window.db.from('responses').insert({ 
                request_id: requestId, 
                pharmacist_id: currentUser.id, 
                response_type: type, 
                message: type === 'original' ? 'Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ (Î ÏÏ‰Ï„ÏŒÏ„Ï…Ï€Î¿)' : 'Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ (Î“ÎµÎ½ÏŒÏƒÎ·Î¼Î¿)',
                price: '0.00' 
            });

            if (!error) { 
                showToast('Î— Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· ÏƒÏ„Î¬Î»Î¸Î·ÎºÎµ!', 'success'); 
                fetchRequests();
            } else { 
                showToast('Î£Ï†Î¬Î»Î¼Î±: ' + error.message, 'error');
            }
        }

        function verifyOrder(requestId, correctCode) {
            const input = document.getElementById(`verify-input-${requestId}`);
            if (input.value.trim() === correctCode) {
                completeOrder(requestId);
            } else {
                showToast('Î›Î¬Î¸Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚!', 'error');
                input.classList.add('ring-2', 'ring-red-500');
                setTimeout(() => input.classList.remove('ring-2', 'ring-red-500'), 1000);
            }
        }

        async function completeOrder(requestId) {
            const { error } = await window.db.from('requests').update({ status: 'completed' }).eq('id', requestId);
            if(!error) {
                document.getElementById(`card-${requestId}`).remove();
                showToast('Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ!', 'success');
                try { new Audio('https://cdn.freesound.org/previews/171/171671_2437358-lq.mp3').play().catch(e=>{}); } catch(e){}
            }
        }

        // FIX: Actual DB update for rejection
        async function dismissRequest(id) {
            document.getElementById(`card-${id}`).remove();
            await window.db.from('requests').update({ status: 'rejected' }).eq('id', id);
        }

        function startCountdown(reqId, startTimeStr) {
            if(timers[reqId]) clearInterval(timers[reqId]);
            const safeStartTime = new Date(startTimeStr).getTime();
            const duration = 60 * 60 * 1000; const endTime = safeStartTime + duration;
            function update() {
                const distance = endTime - new Date().getTime();
                const el = document.getElementById(`timer-${reqId}`);
                if (!el) { clearInterval(timers[reqId]); return; }
                if (distance < 0) { clearInterval(timers[reqId]); el.innerHTML = "Î•Î›Î—ÎÎ•"; el.classList.add('text-red-600'); return; }
                const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((distance % (1000 * 60)) / 1000);
                el.innerHTML = `${m}:${s < 10 ? '0' : ''}${s}`;
            }
            update(); timers[reqId] = setInterval(update, 1000);
        }

        // --- REALTIME (NUCLEAR OPTION) ---
        function subscribeToEverything() {
            window.db.channel('pharmacy-global').on('postgres_changes', { event: '*', schema: 'public', table: 'requests' }, payload => {
                if(payload.eventType === 'INSERT') {
                    showToast('ğŸ”” ÎÎ­Î¿ Î±Î¯Ï„Î·Î¼Î±!', 'info');
                    try { new Audio('https://cdn.freesound.org/previews/201/201159_866625-lq.mp3').play().catch(e=>{}); } catch(e){}
                    fetchRequests();
                }
                if(payload.eventType === 'UPDATE' && payload.new.status === 'reserved' && payload.new.winner_pharmacy_id === currentUser.id) {
                    showToast('âœ… ÎŸ Ï€ÎµÎ»Î¬Ï„Î·Ï‚ Î­ÎºÎ±Î½Îµ ÎºÏÎ¬Ï„Î·ÏƒÎ·!', 'success');
                    fetchRequests(); // Î‘Ï…Ï„ÏŒ Î¸Î± ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ ÎºÎ±Î¹ Ï„Î¿Î½ timer
                }
            }).subscribe();
        }

        function showToast(msg, type='info') { const c = document.getElementById('toast-container'); const el = document.createElement('div'); const bg = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-slate-800'); el.className = `toast ${bg} text-white px-4 py-3 rounded-xl shadow-lg text-sm font-semibold`; el.innerHTML = msg; c.appendChild(el); setTimeout(() => el.remove(), 3000); }
    </script>
</body>
</html>
