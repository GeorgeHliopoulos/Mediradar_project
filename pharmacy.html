<!DOCTYPE html>
<html lang="el" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediRadar Pro - Portal Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    
    <script>
        const SB_URL = "https://qzerrisyowkfkmcyxmav.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZXJyaXN5b3drZmttY3l4bWF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTcxODQsImV4cCI6MjA3NTU5MzE4NH0.alkvHkOQPBTwY3daUcKAEsf4-aI1tQvKxmhR-S330i4";
        const db = supabase.createClient(SB_URL, SB_KEY);
        window.db = db;

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { pro: '#0f172a', accent: '#3b82f6' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f1f5f9; }
        .glass-panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .req-card { transition: all 0.2s; border-left: 4px solid transparent; }
        .req-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .req-card.new { border-left-color: #3b82f6; background-color: #eff6ff; }
        .btn-accept { background: #3b82f6; color: white; transition: 0.2s; }
        .btn-accept:hover { background: #2563eb; }
        
        /* Loading overlay */
        #global-loader { position: fixed; inset: 0; background: white; z-index: 100; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body class="text-slate-800">

    <div id="global-loader">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>

    <section id="auth-section" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-100">
            <div class="text-center mb-8">
                <div class="bg-blue-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600">
                    <i class="ph-fill ph-prescription text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-900">MediRadar Pro</h1>
                <p class="text-slate-500 text-sm">Î Î»Î±Ï„Ï†ÏŒÏÎ¼Î± Î¦Î±ÏÎ¼Î±ÎºÎ¿Ï€Î¿Î¹ÏÎ½</p>
            </div>

            <form onsubmit="handleProLoginFromUserApp(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…</label>
                    <input type="email" id="pro-email" class="w-full p-3 rounded-xl border border-slate-200 focus:border-blue-500 focus:outline-none transition-colors" placeholder="pharmacy@example.com" required>
                </div>
                <button type="submit" id="btn-login" class="w-full bg-slate-900 text-white p-3 rounded-xl font-semibold hover:bg-slate-800 transition-colors">
                    Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Magic Link
                </button>
            </form>

            <div class="mt-6 pt-6 border-t border-slate-100">
                 <button onclick="handleGoogleLoginPro()" class="w-full flex items-center justify-center gap-2 bg-white border border-slate-200 p-3 rounded-xl text-slate-700 font-medium hover:bg-slate-50 transition-colors">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5">
                    Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Google
                </button>
            </div>
        </div>
    </section>

    <section id="pending-section" class="min-h-screen flex flex-col items-center justify-center p-4 hidden">
        <i class="ph-duotone ph-hourglass-high text-6xl text-orange-500 mb-4"></i>
        <h1 class="text-2xl font-bold text-slate-900">Î‘Î½Î±Î¼Î¿Î½Î® ÎˆÎ³ÎºÏÎ¹ÏƒÎ·Ï‚</h1>
        <p class="text-slate-600 max-w-md text-center mt-2">
            ÎŸ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ ÏƒÎ±Ï‚ Î­Ï‡ÎµÎ¹ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸ÎµÎ¯ ÎºÎ±Î¹ ÎµÎ¾ÎµÏ„Î¬Î¶ÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï„Î·Î½ Î¿Î¼Î¬Î´Î± Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚. 
            Î˜Î± Î»Î¬Î²ÎµÏ„Îµ ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î¼ÏŒÎ»Î¹Ï‚ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯.
        </p>
        <button onclick="logout()" class="mt-8 text-sm text-slate-500 hover:text-red-500 underline">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</button>
    </section>

    <section id="dashboard-section" class="min-h-screen flex flex-col hidden">
        <nav class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg shadow-blue-200">
                    <i class="ph-fill ph-radar text-xl"></i>
                </div>
                <div>
                    <h2 class="font-bold text-slate-800 text-lg leading-tight">Live Requests</h2>
                    <p id="pharmacy-name-display" class="text-xs text-slate-500 font-medium">Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿ ...</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button id="btn-sound" onclick="enableSound()" class="hidden bg-orange-100 text-orange-700 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 animate-pulse">
                    <i class="ph-fill ph-speaker-high"></i> Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î‰Ï‡Î¿Ï…
                </button>

                <div class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-full">
                    <span class="relative flex h-2.5 w-2.5">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span>
                    </span>
                    <span class="text-xs font-semibold text-slate-600">Online</span>
                </div>
                <button onclick="logout()" class="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-red-500 transition-colors">
                    <i class="ph ph-sign-out text-xl"></i>
                </button>
            </div>
        </nav>

        <main class="flex-1 p-6 max-w-5xl mx-auto w-full">
            <div id="requests-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="col-span-full text-center py-20 text-slate-400">
                    <i class="ph ph-coffee text-4xl mb-4 inline-block opacity-50"></i>
                    <p>Î‘Î½Î±Î¼Î¿Î½Î® Î³Î¹Î± Î½Î­Î± Î±Î¹Ï„Î®Î¼Î±Ï„Î± ÏƒÏ„Î·Î½ Ï€ÎµÏÎ¹Î¿Ï‡Î® ÏƒÎ±Ï‚...</p>
                </div>
            </div>
        </main>
    </section>

    <div id="image-modal" class="fixed inset-0 z-[60] bg-black/90 hidden items-center justify-center p-4 cursor-pointer" onclick="this.classList.add('hidden')">
        <img id="image-modal-src" class="max-w-full max-h-[90vh] rounded-xl shadow-2xl">
    </div>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-2"></div>

    <script>
        // --- GLOBAL STATE ---
        let currentPharmacyId = null;
        let audioContextAllowed = false;

        // --- INIT ---
        window.addEventListener('load', async () => {
            // Check Session on Load
            const { data: { session } } = await window.db.auth.getSession();
            
            if (session) {
                currentPharmacyId = session.user.id;
                await checkApprovalStatus();
            } else {
                showAuth();
            }
            
            document.getElementById('global-loader').classList.add('hidden');
        });

        // --- AUTH LOGIC ---
        function showAuth() {
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('pending-section').classList.add('hidden');
        }

        async function checkApprovalStatus() {
            // Fetch pharmacy details
            const { data: pharmacy, error } = await window.db
                .from('pharmacies')
                .select('*')
                .eq('id', currentPharmacyId)
                .single();

            if (error || !pharmacy) {
                // First time login or data missing -> Maybe redirect to a setup profile page?
                // For now, assume if logged in but no record, create one or show pending
                console.log("Pharmacy profile not found. Creating default...");
                // Note: You should have a logic to create profile. Assuming it exists for now.
                showAuth(); 
                return;
            }

            if (pharmacy.status === 'approved') {
                // Access Granted
                document.getElementById('pharmacy-name-display').innerText = pharmacy.name;
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('pending-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.remove('hidden');
                
                // Show Sound Button
                document.getElementById('btn-sound').classList.remove('hidden');

                // Start Logic
                fetchRequests();
                subscribeToEverything();
            } else {
                // Pending Access
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.add('hidden');
                document.getElementById('pending-section').classList.remove('hidden');
            }
        }

        async function handleProLoginFromUserApp(e) {
            e.preventDefault();
            const email = document.getElementById('pro-email').value;
            const btn = document.getElementById('btn-login');
            const oldText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®...';

            // Redirect back to pharmacy.html, not index
            const redirectUrl = window.location.origin + '/pharmacy.html';

            const { error } = await window.db.auth.signInWithOtp({
                email: email,
                options: {
                    emailRedirectTo: redirectUrl
                }
            });

            if (error) {
                showToast("Î£Ï†Î¬Î»Î¼Î±: " + error.message, 'error');
                btn.innerHTML = oldText;
                btn.disabled = false;
            } else {
                showToast("âœ… Link ÎµÏƒÏ„Î¬Î»Î·! Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î¿ email ÏƒÎ±Ï‚.", 'success');
                btn.innerHTML = '<i class="ph ph-check"></i> Î•ÏƒÏ„Î¬Î»Î·!';
            }
        }

        async function handleGoogleLoginPro() {
            const redirectUrl = window.location.origin + '/pharmacy.html';
            const { error } = await window.db.auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: redirectUrl }
            });
            if (error) showToast(error.message, 'error');
        }

        async function logout() {
            await window.db.auth.signOut();
            window.location.reload();
        }

        // --- DASHBOARD LOGIC ---

        function enableSound() {
            // User interaction to unlock audio
            const audio = new Audio('https://cdn.freesound.org/previews/201/201159_866625-lq.mp3');
            audio.play().then(() => {
                audioContextAllowed = true;
                document.getElementById('btn-sound').classList.add('hidden');
                showToast("ğŸ”Š Î‰Ï‡Î¿Ï‚ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎµ!", "success");
            }).catch(e => console.error(e));
        }

        function playNotificationSound() {
            if (audioContextAllowed) {
                new Audio('https://cdn.freesound.org/previews/201/201159_866625-lq.mp3').play().catch(e=>{});
            }
        }

        async function fetchRequests() {
            // Only fetch pending requests
            const { data: requests, error } = await window.db
                .from('requests')
                .select('*')
                .eq('status', 'pending')
                .order('created_at', { ascending: false });

            if (requests) renderRequests(requests);
        }

        function renderRequests(requests) {
            const container = document.getElementById('requests-grid');
            
            if (requests.length === 0) {
                container.innerHTML = `
                <div class="col-span-full text-center py-20 text-slate-400">
                    <i class="ph ph-coffee text-4xl mb-4 inline-block opacity-50"></i>
                    <p>Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎºÎºÏÎµÎ¼Î® Î±Î¹Ï„Î®Î¼Î±Ï„Î±.</p>
                </div>`;
                return;
            }

            container.innerHTML = requests.map(req => `
                <div class="req-card bg-white p-5 rounded-xl shadow-sm border border-slate-100 new flex flex-col justify-between h-full">
                    <div>
                        <div class="flex justify-between items-start mb-3">
                            <span class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded uppercase tracking-wide">ÎÎµÎ¿ Î‘Î¹Ï„Î·Î¼Î±</span>
                            <span class="text-xs text-slate-400">${new Date(req.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        
                        <h3 class="text-lg font-bold text-slate-900 mb-1">${req.medicine_name || 'Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î± Î£Ï…Î½Ï„Î±Î³Î®Ï‚'}</h3>
                        
                        ${req.image_url ? 
                            `<div onclick="showImageModal('${req.image_url}')" class="cursor-pointer mb-3 relative group">
                                <img src="${req.image_url}" class="w-full h-32 object-cover rounded-lg border border-slate-200">
                                <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center rounded-lg text-white">
                                    <i class="ph-bold ph-magnifying-glass-plus text-2xl"></i>
                                </div>
                             </div>` 
                        : ''}
                        
                        <div class="flex items-center gap-2 text-sm text-slate-500 mb-4">
                            <i class="ph-fill ph-map-pin text-slate-400"></i>
                            <span>Î‘Ï€ÏŒÏƒÏ„Î±ÏƒÎ·: <span class="font-semibold text-slate-700">~1.2km</span></span>
                        </div>
                    </div>

                    <button onclick="acceptRequest('${req.id}')" class="btn-accept w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-500/30">
                        <i class="ph-bold ph-check"></i>
                        ÎˆÏ‡Ï‰ Ï„Î¿ Ï†Î¬ÏÎ¼Î±ÎºÎ¿
                    </button>
                </div>
            `).join('');
        }

        async function acceptRequest(reqId) {
            if (!confirm('Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î­Ï‡ÎµÏ„Îµ Ï„Î¿ Ï†Î¬ÏÎ¼Î±ÎºÎ¿ ÎºÎ±Î¹ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï„Î¿ Î´ÎµÏƒÎ¼ÎµÏÏƒÎµÏ„Îµ Î³Î¹Î± 15 Î»ÎµÏ€Ï„Î¬;')) return;

            // Get Pharmacy Details (Address/Phone) to send to customer
            const { data: pharmacy } = await window.db.from('pharmacies').select('*').eq('id', currentPharmacyId).single();

            // Atomic Update
            const { data, error } = await window.db
                .from('requests')
                .update({ 
                    status: 'reserved',
                    winner_pharmacy: pharmacy.name,
                    pharmacy_id: currentPharmacyId,
                    pharmacy_address: pharmacy.address,
                    pharmacy_phone: pharmacy.phone,
                    pharmacy_lat: pharmacy.lat,
                    pharmacy_lng: pharmacy.lng,
                    updated_at: new Date()
                })
                .eq('id', reqId)
                .select();

            if (error) {
                showToast('ÎšÎ¬Ï€Î¿Î¹Î¿Ï‚ Î¬Î»Î»Î¿Ï‚ Ï€ÏÏŒÎ»Î±Î²Îµ Ï„Î¿ Î±Î¯Ï„Î·Î¼Î±.', 'error');
                fetchRequests();
            } else {
                showToast('ğŸ‰ Î¤Î¿ Î±Î¯Ï„Î·Î¼Î± Î±Î½Î±Ï„Î­Î¸Î·ÎºÎµ ÏƒÎµ ÎµÏƒÎ¬Ï‚!', 'success');
                fetchRequests();
                // Optional: Show "Won" tab
            }
        }

        function subscribeToEverything() {
            window.db.channel('pharmacy-global')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'requests' }, payload => {
                    if (payload.eventType === 'INSERT') {
                        showToast('ğŸ”” ÎÎ­Î¿ Î±Î¯Ï„Î·Î¼Î±!', 'info');
                        playNotificationSound();
                        fetchRequests();
                    }
                    if (payload.eventType === 'UPDATE') {
                        // Refresh list to remove taken requests
                        fetchRequests();
                    }
                })
                .subscribe();
        }

        // --- UTILS ---
        function showImageModal(src) { 
            document.getElementById('image-modal-src').src = src; 
            document.getElementById('image-modal').classList.remove('hidden'); 
            document.getElementById('image-modal').classList.add('flex');
        }

        function showToast(msg, type='info') {
            const c = document.getElementById('toast-container');
            const el = document.createElement('div');
            const bg = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-slate-800');
            el.className = `toast ${bg} text-white px-4 py-3 rounded-xl shadow-lg text-sm font-semibold flex items-center gap-2 animate-bounce-in`;
            el.innerHTML = msg;
            c.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

    </script>
</body>
</html>
