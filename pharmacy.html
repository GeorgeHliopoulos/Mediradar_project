<!DOCTYPE html>
<html lang="el" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MediRadar â€¢ Pharmacy</title>
  <meta name="application-name" content="MediRadar" />
  <meta name="apple-mobile-web-app-title" content="MediRadar" />
  <meta name="description" content="Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Î­ÏƒÏ‰ Google Î³Î¹Î± Ï„Î·Î½ Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼Î± MediRadar" />
  <meta property="og:site_name" content="MediRadar" />
  <meta property="og:description" content="Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Î­ÏƒÏ‰ Google Î³Î¹Î± Ï„Î·Î½ Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼Î± MediRadar" />
  <meta property="twitter:description" content="Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Î­ÏƒÏ‰ Google Î³Î¹Î± Ï„Î·Î½ Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼Î± MediRadar" />
  <link rel="icon" href="/icons/icon-192.png" />

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#29a3a3" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: { brand: { 500:'#29a3a3', 600:'#208181', 700:'#196464' } },
          boxShadow: { soft:'0 16px 40px rgba(2,6,23,.12)' }
        }
      }
    }
  </script>

  <style>
    body { position: relative; overflow-x: hidden; }
    .glass-surface {
      background: rgba(255, 255, 255, 0.22);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.35);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
      border-radius: 1rem;
    }
    .dark .glass-surface {
      background: rgba(15, 23, 42, 0.6);
      border-color: rgba(148, 163, 184, 0.3);
      box-shadow: 0 22px 48px rgba(2, 6, 23, 0.55);
    }
    /* ğŸ’Š Î•Î½Î¹ÏƒÏ‡Ï…Î¼Î­Î½Î· ÎºÎ¯Î½Î·ÏƒÎ· emoji Î³Î¹Î± Ï€Î¹Î¿ Î¶Ï‰Î·ÏÏŒ demo Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½ */
    .global-emoji-layer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .global-emoji-layer span {
      position: absolute;
      font-size: clamp(3rem, 7vw, 4.5rem);
      opacity: 0.3;
      animation-iteration-count: infinite;
      animation-timing-function: linear;
      filter: drop-shadow(0 18px 32px rgba(8, 47, 73, 0.28));
    }
    .global-emoji-layer span:nth-child(1) { top: 8%; left: 12%; animation: pharmEmojiFloatA 22s linear infinite; }
    .global-emoji-layer span:nth-child(2) { top: 20%; right: 14%; animation: pharmEmojiFloatB 24s linear infinite; }
    .global-emoji-layer span:nth-child(3) { top: 40%; left: 40%; animation: pharmEmojiFloatC 26s linear infinite; opacity: 0.26; }
    .global-emoji-layer span:nth-child(4) { bottom: 18%; left: 18%; animation: pharmEmojiFloatD 23s linear infinite; }
    .global-emoji-layer span:nth-child(5) { bottom: 10%; right: 14%; animation: pharmEmojiFloatE 25s linear infinite; }
    .global-emoji-layer span:nth-child(6) { top: 62%; left: 10%; animation: pharmEmojiFloatF 21s linear infinite; }
    .global-emoji-layer span:nth-child(7) { top: 14%; right: 32%; animation: pharmEmojiFloatG 22s linear infinite; }
    .global-emoji-layer span:nth-child(8) { bottom: 30%; right: 30%; animation: pharmEmojiFloatH 24s linear infinite; }
    .dark .global-emoji-layer span { opacity: 0.34; }
    @keyframes pharmEmojiFloatA {
      0% { transform: translate3d(0, 0, 0) scale(0.94); opacity: 0.12; }
      45% { transform: translate3d(28px, -20px, 0) scale(1.1); opacity: 0.34; }
      100% { transform: translate3d(0, 0, 0) scale(0.94); opacity: 0.12; }
    }
    @keyframes pharmEmojiFloatB {
      0% { transform: translate3d(0, 0, 0) scale(1); opacity: 0.1; }
      50% { transform: translate3d(-30px, 22px, 0) scale(1.12); opacity: 0.36; }
      100% { transform: translate3d(0, 0, 0) scale(1); opacity: 0.1; }
    }
    @keyframes pharmEmojiFloatC {
      0% { transform: translate3d(0, 0, 0) scale(0.92); opacity: 0.12; }
      55% { transform: translate3d(32px, 20px, 0) scale(1.14); opacity: 0.3; }
      100% { transform: translate3d(0, 0, 0) scale(0.92); opacity: 0.12; }
    }
    @keyframes pharmEmojiFloatD {
      0% { transform: translate3d(0, 0, 0) scale(1.02); opacity: 0.12; }
      45% { transform: translate3d(28px, -20px, 0) scale(1.08); opacity: 0.3; }
      100% { transform: translate3d(0, 0, 0) scale(1.02); opacity: 0.12; }
    }
    @keyframes pharmEmojiFloatE {
      0% { transform: translate3d(0, 0, 0) scale(0.96); opacity: 0.12; }
      50% { transform: translate3d(-28px, -18px, 0) scale(1.08); opacity: 0.3; }
      100% { transform: translate3d(0, 0, 0) scale(0.96); opacity: 0.12; }
    }
    @keyframes pharmEmojiFloatF {
      0% { transform: translate3d(0, 0, 0) scale(0.9); opacity: 0.1; }
      58% { transform: translate3d(30px, -16px, 0) scale(1.08); opacity: 0.3; }
      100% { transform: translate3d(0, 0, 0) scale(0.9); opacity: 0.1; }
    }
    @keyframes pharmEmojiFloatG {
      0% { transform: translate3d(0, 0, 0) scale(1.04); opacity: 0.1; }
      50% { transform: translate3d(-22px, 28px, 0) scale(1.12); opacity: 0.34; }
      100% { transform: translate3d(0, 0, 0) scale(1.04); opacity: 0.1; }
    }
    @keyframes pharmEmojiFloatH {
      0% { transform: translate3d(0, 0, 0) scale(0.98); opacity: 0.1; }
      56% { transform: translate3d(24px, -28px, 0) scale(1.1); opacity: 0.32; }
      100% { transform: translate3d(0, 0, 0) scale(0.98); opacity: 0.1; }
    }
    .pro-info-panel {
      padding: 1.5rem;
      border-radius: 1.25rem;
      transition: opacity .35s ease, transform .35s ease;
      opacity: 0;
      transform: translateY(-8px);
    }
    .pro-info-panel.is-visible {
      opacity: 1;
      transform: translateY(0);
    }
    .pro-info-panel h3 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 0.65rem;
    }
    .pro-info-panel p {
      margin-bottom: 0.65rem;
      line-height: 1.55;
    }
    .pro-info-panel ul {
      list-style: none;
      padding-left: 0;
      margin: 0 0 0.75rem;
      display: grid;
      gap: 0.4rem;
    }
    .pro-info-panel li {
      display: flex;
      gap: 0.6rem;
      font-weight: 600;
      align-items: flex-start;
    }
    .pro-info-panel li span:first-child {
      font-size: 1.15rem;
      line-height: 1.1;
    }
    .pro-info-panel em { font-style: italic; }
    .dark .pro-info-panel h3 { color: #7edbd9; }
    .dark .pro-info-panel li { color: #e0f2f1; }
    .dark .pro-info-panel em { color: #cbd5f5; }
    .card {
      border-radius: 1rem;
      background: rgba(255, 255, 255, 0.22);
      border: 1px solid rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(12px);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
      padding: 1.25rem;
    }
    .dark .card {
      background: rgba(15, 23, 42, 0.6);
      border-color: rgba(148, 163, 184, 0.3);
      box-shadow: 0 22px 48px rgba(2, 6, 23, 0.55);
    }
    .btn  {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 0.9rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(51, 65, 85, 0.25);
      font-weight: 600;
      background: rgba(255, 255, 255, 0.32);
      backdrop-filter: blur(10px);
      transition: all .2s ease;
    }
    .btn:hover { background: rgba(255, 255, 255, 0.45); }
    .dark .btn {
      background: rgba(15, 23, 42, 0.45);
      border-color: rgba(148, 163, 184, 0.4);
      color: #e2e8f0;
    }
    /* Î•Î¹Î´Î¹ÎºÏŒ spinner Î³Î¹Î± Ï„Î·Î½ Î­Î½Î´ÎµÎ¹Î¾Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ ÏƒÏ„Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ */
    .btn-loading-indicator {
      width: 1rem;
      height: 1rem;
      border-radius: 9999px;
      border: 2px solid currentColor;
      border-right-color: transparent;
      animation: authSpinner 0.75s linear infinite;
    }
    @keyframes authSpinner {
      to { transform: rotate(360deg); }
    }
    /* Toast ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ‰Î½ Î³Î¹Î± ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î± Î® ÏƒÏ†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ */
    #toast-stack {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      z-index: 250;
      pointer-events: none;
    }
    #toast-stack .toast {
      pointer-events: auto;
      min-width: 240px;
      border-radius: 1rem;
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: white;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.22);
      backdrop-filter: blur(12px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #toast-stack .toast--success { background: rgba(16, 185, 129, 0.94); }
    #toast-stack .toast--error { background: rgba(248, 113, 113, 0.94); }
    #toast-stack .toast--info { background: rgba(59, 130, 246, 0.94); }
    #toast-stack .toast.toast--hide {
      opacity: 0;
      transform: translateY(-8px);
    }
    .dark .btn:hover { background: rgba(30, 41, 59, 0.6); }
    .auth-portal-card { animation: authPortalIn .45s ease forwards; opacity:0; transform: translateY(16px) scale(.96); }
    .auth-portal-card::before {
      content:'';
      position:absolute;
      inset:0;
      border-radius:inherit;
      padding:1px;
      background:linear-gradient(135deg,#00c6ff,#0072ff);
      pointer-events:none;
      opacity:.9;
      transition:opacity .3s ease;
      -webkit-mask:
        linear-gradient(#fff 0 0) content-box,
        linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask:
        linear-gradient(#fff 0 0) content-box,
        linear-gradient(#fff 0 0);
      mask-composite: exclude;
    }
    .auth-portal-card:hover::before {
      opacity:1;
    }
    @keyframes authPortalIn { to { opacity:1; transform: translateY(0) scale(1); } }
    /* ğŸŒŸ Î Î¹Î¿ Ï€Ï…ÎºÎ½Î¬ emoji ÎºÎ±Î¹ Ï„Î±Ï‡ÏÏ„ÎµÏÎ· ÎºÎ¯Î½Î·ÏƒÎ· ÏƒÏ„Î¿ modal ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ */
    .auth-emoji-layer { position:absolute; inset:0; pointer-events:none; overflow:hidden; }
    .auth-emoji-layer span {
      position:absolute;
      font-size:3rem;
      opacity:.28;
      animation-iteration-count:infinite;
      animation-timing-function:linear;
      filter: drop-shadow(0 12px 24px rgba(14, 116, 144, 0.32));
    }
    .auth-emoji-layer span:nth-child(1) { top:12%; left:18%; animation-name:emojiDriftA; animation-duration:14s; }
    .auth-emoji-layer span:nth-child(2) { top:8%; right:12%; animation-name:emojiDriftB; animation-duration:16s; }
    .auth-emoji-layer span:nth-child(3) { bottom:16%; left:24%; animation-name:emojiDriftC; animation-duration:15s; }
    .auth-emoji-layer span:nth-child(4) { bottom:10%; right:18%; animation-name:emojiDriftD; animation-duration:17s; }
    .auth-emoji-layer span:nth-child(5) { top:44%; left:46%; animation-name:emojiDriftE; animation-duration:18s; opacity:.24; }
    .auth-emoji-layer span:nth-child(6) { top:30%; right:32%; animation-name:emojiDriftF; animation-duration:15s; }
    @keyframes emojiDriftA { 0% { transform:translate3d(0,0,0) scale(.95); opacity:.12; } 45% { transform:translate3d(18px,-14px,0) scale(1.12); opacity:.34; } 100% { transform:translate3d(0,0,0) scale(.95); opacity:.12; } }
    @keyframes emojiDriftB { 0% { transform:translate3d(0,0,0) scale(1); opacity:.1; } 50% { transform:translate3d(-18px,16px,0) scale(1.12); opacity:.34; } 100% { transform:translate3d(0,0,0) scale(1); opacity:.1; } }
    @keyframes emojiDriftC { 0% { transform:translate3d(0,0,0) scale(.96); opacity:.12; } 55% { transform:translate3d(20px,-10px,0) scale(1.1); opacity:.3; } 100% { transform:translate3d(0,0,0) scale(.96); opacity:.12; } }
    @keyframes emojiDriftD { 0% { transform:translate3d(0,0,0) scale(1.02); opacity:.12; } 50% { transform:translate3d(-16px,-16px,0) scale(.96); opacity:.28; } 100% { transform:translate3d(0,0,0) scale(1.02); opacity:.12; } }
    @keyframes emojiDriftE { 0% { transform:translate3d(0,0,0) scale(.94); opacity:.1; } 52% { transform:translate3d(18px,18px,0) scale(1.08); opacity:.28; } 100% { transform:translate3d(0,0,0) scale(.94); opacity:.1; } }
    @keyframes emojiDriftF { 0% { transform:translate3d(0,0,0) scale(1.04); opacity:.1; } 48% { transform:translate3d(-14px,14px,0) scale(1.1); opacity:.3; } 100% { transform:translate3d(0,0,0) scale(1.04); opacity:.1; } }
    .auth-card--pulse-success { animation: authSuccessGlow 1.2s ease-out; }
    .auth-card--login-success { animation: authLoginSuccess 2s ease-out; }
    .auth-card--shake-error { animation: authErrorShake .55s ease; }
    @keyframes authSuccessGlow { 0% { box-shadow:0 0 0 0 rgba(16,185,129,0); border-color:rgba(16,185,129,0); } 50% { box-shadow:0 0 0 12px rgba(16,185,129,.12), 0 30px 60px rgba(15,23,42,.22); border-color:rgba(16,185,129,.35); } 100% { box-shadow:0 30px 60px rgba(15,23,42,.18); border-color:rgba(255,255,255,.4); } }
    @keyframes authLoginSuccess { 0% { box-shadow:0 0 0 0 rgba(34,197,94,0); border-color:rgba(34,197,94,0); transform:translateY(0) scale(1); } 25% { box-shadow:0 0 0 14px rgba(34,197,94,.14), 0 32px 70px rgba(15,23,42,.22); border-color:rgba(34,197,94,.4); transform:translateY(-4px) scale(1.01); } 70% { box-shadow:0 0 0 10px rgba(34,197,94,.08), 0 26px 60px rgba(15,23,42,.2); border-color:rgba(34,197,94,.22); } 100% { box-shadow:0 30px 60px rgba(15,23,42,.18); border-color:rgba(255,255,255,.4); transform:translateY(0) scale(1); } }
    @keyframes authErrorShake { 0%, 100% { transform:translateX(0); box-shadow:0 30px 60px rgba(15,23,42,.18); border-color:rgba(255,255,255,.4); } 20% { transform:translateX(-8px); box-shadow:0 0 0 10px rgba(248,113,113,.15), 0 30px 60px rgba(15,23,42,.2); border-color:rgba(248,113,113,.45); } 40% { transform:translateX(8px); } 60% { transform:translateX(-5px); } 80% { transform:translateX(5px); } }
    .auth-success-active { animation: authSuccessSequence 2s ease forwards; }
    @keyframes authSuccessSequence { 0% { opacity:0; transform:translateY(12px) scale(.95); } 20% { opacity:1; transform:translateY(0) scale(1); } 70% { opacity:1; transform:translateY(0) scale(1.02); } 100% { opacity:0; transform:translateY(-6px) scale(1.02); } }
  </style>
</head>
<body class="min-h-full bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-200 font-sans">
  <div class="global-emoji-layer" aria-hidden="true">
    <span>ğŸ’Š</span>
    <span>ğŸ’‰</span>
    <span>ğŸ©º</span>
    <span>ğŸ©¹</span>
    <span>ğŸ§´</span>
    <span>ğŸ’š</span>
    <span>âš•ï¸</span>
    <span>ğŸ’ </span>
  </div>

  <section id="pharmacy-access-gate" class="px-4 py-6 max-w-3xl mx-auto">
    <div class="glass-surface bg-white/85 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-800 px-6 py-6 rounded-2xl shadow-soft flex flex-col gap-4">
      <div>
        <h1 class="text-2xl font-bold">Î ÏÏŒÏƒÎ²Î±ÏƒÎ· MediRadar Pro</h1>
        <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">Î— Ï€ÎµÏÎ¹Î¿Ï‡Î® Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï… ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ ÏƒÎµ ÏƒÏ…Î½ÎµÏÎ³Î¬Ï„ÎµÏ‚ Î¼Îµ ÎµÎ¹Î´Î¹ÎºÎ® Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·. Î£Ï…Î½Î´Î­ÏƒÎ¿Ï… Î¼Îµ Ï„Î± Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± Ï€Î¿Ï… ÏƒÎ¿Ï… Î­Ï‡Î¿Ï…Î¼Îµ Î±Ï€Î¿Î´ÏÏƒÎµÎ¹ Î³Î¹Î± Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÎ¹Ï‚.</p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <button id="pharmacy-access-login" type="button" class="btn bg-brand-600 text-white hover:bg-brand-700 shadow">Î£ÏÎ½Î´ÎµÏƒÎ· Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…</button>
        <a href="/" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">â† Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î®</a>
      </div>
      <p id="pharmacy-access-message" class="hidden text-sm text-slate-600 dark:text-slate-300"></p>
    </div>
  </section>

  <!-- âœ¨ ÎÎ­Î¿Ï‚ Ï€Î¯Î½Î±ÎºÎ±Ï‚ ÎµÎ»Î­Î³Ï‡Î¿Ï… Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï… Î¼Îµ DEMO Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± -->
  <main id="pharmacy-dashboard" class="hidden px-4 py-6 sm:py-8 max-w-6xl mx-auto">
    <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
      <div>
        <h2 class="text-2xl font-bold">Î Î¯Î½Î±ÎºÎ±Ï‚ Î•Î»Î­Î³Ï‡Î¿Ï… Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…</h2>
        <p id="dashboard-subtitle" class="text-sm text-slate-500 dark:text-slate-400">Î£Ï…Î½Î´Î­ÏƒÎ¿Ï… Î³Î¹Î± Î½Î± Î´ÎµÎ¹Ï‚ Ï„Î± Î±Î¹Ï„Î®Î¼Î±Ï„Î± Ï€ÎµÎ»Î±Ï„ÏÎ½.</p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <span id="demo-dashboard-pill" class="hidden px-3 py-1 text-xs font-semibold rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-200">DEMO Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™Î‘</span>
        <div class="px-3 py-1 rounded-full bg-slate-100 dark:bg-slate-800 text-xs font-semibold" id="dashboard-user-pill">â€”</div>
      </div>
    </div>

    <section class="grid gap-6 lg:grid-cols-[minmax(0,3fr)_minmax(0,2fr)]">
      <div class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/60 p-5 shadow-soft">
        <div class="flex items-center justify-between gap-2">
          <div>
            <h3 class="text-lg font-semibold">Î‘Î¹Ï„Î®Î¼Î±Ï„Î± Î ÎµÎ»Î±Ï„ÏÎ½</h3>
            <p class="text-xs text-slate-500 dark:text-slate-400">Î•Î¼Ï†Î±Î½Î¯Î¶Î¿Î½Ï„Î±Î¹ Î¼ÏŒÎ½Î¿ Î±Î¹Ï„Î®Î¼Î±Ï„Î± Î¼Îµ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· pending Î® has_responses.</p>
          </div>
          <button id="dashboard-reload" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">â†»</button>
        </div>
        <div class="mt-4 space-y-4" id="dashboard-requests"></div>
        <div id="dashboard-empty" class="hidden mt-4 rounded-xl border border-slate-200 dark:border-slate-800 bg-white/60 dark:bg-slate-900/60 px-4 py-6 text-sm text-center text-slate-500 dark:text-slate-400">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î¹Ï„Î®Î¼Î±Ï„Î± Ï€Î¿Ï… Î½Î± Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·.</div>
      </div>

      <div class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/60 p-5 shadow-soft">
        <div class="flex items-center justify-between gap-2">
          <div>
            <h3 class="text-lg font-semibold">ÎÏÎµÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚</h3>
            <p class="text-xs text-slate-500 dark:text-slate-400">Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ Î¶ÏÎ½ÎµÏ‚ ÏÏÎ±Ï‚ Î³Î¹Î± ÎºÎ¬Î¸Îµ Î·Î¼Î­ÏÎ± ÎºÎ±Î¹ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎµ.</p>
          </div>
          <button id="opening-hours-add-week" class="btn hover:bg-slate-100 dark:hover:bg-slate-800 text-xs">+ ÎŒÎ»ÎµÏ‚ 09:00-17:00</button>
        </div>
        <div id="opening-hours-status" class="mt-3 text-xs text-slate-500 dark:text-slate-400"></div>
        <div id="opening-hours-days" class="mt-4 space-y-3"></div>
        <div class="mt-5 flex flex-wrap items-center gap-2">
          <button id="save-opening-hours" class="px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold hover:bg-brand-700">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï‰ÏÎ±ÏÎ¯Î¿Ï…</button>
          <button id="reset-opening-hours" class="px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-sm font-semibold">Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬</button>
        </div>
      </div>
    </section>
  </main>
  <!-- Î£Ï„Î¿Î¯Î²Î± toast ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ‰Î½ Î³Î¹Î± Ï„Î·Î½ ÎµÎ¼Ï€ÎµÎ¹ÏÎ¯Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ -->
  <div id="toast-stack" aria-live="polite" aria-atomic="true"></div>
  <div id="public-shell" class="hidden max-w-5xl mx-auto p-4">
    <header class="flex flex-wrap items-center justify-between gap-3 mb-4 glass-surface bg-white/80 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-800 px-4 py-3 shadow-soft">
      <div class="flex items-center gap-3">
        <a href="/" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">â† Î‘ÏÏ‡Î¹ÎºÎ®</a>
        <h1 class="text-2xl font-extrabold">MediRadar â€¢ Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿</h1>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2" data-auth-header>
          <button id="signin-btn" type="button" data-auth-open data-auth-target="pharmacies" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">Î£ÏÎ½Î´ÎµÏƒÎ·</button>
          <!-- ğŸ§ª ÎšÎ¿Ï…Î¼Ï€Î¯ Î³Î¹Î± Î¬Î¼ÎµÏƒÎ· ÏƒÏÎ½Î´ÎµÏƒÎ· DEMO Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï… -->
          <button id="demo-login-btn" type="button" class="btn bg-emerald-600/90 text-white hover:bg-emerald-600 shadow" title="Î£ÏÎ½Î´ÎµÏƒÎ· ÎµÏ€Î¯Î´ÎµÎ¹Î¾Î·Ï‚">Î£ÏÎ½Î´ÎµÏƒÎ· DEMO Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…</button>
          <div data-auth-header-session class="hidden items-center gap-2">
            <div data-auth-header-avatar class="w-8 h-8 rounded-full bg-brand-600 text-white text-xs font-semibold grid place-items-center">Îœ</div>
            <span data-auth-header-email class="text-sm font-semibold"></span>
          </div>
        </div>
        <div id="auth-session" class="text-xs text-slate-500 dark:text-slate-400"></div>
        <button id="signout-btn" data-auth-header-logout class="btn hidden hover:bg-slate-100 dark:hover:bg-slate-800">ÎˆÎ¾Î¿Î´Î¿Ï‚</button>
        <button id="theme-toggle" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">ğŸŒ™/ğŸŒ</button>
      </div>
    </header>
    <!-- â„¹ï¸ ÎœÎ¹ÎºÏÎ® ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î³Î¹Î± Ï„Î¿ Ï€ÏÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Î· DEMO ÎµÎ¯ÏƒÎ¿Î´Î¿Ï‚ -->
    <div class="mb-5 rounded-2xl border border-emerald-300/50 bg-emerald-100/70 dark:bg-emerald-900/40 dark:border-emerald-700/60 p-4 text-sm text-emerald-900 dark:text-emerald-100 shadow-soft">
      <p class="font-semibold">ÎŸÎ´Î·Î³Î¯ÎµÏ‚ DEMO:</p>
      <p class="mt-1">Î Î¬Ï„Î·ÏƒÎµ Â«Î£ÏÎ½Î´ÎµÏƒÎ· DEMO Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…Â» Î³Î¹Î± Î½Î± Î¼Ï€ÎµÎ¹Ï‚ Î¬Î¼ÎµÏƒÎ± Î¼Îµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± <code class="font-mono">demo@pharmacy.gr</code> / <code class="font-mono">Demo123!</code>.</p>
      <p class="mt-1">Î˜Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ Ï„Î¿ Ï„Î±Î¼Ï€Î»ÏŒ Ï„Î¿Ï… demo Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï… Î¼Îµ Î±Î¹Ï„Î®Î¼Î±Ï„Î± Ï€ÎµÎ»Î±Ï„ÏÎ½ ÎºÎ±Î¹ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÎµÎ¹Ï‚ Î´Î¿ÎºÎ¹Î¼Î±ÏƒÏ„Î¹ÎºÏŒ Ï‰ÏÎ¬ÏÎ¹Î¿.</p>
      <p class="mt-1">Î— ÎµÎ¯ÏƒÎ¿Î´Î¿Ï‚ DEMO Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± Î­Î½Î± Î´Î¿ÎºÎ¹Î¼Î±ÏƒÏ„Î¹ÎºÏŒ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿ ÎºÎ±Î¹ Î¼ÎµÏÎ¹ÎºÎ¬ Î±Î¹Ï„Î®Î¼Î±Ï„Î± ÎµÏ€Î¯Î´ÎµÎ¹Î¾Î·Ï‚ Î³Î¹Î± Î½Î± ÎµÎ¾ÎµÏÎµÏ…Î½Î®ÏƒÎµÎ¹Ï‚ Ï„Î¹Ï‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚.</p>
    </div>

    <!-- PHARMACY PICK/CREATE -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <h2 class="text-lg font-bold mb-2">Î•Ï€Î¹Î»Î¿Î³Î® Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…</h2>
        <div class="flex gap-2">
          <select id="pharmacy-select" class="w-full px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800"></select>
          <button id="reload-pharmacies" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">â†»</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹, Î´Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎ­ Ï„Î¿ Î´Î¯Ï€Î»Î±.</p>
        <div id="pharmacy-picked" class="mt-3 hidden">
          <div class="text-sm"><span class="font-semibold">Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿:</span> <span id="pharm-name"></span> â€¢ <span id="pharm-city"></span></div>
          <div class="text-xs text-slate-500"><span id="pharm-addr"></span> â€¢ <span id="pharm-phone"></span></div>
        </div>
      </div>

      <div class="card">
        <h2 class="text-lg font-bold mb-2">ÎÎ­Î¿ Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿</h2>
        <div class="grid grid-cols-1 gap-2">
          <input id="new-name"  class="px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="ÎŒÎ½Î¿Î¼Î±">
          <input id="new-addr"  class="px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·">
          <input id="new-phone" class="px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="Î¤Î·Î»Î­Ï†Ï‰Î½Î¿">
          <select id="new-city" class="px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800">
            <option value="">â€” Î ÏŒÎ»Î· â€”</option>
            <option>Î‘Î¸Î®Î½Î±</option><option>Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·</option><option>Î Î¬Ï„ÏÎ±</option>
            <option>Î—ÏÎ¬ÎºÎ»ÎµÎ¹Î¿</option><option>Î›Î¬ÏÎ¹ÏƒÎ±</option><option>Î’ÏŒÎ»Î¿Ï‚</option>
            <option>Î§Î±Î½Î¹Î¬</option><option>Î“Î»Ï…Ï†Î¬Î´Î±</option><option>Î¡ÏŒÎ´Î¿Ï‚</option>
          </select>
          <button id="create-pharmacy" class="px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold hover:opacity-95">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±</button>
        </div>
      </div>
    </section>

    <!-- HOURS JSON -->
    <section id="hours-box" class="card mt-4 hidden">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h2 class="text-lg font-bold">Î ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚</h2>
          <p class="text-xs text-slate-500 dark:text-slate-400">Î•Ï€Î¯Î»ÎµÎ¾Îµ Î·Î¼Î­ÏÎµÏ‚ ÎºÎ±Î¹ ÏÏÎµÏ‚ Î¼Îµ Ï„Î·Î½ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ Ï€ÏÏŒÏ„Î±ÏƒÎ·.</p>
        </div>
        <div id="hours-meta" class="text-[11px] text-slate-400"></div>
      </div>
      <div id="hours-auth-alert" class="mt-3 text-xs text-amber-600 bg-amber-100/80 dark:bg-amber-900/30 dark:text-amber-200 rounded-xl px-3 py-2 hidden">Î§ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ ÎµÎ¯ÏƒÎ¿Î´Î¿Ï‚ Î³Î¹Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Ï‰ÏÎ±ÏÎ¯Î¿Ï….</div>
      <div class="mt-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-3" id="hours-grid"></div>
      <div class="mt-4 flex flex-wrap items-center justify-between gap-3">
        <div id="hours-status" class="text-sm text-slate-500"></div>
        <div class="flex gap-2">
          <button id="cancel-hours" class="px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-sm font-semibold" disabled>Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
          <button id="save-hours" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700 disabled:opacity-60 disabled:pointer-events-none">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
        </div>
      </div>
    </section>

    <!-- REQUESTS LIST -->
    <section id="req-box" class="card mt-4 hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold">Î‘Î¹Ï„Î®Î¼Î±Ï„Î± ÏƒÏ„Î·Î½ Ï€ÏŒÎ»Î· ÏƒÎ¿Ï…</h2>
        <div class="flex items-center gap-2 text-sm">
          <span>Î ÏŒÎ»Î·:</span><span id="city-pill" class="px-2 py-1 rounded-lg bg-slate-100 dark:bg-slate-800"></span>
          <button id="reload-requests" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">â†»</button>
        </div>
      </div>
      <div id="req-list" class="mt-3 grid gap-3"></div>
      <div id="empty-state" class="hidden p-3 rounded-xl border text-sm">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎºÎºÏÎµÎ¼Î® Î±Î¹Ï„Î®Î¼Î±Ï„Î± Î±Ï…Ï„Î® Ï„Î· ÏƒÏ„Î¹Î³Î¼Î®.</div>
    </section>
  </div>

  <!-- USER AUTH MODAL -->
  <div data-auth-modal="users" id="auth-modal-users" class="fixed inset-0 hidden z-[100] items-center justify-center px-4 py-6" role="dialog" aria-modal="true" aria-labelledby="auth-user-title">
    <div class="absolute inset-0 bg-slate-950/70 backdrop-blur-sm" data-auth-close></div>
    <div class="relative w-full max-w-xl mx-auto">
      <div class="relative overflow-hidden rounded-3xl glass-surface border border-white/40 dark:border-slate-700/60 bg-white/70 dark:bg-slate-900/80 backdrop-blur-xl shadow-[0_30px_60px_rgba(15,23,42,0.18)] auth-portal-card" data-auth-card>
        <div class="absolute inset-0 pointer-events-none">
          <div class="absolute -top-24 right-[-60px] h-56 w-56 rounded-full bg-sky-400/20 blur-3xl"></div>
          <div class="absolute -bottom-28 left-[-40px] h-60 w-60 rounded-full bg-brand-500/25 blur-3xl"></div>
        </div>
        <div class="auth-emoji-layer" aria-hidden="true">
          <span>ğŸ’Š</span>
          <span>ğŸ’‰</span>
          <span>ğŸ©º</span>
          <span>ğŸ©¹</span>
          <span>ğŸ§´</span>
          <span>ğŸ’š</span>
          <span>âš•ï¸</span>
        </div>
        <button type="button" class="absolute top-4 right-4 z-10 p-2 rounded-xl bg-white/70 dark:bg-slate-800/60 border border-white/60 dark:border-slate-700 text-slate-600 dark:text-slate-200 hover:bg-white dark:hover:bg-slate-700" data-auth-close aria-label="ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿">âœ•</button>
        <div class="relative p-6 sm:p-8 space-y-6" data-auth-root data-auth-role="users">
          <div class="flex flex-col items-center text-center gap-4">
            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-brand-500 to-brand-600 text-white grid place-items-center shadow-lg">
              <svg viewBox="0 0 24 24" class="w-9 h-9" aria-hidden="true">
                <path fill="currentColor" d="M11 2h2v3.06A7 7 0 0 1 18.94 11H22v2h-3.06A7 7 0 0 1 13 18.94V22h-2v-3.06A7 7 0 0 1 5.06 13H2v-2h3.06A7 7 0 0 1 11 5.06V2Zm1 5a5 5 0 1 0 0 10a5 5 0 0 0 0-10Z" />
              </svg>
            </div>
            <div class="space-y-2">
              <h2 id="auth-user-title" class="text-2xl font-bold tracking-tight text-slate-900 dark:text-white">Î£ÏÎ½Î´ÎµÏƒÎ· ÏƒÏ„Î·Î½ Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼Î± MediRadar</h2>
              <p id="auth-user-subtitle" class="text-sm text-slate-600 dark:text-slate-300">Î£Ï…Î½Î­Ï‡Î¹ÏƒÎµ Î¼Îµ magic link Î® Google Î³Î¹Î± Î½Î± Ï€ÏÎ¿Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹Ï‚ ÏƒÏ„Î· Î´Î­ÏƒÎ¼ÎµÏ…ÏƒÎ·.</p>
            </div>
          </div>

          <p data-auth-status-global class="hidden text-sm text-center text-rose-600"></p>

          <div data-auth-forms class="space-y-5">
            <form data-auth-form="users" class="space-y-4" novalidate>
              <label class="flex flex-col gap-2 text-left text-sm font-semibold text-slate-700 dark:text-slate-200">
                <span id="auth-users-email-label">Email</span>
                <input id="auth-users-email-input" type="email" required autocomplete="email" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white/90 dark:bg-slate-900/80 px-3 py-3 text-base focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="name@email.com">
              </label>
              <button type="submit" id="auth-users-email-cta" data-auth-email-button class="w-full rounded-xl bg-gradient-to-r from-brand-500 via-brand-600 to-brand-500 px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-brand-500/30 hover:opacity-95 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-500">Î£ÏÎ½Î´ÎµÏƒÎ· / Î•Î³Î³ÏÎ±Ï†Î® Î¼Îµ Email</button>
              <button type="button" data-auth-google class="w-full flex items-center justify-center gap-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white/90 dark:bg-slate-900/80 px-4 py-3 text-sm font-semibold text-slate-700 dark:text-slate-200 shadow-sm hover:bg-white">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" class="w-5 h-5" />
                <span id="auth-users-google-cta">Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Google</span>
              </button>
              <p data-auth-status class="min-h-[1.25rem] text-center text-sm text-slate-600 dark:text-slate-300"></p>
            </form>
          </div>

          <div data-auth-success class="hidden flex-col items-center gap-3 text-center">
            <div class="w-14 h-14 rounded-full bg-emerald-500/15 text-emerald-500 grid place-items-center text-2xl shadow-inner">âœ…</div>
            <p id="auth-user-success-text" class="text-sm font-semibold text-emerald-600 dark:text-emerald-300">Î•Ï€Î¹Ï„Ï…Ï‡Î®Ï‚ Î£ÏÎ½Î´ÎµÏƒÎ·</p>
          </div>

          <div data-auth-session class="hidden">
            <div class="flex items-center justify-between gap-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/85 dark:bg-slate-900/70 px-4 py-4 shadow-inner">
              <div class="flex items-center gap-3">
                <div data-auth-avatar class="w-12 h-12 rounded-full bg-gradient-to-br from-brand-500 to-brand-600 text-white text-lg font-semibold grid place-items-center shadow-lg"></div>
                <div class="text-left">
                  <p id="auth-session-welcome" class="text-sm text-slate-500 dark:text-slate-300">ÎšÎ±Î»Ï‰ÏƒÎ®ÏÎ¸ÎµÏ‚</p>
                  <p data-auth-user-email class="text-sm font-semibold text-slate-900 dark:text-white"></p>
                </div>
              </div>
              <button type="button" data-auth-logout class="rounded-xl border border-brand-500 px-4 py-2 text-sm font-semibold text-brand-700 dark:text-brand-200 hover:bg-brand-50 dark:hover:bg-brand-900/30">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</button>
            </div>
          </div>

          <p id="auth-user-footer" class="text-xs text-slate-500 dark:text-slate-400 text-center">Î— Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÎµÎ¯Î½Î±Î¹ Î´Ï‰ÏÎµÎ¬Î½ Î³Î¹Î± Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚. ÎŸÎ¹ Ï†Î±ÏÎ¼Î±ÎºÎ¿Ï€Î¿Î¹Î¿Î¯ Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ ÎµÎ½ÎµÏÎ³Î® ÏƒÏ…Î½Î´ÏÎ¿Î¼Î® MediRadar Pro.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- PHARMACY AUTH MODAL -->
  <div data-auth-modal="pharmacies" id="auth-modal-pharmacies" class="fixed inset-0 hidden z-[100] items-center justify-center px-4 py-6" role="dialog" aria-modal="true" aria-labelledby="auth-pharm-title">
    <div class="absolute inset-0 bg-slate-950/70 backdrop-blur-sm" data-auth-close></div>
    <div class="relative w-full max-w-xl mx-auto">
      <div class="relative overflow-hidden rounded-3xl glass-surface border border-white/40 dark:border-slate-700/60 bg-white/70 dark:bg-slate-900/80 backdrop-blur-xl shadow-[0_30px_60px_rgba(15,23,42,0.18)] auth-portal-card" data-auth-card>
        <div class="absolute inset-0 pointer-events-none">
          <div class="absolute -top-24 right-[-60px] h-56 w-56 rounded-full bg-sky-400/20 blur-3xl"></div>
          <div class="absolute -bottom-28 left-[-40px] h-60 w-60 rounded-full bg-brand-500/25 blur-3xl"></div>
        </div>
        <div class="auth-emoji-layer" aria-hidden="true">
          <span>ğŸ’Š</span>
          <span>ğŸ’‰</span>
          <span>ğŸ©¹</span>
          <span>ğŸ§´</span>
          <span>ğŸ’š</span>
        </div>
        <button type="button" class="absolute top-4 right-4 z-10 p-2 rounded-xl bg-white/70 dark:bg-slate-800/60 border border-white/60 dark:border-slate-700 text-slate-600 dark:text-slate-200 hover:bg-white dark:hover:bg-slate-700" data-auth-close aria-label="ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿">âœ•</button>
        <div class="relative p-6 sm:p-8 space-y-6" data-auth-root data-auth-role="pharmacies">
          <div class="flex flex-col items-center text-center gap-4">
            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-brand-500 to-brand-600 text-white grid place-items-center shadow-lg">
              <svg viewBox="0 0 24 24" class="w-9 h-9" aria-hidden="true">
                <path fill="currentColor" d="M11 2h2v3.06A7 7 0 0 1 18.94 11H22v2h-3.06A7 7 0 0 1 13 18.94V22h-2v-3.06A7 7 0 0 1 5.06 13H2v-2h3.06A7 7 0 0 1 11 5.06V2Zm1 5a5 5 0 1 0 0 10a5 5 0 0 0 0-10Z" />
              </svg>
            </div>
            <div class="space-y-2">
              <h2 id="auth-pharm-title" class="text-2xl font-bold tracking-tight text-slate-900 dark:text-white">Î ÏÏŒÏƒÎ²Î±ÏƒÎ· Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Ï‰Î½</h2>
              <p id="auth-pharm-subtitle" class="text-sm text-slate-600 dark:text-slate-300">Î£Ï…Î½Î´Î­ÏƒÎ¿Ï… Î® ÎµÎ³Î³ÏÎ¬ÏˆÎ¿Ï… ÏƒÏ„Î¿ MediRadar Pro Î³Î¹Î± Î½Î± Î±Ï€Î±Î½Ï„Î¬Ï‚ ÏƒÎµ Î±Î¹Ï„Î®Î¼Î±Ï„Î± Î´Î¹Î±Î¸ÎµÏƒÎ¹Î¼ÏŒÏ„Î·Ï„Î±Ï‚.</p>
            </div>
          </div>

          <p data-auth-status-global class="hidden text-sm text-center text-rose-600"></p>

          <div data-auth-forms class="space-y-5">
            <form data-auth-form="pharmacies" class="space-y-4" novalidate>
              <label class="flex flex-col gap-2 text-left text-sm font-semibold text-slate-700 dark:text-slate-200">
                <span id="auth-pharm-email-label">Email Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…</span>
                <input id="auth-pharm-email-input" type="email" required autocomplete="email" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white/90 dark:bg-slate-900/80 px-3 py-3 text-base focus:outline-none focus:ring-4 focus:ring-brand-500/30" placeholder="pharmacy@example.gr">
              </label>
              <button type="submit" id="auth-pharm-email-cta" data-auth-email-button class="w-full rounded-xl bg-gradient-to-r from-brand-500 via-brand-600 to-brand-500 px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-brand-500/30 hover:opacity-95 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-500">Î£ÏÎ½Î´ÎµÏƒÎ· / Î•Î³Î³ÏÎ±Ï†Î® Î¼Îµ Email</button>
              <button type="button" data-auth-google class="w-full flex items-center justify-center gap-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white/90 dark:bg-slate-900/80 px-4 py-3 text-sm font-semibold text-slate-700 dark:text-slate-200 shadow-sm hover:bg-white">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" class="w-5 h-5" />
                <span id="auth-pharm-google-cta">Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Google</span>
              </button>
              <p data-auth-status class="min-h-[1.25rem] text-center text-sm text-slate-600 dark:text-slate-300"></p>
            </form>
          </div>

          <div data-auth-success class="hidden flex-col items-center gap-3 text-center">
            <div class="w-14 h-14 rounded-full bg-emerald-500/15 text-emerald-500 grid place-items-center text-2xl shadow-inner">âœ…</div>
            <p id="auth-pharm-success-text" class="text-sm font-semibold text-emerald-600 dark:text-emerald-300">Î•Ï€Î¹Ï„Ï…Ï‡Î®Ï‚ Î£ÏÎ½Î´ÎµÏƒÎ·</p>
          </div>

          <div data-auth-session class="hidden">
            <div class="flex items-center justify-between gap-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/85 dark:bg-slate-900/70 px-4 py-4 shadow-inner">
              <div class="flex items-center gap-3">
                <div data-auth-avatar class="w-12 h-12 rounded-full bg-gradient-to-br from-brand-500 to-brand-600 text-white text-lg font-semibold grid place-items-center shadow-lg"></div>
                <div class="text-left">
                  <p class="text-sm text-slate-500 dark:text-slate-300">ÎšÎ±Î»Ï‰ÏƒÎ®ÏÎ¸ÎµÏ‚</p>
                  <p data-auth-user-email class="text-sm font-semibold text-slate-900 dark:text-white"></p>
                </div>
              </div>
              <button type="button" data-auth-logout class="rounded-xl border border-brand-500 px-4 py-2 text-sm font-semibold text-brand-700 dark:text-brand-200 hover:bg-brand-50 dark:hover:bg-brand-900/30">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</button>
            </div>
          </div>

          <p id="auth-pharm-footer" class="text-xs text-slate-500 dark:text-slate-400 text-center">Î— Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÎµÎ¯Î½Î±Î¹ Î´Ï‰ÏÎµÎ¬Î½ Î³Î¹Î± Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚. ÎŸÎ¹ Ï†Î±ÏÎ¼Î±ÎºÎ¿Ï€Î¿Î¹Î¿Î¯ Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ ÎµÎ½ÎµÏÎ³Î® ÏƒÏ…Î½Î´ÏÎ¿Î¼Î® MediRadar Pro.</p>

          <button type="button" id="auth-pro-info-link" data-pro-info-toggle aria-expanded="false" class="mx-auto block text-xs font-semibold text-brand-700 underline decoration-dotted underline-offset-4 hover:text-brand-600 dark:text-brand-200 dark:hover:text-brand-100">ÎœÎ¬Î¸ÎµÏ„Îµ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ± Î³Î¹Î± Ï„Î¿ MediRadar Pro</button>
          <div data-pro-info-panel class="pro-info-panel glass-surface hidden text-left text-sm text-slate-700 dark:text-slate-200" role="region" aria-label="Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ MediRadar Pro">
            <h3>Î“Î¹Î±Ï„Î¯ Î½Î± ÎµÏ€Î¹Î»Î­Î¾ÎµÏ„Îµ Ï„Î¿ MediRadar Pro</h3>
            <p>Î¤Î¿ MediRadar Pro Ï€ÏÎ¿ÏƒÏ†Î­ÏÎµÎ¹ ÏƒÏ„Î¿Ï…Ï‚ Ï†Î±ÏÎ¼Î±ÎºÎ¿Ï€Î¿Î¹Î¿ÏÏ‚ Î­Î½Î± ÎµÏÏ‡ÏÎ·ÏƒÏ„Î¿ ÎºÎ±Î¹ Î³ÏÎ®Î³Î¿ÏÎ¿ ÏƒÏÏƒÏ„Î·Î¼Î± Î³Î¹Î± Î½Î± Î±Ï€Î±Î½Ï„Î¿ÏÎ½ Î¬Î¼ÎµÏƒÎ± ÏƒÏ„Î± Î±Î¹Ï„Î®Î¼Î±Ï„Î± Î´Î¹Î±Î¸ÎµÏƒÎ¹Î¼ÏŒÏ„Î·Ï„Î±Ï‚ Ï†Î±ÏÎ¼Î¬ÎºÏ‰Î½ Ï„Ï‰Î½ Ï€ÎµÎ»Î±Ï„ÏÎ½ Ï„Î¿Ï…Ï‚, Ï‡Ï‰ÏÎ¯Ï‚ Ï„Î·Î»ÎµÏ†Ï‰Î½Î®Î¼Î±Ï„Î± ÎºÎ±Î¹ ÎºÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ®ÏƒÎµÎ¹Ï‚.</p>
            <p>ÎœÎµ Ï„Î· ÏƒÏ…Î½Î´ÏÎ¿Î¼Î® Pro:</p>
            <ul>
              <li><span aria-hidden="true">ğŸ“±</span><span>Î•Î¾Ï…Ï€Î·ÏÎµÏ„ÎµÎ¯Ï„Îµ Ï„Î¿Ï…Ï‚ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚ ÏƒÎ±Ï‚ ÏƒÎµ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒ Ï‡ÏÏŒÎ½Î¿.</span></li>
              <li><span aria-hidden="true">ğŸ’¬</span><span>ÎœÎµÎ¹ÏÎ½ÎµÏ„Îµ Ï„Î± Ï„Î·Î»ÎµÏ†Ï‰Î½Î®Î¼Î±Ï„Î± ÎºÎ±Î¹ Ï„Î·Î½ Î±Ï€Î±ÏƒÏ‡ÏŒÎ»Î·ÏƒÎ· Ï„Î¿Ï… Ï€ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÎ¿Ï.</span></li>
              <li><span aria-hidden="true">âš¡</span><span>ÎšÎµÏÎ´Î¯Î¶ÎµÏ„Îµ Î½Î­Î¿Ï…Ï‚ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚ Ï€Î¿Ï… Î²Î»Î­Ï€Î¿Ï…Î½ Ï„Î· Î´Î¹Î±Î¸ÎµÏƒÎ¹Î¼ÏŒÏ„Î·Ï„Î¬ ÏƒÎ±Ï‚ Î¬Î¼ÎµÏƒÎ±.</span></li>
              <li><span aria-hidden="true">ğŸ’¶</span><span>Î•Î¾Î¿Î¹ÎºÎ¿Î½Î¿Î¼ÎµÎ¯Ï„Îµ Ï‡ÏÏŒÎ½Î¿ ÎºÎ±Î¹ Î±Ï…Î¾Î¬Î½ÎµÏ„Îµ Ï„Î± ÎºÎ­ÏÎ´Î· Î±Ï€ÏŒ Î³ÏÎ®Î³Î¿ÏÎµÏ‚ Ï€Ï‰Î»Î®ÏƒÎµÎ¹Ï‚.</span></li>
              <li><span aria-hidden="true">â˜ï¸</span><span>Î”ÎµÎ½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· â€” Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ 100% Î¼Î­ÏƒÏ‰ cloud.</span></li>
            </ul>
            <p>Î— ÎµÏ„Î®ÏƒÎ¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î® Î±Î½Î­ÏÏ‡ÎµÏ„Î±Î¹ ÏƒÎµ Î¼ÏŒÎ»Î¹Ï‚ <b>â‚¬365/Î­Ï„Î¿Ï‚</b> â€” Î»Î¹Î³ÏŒÏ„ÎµÏÎ¿ Î±Ï€ÏŒ â‚¬1 Ï„Î·Î½ Î·Î¼Î­ÏÎ±, Î³Î¹Î± Î½Î± ÎµÎ½Î¹ÏƒÏ‡ÏÏƒÎµÏ„Îµ Ï„Î·Î½ ÎµÎ¾Ï…Ï€Î·ÏÎ­Ï„Î·ÏƒÎ· ÎºÎ±Î¹ Ï„Î·Î½ ÎµÎ¹ÎºÏŒÎ½Î± Ï„Î¿Ï… Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï… ÏƒÎ±Ï‚.</p>
            <p><em>Î•Ï€Î¹Î»Î­Î¾Ï„Îµ MediRadar Pro ÎºÎ±Î¹ ÎºÎ¬Î½Ï„Îµ Ï„Î¿ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿ ÏƒÎ±Ï‚ Î¼Î­ÏÎ¿Ï‚ Ï„Î·Ï‚ Î½Î­Î±Ï‚ ÏˆÎ·Ï†Î¹Î±ÎºÎ®Ï‚ ÎµÏ€Î¿Ï‡Î®Ï‚.</em></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ENV -->
  <script src="/env.js"></script>

  <!-- Supabase + App -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    import { supabaseClient } from "./firebase.js";
    import {
      WEEK_DAYS,
      createEmptySchedule,
      cloneSchedule,
      validateSchedule,
      loadSchedule,
      saveSchedule
    } from "./pharmacy/schedule.js";

    /* ---------- setup ---------- */
    const env = window.ENV || {};
    const SUPABASE_URL = env.SUPABASE_URL || window.SUPABASE_URL || '';
    const SUPABASE_ANON_KEY = env.SUPABASE_ANON_KEY || window.SUPABASE_ANON_KEY || '';
    const missingSupabaseMessage = 'Î›ÎµÎ¯Ï€Î¿Ï…Î½ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Supabase (URL Î® anon key). Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î¿ env.js.';
    const hasSupabaseConfig = !!(SUPABASE_URL && SUPABASE_ANON_KEY);
    const supabase = supabaseClient || (hasSupabaseConfig
      ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null);
    const supabaseStatus = {
      ready: !!supabase,
      reason: hasSupabaseConfig ? 'client_unavailable' : 'missing_config'
    };
    const runningWithoutSupabase = !supabaseStatus.ready;
    const supabaseFallbackNotice = 'Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ ÏƒÎµ demo Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Ï‡Ï‰ÏÎ¯Ï‚ ÏƒÏÎ½Î´ÎµÏƒÎ· Supabase.';
    if(supabase && !window.mediradarSupabase){
      window.mediradarSupabase = supabase;
    }
    if(!supabaseStatus.ready){
      console.warn(`${missingSupabaseMessage} (url:${hasSupabaseConfig ? 'ok' : 'â€”'}, client:${supabaseClient ? 'reused' : 'missing'})`);
    }

    const DEMO_CREDENTIALS = {
      email: 'demo@pharmacy.gr',
      password: 'Demo123!'
    };

    const DEMO_PHARMACY = {
      id: 'demo-pharmacy',
      name: 'Demo Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿',
      city: 'Î‘Î¸Î®Î½Î±',
      address: 'Î•Î¹ÎºÎ¿Î½Î¹ÎºÎ® Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·',
      phone: '2100000000',
      isDemo: true
    };

    const DEMO_USER_METADATA = {
      role: 'pharmacy',
      pharmacy_id: DEMO_PHARMACY.id,
      pharmacy_name: DEMO_PHARMACY.name,
      pharmacy_city: DEMO_PHARMACY.city,
      pharmacy_address: DEMO_PHARMACY.address,
      pharmacy_phone: DEMO_PHARMACY.phone,
      demo: true
    };

    const DEMO_REQUEST_TEMPLATES = [
      {
        med_name: 'Î Î±ÏÎ±ÎºÎµÏ„Î±Î¼ÏŒÎ»Î· 500mg',
        med_type: 'Î”Î¹ÏƒÎºÎ¯Î±',
        quantity: 1,
        allow_generic: true,
        customer_name: 'Î•Î»Î­Î½Î·'
      },
      {
        med_name: 'Î‘Î½Ï„Î¹Î²Î·Ï‡Î¹ÎºÏŒ Î£Î¹ÏÏŒÏ€Î¹',
        med_type: 'Î£Î¹ÏÏŒÏ€Î¹',
        quantity: 2,
        allow_generic: false,
        customer_name: 'Î“Î¹ÏÏÎ³Î¿Ï‚'
      },
      {
        med_name: 'Î‘Î½Ï„Î¹ÏƒÏ„Î±Î¼Î¹Î½Î¹ÎºÎ¬',
        med_type: 'Î”Î¹ÏƒÎºÎ¯Î±',
        quantity: 1,
        allow_generic: true,
        customer_name: 'ÎœÎ±ÏÎ¯Î±'
      }
    ];

    function buildDemoRequestsPayload(){
      const now = Date.now();
      return DEMO_REQUEST_TEMPLATES.map((template, index) => ({
        ...template,
        city: DEMO_PHARMACY.city,
        status: 'pending',
        created_at: new Date(now - index * 20 * 60 * 1000).toISOString()
      }));
    }
    const qs = (s, r=document)=>r.querySelector(s);
    const qsa = (s, r=document)=>[...r.querySelectorAll(s)];
    const toastStack = qs('#toast-stack');
    const statusBaseClasses = ['text-slate-600','dark:text-slate-300'];
    const statusSuccessClasses = ['text-emerald-600','dark:text-emerald-300'];
    const statusErrorClasses = ['text-rose-600','dark:text-rose-300'];

    // ğŸ“Œ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Ï€Î¿Ï… Î±Ï†Î¿ÏÎ¿ÏÎ½ Ï„Î¿Î½ Î½Î­Î¿ Ï€Î¯Î½Î±ÎºÎ± ÎµÎ»Î­Î³Ï‡Î¿Ï… ÎºÎ±Î¹ Ï„Î¿ DEMO login
    const publicShell = qs('#public-shell');
    const dashboardShell = qs('#pharmacy-dashboard');
    const demoLoginBtn = qs('#demo-login-btn');
    const dashboardSubtitle = qs('#dashboard-subtitle');
    const dashboardUserPill = qs('#dashboard-user-pill');
    const demoDashboardPill = qs('#demo-dashboard-pill');
    const dashboardRequestsList = qs('#dashboard-requests');
    const dashboardEmptyState = qs('#dashboard-empty');
    const dashboardReloadBtn = qs('#dashboard-reload');
    const openingHoursWrap = qs('#opening-hours-days');
    const openingHoursStatus = qs('#opening-hours-status');
    const openingHoursSaveBtn = qs('#save-opening-hours');
    const openingHoursResetBtn = qs('#reset-opening-hours');
    const openingHoursFillWeekBtn = qs('#opening-hours-add-week');

    const accessGate = qs('#pharmacy-access-gate');
    const accessLoginBtn = qs('#pharmacy-access-login');
    const accessMessageEl = qs('#pharmacy-access-message');
    const accessState = { allowed: false };

    function setAccessMessage(message = '', tone = 'muted'){
      if(!accessMessageEl) return;
      accessMessageEl.textContent = message || '';
      accessMessageEl.classList.toggle('hidden', !message);
      accessMessageEl.classList.remove('text-slate-600','dark:text-slate-300','text-amber-600','dark:text-amber-300','text-rose-600','dark:text-rose-300','text-emerald-600','dark:text-emerald-300');
      if(!message){
        accessMessageEl.classList.add('text-slate-600','dark:text-slate-300');
        return;
      }
      if(tone === 'error'){
        accessMessageEl.classList.add('text-rose-600','dark:text-rose-300');
      } else if(tone === 'warning'){
        accessMessageEl.classList.add('text-amber-600','dark:text-amber-300');
      } else if(tone === 'success'){
        accessMessageEl.classList.add('text-emerald-600','dark:text-emerald-300');
      } else {
        accessMessageEl.classList.add('text-slate-600','dark:text-slate-300');
      }
    }

    function addRoleCandidate(target, value){
      if(!target || value === undefined || value === null) return;
      if(Array.isArray(value)){
        value.forEach(entry => addRoleCandidate(target, entry));
        return;
      }
      if(typeof value === 'object'){
        Object.values(value).forEach(entry => addRoleCandidate(target, entry));
        return;
      }
      const normalized = value.toString().trim().toLowerCase();
      if(normalized){
        target.add(normalized);
      }
    }

    function isTruthyFlag(value){
      if(value === true || value === false) return value;
      if(typeof value === 'number'){
        return !Number.isNaN(value) && value !== 0;
      }
      if(typeof value === 'string'){
        const normalized = value.trim().toLowerCase();
        return normalized === 'true' || normalized === '1' || normalized === 'yes' || normalized === 'y' || normalized === 'enabled';
      }
      return false;
    }

    function userHasPharmacyAccess(session){
      const user = session?.user;
      if(!user) return false;
      const roles = new Set();
      [
        user.role,
        user.app_metadata?.role,
        user.app_metadata?.roles,
        user.user_metadata?.role,
        user.user_metadata?.roles
      ].forEach(source => addRoleCandidate(roles, source));
      if(roles.has('pharmacy') || roles.has('pharmacy_admin')) return true;

      const meta = user.user_metadata || {};
      const appMeta = user.app_metadata || {};
      const flagSources = [
        meta.pharmacy_access,
        meta.pharmacyAccess,
        meta.hasPharmacyAccess,
        appMeta.pharmacy_access,
        appMeta.pharmacyAccess
      ];
      if(flagSources.some(isTruthyFlag)) return true;

      if(meta.pharmacy_id || meta.pharmacyId || appMeta.pharmacy_id || appMeta.pharmacyId) return true;
      if(isTruthyFlag(meta.demo) || isTruthyFlag(appMeta.demo_access)) return true;

      return false;
    }

    function enforceAccessGate(session){
      if(!accessGate){
        accessState.allowed = true;
        return true;
      }
      if(runningWithoutSupabase){
        accessState.allowed = true;
        accessGate.classList.add('hidden');
        publicShell?.classList.remove('hidden');
        setAccessMessage(supabaseFallbackNotice, 'warning');
        return true;
      }
      const allowed = userHasPharmacyAccess(session);
      accessState.allowed = allowed;
      if(allowed){
        accessGate.classList.add('hidden');
        publicShell?.classList.remove('hidden');
      } else {
        publicShell?.classList.add('hidden');
        accessGate.classList.remove('hidden');
      }
      return allowed;
    }

    // ğŸ•’ Î‘Ï€Î»ÏŒ ÏƒÏÏƒÏ„Î·Î¼Î± Ï‰ÏÎ±ÏÎ¯Î¿Ï… Î¼Îµ Ï€Î¿Î»Î»Î±Ï€Î»Î­Ï‚ Î¶ÏÎ½ÎµÏ‚ Î±Î½Î¬ Î·Î¼Î­ÏÎ±
    const DASHBOARD_DAYS = [
      { key:'mon', label:'Î”ÎµÏ…Ï„Î­ÏÎ±' },
      { key:'tue', label:'Î¤ÏÎ¯Ï„Î·' },
      { key:'wed', label:'Î¤ÎµÏ„Î¬ÏÏ„Î·' },
      { key:'thu', label:'Î Î­Î¼Ï€Ï„Î·' },
      { key:'fri', label:'Î Î±ÏÎ±ÏƒÎºÎµÏ…Î®' },
      { key:'sat', label:'Î£Î¬Î²Î²Î±Ï„Î¿' },
      { key:'sun', label:'ÎšÏ…ÏÎ¹Î±ÎºÎ®' }
    ];

    function createEmptyOpeningHours(){
      const base = {};
      DASHBOARD_DAYS.forEach(day => { base[day.key] = []; });
      return base;
    }

    const dashboardState = {
      demoSession: null,
      activeUser: null,
      pharmacy: null,
      openingHoursDraft: createEmptyOpeningHours(),
      openingHoursSaved: createEmptyOpeningHours(),
      openingHoursDirty: false,
      openingHoursLoading: false
    };

    let demoLoginInFlight = false;

    function cloneOpeningHours(payload = createEmptyOpeningHours()){
      return JSON.parse(JSON.stringify(payload));
    }

    function getDemoRequestsFallback(){
      return buildDemoRequestsPayload().map((row, index) => ({
        ...row,
        id: `demo-${index + 1}`
      }));
    }

    async function ensureDemoSupabaseSetup(){
      if(!supabase) return null;
      try{
        const { data: { user } } = await supabase.auth.getUser();
        if(!user){
          return null;
        }

        const metadata = user.user_metadata || {};
        const needsMetadataUpdate = Object.entries(DEMO_USER_METADATA)
          .some(([key, value]) => metadata[key] !== value);

        if(needsMetadataUpdate){
          const updated = await supabase.auth.updateUser({ data: { ...metadata, ...DEMO_USER_METADATA } });
          if(updated.error){
            throw updated.error;
          }
        }

        const { error: upsertError } = await supabase
          .from('pharmacies')
          .upsert({
            id: DEMO_PHARMACY.id,
            name: DEMO_PHARMACY.name,
            city: DEMO_PHARMACY.city,
            address: DEMO_PHARMACY.address,
            phone: DEMO_PHARMACY.phone
          }, { onConflict: 'id' });
        if(upsertError){
          throw upsertError;
        }

        return user;
      }catch(err){
        console.warn('ensureDemoSupabaseSetup error', err);
        return null;
      }
    }

    async function seedDemoRequests(){
      if(!supabase) return;
      try{
        const { data, error } = await supabase
          .from('requests')
          .select('id')
          .eq('city', DEMO_PHARMACY.city)
          .in('status', ['pending','has_responses'])
          .limit(1);
        if(error){
          throw error;
        }
        if(data && data.length){
          return;
        }
        const payload = buildDemoRequestsPayload();
        const { error: insertError } = await supabase.from('requests').insert(payload);
        if(insertError){
          throw insertError;
        }
      }catch(err){
        console.warn('seedDemoRequests error', err);
      }
    }

    function normalizeTimeValue(value){
      if(typeof value !== 'string') return '';
      const trimmed = value.trim();
      if(!trimmed) return '';
      const match = /^([0-2]?\d):([0-5]\d)$/.exec(trimmed);
      if(!match) return '';
      const hours = Number.parseInt(match[1], 10);
      const minutes = Number.parseInt(match[2], 10);
      if(hours > 23) return '';
      return `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}`;
    }

    function setOpeningHoursStatus(message = '', tone = 'muted'){
      if(!openingHoursStatus) return;
      let cls = 'text-xs ';
      if(tone === 'error'){ cls += 'text-rose-500 dark:text-rose-300'; }
      else if(tone === 'success'){ cls += 'text-emerald-600 dark:text-emerald-300'; }
      else if(tone === 'info'){ cls += 'text-slate-500 dark:text-slate-300'; }
      else { cls += 'text-slate-500 dark:text-slate-400'; }
      openingHoursStatus.className = cls;
      openingHoursStatus.textContent = message;
    }

    function markOpeningHoursDirty(){
      const prev = dashboardState.openingHoursDirty;
      dashboardState.openingHoursDirty = JSON.stringify(dashboardState.openingHoursDraft) !== JSON.stringify(dashboardState.openingHoursSaved);
      if(prev !== dashboardState.openingHoursDirty){
        updateOpeningHoursButtons();
      }
    }

    function updateOpeningHoursButtons(){
      const disabled = dashboardState.openingHoursLoading;
      if(openingHoursSaveBtn){
        openingHoursSaveBtn.disabled = disabled || !dashboardState.openingHoursDirty;
        openingHoursSaveBtn.classList.toggle('opacity-60', openingHoursSaveBtn.disabled);
      }
      if(openingHoursResetBtn){
        openingHoursResetBtn.disabled = disabled || !dashboardState.openingHoursDirty;
        openingHoursResetBtn.classList.toggle('opacity-60', openingHoursResetBtn.disabled);
      }
    }

    function renderOpeningHours(){
      if(!openingHoursWrap) return;
      openingHoursWrap.innerHTML = '';
      DASHBOARD_DAYS.forEach(day => {
        const wrapper = document.createElement('div');
        wrapper.className = 'rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/40 p-4';

        const heading = document.createElement('div');
        heading.className = 'flex items-center justify-between gap-2';
        const title = document.createElement('h4');
        title.className = 'text-sm font-semibold';
        title.textContent = day.label;
        heading.appendChild(title);

        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'text-xs font-semibold px-3 py-1 rounded-lg border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800';
        addBtn.textContent = 'Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î¶ÏÎ½Î·Ï‚';
        addBtn.addEventListener('click', () => {
          dashboardState.openingHoursDraft[day.key] = dashboardState.openingHoursDraft[day.key] || [];
          dashboardState.openingHoursDraft[day.key].push({ start:'09:00', end:'17:00' });
          renderOpeningHours();
          dashboardState.openingHoursDirty = true;
          updateOpeningHoursButtons();
          setOpeningHoursStatus('Î ÏÏŒÏƒÎ¸ÎµÏƒÎµÏ‚ Î½Î­Î± Î¶ÏÎ½Î·. Î˜Ï…Î¼Î®ÏƒÎ¿Ï… Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÎµÎ¹Ï‚.', 'info');
        });
        heading.appendChild(addBtn);
        wrapper.appendChild(heading);

        const slots = dashboardState.openingHoursDraft[day.key] || [];
        if(!slots.length){
          const emptyMsg = document.createElement('p');
          emptyMsg.className = 'mt-3 text-xs text-slate-500 dark:text-slate-400 italic';
          emptyMsg.textContent = 'ÎšÎ»ÎµÎ¹ÏƒÏ„ÏŒ';
          wrapper.appendChild(emptyMsg);
        } else {
          const slotList = document.createElement('div');
          slotList.className = 'mt-3 space-y-2';
          slots.forEach((slot, index) => {
            const row = document.createElement('div');
            row.className = 'flex flex-wrap items-center gap-2';

            const startInput = document.createElement('input');
            startInput.type = 'time';
            startInput.className = 'px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm flex-1 min-w-[100px]';
            startInput.value = slot.start || '';
            startInput.addEventListener('input', () => {
              dashboardState.openingHoursDraft[day.key][index].start = startInput.value;
              markOpeningHoursDirty();
            });

            const endInput = document.createElement('input');
            endInput.type = 'time';
            endInput.className = 'px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm flex-1 min-w-[100px]';
            endInput.value = slot.end || '';
            endInput.addEventListener('input', () => {
              dashboardState.openingHoursDraft[day.key][index].end = endInput.value;
              markOpeningHoursDirty();
            });

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'px-2 py-1 rounded-lg border border-rose-200 dark:border-rose-700 text-xs text-rose-600 dark:text-rose-300 hover:bg-rose-50 dark:hover:bg-rose-900/40';
            removeBtn.textContent = 'âœ•';
            removeBtn.addEventListener('click', () => {
              dashboardState.openingHoursDraft[day.key].splice(index, 1);
              renderOpeningHours();
              dashboardState.openingHoursDirty = true;
              updateOpeningHoursButtons();
              setOpeningHoursStatus('Î‘Ï†Î±Î¯ÏÎµÏƒÎµÏ‚ Î¶ÏÎ½Î·. Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎµ Î³Î¹Î± Î½Î± ÎºÏÎ±Ï„Î·Î¸ÎµÎ¯ Î· Î±Î»Î»Î±Î³Î®.', 'info');
            });

            row.append(startInput, document.createTextNode(' Î­Ï‰Ï‚ '), endInput, removeBtn);
            slotList.appendChild(row);
          });
          wrapper.appendChild(slotList);
        }

        openingHoursWrap.appendChild(wrapper);
      });
      markOpeningHoursDirty();
    }

    function deserializeOpeningHours(raw){
      const base = createEmptyOpeningHours();
      if(!raw || typeof raw !== 'object') return base;
      DASHBOARD_DAYS.forEach(day => {
        const slots = Array.isArray(raw[day.key]) ? raw[day.key] : [];
        base[day.key] = slots
          .map(slot => ({
            start: normalizeTimeValue(slot.start ?? slot.from ?? slot.begin ?? ''),
            end: normalizeTimeValue(slot.end ?? slot.to ?? slot.finish ?? '')
          }))
          .filter(slot => slot.start && slot.end);
      });
      return base;
    }

    function buildOpeningHoursPayload(){
      const errors = [];
      const payload = {};
      DASHBOARD_DAYS.forEach(day => {
        const slots = dashboardState.openingHoursDraft[day.key] || [];
        const normalized = [];
        slots.forEach((slot, index) => {
          const start = normalizeTimeValue(slot.start);
          const end = normalizeTimeValue(slot.end);
          if(!start || !end){
            errors.push(`${day.label}: ÎºÎµÎ½Î¬ Ï€ÎµÎ´Î¯Î± ÏƒÏ„Î· Î¶ÏÎ½Î· ${index + 1}`);
            return;
          }
          if(end <= start){
            errors.push(`${day.label}: Î· Î»Î®Î¾Î· Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Î¼ÎµÏ„Î¬ Ï„Î·Î½ Î­Î½Î±ÏÎ¾Î· (Î¶ÏÎ½Î· ${index + 1}).`);
            return;
          }
          normalized.push({ start, end });
        });
        if(normalized.length){
          payload[day.key] = normalized;
        }
      });
      return { payload, errors };
    }

    function applyDefaultWeekTemplate(){
      dashboardState.openingHoursDraft = createEmptyOpeningHours();
      DASHBOARD_DAYS.forEach(day => {
        dashboardState.openingHoursDraft[day.key] = [{ start:'09:00', end:'17:00' }];
      });
      renderOpeningHours();
      dashboardState.openingHoursDirty = true;
      updateOpeningHoursButtons();
      setOpeningHoursStatus('Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎ±Î½ Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½ÎµÏ‚ ÏÏÎµÏ‚ 09:00-17:00 ÏƒÎµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î·Î¼Î­ÏÎµÏ‚.', 'info');
    }

    function resetOpeningHoursToSaved(){
      dashboardState.openingHoursDraft = cloneOpeningHours(dashboardState.openingHoursSaved);
      renderOpeningHours();
      setOpeningHoursStatus('Î•Ï€Î±Î½Î±Ï†Î­ÏÎ¸Î·ÎºÎ±Î½ Î¿Î¹ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½ÎµÏ‚ ÏÏÎµÏ‚.', 'info');
    }

    async function ensurePharmacyProfile(pharmacy){
      if(!supabase || !pharmacy?.id) return;
      try{
        await supabase.from('pharmacies').upsert({
          id: pharmacy.id,
          name: pharmacy.name || 'Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿',
          city: pharmacy.city || null,
          address: pharmacy.address || null,
          phone: pharmacy.phone || null
        }, { onConflict: 'id' });
      }catch(err){
        console.warn('ensurePharmacyProfile error', err);
      }
    }

    async function loadOpeningHoursForPharmacy(){
      if(!dashboardState.pharmacy?.id){
        return;
      }
      if(!supabase){
        renderOpeningHours();
        setOpeningHoursStatus('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÏÎ½Î´ÎµÏƒÎ· Supabase, Î¿Î¹ Î±Î»Î»Î±Î³Î­Ï‚ Î´ÎµÎ½ Î¸Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Ï„Î¿ÏÎ½.', 'error');
        return;
      }
      dashboardState.openingHoursLoading = true;
      updateOpeningHoursButtons();
      setOpeningHoursStatus('Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï‰ÏÎ±ÏÎ¯Î¿Ï…â€¦', 'info');
      try{
        const { data, error } = await supabase
          .from('pharmacies')
          .select('id,name,city,address,phone,opening_hours')
          .eq('id', dashboardState.pharmacy.id)
          .maybeSingle();
        if(error && error.code !== 'PGRST116'){
          throw error;
        }
        if(!data){
          await ensurePharmacyProfile(dashboardState.pharmacy);
          dashboardState.openingHoursDraft = createEmptyOpeningHours();
          dashboardState.openingHoursSaved = cloneOpeningHours(dashboardState.openingHoursDraft);
        } else {
          dashboardState.pharmacy = {
            ...dashboardState.pharmacy,
            name: data.name || dashboardState.pharmacy.name,
            city: data.city || dashboardState.pharmacy.city,
            address: data.address || dashboardState.pharmacy.address,
            phone: data.phone || dashboardState.pharmacy.phone
          };
          dashboardState.openingHoursDraft = deserializeOpeningHours(data.opening_hours);
          dashboardState.openingHoursSaved = cloneOpeningHours(dashboardState.openingHoursDraft);
        }
        renderOpeningHours();
        setOpeningHoursStatus('Î¤Î¿ Ï‰ÏÎ¬ÏÎ¹Î¿ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ.', 'info');
      }catch(err){
        console.warn('loadOpeningHoursForPharmacy error', err);
        setOpeningHoursStatus('Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Ï‰ÏÎ±ÏÎ¯Î¿Ï….', 'error');
      }finally{
        dashboardState.openingHoursLoading = false;
        updateOpeningHoursButtons();
      }
    }

    async function saveOpeningHoursForPharmacy(){
      if(!supabase || !dashboardState.pharmacy?.id){
        setOpeningHoursStatus('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÏÎ½Î´ÎµÏƒÎ· Supabase Î³Î¹Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·.', 'error');
        return;
      }
      const { payload, errors } = buildOpeningHoursPayload();
      if(errors.length){
        setOpeningHoursStatus(`Î”Î¹ÏŒÏÎ¸Ï‰ÏƒÎµ Ï„Î± Î»Î¬Î¸Î·: ${errors.join(' â€¢ ')}`, 'error');
        return;
      }
      dashboardState.openingHoursLoading = true;
      updateOpeningHoursButtons();
      setOpeningHoursStatus('Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï‰ÏÎ±ÏÎ¯Î¿Ï…â€¦', 'info');
      try{
        const { error } = await supabase.from('pharmacies').upsert({
          id: dashboardState.pharmacy.id,
          name: dashboardState.pharmacy.name,
          city: dashboardState.pharmacy.city,
          address: dashboardState.pharmacy.address,
          phone: dashboardState.pharmacy.phone,
          opening_hours: payload
        }, { onConflict: 'id' });
        if(error){
          throw error;
        }
        dashboardState.openingHoursSaved = cloneOpeningHours(payload);
        dashboardState.openingHoursDraft = cloneOpeningHours(payload);
        renderOpeningHours();
        showToast('Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½ Î¿Î¹ ÏÏÎµÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚', 'success');
        setOpeningHoursStatus('Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½ Î¿Î¹ ÏÏÎµÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚.', 'success');
      }catch(err){
        console.warn('saveOpeningHoursForPharmacy error', err);
        setOpeningHoursStatus(`Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚ Ï‰ÏÎ±ÏÎ¯Î¿Ï…: ${err?.message || 'Î†Î³Î½Ï‰ÏƒÏ„Î¿ ÏƒÏ†Î¬Î»Î¼Î±'}`, 'error');
      }finally{
        dashboardState.openingHoursLoading = false;
        updateOpeningHoursButtons();
      }
    }

    function formatRequestDate(value){
      if(!value) return 'Î†Î³Î½Ï‰ÏƒÏ„Î· ÏÏÎ±';
      try{
        return new Date(value).toLocaleString('el-GR', { hour12:false });
      }catch{ return value; }
    }

    // ğŸ“® ÎÎ­Î± Î»Î¯ÏƒÏ„Î± Î±Î¹Ï„Î·Î¼Î¬Ï„Ï‰Î½ Î¼Îµ Ï„Î± Ï„ÏÎ¯Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ Î±Ï€ÏŒÎºÏÎ¹ÏƒÎ·Ï‚
    function renderDashboardRequests(rows){
      if(!dashboardRequestsList) return;
      dashboardRequestsList.innerHTML = '';
      rows.forEach(row => {
        const allowGeneric = !!row.allow_generic;
        const card = document.createElement('article');
        card.dataset.requestId = row.id;
        card.className = 'rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/40 p-4 shadow-sm';
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-sm font-semibold text-slate-900 dark:text-white">${row.med_name || 'Î†Î³Î½Ï‰ÏƒÏ„Î¿ Ï†Î¬ÏÎ¼Î±ÎºÎ¿'}</p>
              <p class="text-xs text-slate-500 dark:text-slate-400">Î‘Î¯Ï„Î·Î¼Î± #${row.id}</p>
            </div>
            <span class="text-xs text-slate-500 dark:text-slate-400">${formatRequestDate(row.created_at)}</span>
          </div>
          <div class="mt-2 text-xs text-slate-600 dark:text-slate-300 leading-relaxed">
            ${row.med_type ? `Î¤ÏÏ€Î¿Ï‚: ${row.med_type} â€¢ ` : ''}Î Î¿ÏƒÏŒÏ„Î·Ï„Î±: ${row.quantity || 1}${row.customer_name ? ` â€¢ Î ÎµÎ»Î¬Ï„Î·Ï‚: ${row.customer_name}` : ''}<br>
            Î“ÎµÎ½ÏŒÏƒÎ·Î¼Î¿: ${allowGeneric ? 'Î•Ï€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹' : 'Î”ÎµÎ½ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹'}
          </div>
          <div class="mt-3 flex flex-wrap gap-2" data-actions>
            <button class="btn bg-emerald-600 text-white border border-emerald-700 hover:opacity-95" data-response="available">Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿</button>
            ${allowGeneric ? '<button class="btn bg-emerald-500/80 text-white border border-emerald-600 hover:opacity-95" data-response="available_generic">Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ + Î“ÎµÎ½ÏŒÏƒÎ·Î¼Î¿</button>' : ''}
            <button class="btn hover:bg-slate-100 dark:hover:bg-slate-800" data-response="unavailable">ÎœÎ· Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿</button>
          </div>
        `;
        dashboardRequestsList.appendChild(card);
      });
    }

    // ğŸ”„ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î±Î¹Ï„Î·Î¼Î¬Ï„Ï‰Î½ Ï†Î¹Î»Ï„ÏÎ±ÏÎ¹ÏƒÎ¼Î­Î½Ï‰Î½ ÏƒÎµ pending / has_responses
    async function loadDashboardRequests(){
      if(!dashboardRequestsList) return;
      dashboardRequestsList.innerHTML = '';
      if(dashboardEmptyState){
        dashboardEmptyState.classList.add('hidden');
        dashboardEmptyState.textContent = 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î¹Ï„Î®Î¼Î±Ï„Î± Ï€Î¿Ï… Î½Î± Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·.';
      }
      if(!supabase){
        renderDashboardRequests(getDemoRequestsFallback());
        if(dashboardEmptyState){
          dashboardEmptyState.classList.add('hidden');
        }
        return;
      }
      if(!dashboardState.pharmacy?.city){
        if(dashboardEmptyState){
          dashboardEmptyState.textContent = 'Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î¿ÏÎ¹ÏƒÏ„ÎµÎ¯ Ï€ÏŒÎ»Î· Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï… Î³Î¹Î± Ï„Î± Î±Î¹Ï„Î®Î¼Î±Ï„Î±.';
          dashboardEmptyState.classList.remove('hidden');
        }
        return;
      }
      try{
        const { data, error } = await supabase
          .from('requests')
          .select('id,created_at,med_name,med_type,quantity,allow_generic,customer_name,city,status')
          .eq('city', dashboardState.pharmacy.city)
          .in('status', ['pending','has_responses'])
          .order('created_at', { ascending:false })
          .limit(50);
        if(error){ throw error; }
        if(!data?.length){
          dashboardEmptyState?.classList.remove('hidden');
          return;
        }
        renderDashboardRequests(data);
      }catch(err){
        console.warn('loadDashboardRequests error', err);
        if(dashboardEmptyState){
          dashboardEmptyState.textContent = 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î±Î¹Ï„Î·Î¼Î¬Ï„Ï‰Î½.';
          dashboardEmptyState.classList.remove('hidden');
        }
      }
    }

    // âœ… ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·Ï‚ ÏƒÏ„Î¿ Supabase Î¼Îµ Ï„Î¹Ï‚ Î½Î­ÎµÏ‚ ÎºÎ±Ï„Î±ÏƒÏ„Î¬ÏƒÎµÎ¹Ï‚
    async function handleDashboardResponse(reqId, status){
      if(!supabase || !dashboardState.pharmacy?.id){
        showToast('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎµÎ½ÎµÏÎ³ÏŒ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿ Î³Î¹Î± Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·.', 'error');
        return;
      }
      try{
        const { error } = await supabase.from('responses').insert({
          request_id: reqId,
          pharmacy_id: dashboardState.pharmacy.id,
          status,
          is_demo: !!dashboardState.demoSession,
          responded_at: new Date().toISOString()
        });
        if(error){ throw error; }
        await supabase.from('requests').update({ status: 'has_responses' }).eq('id', reqId);
        showToast('Î— Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎµ.', 'success');
        await loadDashboardRequests();
      }catch(err){
        console.warn('handleDashboardResponse error', err);
        showToast('Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·Ï‚.', 'error');
      }
    }

    function leaveDashboard(){
      if(publicShell){
        publicShell.classList.toggle('hidden', !accessState.allowed);
      }
      if(dashboardShell){ dashboardShell.classList.add('hidden'); }
      demoDashboardPill?.classList.add('hidden');
      if(dashboardUserPill){ dashboardUserPill.textContent = 'â€”'; }
      if(dashboardSubtitle){ dashboardSubtitle.textContent = 'Î£Ï…Î½Î´Î­ÏƒÎ¿Ï… Î³Î¹Î± Î½Î± Î´ÎµÎ¹Ï‚ Ï„Î± Î±Î¹Ï„Î®Î¼Î±Ï„Î± Ï€ÎµÎ»Î±Ï„ÏÎ½.'; }
      if(dashboardRequestsList){ dashboardRequestsList.innerHTML = ''; }
      dashboardEmptyState?.classList.add('hidden');
      dashboardState.activeUser = null;
      dashboardState.pharmacy = dashboardState.demoSession ? dashboardState.pharmacy : null;
    }

    // ğŸ–¥ï¸ Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Î¿Ï… Î½Î­Î¿Ï… Ï€Î¯Î½Î±ÎºÎ± ÎµÎ»Î­Î³Ï‡Î¿Ï… Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…
    async function enterDashboard({ user = null, isDemo = false, pharmacy }){
      if(!pharmacy){
        console.warn('Î”ÎµÎ½ Î´ÏŒÎ¸Î·ÎºÎµ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿ Î³Î¹Î± ÎµÎ¯ÏƒÎ¿Î´Î¿ ÏƒÏ„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ± ÎµÎ»Î­Î³Ï‡Î¿Ï…');
        return;
      }
      dashboardState.activeUser = user;
      dashboardState.pharmacy = { ...dashboardState.pharmacy, ...pharmacy };
      if(isDemo){
        dashboardState.demoSession = { role:'pharmacy', pharmacy_id: pharmacy.id };
      } else {
        dashboardState.demoSession = null;
      }
      if(supabase){
        await ensurePharmacyProfile(dashboardState.pharmacy);
      }
      if(publicShell){ publicShell.classList.add('hidden'); }
      if(dashboardShell){ dashboardShell.classList.remove('hidden'); }
      demoDashboardPill?.classList.toggle('hidden', !isDemo);
      if(dashboardUserPill){
        const cityText = dashboardState.pharmacy.city ? ` â€¢ ${dashboardState.pharmacy.city}` : '';
        dashboardUserPill.textContent = `${dashboardState.pharmacy.name || 'Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿'}${cityText}`;
      }
      if(dashboardSubtitle){
        // ğŸ·ï¸ Î•Î½Î·Î¼ÎµÏÏÎ½Î¿Ï…Î¼Îµ Ï„Î· Î»ÎµÎ¶Î¬Î½Ï„Î± Î³Î¹Î± Î½Î± Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ Î¬Î¼ÎµÏƒÎ± ÏŒÏ„Î±Î½ ÎµÎ¯Î¼Î±ÏƒÏ„Îµ ÏƒÎµ DEMO Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±
        const cityLabel = dashboardState.pharmacy.city || 'â€”';
        dashboardSubtitle.textContent = isDemo
          ? `DEMO Ï€ÏÎ¿Î²Î¿Î»Î® Î±Î¹Ï„Î·Î¼Î¬Ï„Ï‰Î½ Î³Î¹Î± Ï„Î·Î½ Ï€ÏŒÎ»Î·: ${cityLabel}`
          : `Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ· Î±Î¹Ï„Î·Î¼Î¬Ï„Ï‰Î½ Î³Î¹Î± Ï„Î·Î½ Ï€ÏŒÎ»Î·: ${cityLabel}`;
      }
      await loadDashboardRequests();
      await loadOpeningHoursForPharmacy();
    }

    function syncDashboardWithSession(session){
      if(session?.user){
        const metadata = session.user.user_metadata || {};
        const role = metadata.role || session.user.app_metadata?.role;
        const pharmacyId = metadata.pharmacy_id || metadata.pharmacyId;
        if(role === 'pharmacy' && pharmacyId){
          const pharmacy = {
            id: pharmacyId,
            name: metadata.pharmacy_name || metadata.name || dashboardState.pharmacy?.name || 'Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿',
            city: metadata.city || metadata.pharmacy_city || dashboardState.pharmacy?.city || null,
            address: metadata.address || metadata.pharmacy_address || dashboardState.pharmacy?.address || null,
            phone: metadata.phone || metadata.pharmacy_phone || dashboardState.pharmacy?.phone || null,
            isDemo: metadata.demo || false
          };
          enterDashboard({ user: session.user, isDemo: !!metadata.demo, pharmacy });
          return;
        }
        if(!dashboardState.demoSession){
          leaveDashboard();
        }
        return;
      }
      if(!dashboardState.demoSession){
        leaveDashboard();
      }
    }

    // ğŸ§ª Î§ÎµÎ¹ÏÎ¹ÏƒÏ„Î®Ï‚ Î³Î¹Î± Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ Â«Î£ÏÎ½Î´ÎµÏƒÎ· DEMO Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…Â»
    async function handleDemoLogin(){
      if(demoLoginInFlight){
        return;
      }
      if(dashboardState.demoSession && runningWithoutSupabase){
        showToast('Î— demo Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± ÎµÎ¯Î½Î±Î¹ Î®Î´Î· ÎµÎ½ÎµÏÎ³Î®.', 'info');
        return;
      }
      demoLoginInFlight = true;
      setButtonLoading(demoLoginBtn, true, 'Î£ÏÎ½Î´ÎµÏƒÎ· DEMOâ€¦');
      try{
        if(!supabase){
          enterDashboard({ user: null, isDemo: true, pharmacy: DEMO_PHARMACY });
          renderDashboardRequests(getDemoRequestsFallback());
          showToast('Demo Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Ï‡Ï‰ÏÎ¯Ï‚ Supabase: demo@pharmacy.gr / Demo123!.', 'info');
          return;
        }
        let { error } = await supabase.auth.signInWithPassword(DEMO_CREDENTIALS);
        if(error){
          const { error: signUpError } = await supabase.auth.signUp({
            email: DEMO_CREDENTIALS.email,
            password: DEMO_CREDENTIALS.password,
            options: { data: { ...DEMO_USER_METADATA } }
          });
          if(signUpError){ throw signUpError; }
          const retry = await supabase.auth.signInWithPassword(DEMO_CREDENTIALS);
          if(retry.error){ throw retry.error; }
        }
        await ensureDemoSupabaseSetup();
        await seedDemoRequests();
        await loadPharmacies();
        const { data } = await supabase.auth.getSession();
        if(data?.session){
          authSession = data.session;
          updateAuthSessionUI();
        }
        showToast('Î£Ï…Î½Î´Î­Î¸Î·ÎºÎµÏ‚ Ï‰Ï‚ demo@pharmacy.gr (ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ Demo123!).', 'success');
      }catch(err){
        console.warn('handleDemoLogin fallback', err);
        enterDashboard({ user: null, isDemo: true, pharmacy: DEMO_PHARMACY });
        renderDashboardRequests(getDemoRequestsFallback());
        showToast('Fallback DEMO Ï‡Ï‰ÏÎ¯Ï‚ Supabase: demo@pharmacy.gr / Demo123!.', 'info');
      }finally{
        demoLoginInFlight = false;
        setButtonLoading(demoLoginBtn, false);
      }
    }

    /* Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· toast Î¼Î·Î½Ï…Î¼Î¬Ï„Ï‰Î½ Î³Î¹Î± Ï„Î¹Ï‚ ÏÎ¿Î­Ï‚ ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ */
    function showToast(message, tone='info'){
      if(!toastStack){
        alert(message);
        return;
      }
      const resolvedTone = ['success','error','info'].includes(tone) ? tone : 'info';
      const toast = document.createElement('div');
      toast.classList.add('toast', `toast--${resolvedTone}`, 'toast--hide');
      toast.textContent = message;
      toastStack.appendChild(toast);
      requestAnimationFrame(() => toast.classList.remove('toast--hide'));
      setTimeout(() => {
        toast.classList.add('toast--hide');
        toast.addEventListener('transitionend', () => toast.remove(), { once: true });
      }, 4200);
    }

    /* Utility Î³Î¹Î± Ï„Î¿ Î¿Ï€Ï„Î¹ÎºÏŒ loading ÏƒÏ„Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ */
    function setButtonLoading(button, isLoading, label='Î¦ÏŒÏÏ„Ï‰ÏƒÎ·â€¦'){
      if(!button) return;
      if(isLoading){
        if(!button.dataset.originalHtml){
          button.dataset.originalHtml = button.innerHTML;
        }
        button.disabled = true;
        button.setAttribute('aria-busy', 'true');
        button.classList.add('opacity-60','pointer-events-none');
        button.innerHTML = `<span class="flex items-center justify-center gap-2"><span class="btn-loading-indicator" aria-hidden="true"></span>${label}</span>`;
      } else {
        button.disabled = false;
        button.setAttribute('aria-busy', 'false');
        button.classList.remove('opacity-60','pointer-events-none');
        if(button.dataset.originalHtml){
          button.innerHTML = button.dataset.originalHtml;
          delete button.dataset.originalHtml;
        }
      }
    }

    /* Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Ï‰Î½ Î¼Î·Î½Ï…Î¼Î¬Ï„Ï‰Î½ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ modal */
    function setStatusMessage(element, message, tone='info'){
      if(!element) return;
      element.textContent = message;
      element.classList.remove(...statusBaseClasses, ...statusSuccessClasses, ...statusErrorClasses);
      if(tone === 'success'){
        element.classList.add(...statusSuccessClasses);
      } else if(tone === 'error'){
        element.classList.add(...statusErrorClasses);
      } else {
        element.classList.add(...statusBaseClasses);
      }
    }

    const store = {
      pharmacy: null
    };

    const scheduleState = {
      draft: createEmptySchedule(),
      saved: createEmptySchedule(),
      meta: null,
      loading: false,
      dirty: false,
      errors: []
    };

    /* ---------- theme ---------- */
    const html = document.documentElement;
    const themeBtn = qs('#theme-toggle');
    function setTheme(mode){ const dark = mode==='dark'; html.classList.toggle('dark', dark); localStorage.setItem('mr-pharm-theme', dark?'dark':'light');}
    setTheme(localStorage.getItem('mr-pharm-theme') || (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
    themeBtn.addEventListener('click',()=> setTheme(html.classList.contains('dark')?'light':'dark'));

    /* ---------- ui refs ---------- */
    const selPh = qs('#pharmacy-select');
    const reloadPh = qs('#reload-pharmacies');
    const pickedBox = qs('#pharmacy-picked');
    const pName = qs('#pharm-name');
    const pCity = qs('#pharm-city');
    const pAddr = qs('#pharm-addr');
    const pPhone = qs('#pharm-phone');

    const authSessionEl = qs('#auth-session');
    const signOutBtn = qs('#signout-btn');
    const authModals = {
      users: qs('[data-auth-modal="users"]'),
      pharmacies: qs('[data-auth-modal="pharmacies"]')
    };
    let activeAuthModal = null;
    const authCloseEls = qsa('[data-auth-close]');
    const authOpenButtons = qsa('[data-auth-open]');
    const authHeaderSession = qs('[data-auth-header-session]');
    const authHeaderAvatar = qs('[data-auth-header-avatar]');
    const authHeaderEmail = qs('[data-auth-header-email]');
    const proInfoToggles = qsa('[data-pro-info-toggle]');

    const pharmacyAuthRoot = authModals.pharmacies || null;
    const pharmacyAuthForm = pharmacyAuthRoot?.querySelector('[data-auth-form="pharmacies"]');
    const pharmacyEmailInput = pharmacyAuthRoot?.querySelector('#auth-pharm-email-input');
    const pharmacyEmailButton = pharmacyAuthRoot?.querySelector('#auth-pharm-email-cta');
    const pharmacyGoogleButton = pharmacyAuthRoot?.querySelector('[data-auth-google]');
    const pharmacyStatusEl = pharmacyAuthRoot?.querySelector('[data-auth-status]');

    const hoursBox = qs('#hours-box');
    const hoursGrid = qs('#hours-grid');
    const saveHoursBtn = qs('#save-hours');
    const cancelHoursBtn = qs('#cancel-hours');
    const hoursStatusEl = qs('#hours-status');
    const hoursMetaEl = qs('#hours-meta');
    const hoursAuthAlert = qs('#hours-auth-alert');

    const dayControls = new Map();

    let authSession = null;

    /* Î§ÎµÎ¹ÏÎ¹ÏƒÏ„Î®Ï‚ Î³Î¹Î± Ï„Î·Î½ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® magic link ÏƒÏ„Î¿ email Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï… */
    async function handlePharmacyEmailLogin(event){
      event.preventDefault();
      const email = pharmacyEmailInput?.value?.trim();
      if(!email){
        const errorMessage = 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚: ÏƒÏ…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ email Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï….';
        showToast(errorMessage, 'error');
        setStatusMessage(pharmacyStatusEl, 'Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ email Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï….', 'error');
        return;
      }
      if(!supabase){
        const errorMessage = 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚: Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏÏÎ¸Î¼Î¹ÏƒÎ· Supabase.';
        showToast(errorMessage, 'error');
        setStatusMessage(pharmacyStatusEl, missingSupabaseMessage, 'error');
        return;
      }
      setStatusMessage(pharmacyStatusEl, 'Î“Î¯Î½ÎµÏ„Î±Î¹ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® magic linkâ€¦', 'info');
      setButtonLoading(pharmacyEmailButton, true, 'Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®â€¦');
      try{
        // Î•Ï€Î¹Î»Î¿Î³Î® Î‘ (ÎµÎ½ÎµÏÎ³Î®): Magic Link Î¼Î­ÏƒÏ‰ Supabase
        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: window.location.origin }
        });
        // Î•Ï€Î¹Î»Î¿Î³Î® Î’ (ÎµÎ½Î±Î»Î»Î±ÎºÏ„Î¹ÎºÎ®): Google OAuth Î¼Î­ÏƒÏ‰ Supabase
        // const { data, error } = await supabase.auth.signInWithOAuth({
        //   provider: 'google',
        //   options: { redirectTo: window.location.origin }
        // });
        // if(data?.url){
        //   window.location.assign(data.url);
        //   return;
        // }
        if(error) throw error;
        const successMessage = 'Î£Î¿Ï… ÏƒÏ„ÎµÎ¯Î»Î±Î¼Îµ email ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚.';
        showToast(successMessage, 'success');
        setStatusMessage(pharmacyStatusEl, successMessage, 'success');
        if(pharmacyEmailInput){ pharmacyEmailInput.value = ''; }
      } catch(err){
        const message = `Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚: ${err?.message || 'Î†Î³Î½Ï‰ÏƒÏ„Î¿ ÏƒÏ†Î¬Î»Î¼Î±.'}`;
        showToast(message, 'error');
        setStatusMessage(pharmacyStatusEl, message, 'error');
      } finally {
        setButtonLoading(pharmacyEmailButton, false);
      }
    }

    /* Î§ÎµÎ¹ÏÎ¹ÏƒÏ„Î®Ï‚ Î³Î¹Î± ÏƒÏÎ½Î´ÎµÏƒÎ· Î¼Î­ÏƒÏ‰ Google OAuth */
    async function handlePharmacyGoogleLogin(event){
      event.preventDefault();
      if(!supabase){
        const errorMessage = 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚: Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏÏÎ¸Î¼Î¹ÏƒÎ· Supabase.';
        showToast(errorMessage, 'error');
        setStatusMessage(pharmacyStatusEl, missingSupabaseMessage, 'error');
        return;
      }
      setStatusMessage(pharmacyStatusEl, 'Î†Î½Î¿Î¹Î³Î¼Î± Google Î³Î¹Î± ÏƒÏÎ½Î´ÎµÏƒÎ·â€¦', 'info');
      setButtonLoading(pharmacyGoogleButton, true, 'Î£ÏÎ½Î´ÎµÏƒÎ·â€¦');
      try{
        const { data, error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: { redirectTo: window.location.origin }
        });
        if(error) throw error;
        if(data?.url){
          window.location.assign(data.url);
        } else {
          showToast('Î†Î½Î¿Î¹Î¾Îµ Î½Î­Î¿ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ¿ Google Î³Î¹Î± Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÎ¹Ï‚.', 'info');
        }
      } catch(err){
        const message = `Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚: ${err?.message || 'Î†Î³Î½Ï‰ÏƒÏ„Î¿ ÏƒÏ†Î¬Î»Î¼Î±.'}`;
        showToast(message, 'error');
        setStatusMessage(pharmacyStatusEl, message, 'error');
      } finally {
        setButtonLoading(pharmacyGoogleButton, false);
      }
    }

    if(pharmacyAuthForm){
      pharmacyAuthForm.addEventListener('submit', handlePharmacyEmailLogin);
    }
    if(pharmacyGoogleButton){
      pharmacyGoogleButton.addEventListener('click', handlePharmacyGoogleLogin);
    }
    if(!supabase && pharmacyStatusEl){
      setStatusMessage(pharmacyStatusEl, missingSupabaseMessage, 'error');
    }

    function getSessionUser(){
      return authSession?.user || null;
    }

    function getOpenAuthModal(){
      return Object.values(authModals).find(modal => modal && !modal.classList.contains('hidden')) || null;
    }

    function openAuthModal(target='pharmacies'){
      const modal = authModals[target] || authModals.pharmacies || authModals.users;
      if(!modal) return;
      activeAuthModal = modal;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.classList.add('overflow-hidden');
      const statusEl = modal.querySelector('[data-auth-status-global]');
      if(statusEl){
        statusEl.classList.add('hidden');
        statusEl.textContent = '';
      }
      if(modal === pharmacyAuthRoot){
        setStatusMessage(pharmacyStatusEl, '', 'info');
      }
    }

    function hideProInfoPanel(panel, toggle){
      if(!panel) return;
      const finalize = () => {
        panel.classList.add('hidden');
        panel.removeEventListener('transitionend', finalize);
      };
      panel.classList.remove('is-visible');
      if(!panel.classList.contains('hidden')){
        panel.addEventListener('transitionend', finalize, { once: true });
      } else {
        panel.classList.add('hidden');
      }
      if(toggle){
        toggle.setAttribute('aria-expanded', 'false');
      }
    }

    proInfoToggles.forEach(toggle => {
      const root = toggle.closest('[data-auth-root]');
      const panel = root?.querySelector('[data-pro-info-panel]');
      if(!panel) return;
      toggle.addEventListener('click', () => {
        const isOpen = panel.classList.contains('is-visible') && !panel.classList.contains('hidden');
        if(isOpen){
          hideProInfoPanel(panel, toggle);
        } else {
          panel.classList.remove('hidden');
          requestAnimationFrame(() => panel.classList.add('is-visible'));
          toggle.setAttribute('aria-expanded', 'true');
        }
      });
    });

    function closeAuthModal(modal = activeAuthModal){
      if(!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      if(modal === activeAuthModal){
        activeAuthModal = null;
      }
      const panel = modal.querySelector('[data-pro-info-panel]');
      const toggle = modal.querySelector('[data-pro-info-toggle]');
      hideProInfoPanel(panel, toggle);
      if(!getOpenAuthModal()){
        document.body.classList.remove('overflow-hidden');
      }
    }

    function updateAuthHeaderUI(userOverride){
      const user = userOverride || getSessionUser();
      const email = user?.email || user?.user_metadata?.name || user?.phone || '';
      authOpenButtons.forEach(btn => btn.classList.toggle('hidden', !!user));
      if(authHeaderSession){ authHeaderSession.classList.toggle('hidden', !user); }
      if(authHeaderAvatar){
        const initial = (email || 'Îœ').trim().charAt(0).toUpperCase();
        authHeaderAvatar.textContent = initial || 'Îœ';
      }
      if(authHeaderEmail){ authHeaderEmail.textContent = email; }
      signOutBtn?.classList.toggle('hidden', !user);
    }

    updateAuthHeaderUI();

    if(supabase){
      supabase.auth.getSession().then(({ data })=>{
        authSession = data?.session || null;
        updateAuthSessionUI();
      }).catch(()=>undefined);
      supabase.auth.onAuthStateChange((_event, session)=>{
        authSession = session;
        updateAuthSessionUI();
      });
    }

    authOpenButtons.forEach(btn => {
      btn.addEventListener('click', async event => {
        event.preventDefault();
        // ÎŸÏÎ¯Î¶Î¿Ï…Î¼Îµ Ï„Î¿Î½ handler Ï‰Ï‚ async ÏÏƒÏ„Îµ Î½Î± Î¼Ï€Î¿ÏÎ¿ÏÎ¼Îµ Î½Î± ÎºÎ±Î»Î­ÏƒÎ¿Ï…Î¼Îµ Supabase hooks Î±Î½ Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯
        openAuthModal(btn.dataset.authTarget || 'pharmacies');
      });
    });

    accessLoginBtn?.addEventListener('click', event => {
      event.preventDefault();
      openAuthModal('pharmacies');
    });

    authCloseEls.forEach(btn => btn.addEventListener('click', () => {
      const modal = btn.closest('[data-auth-modal]');
      closeAuthModal(modal || undefined);
    }));

    document.addEventListener('keydown', event => {
      if(event.key === 'Escape' && getOpenAuthModal()){
        closeAuthModal();
      }
    });

    document.addEventListener('mediradar-auth-change', event => {
      const user = event?.detail?.user || null;
      if(user){
        updateAuthHeaderUI(user);
        if(supabase){
          supabase.auth.getSession()
            .then(({ data }) => {
              if(data?.session){
                authSession = data.session;
                updateAuthSessionUI();
              }
            })
            .catch(()=>undefined);
        }
        setTimeout(()=> closeAuthModal(), 2200);
      } else {
        authSession = null;
        updateAuthHeaderUI(null);
        updateAuthSessionUI();
      }
    });

    signOutBtn?.addEventListener('click', async ()=>{
      if(!supabase) return;
      try{
        await supabase.auth.signOut();
      }catch(err){
        console.warn('signout error', err);
      }
    });

    function updateAuthSessionUI(){
      const loggedIn = !!authSession?.user;
      const identifier = authSession?.user?.email || authSession?.user?.phone || authSession?.user?.user_metadata?.name || authSession?.user?.id || '';
      if(authSessionEl){
        authSessionEl.textContent = loggedIn
          ? `Î£Ï…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚ Ï‰Ï‚ ${identifier || 'Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚'}`
          : 'Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ ÏƒÏ…Î½Î´ÎµÎ¸ÎµÎ¯';
      }
      updateAuthHeaderUI();
      hoursAuthAlert?.classList.toggle('hidden', loggedIn);
      updateScheduleButtons();

      const allowed = enforceAccessGate(authSession);
      if(runningWithoutSupabase){
        if(!authSession?.user){
          setAccessMessage(supabaseFallbackNotice, 'warning');
        }
      } else if(allowed){
        setAccessMessage('');
      } else if(loggedIn){
        setAccessMessage('ÎŸ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ ÏƒÎ¿Ï… Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î³Î¹Î± MediRadar Pro. Î•Ï€Î¹ÎºÎ¿Î¹Î½ÏÎ½Î·ÏƒÎµ Î¼Îµ Ï„Î·Î½ Î¿Î¼Î¬Î´Î± MediRadar Î³Î¹Î± Î½Î± ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î· Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·.', 'warning');
      } else {
        setAccessMessage('Î— Ï€ÎµÏÎ¹Î¿Ï‡Î® Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï… ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î· Î¼ÏŒÎ½Î¿ ÏƒÎµ ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´Î¿Ï„Î·Î¼Î­Î½Î¿Ï…Ï‚ ÏƒÏ…Î½ÎµÏÎ³Î¬Ï„ÎµÏ‚. Î£Ï…Î½Î´Î­ÏƒÎ¿Ï… Î¼Îµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Ï€Î¿Ï… ÏƒÎ¿Ï… Î­Ï‡Î¿Ï…Î½ Î´Î¿Î¸ÎµÎ¯.', 'muted');
      }

      if(allowed){
        syncDashboardWithSession(authSession);
      } else if(!dashboardState.demoSession){
        leaveDashboard();
      }
    }
    updateAuthSessionUI();

    const reqBox = qs('#req-box');
    const cityPill = qs('#city-pill');
    const reqList = qs('#req-list');
    const emptyState = qs('#empty-state');
    const reloadReq = qs('#reload-requests');

    /* ---------- pharmacy CRUD ---------- */
    async function loadPharmacies(){
      if(!selPh){ return; }
      if(!supabase){
        const fallback = [DEMO_PHARMACY];
        selPh.innerHTML = `<option value="">â€” Î•Ï€Î¹Î»Î¿Î³Î® â€”</option>` + fallback.map(p=>`<option value="${p.id}" data-city="${p.city||''}" data-addr="${p.address||''}" data-phone="${p.phone||''}">${p.name} â€” ${p.city||'â€”'}</option>`).join('');
        return;
      }
      const { data, error } = await supabase.from('pharmacies').select('id,name,city,address,phone').order('name');
      if(error){ console.warn(error); return; }
      const list = Array.isArray(data) ? data.slice() : [];
      const hasDemo = list.some(item => item.id === DEMO_PHARMACY.id);
      if(!hasDemo){
        list.unshift({ ...DEMO_PHARMACY });
      }
      selPh.innerHTML = `<option value="">â€” Î•Ï€Î¹Î»Î¿Î³Î® â€”</option>` + list.map(p=>`<option value="${p.id}" data-city="${p.city||''}" data-addr="${p.address||''}" data-phone="${p.phone||''}">${p.name}${p.id===DEMO_PHARMACY.id?' (DEMO)':''} â€” ${p.city||'â€”'}</option>`).join('');
    }

    async function createPharmacy(){
      const name = qs('#new-name').value.trim();
      const address = qs('#new-addr').value.trim();
      const phone = qs('#new-phone').value.trim();
      const city = qs('#new-city').value;
      if(!name || !city){ alert('ÎŒÎ½Î¿Î¼Î± ÎºÎ±Î¹ Î ÏŒÎ»Î· ÎµÎ¯Î½Î±Î¹ Ï…Ï€Î¿Ï‡ÏÎµÏ‰Ï„Î¹ÎºÎ¬'); return; }
      const { data, error } = await supabase.from('pharmacies').insert({ name, address, phone, city }).select('id,name,city,address,phone').single();
      if(error){ alert('Î£Ï†Î¬Î»Î¼Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±Ï‚ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…'); console.warn(error); return; }
      await loadPharmacies();
      selPh.value = data.id;
      applyPickedFromSelect();
      qs('#new-name').value=''; qs('#new-addr').value=''; qs('#new-phone').value=''; qs('#new-city').value='';
    }

    async function applyPickedFromSelect(){
      const id = selPh.value;
      if(!id){
        pickedBox.classList.add('hidden');
        hoursBox.classList.add('hidden');
        reqBox.classList.add('hidden');
        store.pharmacy=null;
        scheduleState.draft = createEmptySchedule();
        scheduleState.saved = createEmptySchedule();
        scheduleState.meta = null;
        refreshScheduleUI({ silent:true });
        setHoursMeta(null);
        setHoursStatus('', 'muted');
        return;
      }
      const opt = selPh.selectedOptions[0];
      store.pharmacy = { id, name: opt.textContent.split(' â€” ')[0], city: opt.dataset.city, address: opt.dataset.addr, phone: opt.dataset.phone };
      pName.textContent = store.pharmacy.name;
      pCity.textContent = store.pharmacy.city || 'â€”';
      pAddr.textContent = store.pharmacy.address || 'â€”';
      pPhone.textContent = store.pharmacy.phone || 'â€”';
      pickedBox.classList.remove('hidden');
      hoursBox.classList.remove('hidden');
      reqBox.classList.remove('hidden');
      cityPill.textContent = store.pharmacy.city || 'â€”';
      if(store.pharmacy?.id && supabase){
        scheduleState.loading = true;
        updateScheduleButtons();
        setHoursStatus('Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï‰ÏÎ±ÏÎ¯Î¿Ï…â€¦', 'muted');
        await loadScheduleForCurrentPharmacy();
      }
      loadRequests();
    }

    /* ---------- hours ---------- */
    function normalizeSchedule(list = []){
      return list.map(item => ({
        dayIndex: item.dayIndex,
        open: !!item.open,
        start: item.start || '',
        end: item.end || ''
      }));
    }

    function setupScheduleEditor(){
      if(!hoursGrid) return;
      hoursGrid.innerHTML = '';
      dayControls.clear();
      WEEK_DAYS.forEach(day => {
        const card = document.createElement('div');
        card.className = 'rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/40 p-4 flex flex-col gap-3 transition-colors';
        card.dataset.dayIndex = String(day.index);

        const header = document.createElement('div');
        header.className = 'flex items-start justify-between gap-2';

        const labelWrap = document.createElement('div');
        const title = document.createElement('div');
        title.className = 'text-sm font-semibold text-slate-900 dark:text-slate-100';
        title.textContent = day.labels?.el || day.labels?.en || day.name || '';
        const status = document.createElement('div');
        status.className = 'text-[11px] text-slate-500 dark:text-slate-400';
        status.textContent = 'ÎšÎ»ÎµÎ¹ÏƒÏ„ÏŒ';
        labelWrap.append(title, status);

        const toggleWrap = document.createElement('label');
        toggleWrap.className = 'inline-flex items-center gap-2 text-xs font-medium text-slate-600 dark:text-slate-300';
        const toggle = document.createElement('input');
        toggle.type = 'checkbox';
        toggle.className = 'size-4 accent-emerald-600 rounded';
        toggleWrap.append(toggle, document.createTextNode('Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ'));

        header.append(labelWrap, toggleWrap);

        const timesWrap = document.createElement('div');
        timesWrap.className = 'grid grid-cols-2 gap-2 transition-opacity';
        const startInput = document.createElement('input');
        startInput.type = 'time';
        startInput.className = 'px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/40';
        const endInput = document.createElement('input');
        endInput.type = 'time';
        endInput.className = 'px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/40';

        timesWrap.append(startInput, endInput);
        card.append(header, timesWrap);
        hoursGrid.appendChild(card);

        dayControls.set(day.index, {
          card,
          toggle,
          statusEl: status,
          timesWrap,
          startInput,
          endInput
        });

        toggle.addEventListener('change', ()=> handleToggleChange(day.index, toggle.checked));
        startInput.addEventListener('input', ()=> handleTimeChange(day.index, 'start', startInput.value));
        endInput.addEventListener('input', ()=> handleTimeChange(day.index, 'end', endInput.value));
      });

      refreshScheduleUI({ silent:true });
    }

    function getScheduleEntry(dayIndex){
      return scheduleState.draft.find(item => item.dayIndex === dayIndex);
    }

    function handleToggleChange(dayIndex, checked){
      const entry = getScheduleEntry(dayIndex);
      if(!entry) return;
      entry.open = !!checked;
      if(!entry.open){
        entry.start = '';
        entry.end = '';
      }
      refreshScheduleUI({ silent:true });
      setDirtyStatusMessage();
    }

    function handleTimeChange(dayIndex, role, value){
      const entry = getScheduleEntry(dayIndex);
      if(!entry) return;
      if(role === 'start'){ entry.start = value; }
      else { entry.end = value; }
      refreshScheduleUI({ silent:true });
      setDirtyStatusMessage();
    }

    function refreshScheduleUI({ silent=false } = {}){
      scheduleState.draft.forEach(entry => {
        const controls = dayControls.get(entry.dayIndex);
        if(!controls) return;
        controls.toggle.checked = !!entry.open;
        controls.startInput.value = entry.start || '';
        controls.endInput.value = entry.end || '';
        const isOpen = !!entry.open;
        controls.timesWrap.classList.toggle('opacity-40', !isOpen);
        controls.timesWrap.classList.toggle('pointer-events-none', !isOpen);
        controls.statusEl.textContent = isOpen && entry.start && entry.end
          ? `${entry.start} â€“ ${entry.end}`
          : 'ÎšÎ»ÎµÎ¹ÏƒÏ„ÏŒ';
        controls.card.classList.remove('ring-2','ring-rose-400','border-rose-300','dark:border-rose-500/50');
        controls.statusEl.classList.remove('text-rose-500');
      });
      applyValidationToUI();
      updateScheduleButtons();
      if(!silent){
        setDirtyStatusMessage();
      }
    }

    function applyValidationToUI(){
      const errors = validateSchedule(scheduleState.draft);
      scheduleState.errors = errors;
      const invalidDays = new Set(errors.map(err => err.dayIndex));
      dayControls.forEach((controls, dayIndex)=>{
        const invalid = invalidDays.has(dayIndex);
        controls.card.classList.toggle('ring-2', invalid);
        controls.card.classList.toggle('ring-rose-400', invalid);
        controls.card.classList.toggle('border-rose-300', invalid);
        controls.card.classList.toggle('dark:border-rose-500/50', invalid);
        controls.statusEl.classList.toggle('text-rose-500', invalid);
      });
    }

    function isScheduleDirty(){
      return JSON.stringify(normalizeSchedule(scheduleState.draft)) !== JSON.stringify(normalizeSchedule(scheduleState.saved));
    }

    function updateScheduleButtons(){
      scheduleState.dirty = isScheduleDirty();
      const saveDisabled = !authSession?.user || scheduleState.loading || !scheduleState.dirty || (scheduleState.errors?.length ?? 0) > 0;
      if(saveHoursBtn) saveHoursBtn.disabled = !!saveDisabled;
      if(cancelHoursBtn) cancelHoursBtn.disabled = scheduleState.loading || !scheduleState.dirty;
    }

    function setHoursStatus(message='', tone='muted'){
      if(!hoursStatusEl) return;
      let cls = 'text-sm ';
      if(tone === 'error'){ cls += 'text-rose-500 dark:text-rose-300'; }
      else if(tone === 'success'){ cls += 'text-emerald-600 dark:text-emerald-300'; }
      else if(tone === 'warning'){ cls += 'text-amber-600 dark:text-amber-300'; }
      else { cls += 'text-slate-500 dark:text-slate-400'; }
      hoursStatusEl.className = cls;
      hoursStatusEl.textContent = message;
    }

    function setHoursMeta(meta){
      if(!hoursMetaEl) return;
      if(meta?.updatedAt){
        try{
          const dt = new Date(meta.updatedAt);
          const formatted = dt.toLocaleString('el-GR', { hour12:false });
          hoursMetaEl.textContent = `Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·: ${formatted}${meta.updatedBy ? ` â€¢ ${meta.updatedBy}` : ''}`;
        }catch(err){
          hoursMetaEl.textContent = `Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·: ${meta.updatedAt}${meta.updatedBy ? ` â€¢ ${meta.updatedBy}` : ''}`;
        }
      }else{
        hoursMetaEl.textContent = '';
      }
    }

    function setDirtyStatusMessage(){
      if(scheduleState.errors.length){
        setHoursStatus('Î”Î¹ÏŒÏÎ¸Ï‰ÏƒÎµ Ï„Î¹Ï‚ ÎµÏ€Î¹ÏƒÎ·Î¼Î¬Î½ÏƒÎµÎ¹Ï‚ Ï€ÏÎ¹Î½ Ï„Î·Î½ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·.', 'error');
      }else if(scheduleState.dirty){
        setHoursStatus('Î¥Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¼Î· Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½ÎµÏ‚ Î±Î»Î»Î±Î³Î­Ï‚.', 'muted');
      }else if(scheduleState.meta?.updatedAt){
        try{
          const dt = new Date(scheduleState.meta.updatedAt);
          setHoursStatus(`Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· ${dt.toLocaleString('el-GR', { hour12:false })}.`, 'muted');
        }catch{
          setHoursStatus('', 'muted');
        }
      }else{
        setHoursStatus('', 'muted');
      }
    }

    async function loadScheduleForCurrentPharmacy(){
      if(!store.pharmacy?.id || !supabase){ return; }
      try{
        const { schedule, meta } = await loadSchedule(store.pharmacy.id, { client: supabase });
        scheduleState.saved = cloneSchedule(schedule);
        scheduleState.draft = cloneSchedule(schedule);
        scheduleState.meta = meta || null;
        refreshScheduleUI({ silent:true });
        setHoursMeta(meta || null);
        setHoursStatus('Î¤Î¿ Ï‰ÏÎ¬ÏÎ¹Î¿ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ.', 'success');
      }catch(err){
        console.warn('load schedule error', err);
        scheduleState.saved = createEmptySchedule();
        scheduleState.draft = createEmptySchedule();
        scheduleState.meta = null;
        refreshScheduleUI({ silent:true });
        setHoursMeta(null);
        setHoursStatus('Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Ï‰ÏÎ±ÏÎ¯Î¿Ï….', 'error');
      }finally{
        scheduleState.loading = false;
        updateScheduleButtons();
      }
    }

    async function handleSaveSchedule(){
      if(!store.pharmacy?.id || !supabase) return;
      scheduleState.errors = validateSchedule(scheduleState.draft);
      if(scheduleState.errors.length){
        applyValidationToUI();
        updateScheduleButtons();
        setHoursStatus('Î”Î¹ÏŒÏÎ¸Ï‰ÏƒÎµ Ï„Î¹Ï‚ ÎµÏ€Î¹ÏƒÎ·Î¼Î¬Î½ÏƒÎµÎ¹Ï‚ Ï€ÏÎ¹Î½ Ï„Î·Î½ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·.', 'error');
        return;
      }
      if(!authSession?.user){
        hoursAuthAlert?.classList.remove('hidden');
        setHoursStatus('Î ÏÎ­Ï€ÎµÎ¹ Î½Î± ÏƒÏ…Î½Î´ÎµÎ¸ÎµÎ¯Ï‚ Î³Î¹Î± Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÎµÎ¹Ï‚.', 'error');
        updateScheduleButtons();
        return;
      }
      scheduleState.loading = true;
      updateScheduleButtons();
      setHoursStatus('Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·â€¦', 'muted');
      try{
        const { schedule, meta } = await saveSchedule(store.pharmacy.id, scheduleState.draft, { client: supabase, session: authSession });
        scheduleState.saved = cloneSchedule(schedule);
        scheduleState.draft = cloneSchedule(schedule);
        scheduleState.meta = meta || null;
        refreshScheduleUI({ silent:true });
        setHoursMeta(meta || null);
        setHoursStatus('Î¤Î¿ Ï‰ÏÎ¬ÏÎ¹Î¿ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.', 'success');
      }catch(err){
        console.warn('save schedule error', err);
        setHoursStatus(err?.message || 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚ Ï‰ÏÎ±ÏÎ¯Î¿Ï….', 'error');
      }finally{
        scheduleState.loading = false;
        updateScheduleButtons();
      }
    }

    function handleCancelSchedule(){
      scheduleState.draft = cloneSchedule(scheduleState.saved);
      refreshScheduleUI({ silent:true });
      setDirtyStatusMessage();
    }

    setupScheduleEditor();
    setHoursMeta(scheduleState.meta);
    setHoursStatus('', 'muted');

    /* ---------- requests feed ---------- */
    async function loadRequests(){
      reqList.innerHTML = '';
      emptyState.classList.add('hidden');
      if(!store.pharmacy?.city) return;

      if(!supabase){
        const demoRows = getDemoRequestsFallback();
        if(!demoRows.length){
          emptyState.textContent = 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î¹Ï„Î®Î¼Î±Ï„Î± Î±Ï…Ï„Î® Ï„Î· ÏƒÏ„Î¹Î³Î¼Î®.';
          emptyState.classList.remove('hidden');
          return;
        }
        demoRows.forEach(row=>{
          const card = document.createElement('div');
          card.className = 'rounded-xl border p-3 bg-white/80 dark:bg-slate-900/60';
          card.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="font-semibold">${row.med_name}</div>
              <div class="text-xs text-slate-500">${new Date(row.created_at).toLocaleString()}</div>
            </div>
            <div class="text-xs text-slate-600 dark:text-slate-400">
              Î¤ÏÏ€Î¿Ï‚: ${row.med_type||'â€”'} â€¢ Î Î¿Ïƒ: ${row.quantity}
            </div>
            <div class="mt-2 text-xs text-slate-500">* Demo Î±Î¯Ï„Î·Î¼Î±</div>
          `;
          card.dataset.id = row.id;
          reqList.appendChild(card);
        });
        return;
      }

      const { data, error } = await supabase
        .from('requests')
        .select('id, created_at, med_name, active_substance, med_type, quantity, allow_generic, city, status')
        .eq('city', store.pharmacy.city)
        .in('status', ['pending','has_responses'])
        .order('created_at', { ascending:false })
        .limit(50);

      if(error){ console.warn(error); return; }
      if(!data || !data.length){ emptyState.classList.remove('hidden'); return; }

      data.forEach(row=>{
        const card = document.createElement('div');
        card.className = 'rounded-xl border p-3 bg-white/80 dark:bg-slate-900/60';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-semibold">${row.med_name}</div>
            <div class="text-xs text-slate-500">${new Date(row.created_at).toLocaleString()}</div>
          </div>
          <div class="text-xs text-slate-600 dark:text-slate-400">
            ${row.active_substance ? `ÎŸÏ…ÏƒÎ¯Î±: ${row.active_substance} â€¢ ` : ''}Î¤ÏÏ€Î¿Ï‚: ${row.med_type||'â€”'} â€¢ Î Î¿Ïƒ: ${row.quantity}
          </div>
          <div class="mt-2 flex items-center gap-3">
            <label class="inline-flex items-center gap-2 text-sm">
              <input type="checkbox" class="gen-chk size-4 accent-brand-600"> Î“ÎµÎ½ÏŒÏƒÎ·Î¼Î¿
            </label>
            <button class="avail btn bg-emerald-600 text-white border-emerald-700 hover:opacity-95">Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿</button>
            <button class="unavail btn hover:bg-slate-100 dark:hover:bg-slate-800">ÎœÎ· Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿</button>
          </div>
        `;
        card.dataset.id = row.id;
        reqList.appendChild(card);
      });
    }

    async function sendResponse(reqId, available, isGeneric){
      if(!store.pharmacy?.id){ alert('Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿ Ï€ÏÏÏ„Î±.'); return; }
      if(!supabase){
        showToast('Demo Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±: Î¿Î¹ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚ Î´ÎµÎ½ Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹.', 'info');
        return;
      }
      const payload = { request_id: reqId, pharmacy_id: store.pharmacy.id, available: !!available, is_generic: !!isGeneric };
      const { error } = await supabase.from('responses').insert(payload);
      if(error){ alert('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·Ï‚ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·Ï‚'); console.warn(error); return; }
      // Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬, ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎµ Ï„Î¿ request ÏƒÎµ has_responses
      await supabase.from('requests').update({ status:'has_responses' }).eq('id', reqId).neq('status','reserved');
    }

    /* ---------- events ---------- */
    renderOpeningHours();

    qs('#create-pharmacy')?.addEventListener('click', createPharmacy);
    selPh?.addEventListener('change', applyPickedFromSelect);
    reloadPh?.addEventListener('click', loadPharmacies);
    saveHoursBtn?.addEventListener('click', handleSaveSchedule);
    cancelHoursBtn?.addEventListener('click', handleCancelSchedule);
    reloadReq?.addEventListener('click', loadRequests);

    demoLoginBtn?.addEventListener('click', handleDemoLogin);
    dashboardReloadBtn?.addEventListener('click', loadDashboardRequests);
    openingHoursFillWeekBtn?.addEventListener('click', applyDefaultWeekTemplate);
    openingHoursResetBtn?.addEventListener('click', resetOpeningHoursToSaved);
    openingHoursSaveBtn?.addEventListener('click', saveOpeningHoursForPharmacy);

    reqList?.addEventListener('click', async (e)=>{
      const card = e.target.closest('[data-id]'); if(!card) return;
      const reqId = card.dataset.id;
      if(e.target.closest('.avail')){
        const isGen = card.querySelector('.gen-chk')?.checked || false;
        await sendResponse(reqId, true, isGen);
        card.classList.add('opacity-60');
      }
      if(e.target.closest('.unavail')){
        await sendResponse(reqId, false, false);
        card.classList.add('opacity-60');
      }
    });

    dashboardRequestsList?.addEventListener('click', async (event) => {
      const btn = event.target.closest('[data-response]');
      if(!btn) return;
      const card = btn.closest('[data-request-id]');
      if(!card) return;
      const reqId = card.dataset.requestId;
      const status = btn.dataset.response;
      setButtonLoading(btn, true, 'ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·â€¦');
      try{
        await handleDashboardResponse(reqId, status);
      }finally{
        setButtonLoading(btn, false);
      }
    });

    /* ---------- realtime (optional) ---------- */
    try{
      supabase
        .channel('requests-feed')
        .on('postgres_changes', { event: 'INSERT', schema:'public', table:'requests', filter:`city=eq.${encodeURIComponent(store.pharmacy?.city||'')}` }, (payload)=>{
          loadRequests();
        })
        .subscribe();
    }catch{}

    /* ---------- init ---------- */
    await loadPharmacies();
  </script>
  <script type="module" src="/auth/magic-link-widget.js"></script>
</body>
</html>
