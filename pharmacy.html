<!DOCTYPE html>
<html lang="el" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MediRadar â€¢ Portal Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Ï‰Î½</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase env + SDK -->
  <script src="/env.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .app-bg{
      background:
        radial-gradient(1100px 600px at 0% -10%, rgba(132,197,244,.30), transparent 60%),
        radial-gradient(900px 540px at 110% 0%, rgba(199,166,244,.22), transparent 58%),
        radial-gradient(1000px 600px at 25% 120%, rgba(247,141,167,.18), transparent 62%),
        radial-gradient(800px 520px at 120% 120%, rgba(157,224,214,.20), transparent 60%),
        linear-gradient(180deg, #f6fbfb 0%, #f8fafc 40%, #fbfcfe 100%);
    }
  </style>
</head>
<body class="min-h-full app-bg text-slate-900 font-sans">
  <header class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
    <a href="/" class="text-sm underline">â† Î‘ÏÏ‡Î¹ÎºÎ®</a>
    <div class="font-semibold">Portal Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Ï‰Î½</div>
    <button id="logout" class="text-sm underline">ÎˆÎ¾Î¿Î´Î¿Ï‚</button>
  </header>

  <main class="max-w-4xl mx-auto px-4 pb-16">
    <!-- Auth card -->
    <section id="auth-card" class="rounded-2xl bg-white/90 border border-slate-200 shadow p-4 max-w-md mx-auto mt-6">
      <h2 class="text-lg font-bold mb-3">Î£ÏÎ½Î´ÎµÏƒÎ· Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…</h2>
      <label class="block text-sm mb-2">Email
        <input id="email" type="email" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" placeholder="pharmacy@email.com">
      </label>
      <label class="block text-sm mb-3">ÎšÏ‰Î´Î¹ÎºÏŒÏ‚
        <input id="pass" type="password" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </label>
      <button id="login" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700 w-full">Î£ÏÎ½Î´ÎµÏƒÎ·</button>
      <p class="text-xs text-slate-500 mt-2">* ÎŸ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯Ï„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿ MediRadar (Î® ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î¼Î­ÏƒÏ‰ email).</p>
    </section>

    <!-- Dashboard -->
    <section id="dash" class="hidden mt-8">
      <div class="rounded-2xl bg-white/90 border border-slate-200 shadow p-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-bold">Î‘Î¹Ï„Î®Î¼Î±Ï„Î± ÏƒÎµ ÎµÎºÎºÏÎµÎ¼ÏŒÏ„Î·Ï„Î±</h2>
          <button id="refresh" class="px-3 py-2 rounded-lg border hover:bg-slate-50">Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</button>
        </div>
        <div id="list" class="mt-4 grid gap-3"></div>
      </div>
    </section>
  </main>

  <script>
    const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    const authCard = document.getElementById('auth-card');
    const dash = document.getElementById('dash');
    const email = document.getElementById('email');
    const pass = document.getElementById('pass');
    const loginBtn = document.getElementById('login');
    const logoutBtn = document.getElementById('logout');
    const refreshBtn = document.getElementById('refresh');
    const list = document.getElementById('list');

    let pharmacyProfile = null; // { id, name, ... }

    async function getPharmacyProfile(userId){
      // Î‘Ï€Î»Î® Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¯Ï‡Î¹ÏƒÎ·: pharmacies.user_id = auth.user.id
      const { data, error } = await supabase.from('pharmacies').select('id,name,city').eq('user_id', userId).single();
      if(error) return null;
      return data;
    }

    async function loadPending(){
      list.innerHTML = '<div class="text-sm text-slate-500">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·â€¦</div>';
      // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ pending (Î® Î¼ÏŒÎ½Î¿ Î³Î¹Î± Î¯Î´Î¹Î± Ï€ÏŒÎ»Î· Î±Î½ Î¸Î­Î»ÎµÎ¹Ï‚)
      const { data, error } = await supabase
        .from('requests')
        .select('id,med_name,active_substance,med_type,qty,city,allow_generic,created_at,status')
        .eq('status','pending')
        .order('created_at',{ascending:false})
        .limit(50);
      if(error){ list.innerHTML = `<div class="text-sm text-red-600">Î£Ï†Î¬Î»Î¼Î±: ${error.message}</div>`; return; }
      if(!data || data.length===0){ list.innerHTML = `<div class="text-sm text-slate-500">ÎšÎ±Î¼Î¯Î± ÎµÎºÎºÏÎµÎ¼ÏŒÏ„Î·Ï„Î±.</div>`; return; }

      list.innerHTML = '';
      data.forEach(r=>{
        const card = document.createElement('div');
        card.className = 'rounded-xl border border-slate-200 p-4 bg-white flex items-center justify-between';
        card.innerHTML = `
          <div class="text-sm">
            <div class="font-semibold">${r.med_name}</div>
            <div class="text-xs text-slate-600">${r.active_substance||''} â€¢ ${r.med_type||''} â€¢ ${r.qty||1} Ï„Î¼Ï‡</div>
            <div class="text-xs text-slate-500 mt-1">Î ÏŒÎ»Î·: ${r.city} â€¢ ${r.allow_generic ? 'ğŸ§¬ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Î³ÎµÎ½ÏŒÏƒÎ·Î¼Î¿' : 'ÎµÎ¼Ï€Î¿ÏÎ¹ÎºÏŒ Î¼ÏŒÎ½Î¿'}</div>
          </div>
          <div class="flex gap-2">
            <button class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm btn-available">Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿</button>
          </div>`;
        card.dataset.reqId = r.id;
        list.appendChild(card);
      });
    }

    async function setAvailable(requestId){
      if(!pharmacyProfile){ alert('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï€ÏÎ¿Ï†Î¯Î» Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï….'); return; }
      // insert response
      const { error } = await supabase.from('responses').insert({
        request_id: requestId,
        pharmacy_id: pharmacyProfile.id,
        generic_only: false
      });
      if(error){ alert('Î£Ï†Î¬Î»Î¼Î±: ' + error.message); return; }
      // Î´ÎµÎ½ Î±Î»Î»Î¬Î¶Î¿Ï…Î¼Îµ status ÎµÎ´Ï â€” Ï„Î¿ frontend Ï€ÎµÎ»Î¬Ï„Î· Î¼Î­ÏƒÏ‰ RPC Î²Î»Î­Ï€ÎµÎ¹ Ï„Î¿ response
      loadPending();
    }

    loginBtn.onclick = async ()=>{
      const { data, error } = await supabase.auth.signInWithPassword({ email: email.value.trim(), password: pass.value });
      if(error){ alert('Login error: ' + error.message); return; }
      pharmacyProfile = await getPharmacyProfile(data.user.id);
      if(!pharmacyProfile){ alert('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÎºÎ±Ï„Î±Ï‡ÏÏÎ¹ÏƒÎ· Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï… Î³Î¹Î± Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î·.'); }
      authCard.classList.add('hidden'); dash.classList.remove('hidden'); loadPending();
    };

    logoutBtn.onclick = async ()=>{
      await supabase.auth.signOut();
      pharmacyProfile=null;
      dash.classList.add('hidden'); authCard.classList.remove('hidden');
    };

    refreshBtn.onclick = loadPending;

    list.addEventListener('click', (e)=>{
      const btn = e.target.closest('.btn-available'); if(!btn) return;
      const card = btn.closest('div.rounded-xl');
      const reqId = parseInt(card.dataset.reqId,10);
      setAvailable(reqId);
    });

    // auto-session
    (async ()=>{
      const { data: { user } } = await supabase.auth.getUser();
      if(user){
        pharmacyProfile = await getPharmacyProfile(user.id);
        authCard.classList.add('hidden'); dash.classList.remove('hidden');
        loadPending();
      }
    })();
  </script>
</body>
</html>
