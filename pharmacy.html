<!DOCTYPE html>
<html lang="el" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MediRadar â€¢ Pharmacy</title>

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#29a3a3" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: { brand: { 500:'#29a3a3', 600:'#208181', 700:'#196464' } },
          boxShadow: { soft:'0 16px 40px rgba(2,6,23,.12)' }
        }
      }
    }
  </script>

  <style>
    .card { @apply rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow; }
    .btn  { @apply px-3 py-2 rounded-xl border font-semibold; }
  </style>
</head>
<body class="min-h-full bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-200 font-sans">
  <div class="max-w-5xl mx-auto p-4">
    <header class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <a href="/" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">â† Î‘ÏÏ‡Î¹ÎºÎ®</a>
        <div class="flex items-center gap-2">
          <svg class="h-10 w-auto" viewBox="0 0 300 200" role="img" aria-labelledby="pharmacy-logo-title pharmacy-logo-desc">
            <title id="pharmacy-logo-title">Î›Î¿Î³ÏŒÏ„Ï…Ï€Î¿ MediRadar</title>
            <desc id="pharmacy-logo-desc">Î ÎµÏ„Î±Î»Î¿ÏÎ´Î± Î¼Îµ Ï‡Î¬Ï€Î¹ ÎºÎ±Î¹ ÏÎ±Î½Ï„Î¬Ï Î³Î¹Î± Ï„Î¿ MediRadar</desc>
            <style>
              .wing {
                transition: transform 0.4s ease;
                transform-origin: center;
              }
              svg:hover .left-wing,
              svg:active .left-wing {
                transform: rotate(-5deg);
              }
              svg:hover .right-wing,
              svg:active .right-wing {
                transform: rotate(5deg);
              }
              @media (prefers-reduced-motion: reduce) {
                .wing {
                  transition: none;
                  transform: none !important;
                }
              }
            </style>

            <g class="wing left-wing">
              <path d="M80 100 C60 60, 60 140, 80 100" fill="#4A90E2" stroke="#1A2A4F" stroke-width="4"/>
              <path d="M80 100 C100 140, 100 60, 80 100" fill="#C0C0C0" stroke="#1A2A4F" stroke-width="4"/>
              <circle cx="75" cy="85" r="4" fill="#1A2A4F"/>
              <circle cx="85" cy="85" r="4" fill="#1A2A4F"/>
              <path d="M75 95 Q80 100, 85 95" stroke="#1A2A4F" stroke-width="2" fill="none"/>
            </g>

            <g class="wing right-wing">
              <path d="M220 100 C240 60, 240 140, 220 100" fill="#A0E57A" stroke="#1A2A4F" stroke-width="4"/>
              <path d="M220 100 C200 140, 200 60, 220 100" fill="#FFFFFF" stroke="#1A2A4F" stroke-width="4"/>
              <circle cx="220" cy="100" r="8" stroke="#1A2A4F" stroke-width="2" fill="none"/>
              <circle cx="220" cy="100" r="16" stroke="#1A2A4F" stroke-width="2" fill="none"/>
              <circle cx="220" cy="100" r="24" stroke="#1A2A4F" stroke-width="2" fill="none"/>
              <circle cx="220" cy="76" r="4" fill="#1A2A4F"/>
              <circle cx="240" cy="100" r="4" fill="#1A2A4F"/>
              <circle cx="220" cy="124" r="4" fill="#1A2A4F"/>
            </g>

            <text x="90" y="180" font-family="Arial, sans-serif" font-size="24" fill="#1A2A4F">MediRadar</text>
          </svg>
          <span class="text-xl sm:text-2xl font-extrabold text-slate-900 dark:text-slate-100">â€¢ Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿</span>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="theme-toggle" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">ğŸŒ™/ğŸŒ</button>
      </div>
    </header>

    <!-- PHARMACY PICK/CREATE -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <h2 class="text-lg font-bold mb-2">Î•Ï€Î¹Î»Î¿Î³Î® Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…</h2>
        <div class="flex gap-2">
          <select id="pharmacy-select" class="w-full px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800"></select>
          <button id="reload-pharmacies" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">â†»</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹, Î´Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎ­ Ï„Î¿ Î´Î¯Ï€Î»Î±.</p>
        <div id="pharmacy-picked" class="mt-3 hidden">
          <div class="text-sm"><span class="font-semibold">Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿:</span> <span id="pharm-name"></span> â€¢ <span id="pharm-city"></span></div>
          <div class="text-xs text-slate-500"><span id="pharm-addr"></span> â€¢ <span id="pharm-phone"></span></div>
        </div>
      </div>

      <div class="card">
        <h2 class="text-lg font-bold mb-2">ÎÎ­Î¿ Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿</h2>
        <div class="grid grid-cols-1 gap-2">
          <input id="new-name"  class="px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="ÎŒÎ½Î¿Î¼Î±">
          <input id="new-addr"  class="px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·">
          <input id="new-phone" class="px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="Î¤Î·Î»Î­Ï†Ï‰Î½Î¿">
          <select id="new-city" class="px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800">
            <option value="">â€” Î ÏŒÎ»Î· â€”</option>
            <option>Î‘Î¸Î®Î½Î±</option><option>Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·</option><option>Î Î¬Ï„ÏÎ±</option>
            <option>Î—ÏÎ¬ÎºÎ»ÎµÎ¹Î¿</option><option>Î›Î¬ÏÎ¹ÏƒÎ±</option><option>Î’ÏŒÎ»Î¿Ï‚</option>
            <option>Î§Î±Î½Î¹Î¬</option><option>Î“Î»Ï…Ï†Î¬Î´Î±</option><option>Î¡ÏŒÎ´Î¿Ï‚</option>
          </select>
          <button id="create-pharmacy" class="px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold hover:opacity-95">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±</button>
        </div>
      </div>
    </section>

    <!-- HOURS JSON -->
    <section id="hours-box" class="card mt-4 hidden">
      <h2 class="text-lg font-bold mb-2">Î©ÏÎ¬ÏÎ¹Î¿</h2>
      <p class="text-xs text-slate-500 mb-2">ÎœÎ¿ÏÏ†Î® Î±Î½Î¬ Î·Î¼Î­ÏÎ±: Ï€.Ï‡. 08:00-17:00 (Î±Ï†Î®ÏƒÎµ ÎºÎµÎ½ÏŒ Î³Î¹Î± ÎºÎ»ÎµÎ¹ÏƒÏ„ÏŒ)</p>
      <div class="grid sm:grid-cols-4 md:grid-cols-7 gap-2" id="hours-grid"></div>
      <div class="mt-3 flex justify-end">
        <button id="save-hours" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:opacity-95">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î©ÏÎ±ÏÎ¯Î¿Ï…</button>
      </div>
    </section>

    <!-- REQUESTS LIST -->
    <section id="req-box" class="card mt-4 hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold">Î‘Î¹Ï„Î®Î¼Î±Ï„Î± ÏƒÏ„Î·Î½ Ï€ÏŒÎ»Î· ÏƒÎ¿Ï…</h2>
        <div class="flex items-center gap-2 text-sm">
          <span>Î ÏŒÎ»Î·:</span><span id="city-pill" class="px-2 py-1 rounded-lg bg-slate-100 dark:bg-slate-800"></span>
          <button id="reload-requests" class="btn hover:bg-slate-100 dark:hover:bg-slate-800">â†»</button>
        </div>
      </div>
      <div id="req-list" class="mt-3 grid gap-3"></div>
      <div id="empty-state" class="hidden p-3 rounded-xl border text-sm">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎºÎºÏÎµÎ¼Î® Î±Î¹Ï„Î®Î¼Î±Ï„Î± Î±Ï…Ï„Î® Ï„Î· ÏƒÏ„Î¹Î³Î¼Î®.</div>
    </section>
  </div>

  <!-- ENV -->
  <script src="/env.js"></script>
  <script>
    window.ENV = window.ENV || {
      SUPABASE_URL: 'https://qzerrisyowkfkmcyxmav.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZXJyaXN5b3drZmttY3l4bWF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTcxODQsImV4cCI6MjA3NTU5MzE4NH0.alkvHkOQPBTwY3daUcKAEsf4nt0kizuU3rYI2c2InPk'
    };
  </script>

  <!-- Supabase + App -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    /* ---------- setup ---------- */
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.ENV || {};
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const qs = (s, r=document)=>r.querySelector(s);
    const qsa = (s, r=document)=>[...r.querySelectorAll(s)];
    const store = {
      pharmacy: null,
      hoursInputs: ['ÎšÏ…Ï','Î”ÎµÏ…','Î¤ÏÎ¹','Î¤ÎµÏ„','Î ÎµÎ¼','Î Î±Ï','Î£Î±Î²'].map(d=>({day:d, val:''}))
    };

    /* ---------- theme ---------- */
    const html = document.documentElement;
    const themeBtn = qs('#theme-toggle');
    function setTheme(mode){ const dark = mode==='dark'; html.classList.toggle('dark', dark); localStorage.setItem('mr-pharm-theme', dark?'dark':'light');}
    setTheme(localStorage.getItem('mr-pharm-theme') || (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
    themeBtn.addEventListener('click',()=> setTheme(html.classList.contains('dark')?'light':'dark'));

    /* ---------- ui refs ---------- */
    const selPh = qs('#pharmacy-select');
    const reloadPh = qs('#reload-pharmacies');
    const pickedBox = qs('#pharmacy-picked');
    const pName = qs('#pharm-name');
    const pCity = qs('#pharm-city');
    const pAddr = qs('#pharm-addr');
    const pPhone = qs('#pharm-phone');

    const hoursBox = qs('#hours-box');
    const hoursGrid = qs('#hours-grid');
    const saveHoursBtn = qs('#save-hours');

    const reqBox = qs('#req-box');
    const cityPill = qs('#city-pill');
    const reqList = qs('#req-list');
    const emptyState = qs('#empty-state');
    const reloadReq = qs('#reload-requests');

    /* ---------- pharmacy CRUD ---------- */
    async function loadPharmacies(){
      const { data, error } = await supabase.from('pharmacies').select('id,name,city,address,phone').order('name');
      if(error){ console.warn(error); return; }
      selPh.innerHTML = `<option value="">â€” Î•Ï€Î¹Î»Î¿Î³Î® â€”</option>` + (data||[]).map(p=>`<option value="${p.id}" data-city="${p.city||''}" data-addr="${p.address||''}" data-phone="${p.phone||''}">${p.name} â€” ${p.city||'â€”'}</option>`).join('');
    }

    async function createPharmacy(){
      const name = qs('#new-name').value.trim();
      const address = qs('#new-addr').value.trim();
      const phone = qs('#new-phone').value.trim();
      const city = qs('#new-city').value;
      if(!name || !city){ alert('ÎŒÎ½Î¿Î¼Î± ÎºÎ±Î¹ Î ÏŒÎ»Î· ÎµÎ¯Î½Î±Î¹ Ï…Ï€Î¿Ï‡ÏÎµÏ‰Ï„Î¹ÎºÎ¬'); return; }
      const { data, error } = await supabase.from('pharmacies').insert({ name, address, phone, city }).select('id,name,city,address,phone').single();
      if(error){ alert('Î£Ï†Î¬Î»Î¼Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±Ï‚ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…'); console.warn(error); return; }
      await loadPharmacies();
      selPh.value = data.id;
      applyPickedFromSelect();
      qs('#new-name').value=''; qs('#new-addr').value=''; qs('#new-phone').value=''; qs('#new-city').value='';
    }

    function applyPickedFromSelect(){
      const id = selPh.value;
      if(!id){ pickedBox.classList.add('hidden'); hoursBox.classList.add('hidden'); reqBox.classList.add('hidden'); store.pharmacy=null; return; }
      const opt = selPh.selectedOptions[0];
      store.pharmacy = { id, name: opt.textContent.split(' â€” ')[0], city: opt.dataset.city, address: opt.dataset.addr, phone: opt.dataset.phone };
      pName.textContent = store.pharmacy.name;
      pCity.textContent = store.pharmacy.city || 'â€”';
      pAddr.textContent = store.pharmacy.address || 'â€”';
      pPhone.textContent = store.pharmacy.phone || 'â€”';
      pickedBox.classList.remove('hidden');
      hoursBox.classList.remove('hidden');
      reqBox.classList.remove('hidden');
      cityPill.textContent = store.pharmacy.city || 'â€”';
      renderHoursInputs();
      loadRequests();
    }

    /* ---------- hours ---------- */
    function renderHoursInputs(){
      const days = ['ÎšÏ…Ï','Î”ÎµÏ…','Î¤ÏÎ¹','Î¤ÎµÏ„','Î ÎµÎ¼','Î Î±Ï','Î£Î±Î²'];
      hoursGrid.innerHTML = days.map((d,i)=>`
        <label class="text-sm">
          <div class="font-semibold mb-1">${d}</div>
          <input data-day="${i}" class="w-full px-3 py-2 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="Ï€.Ï‡. 08:00-17:00">
        </label>
      `).join('');
      // load existing hours_json
      if(store.pharmacy?.id){
        supabase.from('pharmacies').select('hours_json').eq('id', store.pharmacy.id).single().then(({data})=>{
          const h = data?.hours_json || {};
          qsa('input[data-day]').forEach(inp=>{
            const di = Number(inp.dataset.day); inp.value = h[di]?.range || '';
          });
        });
      }
    }
    async function saveHours(){
      const obj = {};
      qsa('input[data-day]').forEach(inp=>{
        const di = Number(inp.dataset.day); const range = inp.value.trim();
        if(range) obj[di] = { range };
      });
      await supabase.from('pharmacies').update({ hours_json: obj }).eq('id', store.pharmacy.id);
      alert('Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ Ï„Î¿ Ï‰ÏÎ¬ÏÎ¹Î¿.');
    }

    /* ---------- requests feed ---------- */
    async function loadRequests(){
      reqList.innerHTML = '';
      emptyState.classList.add('hidden');
      if(!store.pharmacy?.city) return;

      const { data, error } = await supabase
        .from('requests')
        .select('id, created_at, med_name, active_substance, med_type, quantity, allow_generic, city, status')
        .eq('city', store.pharmacy.city)
        .in('status', ['pending','has_responses'])
        .order('created_at', { ascending:false })
        .limit(50);

      if(error){ console.warn(error); return; }
      if(!data || !data.length){ emptyState.classList.remove('hidden'); return; }

      data.forEach(row=>{
        const card = document.createElement('div');
        card.className = 'rounded-xl border p-3 bg-white/80 dark:bg-slate-900/60';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-semibold">${row.med_name}</div>
            <div class="text-xs text-slate-500">${new Date(row.created_at).toLocaleString()}</div>
          </div>
          <div class="text-xs text-slate-600 dark:text-slate-400">
            ${row.active_substance ? `ÎŸÏ…ÏƒÎ¯Î±: ${row.active_substance} â€¢ ` : ''}Î¤ÏÏ€Î¿Ï‚: ${row.med_type||'â€”'} â€¢ Î Î¿Ïƒ: ${row.quantity}
          </div>
          <div class="mt-2 flex items-center gap-3">
            <label class="inline-flex items-center gap-2 text-sm">
              <input type="checkbox" class="gen-chk size-4 accent-brand-600"> Î“ÎµÎ½ÏŒÏƒÎ·Î¼Î¿
            </label>
            <button class="avail btn bg-emerald-600 text-white border-emerald-700 hover:opacity-95">Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿</button>
            <button class="unavail btn hover:bg-slate-100 dark:hover:bg-slate-800">ÎœÎ· Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿</button>
          </div>
        `;
        card.dataset.id = row.id;
        reqList.appendChild(card);
      });
    }

    async function sendResponse(reqId, available, isGeneric){
      if(!store.pharmacy?.id){ alert('Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿ Ï€ÏÏÏ„Î±.'); return; }
      const payload = { request_id: reqId, pharmacy_id: store.pharmacy.id, available: !!available, is_generic: !!isGeneric };
      const { error } = await supabase.from('responses').insert(payload);
      if(error){ alert('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·Ï‚ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·Ï‚'); console.warn(error); return; }
      // Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬, ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎµ Ï„Î¿ request ÏƒÎµ has_responses
      await supabase.from('requests').update({ status:'has_responses' }).eq('id', reqId).neq('status','reserved');
    }

    /* ---------- events ---------- */
    qs('#create-pharmacy').addEventListener('click', createPharmacy);
    selPh.addEventListener('change', applyPickedFromSelect);
    reloadPh.addEventListener('click', loadPharmacies);
    saveHoursBtn.addEventListener('click', saveHours);
    reloadReq.addEventListener('click', loadRequests);

    reqList.addEventListener('click', async (e)=>{
      const card = e.target.closest('[data-id]'); if(!card) return;
      const reqId = card.dataset.id;
      if(e.target.closest('.avail')){
        const isGen = card.querySelector('.gen-chk')?.checked || false;
        await sendResponse(reqId, true, isGen);
        card.classList.add('opacity-60');
      }
      if(e.target.closest('.unavail')){
        await sendResponse(reqId, false, false);
        card.classList.add('opacity-60');
      }
    });

    /* ---------- realtime (optional) ---------- */
    try{
      supabase
        .channel('requests-feed')
        .on('postgres_changes', { event: 'INSERT', schema:'public', table:'requests', filter:`city=eq.${encodeURIComponent(store.pharmacy?.city||'')}` }, (payload)=>{
          loadRequests();
        })
        .subscribe();
    }catch{}

    /* ---------- init ---------- */
    await loadPharmacies();
  </script>
</body>
</html>
