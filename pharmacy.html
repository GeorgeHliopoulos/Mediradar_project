<!DOCTYPE html>
<html lang="el" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediRadar Pro - Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const SB_URL = "https://qzerrisyowkfkmcyxmav.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZXJyaXN5b3drZmttY3l4bWF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTcxODQsImV4cCI6MjA3NTU5MzE4NH0.alkvHkOQPBTwY3daUcKAEsf4nt0kizuU3rYI2c2InPk";
        tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, colors: { primary: '#0f172a', secondary: '#0d9488' }, animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' } } } }
    </script>
    <style>
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); } 
        .toast { animation: slideIn 0.3s ease-out forwards; } 
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .tab-content { display: none; animation: fadeIn 0.2s ease-out; } .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <nav class="bg-white shadow-sm border-b border-slate-200 p-4 sticky top-0 z-30">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3"><div class="w-10 h-10 bg-secondary rounded-xl flex items-center justify-center text-white shadow-lg"><i class="ph ph-first-aid-kit text-2xl"></i></div><div><h1 class="font-bold text-lg leading-tight">MediRadar <span class="text-secondary">Pro</span></h1><p class="text-xs text-slate-500">Portal Î¦Î±ÏÎ¼Î±ÎºÎ¿Ï€Î¿Î¹ÏÎ½</p></div></div>
            <div class="flex gap-2 items-center"><div id="auth-section"></div></div>
        </div>
    </nav>

    <div id="login-overlay" class="fixed inset-0 z-50 bg-slate-900/95 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-8 text-center">
            <div class="w-20 h-20 bg-secondary/10 rounded-full flex items-center justify-center mx-auto mb-4 text-secondary"><i class="ph ph-lock-key text-4xl"></i></div>
            <h2 class="text-2xl font-bold text-slate-800">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚ Pro</h2>
            <p class="text-sm text-slate-500 mb-6">Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î¿ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿ ÏƒÎ±Ï‚.</p>
            <form onsubmit="handleProLogin(event)" class="space-y-4 text-left">
                <div><label class="text-xs font-bold text-slate-500 uppercase ml-1">Email</label><input type="email" id="login-email" placeholder="pharmacy@example.com" required class="w-full bg-slate-50 border border-slate-300 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-secondary"></div>
                <button type="submit" class="w-full bg-secondary hover:bg-teal-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2"><i class="ph ph-magic-wand"></i> Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Magic Link</button>
            </form>
            <div class="mt-6"><button onclick="demoLogin()" class="text-xs text-slate-400 hover:text-secondary underline">Demo Login (Test)</button></div>
        </div>
    </div>

    <main class="max-w-6xl mx-auto p-4 w-full flex-grow">
        
        <div class="flex gap-4 mb-6 border-b border-slate-200 pb-2">
            <button onclick="switchMainTab('requests')" id="nav-requests" class="px-4 py-2 text-sm font-bold text-secondary border-b-2 border-secondary transition-colors">ğŸ”” Î‘Î¹Ï„Î®Î¼Î±Ï„Î±</button>
            <button onclick="switchMainTab('profile')" id="nav-profile" class="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 transition-colors">âš™ï¸ Î ÏÎ¿Ï†Î¯Î» & Î©ÏÎ¬ÏÎ¹Î¿</button>
        </div>

        <div id="tab-requests" class="tab-content active grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <div class="glass-panel p-5 rounded-2xl shadow-sm">
                    <h3 class="font-bold text-xs uppercase text-slate-500 mb-4">Live ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</h3>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="status-toggle" class="sr-only peer" onchange="togglePharmacyStatus()">
                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-300 rounded-full peer peer-checked:bg-secondary after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full peer-checked:after:border-white"></div>
                        <span class="ml-3 text-sm font-medium" id="status-text">ÎšÎ»ÎµÎ¹ÏƒÏ„ÏŒ</span>
                    </label>
                </div>
            </div>
            <div class="lg:col-span-3">
                <div class="flex justify-between items-end mb-4"><h2 class="text-xl font-bold flex items-center gap-2"><i class="ph ph-bell-ringing text-secondary"></i> Î•Î¹ÏƒÎµÏÏ‡ÏŒÎ¼ÎµÎ½Î±</h2><button onclick="fetchRequests()" class="text-sm text-secondary font-bold hover:underline"><i class="ph ph-arrows-clockwise"></i> Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</button></div>
                <div id="loading-spinner" class="hidden text-center py-10"><i class="ph ph-spinner animate-spin text-3xl text-secondary"></i></div>
                <div id="requests-container" class="space-y-4"></div>
            </div>
        </div>

        <div id="tab-profile" class="tab-content max-w-2xl mx-auto">
            <div class="glass-panel p-8 rounded-3xl shadow-lg relative">
                <div class="flex items-center gap-4 mb-8">
                    <div class="w-20 h-20 rounded-full bg-slate-100 overflow-hidden border-4 border-white shadow-sm relative group">
                        <img id="profile-img-preview" src="https://ui-avatars.com/api/?name=Ph&background=0d9488&color=fff" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…</h2>
                        <p class="text-sm text-slate-500">Î•Î½Î·Î¼ÎµÏÏÏƒÏ„Îµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Ï€Î¿Ï… Î²Î»Î­Ï€Î¿Ï…Î½ Î¿Î¹ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚.</p>
                    </div>
                </div>

                <form onsubmit="saveProfile(event)" class="space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Î•Ï€Ï‰Î½Ï…Î¼Î¯Î±</label><input id="prof-name" type="text" class="w-full p-3 rounded-xl border bg-slate-50 outline-none focus:border-secondary"></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Î¤Î·Î»Î­Ï†Ï‰Î½Î¿</label><input id="prof-phone" type="text" class="w-full p-3 rounded-xl border bg-slate-50 outline-none focus:border-secondary"></div>
                    </div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·</label><input id="prof-address" type="text" class="w-full p-3 rounded-xl border bg-slate-50 outline-none focus:border-secondary"></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Î©ÏÎ¬ÏÎ¹Î¿ Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚</label><input id="prof-hours" type="text" placeholder="Ï€.Ï‡. 08:00 - 14:30 & 17:30 - 21:00" class="w-full p-3 rounded-xl border bg-slate-50 outline-none focus:border-secondary"></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">URL Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚ (Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</label><input id="prof-img" type="text" placeholder="https://..." oninput="document.getElementById('profile-img-preview').src = this.value || 'https://ui-avatars.com/api/?name=Ph'" class="w-full p-3 rounded-xl border bg-slate-50 outline-none focus:border-secondary"></div>
                    
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-center justify-between">
                        <div>
                            <p class="text-sm font-bold text-blue-800">ğŸ“ Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î± GPS</p>
                            <p class="text-xs text-blue-600">Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î¼Îµ Ï„Î·Î½ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Î¸Î­ÏƒÎ· ÏƒÎ±Ï‚.</p>
                        </div>
                        <button type="button" onclick="updateLocation()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-700">Î›Î®ÏˆÎ· Î£Ï…Î½Ï„ÎµÏ„Î±Î³Î¼Î­Î½Ï‰Î½</button>
                    </div>

                    <button type="submit" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg transition-all mt-4">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î‘Î»Î»Î±Î³ÏÎ½</button>
                </form>
            </div>
        </div>

    </main>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-2"></div>

    <script>
        let currentUser = null; let myLat = null; let myLon = null; let timers = {};
        window.db = window.supabase.createClient(SB_URL, SB_KEY);

        window.onload = async function() {
            const { data: { session } } = await window.db.auth.getSession();
            if (session) { handleLoginSuccess(session.user); } else { document.getElementById('login-overlay').classList.remove('hidden'); }
        };

        function switchMainTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            document.getElementById('nav-requests').className = tab === 'requests' ? "px-4 py-2 text-sm font-bold text-secondary border-b-2 border-secondary transition-colors" : "px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 transition-colors";
            document.getElementById('nav-profile').className = tab === 'profile' ? "px-4 py-2 text-sm font-bold text-secondary border-b-2 border-secondary transition-colors" : "px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 transition-colors";
        }

        async function handleProLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const { error } = await window.db.auth.signInWithOtp({ email: email, options: { emailRedirectTo: window.location.href } });
            if (error) showToast("Î£Ï†Î¬Î»Î¼Î±: " + error.message, 'error'); else showToast("âœ… Î•ÏƒÏ„Î¬Î»Î· Magic Link!", 'success');
        }

        function handleLoginSuccess(user) {
            currentUser = user;
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('auth-section').innerHTML = `<span class="text-xs font-bold mr-2">${user.email}</span><button onclick="window.db.auth.signOut().then(()=>location.reload())" class="text-xs bg-slate-200 px-2 py-1 rounded hover:bg-red-500 hover:text-white">Exit</button>`;
            
            loadProfile(); // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…
            fetchRequests();
            setInterval(fetchRequests, 10000);
        }

        // --- PROFILE LOGIC ---
        async function loadProfile() {
            // Î ÏÎ¿ÏƒÏ€Î±Î¸Î¿ÏÎ¼Îµ Î½Î± Î²ÏÎ¿ÏÎ¼Îµ Ï„Î¿ Ï€ÏÎ¿Ï†Î¯Î». Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ (Î½Î­Î¿Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚), Ï„Î¿ Ï†Ï„Î¹Î¬Ï‡Î½Î¿Ï…Î¼Îµ.
            let { data, error } = await window.db.from('pharmacies').select('*').eq('id', currentUser.id).single();
            
            if (!data) {
                // First time setup - insert empty row
                const { data: newData, error: newError } = await window.db.from('pharmacies').insert([{ id: currentUser.id, name: 'ÎÎ­Î¿ Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿' }]).select().single();
                data = newData;
            }

            if (data) {
                document.getElementById('prof-name').value = data.name || '';
                document.getElementById('prof-address').value = data.address || '';
                document.getElementById('prof-phone').value = data.phone || '';
                document.getElementById('prof-hours').value = data.opening_hours || '';
                document.getElementById('prof-img').value = data.image_url || '';
                if(data.image_url) document.getElementById('profile-img-preview').src = data.image_url;
                
                document.getElementById('status-toggle').checked = data.is_open;
                document.getElementById('status-text').innerText = data.is_open ? 'Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ' : 'ÎšÎ»ÎµÎ¹ÏƒÏ„ÏŒ';
                
                // Set global lat/lon from profile if exists
                if(data.lat && data.lon) { myLat = data.lat; myLon = data.lon; }
                else { updateLocation(); } // Î‘Î½ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹, Ï€Î¬ÏÎµ Î±Ï€ÏŒ GPS
            }
        }

        async function saveProfile(e) {
            e.preventDefault();
            const updates = {
                name: document.getElementById('prof-name').value,
                address: document.getElementById('prof-address').value,
                phone: document.getElementById('prof-phone').value,
                opening_hours: document.getElementById('prof-hours').value,
                image_url: document.getElementById('prof-img').value,
                updated_at: new Date()
            };

            const { error } = await window.db.from('pharmacies').update(updates).eq('id', currentUser.id);
            if(error) showToast('Î£Ï†Î¬Î»Î¼Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚', 'error'); else showToast('Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ!', 'success');
        }

        function updateLocation() {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                myLat = pos.coords.latitude; 
                myLon = pos.coords.longitude;
                // Save to DB immediately
                await window.db.from('pharmacies').update({ lat: myLat, lon: myLon }).eq('id', currentUser.id);
                showToast(`Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î± ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ: ${myLat.toFixed(4)}, ${myLon.toFixed(4)}`, 'success');
            }, () => showToast('Î”ÎµÎ½ Î´ÏŒÎ¸Î·ÎºÎµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±Ï‚', 'error'));
        }

        async function togglePharmacyStatus() {
            const isOpen = document.getElementById('status-toggle').checked;
            document.getElementById('status-text').innerText = isOpen ? 'Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ' : 'ÎšÎ»ÎµÎ¹ÏƒÏ„ÏŒ';
            await window.db.from('pharmacies').update({ is_open: isOpen }).eq('id', currentUser.id);
        }

        // --- REQUESTS & RESPONSE LOGIC (Same as before) ---
        async function fetchRequests() {
            if(!currentUser) return;
            // Fetch requests... (Î¯Î´Î¹Î¿Ï‚ ÎºÏÎ´Î¹ÎºÎ±Ï‚ Î¼Îµ Ï€ÏÎ¹Î½, Î±Ï€Î»Î¬ Ï€ÏÎ¿ÏƒÎ¸Î­Ï„Î¿Ï…Î¼Îµ Î­Î»ÎµÎ³Ï‡Î¿ myLat)
            const { data, error } = await window.db.from('requests').select('*').neq('status', 'rejected').neq('status', 'completed').or(`status.eq.pending,and(status.eq.reserved,winner_pharmacy_id.eq.${currentUser.id})`).order('created_at', { ascending: false });
            
            const container = document.getElementById('requests-container');
            const { data: myResponses } = await window.db.from('responses').select('request_id').eq('pharmacist_id', currentUser.id);
            const myRespondedIds = new Set((myResponses || []).map(r => r.request_id));

            if(error) return;
            container.innerHTML = '';
            if(data && data.length > 0) { 
                data.forEach(req => container.innerHTML += createRequestCard(req, myRespondedIds.has(req.id)));
                // Timers setup...
            } else { 
                container.innerHTML = `<div class="text-center py-10 text-slate-400">ÎšÎ±Î½Î­Î½Î± Î±Î¯Ï„Î·Î¼Î±.</div>`; 
            }
        }

        function createRequestCard(req, hasResponded) {
            // (ÎŠÎ´Î¹Î± ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Î¼Îµ Ï€ÏÎ¹Î½ - Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î±Ï€ÏŒÏƒÏ„Î±ÏƒÎ·Ï‚ ÎºÎ±Î¹ ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ· Î»Î¯ÏƒÏ„Î±Ï‚ Î¼Îµ checkboxes)
            const realDist = (myLat && req.lat) ? getDistanceFromLatLonInKm(myLat, myLon, req.lat, req.lon) + ' Ï‡Î»Î¼' : '...';
            const timeAgo = new Date(req.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let items = [];
            if(req.items && Array.isArray(req.items)) items = req.items;
            else if(req.medicine_name) items = [{name: req.medicine_name, quantity: req.quantity || 1}]; 

            let itemsListHTML = '';
            // Input for partial quantity
            if(!hasResponded && req.status === 'pending') {
                itemsListHTML = `<div class="bg-slate-50 rounded-xl p-3 mb-3 border border-slate-200">
                    <p class="text-[10px] uppercase font-bold text-slate-400 mb-2">Î”Î¹Î±Î¸ÎµÏƒÎ¹Î¼Î¿Ï„Î·Ï„Î±:</p>
                    ${items.map((item, idx) => `
                        <div class="flex items-center gap-2 mb-2 bg-white p-2 rounded-lg border border-slate-100 shadow-sm">
                            <input type="checkbox" id="check-${req.id}-${idx}" value="${item.name}" checked class="w-5 h-5 text-secondary rounded focus:ring-secondary cursor-pointer" onchange="toggleQtyInput('${req.id}-${idx}')">
                            <div class="flex-1 flex flex-col">
                                <span class="font-bold text-sm text-slate-800">${item.name}</span>
                                <span class="text-[10px] text-slate-400">Î–Î·Ï„Î¬ÎµÎ¹: ${item.quantity}</span>
                            </div>
                            <div class="flex items-center gap-1 bg-slate-50 rounded px-2">
                                <span class="text-[10px] font-bold text-slate-500">ÎˆÏ‡Ï‰:</span>
                                <input type="number" id="qty-${req.id}-${idx}" min="1" max="${item.quantity}" value="${item.quantity}" class="w-10 text-center text-sm font-bold bg-white border border-slate-200 rounded focus:border-secondary outline-none">
                            </div>
                        </div>
                    `).join('')}
                </div>`;
            } else {
                itemsListHTML = `<ul class="list-disc list-inside text-sm text-slate-600 mb-3 bg-slate-50 p-2 rounded">${items.map(i => `<li>${i.name} (x${i.quantity})</li>`).join('')}</ul>`;
            }

            // Buttons Logic
            let stateUI = '';
            if (req.status === 'reserved' && req.winner_pharmacy_id === currentUser.id) {
                stateUI = `<div class="mt-4 bg-green-50 border border-green-200 p-4 rounded-xl"><h4 class="font-bold text-green-800 flex items-center gap-2"><i class="ph ph-check-circle"></i> ÎšÏÎ¬Ï„Î·ÏƒÎ·!</h4><p class="text-xs text-green-700">Î ÎµÎ»Î¬Ï„Î·Ï‚ ÎºÎ±Î¸' Î¿Î´ÏŒÎ½.</p></div>`;
            } else if (hasResponded) {
                stateUI = `<div class="mt-4 bg-yellow-50 text-yellow-700 p-3 rounded-xl text-sm font-bold">ÎˆÏ‡ÎµÏ„Îµ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹. Î‘Î½Î±Î¼Î¿Î½Î®...</div>`;
            } else {
                stateUI = `<div class="grid grid-cols-2 gap-3 mt-4"><button onclick="sendResponseMulti('${req.id}', 'original')" class="col-span-1 bg-secondary hover:bg-teal-700 text-white py-3 rounded-xl font-bold text-sm shadow-md">âœ… Î¥Ï€Î¬ÏÏ‡Î¿Ï…Î½</button><button onclick="sendResponseMulti('${req.id}', 'generic')" class="col-span-1 bg-white border border-secondary text-secondary hover:bg-teal-50 py-3 rounded-xl font-bold text-sm">ğŸ’Š Î“ÎµÎ½ÏŒÏƒÎ·Î¼Î±</button><button onclick="dismissRequest('${req.id}')" class="col-span-2 text-xs text-slate-400">Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ·</button></div>`;
            }

            return `<div id="card-${req.id}" class="glass-panel p-5 rounded-2xl shadow-sm border-l-4 border-secondary mb-4 relative"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-500">${timeAgo}</span><span class="text-xs font-bold text-teal-600 flex items-center gap-1"><i class="ph ph-map-pin"></i> ${realDist}</span></div><h3 class="font-bold text-slate-800 mb-2">${req.customer_name}</h3>${itemsListHTML}${stateUI}</div>`;
        }

        // --- UTILS (Haversine, Toast, etc) ---
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) { if(!lat1 || !lat2) return "N/A"; const R = 6371; const dLat = deg2rad(lat2 - lat1); const dLon = deg2rad(lon2 - lon1); const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); return (R * c).toFixed(1); }
        function deg2rad(deg) { return deg * (Math.PI / 180); }
        function showToast(msg, type='info') { const c = document.getElementById('toast-container'); const el = document.createElement('div'); const bg = type === 'success' ? 'bg-green-500' : 'bg-slate-800'; el.className = `toast ${bg} text-white px-4 py-3 rounded-xl shadow-lg text-sm font-semibold`; el.innerHTML = msg; c.appendChild(el); setTimeout(() => el.remove(), 3000); }
        function toggleQtyInput(id) { const cb = document.getElementById(`check-${id}`); const inp = document.getElementById(`qty-${id}`); inp.disabled = !cb.checked; if(!cb.checked) inp.classList.add('opacity-50'); else inp.classList.remove('opacity-50'); }
        
        async function sendResponseMulti(requestId, type) {
            // (ÎŠÎ´Î¹Î¿Ï‚ ÎºÏÎ´Î¹ÎºÎ±Ï‚ Î¼Îµ Ï€ÏÎ¹Î½ Î³Î¹Î± Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·Ï‚ Î¼Îµ Ï€Î¿ÏƒÏŒÏ„Î·Ï„ÎµÏ‚)
            const container = document.getElementById(`card-${requestId}`);
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            if(checkboxes.length === 0) return showToast('Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î­Î½Î±!', 'error');
            const foundItems = Array.from(checkboxes).map(cb => { const indexStr = cb.id.split('-').pop(); const qtyInput = container.querySelector(`#qty-${requestId}-${indexStr}`); return { name: cb.value, quantity: qtyInput ? parseInt(qtyInput.value) : 1 }; });
            const message = `Î’ÏÎ­Î¸Î·ÎºÎ±Î½ ${foundItems.length} ÎµÎ¯Î´Î·.`;
            const { error } = await window.db.from('responses').insert({ request_id: requestId, pharmacist_id: currentUser.id, response_type: type, message: message, distance: '0.0', found_items: foundItems });
            if (!error) { showToast('Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· ÎµÏƒÏ„Î¬Î»Î·!', 'success'); fetchRequests(); } else { showToast('Î£Ï†Î¬Î»Î¼Î±', 'error'); }
        }
        
        async function demoLogin() { const { data, error } = await window.db.auth.signInAnonymously(); if(error) showToast('Error', 'error'); else handleLoginSuccess(data.user); }
    </script>
</body>
</html>
