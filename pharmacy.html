<!DOCTYPE html>
<html lang="el" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MediRadar • Φαρμακείο</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: { brand: { 500:'#29a3a3', 600:'#208181', 700:'#196464' } },
          boxShadow: { soft:'0 16px 40px rgba(2,6,23,.12)' }
        }
      }
    }
  </script>

  <style>
    .app-bg{
      background:
        radial-gradient(1100px 600px at 0% -10%, rgba(132,197,244,.30), transparent 60%),
        radial-gradient(900px 540px at 110% 0%, rgba(199,166,244,.22), transparent 58%),
        radial-gradient(1000px 600px at 25% 120%, rgba(247,141,167,.18), transparent 62%),
        radial-gradient(800px 520px at 120% 120%, rgba(157,224,214,.20), transparent 60%),
        linear-gradient(180deg, #f6fbfb 0%, #f8fafc 40%, #fbfcfe 100%);
    }
    .dark .app-bg{
      background:
        radial-gradient(1100px 600px at 0% -10%, rgba(132,197,244,.16), transparent 60%),
        radial-gradient(900px 540px at 110% 0%, rgba(199,166,244,.14), transparent 58%),
        radial-gradient(1000px 600px at 25% 120%, rgba(247,141,167,.12), transparent 62%),
        radial-gradient(800px 520px at 120% 120%, rgba(157,224,214,.12), transparent 60%),
        linear-gradient(180deg, #0b1515, #0b1515 45%, #0b1515 100%);
    }
    .day-grid { display:grid; grid-template-columns: 120px 1fr 1fr 1fr; gap:.5rem; align-items:center; }
    .badge { display:inline-flex; align-items:center; gap:6px; padding:.25rem .5rem; border-radius:999px; font-size:.75rem; }
  </style>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#29a3a3" />
</head>
<body class="min-h-full app-bg text-slate-900 dark:text-slate-200 font-sans">

  <!-- Top bar -->
  <div class="sticky top-0 z-40 px-4 pt-3">
    <div class="max-w-5xl mx-auto flex items-center justify-between rounded-2xl bg-white/80 dark:bg-slate-900/70 backdrop-blur border border-slate-200 dark:border-slate-800 px-3 py-2">
      <div class="flex items-center gap-2">
        <a href="/index.html" class="px-3 py-1.5 rounded-lg border text-sm hover:bg-slate-50 dark:hover:bg-slate-800">← Αρχική</a>
        <div class="font-semibold">Πίνακας Φαρμακείου</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="theme-toggle" class="px-2 py-1.5 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800">🌓</button>
      </div>
    </div>
  </div>

  <main class="max-w-5xl mx-auto px-4 py-5">
    <!-- Pharmacy selector -->
    <section class="rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <div>
          <div class="text-sm text-slate-500">Ενεργό φαρμακείο</div>
          <div id="active-pharmacy" class="text-lg font-bold">—</div>
        </div>
        <div class="flex gap-2">
          <button id="btn-choose" class="px-3 py-2 rounded-xl border hover:bg-slate-50 dark:hover:bg-slate-800">Επιλογή</button>
          <button id="btn-new" class="px-3 py-2 rounded-xl bg-brand-600 text-white hover:bg-brand-700">Νέο φαρμακείο</button>
        </div>
      </div>
      <div id="pharmacy-extra" class="mt-3 text-sm text-slate-600 dark:text-slate-400"></div>
    </section>

    <!-- Hours editor -->
    <section class="mt-5 rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
      <div class="flex items-center justify-between">
        <h2 class="text-base font-semibold">Ωράριο λειτουργίας</h2>
        <button id="btn-save-hours" class="px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Αποθήκευση</button>
      </div>
      <p class="text-xs text-slate-500 mt-1">Συμπλήρωσε ένα ωράριο ανά ημέρα ή επίλεξε «Κλειστό».</p>

      <div id="hours-grid" class="mt-3 space-y-2">
        <!-- rows injected by JS -->
      </div>
    </section>

    <!-- Requests list -->
    <section class="mt-5 rounded-2xl bg-white/90 dark:bg-slate-900/60 backdrop-blur border border-slate-200 dark:border-slate-800 p-4 shadow-soft">
      <div class="flex items-center justify-between">
        <h2 class="text-base font-semibold">Αιτήματα πελατών</h2>
        <div class="flex items-center gap-2">
          <button id="btn-refresh" class="px-3 py-2 rounded-xl border hover:bg-slate-50 dark:hover:bg-slate-800">Ανανέωση</button>
        </div>
      </div>
      <div id="req-list" class="mt-3 grid gap-3"></div>
      <div id="req-empty" class="mt-3 text-sm text-slate-600 hidden">Δεν υπάρχουν ανοιχτά αιτήματα.</div>
    </section>
  </main>

  <!-- ENV -->
  <script src="/env.js"></script>
  <script>
    window.ENV = window.ENV || {
      SUPABASE_URL: 'https://YOUR-PROJECT.ref.supabase.co',
      SUPABASE_ANON_KEY: 'YOUR_PUBLIC_ANON_KEY'
    };
  </script>

  <!-- Supabase -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.ENV || {};
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabase = supabase; // για debug στην κονσόλα
  </script>

  <!-- App JS -->
  <script>
    /* ===== Theme ===== */
    const htmlEl = document.documentElement;
    document.getElementById('theme-toggle').onclick = ()=>{
      const dark = !htmlEl.classList.contains('dark');
      htmlEl.classList.toggle('dark', dark);
      localStorage.setItem('mediradar-theme', dark?'dark':'light');
    };
    (function initTheme(){
      const saved = localStorage.getItem('mediradar-theme');
      htmlEl.classList.toggle('dark', saved ? saved==='dark' : matchMedia('(prefers-color-scheme: dark)').matches);
    })();

    /* ===== Helpers ===== */
    const sb = ()=> window.supabase;
    const PH_KEY = 'mr:pharmacy';
    let activePharmacy = null;
    const dayNames = ['Κυριακή','Δευτέρα','Τρίτη','Τετάρτη','Πέμπτη','Παρασκευή','Σάββατο'];

    const activePhEl = document.getElementById('active-pharmacy');
    const phExtraEl  = document.getElementById('pharmacy-extra');
    const hoursGrid  = document.getElementById('hours-grid');
    const reqList    = document.getElementById('req-list');
    const reqEmpty   = document.getElementById('req-empty');

    function toastOk(msg){ 
      const d = document.createElement('div');
      d.className='fixed bottom-4 left-1/2 -translate-x-1/2 z-50 bg-emerald-600 text-white px-4 py-2 rounded-xl shadow-soft';
      d.textContent = msg; document.body.appendChild(d);
      setTimeout(()=>d.remove(), 1700);
    }
    function toastErr(msg){
      const d = document.createElement('div');
      d.className='fixed bottom-4 left-1/2 -translate-x-1/2 z-50 bg-rose-600 text-white px-4 py-2 rounded-xl shadow-soft';
      d.textContent = msg; document.body.appendChild(d);
      setTimeout(()=>d.remove(), 2200);
    }

    /* ===== Pharmacy select/create ===== */
    document.getElementById('btn-choose').onclick = async ()=>{
      try{
        const { data, error } = await sb().from('pharmacies').select('id,name,address,phone').order('name');
        if(error) throw error;
        if(!data || !data.length){ alert('Δεν υπάρχουν φαρμακεία. Δημιούργησε ένα.'); return; }
        const names = data.map((p,i)=> `${i+1}. ${p.name} — ${p.address||'—'}`).join('\n');
        const pick = prompt(`Επίλεξε αριθμό:\n${names}`);
        const idx = parseInt(pick||'',10)-1;
        if(isNaN(idx) || !data[idx]) return;
        setActivePharmacy(data[idx]);
      }catch(err){ console.error(err); toastErr('Σφάλμα φόρτωσης φαρμακείων'); }
    };

    document.getElementById('btn-new').onclick = async ()=>{
      const name = prompt('Όνομα φαρμακείου;');
      if(!name) return;
      const address = prompt('Διεύθυνση; (προαιρετικό)') || null;
      const phone   = prompt('Τηλέφωνο; (προαιρετικό)') || null;
      try{
        const { data, error } = await sb().from('pharmacies').insert({ name, address, phone }).select('id,name,address,phone').single();
        if(error) throw error;
        setActivePharmacy(data);
        toastOk('Δημιουργήθηκε');
      }catch(err){ console.error(err); toastErr('Σφάλμα δημιουργίας'); }
    };

    function setActivePharmacy(ph){
      activePharmacy = ph;
      activePhEl.textContent = ph?.name || '—';
      phExtraEl.textContent  = ph?.address ? `${ph.address}${ph.phone? ' • '+ph.phone: ''}` : (ph?.phone||'');
      localStorage.setItem(PH_KEY, JSON.stringify(ph));
      loadHours();
      loadRequests();
      attachRealtime();
    }

    (function restorePharmacy(){
      try{
        const saved = JSON.parse(localStorage.getItem(PH_KEY)||'null');
        if(saved?.id){ setActivePharmacy(saved); }
      }catch{}
    })();

    /* ===== Hours editor ===== */
    function rowTpl(idx, val){
      const closed = !!(val && val.closed);
      const o = (val && val.o) || '';
      const c = (val && val.c) || '';
      return `
        <div class="day-grid">
          <div class="font-medium">${dayNames[idx]}</div>
          <label class="inline-flex items-center gap-2"><input type="checkbox" class="day-closed accent-brand-600" ${closed?'checked':''}> Κλειστό</label>
          <input type="time" class="day-open px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800" value="${o}" ${closed?'disabled':''}>
          <input type="time" class="day-close px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800" value="${c}" ${closed?'disabled':''}>
        </div>`;
    }

    async function loadHours(){
      hoursGrid.innerHTML = '';
      let hours = null;
      if(activePharmacy?.id){
        const { data } = await sb().from('pharmacies').select('hours_json').eq('id', activePharmacy.id).single();
        hours = data?.hours_json || null;
      }
      for(let i=0;i<7;i++){
        hoursGrid.insertAdjacentHTML('beforeend', rowTpl(i, hours?.[i] || null));
      }
      // enable/disable on toggle
      [...hoursGrid.querySelectorAll('.day-grid')].forEach(row=>{
        const cb = row.querySelector('.day-closed');
        const oi = row.querySelector('.day-open');
        const ci = row.querySelector('.day-close');
        cb.addEventListener('change', ()=>{
          oi.disabled = cb.checked; ci.disabled = cb.checked;
        });
      });
    }

    document.getElementById('btn-save-hours').onclick = async ()=>{
      if(!activePharmacy?.id){ alert('Πρώτα επίλεξε φαρμακείο.'); return; }
      const rows = [...hoursGrid.querySelectorAll('.day-grid')];
      const out = {};
      rows.forEach((row, i)=>{
        const closed = row.querySelector('.day-closed').checked;
        const o = row.querySelector('.day-open').value;
        const c = row.querySelector('.day-close').value;
        out[i] = closed ? { closed:true } : ((o&&c)? { o, c } : null);
      });
      try{
        await sb().from('pharmacies').update({ hours_json: out }).eq('id', activePharmacy.id);
        toastOk('Αποθηκεύτηκε το ωράριο');
      }catch(err){ console.error(err); toastErr('Σφάλμα αποθήκευσης ωραρίου'); }
    };

    /* ===== Requests ===== */
    async function loadRequests(){
      reqList.innerHTML = '';
      reqEmpty.classList.add('hidden');
      try{
        const { data, error } = await sb()
          .from('requests')
          .select('id,created_at,med_name,active_substance,med_type,quantity,allow_generic,city,status')
          .eq('status','pending')
          .order('created_at',{ ascending:false })
          .limit(50);
        if(error) throw error;

        if(!data || !data.length){
          reqEmpty.classList.remove('hidden');
          return;
        }
        data.forEach(r=> renderRequestCard(r));
      }catch(err){ console.error(err); toastErr('Σφάλμα φόρτωσης αιτημάτων'); }
    }

    function renderRequestCard(r){
      const el = document.createElement('div');
      el.className = 'rounded-xl border border-slate-200 dark:border-slate-800 bg-white/90 dark:bg-slate-900/60 p-4';
      const when = new Date(r.created_at).toLocaleString();
      el.innerHTML = `
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <div>
            <div class="font-semibold">${r.med_name}</div>
            <div class="text-xs text-slate-600 dark:text-slate-400">${r.active_substance||'—'} • ${r.med_type||'—'} • x${r.quantity}</div>
            <div class="text-xs mt-1">${r.city||'—'} • <span class="opacity-70">${when}</span></div>
            ${r.allow_generic ? `<div class="mt-1"><span class="badge bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-200">🧬 Επιτρέπεται γενόσημο</span></div>`:''}
          </div>
          <div class="flex gap-2 shrink-0">
            <button class="btn-av px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Διαθέσιμο</button>
            <button class="btn-gen px-3 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700">Γενόσημο</button>
            <button class="btn-no px-3 py-2 rounded-xl border hover:bg-slate-50 dark:hover:bg-slate-800">Μη διαθέσιμο</button>
          </div>
        </div>
      `;
      // attach handlers
      el.querySelector('.btn-av').onclick  = ()=> sendResponse(r, { available:true, is_generic:false });
      el.querySelector('.btn-gen').onclick = ()=> sendResponse(r, { available:true, is_generic:true });
      el.querySelector('.btn-no').onclick  = ()=> sendResponse(r, { available:false, is_generic:false });
      reqList.appendChild(el);
    }

    async function sendResponse(reqRow, opts){
      if(!activePharmacy?.id){ alert('Πρώτα επίλεξε φαρμακείο.'); return; }
      try{
        // insert response
        const { error: insErr } = await sb().from('responses').insert({
          request_id: reqRow.id,
          pharmacy_id: activePharmacy.id,
          available: !!opts.available,
          is_generic: !!opts.is_generic
        });
        if(insErr) throw insErr;

        // αν είναι διαθέσιμο/γενόσημο → ενημέρωσε request για να ξεκολλήσει ο πελάτης
        if(opts.available){
          await sb().from('requests').update({ status:'has_responses' }).eq('id', reqRow.id);
        }

        toastOk('Καταχωρήθηκε η απάντηση');
        // ανανέωση λίστας
        loadRequests();
      }catch(err){ console.error(err); toastErr('Σφάλμα καταχώρησης απάντησης'); }
    }

    /* ===== Realtime ===== */
    let rtChannel = null;
    function attachRealtime(){
      if(rtChannel){ sb().removeChannel(rtChannel); rtChannel=null; }
      // άκου για νέα/updates requests ώστε να ανανεώνεται η λίστα
      rtChannel = sb().channel('pharmacy-requests')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'requests' }, (payload)=>{
          // απλή στρατηγική: σε κάθε change, ανανέωσε (debounce θα ήταν extra)
          loadRequests();
        })
        .subscribe((status)=>{ /* console.log('RT status', status); */ });
    }

    document.getElementById('btn-refresh').onclick = ()=> loadRequests();

    /* ===== Init ===== */
    loadHours(); // χωρίς ενεργό φαρμακείο θα δείξει κενό πλέγμα
    loadRequests();
    attachRealtime();
  </script>
</body>
</html>
