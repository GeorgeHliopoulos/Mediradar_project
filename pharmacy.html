<!DOCTYPE html>
<html lang="el" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediRadar Pro - Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    
    <script>
        const SB_URL = "https://qzerrisyowkfkmcyxmav.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZXJyaXN5b3drZmttY3l4bWF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTcxODQsImV4cCI6MjA3NTU5MzE4NH0.alkvHkOQPBTwY3daUcKAEsf4nt0kizuU3rYI2c2InPk";
        
        tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, colors: { primary: '#0f172a', secondary: '#0d9488' }, animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' } } } }
    </script>
    <style>.glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); } html.dark .glass-panel { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.05); } .toast { animation: slideIn 0.3s ease-out forwards; } @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }</style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 min-h-screen flex flex-col">

    <nav class="bg-white dark:bg-slate-800 shadow-sm border-b border-slate-200 dark:border-slate-700 p-4 sticky top-0 z-30">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3"><div class="w-10 h-10 bg-secondary rounded-xl flex items-center justify-center text-white shadow-lg"><i class="ph ph-first-aid-kit text-2xl"></i></div><div><h1 class="font-bold text-lg leading-tight">MediRadar <span class="text-secondary">Pro</span></h1><p class="text-xs text-slate-500 dark:text-slate-400">ÎšÎ­Î½Ï„ÏÎ¿ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚</p></div></div>
            <div class="flex gap-2 items-center">
                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"><i class="ph ph-moon-stars text-xl"></i></button>
                <div id="auth-section"></div>
            </div>
        </div>
    </nav>

    <div id="login-overlay" class="fixed inset-0 z-50 bg-slate-900/90 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border border-slate-700">
            <div class="w-20 h-20 bg-secondary/20 rounded-full flex items-center justify-center mx-auto mb-6 text-secondary"><i class="ph ph-lock-key text-4xl"></i></div>
            <h2 class="text-2xl font-bold mb-2 text-slate-900 dark:text-white">Î£ÏÎ½Î´ÎµÏƒÎ· Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…</h2>
            <button onclick="demoLogin()" class="w-full mt-4 bg-secondary hover:bg-teal-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2"><i class="ph ph-sign-in text-lg"></i> Î•Î¯ÏƒÎ¿Î´Î¿Ï‚ (Demo)</button>
        </div>
    </div>

    <main class="max-w-6xl mx-auto p-4 w-full grid grid-cols-1 lg:grid-cols-4 gap-6 flex-grow">
        <div class="lg:col-span-1 space-y-6">
            <div class="glass-panel p-5 rounded-2xl shadow-sm"><h3 class="font-bold text-xs uppercase text-slate-500 mb-4">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</h3><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" checked class="sr-only peer"><div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-300 dark:peer-focus:ring-teal-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-secondary"></div><span class="ml-3 text-sm font-medium text-slate-900 dark:text-slate-300">Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ Î¤ÏÏÎ±</span></label></div>
        </div>
        
        <div class="lg:col-span-3">
            <div class="flex justify-between items-end mb-4"><h2 class="text-xl font-bold flex items-center gap-2"><i class="ph ph-bell-ringing text-secondary animate-pulse-slow"></i> Î•Î¹ÏƒÎµÏÏ‡ÏŒÎ¼ÎµÎ½Î± Î‘Î¹Ï„Î®Î¼Î±Ï„Î±</h2><button onclick="fetchRequests()" class="text-sm text-secondary font-semibold hover:underline"><i class="ph ph-arrows-clockwise"></i> Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</button></div>
            <div id="loading-spinner" class="hidden text-center py-10"><i class="ph ph-spinner animate-spin text-3xl text-secondary"></i><p class="text-sm text-slate-500 mt-2">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</p></div>
            <div id="requests-container" class="space-y-4"></div>
        </div>
    </main>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-2"></div>

    <script>
        let currentUser = null;
        let timers = {}; // Store intervals for countdowns

        // Initialize Supabase
        window.db = window.supabase.createClient(SB_URL, SB_KEY);

        window.onload = async function() {
            const { data: { session } } = await window.db.auth.getSession();
            if (session) { handleLoginSuccess(session.user); } else { document.getElementById('login-overlay').classList.remove('hidden'); }
        };

        function handleLoginSuccess(user) {
            currentUser = user;
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('auth-section').innerHTML = `<span class="text-xs font-medium mr-2 hidden sm:inline">${user.email}</span><button onclick="handleLogout()" class="text-xs bg-slate-200 dark:bg-slate-700 px-3 py-1 rounded-lg hover:bg-red-500 hover:text-white transition-colors">ÎˆÎ¾Î¿Î´Î¿Ï‚</button>`;
            fetchRequests();
            subscribeToRequests();
        }

        async function demoLogin() {
            const { data, error } = await window.db.auth.signInAnonymously();
            if (error) { showToast('Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚', 'error'); } 
            else { handleLoginSuccess(data.user); }
        }
        async function handleLogout() { await window.db.auth.signOut(); window.location.reload(); }

        // --- FETCH REQUESTS ---
        async function fetchRequests() {
            document.getElementById('loading-spinner').classList.remove('hidden');
            const container = document.getElementById('requests-container');
            
            // Fetch requests that are Pending OR Reserved by ME
            const { data, error } = await window.db.from('requests').select('*')
                .or(`status.eq.pending,and(status.eq.reserved,winner_pharmacy_id.eq.${currentUser.id})`)
                .order('created_at', { ascending: false });

            // Fetch my responses to know which ones I've already replied to
            const { data: myResponses } = await window.db.from('responses').select('request_id').eq('pharmacist_id', currentUser.id);
            const myRespondedIds = new Set((myResponses || []).map(r => r.request_id));

            document.getElementById('loading-spinner').classList.add('hidden');
            if(error) return; 
            
            container.innerHTML = '';
            if(data && data.length > 0) { 
                data.forEach(req => container.innerHTML += createRequestCard(req, myRespondedIds.has(req.id))); 
                // Start timers for any reserved requests
                data.forEach(req => {
                    if(req.status === 'reserved' && req.winner_pharmacy_id === currentUser.id) {
                        startCountdown(req.id, req.updated_at); // Use updated_at as the "Acceptance Time"
                    }
                });
            } else { 
                container.innerHTML = `<div class="text-center py-16 bg-white/50 dark:bg-slate-800/50 rounded-3xl border-2 border-dashed border-slate-300 dark:border-slate-700"><p class="text-slate-500">ÎšÎ±Î½Î­Î½Î± ÎµÎ½ÎµÏÎ³ÏŒ Î±Î¯Ï„Î·Î¼Î±.</p></div>`; 
            }
        }

        function createRequestCard(req, hasResponded) {
            const timeAgo = new Date(req.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            let stateUI = '';
            let borderClass = 'border-l-secondary';

            // 1. STATE: RESERVED (Accepted by user)
            if (req.status === 'reserved' && req.winner_pharmacy_id === currentUser.id) {
                borderClass = 'border-l-green-500 ring-1 ring-green-500/20';
                const verifyCode = req.id.substring(0, 6); // Simple verification code logic
                
                stateUI = `
                    <div class="mt-4 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 p-4 rounded-xl animate-[fadeIn_0.5s]">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-bold text-green-800 dark:text-green-300 flex items-center gap-2"><i class="ph ph-check-circle text-xl"></i> ÎŸ Î ÎµÎ»Î¬Ï„Î·Ï‚ ÎˆÏÏ‡ÎµÏ„Î±Î¹!</h4>
                                <p class="text-xs text-green-700 dark:text-green-400 mt-1">Î‘Ï€Î¿Î¼Î­Î½Î¿Ï…Î½: <span id="timer-${req.id}" class="font-mono font-bold text-lg">60:00</span></p>
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] uppercase text-slate-400 font-bold">ÎšÏ‰Î´Î¹ÎºÎ¿Ï‚</span>
                                <div class="text-2xl font-mono font-bold text-slate-800 dark:text-white tracking-widest">${verifyCode}</div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-slate-800 p-3 rounded-xl border border-green-100 dark:border-green-800/50 flex gap-2">
                            <input type="text" id="verify-input-${req.id}" placeholder="Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® ÎšÏ‰Î´Î¹ÎºÎ¿Ï" class="flex-1 bg-transparent outline-none text-center font-bold tracking-widest uppercase">
                            <button onclick="verifyOrder('${req.id}', '${verifyCode}')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-md">Î•Ï€Î±Î»Î®Î¸ÎµÏ…ÏƒÎ·</button>
                        </div>
                    </div>
                `;
            } 
            // 2. STATE: WAITING (Pharmacist replied, user hasn't accepted yet)
            else if (hasResponded) {
                borderClass = 'border-l-yellow-400';
                stateUI = `
                    <div class="mt-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 p-3 rounded-xl flex items-center justify-between">
                        <div class="flex items-center gap-2 text-yellow-700 dark:text-yellow-400 font-bold text-sm">
                            <i class="ph ph-hourglass-medium animate-spin"></i> Î‘Î½Î±Î¼Î¿Î½Î® Ï€ÎµÎ»Î¬Ï„Î·...
                        </div>
                        <span class="text-xs text-yellow-600 bg-yellow-100 dark:bg-yellow-900 px-2 py-1 rounded">Î‘Ï€Î±Î½Ï„Î®ÏƒÎ±Ï„Îµ: Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿</span>
                    </div>
                `;
            } 
            // 3. STATE: NEW REQUEST
            else {
                stateUI = `
                    <div class="grid grid-cols-2 gap-3 mt-4">
                        <button onclick="sendResponse('${req.id}', 'original')" class="col-span-1 bg-secondary hover:bg-teal-700 text-white py-3 rounded-xl font-bold text-sm shadow-md transition-transform active:scale-95">âœ… Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ (Î ÏÏ‰Ï„ÏŒÏ„Ï…Ï€Î¿)</button>
                        <button onclick="sendResponse('${req.id}', 'generic')" class="col-span-1 bg-white dark:bg-slate-700 border border-secondary text-secondary hover:bg-teal-50 dark:hover:bg-slate-600 py-3 rounded-xl font-bold text-sm transition-transform active:scale-95">ğŸ’Š Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ (Î“ÎµÎ½ÏŒÏƒÎ·Î¼Î¿)</button>
                        <button onclick="dismissRequest('${req.id}')" class="col-span-2 text-xs text-slate-400 hover:text-slate-600 py-2">Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ·</button>
                    </div>
                `;
            }

            return `
                <div id="card-${req.id}" class="glass-panel p-5 rounded-2xl shadow-sm hover:shadow-md transition-all border-l-4 ${borderClass} relative mb-4">
                    <div class="flex justify-between items-start mb-2">
                        <span class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1"><i class="ph ph-clock"></i> ${timeAgo}</span>
                        <span class="text-xs font-bold text-slate-500 flex items-center gap-1"><i class="ph ph-map-pin"></i> ${req.location || 'Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±'}</span>
                    </div>
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-1">${req.medicine_name} <span class="text-lg font-normal text-slate-500">x${req.quantity}</span></h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-2">${req.customer_name || 'Î ÎµÎ»Î¬Ï„Î·Ï‚'}</p>
                    ${req.notes ? `<div class="bg-slate-50 dark:bg-slate-800 p-2 rounded text-xs italic border border-slate-100 dark:border-slate-700">"${req.notes}"</div>` : ''}
                    ${stateUI}
                </div>
            `;
        }

        // --- ACTIONS ---

        async function sendResponse(requestId, type) {
            // Optimistic UI update
            const card = document.getElementById(`card-${requestId}`);
            const buttons = card.querySelector('.grid');
            if(buttons) buttons.innerHTML = '<div class="col-span-2 text-center text-sm text-slate-500"><i class="ph ph-spinner animate-spin"></i> Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®...</div>';

            const { error } = await window.db.from('responses').insert({ 
                request_id: requestId, 
                pharmacist_id: currentUser.id, 
                response_type: type, 
                message: type === 'original' ? 'Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ (Î ÏÏ‰Ï„ÏŒÏ„Ï…Ï€Î¿)' : 'Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ (Î“ÎµÎ½ÏŒÏƒÎ·Î¼Î¿)',
                price: '0.00' 
            });

            if (!error) { 
                showToast('Î— Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· ÏƒÏ„Î¬Î»Î¸Î·ÎºÎµ!', 'success'); 
                fetchRequests(); // Refresh to show "Waiting" state
            } else { 
                showToast('Î£Ï†Î¬Î»Î¼Î±: ' + error.message, 'error');
                fetchRequests(); // Reset on error
            }
        }

        function verifyOrder(requestId, correctCode) {
            const input = document.getElementById(`verify-input-${requestId}`);
            if (input.value.trim() === correctCode) {
                completeOrder(requestId);
            } else {
                showToast('Î›Î¬Î¸Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚!', 'error');
                input.classList.add('ring-2', 'ring-red-500');
                setTimeout(() => input.classList.remove('ring-2', 'ring-red-500'), 1000);
            }
        }

        async function completeOrder(requestId) {
            const { error } = await window.db.from('requests').update({ status: 'completed' }).eq('id', requestId);
            if(!error) {
                document.getElementById(`card-${requestId}`).remove();
                showToast('Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ!', 'success');
                // Play success sound
                try { new Audio('https://cdn.freesound.org/previews/171/171671_2437358-lq.mp3').play().catch(e=>{}); } catch(e){}
            }
        }

        function dismissRequest(id) { document.getElementById(`card-${id}`).remove(); }

        // --- TIMER LOGIC ---
        function startCountdown(reqId, startTimeStr) {
            if(timers[reqId]) clearInterval(timers[reqId]);
            
            const startTime = new Date(startTimeStr).getTime();
            const duration = 60 * 60 * 1000; // 60 minutes
            const endTime = startTime + duration;

            function update() {
                const now = new Date().getTime();
                const distance = endTime - now;

                if (distance < 0) {
                    clearInterval(timers[reqId]);
                    const el = document.getElementById(`timer-${reqId}`);
                    if(el) { el.innerHTML = "Î•Î›Î—ÎÎ•"; el.classList.add('text-red-600'); }
                    return;
                }

                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                const el = document.getElementById(`timer-${reqId}`);
                if(el) el.innerHTML = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            }

            update();
            timers[reqId] = setInterval(update, 1000);
        }

        // --- REALTIME SUBSCRIPTION (Robust) ---
        function subscribeToRequests() {
            // Listen for changes in the 'requests' table
            window.db.channel('pharmacy-global')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'requests' }, payload => {
                // Refresh if a new request comes OR if a request I reserved was updated (maybe canceled?)
                fetchRequests();
                if(payload.eventType === 'INSERT') showToast('ğŸ”” ÎÎ­Î¿ Î±Î¯Ï„Î·Î¼Î±!', 'info');
                if(payload.eventType === 'UPDATE' && payload.new.status === 'reserved' && payload.new.winner_pharmacy_id === currentUser.id) {
                    showToast('âœ… ÎŸ Ï€ÎµÎ»Î¬Ï„Î·Ï‚ Î­ÎºÎ±Î½Îµ ÎºÏÎ¬Ï„Î·ÏƒÎ·!', 'success');
                    try { new Audio('https://cdn.freesound.org/previews/171/171671_2437358-lq.mp3').play().catch(e=>{}); } catch(e){}
                }
            })
            .subscribe((status) => {
                console.log("Realtime Status:", status);
            });
        }

        function showToast(msg, type='info') { const c = document.getElementById('toast-container'); const el = document.createElement('div'); const bg = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-slate-800'); el.className = `toast ${bg} text-white px-4 py-3 rounded-xl shadow-lg text-sm font-semibold`; el.innerHTML = msg; c.appendChild(el); setTimeout(() => el.remove(), 3000); }
        function toggleTheme() { document.documentElement.classList.toggle('dark'); }
    </script>
</body>
</html>
