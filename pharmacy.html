<!DOCTYPE html>
<html lang="el" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediRadar Pro - Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, colors: { primary: '#0f172a', secondary: '#0d9488' }, animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' } } } }
    </script>
    <style>.glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); } html.dark .glass-panel { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.05); } .toast { animation: slideIn 0.3s ease-out forwards; } @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }</style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 min-h-screen flex flex-col">

    <nav class="bg-white dark:bg-slate-800 shadow-sm border-b border-slate-200 dark:border-slate-700 p-4 sticky top-0 z-30">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3"><div class="w-10 h-10 bg-secondary rounded-xl flex items-center justify-center text-white shadow-lg"><i class="ph ph-first-aid-kit text-2xl"></i></div><div><h1 class="font-bold text-lg leading-tight">MediRadar <span class="text-secondary">Pro</span></h1><p class="text-xs text-slate-500 dark:text-slate-400">ÎšÎ­Î½Ï„ÏÎ¿ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚</p></div></div>
            <div class="flex gap-3 items-center">
                <button onclick="openScheduleModal()" class="text-xs font-bold bg-slate-100 dark:bg-slate-700 px-3 py-2 rounded-lg hover:bg-slate-200 transition flex items-center gap-1"><i class="ph ph-clock"></i> Î©ÏÎ¬ÏÎ¹Î¿</button>
                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"><i class="ph ph-moon-stars text-xl"></i></button>
                <div id="auth-section"></div>
            </div>
        </div>
    </nav>

    <div id="login-overlay" class="fixed inset-0 z-50 bg-slate-900/90 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border border-slate-700">
            <div class="w-20 h-20 bg-secondary/20 rounded-full flex items-center justify-center mx-auto mb-6 text-secondary"><i class="ph ph-lock-key text-4xl"></i></div>
            <h2 class="text-2xl font-bold mb-2 text-slate-900 dark:text-white">Î£ÏÎ½Î´ÎµÏƒÎ· Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…</h2>
            <p class="text-slate-500 mb-8 text-sm">Î£Ï…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ Î³Î¹Î± Î½Î± Î´ÎµÎ¯Ï„Îµ Î±Î¹Ï„Î®Î¼Î±Ï„Î±.</p>
            <form id="login-form" class="space-y-4 text-left"><div><label class="text-xs font-bold uppercase ml-1 text-slate-500">Email</label><input type="email" id="email" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-secondary outline-none" placeholder="pharmacy@example.com" required></div><div><label class="text-xs font-bold uppercase ml-1 text-slate-500">ÎšÏ‰Î´Î¹ÎºÏŒÏ‚</label><input type="password" id="password" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-secondary outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required></div><button type="submit" class="w-full bg-secondary hover:bg-teal-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚</button></form>
            <div class="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700"><button onclick="demoLogin()" class="w-full bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-200 font-semibold py-3 rounded-xl transition-all flex items-center justify-center gap-2"><i class="ph ph-flask text-lg"></i> Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Demo (Test)</button></div>
        </div>
    </div>

    <div id="schedule-modal" class="fixed inset-0 z-[60] bg-slate-900/95 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-2xl max-w-2xl w-full border border-slate-700 h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2"><i class="ph ph-clock text-secondary"></i> Î©ÏÎ¬ÏÎ¹Î¿ Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚</h2>
                    <p class="text-xs text-red-500 font-bold mt-1">âš ï¸ Î¥Ï€Î¿Ï‡ÏÎµÏ‰Ï„Î¹ÎºÏŒ Î³Î¹Î± Î½Î± Î»Î±Î¼Î²Î¬Î½ÎµÏ„Îµ Î±Î¹Ï„Î®Î¼Î±Ï„Î±.</p>
                </div>
                <button onclick="closeScheduleModal()" class="text-slate-400 hover:text-white"><i class="ph ph-x text-xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto pr-2 space-y-3" id="schedule-form">
                </div>

            <div class="mt-6 pt-4 border-t border-slate-200 dark:border-slate-700">
                <button onclick="saveSchedule()" class="w-full bg-secondary hover:bg-teal-700 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2">
                    <i class="ph ph-floppy-disk text-lg"></i> Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· & ÎˆÎ½Î±ÏÎ¾Î·
                </button>
            </div>
        </div>
    </div>

    <main class="max-w-6xl mx-auto p-4 w-full grid grid-cols-1 lg:grid-cols-4 gap-6 flex-grow">
        <div class="lg:col-span-1 space-y-6">
            <div class="glass-panel p-5 rounded-2xl shadow-sm"><h3 class="font-bold text-xs uppercase text-slate-500 mb-4">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</h3><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" checked class="sr-only peer"><div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-300 dark:peer-focus:ring-teal-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-secondary"></div><span class="ml-3 text-sm font-medium text-slate-900 dark:text-slate-300">Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ Î¤ÏÏÎ±</span></label></div>
        </div>
        <div class="lg:col-span-3">
            <div class="flex justify-between items-end mb-4"><h2 class="text-xl font-bold flex items-center gap-2"><i class="ph ph-bell-ringing text-secondary animate-pulse-slow"></i> Î•Î¹ÏƒÎµÏÏ‡ÏŒÎ¼ÎµÎ½Î± Î‘Î¹Ï„Î®Î¼Î±Ï„Î±</h2><button onclick="fetchRequests()" class="text-sm text-secondary font-semibold hover:underline"><i class="ph ph-arrows-clockwise"></i> Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</button></div>
            <div id="loading-spinner" class="hidden text-center py-10"><i class="ph ph-spinner animate-spin text-3xl text-secondary"></i><p class="text-sm text-slate-500 mt-2">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·...</p></div>
            <div id="requests-container" class="space-y-4"></div>
        </div>
    </main>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-2"></div>

    <script src="env.js"></script>
    <script src="supabase.js"></script>

    <script>
        let currentUser = null;
        let mySchedule = null; // Stores the loaded schedule
        const DAYS = ['Î”ÎµÏ…Ï„Î­ÏÎ±', 'Î¤ÏÎ¯Ï„Î·', 'Î¤ÎµÏ„Î¬ÏÏ„Î·', 'Î Î­Î¼Ï€Ï„Î·', 'Î Î±ÏÎ±ÏƒÎºÎµÏ…Î®', 'Î£Î¬Î²Î²Î±Ï„Î¿', 'ÎšÏ…ÏÎ¹Î±ÎºÎ®'];
        const DB_DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        window.onload = async function() {
            if(!window.db) return;
            const { data: { session } } = await window.db.auth.getSession();
            if (session) { handleLoginSuccess(session.user); } else { document.getElementById('login-overlay').classList.remove('hidden'); }
            
            // Init Schedule Form
            const formContainer = document.getElementById('schedule-form');
            DAYS.forEach((day, index) => {
                formContainer.innerHTML += `
                    <div class="flex items-center gap-4 p-3 bg-slate-50 dark:bg-slate-900 rounded-xl">
                        <div class="w-24 font-bold text-sm text-slate-700 dark:text-slate-300">${day}</div>
                        <input type="time" id="open-${index}" class="p-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm outline-none focus:border-secondary" value="08:00">
                        <span class="text-slate-400">-</span>
                        <input type="time" id="close-${index}" class="p-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm outline-none focus:border-secondary" value="21:00">
                        <label class="flex items-center gap-2 cursor-pointer ml-auto">
                            <input type="checkbox" id="active-${index}" class="accent-secondary w-4 h-4" checked>
                            <span class="text-xs text-slate-500">Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ</span>
                        </label>
                    </div>
                `;
            });
        };

        function handleLoginSuccess(user) {
            currentUser = user;
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('auth-section').innerHTML = `<span class="text-xs font-medium mr-2">${user.email}</span><button onclick="handleLogout()" class="text-xs bg-slate-200 dark:bg-slate-700 px-3 py-1 rounded-lg hover:bg-red-500 hover:text-white transition-colors">ÎˆÎ¾Î¿Î´Î¿Ï‚</button>`;
            
            fetchSchedule(); // Check if schedule exists
            fetchRequests();
            subscribeToRequests();
        }

        // --- SCHEDULE LOGIC ---
        async function fetchSchedule() {
            const { data, error } = await window.db.from('schedules').select('data').eq('pharmacist_id', currentUser.id).single();
            
            if (!data || error) {
                // No schedule found! Force open modal.
                document.getElementById('schedule-modal').classList.remove('hidden');
            } else {
                mySchedule = data.data;
                // Populate form just in case they want to edit
                // (Code skipped for brevity, assuming they set it once)
            }
        }

        async function saveSchedule() {
            const scheduleData = {};
            for(let i=0; i<7; i++) {
                scheduleData[DB_DAYS[i]] = {
                    open: document.getElementById(`open-${i}`).value,
                    close: document.getElementById(`close-${i}`).value,
                    isActive: document.getElementById(`active-${i}`).checked
                };
            }

            const { error } = await window.db.from('schedules').upsert({ 
                pharmacist_id: currentUser.id, 
                data: scheduleData 
            });

            if (error) {
                showToast("Î£Ï†Î¬Î»Î¼Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚: " + error.message, 'error');
            } else {
                mySchedule = scheduleData;
                document.getElementById('schedule-modal').classList.add('hidden');
                showToast("Î¤Î¿ Ï‰ÏÎ¬ÏÎ¹Î¿ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ!", 'success');
            }
        }

        function openScheduleModal() { document.getElementById('schedule-modal').classList.remove('hidden'); }
        function closeScheduleModal() { 
            if(!mySchedule) { alert("Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÎµÏ„Îµ Ï‰ÏÎ¬ÏÎ¹Î¿ Î³Î¹Î± Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÏ„Îµ!"); return; }
            document.getElementById('schedule-modal').classList.add('hidden'); 
        }

        // --- CHECK IF OPEN LOGIC ---
        function getClosingTimeToday() {
            if (!mySchedule) return null;
            const today = new Date().toLocaleDateString('en-US', { weekday: 'long' }); // e.g. "Monday"
            const todaySched = mySchedule[today];
            
            if (!todaySched || !todaySched.isActive) return null; // Closed today
            return todaySched.close; // "21:00"
        }

        function canAcceptOrder() {
            const closingTime = getClosingTimeToday();
            if (!closingTime) return { allowed: false, reason: "Î¤Î¿ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿ ÎµÎ¯Î½Î±Î¹ ÎºÎ»ÎµÎ¹ÏƒÏ„ÏŒ ÏƒÎ®Î¼ÎµÏÎ±!" };

            const now = new Date();
            const [closeH, closeM] = closingTime.split(':').map(Number);
            const closeDate = new Date();
            closeDate.setHours(closeH, closeM, 0);

            // Add 60 mins to NOW
            const arrivalTime = new Date(now.getTime() + 60 * 60000);

            if (arrivalTime > closeDate) {
                return { allowed: false, reason: `ÎšÎ»ÎµÎ¯Î½ÎµÏ„Îµ ÏƒÏ„Î¹Ï‚ ${closingTime}. ÎŸ Ï€ÎµÎ»Î¬Ï„Î·Ï‚ Î´ÎµÎ½ Ï€ÏÎ¿Î»Î±Î²Î±Î¯Î½ÎµÎ¹ (Î¸Î­Î»ÎµÎ¹ 60').` };
            }
            return { allowed: true, closingTime };
        }

        // --- RESPONSE LOGIC ---
        async function sendResponse(requestId, type) {
            // 1. SAFETY CHECK
            const check = canAcceptOrder();
            if (!check.allowed) {
                alert("â›” Î”Î•Î ÎœÎ ÎŸÎ¡Î•Î™Î¤Î• ÎÎ‘ Î‘Î Î‘ÎÎ¤Î—Î£Î•Î¤Î•:\n" + check.reason);
                return;
            }

            const btn = document.querySelector(`#card-${requestId} button`); if(btn) btn.innerText = '...';
            
            const { error } = await window.db.from('responses').insert({ 
                request_id: requestId, 
                pharmacist_id: currentUser.id, 
                response_type: type, 
                message: type === 'original' ? 'Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ (Î ÏÏ‰Ï„ÏŒÏ„Ï…Ï€Î¿)' : 'Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ (Î“ÎµÎ½ÏŒÏƒÎ·Î¼Î¿)', 
                price: '0.00',
                closing_time: check.closingTime // Send closing time to user
            });

            if (!error) { showToast('Î— Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· ÏƒÏ„Î¬Î»Î¸Î·ÎºÎµ!', 'success'); removeCard(requestId); } 
            else { showToast('Î£Ï†Î¬Î»Î¼Î±: ' + error.message, 'error'); }
        }

        // --- (Rest of the code remains same: fetchRequests, createRequestCard, etc) ---
        document.getElementById('login-form').addEventListener('submit', async (e) => { e.preventDefault(); const { data, error } = await window.db.auth.signInWithPassword({ email: document.getElementById('email').value, password: document.getElementById('password').value }); if (error) showToast('Î£Ï†Î¬Î»Î¼Î±: ' + error.message, 'error'); else handleLoginSuccess(data.user); });
        async function demoLogin() { const { data, error } = await window.db.auth.signInAnonymously(); if (error) { currentUser = { id: 'demo_pharmacist', email: 'demo@pharmacy.gr' }; handleLoginSuccess(currentUser); showToast('Demo Mode', 'success'); } else { handleLoginSuccess(data.user); } }
        async function handleLogout() { await window.db.auth.signOut(); window.location.reload(); }
        async function fetchRequests() {
            const spinner = document.getElementById('loading-spinner'); const container = document.getElementById('requests-container'); spinner.classList.remove('hidden');
            const { data, error } = await window.db.from('requests').select('*').eq('status', 'pending').order('created_at', { ascending: false });
            spinner.classList.add('hidden');
            if (error) { showToast('Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚', 'error'); return; }
            container.innerHTML = '';
            if(data && data.length > 0) { data.forEach(req => container.innerHTML += createRequestCard(req)); } else { container.innerHTML = `<div class="text-center py-16 bg-white/50 dark:bg-slate-800/50 rounded-3xl border-2 border-dashed border-slate-300 dark:border-slate-700"><p class="text-slate-500">ÎšÎ±Î½Î­Î½Î± Î½Î­Î¿ Î±Î¯Ï„Î·Î¼Î±.</p></div>`; }
        }
        function createRequestCard(req) {
            const timeAgo = new Date(req.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const typeBadge = req.med_type ? `<span class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-[10px] font-bold px-2 py-1 rounded uppercase">${req.med_type}</span>` : '';
            const mediaButton = req.media_url ? `<a href="${req.media_url}" target="_blank" class="text-blue-500 text-xs font-bold flex items-center gap-1 bg-blue-50 px-2 py-1 rounded"><i class="ph ph-image"></i> Î¦Ï‰Ï„ÏŒ</a>` : '';
            return `<div id="card-${req.id}" class="glass-panel p-5 rounded-2xl shadow-sm hover:shadow-md transition-all border-l-4 border-l-secondary relative group"><div class="flex justify-between items-start mb-3"><div class="flex flex-wrap items-center gap-2"><span class="bg-teal-100 text-teal-700 text-xs font-bold px-2 py-1 rounded-md flex items-center gap-1"><i class="ph ph-clock"></i> ${timeAgo}</span>${typeBadge}<span class="text-xs font-bold text-slate-500 flex items-center gap-1"><i class="ph ph-map-pin"></i> ${req.location || 'Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±'}</span></div></div><div class="flex justify-between items-start"><div><h3 class="text-lg font-bold text-slate-900 dark:text-white mb-1">${req.medicine_name} <span class="text-sm font-normal text-slate-500">x${req.quantity || 1}</span></h3><p class="text-sm text-slate-500 dark:text-slate-400 mb-2">${req.substance || ''}</p></div><div class="flex flex-col items-end gap-2">${mediaButton}</div></div>${req.notes ? `<div class="bg-slate-50 p-3 rounded-lg text-xs italic border mb-4">" ${req.notes} "</div>` : ''}<div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mt-4"><button onclick="sendResponse('${req.id}', 'original')" class="col-span-1 bg-secondary hover:bg-teal-700 text-white py-2.5 rounded-xl font-bold text-xs shadow-lg flex items-center justify-center gap-2"><i class="ph ph-check-circle text-lg"></i> Î ÏÏ‰Ï„ÏŒÏ„Ï…Ï€Î¿</button><button onclick="sendResponse('${req.id}', 'generic')" class="col-span-1 bg-white border border-secondary text-secondary hover:bg-teal-50 py-2.5 rounded-xl font-bold text-xs flex items-center justify-center gap-2"><i class="ph ph-pill text-lg"></i> Î“ÎµÎ½ÏŒÏƒÎ·Î¼Î¿</button><button onclick="dismissRequest('${req.id}')" class="col-span-2 sm:col-span-1 bg-slate-100 text-slate-500 hover:bg-slate-200 py-2.5 rounded-xl font-bold text-xs flex items-center justify-center gap-2"><i class="ph ph-x text-lg"></i> Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ·</button></div></div>`;
        }
        function dismissRequest(requestId) { removeCard(requestId); }
        function removeCard(id) { const card = document.getElementById(`card-${id}`); if (card) { card.style.opacity = '0'; setTimeout(() => card.remove(), 300); } }
        function subscribeToRequests() { window.db.channel('pharmacy-feed').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'requests' }, payload => { showToast('ğŸ”” ÎÎ­Î¿ Î±Î¯Ï„Î·Î¼Î±!', 'info'); const container = document.getElementById('requests-container'); const temp = document.createElement('div'); temp.innerHTML = createRequestCard(payload.new); container.prepend(temp.firstElementChild); }).subscribe(); }
        function showToast(msg, type='info') { const c = document.getElementById('toast-container'); const el = document.createElement('div'); const bg = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-slate-800'); el.className = `toast ${bg} text-white px-4 py-3 rounded-xl shadow-lg text-sm font-semibold`; el.innerHTML = msg; c.appendChild(el); setTimeout(() => el.remove(), 3000); }
        function toggleTheme() { document.documentElement.classList.toggle('dark'); }
    </script>
</body>
</html>
