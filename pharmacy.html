<!DOCTYPE html>
<html lang="el" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediRadar Pro - Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, colors: { primary: '#0f172a', secondary: '#0d9488' }, animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' } } } }
    </script>
    <style>.glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); } html.dark .glass-panel { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.05); } .toast { animation: slideIn 0.3s ease-out forwards; } @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }</style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 min-h-screen flex flex-col">

    <nav class="bg-white dark:bg-slate-800 shadow-sm border-b border-slate-200 dark:border-slate-700 p-4 sticky top-0 z-30">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3"><div class="w-10 h-10 bg-secondary rounded-xl flex items-center justify-center text-white shadow-lg"><i class="ph ph-first-aid-kit text-2xl"></i></div><div><h1 class="font-bold text-lg leading-tight">MediRadar <span class="text-secondary">Pro</span></h1><p class="text-xs text-slate-500 dark:text-slate-400">ÎšÎ­Î½Ï„ÏÎ¿ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚</p></div></div>
            <div class="flex gap-2 items-center">
                <!-- VERIFY BUTTON (MANUAL) -->
                <button onclick="openVerificationModal()" class="text-xs font-bold bg-secondary text-white px-3 py-2 rounded-lg hover:bg-teal-700 transition flex items-center gap-1 shadow-md shadow-teal-500/20">
                    <i class="ph ph-numpad text-lg"></i> <span class="hidden sm:inline">Î•Ï€Î±Î»Î®Î¸ÎµÏ…ÏƒÎ· ÎšÏ‰Î´Î¹ÎºÎ¿Ï</span>
                </button>
                
                <button onclick="openScheduleModal()" class="text-xs font-bold bg-slate-100 dark:bg-slate-700 px-3 py-2 rounded-lg hover:bg-slate-200 transition flex items-center gap-1"><i class="ph ph-calendar-check"></i> Î©ÏÎ¬ÏÎ¹Î¿</button>
                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"><i class="ph ph-moon-stars text-xl"></i></button>
                <div id="auth-section"></div>
            </div>
        </div>
    </nav>

    <div id="login-overlay" class="fixed inset-0 z-50 bg-slate-900/90 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border border-slate-700">
            <div class="w-20 h-20 bg-secondary/20 rounded-full flex items-center justify-center mx-auto mb-6 text-secondary"><i class="ph ph-lock-key text-4xl"></i></div>
            <h2 class="text-2xl font-bold mb-2 text-slate-900 dark:text-white">Î£ÏÎ½Î´ÎµÏƒÎ· Î¦Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿Ï…</h2>
            <p class="text-slate-500 mb-8 text-sm">Î£Ï…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ Î³Î¹Î± Î½Î± Î´ÎµÎ¯Ï„Îµ Î±Î¹Ï„Î®Î¼Î±Ï„Î±.</p>
            <form id="login-form" class="space-y-4 text-left"><div><label class="text-xs font-bold uppercase ml-1 text-slate-500">Email</label><input type="email" id="email" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-secondary outline-none" placeholder="pharmacy@example.com" required></div><div><label class="text-xs font-bold uppercase ml-1 text-slate-500">ÎšÏ‰Î´Î¹ÎºÏŒÏ‚</label><input type="password" id="password" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-secondary outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required></div><button type="submit" class="w-full bg-secondary hover:bg-teal-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚</button></form>
            <div class="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700"><button onclick="demoLogin()" class="w-full bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-200 font-semibold py-3 rounded-xl transition-all flex items-center justify-center gap-2"><i class="ph ph-flask text-lg"></i> Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Demo (Test)</button></div>
        </div>
    </div>

    <!-- SCHEDULE MODAL -->
    <div id="schedule-modal" class="fixed inset-0 z-[60] bg-slate-900/95 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-2xl max-w-3xl w-full border border-slate-700 h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <div><h2 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2"><i class="ph ph-calendar-check text-secondary"></i> Î•Î²Î´Î¿Î¼Î±Î´Î¹Î±Î¯Î¿ Î ÏÏŒÎ³ÏÎ±Î¼Î¼Î±</h2><p class="text-xs text-slate-500 mt-1">ÎŸÏÎ¯ÏƒÏ„Îµ Ï„Î¹Ï‚ ÏÏÎµÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚.</p></div>
                <button onclick="closeScheduleModal()" class="text-slate-400 hover:text-white"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto pr-2 space-y-2" id="schedule-form"></div>
            <div class="mt-6 pt-4 border-t border-slate-200 dark:border-slate-700">
                <button onclick="saveSchedule()" class="w-full bg-secondary hover:bg-teal-700 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2"><i class="ph ph-floppy-disk text-lg"></i> Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· & ÎˆÎ½Î±ÏÎ¾Î·</button>
            </div>
        </div>
    </div>

    <!-- MANUAL VERIFICATION MODAL -->
    <div id="verification-input-modal" class="fixed inset-0 z-[100] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-2xl max-w-sm w-full text-center border border-slate-600 animate-[fadeIn_0.3s_ease-out]">
            <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                <i class="ph ph-keyboard"></i>
            </div>
            <h3 class="text-xl font-bold mb-1 text-slate-800 dark:text-white">Î•Ï€Î±Î»Î®Î¸ÎµÏ…ÏƒÎ· ÎšÏ‰Î´Î¹ÎºÎ¿Ï</h3>
            <p class="text-sm text-slate-500 mb-6">Î Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³Î®ÏƒÏ„Îµ Ï„Î¿Î½ 6-ÏˆÎ®Ï†Î¹Î¿ ÎºÏ‰Î´Î¹ÎºÏŒ Ï€Î¿Ï… ÏƒÎ±Ï‚ Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ Î¿ Ï€ÎµÎ»Î¬Ï„Î·Ï‚.</p>
            
            <div class="mb-6">
                <input type="text" id="verify-code-input" placeholder="Ï€.Ï‡. a1b2c3" maxlength="8" 
                       class="w-full p-4 text-center text-2xl font-mono font-bold tracking-widest uppercase rounded-xl border-2 border-indigo-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 outline-none dark:bg-slate-900 dark:text-white dark:border-slate-600">
            </div>

            <button onclick="checkManualCode()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 transition-all">
                <i class="ph ph-check-bold text-lg"></i> ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚
            </button>
            <button onclick="closeVerificationModal()" class="mt-3 text-sm text-slate-500 hover:text-slate-800 dark:hover:text-slate-300 font-medium">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
        </div>
    </div>

    <!-- SUCCESS MODAL (AFTER CODE CHECK) -->
    <div id="verification-success-modal" class="fixed inset-0 z-[100] bg-slate-900/90 backdrop-blur-md flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-2xl max-w-sm w-full text-center border-2 border-green-500 animate-[fadeIn_0.3s_ease-out]">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl animate-bounce">
                <i class="ph ph-check-circle-fill"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-1">Î•Ï€Î¹Ï„Ï…Ï‡Î¯Î±!</h2>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± Î²ÏÎ­Î¸Î·ÎºÎµ.</p>
            
            <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4 text-left space-y-3 mb-6">
                <div><p class="text-xs text-slate-400 uppercase font-bold">Î ÎµÎ»Î±Ï„Î·Ï‚</p><p class="font-bold text-slate-800 dark:text-white text-lg" id="success-name">-</p></div>
                <div><p class="text-xs text-slate-400 uppercase font-bold">Î¦Î±ÏÎ¼Î±ÎºÎ¿</p><p class="font-bold text-secondary text-lg" id="success-med">-</p></div>
                <div><p class="text-xs text-slate-400 uppercase font-bold">Î Î¿ÏƒÎ¿Ï„Î·Ï„Î±</p><p class="font-mono font-bold text-slate-800 dark:text-white" id="success-qty">-</p></div>
            </div>

            <button id="success-confirm-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 transition-all">
                <i class="ph ph-hand-coins text-lg"></i> ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î Î±ÏÎ¬Î´Î¿ÏƒÎ·Ï‚
            </button>
            <button onclick="document.getElementById('verification-success-modal').classList.add('hidden')" class="mt-3 text-sm text-slate-400 hover:text-white">Î†ÎºÏ…ÏÎ¿</button>
        </div>
    </div>

    <main class="max-w-6xl mx-auto p-4 w-full grid grid-cols-1 lg:grid-cols-4 gap-6 flex-grow">
        <div class="lg:col-span-1 space-y-6">
            <div class="glass-panel p-5 rounded-2xl shadow-sm"><h3 class="font-bold text-xs uppercase text-slate-500 mb-4">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</h3><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" checked class="sr-only peer"><div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-300 dark:peer-focus:ring-teal-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-secondary"></div><span class="ml-3 text-sm font-medium text-slate-900 dark:text-slate-300">Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ Î¤ÏÏÎ±</span></label></div>
        </div>
        <div class="lg:col-span-3">
            <div class="flex justify-between items-end mb-4"><h2 class="text-xl font-bold flex items-center gap-2"><i class="ph ph-bell-ringing text-secondary animate-pulse-slow"></i> Î•Î¹ÏƒÎµÏÏ‡ÏŒÎ¼ÎµÎ½Î± Î‘Î¹Ï„Î®Î¼Î±Ï„Î±</h2><button onclick="fetchRequests()" class="text-sm text-secondary font-semibold hover:underline"><i class="ph ph-arrows-clockwise"></i> Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</button></div>
            <div id="loading-spinner" class="hidden text-center py-10"><i class="ph ph-spinner animate-spin text-3xl text-secondary"></i><p class="text-sm text-slate-500 mt-2">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·...</p></div>
            <div id="requests-container" class="space-y-4"></div>
        </div>
    </main>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-2"></div>

    <script src="env.js"></script>
    <script src="supabase.js"></script>

    <script>
        let currentUser = null;
        let mySchedule = null;
        let allActiveRequests = []; 

        const DAYS = ['Î”ÎµÏ…Ï„Î­ÏÎ±', 'Î¤ÏÎ¯Ï„Î·', 'Î¤ÎµÏ„Î¬ÏÏ„Î·', 'Î Î­Î¼Ï€Ï„Î·', 'Î Î±ÏÎ±ÏƒÎºÎµÏ…Î®', 'Î£Î¬Î²Î²Î±Ï„Î¿', 'ÎšÏ…ÏÎ¹Î±ÎºÎ®'];
        const DB_DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        function getHourOptions(s) { let o=''; for(let i=0;i<24;i++){const v=i.toString().padStart(2,'0');o+=`<option value="${v}" ${v===s?'selected':''}>${v}</option>`;} return o; }
        function getMinOptions(s) { return ['00','15','30','45'].map(m=>`<option value="${m}" ${m===s?'selected':''}>${m}</option>`).join(''); }

        window.onload = async function() {
            if(!window.db) return;
            const { data: { session } } = await window.db.auth.getSession();
            if (session) { handleLoginSuccess(session.user); } else { document.getElementById('login-overlay').classList.remove('hidden'); }
            
            const formContainer = document.getElementById('schedule-form');
            DAYS.forEach((day, index) => {
                formContainer.innerHTML += `
                    <div class="flex flex-col sm:flex-row items-center gap-3 p-3 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700">
                        <div class="w-full sm:w-24 font-bold text-sm text-slate-700 dark:text-slate-300 flex items-center gap-2"><input type="checkbox" id="active-${index}" class="accent-secondary w-4 h-4" checked onchange="toggleDay(${index})">${day}</div>
                        <div id="times-${index}" class="flex items-center gap-2 flex-1"><div class="flex items-center bg-white dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600 px-2"><select id="open-h-${index}" class="bg-transparent py-2 outline-none text-sm font-mono">${getHourOptions('08')}</select><span class="text-slate-400">:</span><select id="open-m-${index}" class="bg-transparent py-2 outline-none text-sm font-mono">${getMinOptions('00')}</select></div><span class="text-slate-400 text-xs">Î­Ï‰Ï‚</span><div class="flex items-center bg-white dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600 px-2"><select id="close-h-${index}" class="bg-transparent py-2 outline-none text-sm font-mono">${getHourOptions('21')}</select><span class="text-slate-400">:</span><select id="close-m-${index}" class="bg-transparent py-2 outline-none text-sm font-mono">${getMinOptions('00')}</select></div></div>
                    </div>`;
            });
        };

        function toggleDay(index) {
            const isActive = document.getElementById(`active-${index}`).checked;
            const container = document.getElementById(`times-${index}`);
            container.style.opacity = isActive ? '1' : '0.3';
            container.style.pointerEvents = isActive ? 'auto' : 'none';
        }

        function handleLoginSuccess(user) {
            currentUser = user;
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('auth-section').innerHTML = `<span class="text-xs font-medium mr-2">${user.email}</span><button onclick="handleLogout()" class="text-xs bg-slate-200 dark:bg-slate-700 px-3 py-1 rounded-lg hover:bg-red-500 hover:text-white transition-colors">ÎˆÎ¾Î¿Î´Î¿Ï‚</button>`;
            fetchSchedule();
            fetchRequests();
            subscribeToRequests();
        }

        // --- MANUAL VERIFICATION LOGIC ---
        function openVerificationModal() {
            document.getElementById('verification-input-modal').classList.remove('hidden');
            document.getElementById('verify-code-input').value = '';
            document.getElementById('verify-code-input').focus();
        }

        function closeVerificationModal() {
            document.getElementById('verification-input-modal').classList.add('hidden');
        }

        function checkManualCode() {
            const code = document.getElementById('verify-code-input').value.trim();
            if(!code || code.length < 4) { showToast("Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 4 Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚", 'error'); return; }

            // Search in active requests
            const order = allActiveRequests.find(r => r.id.toLowerCase().startsWith(code.toLowerCase()));

            if(order) {
                closeVerificationModal();
                // Show Success Details
                document.getElementById('success-name').innerText = order.customer_name || 'Î‘Î½ÏÎ½Ï…Î¼Î¿Ï‚';
                document.getElementById('success-med').innerText = order.medicine_name;
                document.getElementById('success-qty').innerText = order.quantity + ' Ï„Î¼Ï‡';
                
                const confirmBtn = document.getElementById('success-confirm-btn');
                confirmBtn.onclick = () => {
                    completeOrder(order.id);
                    document.getElementById('verification-success-modal').classList.add('hidden');
                };
                
                document.getElementById('verification-success-modal').classList.remove('hidden');
            } else {
                showToast("ÎŸ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î® Î­Ï‡ÎµÎ¹ Î»Î®Î¾ÎµÎ¹.", 'error');
            }
        }

        async function fetchSchedule() {
            const { data, error } = await window.db.from('schedules').select('data').eq('pharmacist_id', currentUser.id).single();
            if (!data || error) { document.getElementById('schedule-modal').classList.remove('hidden'); } else { mySchedule = data.data; }
        }

        async function saveSchedule() {
            const scheduleData = {};
            for(let i=0; i<7; i++) {
                scheduleData[DB_DAYS[i]] = {
                    open: `${document.getElementById(`open-h-${i}`).value}:${document.getElementById(`open-m-${i}`).value}`,
                    close: `${document.getElementById(`close-h-${i}`).value}:${document.getElementById(`close-m-${i}`).value}`,
                    isActive: document.getElementById(`active-${i}`).checked
                };
            }
            const { error } = await window.db.from('schedules').upsert({ pharmacist_id: currentUser.id, data: scheduleData });
            if (error) { showToast("Î£Ï†Î¬Î»Î¼Î±: " + error.message, 'error'); } 
            else { mySchedule = scheduleData; document.getElementById('schedule-modal').classList.add('hidden'); showToast("Î¤Î¿ Ï‰ÏÎ¬ÏÎ¹Î¿ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ!", 'success'); }
        }

        function openScheduleModal() { document.getElementById('schedule-modal').classList.remove('hidden'); }
        function closeScheduleModal() { if(!mySchedule) { alert("Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï‰ÏÎ±ÏÎ¯Î¿Ï…!"); return; } document.getElementById('schedule-modal').classList.add('hidden'); }

        function getClosingTimeToday() {
            if (!mySchedule) return null;
            const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            const sched = mySchedule[today];
            if (!sched || !sched.isActive) return null;
            return sched.close;
        }

        function canAcceptOrder() {
            const closingTime = getClosingTimeToday();
            if (!closingTime) return { allowed: false, reason: "Î¤Î¿ Ï†Î±ÏÎ¼Î±ÎºÎµÎ¯Î¿ Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ ÎºÎ»ÎµÎ¹ÏƒÏ„ÏŒ Î³Î¹Î± ÏƒÎ®Î¼ÎµÏÎ± ÏƒÏ„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î±." };
            const now = new Date();
            const [cH, cM] = closingTime.split(':').map(Number);
            const closeDate = new Date();
            closeDate.setHours(cH, cM, 0);
            const arrivalTime = new Date(now.getTime() + 60 * 60000);
            if (arrivalTime > closeDate) { return { allowed: false, reason: `ÎšÎ»ÎµÎ¯Î½ÎµÏ„Îµ ÏƒÏ„Î¹Ï‚ ${closingTime}. Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï€ÎµÏÎ¹Î¸ÏÏÎ¹Î¿ 60'.` }; }
            return { allowed: true, closingTime };
        }

        async function sendResponse(requestId, type) {
            const check = canAcceptOrder();
            if (!check.allowed) { alert("â›” Î Î¡ÎŸÎ£ÎŸÎ§Î—:\n" + check.reason); return; }

            const btn = document.querySelector(`#card-${requestId} button`); if(btn) btn.innerText = '...';
            
            const { error } = await window.db.from('responses').insert({ 
                request_id: requestId, 
                pharmacist_id: currentUser.id, 
                response_type: type, 
                message: type === 'original' ? 'Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ (Î ÏÏ‰Ï„ÏŒÏ„Ï…Ï€Î¿)' : 'Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ (Î“ÎµÎ½ÏŒÏƒÎ·Î¼Î¿)', 
                price: '0.00',
                closing_time: check.closingTime
            });

            if (!error) { 
                showToast('Î— Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· ÏƒÏ„Î¬Î»Î¸Î·ÎºÎµ!', 'success'); 
                fetchRequests(); 
            } else { showToast('Î£Ï†Î¬Î»Î¼Î±: ' + error.message, 'error'); }
        }

        async function completeOrder(requestId) {
            removeCard(requestId);
            const { error } = await window.db.from('requests').update({ status: 'completed' }).eq('id', requestId);
            if(!error) {
                showToast('Î Î±ÏÎ±Î´ÏŒÎ¸Î·ÎºÎµ!', 'success');
                try { new Audio('https://cdn.freesound.org/previews/201/201159_866625-lq.mp3').play().catch(e=>{}); } catch(e){}
                fetchRequests();
            }
        }

        async function fetchRequests() {
            const spinner = document.getElementById('loading-spinner'); const container = document.getElementById('requests-container'); spinner.classList.remove('hidden');
            
            const { data, error } = await window.db.from('requests').select('*')
                .or(`status.eq.pending,and(status.eq.reserved,winner_pharmacy_id.eq.${currentUser.id})`)
                .order('created_at', { ascending: false });

            if(data) allActiveRequests = data; // Cache for search

            const { data: myResponses } = await window.db.from('responses').select('request_id').eq('pharmacist_id', currentUser.id);
            const myRespondedIds = new Set((myResponses || []).map(r => r.request_id));

            spinner.classList.add('hidden');
            if(error) return; container.innerHTML = '';
            
            if(data && data.length > 0) { 
                data.forEach(req => container.innerHTML += createRequestCard(req, myRespondedIds.has(req.id))); 
            } else { container.innerHTML = `<div class="text-center py-16 bg-white/50 dark:bg-slate-800/50 rounded-3xl border-2 border-dashed border-slate-300 dark:border-slate-700"><p class="text-slate-500">ÎšÎ±Î½Î­Î½Î± Î½Î­Î¿ Î±Î¯Ï„Î·Î¼Î±.</p></div>`; }
        }

        function createRequestCard(req, hasResponded) {
            const timeAgo = new Date(req.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
            const typeBadge = req.med_type ? `<span class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-[10px] font-bold px-2 py-1 rounded uppercase">${req.med_type}</span>` : '';
            const mediaButton = req.media_url ? `<a href="${req.media_url}" target="_blank" class="text-blue-500 text-xs font-bold flex items-center gap-1 bg-blue-50 px-2 py-1 rounded"><i class="ph ph-image"></i> Î¦Ï‰Ï„ÏŒ</a>` : '';
            const customerInfo = req.customer_name ? `<div class="text-xs font-bold text-slate-800 dark:text-white mt-1"><i class="ph ph-user"></i> ${req.customer_name} <i class="ph ph-phone ml-1"></i> <a href="tel:${req.phone}" class="underline">${req.phone || '-'}</a></div>` : '';

            let stateUI = '';
            let borderClass = 'border-l-secondary'; 

            if (req.status === 'reserved' && req.winner_pharmacy_id === currentUser.id) {
                borderClass = 'border-l-green-500 ring-1 ring-green-500/20';
                stateUI = `
                    <div class="mt-4 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 p-4 rounded-xl">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-green-700 dark:text-green-300 flex items-center gap-2 text-sm"><i class="ph ph-check-circle-fill text-xl"></i> ÎšÎ¡Î‘Î¤Î—Î£Î—!</span>
                            <span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded font-mono">ID: ${req.id.substr(0,6)}</span>
                        </div>
                        <p class="text-xs text-green-600 dark:text-green-400">ÎŸ Ï€ÎµÎ»Î¬Ï„Î·Ï‚ Î­ÏÏ‡ÎµÏ„Î±Î¹. Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ Ï€Î±ÏÎ±Î»Î±Î²Î®Ï‚.</p>
                        
                        <button onclick="openVerificationModal()" class="w-full mt-3 bg-green-600 text-white px-3 py-3 rounded-xl text-sm font-bold hover:bg-green-700 flex items-center justify-center gap-2 shadow-md">
                            <i class="ph ph-numpad text-lg"></i> Î•Ï€Î±Î»Î®Î¸ÎµÏ…ÏƒÎ· & Î Î±ÏÎ¬Î´Î¿ÏƒÎ·
                        </button>
                    </div>
                `;
            } else if (hasResponded) {
                borderClass = 'border-l-yellow-400';
                stateUI = `
                    <div class="mt-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 p-3 rounded-xl">
                        <div class="flex items-center gap-2 text-yellow-700 dark:text-yellow-400 font-bold text-sm"><i class="ph ph-hourglass-medium"></i> Î‘Î½Î±Î¼Î¿Î½Î®...</div>
                        <p class="text-xs text-yellow-600 dark:text-yellow-500 mt-1">Î£Ï„ÎµÎ¯Î»Î±Ï„Îµ Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ¬.</p>
                    </div>
                `;
            } else {
                stateUI = `
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mt-4">
                        <button onclick="sendResponse('${req.id}', 'original')" class="col-span-1 bg-secondary hover:bg-teal-700 text-white py-2.5 rounded-xl font-bold text-xs shadow-lg flex items-center justify-center gap-2"><i class="ph ph-check-circle text-lg"></i> Î ÏÏ‰Ï„ÏŒÏ„Ï…Ï€Î¿</button>
                        <button onclick="sendResponse('${req.id}', 'generic')" class="col-span-1 bg-white border border-secondary text-secondary hover:bg-teal-50 py-2.5 rounded-xl font-bold text-xs flex items-center justify-center gap-2"><i class="ph ph-pill text-lg"></i> Î“ÎµÎ½ÏŒÏƒÎ·Î¼Î¿</button>
                        <button onclick="dismissRequest('${req.id}')" class="col-span-2 sm:col-span-1 bg-slate-100 text-slate-500 hover:bg-slate-200 py-2.5 rounded-xl font-bold text-xs flex items-center justify-center gap-2"><i class="ph ph-x text-lg"></i> Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ·</button>
                    </div>
                `;
            }

            return `<div id="card-${req.id}" class="glass-panel p-5 rounded-2xl shadow-sm hover:shadow-md transition-all border-l-4 ${borderClass} relative group"><div class="flex justify-between items-start mb-3"><div class="flex flex-wrap items-center gap-2"><span class="bg-teal-100 text-teal-700 text-xs font-bold px-2 py-1 rounded-md flex items-center gap-1"><i class="ph ph-clock"></i> ${timeAgo}</span>${typeBadge}<span class="text-xs font-bold text-slate-500 flex items-center gap-1"><i class="ph ph-map-pin"></i> ${req.location || 'Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±'}</span></div></div><div class="flex justify-between items-start"><div><h3 class="text-lg font-bold text-slate-900 dark:text-white mb-1">${req.medicine_name} <span class="text-sm font-normal text-slate-500">x${req.quantity || 1}</span></h3><p class="text-sm text-slate-500 dark:text-slate-400 mb-2">${req.substance || ''}</p>${customerInfo}</div><div class="flex flex-col items-end gap-2">${mediaButton}</div></div>${req.notes ? `<div class="bg-slate-50 p-3 rounded-lg text-xs italic border mb-4">" ${req.notes} "</div>` : ''}${stateUI}</div>`;
        }

        function dismissRequest(requestId) { removeCard(requestId); }
        function removeCard(id) { const card = document.getElementById(`card-${id}`); if (card) { card.style.opacity = '0'; setTimeout(() => card.remove(), 300); } }

        function subscribeToRequests() {
             window.db.channel('pharmacy-feed')
             .on('postgres_changes', { event: '*', schema: 'public', table: 'requests' }, payload => {
                 if(payload.eventType === 'INSERT') showToast('ğŸ”” ÎÎ­Î¿ Î±Î¯Ï„Î·Î¼Î±!', 'info');
                 if(payload.eventType === 'UPDATE' && payload.new.winner_pharmacy_id === currentUser.id && payload.new.status === 'reserved') {
                     showToast('âœ… ÎšÎ¡Î‘Î¤Î—Î£Î—! ÎˆÎ½Î±Ï‚ Ï€ÎµÎ»Î¬Ï„Î·Ï‚ ÏƒÎ±Ï‚ ÎµÏ€Î­Î»ÎµÎ¾Îµ!', 'success');
                     try { new Audio('https://cdn.freesound.org/previews/171/171671_2437358-lq.mp3').play().catch(e=>{}); } catch(e){}
                 }
                 fetchRequests();
             })
             .subscribe();
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => { e.preventDefault(); const { data, error } = await window.db.auth.signInWithPassword({ email: document.getElementById('email').value, password: document.getElementById('password').value }); if (error) showToast(error.message, 'error'); else handleLoginSuccess(data.user); });
        async function demoLogin() { const { data, error } = await window.db.auth.signInAnonymously(); if (error) { currentUser = { id: 'demo_pharmacist', email: 'demo@pharmacy.gr' }; handleLoginSuccess(currentUser); showToast('Demo Mode', 'success'); } else { handleLoginSuccess(data.user); } }
        async function handleLogout() { await window.db.auth.signOut(); window.location.reload(); }
        function showToast(msg, type='info') { const c = document.getElementById('toast-container'); const el = document.createElement('div'); const bg = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-slate-800'); el.className = `toast ${bg} text-white px-4 py-3 rounded-xl shadow-lg text-sm font-semibold`; el.innerHTML = msg; c.appendChild(el); setTimeout(() => el.remove(), 3000); }
        function toggleTheme() { document.documentElement.classList.toggle('dark'); }
    </script>
</body>
</html>
